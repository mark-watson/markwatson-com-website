<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Haskell Tutorial and Cookbook</title>
  <link href="stylesheet.css" rel="stylesheet" />
</head>
<body dir="" class="lfm">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-cover-material-copyright-and-license'>Cover Material, Copyright, and License</a>
  </li>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-additional-material-in-the-second-edition'>Additional Material in the Second Edition</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-request-from-the-author'>A Request from the Author</a>
      </li>
      <li>
        <a href='#leanpub-auto-structure-of-the-book'>Structure of the Book</a>
      </li>
      <li>
        <a href='#leanpub-auto-code-examples'>Code Examples</a>
      </li>
      <li>
        <a href='#leanpub-auto-functional-programming-requires-a-different-mind-set'>Functional Programming Requires a Different Mind Set</a>
      </li>
      <li>
        <a href='#leanpub-auto-ebooks-are-living-documents'>eBooks Are Living Documents</a>
      </li>
      <li>
        <a href='#leanpub-auto-setting-up-your-development-environment'>Setting Up Your Development Environment</a>
      </li>
      <li>
        <a href='#leanpub-auto-why-haskell'>Why Haskell?</a>
      </li>
      <li>
        <a href='#leanpub-auto-enjoy-yourself'>Enjoy Yourself</a>
      </li>
      <li>
        <a href='#leanpub-auto-acknowledgements'>Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-section-1---tutorial'>Section 1 - Tutorial</a>
  </li>
  <li>
    <a href='#leanpub-auto-tutorial-on-pure-haskell-programming'>Tutorial on Pure Haskell Programming</a>
    <ul>
      <li>
        <a href='#leanpub-auto-interactive-ghci-shell'>Interactive GHCi Shell</a>
      </li>
      <li>
        <a href='#leanpub-auto-introduction-to-haskell-types'>Introduction to Haskell Types</a>
      </li>
      <li>
        <a href='#leanpub-auto-functions-are-pure'>Functions Are Pure</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-parenthesis-or-the-special--character-and-operator-precedence'>Using Parenthesis or the Special <strong>$</strong> Character and Operator Precedence</a>
      </li>
      <li>
        <a href='#leanpub-auto-lazy-evaluation'>Lazy Evaluation</a>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-list-comprehensions'>Understanding List Comprehensions</a>
      </li>
      <li>
        <a href='#leanpub-auto-haskell-rules-for-indenting-code'>Haskell Rules for Indenting Code</a>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-let-and-where'>Understanding <strong>let</strong> and <strong>where</strong></a>
      </li>
      <li>
        <a href='#leanpub-auto-conditional-do-expressions-and-anonymous-functions'>Conditional <strong>do</strong> Expressions and Anonymous Functions</a>
      </li>
      <li>
        <a href='#leanpub-auto-maps'>Maps</a>
      </li>
      <li>
        <a href='#leanpub-auto-sets'>Sets</a>
      </li>
      <li>
        <a href='#leanpub-auto-more-on-functions'>More on Functions</a>
      </li>
      <li>
        <a href='#leanpub-auto-comments-on-dealing-with-immutable-data-and-how-to-structure-programs'>Comments on Dealing With Immutable Data and How to Structure Programs</a>
      </li>
      <li>
        <a href='#leanpub-auto-error-handling'>Error Handling</a>
      </li>
      <li>
        <a href='#leanpub-auto-testing-haskell-code'>Testing Haskell Code</a>
      </li>
      <li>
        <a href='#leanpub-auto-pure-haskell-wrap-up'>Pure Haskell Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-tutorial-on-impure-haskell-programming'>Tutorial on Impure Haskell Programming</a>
    <ul>
      <li>
        <a href='#leanpub-auto-hello-io--monad'>Hello IO () Monad</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-note-about--and--operators'>A Note About <strong>&gt;&gt;</strong> and <strong>&gt;&gt;=</strong> Operators</a>
      </li>
      <li>
        <a href='#leanpub-auto-console-io-example-with-stack-configuration'>Console IO Example with Stack Configuration</a>
      </li>
      <li>
        <a href='#leanpub-auto-file-io'>File IO</a>
      </li>
      <li>
        <a href='#leanpub-auto-error-handling-in-impure-code'>Error Handling in Impure Code</a>
      </li>
      <li>
        <a href='#leanpub-auto-network-io'>Network IO</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-haskell-game-loop-that-maintains-state-functionally'>A Haskell Game Loop that Maintains State Functionally</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-more-detailed-look-at-monads'>A More Detailed Look at Monads</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-applicative-operators--and--finding-common-words-in-files'>Using Applicative Operators &lt;$&gt; and &lt;*&gt;: Finding Common Words in Files</a>
      </li>
      <li>
        <a href='#leanpub-auto-list-comprehensions-using-the-do-notation'>List Comprehensions Using the <strong>do</strong> Notation</a>
      </li>
      <li>
        <a href='#leanpub-auto-dealing-with-time'>Dealing With Time</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-debugtrace'>Using Debug.Trace</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up'>Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-section-2---cookbook'>Section 2 - Cookbook</a>
  </li>
  <li>
    <a href='#leanpub-auto-text-processing'>Text Processing</a>
    <ul>
      <li>
        <a href='#leanpub-auto-csv-spreadsheet-files'>CSV Spreadsheet Files</a>
      </li>
      <li>
        <a href='#leanpub-auto-json-data'>JSON Data</a>
      </li>
      <li>
        <a href='#leanpub-auto-cleaning-natural-language-text'>Cleaning Natural Language Text</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-natural-language-processing-tools'>Natural Language Processing Tools</a>
    <ul>
      <li>
        <a href='#leanpub-auto-resolve-entities-in-text-to-dbpedia-uris'>Resolve Entities in Text to DBPedia URIs</a>
      </li>
      <li>
        <a href='#leanpub-auto-bag-of-words-classification-model'>Bag of Words Classification Model</a>
      </li>
      <li>
        <a href='#leanpub-auto-text-summarization'>Text Summarization</a>
      </li>
      <li>
        <a href='#leanpub-auto-part-of-speech-tagging'>Part of Speech Tagging</a>
      </li>
      <li>
        <a href='#leanpub-auto-natural-language-processing-wrap-up'>Natural Language Processing Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-linked-data-and-the-semantic-web'>Linked Data and the Semantic Web</a>
    <ul>
      <li>
        <a href='#leanpub-auto-the-sparql-query-language'>The SPARQL Query Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-haskell-http-based-sparql-client'>A Haskell HTTP Based SPARQL Client</a>
      </li>
      <li>
        <a href='#leanpub-auto-querying-remote-sparql-endpoints'>Querying Remote SPARQL Endpoints</a>
      </li>
      <li>
        <a href='#leanpub-auto-linked-data-and-semantic-web-wrap-up'>Linked Data and Semantic Web Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-web-scraping'>Web Scraping</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-the-wreq-library'>Using the Wreq Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-handsomesoup-library-for-parsing-html'>Using the <strong>HandsomeSoup</strong> Library for Parsing HTML</a>
      </li>
      <li>
        <a href='#leanpub-auto-web-scraping-wrap-up'>Web Scraping Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-relational-databases'>Using Relational Databases</a>
    <ul>
      <li>
        <a href='#leanpub-auto-database-access-for-sqlite'>Database Access for Sqlite</a>
      </li>
      <li>
        <a href='#leanpub-auto-database-access-for-postgres'>Database Access for Postgres</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-haskell-program-to-play-the-blackjack-card-game'>Haskell Program to Play the Blackjack Card Game</a>
  </li>
  <li>
    <a href='#leanpub-auto-section-3---larger-projects'>Section 3 - Larger Projects</a>
  </li>
  <li>
    <a href='#leanpub-auto-knowledge-graph-creator'>Knowledge Graph Creator</a>
    <ul>
      <li>
        <a href='#leanpub-auto-code-layout-for-the-kgcreator-project-and-strategies-for-sharing-haskell-code-between-projects'>Code Layout For the KGCreator Project and strategies for sharing Haskell code between projects</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-main-event-detecting-entities-in-text'>The Main Event: Detecting Entities in Text</a>
      </li>
      <li>
        <a href='#leanpub-auto-utility-code-for-generating-rdf'>Utility Code for Generating RDF</a>
      </li>
      <li>
        <a href='#leanpub-auto-utility-code-for-generating-cypher-input-data-for-neo4j'>Utility Code for Generating Cypher Input Data for Neo4J</a>
      </li>
      <li>
        <a href='#leanpub-auto-top-level-api-code-for-handling-knowledge-graph-data-generation'>Top Level API Code for Handling Knowledge Graph Data Generation</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrapup-for-automating-the-creation-of-knowledge-graphs'>Wrapup for Automating the Creation of Knowledge Graphs</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-hybrid-haskell-and-python-natural-language-processing'>Hybrid Haskell and Python Natural Language Processing</a>
    <ul>
      <li>
        <a href='#leanpub-auto-example-use-of-the-haskell-nlp-client'>Example Use of the Haskell NLP Client</a>
      </li>
      <li>
        <a href='#leanpub-auto-setting-up-the-python-nlp-server'>Setting up the Python NLP Server</a>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-the-haskell-nlp-client-code'>Understanding the Haskell NLP Client Code</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrapup-for-using-the-python-spacy-nlp-service'>Wrapup for Using the Python SpaCy NLP Service</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-hybrid-haskell-and-python-for-coreference-resolution'>Hybrid Haskell and Python For Coreference Resolution</a>
    <ul>
      <li>
        <a href='#leanpub-auto-installing-the-python-coreference-server'>Installing the Python Coreference Server</a>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-the-haskell-coreference-client-code'>Understanding the Haskell Coreference Client Code</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrapup-for-using-the-python-coreference-nlp-service'>Wrapup for Using the Python Coreference NLP Service</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-book-wrap-up'>Book Wrap Up</a>
  </li>
  <li>
    <a href='#leanpub-auto-appendix-a---haskell-tools-setup'>Appendix A - Haskell Tools Setup</a>
    <ul>
      <li>
        <a href='#leanpub-auto-stack'>stack</a>
      </li>
      <li>
        <a href='#leanpub-auto-emacs-setup'>Emacs Setup</a>
      </li>
      <li>
        <a href='#leanpub-auto-do-you-want-more-of-an-ide-like-development-environment'>Do you want more of an IDE-like Development Environment?</a>
      </li>
      <li>
        <a href='#leanpub-auto-hlint'>hlint</a>
      </li>
    </ul>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="lfm">
<h2 id="leanpub-auto-cover-material-copyright-and-license">Cover Material, Copyright, and License</h2>

<p>Copyright 2016 Mark Watson. All rights reserved. This book may be shared using the Creative Commons “share and share alike, no modifications, no commercial reuse” license.</p>

<p>This eBook will be updated occasionally so please periodically check the <a href="https://leanpub.com/haskell-cookbook">leanpub.com web page for this book</a> for updates.</p>

<p>Please visit the <a href="http://markwatson.com">author’s website</a>.</p>

<p>If you found a copy of this book on the web and find it of value then please consider buying a copy at <a href="https://leanpub.com/haskell-cookbook">leanpub.com/haskell-cookbook</a> to support the author and fund work for future updates.</p>


<h2 id="leanpub-auto-preface">Preface</h2>

<p>This is the preface to the new second edition released summer of 2019.</p>

<p>It took me over a year learning Haskell before I became comfortable with the language because I tried to learn too much at once. There are two aspects to Haskell development: writing pure functional code and writing impure code that needs to maintain state and generally deal with the world non-deterministically. I usually find writing pure functional Haskell code to be easy and a lot of fun. Writing impure code is sometimes a different story. This is why I am taking a different approach to teaching you to program in Haskell: we begin techniques for writing concise, easy to read and understand efficient pure Haskell code. I will then show you patterns for writing impure code to deal with file IO, network IO, database access, and web access. You will see that the impure code tends to be (hopefully!) a small part of your application and is isolated in the impure main program and in a few impure helper functions used by the main program. Finally, we will look at a few larger Haskell programs.</p>

<h3 id="leanpub-auto-additional-material-in-the-second-edition">Additional Material in the Second Edition</h3>

<p>In addition to updating the introduction to Haskell and tutorial material, I have added a few larger projects to the second edition.</p>

<p>The project <strong>knowledge_graph_creator</strong> helps to automate the process of creating Knowledge Graphs from raw text input and generates data for both the Neo4J open source graph database as well as RDF data for use in semantic web and linked data applications.</p>

<p>The project <strong>HybridHaskellPythonNlp</strong> is a hybrid project: a Python web service that provides access to the SpaCy natural language processing (NLP) library and select NLP deep learning models and a Haskell client for accessing this service. It sometimes makes sense to develop polyglot applications (i.e., applications written in multiple programming languages) to take advantage of language specific libraries and frameworks. We will also use a similar hybrid example <strong>HybridHaskellPythonCorefAnaphoraResolution</strong> that uses another deep learning model to replace pronouns in text with the original nouns that the pronouns refer to. This is a common processing step for systems that extract information from text.</p>

<h3 id="leanpub-auto-a-request-from-the-author">A Request from the Author</h3>

<p>I spent time writing this book to help you, dear reader. I release this book under the Creative Commons “share and share alike, no modifications, no commercial reuse” license and set the minimum purchase price to $5.00 in order to reach the most readers. You can also download a free copy from <a href="https://markwatson.com/books">my website</a>. Under this license you can share a PDF version of this book with your friends and coworkers. If you found this book on the web (or it was given to you) and if it provides value to you then please consider doing one of the following to support my future writing efforts and also to support future updates to this book:</p>

<ul>
  <li>Purchase a copy of this book at <a href="https://leanpub.com/haskell-cookbook">leanpub.com/haskell-cookbook</a>
</li>
  <li><a href="http://markwatson.com/">Hire me as a consultant</a></li>
</ul>

<p>I enjoy writing and your support helps me write new editions and updates for my books and to develop new book projects. Thank you!</p>

<h3 id="leanpub-auto-structure-of-the-book">Structure of the Book</h3>

<p>The first section of this book contains two chapters:</p>

<ul>
  <li>A tutorial on pure Haskell development: no side effects.</li>
  <li>A tutorial on impure Haskell development: dealing with the world (I/O, network access, database access, etc.). This includes examples of file IO and network programming as well as writing short applications: a mixture of pure and impure Haskell code.</li>
</ul>

<p>After working through these tutorial chapters you will understand enough of Haskell development to understand and be able to make modifications for your own use of the cookbook examples in the second section. Some of the general topics will be covered again in the second book section that contains longer sample applications. For example, you will learn the basics for interacting with Sqlite and Postgres databases in the tutorial on impure Haskell code but you will see a much longer example later in the book when I provide code that implements a natural language processing (NLP) interface to relational databases.</p>

<p>The second section contains the following recipes implemented as complete programs:</p>

<ul>
  <li>Textprocessing CSV Files</li>
  <li>Textprocessing JSON Files</li>
  <li>Natural Language Processing (NLP) interface to relational databases, including annotating English text with Wikipedia/DBPedia URIs for entities in the original text. Entities can be people, places, organizations, etc.</li>
  <li>Accessing and Using Linked Data</li>
  <li>Querying Semantic Web RDF Data Sources</li>
  <li>Web scraping data on web sites</li>
  <li>Using Sqlite and Postgres relational databases</li>
  <li>Play a simple version of Blackjack card game</li>
</ul>

<p>A new third section (added in 2019 for the second edition) has three examples that were derived by my own work.</p>

<h3 id="leanpub-auto-code-examples">Code Examples</h3>

<p>The code examples in this book are licensed under two software licenses and you can choose the license that works best for your needs: Apache 2 and GPL 3. To be clear, you can use the examples in commercial projects under the Apache 2 license and if you like to write Free (Libre) software then use the GPL 3 license.</p>

<p>We will use <em>stack</em> as a build system for all code examples. The code examples are provided as 22 separate <em>stack</em> based projects. These examples <a href="https://github.com/mark-watson/haskell_tutorial_cookbook_examples">are found on github</a>.</p>

<h3 id="leanpub-auto-functional-programming-requires-a-different-mind-set">Functional Programming Requires a Different Mind Set</h3>

<p>You will learn to look at problems differently when you write functional programs. We will use a bottom up approach in most of the examples in this book. I like to start by thinking of the problem domain and decide how I can represent the data required for the problem at hand. I prefer to use native data structures. This is the opposite approach to object oriented development where considerable analysis effort and coding effort is required to define class hierachies to represent data. In most of the code we use simple native data types like lists and maps.</p>

<p>Once we decide how to represent data for a program we then start designing and implementing simple functions to operate on and transform data. If we find ourselves writing functions that are too long or too complex, we can break up code into simpler functions. Haskell has good language support for composing simple functions into more complex operations.</p>

<p>I have spent many years engaged in object oriented programming starting with CLOS for Common Lisp, C++, Java, and Ruby. I now believe that in general, and I know it is sometimes a bad idea to generalize too much, functional programming is a superior paradigm to object oriented programming. Convincing you of this belief is one of my goals in writing this book!</p>

<h3 id="leanpub-auto-ebooks-are-living-documents">eBooks Are Living Documents</h3>

<p>I wrote printed books for publishers like Springer-Verlag, McGraw-Hill, and Morgan Kaufman before I started self-publishing my own books. I prefer eBooks because I can update already published books and update the code examples for eBooks.</p>

<p>I encourage you to periodically check for free updates to both this book and the code examples on the <a href="https://leanpub.com/haskell-cookbook">leanpub.com web page for this book</a>.</p>

<h3 id="leanpub-auto-setting-up-your-development-environment">Setting Up Your Development Environment</h3>

<p>I strongly recommend that you use the <em>stack</em> tool from the <a href="http://docs.haskellstack.org/en/stable/README.html">stack website</a>. This web site has instructions for installing <em>stack</em> on OS X, Windows, and Linux. If you don’t have <em>stack</em> installed yet please do so now and follow the “getting started” instructions for creating a small project. Appendix A contains material to help get you set up.</p>

<p>It is important for you to learn the basics of using <em>stack</em> before jumping into this book because I have set up all of the example programs using stack.</p>

<p>The github repository for the examples in this book is located at <a href="https://github.com/mark-watson/haskell_tutorial_cookbook_examples">github.com/mark-watson/haskell_tutorial_cookbook_examples</a>.</p>

<p>Many of the example listings for code examples are partial or full listing of files in my github repository. I show the file name, the listing, and the output. To experiment with the example yourself you need to load it and execute the main function; for example, if the example file is TestSqLite1.hs in the sub-directory Database, then from the top level directory in the git repository for the book examples you would do the following:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">$</code> <code class="n">haskell_tutorial_cookbook_examples</code> <code class="n">git</code><code class="p">:(</code><code class="k">master</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">cd</code> <code class="n">Database</code> 
<code class="o">$</code> <code class="n">Database</code> <code class="n">git</code><code class="p">:(</code><code class="k">master</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">stack</code> <code class="n">build</code> <code class="o">--</code><code class="n">exec</code> <code class="n">ghci</code>
<code class="n">GHCi</code><code class="p">,</code> <code class="n">version</code> <code class="mf">7.10</code><code class="o">.</code><code class="mi">3</code><code class="p">:</code> <code class="n">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="o">.</code><code class="n">haskell</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ghc</code><code class="o">/</code>  <code class="p">:</code><code class="err">?</code> <code class="k">for</code> <code class="n">help</code>
<code class="n">Prelude</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">l</code> <code class="n">TestSqLite1</code>
<code class="p">[</code><code class="mi">1</code> <code class="n">of</code> <code class="mi">1</code><code class="p">]</code> <code class="n">Compiling</code> <code class="n">Main</code>             <code class="p">(</code> <code class="n">TestSqLite1</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="n">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="p">:</code> <code class="n">Main</code><code class="o">.</code>
<code class="o">*</code><code class="n">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="s2">"Table names in database test.db:"</code>
<code class="s2">"test"</code>
<code class="s2">"SQL to create table 'test' in database test.db:"</code>
<code class="s2">"CREATE TABLE test (id integer primary key, str text)"</code>
<code class="s2">"number of rows in table 'test':"</code>
<code class="mi">1</code>
<code class="s2">"rows in table 'test':"</code>
<code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="s2">"test string 2"</code><code class="p">)</code>
<code class="o">*</code><code class="n">Main</code><code class="o">&gt;</code>
</pre></div>

</figure>

<p>If you don’t want to run the example in a REPL in order to experiment with it interactively you can then just run it via stack using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ Database git:<code class="o">(</code>master<code class="o">)</code> &gt; stack build --exec TestSqlite1
<code class="s2">"Table names in database test.db:"</code>
<code class="s2">"test"</code>
<code class="s2">"SQL to create table 'test' in database test.db:"</code>
<code class="s2">"CREATE TABLE test (id integer primary key, str text)"</code>
<code class="s2">"number of rows in table 'test':"</code>
<code class="m">1</code>
<code class="s2">"rows in table 'test':"</code>
<code class="o">(</code><code class="m">1</code>,<code class="s2">"test string 2"</code><code class="o">)</code>
</pre></div>

</figure>

<p>I include <em>README.md</em> files in the project directories with specific instructions.</p>

<p>I now use VSCode for most of my Haskell development. With the Haskell plugins VSCode offers auto-completion while typing and highlights syntax errors. Previously I use other editor for Haskell development. If you are an Emacs user I recommend that you follow the instructions in Appendix A, load the tutorial files into an Emacs buffer, build an example and open a REPL frame. If one is not already open type control-c control-l, switch to the REPL frame, and run the <strong>main</strong> function. When you make changes to the tutorial files, doing another control-c control-l will re-build the example in less than a second. In addition to using Emacs I occasionally use the IntelliJ Community Edition (free) IDE with the Haskell plugin, the TextMate editor (OS X only) with the Haskell plugin, or the GNU GEdit editor (Linux only).</p>

<p>Appendix A also shows you how to setup the <em>*stack</em> Haskell build tool.</p>

<p>Whether you use Emacs/VSCode or run a REPL in a terminal window (command window if you are using Windows) the important thing is to get used to and enjoy the interactive style of development that Haskell provides.</p>

<h3 id="leanpub-auto-why-haskell">Why Haskell?</h3>

<p>I have been using Lisp programming languages professionally since 1982. Lisp languages are flexible and appropriate for many problems. Some might dissagree with me but I find that Haskell has most of the advantages of Lisp with the added benefit of being strongly typed. Both Lisp and Haskell support a style of development using an interactive shell (or “repl”).</p>

<p>What does being a strongly typed language mean? In a practical sense it means that you will often encounter syntax errors caused by type mismatches that you will need to fix before your code will compile (or run in the GHCi shell interpreter). Once your code compiles it will likely work, barring a logic error. The other benefit  that you can get is having to write fewer unit tests - at least that is my experience. So, using a strongly typed language is a tradeoff. When I don’t use Haskell I tend to use dynamic languages like Common Lisp or Python.</p>

<h3 id="leanpub-auto-enjoy-yourself">Enjoy Yourself</h3>

<p>I have worked hard to make learning Haskell as easy as possible for you. If you are new to the Haskell programming language then I have something to ask of you, dear reader: please don’t rush through this book, rather take it slow and take time to experiment with the programming examples that most interest you.</p>

<h3 id="leanpub-auto-acknowledgements">Acknowledgements</h3>

<p>I would like to thank my wife Carol Watson for editing the manuscript for this book. I would like to thank Roy Marantz, Michel Benard, and Daniel Kroni for reporting an errors.</p>


<h2 id="leanpub-auto-section-1---tutorial">Section 1 - Tutorial</h2>

<p>The first section of this book contains two chapters:</p>

<ul>
  <li>A tutorial on pure Haskell development: no side effects.</li>
  <li>A tutorial on impure Haskell development: dealing with the world (I/O, network access, database access, etc.)</li>
</ul>

<p>After working through these two tutorial chapters you will have sufficient knowledge of Haskell development to understand the cookbook examples in the second section and be able to modify them for your own use. Some of the general topics will be covered again in the second book section that contains longer example programs.</p>


<h2 id="leanpub-auto-tutorial-on-pure-haskell-programming">Tutorial on Pure Haskell Programming</h2>

<p>Pure Haskell code has no side effects and if written properly is easy to read and understand. I am assuming that you have installed <em>stack</em> using the directions in Appendix A. It is important to keep a Haskell interactive <strong>repl</strong> open as you read the material in this book and experiment with the code examples as you read. I don’t believe that you will be able to learn the material in this chapter unless you work along trying the examples and experimenting with them in an open Haskell repl!</p>

<p>The directory <strong>Pure</strong> in the git repository contains the examples for this chapter. Many of the examples contain a small bit of impure code in a <strong>main</strong> function. We will cover how this impure code works in the next chapter. Here is an example of impure code, contained inside a <strong>main</strong> function that you will see in this chapter:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="n">putStrLn</code> <code class="p">(</code><code class="s">"1 + 2 = "</code> <code class="o">++</code> <code class="n">show</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>I ask you to treat these small bits of impure code in this chapter as a “black box” and wait for the next chapter for a fuller explanation.</p>

<p>Pure Haskell code performs no I/O, network access, access to shared in-memory datastructures, etc.</p>

<p>The first time you build an example program with <em>stack</em> it may take a while since library dependencies need to be loaded from the web. In each example directory, after an initial <strong>stack build</strong> or <strong>stack ghci</strong> (to run the repl) then you should not notice this delay.</p>

<h3 id="leanpub-auto-interactive-ghci-shell">Interactive GHCi Shell</h3>

<p>The interactive shell (often called a “repl”) is very useful for learning Haskell: understanding types and the value of expressions. While simple expressions can be typed directly into the GHCi shell, it is usually better to use an external text editor and load Haskell source files into the shell (repl). Let’s get started. Assuming that you have installed <em>stack</em> as described in Appendix A, please try:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">~/$</code> <code class="n">cd</code> <code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code>
<code class="linenos"> 2 </code><code class="o">~/</code><code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos"> 3 </code><code class="kt">Using</code> <code class="n">main</code> <code class="kr">module</code><code class="err">:</code> <code class="nn">Package</code> <code class="p">`</code><code class="kt">Pure'</code> <code class="n">component</code> <code class="n">exe</code><code class="kt">:Simple</code> <code class="n">with</code> <code class="n">main</code><code class="o">-</code><code class="n">is</code> <code class="n">file</code><code class="kt">:</code> <code class="o">/</code><code class="n">home</code><code class="o">/</code><code class="n">mark</code><code class="nf">\</code>
<code class="linenos"> 4 </code><code class="nf">w</code><code class="o">/</code><code class="kt">BITBUCKET</code><code class="o">/</code><code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">/</code><code class="kt">Simple</code><code class="o">.</code><code class="n">hs</code>
<code class="linenos"> 5 </code><code class="kt">Configuring</code> <code class="kt">GHCi</code> <code class="n">with</code> <code class="n">the</code> <code class="n">following</code> <code class="n">packages</code><code class="kt">:</code> <code class="kt">Pure</code>
<code class="linenos"> 6 </code><code class="kt">GHCi</code><code class="p">,</code> <code class="n">version</code> <code class="mf">7.10</code><code class="o">.</code><code class="mi">3</code><code class="kt">:</code> <code class="n">http</code><code class="kt">://</code><code class="n">www</code><code class="o">.</code><code class="n">haskell</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ghc</code><code class="o">/</code>  <code class="kt">:?</code> <code class="n">for</code> <code class="n">help</code>
<code class="linenos"> 7 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="o">/</code><code class="n">home</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="kt">BITBUCKET</code><code class="o">/</code><code class="n">haskell_tutorial_cookboo</code><code class="nf">\</code>
<code class="linenos"> 8 </code><code class="nf">k_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">/</code><code class="kt">Simple</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 9 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">10 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code>
<code class="linenos">11 </code><code class="mi">3</code>
<code class="linenos">12 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">13 </code><code class="mi">3</code>
<code class="linenos">14 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">15 </code><code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code>
<code class="linenos">16 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">Simple</code><code class="o">.</code><code class="n">hs</code>
<code class="linenos">17 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">Simple</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">18 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">19 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">20 </code><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code> <code class="ow">=</code> <code class="mi">3</code>
<code class="linenos">21 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>If you are working in a repl and edit a file you just loaded with <strong>:l</strong>, you can then reload the last file loaded using <strong>:r</strong> without specifying the file name. This makes it quick and easy to edit a Haskell file with an external editor like Emacs or Vi and reload it in the repl after saving changes to the current file.</p>

<p>Here we have evaluated a simple expression “1 + 2” in line 10. Notice that in line 12 we can always place parenthesis around an expression without changing its value. We will use parenthesis when we need to change the default orders of precedence of functions and operators and make the code more readable.</p>

<p>In line 14 we are using the ghci <strong>:t</strong> command to show the type of the expression <strong>(1 + 2)</strong>. The type <strong>Num</strong> is a type class (i.e., a more general purpose type that other types can inherit from) that contains several sub-types of numbers. As examples, two subtypes of <strong>Num</strong> are <strong>Fractional</strong> (e.g., 3.5) and <strong>Integer</strong> (e.g., 123). Type classes provide a form of function overloading since existing functions can be redefined to handle arguments that are instances of new classes.</p>

<p>In line 16 we are using the ghci command <strong>:l</strong> to load the external file <em>Simple.hs</em>. This file contains a function called <strong>main</strong> so we can execute <strong>main</strong> after loading the file. The contents of <em>Simple.hs</em> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="nf">sum2</code> <code class="n">x</code> <code class="n">y</code> <code class="ow">=</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">6 </code>  <code class="n">putStrLn</code> <code class="p">(</code><code class="s">"1 + 2 = "</code> <code class="o">++</code> <code class="n">show</code> <code class="p">(</code><code class="n">sum2</code> <code class="mi">1</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>Line 1 defines a module named <strong>Main</strong>. The rest of this file is the definition of the module. This form of the module <strong>do</strong> expression exports all symbols so other code loading this module has access to <strong>sum2</strong> and <strong>main</strong>. If we only wanted to export <strong>main</strong> then we could use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">Main</code> <code class="p">(</code><code class="nf">main</code><code class="p">)</code> <code class="kr">where</code>
</pre></div>

</figure>

<p>The function <strong>sum2</strong> takes two arguments and adds them together. I didn’t define the type of this function so Haskell does it for us using type inference.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">Simple</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">Simple</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">sum2</code>
<code class="linenos"> 5 </code><code class="nf">sum2</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">sum2</code> <code class="mi">1</code> <code class="mi">2</code>
<code class="linenos"> 7 </code><code class="mi">3</code>
<code class="linenos"> 8 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">sum2</code> <code class="mf">1.0</code> <code class="mi">2</code>
<code class="linenos"> 9 </code><code class="mf">3.0</code>
<code class="linenos">10 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="mf">3.0</code>
<code class="linenos">11 </code><code class="mf">3.0</code> <code class="ow">::</code> <code class="kt">Fractional</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code>
<code class="linenos">12 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="mi">3</code>
<code class="linenos">13 </code><code class="mi">3</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code>
<code class="linenos">14 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="n">toInteger</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">15 </code><code class="mi">3</code>
<code class="linenos">16 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="n">toInteger</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">17 </code><code class="p">(</code><code class="n">toInteger</code> <code class="mi">3</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Integer</code>
<code class="linenos">18 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>What if you want to build a standalone executable program from the example in <strong>Smple.hs</strong>? Here is an example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ stack ghc Simple.hs
<code class="linenos">2 </code><code class="o">[</code><code class="m">1</code> of <code class="m">1</code><code class="o">]</code> Compiling Main             <code class="o">(</code> Simple.hs, Simple.o <code class="o">)</code>
<code class="linenos">3 </code>Linking Simple ...
<code class="linenos">4 </code>$ ./Simple 
<code class="linenos">5 </code><code class="m">1</code> + <code class="nv">2</code> <code class="o">=</code> <code class="m">3</code>
</pre></div>

</figure>

<p>Most of the time we will use simple types built into Haskell: <strong>characters</strong>, <strong>strings</strong>, <strong>lists</strong>, and <strong>tuples</strong>. The type <strong>Char</strong> is a single character. One type of string is a list of characters <strong>[Char]</strong>. (Another type <strong>ByteString</strong> will be covered in later chapters.) Every element in a list must have the same type. A <strong>Tuple</strong> is like a list but elements can be different types. Here is a quick introduction to these types, with many more examples later:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="sc">'s'</code>
<code class="linenos"> 2 </code><code class="sc">'s'</code> <code class="ow">::</code> <code class="kt">Char</code>
<code class="linenos"> 3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="s">"tree"</code>
<code class="linenos"> 4 </code><code class="s">"tree"</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="sc">'s'</code> <code class="kt">:</code> <code class="s">"tree"</code>
<code class="linenos"> 6 </code><code class="s">"stree"</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="s">"tick"</code>
<code class="linenos"> 8 </code><code class="s">"tick"</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="sc">'s'</code> <code class="kt">:</code> <code class="s">"tick"</code>
<code class="linenos">10 </code><code class="s">"stick"</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code>
<code class="linenos">12 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="linenos">13 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mf">3.3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code>
<code class="linenos">14 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mf">3.3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code> <code class="ow">::</code> <code class="kt">Fractional</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="linenos">15 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"slept"</code><code class="p">]</code>
<code class="linenos">16 </code><code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"slept"</code><code class="p">]</code> <code class="ow">::</code> <code class="p">[[</code><code class="kt">Char</code><code class="p">]]</code>
<code class="linenos">17 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"slept"</code><code class="p">]</code> <code class="o">!!</code> <code class="mi">0</code>
<code class="linenos">18 </code><code class="s">"the"</code>
<code class="linenos">19 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">head</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"slept"</code><code class="p">]</code>
<code class="linenos">20 </code><code class="s">"the"</code>
<code class="linenos">21 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">tail</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"slept"</code><code class="p">]</code>
<code class="linenos">22 </code><code class="p">[</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"slept"</code><code class="p">]</code>
<code class="linenos">23 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"slept"</code><code class="p">]</code> <code class="o">!!</code> <code class="mi">1</code>
<code class="linenos">24 </code><code class="s">"cat"</code>
<code class="linenos">25 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="mi">20</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">)</code>
<code class="linenos">26 </code><code class="p">(</code><code class="mi">20</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">(</code><code class="n">t</code><code class="p">,</code> <code class="kt">Char</code><code class="p">)</code>
<code class="linenos">27 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="mi">30</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">)</code>
<code class="linenos">28 </code><code class="p">(</code><code class="mi">30</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">(</code><code class="n">t</code><code class="p">,</code> <code class="p">[</code><code class="kt">Char</code><code class="p">])</code>
<code class="linenos">29 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s">"10 Jackson Street"</code><code class="p">,</code> <code class="mi">80211</code><code class="p">,</code> <code class="mf">77.5</code><code class="p">)</code>
<code class="linenos">30 </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s">"10 Jackson Street"</code><code class="p">,</code> <code class="mi">80211</code><code class="p">,</code> <code class="mf">77.5</code><code class="p">)</code>
<code class="linenos">31 </code>  <code class="ow">::</code> <code class="p">(</code><code class="kt">Fractional</code> <code class="n">t2</code><code class="p">,</code> <code class="kt">Num</code> <code class="n">t</code><code class="p">,</code> <code class="kt">Num</code> <code class="n">t1</code><code class="p">)</code> <code class="ow">=&gt;</code> <code class="p">(</code><code class="n">t</code><code class="p">,</code> <code class="p">[</code><code class="kt">Char</code><code class="p">],</code> <code class="n">t1</code><code class="p">,</code> <code class="n">t2</code><code class="p">)</code>
</pre></div>

</figure>

<p>The GHCi repl command <strong>:t</strong> tells us the type of any expression or function. Much of your time developing Haskell will be spent with an open repl and you will find yourself checking types many times during a development session.</p>

<p>In line 1 you see that the type of <strong>’s‘</strong> is <strong>’s’ :: Char</strong> and in line 3 that the type of the string “tree” is <strong>[Char]</strong> which is a list of characters. The abbreviation <strong>String</strong> is defined for <strong>[Char]</strong>; you can use either. In line 9 we see the “cons” operator <strong>:</strong> used to prepend a character to a list of characters. The cons <strong>:</strong> operator works with all types contained in any lists. All elements in a list must be of the same type.</p>

<p>The type of the list of numbers <strong>[1,2,3,4]</strong> in line 11 is <strong>[1,2,3,4] :: Num t ⇒ [t]</strong>. The type <strong>Num</strong> is a general number type. The expression <strong>Num t ⇒ [t]</strong> is read as: “<em>t</em> is a type variable equal to <strong>Num</strong> and the type of the list is <strong>[t]</strong>, or a list of Num values”. It bears repeating: all elements in a list must be of the same type. The functions <strong>head</strong> and <strong>tail</strong> used in lines 19 and 21 return the first element of a list and return a list without the first element.</p>

<p>You will use lists frequently but the restriction of all list elements being the same type can be too restrictive so Haskell also provides a type of sequence called <strong>tuple</strong> whose elements can be of different types as in the examples in lines 25-31.</p>

<p>Tuples of length 2 are special because functions <strong>fst</strong> and <strong>snd</strong> are provided to access the first and second pair value:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">fst</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s">"10 Jackson Street"</code><code class="p">)</code>
<code class="mi">1</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">snd</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s">"10 Jackson Street"</code><code class="p">)</code>
<code class="s">"10 Jackson Street"</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="n">fst</code>
<code class="nf">fst</code> <code class="ow">::</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">a</code> 	<code class="c1">-- Defined in ‘Data.Tuple’</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="n">snd</code>
<code class="nf">snd</code> <code class="ow">::</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">b</code> 	<code class="c1">-- Defined in ‘Data.Tuple’</code>
</pre></div>

</figure>

<p>Please note that <strong>fst</strong> and <strong>snd</strong> will not work with tuples that are not of length 2. Also note that if you use the function <strong>length</strong> on a tuple, the result is always one because of the way tuples are defined as Foldable types, which we will use later.</p>

<p>Haskell provides a concise notation to get values out of long tuples. This notation is called destructuring:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">geoData</code> <code class="ow">=</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s">"10 Jackson Street"</code><code class="p">,</code> <code class="mi">80211</code><code class="p">,</code> <code class="mf">77.5</code><code class="p">)</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="p">(</code><code class="kr">_</code><code class="p">,</code><code class="kr">_</code><code class="p">,</code><code class="n">zipCode</code><code class="p">,</code><code class="n">temperature</code><code class="p">)</code> <code class="ow">=</code> <code class="n">geoData</code> 
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">zipCode</code> 
<code class="linenos">4 </code><code class="mi">80211</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">temperature</code> 
<code class="linenos">6 </code><code class="mf">77.5</code>
</pre></div>

</figure>

<p>Here, we defined a tuple <strong>geoData</strong> with values: index, street address, zip code, and temperature. In line two we extract the zip code and temperature. Another reminder: we use <strong>let</strong> in lines 1-2 because we are in a repl.</p>

<p>Like all programming languages, Haskell has operator precedence rules as these examples show:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code> <code class="o">*</code> <code class="mi">10</code>
<code class="linenos"> 2 </code><code class="mi">21</code>
<code class="linenos"> 3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">1</code> <code class="o">+</code> <code class="p">(</code><code class="mi">2</code> <code class="o">*</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="mi">21</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">length</code> <code class="s">"the"</code>
<code class="linenos"> 6 </code><code class="mi">3</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">length</code> <code class="s">"the"</code> <code class="o">+</code> <code class="mi">10</code>
<code class="linenos"> 8 </code><code class="mi">13</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="n">length</code> <code class="s">"the"</code><code class="p">)</code> <code class="o">+</code> <code class="mi">10</code>
<code class="linenos">10 </code><code class="mi">13</code>
</pre></div>

</figure>

<p>The examples in lines 1-4 illustrate that the multiplication operator has a higher precidence than the addition operator.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">length</code>
<code class="nf">length</code> <code class="ow">::</code> <code class="kt">Foldable</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="n">t</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Int</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code>
<code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
</pre></div>

</figure>

<p>Note that the function <strong>length</strong> starts with a lower case letter. All Haskell functions start with a lower case letter except for type constructor functions that we will get to later. A <strong>Foldable</strong> type can be iterated through and be processed with map functions (which we will use shortly).</p>

<p>We saw that the function <strong>+</strong> acts as an infix operator. We can convert infix functions to prefix functions by enclosing them in parenthesis:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="mi">1</code> <code class="mi">2</code>
<code class="mi">3</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">div</code> <code class="mi">10</code> <code class="mi">3</code>
<code class="mi">3</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">10</code> <code class="p">`</code><code class="n">div</code><code class="p">`</code> <code class="mi">3</code>
<code class="mi">3</code>
</pre></div>

</figure>

<p>In this last example we also saw how a prefix function <strong>div</strong> can be used infix by enclosing it in back tick characters.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">x3</code> <code class="ow">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos"> 2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">x3</code>
<code class="linenos"> 3 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">x4</code> <code class="ow">=</code> <code class="mi">0</code> <code class="kt">:</code> <code class="n">x3</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">x4</code>
<code class="linenos"> 6 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">x3</code> <code class="o">++</code> <code class="n">x4</code>
<code class="linenos"> 8 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">x4</code>
<code class="linenos">10 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">x4</code> <code class="o">!!</code> <code class="mi">0</code>
<code class="linenos">12 </code><code class="mi">0</code>
<code class="linenos">13 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">x4</code> <code class="o">!!</code> <code class="mi">100</code>
<code class="linenos">14 </code><code class="o">***</code> <code class="kt">Exception:</code> <code class="kt">Prelude</code><code class="o">.!!:</code> <code class="n">index</code> <code class="n">too</code> <code class="n">large</code>
<code class="linenos">15 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">myfunc1</code> <code class="n">x</code> <code class="n">y</code> <code class="ow">=</code> <code class="n">x</code> <code class="o">++</code> <code class="n">y</code>
<code class="linenos">16 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">myfunc1</code>
<code class="linenos">17 </code><code class="nf">myfunc1</code> <code class="ow">::</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code>
<code class="linenos">18 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">myfunc1</code> <code class="n">x3</code> <code class="n">x4</code>
<code class="linenos">19 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
</pre></div>

</figure>

<p>Usually we define functions in files and load them as we need them. Here is the contents of the file myfunc1.hs:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">myfunc1</code> <code class="ow">::</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code>
<code class="linenos">2 </code><code class="nf">myfunc1</code> <code class="n">x</code> <code class="n">y</code> <code class="ow">=</code> <code class="n">x</code> <code class="o">++</code> <code class="n">y</code>
</pre></div>

</figure>

<p>The first line is a type signature for the function and is not required; here the input arguments are two lists and the output is the two lists concatenated together. In line 1 note that <strong>a</strong> is a type variable that can represent any type. However, all elements in the two function input lists and the output list are constrained to be the same type.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="n">myfunc1</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="n">myfunc1</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">myfunc1</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">]</code> <code class="p">[</code><code class="s">"ran"</code><code class="p">,</code> <code class="s">"up"</code><code class="p">,</code> <code class="s">"a"</code><code class="p">,</code> <code class="s">"tree"</code><code class="p">]</code>
<code class="linenos">5 </code><code class="p">[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"up"</code><code class="p">,</code><code class="s">"a"</code><code class="p">,</code><code class="s">"tree"</code><code class="p">]</code>
</pre></div>

</figure>

<p>Please note that the <em>stack</em> repl auto-completes using the tab character. For example, when I was typing in “:l myfunc1.hs” I actually just typed “:l myf” and then hit the tab character to complete the file name. Experiment with auto-completion, it will save you a lot of typing. In the following example, for instance, after defining the variable <strong>sentence</strong> I can just type “se” and the tab character to auto-complete the entire variable name:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">sentence</code> <code class="ow">=</code> <code class="n">myfunc1</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">]</code> <code class="p">[</code><code class="s">"ran"</code><code class="p">,</code> <code class="s">"up"</code><code class="p">,</code> <code class="s">"a"</code><code class="p">,</code> <code class="s">"tree"</code><code class="p">]</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">sentence</code> 
<code class="linenos">3 </code><code class="p">[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"up"</code><code class="p">,</code><code class="s">"a"</code><code class="p">,</code><code class="s">"tree"</code><code class="p">]</code>
</pre></div>

</figure>

<p>The function <strong>head</strong> returns the first element in a list and the function <strong>tail</strong> returns all but the first elements in a list:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">head</code> <code class="n">sentence</code> 
<code class="linenos">2 </code><code class="s">"the"</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">tail</code> <code class="n">sentence</code> 
<code class="linenos">4 </code><code class="p">[</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"up"</code><code class="p">,</code><code class="s">"a"</code><code class="p">,</code><code class="s">"tree"</code><code class="p">]</code>
</pre></div>

</figure>

<p>We can create new functions from existing arguments by supplying few arguments, a process known as “currying”:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">p1</code> <code class="ow">=</code> <code class="p">(</code><code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">p1</code>
<code class="linenos">3 </code><code class="nf">p1</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">p1</code> <code class="mi">20</code>
<code class="linenos">5 </code><code class="mi">21</code>
</pre></div>

</figure>

<p>In this last example the function <strong>+</strong> takes two arguments but if we only supply one argument a function is returned as the value: in this case a function that adds 1 to an input value.</p>

<p>We can also create new functions by <em>composing</em> existing functions using the infix function <strong>.</strong> that when placed between two function names produces a new function that combines the two functions. Let’s look at an example that uses <strong>.</strong> to combine the partial function <strong>(+ 1)</strong> with the function <strong>length</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">lengthp1</code> <code class="ow">=</code> <code class="p">(</code><code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">.</code> <code class="n">length</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">lengthp1</code>
<code class="linenos">3 </code><code class="nf">lengthp1</code> <code class="ow">::</code> <code class="kt">Foldable</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="n">t</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Int</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">lengthp1</code> <code class="s">"dog"</code>
<code class="linenos">5 </code><code class="mi">4</code>
</pre></div>

</figure>

<p>Note the order of the arguments to the inline function <strong>.</strong>: the argument on the right side is the first function that is applied, then the function on the left side of the <strong>.</strong> is applied.</p>

<p>This is the second example where we have seen the type <strong>Foldable</strong> which means that a type can be mapped over, or iterated over. We will look at Haskell types in the next section.</p>

<h3 id="leanpub-auto-introduction-to-haskell-types">Introduction to Haskell Types</h3>

<p>This is a good time to spend more time studying Haskell types. We will see more material on Haskell types throughout this book so this is just an introduction using the <strong>data</strong> expression to define a Type <strong>MyColors</strong> defined in the file <strong>MyColors.hs</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">data</code> <code class="kt">MyColors</code> <code class="ow">=</code> <code class="kt">Orange</code> <code class="o">|</code> <code class="kt">Red</code> <code class="o">|</code> <code class="kt">Blue</code> <code class="o">|</code> <code class="kt">Green</code> <code class="o">|</code> <code class="kt">Silver</code>
<code class="linenos">2 </code> <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">)</code>
</pre></div>

</figure>

<p>This example is incomplete so we will modify it soon. Line 1 defines the possible values for our new type <strong>MyColors</strong>. On line 2, we are asking the Haskell compiler to automatically generate a function <strong>show</strong> that can convert a value to a string. <strong>show</strong> is a standard function and in general we want it defined for all types. <strong>show</strong> converts an instance to a string value.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="n">colors</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="n">colors</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">show</code> <code class="kt">Red</code>
<code class="linenos"> 5 </code><code class="s">"Red"</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">c1</code> <code class="ow">=</code> <code class="kt">Green</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">c1</code>
<code class="linenos"> 8 </code><code class="kt">Green</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">c1</code>
<code class="linenos">10 </code><code class="nf">c1</code> <code class="ow">::</code> <code class="kt">MyColors</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Red</code> <code class="o">==</code> <code class="kt">Green</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="o">&lt;</code><code class="n">interactive</code><code class="o">&gt;:</code><code class="mi">60</code><code class="kt">:</code><code class="mi">5</code><code class="kt">:</code>
<code class="linenos">14 </code>    <code class="kt">No</code> <code class="kr">instance</code> <code class="n">for</code> <code class="p">(</code><code class="kt">Eq</code> <code class="kt">MyColors</code><code class="p">)</code> <code class="n">arising</code> <code class="n">from</code> <code class="n">a</code> <code class="n">use</code> <code class="kr">of</code> <code class="err">‘</code><code class="o">==</code><code class="err">’</code>
<code class="linenos">15 </code>    <code class="kt">In</code> <code class="n">the</code> <code class="n">expression</code><code class="kt">:</code> <code class="kt">Red</code> <code class="o">==</code> <code class="kt">Green</code>
<code class="linenos">16 </code>    <code class="kt">In</code> <code class="n">an</code> <code class="n">equation</code> <code class="n">for</code> <code class="err">‘</code><code class="n">it</code><code class="err">’</code><code class="kt">:</code> <code class="n">it</code> <code class="ow">=</code> <code class="kt">Red</code> <code class="o">==</code> <code class="kt">Green</code>
</pre></div>

</figure>

<p>What went wrong here? The infix function <strong>==</strong> checks for equality and we did not define equality functions for our new type. Let’s fix the definition in the file colors.hs:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">data</code> <code class="kt">MyColors</code> <code class="ow">=</code> <code class="kt">Orange</code> <code class="o">|</code> <code class="kt">Red</code> <code class="o">|</code> <code class="kt">Blue</code> <code class="o">|</code> <code class="kt">Green</code> <code class="o">|</code> <code class="kt">Silver</code>
<code class="linenos">2 </code> <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">,</code> <code class="kt">Eq</code><code class="p">)</code>
</pre></div>

</figure>

<p>Because we are deriving <strong>Eq</strong> we are also asking the compiler to generate code to see if two instances of this class are equal. If we wanted to be able to order our colors then we would also derive <strong>Ord</strong>.</p>

<p>Now our new type has <strong>show</strong>, <strong>==</strong>, and <strong>/=</strong> (inequality) defined:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="n">colors</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="n">colors</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Red</code> <code class="o">==</code> <code class="kt">Green</code>
<code class="linenos">5 </code><code class="kt">False</code>
<code class="linenos">6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Red</code> <code class="o">/=</code> <code class="kt">Green</code>
<code class="linenos">7 </code><code class="kt">True</code>
</pre></div>

</figure>

<p>Let’s also now derive <strong>Ord</strong> to have the compile generate a default function <strong>compare</strong> that operates on the type <strong>MyColors</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">data</code> <code class="kt">MyColors</code> <code class="ow">=</code> <code class="kt">Orange</code> <code class="o">|</code> <code class="kt">Red</code> <code class="o">|</code> <code class="kt">Blue</code> <code class="o">|</code> <code class="kt">Green</code> <code class="o">|</code> <code class="kt">Silver</code>
<code class="linenos">2 </code> <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">,</code> <code class="kt">Eq</code><code class="p">,</code> <code class="kt">Ord</code><code class="p">)</code>
</pre></div>

</figure>

<p>Because we are now deriving <strong>Ord</strong> the compiler will generate functions to calculate relative ordering for values of type <strong>MyColors</strong>. Let’s experiment with this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">MyColors</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">MyColors</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">compare</code>
<code class="linenos"> 5 </code><code class="nf">compare</code> <code class="ow">::</code> <code class="kt">Ord</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Ordering</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">compare</code> <code class="kt">Green</code> <code class="kt">Blue</code>
<code class="linenos"> 7 </code><code class="kt">GT</code>
<code class="linenos"> 8 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">compare</code> <code class="kt">Blue</code> <code class="kt">Green</code>
<code class="linenos"> 9 </code><code class="kt">LT</code>
<code class="linenos">10 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Orange</code> <code class="o">&lt;</code> <code class="kt">Red</code>
<code class="linenos">11 </code><code class="kt">True</code>
<code class="linenos">12 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Red</code> <code class="o">&lt;</code> <code class="kt">Orange</code>
<code class="linenos">13 </code><code class="kt">False</code>
<code class="linenos">14 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Green</code> <code class="o">&lt;</code> <code class="kt">Red</code>
<code class="linenos">15 </code><code class="kt">False</code>
<code class="linenos">16 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Green</code> <code class="o">&lt;</code> <code class="kt">Silver</code>
<code class="linenos">17 </code><code class="kt">True</code>
<code class="linenos">18 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Green</code> <code class="o">&gt;</code> <code class="kt">Red</code>
<code class="linenos">19 </code><code class="kt">True</code>
</pre></div>

</figure>

<p>Notice that the compiler generates a <strong>compare</strong> function for the type <strong>MyColors</strong> that orders values by the order that they appear in the <strong>data</strong> expression. What if you wanted to order them in string sort order? This is very simple: we will remove <strong>Ord</strong> from the deriving clause and define our own function <strong>compare</strong> for type <strong>MyColors</strong> instead of letting the compiler generate it for us:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">data</code> <code class="kt">MyColors</code> <code class="ow">=</code> <code class="kt">Orange</code> <code class="o">|</code> <code class="kt">Red</code> <code class="o">|</code> <code class="kt">Blue</code> <code class="o">|</code> <code class="kt">Green</code> <code class="o">|</code> <code class="kt">Silver</code>
<code class="linenos">2 </code> <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">,</code> <code class="kt">Eq</code><code class="p">)</code>
<code class="linenos">3 </code>          
<code class="linenos">4 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">MyColors</code> <code class="kr">where</code>
<code class="linenos">5 </code>  <code class="n">compare</code> <code class="n">c1</code> <code class="n">c2</code> <code class="ow">=</code> <code class="n">compare</code> <code class="p">(</code><code class="n">show</code> <code class="n">c1</code><code class="p">)</code> <code class="p">(</code><code class="n">show</code> <code class="n">c2</code><code class="p">)</code>
</pre></div>

</figure>

<p>In line 5 I am using the function <strong>show</strong> to convert instances of <strong>MyColors</strong> to strings and then the version of <strong>compare</strong> that is called in line 5 is the version the compiler wrote for us because we derived <strong>Show</strong>. Now the ordering is in string ascending sort order because we are using the <strong>compare</strong> function that is supplied for the type <strong>String</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">MyColors</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">MyColors</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">Green</code> <code class="o">&gt;</code> <code class="kt">Red</code>
<code class="linenos">5 </code><code class="kt">False</code>
</pre></div>

</figure>

<p>Our new type MyColors is a simple type. Haskell also supports hierarchies of types called <strong>Type</strong> <strong>Classes</strong> and the type we have seen earlier <strong>Foldable</strong> is an example of a type class that other types can inherit from. For now, consider sub-types of <strong>Foldable</strong> to be collections like lists and trees that can be iterated over.</p>

<p>I want you to get in the habit of using <strong>:type</strong> and <strong>:info</strong> (usually abbreviated to <strong>:t</strong> and <strong>:i</strong>) in the GHCi repl. Stop reading for a minute now and type <strong>:info Ord</strong> in an open repl. You will get a lot of output showing you all of the types that <strong>Ord</strong> is defined for. Here is a small bit of what gets printed:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">i</code> <code class="kt">Ord</code>
<code class="linenos"> 2 </code><code class="kr">class</code> <code class="kt">Eq</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="kt">Ord</code> <code class="n">a</code> <code class="kr">where</code>
<code class="linenos"> 3 </code>  <code class="n">compare</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Ordering</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="o">&lt;</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Bool</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="o">&lt;=</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Bool</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="o">&gt;</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Bool</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="o">&gt;=</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Bool</code>
<code class="linenos"> 8 </code>  <code class="n">max</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos"> 9 </code>  <code class="n">min</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos">10 </code>  	<code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
<code class="linenos">11 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">MyColors</code> <code class="c1">-- Defined at MyColors.hs:4:10</code>
<code class="linenos">12 </code><code class="kr">instance</code> <code class="p">(</code><code class="kt">Ord</code> <code class="n">a</code><code class="p">,</code> <code class="kt">Ord</code> <code class="n">b</code><code class="p">)</code> <code class="ow">=&gt;</code> <code class="kt">Ord</code> <code class="p">(</code><code class="kt">Either</code> <code class="n">a</code> <code class="n">b</code><code class="p">)</code>
<code class="linenos">13 </code>  <code class="c1">-- Defined in ‘Data.Either’</code>
<code class="linenos">14 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="kt">Ord</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code>
<code class="linenos">15 </code>  <code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
<code class="linenos">16 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">Word</code> <code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
<code class="linenos">17 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">Ordering</code> <code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
<code class="linenos">18 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">Int</code> <code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
<code class="linenos">19 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">Float</code> <code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
<code class="linenos">20 </code><code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">Double</code> <code class="c1">-- Defined in ‘ghc-prim-0.4.0.0:GHC.Classes’</code>
</pre></div>

</figure>

<p>Lines 1 through 8 show you that <strong>Ord</strong> is a subtype of <strong>Eq</strong> that defines functions <strong>compare</strong>, <strong>max</strong>, and <strong>min</strong> as well as the four operators <strong>&lt;</strong>, <strong>&lt;=</strong>, <strong>&gt;=</strong>, and <strong>&gt;=</strong>. When we customized the <strong>compare</strong> function for the type <strong>MyColors</strong>, we only implemented <strong>compare</strong>. That is all that we needed to do since the other operators rely on the implementation of <strong>compare</strong>.</p>

<p>Once again, I ask you to experiment with the example type <strong>MyColors</strong> in an open GHCi repl:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">max</code>
<code class="linenos">2 </code><code class="nf">max</code> <code class="ow">::</code> <code class="kt">Ord</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="kt">Green</code>
<code class="linenos">4 </code><code class="kt">Green</code> <code class="ow">::</code> <code class="kt">MyColors</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">i</code> <code class="kt">Green</code>
<code class="linenos">6 </code><code class="kr">data</code> <code class="kt">MyColors</code> <code class="ow">=</code> <code class="o">...</code> <code class="o">|</code> <code class="kt">Green</code> <code class="o">|</code> <code class="o">...</code> 	<code class="c1">-- Defined at MyColors.hs:1:39</code>
<code class="linenos">7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">max</code> <code class="kt">Green</code> <code class="kt">Red</code>
<code class="linenos">8 </code><code class="kt">Red</code>
</pre></div>

</figure>

<p>The following diagram shows a partial type hierarchy of a few types included in the standard Haskell Prelude (this is derived from the <a href="https://www.haskell.org/onlinereport/basic.html">Haskell Report at haskell.org</a>):</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 60%">
    <img src="images/example_type_hierarchy.png" alt="Example Haskell Type Hierarchy" style="width: 100%">
    <figcaption>Example Haskell Type Hierarchy</figcaption>
  </figure>
</div>


<p>Here you see that type <strong>Num</strong> and <strong>Ord</strong> are sub-types of type <strong>Eq</strong>, <strong>Real</strong> is a sub-type of <strong>Num</strong>, etc. We will see the types <strong>Monad</strong> and <strong>Functor</strong> in the next chapter.</p>

<h3 id="leanpub-auto-functions-are-pure">Functions Are Pure</h3>

<p>Again, it is worth pointing out that Haskell functions do not modify their inputs values. The common pattern is to pass immutable values to a function and modified values are returned. As a first example of this pattern we will look at the standard function <strong>map</strong> that takes two arguments: a function that converts a value of any type <strong>a</strong> to another type <strong>b</strong>, and a list of type <strong>a</strong>. Functions that take other functions as arguments are called <strong>higher</strong> <strong>order</strong> <strong>functions</strong>. The result is another list of the same length whose elements are of type <strong>b</strong> and the elements are calulated using the function passed as the first argument. Let’s look at a simple example using the function <strong>(+ 1)</strong> that adds 1 to a value:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">map</code>
<code class="linenos">2 </code><code class="nf">map</code> <code class="ow">::</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">b</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map</code> <code class="p">(</code><code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="p">[</code><code class="mi">10</code><code class="p">,</code><code class="mi">20</code><code class="p">,</code><code class="mi">30</code><code class="p">]</code>
<code class="linenos">4 </code><code class="p">[</code><code class="mi">11</code><code class="p">,</code><code class="mi">21</code><code class="p">,</code><code class="mi">31</code><code class="p">]</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map</code> <code class="p">(</code><code class="n">show</code> <code class="o">.</code> <code class="p">(</code><code class="o">+</code> <code class="mi">1</code><code class="p">))</code> <code class="p">[</code><code class="mi">10</code><code class="p">,</code><code class="mi">20</code><code class="p">,</code><code class="mi">30</code><code class="p">]</code>
<code class="linenos">6 </code><code class="p">[</code><code class="s">"11"</code><code class="p">,</code><code class="s">"21"</code><code class="p">,</code><code class="s">"31"</code><code class="p">]</code>
</pre></div>

</figure>

<p>In the first example, types <strong>a</strong> and <strong>b</strong> are the same, a <strong>Num</strong>. The second example used a composed function that adds 1 and then converts the example to a string. Remember: the function <strong>show</strong> converts a Haskell data value to a string. In this second example types <strong>a</strong> and <strong>b</strong> are different because the function is mapping a number to a string.</p>

<p>The directory <em>haskell_tutorial_cookbook_examples/Pure</em>  contains the examples for this chapter. We previously used the example file <em>Simple.hs</em>. Please note that in the rest of this book I will omit the git repository top level directory name haskell_tutorial_cookbook_examples and just specify the sub-directory name:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="nf">sum2</code> <code class="n">x</code> <code class="n">y</code> <code class="ow">=</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">6 </code>  <code class="n">putStrLn</code> <code class="p">(</code><code class="s">"1 + 2 = "</code> <code class="o">++</code> <code class="n">show</code> <code class="p">(</code><code class="n">sum2</code> <code class="mi">1</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>For now let’s just look at the mechanics of executing this file without using the REPL (started with <em>stack</em> <strong>ghci</strong>). We can simply build and run this example using <em>stack</em>, which is covered in some detail in Appendix A:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">stack</code> <code class="nv">build</code> <code class="o">--</code><code class="k">exec</code> <code class="nv">Simple</code>
</pre></div>

</figure>

<p>This command builds the project defined in the configuration files <em>Pure.cabal</em> and <em>stack.yaml</em> (the format and use of these files is briefly covered in detail in Appendix A and there is more <a href="https://docs.haskellstack.org/en/stable/yaml_configuration/">reference material here</a>). This example defines two functions: <strong>sum2</strong> and <strong>main</strong>. <strong>sum2</strong> is a pure Haskell function with no state, no interaction with the outside world like file IO, etc., and no non-determinism. <strong>main</strong> is an impure function, and we will look at impure Haskell code in some detail in the next chapter. As you might guess the output of this code snippet is</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code> <code class="ow">=</code> <code class="mi">3</code>
</pre></div>

</figure>

<p>To continue the tutorial on using pure Haskell functions, once again we will use <em>stack</em> to start an interactive repl during development:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">markw</code><code class="o">@</code><code class="n">linux</code><code class="kt">:~/</code><code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="mi">3</code>
<code class="linenos">3 </code><code class="mi">3</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="s">"dog"</code>
<code class="linenos">5 </code><code class="s">"dog"</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">main</code>
<code class="linenos">7 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">8 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>In this last listing I don’t show the information about your Haskell environment and the packages that were loaded. In repl listings in the remainder of this book I will continue to edit out this Haskell environment information for brevity. </p>

<p>Line 4 shows the use of the repl shortcut <em>:t</em> to print out the type of a string which is an array of [Char], and the type of the function <strong>main</strong> is of type <strong>IO Action</strong>, which we will explain in the next chapter. An IO action contains impure code where we can read and write files, perform a network operation, etc. and we will look at <strong>IO Action</strong> in the next chapter.</p>

<h3 id="leanpub-auto-using-parenthesis-or-the-special--character-and-operator-precedence">Using Parenthesis or the Special <strong>$</strong> Character and Operator Precedence</h3>

<p>We will look at operator and function precedence and the use of the <strong>$</strong> character to simplify using parenthesis in expessions. By the way, in Haskell there is not much difference between operators and function calls except operators like <strong>+</strong>, etc. which are by default infix while functions are usually prefix. So except for infix functions that are enclosed in backticks (e.g., <strong>10 <code>div</code> 3</strong>) Haskell usually uses prefix functions: a function followed by zero or more arguments. You can also use <strong>$</strong> that acts as an opening parenthesis with a not-shown closing parenthesis at the end of the current expression (which may be multi-line). Here are some examples:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">print</code> <code class="p">(</code><code class="mi">3</code> <code class="o">*</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="mi">6</code>
<code class="linenos"> 3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">print</code> <code class="o">$</code> <code class="mi">3</code> <code class="o">*</code> <code class="mi">2</code>
<code class="linenos"> 4 </code><code class="mi">6</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">last</code> <code class="p">(</code><code class="n">take</code> <code class="mi">10</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="p">])</code>
<code class="linenos"> 6 </code><code class="mi">10</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">last</code> <code class="o">$</code> <code class="n">take</code> <code class="mi">10</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="p">]</code>
<code class="linenos"> 8 </code><code class="mi">10</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">((</code><code class="n">take</code> <code class="mi">10</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="p">])</code> <code class="o">++</code> <code class="p">(</code><code class="n">take</code> <code class="mi">10</code> <code class="p">[</code><code class="mi">1000</code><code class="o">..</code><code class="p">]))</code>
<code class="linenos">10 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">10</code><code class="p">,</code><code class="mi">1000</code><code class="p">,</code><code class="mi">1001</code><code class="p">,</code><code class="mi">1002</code><code class="p">,</code><code class="mi">1003</code><code class="p">,</code><code class="mi">1004</code><code class="p">,</code><code class="mi">1005</code><code class="p">,</code><code class="mi">1006</code><code class="p">,</code><code class="mi">1007</code><code class="p">,</code><code class="mi">1008</code><code class="p">,</code><code class="mi">1009</code><code class="p">]</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">take</code> <code class="mi">10</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="p">]</code> <code class="o">++</code> <code class="n">take</code> <code class="mi">10</code> <code class="p">[</code><code class="mi">1000</code><code class="o">..</code><code class="p">]</code>
<code class="linenos">12 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">10</code><code class="p">,</code><code class="mi">1000</code><code class="p">,</code><code class="mi">1001</code><code class="p">,</code><code class="mi">1002</code><code class="p">,</code><code class="mi">1003</code><code class="p">,</code><code class="mi">1004</code><code class="p">,</code><code class="mi">1005</code><code class="p">,</code><code class="mi">1006</code><code class="p">,</code><code class="mi">1007</code><code class="p">,</code><code class="mi">1008</code><code class="p">,</code><code class="mi">1009</code><code class="p">]</code>
<code class="linenos">13 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">1</code> <code class="o">+</code> <code class="mi">2</code> <code class="o">*</code> <code class="p">(</code><code class="mi">4</code> <code class="o">*</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">14 </code><code class="mi">41</code>
<code class="linenos">15 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">2</code> <code class="o">*</code> <code class="mi">3</code> <code class="o">+</code> <code class="mi">10</code> <code class="o">*</code> <code class="mi">30</code>
<code class="linenos">16 </code><code class="mi">306</code>
</pre></div>

</figure>

<p>I use the GHCi command <strong>:info</strong> (<strong>:i</strong> is an abbreviation) to check both operator precedence and the function signature if the operator is converted to a function by enclosing it in parenthessis:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="o">*</code>
<code class="linenos"> 2 </code><code class="kr">class</code> <code class="kt">Num</code> <code class="n">a</code> <code class="kr">where</code>
<code class="linenos"> 3 </code>  <code class="o">...</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="o">*</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos"> 5 </code>  <code class="o">...</code>
<code class="linenos"> 6 </code>  	<code class="c1">-- Defined in ‘GHC.Num’</code>
<code class="linenos"> 7 </code><code class="kr">infixl</code> <code class="mi">7</code> <code class="o">*</code>
<code class="linenos"> 8 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="o">+</code>
<code class="linenos"> 9 </code><code class="kr">class</code> <code class="kt">Num</code> <code class="n">a</code> <code class="kr">where</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos">11 </code>  <code class="o">...</code>
<code class="linenos">12 </code>  	<code class="c1">-- Defined in ‘GHC.Num’</code>
<code class="linenos">13 </code><code class="kr">infixl</code> <code class="mi">6</code> <code class="o">+</code>
<code class="linenos">14 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="p">`</code><code class="n">div</code><code class="p">`</code>
<code class="linenos">15 </code><code class="kr">class</code> <code class="p">(</code><code class="kt">Real</code> <code class="n">a</code><code class="p">,</code> <code class="kt">Enum</code> <code class="n">a</code><code class="p">)</code> <code class="ow">=&gt;</code> <code class="kt">Integral</code> <code class="n">a</code> <code class="kr">where</code>
<code class="linenos">16 </code>  <code class="o">...</code>
<code class="linenos">17 </code>  <code class="n">div</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos">18 </code>  <code class="o">...</code>
<code class="linenos">19 </code>  	<code class="c1">-- Defined in ‘GHC.Real’</code>
<code class="linenos">20 </code><code class="kr">infixl</code> <code class="mi">7</code> <code class="p">`</code><code class="n">div</code><code class="p">`</code>
<code class="linenos">21 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">i</code> <code class="o">+</code>
<code class="linenos">22 </code><code class="kr">class</code> <code class="kt">Num</code> <code class="n">a</code> <code class="kr">where</code>
<code class="linenos">23 </code>  <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="linenos">24 </code>  <code class="o">...</code>
<code class="linenos">25 </code>  	<code class="c1">-- Defined in ‘GHC.Num’</code>
<code class="linenos">26 </code><code class="kr">infixl</code> <code class="mi">6</code> <code class="o">+</code>
</pre></div>

</figure>

<p>Notice how <strong>+</strong> has lower precedence than *.</p>

<p>Just to be clear, understand how operators are used as functions and also how functions can be used as infix operators:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">2</code> <code class="o">*</code> <code class="mi">3</code>
<code class="linenos">2 </code><code class="mi">6</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="o">*</code><code class="p">)</code> <code class="mi">2</code> <code class="mi">3</code>
<code class="linenos">4 </code><code class="mi">6</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">10</code> <code class="p">`</code><code class="n">div</code><code class="p">`</code> <code class="mi">3</code>
<code class="linenos">6 </code><code class="mi">3</code>
<code class="linenos">7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">div</code> <code class="mi">10</code> <code class="mi">3</code>
<code class="linenos">8 </code><code class="mi">3</code>
</pre></div>

</figure>

<p>Especially when you are just starting to use Haskell it is a good idea to also use <strong>:info</strong> to check the type signatures of standard functions that you use. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="n">last</code>
<code class="linenos">2 </code><code class="nf">last</code> <code class="ow">::</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="n">a</code> 	<code class="c1">-- Defined in ‘GHC.List’</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="n">map</code>
<code class="linenos">4 </code><code class="nf">map</code> <code class="ow">::</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">b</code><code class="p">]</code> 	<code class="c1">-- Defined in ‘GHC.Base’</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-lazy-evaluation">Lazy Evaluation</h3>

<p>Haskell is refered to as a <em>lazy</em> <em>language</em> because expressions are not evaluated until they are used. Consider the following example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos"> 2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">10</code><code class="p">]</code>
<code class="linenos"> 3 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">10</code><code class="p">]</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">take</code> <code class="mi">11</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="p">]</code>
<code class="linenos"> 5 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">10</code><code class="p">]</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">xs</code> <code class="ow">=</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="p">]</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">sprint</code> <code class="n">xs</code>
<code class="linenos"> 8 </code><code class="nf">xs</code> <code class="ow">=</code> <code class="kr">_</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">take</code> <code class="mi">5</code> <code class="n">xs</code>
<code class="linenos">10 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">sprint</code> <code class="n">xs</code>
<code class="linenos">12 </code><code class="nf">xs</code> <code class="ow">=</code> <code class="kr">_</code>
<code class="linenos">13 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>In line 2 we are creating a list with 11 elements. In line 4 we are doing two things:</p>

<ul>
  <li>Creating an infinitely long list containing ascending integers starting with 0.</li>
  <li>Fetching the first 11 elements of this infinitely long list. It is important to understand that in line 4 only the first 11 elements are generated because that is all the <strong>take</strong> function requires.</li>
</ul>

<p>In line 6 we are assigning another infinitely long list to the variable <strong>xs</strong> but the value of <strong>xs</strong> is unevaluated and a placeholder is stored to calculate values as required. In line 7 we use GHCi’s <strong>:sprint</strong> command to show a value without evaluating it. The output in line 8 <strong>_</strong> indicated that the expression has yet to be evaluated.</p>

<p>Lines 9 through 12 remind us that Haskell is a functional language: the <strong>take</strong> function used in line 9 does not change the value of its argument so <strong>xs</strong> as seen in lines 10 and 12 is still unevaluated.</p>

<h3 id="leanpub-auto-understanding-list-comprehensions">Understanding List Comprehensions</h3>

<p>Effectively using list comprehensions makes your code shorter, easier to understand, and easier to maintain. Let’s start out with a few GHCi repl examples. You will learn a new GHCi repl trick in this section: entering multiple line expressions by using <strong>:{</strong> and <strong>:}</strong> to delay evaluation until an entire expression is entered in the repl (listings in this section are reformatted to fit the page width):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">x</code> <code class="o">|</code> <code class="n">x</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="s">"cat"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"bird"</code><code class="p">]]</code>
<code class="linenos">2 </code><code class="p">[</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"bird"</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="p">{</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="p">[(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code> <code class="o">|</code> <code class="n">x</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="s">"cat"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"bird"</code><code class="p">],</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">y</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="mi">2</code><code class="p">]]</code>
<code class="linenos">6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="kt">:</code><code class="p">}</code>
<code class="linenos">7 </code><code class="p">[(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">2</code><code class="p">),(</code><code class="s">"dog"</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="s">"dog"</code><code class="p">,</code><code class="mi">2</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">2</code><code class="p">)]</code>
</pre></div>

</figure>

<p>The list comprehension on line 1 assigns the elements of the list <strong>[“cat”, “dog”, “bird”]</strong> one at a time to the variable <strong>x</strong> and then collects all these values of <strong>x</strong> in a list value that is the value of the list comprehension. The list comprehension in line 1 is hopefully easy to understand but when we bind and collect multiple variables the situation, as seen in the example in lines 4 and 5, is not as easy to understand. The thing to remember is that the first variable gets iterated as an “outer loop” and the second variable is iterated as the “inner loop.” List comprehensions can use many variables and the iteration ordering rule is the same: last variable iterates first, etc.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="p">{</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="p">[(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code> <code class="o">|</code> <code class="n">x</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">3</code><code class="p">],</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">y</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">3</code><code class="o">..</code><code class="mi">10</code><code class="p">]]</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="kt">:</code><code class="p">}</code>
<code class="p">[(</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="mi">0</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="mi">0</code><code class="p">,</code><code class="mi">5</code><code class="p">),(</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">),(</code><code class="mi">0</code><code class="p">,</code><code class="mi">9</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="mi">5</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">),</code>
 <code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">9</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="mi">5</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="mi">7</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="mi">9</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="mi">1</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="mi">5</code><code class="p">),</code>
 <code class="p">(</code><code class="mi">3</code><code class="p">,</code><code class="mi">7</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="mi">9</code><code class="p">)]</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">3</code><code class="o">..</code><code class="mi">10</code><code class="p">]</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">9</code><code class="p">]</code>
</pre></div>

</figure>

<p>In this last example we are generating all combinations of [0..3] and [1,3..10] and storing the combinations as two element tuples. You could also store then as lists:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">[[</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">]</code> <code class="o">|</code> <code class="n">x</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],</code> <code class="n">y</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">10</code><code class="p">,</code><code class="mi">11</code><code class="p">]]</code>
<code class="linenos">2 </code><code class="p">[[</code><code class="mi">1</code><code class="p">,</code><code class="mi">10</code><code class="p">],[</code><code class="mi">1</code><code class="p">,</code><code class="mi">11</code><code class="p">],[</code><code class="mi">2</code><code class="p">,</code><code class="mi">10</code><code class="p">],[</code><code class="mi">2</code><code class="p">,</code><code class="mi">11</code><code class="p">]]</code>
</pre></div>

</figure>

<p>List comprehensions can also contain filtering operations. Here is an example with one filter:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="p">{</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="p">[(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code> <code class="o">|</code> <code class="n">x</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="s">"cat"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"bird"</code><code class="p">],</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">y</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="mi">10</code><code class="p">],</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">y</code> <code class="p">`</code><code class="n">mod</code><code class="p">`</code> <code class="mi">3</code> <code class="o">==</code> <code class="mi">0</code><code class="p">]</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="kt">:</code><code class="p">}</code>
<code class="linenos">6 </code><code class="p">[(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">6</code><code class="p">),(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">9</code><code class="p">),</code>
<code class="linenos">7 </code> <code class="p">(</code><code class="s">"dog"</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="s">"dog"</code><code class="p">,</code><code class="mi">6</code><code class="p">),(</code><code class="s">"dog"</code><code class="p">,</code><code class="mi">9</code><code class="p">),</code>
<code class="linenos">8 </code> <code class="p">(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">6</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">9</code><code class="p">)]</code>
</pre></div>

</figure>

<p>Here is a similar example with two filters (we are also filtering out all possible values of <strong>x</strong> that start with the character ‘d’):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="p">{</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="p">[(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code> <code class="o">|</code> <code class="n">x</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="s">"cat"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"bird"</code><code class="p">],</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">y</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="mi">10</code><code class="p">],</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">y</code> <code class="p">`</code><code class="n">mod</code><code class="p">`</code> <code class="mi">3</code> <code class="o">==</code> <code class="mi">0</code><code class="p">,</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>          <code class="n">x</code> <code class="o">!!</code> <code class="mi">0</code> <code class="o">/=</code> <code class="sc">'d'</code><code class="p">]</code>
<code class="linenos">6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="kt">:</code><code class="p">}</code>
<code class="linenos">7 </code><code class="p">[(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">6</code><code class="p">),(</code><code class="s">"cat"</code><code class="p">,</code><code class="mi">9</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">3</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">6</code><code class="p">),(</code><code class="s">"bird"</code><code class="p">,</code><code class="mi">9</code><code class="p">)]</code>
</pre></div>

</figure>

<p>For simple filtering cases I usually use the <strong>filter</strong> function but list comprehensions are more versatile. List comprehensions are extremely useful - I use them frequently.</p>

<p>Lists are instances of the class <strong>Monad</strong> that we will cover in the next chapter (check out the section “List Comprehensions Using the <strong>do</strong> Notation”).</p>

<p>List comprehensions are powerful. I would like to end this section with another trick that does not use list comprehensions for building lists of tuple values: using the <strong>zip</strong> function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">animals</code> <code class="ow">=</code> <code class="p">[</code><code class="s">"cat"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"bird"</code><code class="p">]</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">zip</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="p">]</code> <code class="n">animals</code>
<code class="linenos">3 </code><code class="p">[(</code><code class="mi">1</code><code class="p">,</code><code class="s">"cat"</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="s">"dog"</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="s">"bird"</code><code class="p">)]</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="n">zip</code>
<code class="linenos">5 </code><code class="nf">zip</code> <code class="ow">::</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">b</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[(</code><code class="n">a</code><code class="p">,</code> <code class="n">b</code><code class="p">)]</code> 	<code class="c1">-- Defined in ‘GHC.List’</code>
</pre></div>

</figure>

<p>The function <strong>zip</strong> is often used in this way when we have a list of objects and we want to operate on the list while knowing the index of each element.</p>

<h3 id="leanpub-auto-haskell-rules-for-indenting-code">Haskell Rules for Indenting Code</h3>

<p>When a line of code is indented relative to the previous line of code, or several lines of code with additional indentation, then the indented lines act as if they were on the previous line. In other words, if code that should all be on one line must be split to multiple lines, then use indentation as a signal to the Haskell compiler.</p>

<p>Indentation of continuation lines should be uniform, starting in the same column. Here are some examples of good code, and code that will not compile:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>  <code class="kr">let</code> <code class="n">a</code> <code class="ow">=</code> <code class="mi">1</code>    <code class="c1">-- good </code>
<code class="linenos"> 2 </code>      <code class="n">b</code> <code class="ow">=</code> <code class="mi">2</code>    <code class="c1">-- good</code>
<code class="linenos"> 3 </code>      <code class="n">c</code> <code class="ow">=</code> <code class="mi">3</code>    <code class="c1">-- good</code>
<code class="linenos"> 4 </code>      
<code class="linenos"> 5 </code>  <code class="kr">let</code>
<code class="linenos"> 6 </code>    <code class="n">a</code> <code class="ow">=</code> <code class="mi">1</code>        <code class="c1">-- good </code>
<code class="linenos"> 7 </code>    <code class="n">b</code> <code class="ow">=</code> <code class="mi">2</code>        <code class="c1">-- good</code>
<code class="linenos"> 8 </code>    <code class="n">c</code> <code class="ow">=</code> <code class="mi">3</code>        <code class="c1">-- good</code>
<code class="linenos"> 9 </code>  <code class="kr">in</code> <code class="n">a</code> <code class="o">+</code> <code class="n">b</code> <code class="o">+</code> <code class="n">c</code>   <code class="c1">-- good</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>  <code class="kr">let</code> <code class="n">a</code> <code class="ow">=</code> <code class="mi">1</code>    <code class="c1">-- will not compile (bad) </code>
<code class="linenos">12 </code>       <code class="n">b</code> <code class="ow">=</code> <code class="mi">2</code>   <code class="c1">-- will not compile (bad)</code>
<code class="linenos">13 </code>      <code class="n">c</code> <code class="ow">=</code> <code class="mi">3</code>    <code class="c1">-- will not compile (bad)</code>
<code class="linenos">14 </code>      
<code class="linenos">15 </code>  <code class="kr">let</code>
<code class="linenos">16 </code>      <code class="n">a</code> <code class="ow">=</code> <code class="mi">1</code>    <code class="c1">-- will not compile (bad) </code>
<code class="linenos">17 </code>      <code class="n">b</code> <code class="ow">=</code> <code class="mi">2</code>    <code class="c1">-- will not compile (bad)</code>
<code class="linenos">18 </code>     <code class="n">c</code> <code class="ow">=</code> <code class="mi">3</code>     <code class="c1">-- will not compile (bad)</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>  <code class="kr">let</code> <code class="p">{</code>
<code class="linenos">21 </code>      <code class="n">a</code> <code class="ow">=</code> <code class="mi">1</code><code class="p">;</code>    <code class="c1">-- compiles but bad style (good) </code>
<code class="linenos">22 </code>        <code class="n">b</code> <code class="ow">=</code> <code class="mi">2</code><code class="p">;</code>  <code class="c1">-- compiles but bad style (good)</code>
<code class="linenos">23 </code>      <code class="n">c</code> <code class="ow">=</code> <code class="mi">3</code><code class="p">;</code>    <code class="c1">-- compiles but bad style (good)</code>
<code class="linenos">24 </code>    <code class="p">}</code> 
</pre></div>

</figure>

<p>If you use <em>C</em> <em>style</em> braces and semicolons to mark end of expressions, then indenting does not matter as seen in lines 20 through 24. Otherwise, uniform indentation is a hint to the compiler.</p>

<p>The same indenting rules apply to other types of <strong>do</strong> expressions which we will see throughout this book for <strong>do</strong>, <strong>if</strong>, and other types of <strong>do</strong> expressions.</p>

<h3 id="leanpub-auto-understanding-let-and-where">Understanding <strong>let</strong> and <strong>where</strong>
</h3>

<p>At first glance, <strong>let</strong> and <strong>where</strong> seem very similar in that they allow us to create temporary variables used inside functions. As the examples in the file <em>LetAndWhere.hs</em> show, there are important differences.</p>

<p>In the following code notice that when we use <strong>let</strong> in pure code inside a function, we then use <strong>in</strong> to indicate the start of an expression to be evaluated that uses any variables defined in a <strong>let</strong> expression. Inside a <strong>do</strong> code block the <strong>in</strong> token is not needed and will cause a parse error if you use it. <strong>do</strong> code blocks are a syntactic sugar for use in impure Haskell code and we will use it frequently later in the book.</p>

<p>You also do not use <strong>in</strong> inside a list comprehension as seen in the function <strong>testLetComprehension</strong> in the next code listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="nf">funnySummation</code> <code class="n">w</code> <code class="n">x</code> <code class="n">y</code> <code class="n">z</code> <code class="ow">=</code>
<code class="linenos"> 4 </code>  <code class="kr">let</code> <code class="n">bob</code> <code class="ow">=</code> <code class="n">w</code> <code class="o">+</code> <code class="n">x</code>
<code class="linenos"> 5 </code>      <code class="n">sally</code> <code class="ow">=</code> <code class="n">y</code> <code class="o">+</code> <code class="n">z</code>
<code class="linenos"> 6 </code>  <code class="kr">in</code> <code class="n">bob</code> <code class="o">+</code> <code class="n">sally</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nf">testLetComprehension</code> <code class="ow">=</code>
<code class="linenos"> 9 </code>  <code class="p">[(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">)</code> <code class="o">|</code> <code class="n">a</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">5</code><code class="p">],</code> <code class="kr">let</code> <code class="n">b</code> <code class="ow">=</code> <code class="mi">10</code> <code class="o">*</code> <code class="n">a</code><code class="p">]</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="nf">testWhereBlocks</code> <code class="n">a</code> <code class="ow">=</code>
<code class="linenos">12 </code>  <code class="n">z</code> <code class="o">*</code> <code class="n">q</code>
<code class="linenos">13 </code>    <code class="kr">where</code>
<code class="linenos">14 </code>      <code class="n">z</code> <code class="ow">=</code> <code class="n">a</code> <code class="o">+</code> <code class="mi">2</code>
<code class="linenos">15 </code>      <code class="n">q</code> <code class="ow">=</code> <code class="mi">2</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="nf">functionWithWhere</code> <code class="n">n</code>  <code class="ow">=</code>
<code class="linenos">18 </code>  <code class="p">(</code><code class="n">n</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="n">tenn</code>
<code class="linenos">19 </code>  <code class="kr">where</code>
<code class="linenos">20 </code>    <code class="n">tenn</code> <code class="ow">=</code> <code class="mi">10</code> <code class="o">*</code> <code class="n">n</code>
<code class="linenos">21 </code>          
<code class="linenos">22 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">23 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">funnySummation</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code>
<code class="linenos">24 </code>  <code class="kr">let</code> <code class="n">n</code> <code class="ow">=</code> <code class="s">"Rigby"</code>
<code class="linenos">25 </code>  <code class="n">print</code> <code class="n">n</code>
<code class="linenos">26 </code>  <code class="n">print</code> <code class="n">testLetComprehension</code>
<code class="linenos">27 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">testWhereBlocks</code> <code class="mi">11</code>
<code class="linenos">28 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">functionWithWhere</code> <code class="mi">1</code>
</pre></div>

</figure>

<p>Compare the <strong>let</strong> <strong>do</strong> expressions starting on line 4 and 24. The first <strong>let</strong> occurs in pure code and uses <strong>in</strong> to define one or more <strong>do</strong> expressions using values bound in the <strong>let</strong>. In line 24 we are inside a monad, specifically using the <strong>do</strong> notation and here <strong>let</strong> is used to define pure values that can be used later in the <strong>do</strong> <strong>do</strong> expression.</p>

<p>Loading the last code example and running the <strong>main</strong> function produces the following output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">LetAndWhere</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">LetAndWhere</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">5 </code><code class="mi">10</code>
<code class="linenos">6 </code><code class="s">"Rigby"</code>
<code class="linenos">7 </code><code class="p">[(</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="mi">10</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="mi">20</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="mi">30</code><code class="p">),(</code><code class="mi">4</code><code class="p">,</code><code class="mi">40</code><code class="p">),(</code><code class="mi">5</code><code class="p">,</code><code class="mi">50</code><code class="p">)]</code>
<code class="linenos">8 </code><code class="mi">26</code>
<code class="linenos">9 </code><code class="mi">20</code>
</pre></div>

</figure>

<p>This output is self explanatory except for line 7 that is the result of calling <strong>testLetComprehension</strong> that retuns an example list comprehension <strong>[(a,b)|a&lt;-[0..5],letb=10*a]</strong></p>

<h3 id="leanpub-auto-conditional-do-expressions-and-anonymous-functions">Conditional <strong>do</strong> Expressions and Anonymous Functions</h3>

<p>The examples in the next three sub-sections can be found in <em>haskell_tutorial_cookbook_examples/Pure/Conditionals.hs</em>. You should read the following sub-sections with this file loaded (some GHCi repl output removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">Conditionals</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">3 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">Conditionals</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">4 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<h4 id="leanpub-auto-simple-pattern-matching">Simple Pattern Matching</h4>

<p>We previously used the built-in functions <strong>head</strong> that returns the first element of a list and <strong>tail</strong> that  returns a list with the first element removed. We will define these functions ourselves using what is called wild card pattern matching. It is common to append the single quote character <strong>‘</strong> to built-in functions when we redefine them so we name our new functions <strong>head’</strong> and <strong>tail’</strong>. Remember when we used destructuring to access elements of a tuple? Wild card pattern matching is similar:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">head'</code><code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="kr">_</code><code class="p">)</code>  <code class="ow">=</code> <code class="n">x</code>
<code class="nf">tail'</code><code class="p">(</code><code class="kr">_</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code> <code class="n">xs</code>
</pre></div>

</figure>

<p>The underscore character <strong>_</strong> matches anything and ignores the matched value. Our <strong>head</strong> and <strong>tail</strong> definitions work as expected:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">head'</code> <code class="p">[</code><code class="s">"bird"</code><code class="p">,</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"cat"</code><code class="p">]</code>
<code class="linenos">2 </code><code class="s">"bird"</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">tail'</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">4 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="kr">type</code> <code class="n">head'</code>
<code class="linenos">6 </code><code class="nf">head'</code> <code class="ow">::</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="n">t</code>
<code class="linenos">7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">tail'</code>
<code class="linenos">8 </code><code class="nf">tail'</code> <code class="ow">::</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
</pre></div>

</figure>

<p>Of course we frequently do not want to ignore matched values. Here is a contrived example that expects a list of numbers and doubles the value of each element. As for all of the examples in this chapter, the following function is <em>pure</em>: it can not modify its argument(s) and always returns the same value given the same input argument(s):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">doubleList</code> <code class="kt">[]</code> <code class="ow">=</code> <code class="kt">[]</code>
<code class="linenos">2 </code><code class="nf">doubleList</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code> <code class="p">(</code><code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="n">x</code> <code class="kt">:</code> <code class="n">doubleList</code> <code class="n">xs</code>
</pre></div>

</figure>

<p>In line 1 we start by defining a pattern to match the empty list. It is necessary to define this <em>terminating</em> condition because we are using recursion in line 2 and eventually we reach the end of the input list and make the recursive call <strong>doubleList []</strong>. If you leave out line 1 you then will see a runtime error like “Non-exhaustive patterns in function doubleList.” As a Haskell beginner you probably hate Haskell error messages and as you start to write your own functions in source files and load them into a GHCi repl or compile them, you will initially probably hate compilation error messages also. I ask you to take on faith a bit of advice: Haskell error messages and warnings will end up saving you a lot of effort getting your code to work properly. Try to develop the attitude “Great! The Haskell compiler is helping me!” when you see runtime errors and compiler errors.</p>

<p>In line 2 notice how I didn’t need to use extra parenthesis because of the operator and function application precedence rules.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">doubleList</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">2 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">10</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">doubleList</code> 
<code class="linenos">4 </code><code class="nf">doubleList</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
</pre></div>

</figure>

<p>This function <strong>doubleList</strong> seems very unsatisfactory because it is so specific. What if we wanted to triple or quadruple the elements of a list? Do we want to write two new functions? You might think of adding an argument that is the multiplier like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">bumpList</code> <code class="n">n</code> <code class="kt">[]</code> <code class="ow">=</code> <code class="kt">[]</code>
<code class="linenos">2 </code><code class="nf">bumpList</code> <code class="n">n</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code> <code class="n">n</code> <code class="o">*</code> <code class="n">x</code> <code class="kt">:</code> <code class="n">bumpList</code> <code class="n">n</code> <code class="n">xs</code>
</pre></div>

</figure>

<p>is better, being more abstract and more general purpose. However, we will do much better.</p>

<p>Before generalizing the list manipuation process further, I would like to make a comment on coding style, specifically on not using unneeded parenthesis. In the last exmple defining <strong>bumpList</strong> if you have superfluous parenthesis like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">bumpList</code> <code class="n">n</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code> <code class="p">(</code><code class="n">n</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code> <code class="kt">:</code> <code class="n">bumpList</code> <code class="p">(</code><code class="n">n</code> <code class="n">xs</code><code class="p">)</code>
</pre></div>

</figure>

<p>then the code still works correctly and is fairly readable. I would like you to get in the habit of avoiding extra uneeded parenthesis and one tool for doing this is running <strong>hlint</strong> (installing <strong>hlint</strong> is covered in Appendix A) on your Haskell code. Using <strong>hlint</strong> source file will provide warnings/suggestions like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">hlint</code> <code class="kt">Conditionals</code><code class="o">.</code><code class="n">hs</code>
<code class="kt">Conditionals</code><code class="o">.</code><code class="n">hs</code><code class="kt">:</code><code class="mi">7</code><code class="kt">:</code><code class="mi">21</code><code class="kt">:</code> <code class="kt">Warning:</code> <code class="kt">Redundant</code> <code class="n">bracket</code>
<code class="kt">Found:</code>
  <code class="p">((</code><code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="n">x</code><code class="p">)</code> <code class="kt">:</code> <code class="n">doubleList</code> <code class="p">(</code><code class="n">xs</code><code class="p">)</code>
<code class="kt">Why</code> <code class="n">not</code><code class="kt">:</code>
  <code class="p">(</code><code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="n">x</code> <code class="kt">:</code> <code class="n">doubleList</code> <code class="p">(</code><code class="n">xs</code><code class="p">)</code>

<code class="kt">Conditionals</code><code class="o">.</code><code class="n">hs</code><code class="kt">:</code><code class="mi">7</code><code class="kt">:</code><code class="mi">43</code><code class="kt">:</code> <code class="kt">Error:</code> <code class="kt">Redundant</code> <code class="n">bracket</code>
<code class="kt">Found:</code>
  <code class="p">(</code><code class="n">xs</code><code class="p">)</code>
<code class="kt">Why</code> <code class="n">not</code><code class="kt">:</code>
  <code class="n">xs</code>
</pre></div>

</figure>

<p><strong>hlint</strong> is not only a tool for improving your code but also for teaching you how to better program using Haskell. Please note that <strong>hlint</strong> provides other suggestions for <em>Conditionals.hs</em> that I am ignoring that mostly suggest that I replace our mapping operations with using the built-in <strong>map</strong> function and use functional composition. The sample code is specifically to show examples of pattern matching and is not as concise as it could be.</p>

<p>Are you satisfied with the generality of the function <strong>bumpList</strong>? I hope that you are not! We should write a function that will apply an arbitrary function to each element of a list. We will call this function <strong>map’</strong> to avoid confusing our <strong>map’</strong> function with the built-in function <strong>map</strong>.</p>

<p>The following is a simple implementation of a map function (we will see Haskell’s standard map functions in the next section):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">map'</code> <code class="n">f</code> <code class="kt">[]</code> <code class="ow">=</code> <code class="kt">[]</code>
<code class="linenos">2 </code><code class="nf">map'</code> <code class="n">f</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code> <code class="n">f</code> <code class="n">x</code> <code class="kt">:</code> <code class="n">map'</code> <code class="n">f</code> <code class="n">xs</code>
</pre></div>

</figure>

<p>In line 2 we do not need parenthesis around <strong>f x</strong> because function application has a higher precidence than the operator <strong>:</strong> which adds an element to the beginning of a list.</p>

<p>Are you pleased with how concise this definition of a map function is? Is concise code like <strong>map’</strong> readable to you? Speaking as someone who has written hundreds of thousands of lines of Java code for customers, let me tell you that I love the conciseness and readability of Haskell! I appreciate the Java ecosystem with many useful libraries and frameworks and augmented like fine languages like Clojure and JRuby, but in my opinion using Haskell is a more enjoyable and generally more productive language and programming environment.</p>

<p>Let’s experiment with our <strong>map’</strong> function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map'</code> <code class="p">(</code><code class="o">*</code> <code class="mi">7</code><code class="p">)</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">2 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">14</code><code class="p">,</code><code class="mi">21</code><code class="p">,</code><code class="mi">28</code><code class="p">,</code><code class="mi">35</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map'</code> <code class="p">(</code><code class="o">+</code> <code class="mf">1.1</code><code class="p">)</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">4 </code><code class="p">[</code><code class="mf">1.1</code><code class="p">,</code><code class="mf">2.1</code><code class="p">,</code><code class="mf">3.1</code><code class="p">,</code><code class="mf">4.1</code><code class="p">,</code><code class="mf">5.1</code><code class="p">,</code><code class="mf">6.1</code><code class="p">]</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code>  <code class="n">map'</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">x</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">6 </code><code class="p">[</code><code class="mi">2</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">8</code><code class="p">,</code><code class="mi">10</code><code class="p">,</code><code class="mi">12</code><code class="p">]</code>
</pre></div>

</figure>

<p>Lines 1 and 3 should be understandable to you: we are creating a partial function like <strong>(* 7)</strong> and passing it to <strong>map’</strong> to apply to the list <strong>[0..5]</strong>.</p>

<p>The syntax for the function in line 5 is called an <em>anonymous</em> <em>function</em>. Lisp programers, like myself, refer to this as a lambda expression. In any case, I often prefer using <em>anonymous</em> <em>functions</em> when a function will not be used elsewhere. In line 5 the argement to the anonymous inline function is <strong>x</strong> and the body of the function is <strong>(x + 1) * 2</strong>.</p>

<p>I do ask you to not get carried away with using too many anonymous inline functions because they can make code a little less readable. When we put our code in modules, by default every symbol (like function names) in the module is externally visible. However, if we explicitly export symbols in a module <strong>do</strong> expression then only the explicitly exported symbols are visible by other code that uses the module. Here is an example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">Test2</code> <code class="p">(</code><code class="nf">doubler</code><code class="p">)</code> <code class="kr">where</code>

<code class="nf">map'</code> <code class="n">f</code> <code class="kt">[]</code> <code class="ow">=</code> <code class="kt">[]</code>
<code class="nf">map'</code> <code class="n">f</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code> <code class="p">(</code><code class="n">f</code> <code class="n">x</code><code class="p">)</code> <code class="kt">:</code> <code class="n">map'</code> <code class="n">f</code> <code class="n">xs</code>

<code class="nf">testFunc</code> <code class="n">x</code> <code class="ow">=</code> <code class="p">(</code><code class="n">x</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code> <code class="mi">2</code>

<code class="nf">doubler</code> <code class="n">xs</code> <code class="ow">=</code> <code class="n">map'</code> <code class="p">(</code><code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="n">xs</code>
</pre></div>

</figure>

<p>In this example <strong>map’</strong> and <strong>testFunc</strong> are hidden: any other module that imports <strong>Test2</strong> only has access to <strong>doubler</strong>. It might help for you to think of the exported functions roughly as an interface for a module.</p>

<h4 id="leanpub-auto-pattern-matching-with-guards">Pattern Matching With Guards</h4>

<p>We will cover two important concepts in this section: using guard pattern matching to make function definitions shorter and easier to read and we will look at the <strong>Maybe</strong> type and how it is used. The <strong>Maybe</strong> type is mostly used in non-pure Haskell code and we will use it heavily later. The Maybe type is a Monad (covered in the next chapter). I introduce the <strong>Maybe</strong> type here since its use fits naturally with guard patterns.</p>

<p>Guards are more flexible than the pattern matching seen in the last section. I use pattern matching for simple cases of destructuring data and guards when I need the flexibility. You may want to revisit the examples in the last section after experimenting with and understanding the examples seen here.</p>

<p>The examples for this section are in the file <em>Guards.hs</em>. As a first simple example we will implement the Ruby language “spaceship operator”:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">spaceship</code> <code class="n">n</code>
<code class="linenos">2 </code>  <code class="o">|</code> <code class="n">n</code> <code class="o">&lt;</code> <code class="mi">0</code>     <code class="ow">=</code> <code class="o">-</code><code class="mi">1</code>
<code class="linenos">3 </code>  <code class="o">|</code> <code class="n">n</code> <code class="o">==</code> <code class="mi">0</code>    <code class="ow">=</code> <code class="mi">0</code>
<code class="linenos">4 </code>  <code class="o">|</code> <code class="n">otherwise</code> <code class="ow">=</code> <code class="mi">1</code>
</pre></div>

</figure>

<p>Notice on line 1 that we do not use an <strong>=</strong> in the function definition when using guards. Each guard starts with <strong>|</strong>, contains a condition, and a value on the right side of the <strong>=</strong> sign.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">spaceship</code> <code class="p">(</code><code class="o">-</code><code class="mi">10</code><code class="p">)</code>
<code class="linenos">2 </code><code class="o">-</code><code class="mi">1</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">spaceship</code> <code class="mi">0</code>
<code class="linenos">4 </code><code class="mi">0</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">spaceship</code> <code class="mi">17</code>
<code class="linenos">6 </code><code class="mi">1</code>
</pre></div>

</figure>

<p>Remember that a literal negative number as seen in line 1 must be wrapped in parenthesis, otherwise the Haskell compiler will interpret <strong>-</strong> as an operator.</p>

<h4 id="leanpub-auto-case-expressions">Case Expressions</h4>

<p>Case <strong>do</strong> expressions match a value against a list of possible values. It is common to use the wildcard matching value <strong>_</strong> at the end of a case expression which can be of any type. Here is an example in the file <em>Cases.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="nf">numberOpinion</code> <code class="n">n</code> <code class="ow">=</code> 
<code class="linenos"> 4 </code>  <code class="kr">case</code> <code class="n">n</code> <code class="kr">of</code>
<code class="linenos"> 5 </code>    <code class="mi">0</code> <code class="ow">-&gt;</code> <code class="s">"Too low"</code>
<code class="linenos"> 6 </code>    <code class="mi">1</code> <code class="ow">-&gt;</code> <code class="s">"just right"</code>
<code class="linenos"> 7 </code>    <code class="kr">_</code> <code class="ow">-&gt;</code> <code class="s">"OK, that is a number"</code>
<code class="linenos"> 8 </code>    
<code class="linenos"> 9 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">10 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">numberOpinion</code> <code class="mi">0</code>
<code class="linenos">11 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">numberOpinion</code> <code class="mi">1</code>
<code class="linenos">12 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">numberOpinion</code> <code class="mi">2</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-if-then-else-expressions">If Then Else expressions</h4>

<p>Haskell has <strong>if</strong> <strong>then</strong> <strong>else</strong> syntax built into the language - <strong>if</strong> is not defined as a function. Personally I do not use <strong>if</strong> <strong>then</strong> <strong>else</strong> in Haskell very often. I mostly use simple pattern matching and guards. Here are some short examples from the file <em>IfThenElses.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">ageToString</code> <code class="n">age</code> <code class="ow">=</code>
  <code class="kr">if</code> <code class="n">age</code> <code class="o">&lt;</code> <code class="mi">21</code> <code class="kr">then</code> <code class="s">"minor"</code> <code class="kr">else</code> <code class="s">"adult"</code>
</pre></div>

</figure>

<p>All <strong>if</strong> statements must have both a <strong>then</strong> expression and a <strong>else</strong> expression.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">IfThenElses</code><code class="o">.</code><code class="n">hs</code> 
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">IfThenElses</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">ageToString</code> <code class="mi">15</code>
<code class="s">"minor"</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">ageToString</code> <code class="mi">37</code>
<code class="s">"adult"</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-maps">Maps</h3>

<p>Maps are simple to construct using a list of key-value tuples and are by default immutable. There is an example using mutable maps in the next chapter.</p>

<p>We will look at the module <strong>Data.Map</strong> first in a GHCi repl, then later in a few full code examples. There is something new in line 1 of the following listing: I am assigning a short alias <strong>M</strong> to the module <strong>Data.Map</strong>. In referencing a function like <strong>fromList</strong> (which converts a list of tuples to a map) in the <strong>Data.Map</strong> module I can use <strong>M.fromList</strong> instead of <strong>Data.Map.fromList</strong>. This is a common practice so when you read someone else’s Haskell code, one of the first things you should do when reading a Haskell source file is to make note of the module name abbreviations at the top of the file.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nf">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos"> 2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 3 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code>
<code class="linenos"> 4 </code><code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="ow">::</code> <code class="kt">Ord</code> <code class="n">k</code> <code class="ow">=&gt;</code> <code class="p">[(</code><code class="n">k</code><code class="p">,</code> <code class="n">a</code><code class="p">)]</code> <code class="ow">-&gt;</code> <code class="kt">M</code><code class="o">.</code><code class="kt">Map</code> <code class="n">k</code> <code class="n">a</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">aTestMap</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"height"</code><code class="p">,</code> <code class="mi">120</code><code class="p">),</code> <code class="p">(</code><code class="s">"weight"</code><code class="p">,</code> <code class="mi">15</code><code class="p">)]</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">aTestMap</code> 
<code class="linenos"> 7 </code><code class="nf">aTestMap</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="kt">M</code><code class="o">.</code><code class="kt">Map</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="n">a</code>
<code class="linenos"> 8 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">lookup</code>
<code class="linenos"> 9 </code><code class="nf">lookup</code> <code class="ow">::</code> <code class="kt">Eq</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="p">[(</code><code class="n">a</code><code class="p">,</code> <code class="n">b</code><code class="p">)]</code> <code class="ow">-&gt;</code> <code class="kt">Maybe</code> <code class="n">b</code>
<code class="linenos">10 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="kt">M</code><code class="o">.</code><code class="n">lookup</code>
<code class="linenos">11 </code><code class="kt">M</code><code class="o">.</code><code class="n">lookup</code> <code class="ow">::</code> <code class="kt">Ord</code> <code class="n">k</code> <code class="ow">=&gt;</code> <code class="n">k</code> <code class="ow">-&gt;</code> <code class="kt">M</code><code class="o">.</code><code class="kt">Map</code> <code class="n">k</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">Maybe</code> <code class="n">a</code>
<code class="linenos">12 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kt">M</code><code class="o">.</code><code class="n">lookup</code> <code class="s">"weight"</code> <code class="n">aTestMap</code> 
<code class="linenos">13 </code><code class="kt">Just</code> <code class="mi">15</code>
<code class="linenos">14 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">M</code><code class="o">&gt;</code> <code class="kt">M</code><code class="o">.</code><code class="n">lookup</code> <code class="s">"address"</code> <code class="n">aTestMap</code> 
<code class="linenos">15 </code><code class="kt">Nothing</code>
</pre></div>

</figure>

<p>The keys in a map must all be the same type and the values are also constrained to be of the same type. I almost always create maps using the helper function <strong>fromList</strong> in the module <strong>Data.Maps</strong>. We will only be using this method of map creation in later examples in this book so I am skipping coverage of other map building functions. I refer you to the <a href="https://www.stackage.org/haddock/lts-6.17/containers-0.5.6.2/Data-Map.html">Data.Map documentation</a>.</p>

<p>The following example shows one way to use the <strong>Just</strong> and <strong>Nothing</strong> return values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">MapExamples</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code> <code class="c1">-- from library containers</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">aTestMap</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"height"</code><code class="p">,</code> <code class="mi">120</code><code class="p">),</code> <code class="p">(</code><code class="s">"weight"</code><code class="p">,</code> <code class="mi">15</code><code class="p">)]</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="nf">getNumericValue</code> <code class="n">key</code> <code class="n">aMap</code> <code class="ow">=</code>
<code class="linenos"> 8 </code>  <code class="kr">case</code> <code class="kt">M</code><code class="o">.</code><code class="n">lookup</code> <code class="n">key</code> <code class="n">aMap</code> <code class="kr">of</code>
<code class="linenos"> 9 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="o">-</code><code class="mi">1</code>
<code class="linenos">10 </code>    <code class="kt">Just</code> <code class="n">value</code> <code class="ow">-&gt;</code> <code class="n">value</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">13 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">getNumericValue</code> <code class="s">"height"</code> <code class="n">aTestMap</code>
<code class="linenos">14 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">getNumericValue</code> <code class="s">"age"</code> <code class="n">aTestMap</code>
</pre></div>

</figure>

<p>The function <strong>getNumericValue</strong> shows one way to extract a value from an instance of type <strong>Maybe</strong>. The function <strong>lookup</strong> returns a <strong>Maybe</strong> value and in this example I use a <strong>case</strong> statement to test for a <strong>Nothing</strong> value or extract a wrapped value in a <strong>Just</strong> instance. Using <strong>Maybe</strong> in Haskell is a better alternative to checking for <strong>null</strong> values in <em>C</em> or <em>Java</em>.</p>

<p>The output from running the <strong>main</strong> function in module <strong>MapExamples</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">MapExamples</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">3 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">MapExamples</code>      <code class="p">(</code> <code class="kt">MapExamples</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">4 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">MapExamples</code><code class="o">.</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">MapExamples</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">6 </code><code class="mi">120</code>
<code class="linenos">7 </code><code class="o">-</code><code class="mi">1</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-sets">Sets</h3>

<p>The documentation of <strong>Data.Set.Class</strong> can <a href="https://www.stackage.org/haddock/lts-6.17/sets-0.0.5/Data-Set-Class.html">be found here</a> and contains overloaded functions for the types of sets defined <a href="https://www.stackage.org/package/sets">here</a>.</p>

<p>For most of my work and for the examples later in this book, I create immutable sets from lists and the only operation I perform is checking to see if a value is in the set. The following examples in GHCI repl are what you need for the material in this book:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Set</code> <code class="k">as</code> <code class="n">S</code> 
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">S</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">testSet</code> <code class="ow">=</code> <code class="kt">S</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"bird"</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">S</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">testSet</code>
<code class="linenos">4 </code><code class="nf">testSet</code> <code class="ow">::</code> <code class="kt">S</code><code class="o">.</code><code class="kt">Set</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">S</code><code class="o">&gt;</code> <code class="kt">S</code><code class="o">.</code><code class="n">member</code> <code class="s">"bird"</code> <code class="n">testSet</code>
<code class="linenos">6 </code><code class="kt">True</code>
<code class="linenos">7 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">S</code><code class="o">&gt;</code> <code class="kt">S</code><code class="o">.</code><code class="n">member</code> <code class="s">"snake"</code> <code class="n">testSet</code>
<code class="linenos">8 </code><code class="kt">False</code>
</pre></div>

</figure>

<p>Sets and Maps are immutable so I find creating maps using a lists of key-value tuples and creating sets using lists is fine. That said, coming from the mutable Java, Ruby, Python, and Lisp programming languages, it took me a while to get used to immutability in Haskell.</p>

<h3 id="leanpub-auto-more-on-functions">More on Functions</h3>

<p>In this section we will review what you have learned so far about Haskell functions and then look at a few more complex examples.</p>

<p>We have been defining and using simple functions and we have seen that operators behave like infix functions. We can make operators act as prefix functions by wrapping them in parenthesis:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">10</code> <code class="o">+</code> <code class="mi">1</code>
<code class="mi">11</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="mi">10</code> <code class="mi">1</code>
<code class="mi">11</code>
</pre></div>

</figure>

<p>and we can make functions act as infix operators:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">div</code> <code class="mi">100</code> <code class="mi">9</code>
<code class="mi">11</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">100</code> <code class="p">`</code><code class="n">div</code><code class="p">`</code> <code class="mi">9</code>
<code class="mi">11</code>
</pre></div>

</figure>

<p>This back tick function to operator syntax works with functions we write also:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">myAdd</code> <code class="n">a</code> <code class="n">b</code> <code class="ow">=</code> <code class="n">a</code> <code class="o">+</code> <code class="n">b</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">myAdd</code> 
<code class="nf">myAdd</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">myAdd</code> <code class="mi">1</code> <code class="mi">2</code>
<code class="mi">3</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="mi">1</code> <code class="p">`</code><code class="n">myAdd</code><code class="p">`</code> <code class="mi">2</code>
<code class="mi">3</code>
</pre></div>

</figure>

<p>Because we are working in a GHCi repl, in line 1 we use <strong>let</strong> to define the function <strong>myAdd</strong>. If you defined this function in a file and then loaded it, you would not use a <strong>let</strong>. </p>

<p>In the map examples where we applied a function to a list of values, so far we have used functions that map input values to the same return type, like this (using both partial function evaluation and anonymous inline function):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map</code> <code class="p">(</code><code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="p">[</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">]</code>
<code class="p">[</code><code class="mi">10</code><code class="p">,</code><code class="mi">12</code><code class="p">]</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code> <code class="p">[</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">]</code>
<code class="p">[</code><code class="mi">10</code><code class="p">,</code><code class="mi">12</code><code class="p">]</code>
</pre></div>

</figure>

<p>We can also map to different types; in this example we map from a list of <strong>Num</strong> values to a list containing sub-lists of <strong>Num</strong> values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">makeList</code> <code class="n">n</code> <code class="ow">=</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="n">n</code><code class="p">]</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">makeList</code> <code class="mi">3</code>
<code class="linenos">3 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">map</code> <code class="n">makeList</code> <code class="p">[</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code>
<code class="linenos">5 </code><code class="p">[[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">],[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]]</code>
</pre></div>

</figure>

<p>As usual, I recommend that when you work in a GHCi repl you check the types of functions and values you are working with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">makeList</code> 
<code class="linenos">2 </code><code class="nf">makeList</code> <code class="ow">::</code> <code class="p">(</code><code class="kt">Enum</code> <code class="n">t</code><code class="p">,</code> <code class="kt">Num</code> <code class="n">t</code><code class="p">)</code> <code class="ow">=&gt;</code> <code class="n">t</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">]</code>
<code class="linenos">4 </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">]</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">[[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">],[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]]</code>
<code class="linenos">6 </code><code class="p">[[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">],[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]]</code> <code class="ow">::</code> <code class="kt">Num</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">[[</code><code class="n">t</code><code class="p">]]</code>
<code class="linenos">7 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>In line 2 we see that for any type <strong>t</strong> the function signature is <strong>t -&gt; [t]</strong> where the compiler determines that <strong>t</strong> is constrained to be a <strong>Num</strong> or <strong>Enum</strong> by examining how the input variable is used as a range parameter for constructing a list. Let’s make a new function that works on any type:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">make3</code> <code class="n">x</code> <code class="ow">=</code> <code class="p">[</code><code class="n">x</code><code class="p">,</code><code class="n">x</code><code class="p">,</code><code class="n">x</code><code class="p">]</code>
<code class="linenos"> 2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">make3</code>
<code class="linenos"> 3 </code><code class="nf">make3</code> <code class="ow">::</code> <code class="n">t</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">make3</code> <code class="s">"abc"</code>
<code class="linenos"> 5 </code><code class="nf">make3</code> <code class="s">"abc"</code> <code class="ow">::</code> <code class="p">[[</code><code class="kt">Char</code><code class="p">]]</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">make3</code> <code class="s">"abc"</code>
<code class="linenos"> 7 </code><code class="p">[</code><code class="s">"abc"</code><code class="p">,</code><code class="s">"abc"</code><code class="p">,</code><code class="s">"abc"</code><code class="p">]</code>
<code class="linenos"> 8 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">make3</code> <code class="mf">7.1</code>
<code class="linenos"> 9 </code><code class="p">[</code><code class="mf">7.1</code><code class="p">,</code><code class="mf">7.1</code><code class="p">,</code><code class="mf">7.1</code><code class="p">]</code>
<code class="linenos">10 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">make3</code> <code class="mf">7.1</code>
<code class="linenos">11 </code><code class="nf">make3</code> <code class="mf">7.1</code> <code class="ow">::</code> <code class="kt">Fractional</code> <code class="n">t</code> <code class="ow">=&gt;</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
</pre></div>

</figure>

<p>Notice in line 3 that the function <strong>make3</strong> takes any type of input and returns a list of elements the same type as the input. We used <strong>makes3</strong> both with a string argument and a fractional (floating point) number) argument.</p>

<h3 id="leanpub-auto-comments-on-dealing-with-immutable-data-and-how-to-structure-programs">Comments on Dealing With Immutable Data and How to Structure Programs</h3>

<p>If you program in other programming languages that use mutable data then expect some feelings of disorientation initially when starting to use Haskell. It is common in other languages to maintain the state of a computation in an object and to mutate the value(s) in that object.  While I cover mutable state in the next chapter the common pattern in Haskell is to create a data structure (we will use lists in examples here) and pass it to functions that return a new modified copy of the data structure as the returned value from the function. It is very common to keep passing the modified new copy of a data structure through a series of function calls. This may seem cumbersome when you are starting to use Haskell but quickly feels natural.</p>

<p>The following example shows a simple case where a list is constructed in the function <strong>main</strong> and passed through two functions <strong>doubleOddElements</strong> and <strong>times10Elements</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">ChainedCalls</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>  
<code class="linenos"> 3 </code><code class="nf">doubleOddElements</code> <code class="ow">=</code>
<code class="linenos"> 4 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="kr">if</code> <code class="n">x</code> <code class="p">`</code><code class="n">mod</code><code class="p">`</code> <code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code> <code class="kr">then</code> <code class="n">x</code> <code class="kr">else</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">times10Elements</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="o">*</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos"> 7 </code>    
<code class="linenos"> 8 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 9 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">doubleOddElements</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">8</code><code class="p">]</code>
<code class="linenos">10 </code>  <code class="kr">let</code> <code class="n">aList</code> <code class="ow">=</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">]</code>
<code class="linenos">11 </code>  <code class="kr">let</code> <code class="n">newList</code> <code class="ow">=</code> <code class="n">times10Elements</code> <code class="o">$</code> <code class="n">doubleOddElements</code> <code class="n">aList</code>
<code class="linenos">12 </code>  <code class="n">print</code> <code class="n">newList</code>
<code class="linenos">13 </code>  <code class="kr">let</code> <code class="n">newList2</code> <code class="ow">=</code> <code class="p">(</code><code class="n">times10Elements</code> <code class="o">.</code> <code class="n">doubleOddElements</code><code class="p">)</code> <code class="n">aList</code>
<code class="linenos">14 </code>  <code class="n">print</code> <code class="n">newList2</code>
</pre></div>

</figure>

<p>Notice that the expressions being evaluated in lines 11 and 13 are the same. In line 11 we are applying function <strong>doubleOddElements</strong> to the value of <strong>aList</strong> and passing this value to the outer function <strong>times10Elements</strong>. In line 13 we are creating a new function from composing two existing functions: <strong>times10Elements . doubleOddElements</strong>. The parenthesis in line 13 are required because the <strong>.</strong> operator has lower precedence than the application of function <strong>doubleOddElements</strong> so without the parenthesis line 13 would evaluate as <strong>times10Elements (doubleOddElements aList)</strong> which is not what I intended and would throw an error.</p>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">Pure</code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">ChainedCalls</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">3 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">ChainedCalls</code>     <code class="p">(</code> <code class="kt">ChainedCalls</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">4 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">ChainedCalls</code><code class="o">.</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">ChainedCalls</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">6 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">10</code><code class="p">,</code><code class="mi">6</code><code class="p">,</code><code class="mi">14</code><code class="p">,</code><code class="mi">8</code><code class="p">]</code>
<code class="linenos">7 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">20</code><code class="p">,</code><code class="mi">20</code><code class="p">,</code><code class="mi">60</code><code class="p">,</code><code class="mi">40</code><code class="p">,</code><code class="mi">100</code><code class="p">]</code>
<code class="linenos">8 </code><code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">20</code><code class="p">,</code><code class="mi">20</code><code class="p">,</code><code class="mi">60</code><code class="p">,</code><code class="mi">40</code><code class="p">,</code><code class="mi">100</code><code class="p">]</code>
</pre></div>

</figure>

<p>Using immutable data takes some getting used to. I am going to digress for a minute to talk about working with Haskell. The steps I take when writing new Haskell code are:</p>

<ul>
  <li>Be sure I understand the problem</li>
  <li>How will data be represented - in Haskell I prefer using built-in types when possible</li>
  <li>Determine which Haskell standard functions, modules, and 3rd party modules might be useful</li>
  <li>Write and test the pure Haskell functions I think that I need for the application</li>
  <li>Write an impure <strong>main</strong> function that fetches required data, calls the pure functions (which are no longer pure in the sense they are called from impure code), and saves the processed data.</li>
</ul>

<p>I am showing you many tiny examples but please keep in mind the entire process of writing longer programs.</p>

<h3 id="leanpub-auto-error-handling">Error Handling</h3>

<p>We have seen examples of handling soft errors when no value can be calculated: use <strong>Maybe</strong>, <strong>Just</strong>, and <strong>Nothing</strong>. In bug free pure Haskell code, runtime exceptions should be very rare and I usually do not try to trap them.</p>

<p>Using <strong>Maybe</strong>, <strong>Just</strong>, and <strong>Nothing</strong> is much better than, for example, throwing an error using the standard function <strong>error</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="ne">error</code> <code class="s">"test error 123"</code>
<code class="o">***</code> <code class="kt">Exception:</code> <code class="n">test</code> <code class="ne">error</code> <code class="mi">123</code>
</pre></div>

</figure>

<p>and then, in impure code catching the errors, here is the <a href="https://wiki.haskell.org/Exception">documentation</a> for your reference.</p>

<p>In impure code that performs IO or accesses network resources that could possibly run out of memory, etc., runtime errors can occur and you could use the same <strong>try</strong> <strong>catch</strong> coding style that you have probably used in other programming languages. I admit this is my personal coding style but I don’t like to catch runtime errors. I spent a long time writing Java applications and when possible I preferred using uncaught exceptions and I usually do the same when writing impure Haskell code.</p>

<p>Because of Haskell’s type safety and excellent testing tools, it is possible to write nearly error free Haskell code. Later when we perform network IO we will rely on library support to handle errors and timeouts in a clean “Haskell like” way.</p>

<h3 id="leanpub-auto-testing-haskell-code">Testing Haskell Code</h3>

<p>The example in this section is found in the directory <em>haskell_tutorial_cookbook_examples/TestingHaskell</em>.</p>

<p>If you use <em>stack</em> to create a new project then the framework for testing is generated for you:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ stack new TestingHaskell
$ <code class="nb">cd</code> TestingHaskell
$  ls -R
LICENSE			app			<code class="nb">test</code>
Setup.hs		src
TestingHaskell.cabal	stack.yaml

TestingHaskell//app:
Main.hs

TestingHaskell//src:
Lib.hs

TestingHaskell//test:
Spec.hs

$ cat test/Spec.hs 
main :: IO <code class="o">()</code>
<code class="nv">main</code> <code class="o">=</code> putStrLn <code class="s2">"Test suite not yet implemented"</code>
$ stack setup
$ stack build
</pre></div>

</figure>

<p>This <em>stack</em> generated project is more complex than the project I created manually in the directory <em>haskell_tutorial_cookbook_examples/Pure</em>. The file <em>Setup.hs</em> is a placeholder and uses any module named <strong>Main</strong> in the <em>app</em> directory. This module, defined in <em>app/Main.hs</em>, imports the module <strong>Lib</strong> defined in <em>src/Lib.hs</em>.</p>

<p>The generated test does not do anything, but let’s run it anyway:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ stack <code class="nb">test</code>
Registering TestingHaskell-0.1.0.0...
TestingHaskell-0.1.0.0: <code class="nb">test</code> <code class="o">(</code>suite: TestingHaskell-test<code class="o">)</code>
             
Progress: <code class="m">1</code>/2 Test suite not yet implemented
             
Completed <code class="m">2</code> action<code class="o">(</code>s<code class="o">)</code>.
</pre></div>

</figure>

<p>In the generated project, I made a few changes:</p>

<ul>
  <li>removed src/Lib.hs</li>
  <li>added src/MyColors.hs providing the type MyColors that we defined earlier</li>
  <li>modified app/Main.hs to use the MyColors type</li>
  <li>added tests to test/Spec.hs</li>
</ul>

<p>Here is the contents of <em>TestingHaskell/src/MyColors.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">MyColors</code> <code class="kr">where</code>

<code class="kr">data</code> <code class="kt">MyColors</code> <code class="ow">=</code> <code class="kt">Orange</code> <code class="o">|</code> <code class="kt">Red</code> <code class="o">|</code> <code class="kt">Blue</code> <code class="o">|</code> <code class="kt">Green</code> <code class="o">|</code> <code class="kt">Silver</code>
 <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">,</code> <code class="kt">Eq</code><code class="p">)</code>
          
<code class="kr">instance</code> <code class="kt">Ord</code> <code class="kt">MyColors</code> <code class="kr">where</code>
  <code class="n">compare</code> <code class="n">c1</code> <code class="n">c2</code> <code class="ow">=</code> <code class="n">compare</code> <code class="p">(</code><code class="n">show</code> <code class="n">c1</code><code class="p">)</code> <code class="p">(</code><code class="n">show</code> <code class="n">c2</code><code class="p">)</code>
</pre></div>

</figure>

<p>And the new <em>test/Spec.hs</em> file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">import</code> <code class="nn">Test.Hspec</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">MyColors</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos"> 6 </code><code class="nf">main</code> <code class="ow">=</code> <code class="n">hspec</code> <code class="n">spec</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nf">spec</code> <code class="ow">::</code> <code class="kt">Spec</code>
<code class="linenos"> 9 </code><code class="nf">spec</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">10 </code>  <code class="n">describe</code> <code class="s">"head"</code> <code class="o">$</code> <code class="kr">do</code>
<code class="linenos">11 </code>    <code class="n">it</code> <code class="s">"test removing first list element"</code> <code class="o">$</code> <code class="kr">do</code>
<code class="linenos">12 </code>      <code class="n">head</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]</code> <code class="p">`</code><code class="n">shouldBe</code><code class="p">`</code> <code class="mi">1</code>
<code class="linenos">13 </code>      <code class="n">head</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"ran"</code><code class="p">]</code> <code class="p">`</code><code class="n">shouldBe</code><code class="p">`</code> <code class="s">"dog"</code> <code class="c1">-- should fail</code>
<code class="linenos">14 </code>  <code class="n">describe</code> <code class="s">"MyColors tests"</code> <code class="o">$</code> <code class="kr">do</code>
<code class="linenos">15 </code>    <code class="n">it</code> <code class="s">"test custom 'compare' function"</code> <code class="o">$</code> <code class="kr">do</code>
<code class="linenos">16 </code>      <code class="kt">MyColors</code><code class="o">.</code><code class="kt">Green</code> <code class="o">&lt;</code> <code class="kt">MyColors</code><code class="o">.</code><code class="kt">Red</code> <code class="p">`</code><code class="n">shouldBe</code><code class="p">`</code> <code class="kt">True</code>
<code class="linenos">17 </code>      <code class="kt">Red</code> <code class="o">&gt;</code> <code class="kt">Silver</code> <code class="p">`</code><code class="n">shouldBe</code><code class="p">`</code> <code class="kt">True</code>                <code class="c1">-- should fail</code>
</pre></div>

</figure>

<p>Notice how two of the tests are meant to fail as an example. Let’s run the tests:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="n">stack</code> <code class="n">test</code>
<code class="linenos"> 2 </code><code class="kt">TestingHaskell</code><code class="o">-</code><code class="mf">0.1</code><code class="o">.</code><code class="mf">0.0</code><code class="kt">:</code> <code class="n">test</code> <code class="p">(</code><code class="n">suite</code><code class="kt">:</code> <code class="kt">TestingHaskell</code><code class="o">-</code><code class="n">test</code><code class="p">)</code>
<code class="linenos"> 3 </code>             
<code class="linenos"> 4 </code><code class="kt">Progress:</code> <code class="mi">1</code><code class="o">/</code><code class="mi">2</code>
<code class="linenos"> 5 </code><code class="nf">head</code>
<code class="linenos"> 6 </code>  <code class="n">test</code> <code class="n">removing</code> <code class="n">first</code> <code class="n">list</code> <code class="n">element</code> <code class="kt">FAILED</code> <code class="p">[</code><code class="mi">1</code><code class="p">]</code>
<code class="linenos"> 7 </code><code class="kt">MyColors</code> <code class="n">tests</code>
<code class="linenos"> 8 </code>  <code class="n">test</code> <code class="n">custom</code> <code class="n">'compare'</code> <code class="n">function</code> <code class="kt">FAILED</code> <code class="p">[</code><code class="mi">2</code><code class="p">]</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="kt">Failures:</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code>  <code class="n">test</code><code class="o">/</code><code class="kt">Spec</code><code class="o">.</code><code class="n">hs</code><code class="kt">:</code><code class="mi">13</code><code class="kt">:</code> 
<code class="linenos">13 </code>  <code class="mi">1</code><code class="p">)</code> <code class="n">head</code> <code class="n">test</code> <code class="n">removing</code> <code class="n">first</code> <code class="n">list</code> <code class="n">element</code>
<code class="linenos">14 </code>       <code class="n">expected</code><code class="kt">:</code> <code class="s">"dog"</code>
<code class="linenos">15 </code>        <code class="n">but</code> <code class="n">got</code><code class="kt">:</code> <code class="s">"the"</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>  <code class="n">test</code><code class="o">/</code><code class="kt">Spec</code><code class="o">.</code><code class="n">hs</code><code class="kt">:</code><code class="mi">17</code><code class="kt">:</code> 
<code class="linenos">18 </code>  <code class="mi">2</code><code class="p">)</code> <code class="kt">MyColors</code> <code class="n">tests</code> <code class="n">test</code> <code class="n">custom</code> <code class="n">'compare'</code> <code class="n">function</code>
<code class="linenos">19 </code>       <code class="n">expected</code><code class="kt">:</code> <code class="kt">True</code>
<code class="linenos">20 </code>        <code class="n">but</code> <code class="n">got</code><code class="kt">:</code> <code class="kt">False</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="kt">Randomized</code> <code class="n">with</code> <code class="n">seed</code> <code class="mi">1233887367</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="kt">Finished</code> <code class="kr">in</code> <code class="mf">0.0139</code> <code class="n">seconds</code>
<code class="linenos">25 </code><code class="mi">2</code> <code class="n">examples</code><code class="p">,</code> <code class="mi">2</code> <code class="n">failures</code>
<code class="linenos">26 </code>             
<code class="linenos">27 </code><code class="kt">Completed</code> <code class="mi">2</code> <code class="n">action</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="o">.</code>
<code class="linenos">28 </code><code class="kt">Test</code> <code class="n">suite</code> <code class="n">failure</code> <code class="n">for</code> <code class="n">package</code> <code class="kt">TestingHaskell</code><code class="o">-</code><code class="mf">0.1</code><code class="o">.</code><code class="mf">0.0</code>
<code class="linenos">29 </code>    <code class="kt">TestingHaskell</code><code class="o">-</code><code class="n">test</code><code class="kt">:</code>  <code class="n">exited</code> <code class="n">with</code><code class="kt">:</code> <code class="kt">ExitFailure</code> <code class="mi">1</code>
<code class="linenos">30 </code><code class="kt">Logs</code> <code class="n">printed</code> <code class="n">to</code> <code class="n">console</code>
</pre></div>

</figure>

<p>In line one with <strong>stack test</strong> we are asking <em>stack</em> to run app tests in the subdirectory <em>test</em>. All Haskell source files in subdirectory <em>test</em> are assumed to be test files. In the listing for file <em>test/Spec.hs</em> we have two tests that fail on purpose and you see the output for the failed tests at lines 12-15 and 17-20.</p>

<p>Because the Haskell compiler does such a good job at finding type errors I have fewer errors in my Haskell code compared to languages like Ruby and Common Lisp. As a result I find myself writing fewer tests for my Haskell code than I would write in other languages. Still, I recommend some tests for each of your projects; decide for yourself how much relative effort you want to put into writing tests.</p>

<h3 id="leanpub-auto-pure-haskell-wrap-up">Pure Haskell Wrap Up</h3>

<p>I hope you are starting to get an appreciation for using composition of functions and higher order functions to enable us to compose programs from smaller pieces that can be joined together.</p>

<p>This composition is made easier when using pure functions that always return the same value when called with the same type of arguments.</p>

<p>We will continue to see examples of how lazy evaluation simplifies code because we can use infinitely large lists with the assurance that values are not calculated until they are needed.</p>

<p>In addition to Haskell code generally having fewer errors (after it gets by the compiler!) other advantages of functional programming include more concise code that is easy to read and understand once you get some experience with the language.</p>


<h2 id="leanpub-auto-tutorial-on-impure-haskell-programming">Tutorial on Impure Haskell Programming</h2>

<p>One of the great things about Haskell is that the language encourages us to think of our code in two parts:</p>

<ul>
  <li>Pure functional code (functions have no side effects) that is easy to write and test. Functional code tends to be shorter and less likely to be imperative (i.e., more functional, using maps and recursion, and less use of loops as in Java or C++).</li>
  <li>Impure code that deals with side effects like file and network IO, maintaining state in a typesafe way, and isolate imperative code that has side effects.</li>
</ul>

<p>In his excellent Functional Programming with Haskell class at <a href="http://edx.org">eDX</a> Erik Meijer described pure code as being islands in the ocean and the ocean representing impure code. He says that it is a design decision how much of your code is pure (islands) and how much is impure (the ocean). This model of looking at Haskel programs works for me.</p>

<p>My use the word “impure” is common for refering to Haskell code with side effects. Haskell is a purely functional language and side effects like I/O are best handled in a pure functional way using by wrapping pure values in <strong>Mondads</strong>.</p>

<p>In addition to showing you reusable examples of impure code that you will likely need in your own programs, a major theme of this chapter is handling impure code in a convenient type safe fashion. Any <strong>Monad</strong>, which wraps a single value, is used to safely manage state. I will introduce you to using <strong>Monad</strong> types as required for the examples in this chapter. This tutorial style introduction will prepare you for understanding the sample applications later.</p>

<h3 id="leanpub-auto-hello-io--monad">Hello IO () Monad</h3>

<p>I showed you many examples of pure code in the last chapter but most examples in source files (as opposed to those shown in a GHCi repl) had a bit of impure code in them: the <strong>main</strong> function like the following that simply writes a string of characters to standard output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="n">print</code> <code class="s">"hello world"</code>
</pre></div>

</figure>

<p>The type of function <strong>main</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">main</code>
<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
</pre></div>

</figure>

<p>The <strong>IO ()</strong> monad is an IO value wrapped in a type safe way. Because Haskell is a lazy evaluation language, the value is not evaluated until it is used. Every <strong>IO ()</strong> action returns exactly one value. Think of the word “mono” (or “one”) when you think of Monads because they always return one value. Monads are also used to connnect together parts of a program.</p>

<p>What is it about the function <strong>main</strong> in the last example that makes its type an <strong>IO ()</strong>? Consider the simple <strong>main</strong> function here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">NoIO</code> <code class="kr">where</code>

<code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="kr">let</code> <code class="n">i</code> <code class="ow">=</code> <code class="mi">1</code> <code class="kr">in</code>
    <code class="mi">2</code> <code class="o">*</code> <code class="n">i</code>
</pre></div>

</figure>

<p>and its type:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">NoIO</code>
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">NoIO</code>             <code class="p">(</code> <code class="kt">NoIO</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">NoIO</code><code class="o">.</code>
<code class="o">*</code><code class="kt">NoIO</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="mi">2</code>
<code class="o">*</code><code class="kt">NoIO</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">main</code>
<code class="nf">main</code> <code class="ow">::</code> <code class="kt">Integer</code>
<code class="o">*</code><code class="kt">NoIO</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>OK, now you see that there is nothing special about a <strong>main</strong> function: it gets its type from the type of value returned from the function. It is common to have the return type depend on the function argument types. The first example returns a type <strong>IO ()</strong> because it returns a print <strong>do</strong> expression:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">print</code>
<code class="nf">print</code> <code class="ow">::</code> <code class="kt">Show</code> <code class="n">a</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">putStrLn</code>
<code class="nf">putStrLn</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
</pre></div>

</figure>

<p>The function <strong>print</strong> shows the enclosing quote characters when displaying a string while <strong>putStrLn</strong> does not. In the first example, what happens when we stitch together several expressions that have type <strong>IO ()</strong>? Consider:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="n">print</code> <code class="mi">1</code>
  <code class="n">print</code> <code class="s">"cat"</code>
</pre></div>

</figure>

<p>Function <strong>main</strong> is still of type <strong>IO ()</strong>. You have seen <strong>do</strong> expressions frequently in examples and now we will dig into what the <strong>do</strong> expression is and why we use it.</p>

<p>The <strong>do</strong> notation makes working with monads easier. There are alternatives to using <strong>do</strong> that we will look at later.</p>

<p>One thing to note is that if you are doing bindings inside a <strong>do</strong> expression using a <strong>let</strong> with a <strong>in</strong> expression, you need to wrap the bindings in a new (inner) <strong>do</strong> expression if there is more than one line of code following the <strong>let</strong> statement. The way to avoid requiring a nested <strong>do</strong> expression is to not use <strong>in</strong> in a <strong>let</strong> expression inside a <strong>do</strong> block of code. Yes, this sounds complicated but let’s clear up any confusion by looking at the examples found in the file <em>ImPure/DoLetExample.hs</em> (you might also want to look at the similar example file <em>ImPure/DoLetExample2.hs</em> that uses <em>bind</em> operators instead of a <strong>do</strong> statement; we will look at <em>bind</em> operators in the next section):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">DoLetExample</code> <code class="kr">where</code>
  
<code class="nf">example1</code> <code class="ow">=</code> <code class="kr">do</code>  <code class="c1">-- good style</code>
  <code class="n">putStrLn</code> <code class="s">"Enter an integer number:"</code>
  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
  <code class="kr">let</code> <code class="n">number</code> <code class="ow">=</code> <code class="p">(</code><code class="n">read</code> <code class="n">s</code> <code class="ow">::</code> <code class="kt">Int</code><code class="p">)</code> <code class="o">+</code> <code class="mi">2</code>
  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Number plus 2 = "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="n">number</code><code class="p">)</code>

<code class="nf">example2</code> <code class="ow">=</code> <code class="kr">do</code>  <code class="c1">-- avoid using "in" inside a do statement</code>
  <code class="n">putStrLn</code> <code class="s">"Enter an integer number:"</code>
  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
  <code class="kr">let</code> <code class="n">number</code> <code class="ow">=</code> <code class="p">(</code><code class="n">read</code> <code class="n">s</code> <code class="ow">::</code> <code class="kt">Int</code><code class="p">)</code> <code class="o">+</code> <code class="mi">2</code> <code class="kr">in</code>
    <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Number plus 2 = "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="n">number</code><code class="p">)</code>

<code class="nf">example3</code> <code class="ow">=</code> <code class="kr">do</code>  <code class="c1">-- avoid using "in" inside a do statement</code>
  <code class="n">putStrLn</code> <code class="s">"Enter an integer number:"</code>
  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
  <code class="kr">let</code> <code class="n">number</code> <code class="ow">=</code> <code class="p">(</code><code class="n">read</code> <code class="n">s</code> <code class="ow">::</code> <code class="kt">Int</code><code class="p">)</code> <code class="o">+</code> <code class="mi">2</code> <code class="kr">in</code>
    <code class="kr">do</code> <code class="c1">-- this do is required since we have two dependent statements:</code>
      <code class="n">putStrLn</code> <code class="s">"Result is:"</code>
      <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Number plus 2 = "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="n">number</code><code class="p">)</code>

<code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="n">example1</code>
  <code class="n">example2</code>
  <code class="n">example3</code>
</pre></div>

</figure>

<p>You should use the pattern in function <strong>example1</strong> and not the pattern in <strong>example2</strong>. The <strong>do</strong> expression is syntactic sugar that allows programmers to string together a sequence of operations that can mix pure and impure code.</p>

<p>To be clear, the left arrow <strong>&lt;-</strong> is used when the expression on the right side is some type of <strong>IO ()</strong> that needs to be <em>lifted</em> before being used. A <strong>let</strong> <strong>do</strong> expression is used when the right side expression is a pure value.</p>

<p>On lines 6 and 12 we are using function <strong>read</strong> to converting a string read out of <strong>IO String ()</strong> to an integer value. Remember that the value of <strong>s</strong> (from calling <strong>readLine</strong>) is an <strong>IO ()</strong> so in the same way you might read from a file, in this example we are reading a value from an <strong>IO ()</strong> value.</p>

<h3 id="leanpub-auto-a-note-about--and--operators">A Note About <strong>&gt;&gt;</strong> and <strong>&gt;&gt;=</strong> Operators</h3>

<p>So far in this book I have been using the syntactic sugar of the <strong>do</strong> expression to work with Monads like <strong>IO ()</strong> and I will usually use this syntactic sugar for the rest of this book.</p>

<p>Even though I find it easier to write and read code using <strong>do</strong>, many Haskell programmers prefer <strong>&gt;&gt;</strong> and <strong>&gt;&gt;=</strong> so let’s go over these operators so you won’t be confused when reading Haskell code that uses them. Also, when we use <strong>do</strong> expressions in code the compiler generates similar code using these <strong>&gt;&gt;</strong> and <strong>&gt;&gt;=</strong> operators.</p>

<p>The Monad type class defines the operators <strong>&gt;&gt;=</strong> and <strong>return</strong>. We turn to the GHCi repl to experiment with and learn about these operators:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="o">&gt;&gt;</code><code class="p">)</code>
<code class="linenos">2 </code><code class="p">(</code><code class="o">&gt;&gt;</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Monad</code> <code class="n">m</code> <code class="ow">=&gt;</code> <code class="n">m</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">b</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">b</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="o">&gt;&gt;=</code><code class="p">)</code>
<code class="linenos">4 </code><code class="p">(</code><code class="o">&gt;&gt;=</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Monad</code> <code class="n">m</code> <code class="ow">=&gt;</code> <code class="n">m</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">b</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">return</code>
<code class="linenos">6 </code><code class="nf">return</code> <code class="ow">::</code> <code class="kt">Monad</code> <code class="n">m</code> <code class="ow">=&gt;</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">a</code>
</pre></div>

</figure>

<p>We start with the <strong>return</strong> function type <strong>return :: Monad m ⇒ a -&gt; m a</strong> which tells us that for a monad <strong>m</strong> the function <strong>return</strong> takes a value and wraps it in a monad. We will see examples of the <strong>return</strong> function used to return a wrapped value from a function that returns <strong>IO ()</strong> values. The <em>bind</em> operator <strong>(&gt;&gt;)</strong> is used to evaluate two expressions in sequence. As an example, we can replace this <strong>do</strong> expression:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="n">example1</code>
  <code class="n">example2</code>
  <code class="n">example3</code>
</pre></div>

</figure>

<p>with the following:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">main</code> <code class="ow">=</code> <code class="n">example1</code> <code class="o">&gt;&gt;</code> <code class="n">example2</code> <code class="o">&gt;&gt;</code> <code class="n">example3</code>
</pre></div>

</figure>

<p>The operator <strong>&gt;&gt;=</strong> is similar to <strong>&gt;&gt;</strong> except that it evaluates the left hand expression and pipes its value into the right hand side expression. The left hand side expression is evaluated to some type of <strong>IO ()</strong> and the expression on the right hand side typically reads from the input <strong>IO ()</strong>. An example will make this simpler to understand:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">module</code> <code class="nn">DoLetExample3</code> <code class="kr">where</code>
<code class="linenos">2 </code>  
<code class="linenos">3 </code><code class="nf">example3</code> <code class="ow">=</code>  <code class="n">putStrLn</code> <code class="s">"Enter an integer number:"</code> <code class="o">&gt;&gt;</code>  <code class="n">getLine</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="nf">example4</code> <code class="n">mv</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">6 </code>  <code class="kr">let</code> <code class="n">number</code> <code class="ow">=</code> <code class="p">(</code><code class="n">read</code> <code class="n">mv</code> <code class="ow">::</code> <code class="kt">Int</code><code class="p">)</code> <code class="o">+</code> <code class="mi">2</code>
<code class="linenos">7 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Number plus 2 = "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="n">number</code><code class="p">)</code>
<code class="linenos">8 </code>
<code class="linenos">9 </code><code class="nf">main</code> <code class="ow">=</code> <code class="n">example3</code> <code class="o">&gt;&gt;=</code> <code class="n">example4</code>
</pre></div>

</figure>

<p>Note that I could have used a <strong>do</strong> statement to define function <strong>example3</strong> but used a <em>bind</em> operator instead. Let’s run this example and look at the function types. Please don’t just quickly read through the following listing; when you understand what is happening in this example then for the rest of your life programming in Haskell things will be easier for you:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos"> 2 </code><code class="kt">Enter</code> <code class="n">an</code> <code class="n">integer</code> <code class="n">number</code><code class="kt">:</code>
<code class="linenos"> 3 </code><code class="mi">1</code>
<code class="linenos"> 4 </code><code class="kt">Number</code> <code class="n">plus</code> <code class="mi">2</code> <code class="ow">=</code> <code class="mi">3</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">example3</code>
<code class="linenos"> 6 </code><code class="nf">example3</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="kt">String</code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">example4</code>
<code class="linenos"> 8 </code><code class="nf">example4</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">main</code>
<code class="linenos">10 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">x</code> <code class="ow">=</code> <code class="n">example3</code>
<code class="linenos">12 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="n">x</code>
<code class="linenos">13 </code><code class="kt">Enter</code> <code class="n">an</code> <code class="n">integer</code> <code class="n">number</code><code class="kt">:</code>
<code class="linenos">14 </code><code class="mi">4</code>
<code class="linenos">15 </code><code class="s">"4"</code>
<code class="linenos">16 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">x</code>
<code class="linenos">17 </code><code class="nf">x</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="kt">String</code>
<code class="linenos">18 </code><code class="o">*</code><code class="kt">DoLetExample3</code><code class="o">&gt;</code> <code class="n">x</code> <code class="o">&gt;&gt;=</code> <code class="n">example4</code>
<code class="linenos">19 </code><code class="kt">Enter</code> <code class="n">an</code> <code class="n">integer</code> <code class="n">number</code><code class="kt">:</code>
<code class="linenos">20 </code><code class="mi">3</code>
<code class="linenos">21 </code><code class="kt">Number</code> <code class="n">plus</code> <code class="mi">2</code> <code class="ow">=</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>The interesting part starts at line 11 when we define <strong>x</strong> to be the returned value from calling <strong>example3</strong>. Remember that Haskell is a lazy language: evaluation is postponed until a value is actually used.</p>

<p>Working inside a GHCi repl is like working interactively inside a <strong>do</strong> expression. When we evaluate <strong>x</strong> in line 12 then the code in function <strong>example3</strong> is actually executed (notice this is where the user prompt to enter a number occurs). In line 18 we are re-evaluationg the value in <strong>x</strong> and passing the resulting <strong>IO String ()</strong> value to the function <strong>example4</strong>.</p>

<p>Haskell is a “piecemeal” programming language as are the Lisp family of languages where a repl is used to write little pieces code that are collected into programs. For simple code in Haskell (and Lisp languages) I do sometimes directly enter code into a text editor but very ofter I start in a repl, experiment, debug, refine, and then copy into an edited file.</p>

<h3 id="leanpub-auto-console-io-example-with-stack-configuration">Console IO Example with Stack Configuration</h3>

<p>The directory <em>CommandLineApps</em> contains two simple applications that interact with STDIO, that is to write to the console and read from the keyboard. The first example can be found in file <em>CommandLineApp/CommandLine1.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>  
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">System.IO</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.Char</code> <code class="p">(</code><code class="nf">toUpper</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 7 </code>  <code class="n">putStrLn</code> <code class="s">"Enter a line of text for test 1:"</code>
<code class="linenos"> 8 </code>  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
<code class="linenos"> 9 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"As upper case:</code><code class="se">\t</code><code class="s">"</code> <code class="o">++</code> <code class="p">(</code><code class="n">map</code> <code class="n">toUpper</code> <code class="n">s</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="n">main</code>
</pre></div>

</figure>

<p>Lines 3 and 4 import the entire <strong>System.IO</strong> module (that is, import all exported symbols from <strong>System.IO</strong>) and just the function <strong>toUpper</strong> from module <strong>Data.Char</strong>. <strong>System.IO</strong> is a standard Haskell module and we do not have to do anything special to import it. The <strong>Data.Char</strong> is stored in the package <strong>text</strong>. The package <strong>text</strong> is contained in the library package <strong>base</strong> which is specified in the <em>CommandLineApp.cabal</em> configuration file that we will look at soon.</p>

<p>Use of the <strong>&lt;-</strong> assignment in line 8 in the last Haskell listing is important to understand. It might occur to you to leave out line 8 and just place the <strong>getLine</strong> function call directly in line 9, like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"As upper case:</code><code class="se">\t</code><code class="s">"</code> <code class="o">++</code> <code class="p">(</code><code class="n">map</code> <code class="n">toUpper</code> <code class="n">getLine</code><code class="p">)</code>
</pre></div>

</figure>

<p>If you try this (please do!) you will see compilation errors like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="w">  </code><code class="n">Couldn</code><code class="err">'</code><code class="n">t</code><code class="w"> </code><code class="k">match</code><code class="w"> </code><code class="n">expected</code><code class="w"> </code><code class="n">type</code><code class="w"> </code><code class="err">‘</code><code class="o">[</code><code class="n">Char</code><code class="o">]</code><code class="err">’</code><code class="w"> </code><code class="k">with</code><code class="w"> </code><code class="n">actual</code><code class="w"> </code><code class="n">type</code><code class="w"> </code><code class="err">‘</code><code class="n">IO</code><code class="w"> </code><code class="n">String</code><code class="err">’</code><code class="w"></code>
<code class="linenos">2 </code><code class="w">  </code><code class="ow">In</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="k">second</code><code class="w"> </code><code class="n">argument</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="err">‘</code><code class="k">map</code><code class="err">’</code><code class="p">,</code><code class="w"> </code><code class="n">namely</code><code class="w"> </code><code class="err">‘</code><code class="n">getLine</code><code class="err">’</code><code class="w"></code>
<code class="linenos">3 </code><code class="w">  </code><code class="ow">In</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="k">second</code><code class="w"> </code><code class="n">argument</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="err">‘</code><code class="p">(</code><code class="o">++</code><code class="p">)</code><code class="err">’</code><code class="p">,</code><code class="w"> </code><code class="n">namely</code><code class="w"> </code><code class="err">‘</code><code class="p">(</code><code class="k">map</code><code class="w"> </code><code class="n">toUpper</code><code class="w"> </code><code class="n">getLine</code><code class="p">)</code><code class="err">’</code><code class="w"></code>
</pre></div>

</figure>

<p>The type of <strong>getLine</strong> is an <strong>IO ()</strong> that is a wrapped IO call. The value is not computed until it is used. The <strong>&lt;-</strong> assignment in line 8 evaluates the IO call and unwraps the result of the IO operation so that it can be used.</p>

<p>I don’t spend much time covering <em>stack</em> project configuration files in this book but I do recommend that as you work through examples to also look for a file in each example directory ending with the file extension <em>.cabal</em> that specified which packages need to be loaded. For some examples it might take a while to download and configure libraries the first time you run either <em>stack build</em> or <em>stack ghci</em> in an example directory.</p>

<p>The Haskell stack project in the <strong>CommandLineApp</strong> directory has five target applications as we can see in the <strong>CommandLineApp.cabal</strong> file. I am not going to go into much detail about the project cabal and stack.yaml files generated by stack when you create a new project except for configuration data that I had to add manually; in this case, I added two executable targets at the end of the cabal file (note: the project in the github repository for this book has more executable targets, I just show a few here):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">executable</code> <code class="nv">CommandLine1</code>
<code class="linenos"> 2 </code>  <code class="nv">hs</code><code class="o">-</code><code class="nv">source</code><code class="o">-</code><code class="nv">dirs</code>:      .
<code class="linenos"> 3 </code>  <code class="nv">main</code><code class="o">-</code><code class="nv">is</code>:             <code class="nv">CommandLine1</code>.<code class="nv">hs</code>
<code class="linenos"> 4 </code>  <code class="nv">default</code><code class="o">-</code><code class="nv">language</code>:    <code class="nv">Haskell2010</code>
<code class="linenos"> 5 </code>  <code class="nv">build</code><code class="o">-</code><code class="nv">depends</code>:       <code class="nv">base</code> <code class="o">&gt;=</code> <code class="mi">4</code>.<code class="mi">7</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code> <code class="mi">5</code>
<code class="linenos"> 6 </code>  
<code class="linenos"> 7 </code><code class="nv">executable</code> <code class="nv">CommandLine2</code>
<code class="linenos"> 8 </code>  <code class="nv">hs</code><code class="o">-</code><code class="nv">source</code><code class="o">-</code><code class="nv">dirs</code>:      .
<code class="linenos"> 9 </code>  <code class="nv">main</code><code class="o">-</code><code class="nv">is</code>:             <code class="nv">CommandLine2</code>.<code class="nv">hs</code>
<code class="linenos">10 </code>  <code class="nv">default</code><code class="o">-</code><code class="nv">language</code>:    <code class="nv">Haskell2010</code>
<code class="linenos">11 </code>  <code class="nv">build</code><code class="o">-</code><code class="nv">depends</code>:       <code class="nv">base</code> <code class="o">&gt;=</code> <code class="mi">4</code>.<code class="mi">7</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code> <code class="mi">5</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="nv">executable</code> <code class="nv">ReadTextFile</code>
<code class="linenos">14 </code>  <code class="nv">hs</code><code class="o">-</code><code class="nv">source</code><code class="o">-</code><code class="nv">dirs</code>:      .
<code class="linenos">15 </code>  <code class="nv">main</code><code class="o">-</code><code class="nv">is</code>:             <code class="nv">ReadTextFile</code>.<code class="nv">hs</code>
<code class="linenos">16 </code>  <code class="nv">default</code><code class="o">-</code><code class="nv">language</code>:    <code class="nv">Haskell2010</code>
<code class="linenos">17 </code>  <code class="nv">build</code><code class="o">-</code><code class="nv">depends</code>:       <code class="nv">base</code> <code class="o">&gt;=</code> <code class="mi">4</code>.<code class="mi">7</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code> <code class="mi">5</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="nv">executable</code> <code class="nv">GameLoop1</code>
<code class="linenos">20 </code>  <code class="nv">hs</code><code class="o">-</code><code class="nv">source</code><code class="o">-</code><code class="nv">dirs</code>:      .
<code class="linenos">21 </code>  <code class="nv">main</code><code class="o">-</code><code class="nv">is</code>:             <code class="nv">GameLoop1</code>.<code class="nv">hs</code>
<code class="linenos">22 </code>  <code class="nv">default</code><code class="o">-</code><code class="nv">language</code>:    <code class="nv">Haskell2010</code>
<code class="linenos">23 </code>  <code class="nv">build</code><code class="o">-</code><code class="nv">depends</code>:       <code class="nv">base</code> <code class="o">&gt;=</code> <code class="mi">4</code>.<code class="mi">7</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code> <code class="mi">5</code>, <code class="nv">time</code>
<code class="linenos">24 </code>        
<code class="linenos">25 </code><code class="nv">executable</code> <code class="nv">GameLoop2</code>
<code class="linenos">26 </code>  <code class="nv">hs</code><code class="o">-</code><code class="nv">source</code><code class="o">-</code><code class="nv">dirs</code>:      .
<code class="linenos">27 </code>  <code class="nv">main</code><code class="o">-</code><code class="nv">is</code>:             <code class="nv">GameLoop2</code>.<code class="nv">hs</code>
<code class="linenos">28 </code>  <code class="nv">default</code><code class="o">-</code><code class="nv">language</code>:    <code class="nv">Haskell2010</code>
<code class="linenos">29 </code>  <code class="nv">build</code><code class="o">-</code><code class="nv">depends</code>:       <code class="nv">base</code> <code class="o">&gt;=</code> <code class="mi">4</code>.<code class="mi">7</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code> <code class="mi">5</code>, <code class="k">random</code>
</pre></div>

</figure>

<p>The executable name determines the compiled and linked executable file name. For line 1, an executable file “CommandLine1” (or “CommandLine1.exe”” on Windows) will be generated. The parameter <strong>hs-source-dirs</strong> is a comma separated list of source file directories. In this simple example all Haskell source files are in the project’s top level directory “../”. The <strong>build-depends</strong> is a comma separated list of module libraries; here we only use the base built-in modules packaged with Haskell.</p>

<p>Let’s use a GHCi repl to poke at this code and understand it better. The project defined in <em>CommandLineApp/CommandLineApp.cabal</em> contains many executable targets so when we enter a GHCi repl, the available targets are shown and you can choose one; in this case I am selecting the first target defined in the <em>cabal</em> file. In later GHCi repl listings, I will edit out this output for brevity:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code>
<code class="linenos"> 4 </code><code class="kt">The</code> <code class="n">main</code> <code class="kr">module</code> <code class="err">to</code> <code class="err">load</code> <code class="err">is</code> <code class="err">ambiguous.</code> <code class="nn">Candidates</code> <code class="n">are</code><code class="kt">:</code> 
<code class="linenos"> 5 </code><code class="mi">1</code><code class="o">.</code> <code class="kt">Package</code> <code class="p">`</code><code class="kt">CommandLineApp'</code> <code class="n">component</code> <code class="n">exe</code><code class="kt">:CommandLine1</code> <code class="n">with</code> <code class="n">main</code><code class="o">-</code><code class="n">is</code> <code class="n">file</code><code class="kt">:</code> <code class="o">/</code><code class="kt">Users</code><code class="o">/</code><code class="n">mar</code><code class="nf">\</code>
<code class="linenos"> 6 </code><code class="nf">kw</code><code class="o">/</code><code class="kt">GITHUB</code><code class="o">/</code><code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">CommandLineApp</code><code class="o">/</code><code class="kt">CommandLine1</code><code class="o">.</code><code class="n">hs</code>
<code class="linenos"> 7 </code><code class="mi">2</code><code class="o">.</code> <code class="kt">Package</code> <code class="p">`</code><code class="kt">CommandLineApp'</code> <code class="n">component</code> <code class="n">exe</code><code class="kt">:CommandLine2</code> <code class="n">with</code> <code class="n">main</code><code class="o">-</code><code class="n">is</code> <code class="n">file</code><code class="kt">:</code> <code class="o">/</code><code class="kt">Users</code><code class="o">/</code><code class="n">mar</code><code class="nf">\</code>
<code class="linenos"> 8 </code><code class="nf">kw</code><code class="o">/</code><code class="kt">GITHUB</code><code class="o">/</code><code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">CommandLineApp</code><code class="o">/</code><code class="kt">CommandLine2</code><code class="o">.</code><code class="n">hs</code>
<code class="linenos"> 9 </code><code class="mi">3</code><code class="o">.</code> <code class="kt">Package</code> <code class="p">`</code><code class="kt">CommandLineApp'</code> <code class="n">component</code> <code class="n">exe</code><code class="kt">:ReadTextFile</code> <code class="n">with</code> <code class="n">main</code><code class="o">-</code><code class="n">is</code> <code class="n">file</code><code class="kt">:</code> <code class="o">/</code><code class="kt">Users</code><code class="o">/</code><code class="n">mar</code><code class="nf">\</code>
<code class="linenos">10 </code><code class="nf">kw</code><code class="o">/</code><code class="kt">GITHUB</code><code class="o">/</code><code class="n">haskell_tutorial_cookbook_examples</code><code class="o">/</code><code class="kt">CommandLineApp</code><code class="o">/</code><code class="kt">ReadTextFile</code><code class="o">.</code><code class="n">hs</code>
<code class="linenos">11 </code><code class="kt">You</code> <code class="n">can</code> <code class="n">specify</code> <code class="n">which</code> <code class="n">one</code> <code class="n">to</code> <code class="n">pick</code> <code class="n">by</code><code class="kt">:</code> 
<code class="linenos">12 </code> <code class="o">*</code> <code class="kt">Specifying</code> <code class="n">targets</code> <code class="n">to</code> <code class="n">stack</code> <code class="n">ghci</code> <code class="n">e</code><code class="o">.</code><code class="n">g</code><code class="o">.</code> <code class="n">stack</code> <code class="n">ghci</code> <code class="kt">CommandLineApp:</code><code class="n">exe</code><code class="kt">:CommandLine1</code>
<code class="linenos">13 </code> <code class="o">*</code> <code class="kt">Specifying</code> <code class="n">what</code> <code class="n">the</code> <code class="n">main</code> <code class="n">is</code> <code class="n">e</code><code class="o">.</code><code class="n">g</code><code class="o">.</code> <code class="n">stack</code> <code class="n">ghci</code> <code class="c1">--main-is CommandLineApp:exe:CommandL\</code>
<code class="linenos">14 </code><code class="nf">ine1</code>
<code class="linenos">15 </code> <code class="o">*</code> <code class="kt">Choosing</code> <code class="n">from</code> <code class="n">the</code> <code class="n">candidate</code> <code class="n">above</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos">16 </code><code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code> <code class="o">*</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="kt">Specify</code> <code class="n">main</code> <code class="kr">module</code> <code class="err">to</code> <code class="err">use</code> <code class="err">(press</code> <code class="err">enter</code> <code class="err">to</code> <code class="err">load</code> <code class="err">none):</code> <code class="err">1</code>
<code class="linenos">19 </code><code class="nn">Loading</code> <code class="n">main</code> <code class="kr">module</code> <code class="err">from</code> <code class="err">cadidate</code> <code class="err">1,</code> <code class="err">--main-is</code> <code class="err">/</code><code class="nn">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="kt">GITHUB</code><code class="o">/</code><code class="n">haskell_tutorial_</code><code class="nf">\</code>
<code class="linenos">20 </code><code class="nf">cookbook_examples</code><code class="o">/</code><code class="kt">CommandLineApp</code><code class="o">/</code><code class="kt">CommandLine1</code><code class="o">.</code><code class="n">hs</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="kt">Configuring</code> <code class="kt">GHCi</code> <code class="n">with</code> <code class="n">the</code> <code class="n">following</code> <code class="n">packages</code><code class="kt">:</code> <code class="kt">CommandLineApp</code>
<code class="linenos">23 </code><code class="kt">GHCi</code><code class="p">,</code> <code class="n">version</code> <code class="mf">7.10</code><code class="o">.</code><code class="mi">3</code><code class="kt">:</code> <code class="n">http</code><code class="kt">://</code><code class="n">www</code><code class="o">.</code><code class="n">haskell</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ghc</code><code class="o">/</code>  <code class="kt">:?</code> <code class="n">for</code> <code class="n">help</code>
<code class="linenos">24 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="n">none</code><code class="o">.</code>
<code class="linenos">25 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="o">/</code><code class="kt">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="kt">GITHUB</code><code class="o">/</code><code class="n">haskell_tutorial_cookbook_</code><code class="nf">\</code>
<code class="linenos">26 </code><code class="nf">examples</code><code class="o">/</code><code class="kt">CommandLineApp</code><code class="o">/</code><code class="kt">CommandLine1</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">27 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos">28 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">main</code>
<code class="linenos">29 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="n">b</code>
<code class="linenos">30 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">info</code> <code class="n">main</code>
<code class="linenos">31 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="n">b</code>
<code class="linenos">32 </code><code class="c1">-- Defined at /Users/markw/GITHUB/haskell_tutorial_cookbook_examples/CommandLineApp/\</code>
<code class="linenos">33 </code><code class="kt">CommandLine1</code><code class="o">.</code><code class="n">hs</code><code class="kt">:</code><code class="mi">6</code><code class="kt">:</code><code class="mi">1</code>
<code class="linenos">34 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">getLine</code>
<code class="linenos">35 </code><code class="nf">getLine</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="kt">String</code>
<code class="linenos">36 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">putStrLn</code>
<code class="linenos">37 </code><code class="nf">putStrLn</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">38 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">39 </code><code class="kt">Enter</code> <code class="n">a</code> <code class="n">line</code> <code class="kr">of</code> <code class="n">text</code> <code class="n">for</code> <code class="n">test</code> <code class="mi">1</code><code class="kt">:</code>
<code class="linenos">40 </code><code class="nf">line</code> <code class="mi">1</code>
<code class="linenos">41 </code><code class="kt">As</code> <code class="n">upper</code> <code class="kr">case</code><code class="kt">:</code>	<code class="kt">LINE</code> <code class="mi">1</code>
<code class="linenos">42 </code><code class="kt">Enter</code> <code class="n">a</code> <code class="n">line</code> <code class="kr">of</code> <code class="n">text</code> <code class="n">for</code> <code class="n">test</code> <code class="mi">1</code><code class="kt">:</code>
<code class="linenos">43 </code><code class="nf">line</code> <code class="mi">2</code>
<code class="linenos">44 </code><code class="kt">As</code> <code class="n">upper</code> <code class="kr">case</code><code class="kt">:</code>	<code class="kt">LINE</code> <code class="mi">2</code>
<code class="linenos">45 </code><code class="kt">Enter</code> <code class="n">a</code> <code class="n">line</code> <code class="kr">of</code> <code class="n">text</code> <code class="n">for</code> <code class="n">test</code> <code class="mi">1</code><code class="kt">:</code>
<code class="linenos">46 </code><code class="o">^</code><code class="kt">C</code> <code class="kt">Interrupted</code><code class="o">.</code>
<code class="linenos">47 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>In line 36 the function <strong>getLine</strong> is of type <strong>getLine :: IO String</strong> which means that calling <strong>getLine</strong> returns a value that is a computation to get a line of text from <em>stdio</em> but the IO operation is not performed until the value is used.</p>

<p>Please note that it is unusual to put five executable targets in a project’s <em>cabal</em> file. I am only doing so here because I wanted to group five similar examples together in this subdirectory of the <a href="https://github.com/mark-watson/haskell_tutorial_cookbook_examples">github repo for this book</a>. This repo has 16 example subdirectories, and the number would be much greater if I didn’t collect similar examples together.</p>

<p>We will use the example in file <em>CommandLine2.hs</em> in the next section which is similar to this example but also appends the user input to a text file.</p>

<h3 id="leanpub-auto-file-io">File IO</h3>

<p>We will now look at a short example of doing file IO. We will write Haskell simple string values to a file. If you are using the more efficient Haskell Text values, the code is the same. Text values are more efficient than simple string values when dealing with a lot of data and we will later use a compiler setting to automatically convert between the underlying formats. The following listing shows <em>CommandLineApp/CommandLine2.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>  
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">System.IO</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.Char</code> <code class="p">(</code><code class="nf">toUpper</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 7 </code>  <code class="n">putStrLn</code> <code class="s">"Enter a line of text for test2:"</code>
<code class="linenos"> 8 </code>  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
<code class="linenos"> 9 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"As upper case:</code><code class="se">\t</code><code class="s">"</code> <code class="o">++</code> <code class="p">(</code><code class="n">map</code> <code class="n">toUpper</code> <code class="n">s</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="n">appendFile</code> <code class="s">"temp.txt"</code> <code class="o">$</code> <code class="n">s</code> <code class="o">++</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">11 </code>  <code class="n">main</code>
</pre></div>

</figure>

<p>Note the use of recursion in line 11 to make this program loop forever until you use a <em>COntrol-c</em> to stop the program.</p>

<p>In line 10 we are using function <strong>appendFile</strong> to open a file, append a string to it, and then close the file. <strong>appendFile</strong> is of type <strong>appendFile :: FilePath -&gt; String -&gt; IO ()</strong>. It looks like we are passing a simple string as a file name instead of type <strong>FilePath</strong> but if you look up the definition of <strong>FilePath</strong> you will see that it is just an alias for string: <strong>type FilePath = String</strong>.</p>

<p>Running this example in a GHCi repl, with much of the initial printout from running <em>stack ghci</em> not shown:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos"> 2 </code><code class="kt">CommandLineApp</code><code class="o">-</code><code class="mf">0.1</code><code class="o">.</code><code class="mf">0.0</code><code class="kt">:</code> <code class="n">configure</code>
<code class="linenos"> 3 </code><code class="kt">Specify</code> <code class="n">main</code> <code class="kr">module</code> <code class="err">to</code> <code class="err">use</code> <code class="err">(press</code> <code class="err">enter</code> <code class="err">to</code> <code class="err">load</code> <code class="err">none):</code> <code class="err">2</code>
<code class="linenos"> 4 </code><code class="nn">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos"> 6 </code><code class="kt">Enter</code> <code class="n">a</code> <code class="n">line</code> <code class="kr">of</code> <code class="n">text</code> <code class="n">for</code> <code class="n">test2</code><code class="kt">:</code>
<code class="linenos"> 7 </code><code class="nf">line</code> <code class="mi">1</code>
<code class="linenos"> 8 </code><code class="kt">As</code> <code class="n">upper</code> <code class="kr">case</code><code class="kt">:</code>	<code class="kt">LINE</code> <code class="mi">1</code>
<code class="linenos"> 9 </code><code class="kt">Enter</code> <code class="n">a</code> <code class="n">line</code> <code class="kr">of</code> <code class="n">text</code> <code class="n">for</code> <code class="n">test2</code><code class="kt">:</code>
<code class="linenos">10 </code><code class="nf">line</code> <code class="mi">2</code>
<code class="linenos">11 </code><code class="kt">As</code> <code class="n">upper</code> <code class="kr">case</code><code class="kt">:</code>	<code class="kt">LINE</code> <code class="mi">2</code>
<code class="linenos">12 </code><code class="kt">Enter</code> <code class="n">a</code> <code class="n">line</code> <code class="kr">of</code> <code class="n">text</code> <code class="n">for</code> <code class="n">test2</code><code class="kt">:</code>
<code class="linenos">13 </code><code class="o">^</code><code class="kt">C</code> <code class="kt">Interrupted</code><code class="o">.</code>
<code class="linenos">14 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>The file <em>temp.txt</em> was just created.</p>

<p>The next example used <em>ReadTextFile.hs</em> to read the file <em>temp.txt</em> and process the text by finding all words in the file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>  
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">System.IO</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Control.Monad</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 7 </code>  <code class="n">entireFileAsString</code> <code class="ow">&lt;-</code> <code class="n">readFile</code> <code class="s">"temp.txt"</code>
<code class="linenos"> 8 </code>  <code class="n">print</code> <code class="n">entireFileAsString</code>
<code class="linenos"> 9 </code>  <code class="kr">let</code> <code class="n">allWords</code> <code class="ow">=</code> <code class="n">words</code> <code class="n">entireFileAsString</code>
<code class="linenos">10 </code>  <code class="n">print</code> <code class="n">allWords</code>
</pre></div>

</figure>

<p><strong>readFile</strong> is a high-level function because it manages for you reading a file and closing the file handle it uses internally. The built in function <strong>words</strong> splits a string on spaces and returns a list of strings <strong>[String]</strong> that are printed on line 7:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="n">stack</code> <code class="n">ghci</code>
<code class="linenos"> 2 </code><code class="kt">CommandLineApp</code><code class="o">-</code><code class="mf">0.1</code><code class="o">.</code><code class="mf">0.0</code><code class="kt">:</code> <code class="n">build</code>
<code class="linenos"> 3 </code><code class="kt">Specify</code> <code class="n">main</code> <code class="kr">module</code> <code class="err">to</code> <code class="err">use</code> <code class="err">(press</code> <code class="err">enter</code> <code class="err">to</code> <code class="err">load</code> <code class="err">none):</code> <code class="err">3</code>
<code class="linenos"> 4 </code><code class="nn">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">ReadTextFile</code><code class="o">.</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">ReadTextFile</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos"> 6 </code><code class="s">"line 1</code><code class="se">\n</code><code class="s">line 2</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 7 </code><code class="p">[</code><code class="s">"line"</code><code class="p">,</code><code class="s">"1"</code><code class="p">,</code><code class="s">"line"</code><code class="p">,</code><code class="s">"2"</code><code class="p">]</code>
<code class="linenos"> 8 </code><code class="o">*</code><code class="kt">ReadTextFile</code><code class="o">&gt;</code> 
<code class="linenos"> 9 </code><code class="o">*</code><code class="kt">ReadTextFile</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">readFile</code>
<code class="linenos">10 </code><code class="nf">readFile</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="kt">String</code>
<code class="linenos">11 </code><code class="o">*</code><code class="kt">ReadTextFile</code><code class="o">&gt;</code> <code class="kt">:</code><code class="kr">type</code> <code class="n">words</code>
<code class="linenos">12 </code><code class="nf">words</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">String</code><code class="p">]</code>
</pre></div>

</figure>

<p>What if the function <strong>readFile</strong> encounters an error? That is the subject for the next section.</p>

<h3 id="leanpub-auto-error-handling-in-impure-code">Error Handling in Impure Code</h3>
<p>I know you have been patiently waiting to see how we handle errors in Haskell code. Your wait is over! We will look at several common types of runtime errors and how to deal with them. In the last section we used the function <strong>readFile</strong> to read the contents of a text file <em>temp.txt</em>. What if <em>temp.txt</em> does not exist? Well, then we get an error like the following when running the example program in <em>ReadTextFile.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="o">***</code> <code class="kt">Exception:</code> <code class="n">temp</code><code class="o">.</code><code class="n">txt</code><code class="kt">:</code> <code class="n">openFile</code><code class="kt">:</code> <code class="n">does</code> <code class="n">not</code> <code class="n">exist</code> <code class="p">(</code><code class="kt">No</code> <code class="n">such</code> <code class="n">file</code> <code class="n">or</code> <code class="n">directory</code><code class="p">)</code>
</pre></div>

</figure>

<p>Let’s modify this last example in a new file <em>ReadTextFileErrorHandling.hs</em> that catches a file not found error. The following example is derived from the first example in Michael Snoyman’s article <a href="https://www.schoolofhaskell.com/user/snoyberg/general-haskell/exceptions/catching-all-exceptions">Catching all exceptions</a>. This example does not work inside threads; if you need to catch errors inside a thread then see the second example in Michael’s article.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>  
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">System.IO</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Control.Exception</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="c1">-- catchAny by Michael Snoyman:</code>
<code class="linenos"> 7 </code><code class="nf">catchAny</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="kt">SomeException</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="n">a</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="n">a</code>
<code class="linenos"> 8 </code><code class="nf">catchAny</code> <code class="ow">=</code> <code class="kt">Control</code><code class="o">.</code><code class="kt">Exception</code><code class="o">.</code><code class="n">catch</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="nf">safeFileReader</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="kt">String</code>
<code class="linenos">11 </code><code class="nf">safeFileReader</code> <code class="n">fPath</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">12 </code>  <code class="n">entireFileAsString</code> <code class="ow">&lt;-</code> <code class="n">catchAny</code> <code class="p">(</code><code class="n">readFile</code> <code class="s">"temp.txt"</code><code class="p">)</code> <code class="o">$</code> <code class="nf">\</code><code class="ne">error</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
<code class="linenos">13 </code>    <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Error: "</code> <code class="o">++</code> <code class="n">show</code> <code class="ne">error</code>
<code class="linenos">14 </code>    <code class="n">return</code> <code class="s">""</code>
<code class="linenos">15 </code>  <code class="n">return</code> <code class="n">entireFileAsString</code>
<code class="linenos">16 </code>  
<code class="linenos">17 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">18 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">19 </code>  <code class="n">fContents</code> <code class="ow">&lt;-</code> <code class="n">safeFileReader</code> <code class="s">"temp.txt"</code>
<code class="linenos">20 </code>  <code class="n">print</code> <code class="n">fContents</code>
<code class="linenos">21 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">words</code> <code class="n">fContents</code>
</pre></div>

</figure>

<p>I will run this twice: the first time without the file <em>temp.txt</em> present and a second time with <em>temp.txt</em> in the current durectory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">ReadTextFileErrorHandling</code><code class="o">.</code><code class="n">hs</code> 
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">ReadTextFileErrorHandling</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Main</code><code class="o">.</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="kt">Error:</code> <code class="n">temp</code><code class="o">.</code><code class="n">txt</code><code class="kt">:</code> <code class="n">openFile</code><code class="kt">:</code> <code class="n">does</code> <code class="n">not</code> <code class="n">exist</code> <code class="p">(</code><code class="kt">No</code> <code class="n">such</code> <code class="n">file</code> <code class="n">or</code> <code class="n">directory</code><code class="p">)</code>
<code class="s">""</code>
<code class="kt">[]</code>
<code class="mi">1</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="s">"line 1</code><code class="se">\n</code><code class="s">line 2</code><code class="se">\n</code><code class="s">"</code>
<code class="p">[</code><code class="s">"line"</code><code class="p">,</code><code class="s">"1"</code><code class="p">,</code><code class="s">"line"</code><code class="p">,</code><code class="s">"2"</code><code class="p">]</code>
</pre></div>

</figure>

<p>Until you need to handle runtime errors in a multi-threaded Haskell program, following this example should be sufficient. In the next section we look at Network IO.</p>

<h3 id="leanpub-auto-network-io">Network IO</h3>

<p>We will experiment with three network IO examples in this book:</p>

<ul>
  <li>A simple socket client/server example in this section.</li>
  <li>Reading web pages in the chapter “Web Scraping”</li>
  <li>Querying remote RDF endpoints in the chapter “Linked Data and the Semantic Web”</li>
</ul>

<p>We start by using a high level library, <strong>network-simple</strong> for both the client and serve examples in the next two sub-sections. The client and sever examples are in the directory <em>haskell_tutorial_cookbook_examples/ClientServer</em> in the files <em>Client.hs</em> and <em>Server.hs</em>.</p>

<h4 id="leanpub-auto-server-using-network-simple-library">Server Using network-simple Library</h4>

<p>The Haskell <strong>Network</strong> and <strong>Network.Simple</strong> modules use strings represented as <strong>Data.ByteString.Char8</strong> data so as seen in line 1 I set the language type <em>OverloadedStrings</em>. The following example in file <em>ClientServer/Server.hs</em> is derived from an example in the <em>network-simple</em> project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">Server</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Control.Monad</code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.ByteString.Char8</code> <code class="k">as</code> <code class="n">B</code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Network.Simple.TCP</code> <code class="k">as</code> <code class="n">T</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nf">reverseStringLoop</code> <code class="n">sock</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">10 </code>  <code class="n">mbs</code> <code class="ow">&lt;-</code> <code class="kt">T</code><code class="o">.</code><code class="n">recv</code> <code class="n">sock</code> <code class="mi">4096</code>
<code class="linenos">11 </code>  <code class="kr">case</code> <code class="n">mbs</code> <code class="kr">of</code>
<code class="linenos">12 </code>    <code class="kt">Just</code> <code class="n">bs</code> <code class="ow">-&gt;</code> <code class="kt">T</code><code class="o">.</code><code class="n">send</code> <code class="n">sock</code> <code class="p">(</code><code class="kt">B</code><code class="o">.</code><code class="n">reverse</code> <code class="n">bs</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="n">reverseStringLoop</code> <code class="n">sock</code>
<code class="linenos">13 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">return</code> <code class="nb">()</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">16 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kt">T</code><code class="o">.</code><code class="n">withSocketsDo</code> <code class="o">$</code> <code class="kr">do</code> <code class="c1">-- derived from library example</code>
<code class="linenos">17 </code>  <code class="kt">T</code><code class="o">.</code><code class="n">listen</code> <code class="s">"*"</code> <code class="s">"3000"</code> <code class="o">$</code> <code class="nf">\</code><code class="p">(</code><code class="n">lsock</code><code class="p">,</code> <code class="n">laddr</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
<code class="linenos">18 </code>    <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Listening at "</code> <code class="o">++</code> <code class="n">show</code> <code class="n">laddr</code>
<code class="linenos">19 </code>    <code class="n">forever</code> <code class="o">.</code> <code class="kt">T</code><code class="o">.</code><code class="n">acceptFork</code> <code class="n">lsock</code> <code class="o">$</code> <code class="nf">\</code><code class="p">(</code><code class="n">sock</code><code class="p">,</code> <code class="n">addr</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
<code class="linenos">20 </code>      <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Connection from "</code> <code class="o">++</code> <code class="n">show</code> <code class="n">addr</code>
<code class="linenos">21 </code>      <code class="n">reverseStringLoop</code> <code class="n">sock</code>
</pre></div>

</figure>

<p>The server accepts a string, reverses the string, and returns the reversed string to the client.</p>

<p>I am assuming that you have done some network programming and are familiar with sockets, etc. The function <strong>reverseStringLoop</strong> defined in lines 9-13 accepts a socket as a parameter and returns a value of type <strong>MonadIO</strong> that wraps a byte-string value. In line 10 we use the <strong>T.recv</strong> function that takes two arguments: a socket and the maximum number of bytes to received from the client. The <strong>case</strong> expression reverses the received byte string, sends the reversed string back to the client, and recursively calls itself waiting for new data from the client. If the client breaks the socket connection, then the function retuns an empty <strong>MonadIO()</strong>.</p>

<p>The <strong>main</strong> function defined in lines 15-21 listens on port 3000 for new client socket connections. In line 19, the function <strong>T.acceptFork</strong> accepts as an argument a socket value and a function to execute; the complete type is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="kt">T</code><code class="o">.</code><code class="n">acceptFork</code>
<code class="linenos">2 </code><code class="kt">T</code><code class="o">.</code><code class="n">acceptFork</code>
<code class="linenos">3 </code>  <code class="ow">::</code> <code class="n">transformers</code><code class="o">-</code><code class="mf">0.4</code><code class="o">.</code><code class="mf">2.0</code><code class="kt">:Control</code><code class="o">.</code><code class="kt">Monad</code><code class="o">.</code><code class="kt">IO</code><code class="o">.</code><code class="kt">Class</code><code class="o">.</code><code class="kt">MonadIO</code> <code class="n">m</code> <code class="ow">=&gt;</code>
<code class="linenos">4 </code>     <code class="kt">T</code><code class="o">.</code><code class="kt">Socket</code>
<code class="linenos">5 </code>     <code class="ow">-&gt;</code> <code class="p">((</code><code class="kt">T</code><code class="o">.</code><code class="kt">Socket</code><code class="p">,</code> <code class="kt">T</code><code class="o">.</code><code class="kt">SockAddr</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="kt">GHC</code><code class="o">.</code><code class="kt">Conc</code><code class="o">.</code><code class="kt">Sync</code><code class="o">.</code><code class="kt">ThreadId</code>
</pre></div>

</figure>

<p>Don’t let line 3 scare you; the GHCi repl is just showing you where this type of <strong>MonadIO</strong> is defined. The return type refers to a thread ID that is passed to the function <strong>forever :: Monad m ⇒ m a -&gt; m b</strong> that is defined in the module <strong>Control.Monad</strong> and lets the thread run until it teminates.</p>

<p>The <em>network-simple</em> package is fairly high level and relatively simple to use. If you are interested you can find many client/server examples on the web that use the lower-level <em>network</em> package.</p>

<p>We will develop a client application to talk with this server in the next section but if you want to immediately try the server, start it and then run <em>telnet</em> in another terminal window:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">Server</code>
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Server</code>           <code class="p">(</code> <code class="kt">Server</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Server</code><code class="o">.</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="kt">Listening</code> <code class="n">at</code> <code class="mf">0.0</code><code class="o">.</code><code class="mf">0.0</code><code class="kt">:</code><code class="mi">3000</code>
</pre></div>

</figure>

<p>And run <em>telnet</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ telnet localhost <code class="m">3000</code>
Trying <code class="m">127</code>.0.0.1...
Connected to localhost.
Escape character is <code class="s1">'^]'</code>.
<code class="m">12345</code>
<code class="m">54321</code>
The dog ran down the street
teerts eht nwod nar god ehT
</pre></div>

</figure>

<p>In the next section we write a simple client to talk with this service example.</p>

<h4 id="leanpub-auto-client-using-network-simple-library">Client Using network-simple Library</h4>

<p>I want to use automatic conversion between strings represented as <strong>Data.ByteString.Char8</strong> data and regular <strong>[Char]</strong> strings so as seen in line 1 I set the language type <em>OverloadedStrings</em> in the example in file <em>Client.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">Client</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Control.Monad</code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Network.Simple.TCP</code> <code class="k">as</code> <code class="n">T</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 9 </code>  <code class="kt">T</code><code class="o">.</code><code class="n">connect</code> <code class="s">"127.0.0.1"</code> <code class="s">"3000"</code> <code class="o">$</code> <code class="nf">\</code><code class="p">(</code><code class="n">connectionSocket</code><code class="p">,</code> <code class="n">remoteAddr</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
<code class="linenos">10 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Connection established to "</code> <code class="o">++</code> <code class="n">show</code> <code class="n">remoteAddr</code>
<code class="linenos">11 </code>  <code class="kt">T</code><code class="o">.</code><code class="n">send</code> <code class="n">connectionSocket</code> <code class="s">"test123"</code>
<code class="linenos">12 </code>  <code class="n">response</code> <code class="ow">&lt;-</code> <code class="kt">T</code><code class="o">.</code><code class="n">recv</code> <code class="n">connectionSocket</code> <code class="mi">100</code>
<code class="linenos">13 </code>  <code class="kr">case</code> <code class="n">response</code> <code class="kr">of</code>
<code class="linenos">14 </code>    <code class="kt">Just</code> <code class="n">s</code> <code class="ow">-&gt;</code> <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"Response: "</code> <code class="o">++</code> <code class="n">show</code> <code class="n">s</code>
<code class="linenos">15 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">putStrLn</code> <code class="s">"No response from server"</code>
</pre></div>

</figure>

<p>The function <strong>T.connect</strong> in line 9 accepts arguments for a host name, a port, and a function to call with the connection socket to the server and the server’s address. The body of this inline function, defined in in the middle on line 9 and continuing in lines 10-15, prints the server address, sends a string “test123” to the server, and waits for a response back from the server (<strong>T.recv</strong> in line 12). The server response is printed, or a warning that no response was received.</p>

<p>While the example in file <em>Server.hs</em> is running in another terminal, we can run the client interactively:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">Prelude</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">l</code> <code class="n">Client</code><code class="o">.</code><code class="n">hs</code> 
<code class="p">[</code><code class="mi">1</code> <code class="n">of</code> <code class="mi">1</code><code class="p">]</code> <code class="n">Compiling</code> <code class="n">Client</code>           <code class="p">(</code> <code class="n">Client</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="n">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="p">:</code> <code class="n">Client</code><code class="o">.</code>
<code class="o">*</code><code class="n">Main</code> <code class="n">main</code>
<code class="n">Connection</code> <code class="n">established</code> <code class="n">to</code> <code class="mf">127.0</code><code class="o">.</code><code class="mf">0.1</code><code class="p">:</code><code class="mi">3000</code>
<code class="n">Response</code><code class="p">:</code> <code class="s2">"321tset"</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-a-haskell-game-loop-that-maintains-state-functionally">A Haskell Game Loop that Maintains State Functionally</h3>

<p>The example in this section can be found in the file <em>GameLoop2.hs</em> in the directory <em>haskell_tutorial_cookbook_examples/CommandLineApp</em>. This example uses the random package to generate a seed random number for a simple number guessing game. An alternative implementation in <em>GameLoop1.hs</em>, which I won’t discuss, uses the system time to generate a seed.</p>

<p>This is an important example because it demonstrates one way to maintain state in a functional way. We have a read-only game state value that is passed to the function <strong>gameLoop</strong> which modifies the read-only game state passed as an argument and returns a newly constructed game state as the function’s returned value. This is a common pattern that we will see again later when we develop an application to play a simplified version of the card game Blackjack in the chapter “Haskell Program to Play the Blackjack Card Game.”</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">GameLoop2</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">System.Random</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">data</code> <code class="kt">GameState</code> <code class="ow">=</code> <code class="kt">GameState</code> <code class="p">{</code> <code class="n">numberToGuess</code><code class="ow">::</code><code class="kt">Integer</code><code class="p">,</code> <code class="n">numTries</code><code class="ow">::</code><code class="kt">Integer</code><code class="p">}</code>
<code class="linenos"> 6 </code>                   <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nf">gameLoop</code> <code class="ow">::</code> <code class="kt">GameState</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="kt">GameState</code>
<code class="linenos"> 9 </code><code class="nf">gameLoop</code> <code class="n">gs</code> <code class="ow">=</code> <code class="kr">do</code>      
<code class="linenos">10 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">numberToGuess</code> <code class="n">gs</code>
<code class="linenos">11 </code>  <code class="n">putStrLn</code> <code class="s">"Enter a number:"</code>
<code class="linenos">12 </code>  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
<code class="linenos">13 </code>  <code class="kr">let</code> <code class="n">num</code> <code class="ow">=</code> <code class="n">read</code> <code class="n">s</code> <code class="ow">::</code> <code class="kt">Integer</code>
<code class="linenos">14 </code>  <code class="kr">if</code> <code class="n">num</code> <code class="o">==</code> <code class="n">numberToGuess</code> <code class="n">gs</code> <code class="kr">then</code>
<code class="linenos">15 </code>    <code class="n">return</code> <code class="n">gs</code>
<code class="linenos">16 </code>  <code class="kr">else</code> <code class="n">gameLoop</code> <code class="o">$</code> <code class="kt">GameState</code> <code class="p">(</code><code class="n">numberToGuess</code> <code class="n">gs</code><code class="p">)</code> <code class="p">((</code><code class="n">numTries</code> <code class="n">gs</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">17 </code>         
<code class="linenos">18 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">19 </code>  <code class="n">pTime</code> <code class="ow">&lt;-</code> <code class="n">randomRIO</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">4</code><code class="p">)</code>
<code class="linenos">20 </code>  <code class="kr">let</code> <code class="n">gameState</code> <code class="ow">=</code> <code class="kt">GameState</code> <code class="n">pTime</code> <code class="mi">1</code>
<code class="linenos">21 </code>  <code class="n">print</code> <code class="s">"Guess a number between 1 and 4"</code>
<code class="linenos">22 </code>  <code class="n">gameLoop</code> <code class="n">gameState</code>
</pre></div>

</figure>

<p>You notice in line 12 that since we are inside of a <strong>do</strong> expression we can <em>lift</em> (or unwrap) the <strong>IO String ()</strong> value returned from <strong>getLine</strong> to a string value that we can use directly. This is a pattern we will use repeatedly. The value returned from <strong>getLine</strong> is not used until line 13 when we use function <strong>read</strong> to extract the value from the <strong>IO String ()</strong> value <strong>getLine</strong> returned.</p>

<p>In the <strong>if</strong> expression in lines 14-16 we check if the user has input the correct value and can then simply return the input game state to the calling <strong>main</strong> function. If the user has not guessed the correct number then in line 16 we create a new game state value and call the function <strong>gameLoop</strong> recursively with the newly constructed game state.</p>

<p>The following listing shows a sample session playing the number guessing game.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">GameLoop2</code><code class="o">.</code><code class="n">hs</code> 
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">GameLoop2</code>        <code class="p">(</code> <code class="kt">GameLoop2</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">GameLoop2</code><code class="o">.</code>
<code class="o">*</code><code class="kt">GameLoop2</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="s">"Guess a number between 1 and 4"</code>
<code class="kt">Enter</code> <code class="n">a</code> <code class="n">number</code><code class="kt">:</code>
<code class="mi">1</code>
<code class="kt">Enter</code> <code class="n">a</code> <code class="n">number</code><code class="kt">:</code>
<code class="mi">3</code>
<code class="kt">Enter</code> <code class="n">a</code> <code class="n">number</code><code class="kt">:</code>
<code class="mi">4</code>
<code class="kt">GameState</code> <code class="p">{</code><code class="n">numberToGuess</code> <code class="ow">=</code> <code class="mi">4</code><code class="p">,</code> <code class="n">numTries</code> <code class="ow">=</code> <code class="mi">3</code><code class="p">}</code>
<code class="o">*</code><code class="kt">GameLoop2</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="s">"Guess a number between 1 and 4"</code>
<code class="kt">Enter</code> <code class="n">a</code> <code class="n">number</code><code class="kt">:</code>
<code class="mi">1</code>
<code class="kt">Enter</code> <code class="n">a</code> <code class="n">number</code><code class="kt">:</code>
<code class="mi">2</code>
<code class="kt">GameState</code> <code class="p">{</code><code class="n">numberToGuess</code> <code class="ow">=</code> <code class="mi">2</code><code class="p">,</code> <code class="n">numTries</code> <code class="ow">=</code> <code class="mi">2</code><code class="p">}</code>
<code class="o">*</code><code class="kt">GameLoop2</code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>We will use this pattern for maintaining state in a game in the later chapter “Haskell Program to Play the Blackjack Card Game.”</p>

<h4 id="leanpub-auto-efficiency-of-haskell-strings">Efficiency of Haskell Strings</h4>

<p>Except for the Client/Server example, so far we have been mostly using simple <strong>String</strong> values where <strong>String</strong> is a list of characters <strong>[Char]</strong>. For longer strings it is much more efficient to use the module <a href="https://www.stackage.org/nightly-2016-09-18/package/text-1.2.2.1"><strong>Data.Text</strong></a> that is defined in package <strong>text</strong> (so <strong>text</strong> needs to be added to the dependencies in your cabal file).</p>

<p>Many Haskell libraries use the simple <strong>String</strong> type but the use of <strong>Data.Text</strong> is also common, especially in applications handling large amounts of string data. We have already seen examples of this in the client/server example programs. Fortunately Haskell is a strongly typed language that supports a language extension for automatically handling both simple strings and the more efficient text types. This language extension, as we have seen in a previous example, is activated by adding the following near the top of a Haskell source file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="cm">{-# LANGUAGE OverloadedStrings     #-}</code>
</pre></div>

</figure>

<p>As much as possible I am going to use simple strings in this book and when we need both simple strings and byte strings I will then use <em>OverloadedStrings</em> for automatic conversion. This conversion is performed by knowing the type signatures of data and functions in surrounding code. The compiler figures out what type of string is expected and does the conversion for you.</p>

<h3 id="leanpub-auto-a-more-detailed-look-at-monads">A More Detailed Look at Monads</h3>

<p>We have been casually using different types of <strong>IO ()</strong> monads. In this section I will introduce you to the <strong>State</strong> monad and then we will take a deeper look at <strong>IO ()</strong>. While we will be just skimming the surface of the topic of monads, my goal in this section is to teach you enough to work through the remaining examples in this book.</p>

<p>Monads are types belonging to the Monad type class that specifies one operator and one function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">class</code> <code class="kt">Monad</code> <code class="n">m</code> <code class="kr">where</code>
  <code class="p">(</code><code class="o">&gt;&gt;=</code><code class="p">)</code> <code class="ow">::</code> <code class="n">m</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">b</code>
  <code class="n">return</code> <code class="ow">::</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">m</code> <code class="n">a</code>
</pre></div>

</figure>

<p>The <strong>&gt;&gt;=</strong> operator takes two arguments: a monad wrapping a value (type <strong>a</strong> in the above listing) and a function taking the same type <strong>a</strong> and returning a monad wrapping a new type <strong>b</strong>. The return value of <strong>&gt;&gt;=</strong> is a new monad wrapping a value of type <strong>b</strong>.</p>

<p>The Monad type class function <strong>return</strong> takes any value and wraps it in a new monad. The naming of <strong>return</strong> is confusing because it does not alter the flow of execution in a program like a <em>return</em> statement in Java, rather, it wraps a value in a monad.</p>

<h4 id="leanpub-auto-state-monad">State Monad</h4>

<p>The definition for the constructor of a State monad is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">newtype</code> <code class="kt">State</code> <code class="n">s</code> <code class="n">a</code> <code class="ow">=</code> <code class="kt">State</code> <code class="p">{</code> <code class="n">runState</code> <code class="ow">::</code> <code class="n">s</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="n">s</code><code class="p">)</code> <code class="p">}</code>
</pre></div>

</figure>

<p>So far we have been using <strong>data</strong> to define new types and <strong>newtype</strong> is similar except <strong>newtype</strong> acts during compile time and no type information is present at runtime. All monads contain a value and for the State monad this value is a function. The <strong>&gt;&gt;=</strong> operator is called the <em>bind</em> operator.</p>

<p>The accessor function <strong>runState</strong> provides the means to access the value in the state. The following example is in the file <em>StateMonad/State1.hs</em>. In this example, <strong>incrementState</strong> is a state monad that increases its wrapped integer value by one when it is executed. Remember that the <strong>return</strong> function is perhaps poorly named because it does not immediately “return” from a computation block as it does in other languages; <strong>return</strong> simply wraps a value as a monad without redirecting the execution flow.</p>

<p>In order to make the following example more clear, I implement the increment state function twice, once using the <strong>do</strong> notation that you are already familiar with and once using the <strong>&gt;&gt;=</strong> bind operator:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Control.Monad.State</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">incrementState</code> <code class="ow">::</code> <code class="kt">State</code> <code class="kt">Int</code> <code class="kt">Int</code>
<code class="linenos"> 6 </code><code class="nf">incrementState</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 7 </code>  <code class="n">n</code> <code class="ow">&lt;-</code> <code class="n">get</code>
<code class="linenos"> 8 </code>  <code class="n">put</code> <code class="p">(</code><code class="n">n</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="n">return</code> <code class="n">n</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="c1">-- same state monad without using a 'do' expression:</code>
<code class="linenos">12 </code><code class="nf">incrementState2</code> <code class="ow">::</code> <code class="kt">State</code> <code class="kt">Int</code> <code class="kt">Int</code>
<code class="linenos">13 </code><code class="nf">incrementState2</code> <code class="ow">=</code> <code class="n">get</code> <code class="o">&gt;&gt;=</code> <code class="nf">\</code><code class="n">a</code> <code class="ow">-&gt;</code>
<code class="linenos">14 </code>                  <code class="n">put</code> <code class="p">(</code><code class="n">a</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">&gt;&gt;=</code> <code class="nf">\</code><code class="n">b</code> <code class="ow">-&gt;</code>
<code class="linenos">15 </code>                  <code class="n">return</code> <code class="n">a</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="nf">bumpVals</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">)</code> <code class="ow">=</code> <code class="p">(</code><code class="n">a</code><code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="n">b</code><code class="o">+</code><code class="mi">2</code><code class="p">)</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">20 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">runState</code> <code class="n">incrementState</code> <code class="mi">1</code>  <code class="c1">-- (1,2) == (return value, final state)</code>
<code class="linenos">21 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">runState</code> <code class="n">incrementState2</code> <code class="mi">1</code> <code class="c1">-- (1,2) == (return value, final state)</code>
<code class="linenos">22 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">runState</code> <code class="p">(</code><code class="n">mapState</code> <code class="n">bumpVals</code> <code class="n">incrementState</code><code class="p">)</code> <code class="mi">1</code> <code class="c1">-- (2,4)</code>
<code class="linenos">23 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">evalState</code> <code class="n">incrementState</code> <code class="mi">1</code>  <code class="c1">-- 1 == return value</code>
<code class="linenos">24 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">execState</code> <code class="n">incrementState</code> <code class="mi">1</code>  <code class="c1">-- 2 == final state</code>
</pre></div>

</figure>

<p>Here we have used two very different looking, yet equivalent, styles for accessing and modifying state monad values. In lines 6-9 we are using the <strong>do</strong> notation. The function <strong>get</strong> in line 7 returns one value: the value wrapped in a state monad. Function <strong>put</strong> in line 8 replaces the wrapped value in the state monad, in this example by incrementing its numeric value. Finally <strong>return</strong> wraps the value in a monad.</p>

<p>I am using the <strong>runState</strong> function defined in lines 20-24 that returns a tuple: the first tuple value is the result of the computation performed by the function passed to <strong>runState</strong> (<strong>incrementState</strong> and <strong>incrementState2</strong> in these examples) and the second tuple value is the final wrapped state.</p>

<p>In lines 12-15 I reimplemented increment state using the <em>bind</em> function (<strong>&gt;&gt;=</strong>). We have seen before that <strong>&gt;&gt;=</strong> passes the value on its left side to the computation on its right side, that is function calls in lines 13-15:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="nf">\</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">put</code> <code class="p">(</code><code class="n">a</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code>
  <code class="nf">\</code><code class="n">b</code> <code class="ow">-&gt;</code> <code class="n">return</code> <code class="n">a</code>
</pre></div>

</figure>

<p>It is a matter of personal taste whether to code using bind or <strong>do</strong>. I almost always use the <strong>do</strong> notation in my own code but I wanted to cover bind both in case you prefer that notation and so you can also read and understand Haskell code using bind. We continue looking at alternatives to the <strong>do</strong> notation in the next section.</p>

<h3 id="leanpub-auto-using-applicative-operators--and--finding-common-words-in-files">Using Applicative Operators &lt;$&gt; and &lt;*&gt;: Finding Common Words in Files</h3>

<p>My goal in this book is to show you a minimal subset of Haskell that is relatively easy to understand and use for coding. However, a big part of using a language is reading other people’s code so I do need to introduce a few more constructs that are widely used: applicative operators.</p>

<p>Before we begin I need to introduce you to a new term: <strong>Functor</strong> which is a typeclass that defines only one method <strong>fmap</strong>. <strong>fmap</strong> is used to map a function over an <strong>IO action</strong> and has the type signature:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">fmap</code> <code class="ow">::</code> <code class="kt">Functor</code> <code class="n">f</code> <code class="ow">=&gt;</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">f</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">f</code> <code class="n">b</code>
</pre></div>

</figure>

<p><strong>fmap</strong> can be used to apply a pure function like <strong>(a -&gt; b)</strong> to an <strong>IO a</strong> and return a new <strong>IO b</strong> without unwrapping the original <strong>IO ()</strong>. The following short example (in file <em>ImPure/FmapExample.hs</em>) will let you play with this idea:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">FmapExample</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="nf">fileToWords</code> <code class="n">fileName</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 4 </code>  <code class="n">fileText</code> <code class="ow">&lt;-</code> <code class="n">readFile</code> <code class="n">fileName</code>
<code class="linenos"> 5 </code>  <code class="n">return</code> <code class="o">$</code> <code class="n">words</code> <code class="n">fileText</code>
<code class="linenos"> 6 </code>    
<code class="linenos"> 7 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 8 </code>  <code class="n">words1</code> <code class="ow">&lt;-</code> <code class="n">fileToWords</code> <code class="s">"text1.txt"</code>
<code class="linenos"> 9 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">reverse</code> <code class="n">words1</code>
<code class="linenos">10 </code>  <code class="n">words2</code> <code class="ow">&lt;-</code> <code class="n">fmap</code> <code class="n">reverse</code> <code class="o">$</code> <code class="n">fileToWords</code> <code class="s">"text1.txt"</code>
<code class="linenos">11 </code>  <code class="n">print</code> <code class="n">words2</code>
</pre></div>

</figure>

<p>In lines 8-9 I am unwrapping the result of the <strong>IO [String]</strong> returned by the function <strong>fileToWords</strong> and then applying the pure function <strong>words</strong> to the unwrapped value. Wouldn’t it be nice to operate on the words in the file without unwrapping the <strong>[String]</strong> value? You can do this using <strong>fmap</strong> as seen in lines 10-11. Please take a moment to understand what line 10 is doing. Here is line 10:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">words2</code> <code class="ow">&lt;-</code> <code class="n">fmap</code> <code class="n">reverse</code> <code class="o">$</code> <code class="n">fileToWords</code> <code class="s">"text1.txt"</code>
</pre></div>

</figure>

<p>First we read the words in a file into an <strong>IO [String]</strong> monad:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>                           <code class="n">fileToWords</code> <code class="s">"text1.txt"</code>
</pre></div>

</figure>

<p>Then we apply the pure function <strong>reverse</strong> to the values inside the <strong>IO [String]</strong> monad, creating a new copy:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>            <code class="n">fmap</code> <code class="n">reverse</code> <code class="o">$</code> <code class="n">fileToWords</code> <code class="s">"text1.txt"</code>
</pre></div>

</figure>

<p>Note that from the type of the <strong>fmap</strong> function, the input monad and output monad can wrap different types. For example, if we applied the function <strong>head</strong> to an <strong>IO [String]</strong> we would get an outut of <strong>IO [Char]</strong>.</p>

<p>Finally we unwrap the [String] value inside the monad and set <strong>words2</strong> to this unwrapped value:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">words2</code> <code class="ow">&lt;-</code> <code class="n">fmap</code> <code class="n">reverse</code> <code class="o">$</code> <code class="n">fileToWords</code> <code class="s">"text1.txt"</code>
</pre></div>

</figure>

<p>In summary, the <strong>Functor</strong> typeclass defines one method <strong>fmap</strong> that is useful for operating on data wrapped inside a monad.</p>

<p>We will now implement a small application that finds common words in two text files, implementing the primary function three times, using:</p>

<ul>
  <li>The <strong>do</strong> notation.</li>
  <li>The &gt;&gt;= bind operator.</li>
  <li>The Applicative operators &lt;$&gt; and &lt;*&gt;</li>
</ul>

<p>Let’s look at the types for these operators:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="o">&lt;$&gt;</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Functor</code> <code class="n">f</code> <code class="ow">=&gt;</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">f</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">f</code> <code class="n">b</code>
<code class="p">(</code><code class="o">&lt;*&gt;</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Applicative</code> <code class="n">f</code> <code class="ow">=&gt;</code> <code class="n">f</code> <code class="p">(</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">f</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">f</code> <code class="n">b</code>
</pre></div>

</figure>

<p>We will use both &lt;$&gt; and &lt;*&gt; in the function <strong>commonWords3</strong> in this example and I will explain how these operators work after the following program listing.</p>

<p>This practical example will give you a chance to experiment more with Haskell (you do have a GHCi repl open now, right?). The source file for this example is in the file <em>ImPure/CommonWords.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">CommonWords</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Data.Set</code> <code class="p">(</code><code class="nf">fromList</code><code class="p">,</code> <code class="nf">toList</code><code class="p">,</code> <code class="nf">intersection</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.Char</code> <code class="p">(</code><code class="nf">toLower</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">fileToWords</code> <code class="n">fileName</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 7 </code>  <code class="n">fileText</code> <code class="ow">&lt;-</code> <code class="n">readFile</code> <code class="n">fileName</code>
<code class="linenos"> 8 </code>  <code class="n">return</code> <code class="o">$</code> <code class="p">(</code><code class="n">fromList</code> <code class="o">.</code> <code class="n">words</code><code class="p">)</code> <code class="p">(</code><code class="n">map</code> <code class="n">toLower</code> <code class="n">fileText</code><code class="p">)</code>
<code class="linenos"> 9 </code>  
<code class="linenos">10 </code><code class="nf">commonWords</code> <code class="n">file1</code> <code class="n">file2</code> <code class="ow">=</code> <code class="kr">do</code>  
<code class="linenos">11 </code>  <code class="n">words1</code> <code class="ow">&lt;-</code> <code class="n">fileToWords</code> <code class="n">file1</code>
<code class="linenos">12 </code>  <code class="n">words2</code> <code class="ow">&lt;-</code> <code class="n">fileToWords</code> <code class="n">file2</code>
<code class="linenos">13 </code>  <code class="n">return</code> <code class="o">$</code>  <code class="n">toList</code> <code class="o">$</code> <code class="n">intersection</code> <code class="n">words1</code> <code class="n">words2</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="nf">commonWords2</code> <code class="n">file1</code> <code class="n">file2</code> <code class="ow">=</code>
<code class="linenos">16 </code>  <code class="n">fileToWords</code> <code class="n">file1</code> <code class="o">&gt;&gt;=</code> <code class="nf">\</code><code class="n">f1</code> <code class="ow">-&gt;</code>
<code class="linenos">17 </code>  <code class="n">fileToWords</code> <code class="n">file2</code> <code class="o">&gt;&gt;=</code> <code class="nf">\</code><code class="n">f2</code> <code class="ow">-&gt;</code>
<code class="linenos">18 </code>  <code class="n">return</code> <code class="o">$</code>  <code class="n">toList</code> <code class="o">$</code> <code class="n">intersection</code> <code class="n">f1</code> <code class="n">f2</code>
<code class="linenos">19 </code>                                                            
<code class="linenos">20 </code><code class="nf">commonWords3</code> <code class="n">file1</code> <code class="n">file2</code> <code class="ow">=</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="nf">\</code><code class="n">f1</code> <code class="n">f2</code> <code class="ow">-&gt;</code> <code class="n">toList</code> <code class="o">$</code> <code class="n">intersection</code> <code class="n">f1</code> <code class="n">f2</code><code class="p">)</code>
<code class="linenos">22 </code>    <code class="o">&lt;$&gt;</code> <code class="n">fileToWords</code> <code class="n">file1</code>
<code class="linenos">23 </code>    <code class="o">&lt;*&gt;</code> <code class="n">fileToWords</code> <code class="n">file2</code>
<code class="linenos">24 </code>    
<code class="linenos">25 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">26 </code>  <code class="n">cw</code> <code class="ow">&lt;-</code> <code class="n">commonWords</code> <code class="s">"text1.txt"</code> <code class="s">"text2.txt"</code>
<code class="linenos">27 </code>  <code class="n">print</code> <code class="n">cw</code>
<code class="linenos">28 </code>  <code class="n">cw2</code> <code class="ow">&lt;-</code> <code class="n">commonWords</code> <code class="s">"text1.txt"</code> <code class="s">"text2.txt"</code>
<code class="linenos">29 </code>  <code class="n">print</code> <code class="n">cw2</code>
<code class="linenos">30 </code>  <code class="n">cw3</code> <code class="ow">&lt;-</code> <code class="n">commonWords</code> <code class="s">"text1.txt"</code> <code class="s">"text2.txt"</code>
<code class="linenos">31 </code>  <code class="n">print</code> <code class="n">cw3</code>
</pre></div>

</figure>

<p>The function <strong>fileToWords</strong> defined in lines 6-8 simply reads a file, as in the last example, maps contents of the file to lower case, uses <strong>words</strong> to convert a <strong>String</strong> to a <strong>[String]</strong> list of individual words, and uses the function <strong>Data.Set.fromList</strong> to create a set from a list of words that in general will have duplicates. We are retuning an <strong>IO (Data.Set.Base.Set String)</strong> value so we can later perform a set intersection operation. In other applications you might want to apply <strong>Data.Set.toList</strong>  before returning the value from <strong>fileToWords</strong> so the return type of the function would be <strong>IO [String]</strong>.</p>

<p>The last listing defines three similar functions <strong>commonWords</strong>, <strong>commonWords2</strong>, and <strong>commonWords3</strong>.</p>

<p><strong>commonWords</strong> defined in lines 10-13 should hopefully look routine and familiar to you now. We set the local variables with the unwrapped (i.e., extracted from a monad) contents of the unique words in two files, and then return monad wrapping the intersection of the words in both files.</p>

<p>The function <strong>commonWords2</strong> is really the same as <strong>commonWords</strong> except that it uses the bind <strong>&gt;&gt;=</strong> operator instead of the <strong>do</strong> notation.</p>

<p>The interesting function in this example is <strong>commonWords3</strong> in lines 20-23 which uses the applicative operators &lt;$&gt; and &lt;*&gt;. Notice the pure function defined inline in line 21: it takes two arguments of type set and returns the set intersection of the arguments. The operator &lt;$&gt; takes a function on the left side and a monad on the right side which contains the wrapped value to be passed as the argument <strong>f1</strong>. &lt;*&gt; supplies the value for the inline function arguments <strong>f2</strong>. To rephrase how lines 21-23 work: we are calling <strong>fileToWords</strong> twice, both times getting a monad. These two wrapped monad values are passed as arguments to the inline function in line 21 and the result of evaluating this inline function is returned as the value of the function <strong>commonWords3</strong>.</p>

<p>I hope that this example has at least provided you with “reading knowledge” of the Applicative operators &lt;$&gt; and &lt;*&gt; and has also given you one more example of replacing the <strong>do</strong> notation with the use of the bind <strong>&gt;&gt;=</strong> operator.</p>

<h3 id="leanpub-auto-list-comprehensions-using-the-do-notation">List Comprehensions Using the <strong>do</strong> Notation</h3>

<p>We saw examples of list comprehensions in the last chapter on pure Haskell programming. We can use <strong>return</strong> to get lists values that are instances of type Monad:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="n">return</code> <code class="kt">[]</code><code class="p">)</code>
<code class="p">(</code><code class="n">return</code> <code class="kt">[]</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">Monad</code> <code class="n">m</code> <code class="ow">=&gt;</code> <code class="n">m</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="o">*</code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="n">return</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">])</code>
<code class="p">(</code><code class="n">return</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">])</code> <code class="ow">::</code> <code class="p">(</code><code class="kt">Monad</code> <code class="n">m</code><code class="p">,</code> <code class="kt">Num</code> <code class="n">t</code><code class="p">)</code> <code class="ow">=&gt;</code> <code class="n">m</code> <code class="p">[</code><code class="n">t</code><code class="p">]</code>
<code class="o">*</code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="p">(</code><code class="n">return</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"tree"</code><code class="p">])</code>
<code class="p">(</code><code class="n">return</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"tree"</code><code class="p">])</code> <code class="ow">::</code> <code class="kt">Monad</code> <code class="n">m</code> <code class="ow">=&gt;</code> <code class="n">m</code> <code class="p">[[</code><code class="kt">Char</code><code class="p">]]</code>
</pre></div>

</figure>

<p>We can get list comprehension behavior from the <strong>do</strong> notation (here I am using the GHCi repl <strong>:{</strong> and <strong>:}</strong> commands to enter multiple line examples):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="p">{</code>
<code class="linenos">2 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="kr">do</code> <code class="n">num</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="mi">3</code><code class="p">]</code>
<code class="linenos">3 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>    <code class="n">animal</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="s">"parrot"</code><code class="p">,</code> <code class="s">"ant"</code><code class="p">,</code> <code class="s">"dolphin"</code><code class="p">]</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code>    <code class="n">return</code> <code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">animal</code><code class="p">)</code>
<code class="linenos">5 </code><code class="o">*</code><code class="kt">Main</code><code class="o">|</code> <code class="kt">:</code><code class="p">}</code>
<code class="linenos">6 </code><code class="p">[(</code><code class="mi">1</code><code class="p">,</code><code class="s">"parrot"</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="s">"ant"</code><code class="p">),(</code><code class="mi">1</code><code class="p">,</code><code class="s">"dolphin"</code><code class="p">),</code>
<code class="linenos">7 </code> <code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="s">"parrot"</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="s">"ant"</code><code class="p">),(</code><code class="mi">2</code><code class="p">,</code><code class="s">"dolphin"</code><code class="p">),</code>
<code class="linenos">8 </code> <code class="p">(</code><code class="mi">3</code><code class="p">,</code><code class="s">"parrot"</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="s">"ant"</code><code class="p">),(</code><code class="mi">3</code><code class="p">,</code><code class="s">"dolphin"</code><code class="p">)]</code>
</pre></div>

</figure>

<p>I won’t use this notation further but you now will recognize this pattern if you read it in other people’s code.</p>

<h3 id="leanpub-auto-dealing-with-time">Dealing With Time</h3>

<p>In the example in this section we will see how to time a block of code (using two different methods) and how to set a timeout for code that runs in an <strong>IO ()</strong>.</p>

<p>The first way we time a block of code uses <strong>getPOSIXTime</strong> and can be used to time pure or impure code. The second method using <strong>timeIt</strong> takes an <strong>IO ()</strong> as an argument; in the following example I wrapped pure code in a <strong>print</strong> function call which returns an <strong>IO ()</strong> as its value. The last example in the file <em>TimerTest.hs</em> shows how to run impure code wrapped in a timeout.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Data.Time.Clock.POSIX</code> <code class="c1">-- for getPOSIXTime</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">System.TimeIt</code>         <code class="c1">-- for timeIt</code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">System.Timeout</code>        <code class="c1">-- for timeout</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="nf">anyCalculationWillDo</code> <code class="n">n</code> <code class="ow">=</code>  <code class="c1">-- a function that can take a while to run</code>
<code class="linenos"> 8 </code>  <code class="n">take</code> <code class="n">n</code> <code class="o">$</code> <code class="n">sieve</code> <code class="p">[</code><code class="mi">2</code><code class="o">..</code><code class="p">]</code>
<code class="linenos"> 9 </code>            <code class="kr">where</code>
<code class="linenos">10 </code>              <code class="n">sieve</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code>
<code class="linenos">11 </code>                <code class="n">x</code><code class="kt">:</code><code class="n">sieve</code> <code class="p">[</code><code class="n">y</code> <code class="o">|</code> <code class="n">y</code> <code class="ow">&lt;-</code> <code class="n">xs</code><code class="p">,</code> <code class="n">rem</code> <code class="n">y</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">]</code>
<code class="linenos">12 </code>                
<code class="linenos">13 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">14 </code>  <code class="n">startingTime</code> <code class="ow">&lt;-</code> <code class="n">getPOSIXTime</code>
<code class="linenos">15 </code>  <code class="n">print</code> <code class="n">startingTime</code>
<code class="linenos">16 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">take</code> <code class="mi">20000001</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="p">]</code>
<code class="linenos">17 </code>  <code class="n">endingTime</code> <code class="ow">&lt;-</code> <code class="n">getPOSIXTime</code>
<code class="linenos">18 </code>  <code class="n">print</code> <code class="n">endingTime</code>
<code class="linenos">19 </code>  <code class="n">print</code> <code class="p">(</code><code class="n">endingTime</code> <code class="o">-</code> <code class="n">startingTime</code><code class="p">)</code>
<code class="linenos">20 </code>  <code class="n">timeIt</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">2000</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>  <code class="kr">let</code> <code class="n">somePrimes</code> <code class="ow">=</code> <code class="n">anyCalculationWillDo</code> <code class="mi">3333</code> <code class="kr">in</code>
<code class="linenos">23 </code>    <code class="n">timeIt</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="n">somePrimes</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>  <code class="c1">-- 100000 microseconds timeout tests:</code>
<code class="linenos">26 </code>  <code class="n">timeout</code> <code class="mi">100000</code> <code class="o">$</code> <code class="n">print</code> <code class="s">"simple print **do** expression did not timeout"</code>
<code class="linenos">27 </code>  <code class="n">timeout</code> <code class="mi">100000</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">4</code>
<code class="linenos">28 </code>  <code class="n">timeout</code> <code class="mi">100000</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">40</code>
<code class="linenos">29 </code>  <code class="n">timeout</code> <code class="mi">100000</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">400</code>
<code class="linenos">30 </code>  <code class="n">timeout</code> <code class="mi">100000</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">4000</code>
<code class="linenos">31 </code>  <code class="n">timeout</code> <code class="mi">100000</code> <code class="o">$</code> <code class="n">print</code> <code class="o">$</code> <code class="n">last</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">40000</code>
<code class="linenos">32 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>I wanted a function that takes a while to run so for <strong>anyCalculationWillDo</strong> (lines 7 to 11) I implemented an inefficient prime number generator.</p>

<p>When running this example on my laptop, the last two timeout calls (lines 26 and 31) are terminated for taking more than 100000 microseconds to execute.</p>

<p>The last line 32 of code prints out the first 5 prime numbers greater than 1 so you can see the results of calling the time wasting test function <strong>anyCalculationWillDo</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ stack build --exec TimerTest
<code class="linenos"> 2 </code><code class="m">1473610528</code>.2177s
<code class="linenos"> 3 </code><code class="m">20000000</code>
<code class="linenos"> 4 </code><code class="m">1473610530</code>.218574s
<code class="linenos"> 5 </code><code class="m">2</code>.000874s
<code class="linenos"> 6 </code><code class="m">17389</code>
<code class="linenos"> 7 </code>CPU time:   <code class="m">0</code>.14s
<code class="linenos"> 8 </code><code class="m">30911</code>
<code class="linenos"> 9 </code>CPU time:   <code class="m">0</code>.25s
<code class="linenos">10 </code><code class="s2">"simple print **do** expression did not timeout"</code>
<code class="linenos">11 </code><code class="m">7</code>
<code class="linenos">12 </code><code class="m">173</code>
<code class="linenos">13 </code><code class="m">2741</code>
<code class="linenos">14 </code><code class="o">[</code><code class="m">2</code>,3,5,7,11<code class="o">]</code>
</pre></div>

</figure>

<p>The <strong>timeout</strong> function is useful for setting a maximum time that you are willing to wait for a calculation to complete. I mostly use <strong>timeout</strong> for timing out operations fetching data from the web.</p>

<h3 id="leanpub-auto-using-debugtrace">Using Debug.Trace</h3>

<p>Inside an <strong>IO</strong> you can use print statements to understand what is going on in your code when debugging. You can not use print statements inside pure code but the Haskell base library contains the <strong>trace</strong> functions that internally perform impure writes to stdout. You do not want to use these debug tools in production code.</p>

<p>As an example, I have rewritten the example from the last section to use Debug.Trace.trace and Debug.Trace.traceShow:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Debug.Trace</code>  <code class="p">(</code><code class="nf">trace</code><code class="p">,</code> <code class="nf">traceShow</code><code class="p">)</code> <code class="c1">-- for debugging only!</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">anyCalculationWillDo</code> <code class="n">n</code> <code class="ow">=</code>
<code class="linenos"> 6 </code>  <code class="n">trace</code>
<code class="linenos"> 7 </code>      <code class="p">(</code><code class="s">"+++ anyCalculationWillDo: "</code> <code class="o">++</code> <code class="n">show</code> <code class="n">n</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos"> 8 </code>      <code class="n">anyCalculationWillDo'</code> <code class="n">n</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="nf">anyCalculationWillDo'</code> <code class="n">n</code> <code class="ow">=</code>
<code class="linenos">11 </code>  <code class="n">take</code> <code class="n">n</code> <code class="o">$</code> <code class="n">trace</code> <code class="p">(</code><code class="s">"   -- sieve n:"</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="n">n</code><code class="p">))</code> <code class="o">$</code> <code class="n">sieve</code> <code class="p">[</code><code class="mi">2</code><code class="o">..</code><code class="p">]</code>
<code class="linenos">12 </code>            <code class="kr">where</code>
<code class="linenos">13 </code>              <code class="n">sieve</code> <code class="p">(</code><code class="n">x</code><code class="kt">:</code><code class="n">xs</code><code class="p">)</code> <code class="ow">=</code>
<code class="linenos">14 </code>                  <code class="n">traceShow</code> <code class="p">(</code><code class="s">"     -- inside sieve recursion"</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos">15 </code>                            <code class="n">x</code><code class="kt">:</code><code class="n">sieve</code> <code class="p">[</code><code class="n">y</code> <code class="o">|</code> <code class="n">y</code> <code class="ow">&lt;-</code> <code class="n">xs</code><code class="p">,</code> <code class="n">rem</code> <code class="n">y</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">]</code>
<code class="linenos">16 </code>                
<code class="linenos">17 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">18 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">anyCalculationWillDo</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>In line 3 we import the <strong>trace</strong> and <strong>showTrace</strong> functions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="n">Main</code><code class="o">&gt;</code> <code class="o">:</code><code class="n">info</code> <code class="n">trace</code>
<code class="n">trace</code> <code class="o">::</code> <code class="kt">String</code> <code class="o">-&gt;</code> <code class="n">a</code> <code class="o">-&gt;</code> <code class="n">a</code> 	<code class="o">--</code> <code class="n">Defined</code> <code class="kr">in</code> <code class="err">‘</code><code class="n">Debug</code><code class="p">.</code><code class="n">Trace</code><code class="err">’</code>
<code class="o">*</code><code class="n">Main</code><code class="o">&gt;</code> <code class="o">:</code><code class="n">info</code> <code class="n">traceShow</code>
<code class="n">traceShow</code> <code class="o">::</code> <code class="n">Show</code> <code class="n">a</code> <code class="o">=&gt;</code> <code class="n">a</code> <code class="o">-&gt;</code> <code class="n">b</code> <code class="o">-&gt;</code> <code class="n">b</code> 	<code class="o">--</code> <code class="n">Defined</code> <code class="kr">in</code> <code class="err">‘</code><code class="n">Debug</code><code class="p">.</code><code class="n">Trace</code><code class="err">’</code>
</pre></div>

</figure>

<p><strong>trace</strong> takes two arguments: the first is a string that that is written to stdout and the second is a function call to be evaluated. <strong>traceShow</strong> is like <em>*trace</em> except that the first argument is cnverted to a tstring. The output from running this example is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>+++ anyCalculationWillDo: 5
   -- sieve n:5
"     -- inside sieve recursion"
"     -- inside sieve recursion"
"     -- inside sieve recursion"
"     -- inside sieve recursion"
"     -- inside sieve recursion"
[2,3,5,7,11]
</pre></div>

</figure>

<p>I don’t usually like using the <strong>trace</strong> functions because debugging with them involves slightly rewriting my code. My preference is to get low level code written interactively in the GHCI repl so it does not need to be debugged. I very frequently use print statement inside <strong>IO</strong>s since adding them requires no significant modification of my code.</p>

<h3 id="leanpub-auto-wrap-up">Wrap Up</h3>

<p>I tried to give you a general fast-start in this chapter for using monads and in general writing impure Haskell code. This chapter should be sufficient for you to be able to understand and experiment with the examples in the rest of this book.</p>

<p>This is the end of the first section. We will now look at a variety of application examples using the Haskell language.</p>

<p>While I expect you to have worked through the previous chapters in order, for the rest of the book you can skip around and read the material in any order that you wish.</p>


<h2 id="leanpub-auto-section-2---cookbook">Section 2 - Cookbook</h2>

<p>Now that you have worked through the pure and impure Haskell coding tutorials in the first two chapters we will look at a “cookbook” of techniques and sample applications to solve some common programming tasks as well as implement a program to play the card game Blackjack.</p>

<p>I expect you, dear reader, to have studied and absorbed the tutorial material on pure and impure Haskell programming in the first two chapters. If you are new to Haskell, or don’t have much experience yet, carefully working through these tutorial chapters is a requirement for understanding the material in the rest of this book.</p>

<p>This section contains the following “recipe” applications:</p>

<ul>
  <li>Textprocessing CSV Files</li>
  <li>Textprocessing JSON Files</li>
  <li>Using sqlite and Postgres databases</li>
  <li>REST Server Providing JSON Data</li>
  <li>REST Client</li>
  <li>Accessing and Using Linked Data</li>
  <li>Querying Semantic Web RDF Data Sources</li>
  <li>Annotating English text with Wikipedia/DBPedia URIs for entities in the original text. Entities can be people, places, organizations, etc.</li>
  <li>Play the Blackjack card game</li>
  <li>Machine Learning</li>
  <li>Probabilistic Graph Models</li>
</ul>


<h2 id="leanpub-auto-text-processing">Text Processing</h2>

<p>In my work in data science and machine learning, processing text is a core activity. I am a practitioner, not a research scientist, and in a practical sense, I spend a fair amount of time collecting data (e.g., web scraping and using semantic web/linked data sources), cleaning it, and converting it to different formats.</p>

<p>We will cover three useful techniques: parsing and using CSV (comma separated values) spreadsheet files, parsing and using JSON data, and cleaning up natural language text that contains noise characters.</p>

<h3 id="leanpub-auto-csv-spreadsheet-files">CSV Spreadsheet Files</h3>

<p>The comma separated values (CSV) format is a plain text format that all spreadsheet applications support. The following example illustrates two techniques that we haven’t covered yet:</p>

<ul>
  <li>Extracting values from the <strong>Either</strong> type.</li>
  <li>Using destructuring to concisely extract parts of a list.</li>
</ul>

<p>The <strong>Either</strong> type <em>Either a b</em> contains either a <em>Left a</em> or a <em>Right b</em> value and is usually used to return an error in <strong>Left</strong> or a value in <strong>Right</strong>. We will using the <strong>Data.Either.Unwrap</strong> module to unwrap the <strong>Right</strong> part of a call to the <strong>Text.CSV.parseCSVFromFile</strong> function that reads a CSV file and returns a <strong>Left</strong> error or the data in the spreadsheet in a list as the <strong>Right</strong> value.</p>

<p>The destructuring trick in line 15 in the following listing lets us separate the head and rest of a list in one operation; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">z</code> <code class="ow">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">]</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="n">z</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">]</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="kr">let</code> <code class="n">x</code><code class="kt">:</code><code class="n">xs</code> <code class="ow">=</code> <code class="n">z</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="n">x</code>
<code class="mi">1</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="n">xs</code>
<code class="p">[</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="p">]</code>
</pre></div>

</figure>

<p>Here is how to read a CSV file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">TestCSV</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Text.CSV</code> <code class="p">(</code><code class="nf">parseCSVFromFile</code><code class="p">,</code> <code class="kt">CSV</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.Either.Unwrap</code> <code class="p">(</code><code class="nf">fromRight</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">readCsvFile</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">CSV</code>
<code class="linenos"> 7 </code><code class="nf">readCsvFile</code> <code class="n">fname</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 8 </code>  <code class="n">c</code> <code class="ow">&lt;-</code> <code class="n">parseCSVFromFile</code> <code class="n">fname</code>
<code class="linenos"> 9 </code>  <code class="n">return</code> <code class="o">$</code> <code class="n">fromRight</code> <code class="n">c</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">12 </code>  <code class="n">c</code> <code class="ow">&lt;-</code> <code class="n">readCsvFile</code> <code class="s">"test.csv"</code>
<code class="linenos">13 </code>  <code class="n">print</code>  <code class="n">c</code>  <code class="c1">-- includes header and data rows</code>
<code class="linenos">14 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">map</code> <code class="n">head</code> <code class="n">c</code>  <code class="c1">-- print header</code>
<code class="linenos">15 </code>  <code class="kr">let</code> <code class="n">header</code><code class="kt">:</code><code class="n">rows</code> <code class="ow">=</code> <code class="n">c</code> <code class="c1">-- destructure</code>
<code class="linenos">16 </code>  <code class="n">print</code> <code class="n">header</code>
<code class="linenos">17 </code>  <code class="n">print</code> <code class="n">rows</code>
</pre></div>

</figure>

<p>Function <strong>readCsvFile</strong> reads from a file and returns a <strong>CSV</strong>. What is a <strong>CSV</strong> type? You could search the web for documentation, but dear reader, if you have worked this far learning Haskell, by now you know to rely on the GHCi repl:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">i</code> <code class="kt">CSV</code>
<code class="kr">type</code> <code class="kt">CSV</code> <code class="ow">=</code> <code class="p">[</code><code class="kt">Text</code><code class="o">.</code><code class="kt">CSV</code><code class="o">.</code><code class="kt">Record</code><code class="p">]</code> 	<code class="c1">-- Defined in ‘Text.CSV’</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">i</code> <code class="kt">Text</code><code class="o">.</code><code class="kt">CSV</code><code class="o">.</code><code class="kt">Record</code>
<code class="kr">type</code> <code class="kt">Text</code><code class="o">.</code><code class="kt">CSV</code><code class="o">.</code><code class="kt">Record</code> <code class="ow">=</code> <code class="p">[</code><code class="kt">Text</code><code class="o">.</code><code class="kt">CSV</code><code class="o">.</code><code class="kt">Field</code><code class="p">]</code> 	<code class="c1">-- Defined in ‘Text.CSV’</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">i</code> <code class="kt">Text</code><code class="o">.</code><code class="kt">CSV</code><code class="o">.</code><code class="kt">Field</code>
<code class="kr">type</code> <code class="kt">Text</code><code class="o">.</code><code class="kt">CSV</code><code class="o">.</code><code class="kt">Field</code> <code class="ow">=</code> <code class="kt">String</code> 	<code class="c1">-- Defined in ‘Text.CSV’</code>
</pre></div>

</figure>

<p>So, a <strong>CSV</strong> is a list of records (rows in the spreadsheet file), each record is a list of fields (i.e., a string value).</p>

<p>The output when reading the CVS file <em>test.csv</em> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">TestCSV</code>
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">TestCSV</code>          <code class="p">(</code> <code class="kt">TestCSV</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">TestCSV</code><code class="o">.</code>
<code class="o">*</code><code class="kt">TestCSV</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="p">[[</code><code class="s">"name"</code><code class="p">,</code><code class="s">" email"</code><code class="p">,</code><code class="s">" age"</code><code class="p">],[</code><code class="s">"John Smith"</code><code class="p">,</code><code class="s">" jsmith@acmetools.com"</code><code class="p">,</code><code class="s">" 41"</code><code class="p">],[</code><code class="s">"June Jones"</code><code class="nf">\</code>
<code class="p">,</code><code class="s">" jj@acmetools.com"</code><code class="p">,</code><code class="s">" 38"</code><code class="p">]]</code>
<code class="p">[</code><code class="s">"name"</code><code class="p">,</code><code class="s">"John Smith"</code><code class="p">,</code><code class="s">"June Jones"</code><code class="p">]</code>
<code class="p">[</code><code class="s">"name"</code><code class="p">,</code><code class="s">" email"</code><code class="p">,</code><code class="s">" age"</code><code class="p">]</code>
<code class="p">[[</code><code class="s">"John Smith"</code><code class="p">,</code><code class="s">" jsmith@acmetools.com"</code><code class="p">,</code><code class="s">" 41"</code><code class="p">],[</code><code class="s">"June Jones"</code><code class="p">,</code><code class="s">" jj@acmetools.com"</code><code class="p">,</code><code class="s">" 38</code><code class="se">\</code>
<code class="s">"]]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-json-data">JSON Data</h3>

<p>JSON is the native data format for the Javascript language and JSON has become a popular serialization format for exchanging data between programs on a network. In this section I will demonstrate serializing a Haskell type to a string with JSON encoding and then perform the opposite operation of deserializing a string containing JSON encoded data back to an object.</p>

<p>The first example uses the module <strong>Text.JSON.Generic</strong> (from the <em>json</em> library) and the second example uses module <strong>Data.Aeson</strong> (from the <em>aeson</em> library).</p>

<p>In the first example, we set the language type to include DeriveDataTypeable so a new type definition can simply derive <em>Typeable</em> which allows the compiler to generate appropriate <strong>encodeJSON</strong> and <strong>decodeJSON</strong> functions for the type <strong>Person</strong> we define in the example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE DeriveDataTypeable #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">TestTextJSON</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Text.JSON.Generic</code>
<code class="linenos"> 6 </code>          
<code class="linenos"> 7 </code><code class="kr">data</code> <code class="kt">Person</code> <code class="ow">=</code> <code class="kt">Person</code> <code class="p">{</code><code class="n">name</code><code class="ow">::</code><code class="kt">String</code><code class="p">,</code> <code class="n">email</code><code class="ow">::</code><code class="kt">String</code><code class="p">}</code>
<code class="linenos"> 8 </code>                     <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">,</code> <code class="kt">Data</code><code class="p">,</code> <code class="kt">Typeable</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">11 </code>  <code class="kr">let</code> <code class="n">a</code> <code class="ow">=</code> <code class="n">encodeJSON</code> <code class="o">$</code> <code class="kt">Person</code> <code class="s">"Sam"</code> <code class="s">"sam@a.com"</code>
<code class="linenos">12 </code>  <code class="n">print</code> <code class="n">a</code>
<code class="linenos">13 </code>  <code class="kr">let</code> <code class="n">d</code> <code class="ow">=</code> <code class="p">(</code><code class="n">decodeJSON</code> <code class="n">a</code> <code class="ow">::</code> <code class="kt">Person</code><code class="p">)</code>
<code class="linenos">14 </code>  <code class="n">print</code> <code class="n">d</code>
<code class="linenos">15 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">name</code> <code class="n">d</code>
<code class="linenos">16 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">email</code> <code class="n">d</code>
</pre></div>

</figure>

<p>Notice that in line 14 that I specified the expected type in the <strong>decodeJSON</strong> call. This is not strictly required, the Haskell GHC compiler knows what to do in this case. I specified the type for code readability. The Haskell compiler wrote the <strong>name</strong> and <strong>email</strong> functions for me and I use these functions in lines 16 and 17 to extract these fields. Here is the output from running this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">TestTextJSON</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">TestTextJSON</code>     <code class="p">(</code> <code class="kt">TestTextJSON</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">TestTextJSON</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">TestTextJSON</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">5 </code><code class="s">"{</code><code class="se">\"</code><code class="s">name</code><code class="se">\"</code><code class="s">:</code><code class="se">\"</code><code class="s">Sam</code><code class="se">\"</code><code class="s">,</code><code class="se">\"</code><code class="s">email</code><code class="se">\"</code><code class="s">:</code><code class="se">\"</code><code class="s">sam@a.com</code><code class="se">\"</code><code class="s">}"</code>
<code class="linenos">6 </code><code class="kt">Person</code> <code class="p">{</code><code class="n">name</code> <code class="ow">=</code> <code class="s">"Sam"</code><code class="p">,</code> <code class="n">email</code> <code class="ow">=</code> <code class="s">"sam@a.com"</code><code class="p">}</code>
<code class="linenos">7 </code><code class="s">"Sam"</code>
<code class="linenos">8 </code><code class="s">"sam@a.com"</code>
</pre></div>

</figure>

<p>The next example uses the <em>Aeson</em> library and is similar to this example.</p>

<p>Using <em>Aeson</em>, we set a language type <em>DeriveGeneric</em>  and in this case have the <strong>Person</strong> class derive <strong>Generic</strong>. The School of Haskell has an <a href="https://www.schoolofhaskell.com/school/starting-with-haskell/libraries-and-frameworks/text-manipulation/json">excellent Aeson tutorial</a> that shows a trick I use in this example: letting the compiler generate required functions for types <strong>FromJSON</strong> and <strong>ToJSON</strong> as seen in lines 12-13.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE DeriveGeneric #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">TestJSON</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Data.Aeson</code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="nn">GHC.Generics</code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="kr">data</code> <code class="kt">Person</code> <code class="ow">=</code> <code class="kt">Person</code> <code class="p">{</code><code class="n">name</code><code class="ow">::</code><code class="kt">String</code><code class="p">,</code> <code class="n">email</code><code class="ow">::</code><code class="kt">String</code> <code class="p">}</code> <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">,</code> <code class="kt">Generic</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="c1">-- nice trick from School Of Haskell tutorial on Aeson:</code>
<code class="linenos">12 </code><code class="kr">instance</code> <code class="kt">FromJSON</code> <code class="kt">Person</code>  <code class="c1">-- DeriveGeneric language setting allows</code>
<code class="linenos">13 </code><code class="kr">instance</code> <code class="kt">ToJSON</code> <code class="kt">Person</code>    <code class="c1">-- automatic generation of instance of</code>
<code class="linenos">14 </code>                          <code class="c1">-- types deriving Generic.</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">17 </code>  <code class="kr">let</code> <code class="n">a</code> <code class="ow">=</code> <code class="n">encode</code> <code class="o">$</code> <code class="kt">Person</code> <code class="s">"Sam"</code> <code class="s">"sam@a.com"</code>
<code class="linenos">18 </code>  <code class="n">print</code> <code class="n">a</code>
<code class="linenos">19 </code>  <code class="kr">let</code> <code class="p">(</code><code class="kt">Just</code> <code class="n">d</code><code class="p">)</code> <code class="ow">=</code> <code class="p">(</code><code class="n">decode</code> <code class="n">a</code> <code class="ow">::</code> <code class="kt">Maybe</code> <code class="kt">Person</code><code class="p">)</code>
<code class="linenos">20 </code>  <code class="n">print</code> <code class="n">d</code>
<code class="linenos">21 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">name</code> <code class="n">d</code>
<code class="linenos">22 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">email</code> <code class="n">d</code>
</pre></div>

</figure>

<p>I use a short cut in line 19, assuming that the <strong>Maybe</strong> object returned from <strong>decode</strong> (which the compiler wrote automatically for the type <strong>FromJSON</strong>) contains a <strong>Just</strong> value instead of an empty <strong>Nothing</strong> value. So in line 19 I directly unwrap the <strong>Just</strong> value.</p>

<p>Here is the output from running this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">TestAESON</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">TestJSON</code>         <code class="p">(</code> <code class="kt">TestAESON</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">TestJSON</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">TestJSON</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">5 </code><code class="s">"{</code><code class="se">\"</code><code class="s">email</code><code class="se">\"</code><code class="s">:</code><code class="se">\"</code><code class="s">sam@a.com</code><code class="se">\"</code><code class="s">,</code><code class="se">\"</code><code class="s">name</code><code class="se">\"</code><code class="s">:</code><code class="se">\"</code><code class="s">Sam</code><code class="se">\"</code><code class="s">}"</code>
<code class="linenos">6 </code><code class="kt">Person</code> <code class="p">{</code><code class="n">name</code> <code class="ow">=</code> <code class="s">"Sam"</code><code class="p">,</code> <code class="n">email</code> <code class="ow">=</code> <code class="s">"sam@a.com"</code><code class="p">}</code>
<code class="linenos">7 </code><code class="s">"Sam"</code>
<code class="linenos">8 </code><code class="s">"sam@a.com"</code>
</pre></div>

</figure>

<p>Line 5 shows the result of printing the JSON encoded string value created by the call to <strong>encode</strong> in line 17 of the last code example. Line 6 shows the decoded value of type <strong>Person</strong>, and lines 7 and 8 show the inner wrapped values in the <strong>Person</strong> data.</p>

<h3 id="leanpub-auto-cleaning-natural-language-text">Cleaning Natural Language Text</h3>

<p>I spend a lot of time working with text data because I have worked on NLP (natural language processing) projects for over 25 years. We will jump into some interesting NLP applications in the next chapter. I will finish this chapter with strategies for cleaning up text which is often a precursor to performing NLP.</p>

<p>You might be asking why we would need to clean up text. Here are a few common use cases:</p>

<ul>
  <li>Text fetched from the web frequently contains garbage characters.</li>
  <li>Some types of punctuation need to be removed.</li>
  <li>Stop words (e.g., the, a, but, etc.) need to be removed.</li>
  <li>Special unicode characters are not desired.</li>
  <li>Sometimes we want white space around punctuation to make tokenizing text easier.</li>
</ul>

<p>Notice the <strong>module</strong> statement on line 1 of the following listing: I am exporting functions <strong>cleanText</strong> and <strong>removeStopWords</strong> so they will be visible and available for use by any other modules that import this module. In line 6 we import <strong>intercalate</strong> which constructs a string from a space character and an [String]  (i.e., a list of strings); here is an example where instead of adding a space character between the strings joined together, I add “*” characters:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">CleanText</code><code class="o">&gt;</code> <code class="n">intercalate</code> <code class="s">"*"</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"black"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">]</code>
<code class="s">"the*black*cat"</code>
</pre></div>

</figure>

<p>The function <strong>cleanText</strong> removes garbage characters and makes sure that any punctuation characters are surrounded by white space (this makes it easier, for example, to determine sentence boundaries). Function <strong>removeStopWords</strong> removes common words like “a”, “the”, etc. from text.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">CleanText</code> <code class="p">(</code><code class="nf">cleanText</code><code class="p">,</code> <code class="nf">removeStopWords</code><code class="p">)</code>  <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Data.List.Split</code> <code class="p">(</code><code class="nf">splitOn</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.List</code> <code class="p">(</code><code class="nf">intercalate</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Data.Char</code> <code class="k">as</code> <code class="n">C</code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="nn">Data.List.Utils</code> <code class="p">(</code><code class="nf">replace</code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nf">noiseCharacters</code> <code class="ow">=</code> <code class="p">[</code><code class="sc">'['</code><code class="p">,</code> <code class="sc">']'</code><code class="p">,</code> <code class="sc">'{'</code><code class="p">,</code> <code class="sc">'}'</code><code class="p">,</code> <code class="kt">'\</code><code class="n">n'</code><code class="p">,</code> <code class="kt">'\</code><code class="n">t'</code><code class="p">,</code> <code class="sc">'&amp;'</code><code class="p">,</code> <code class="sc">'^'</code><code class="p">,</code> 
<code class="linenos"> 9 </code>                   <code class="sc">'@'</code><code class="p">,</code> <code class="sc">'%'</code><code class="p">,</code> <code class="sc">'$'</code><code class="p">,</code> <code class="sc">'#'</code><code class="p">,</code> <code class="sc">','</code><code class="p">]</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="nf">substituteNoiseCharacters</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">12 </code><code class="nf">substituteNoiseCharacters</code> <code class="ow">=</code>
<code class="linenos">13 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="kr">if</code> <code class="n">elem</code> <code class="n">x</code> <code class="n">noiseCharacters</code> <code class="kr">then</code> <code class="sc">' '</code> <code class="kr">else</code> <code class="n">x</code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="nf">cleanText</code> <code class="n">s</code> <code class="ow">=</code>
<code class="linenos">16 </code>  <code class="n">intercalate</code>
<code class="linenos">17 </code>   <code class="s">" "</code> <code class="o">$</code>
<code class="linenos">18 </code>   <code class="n">filter</code>
<code class="linenos">19 </code>     <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="n">length</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos">20 </code>     <code class="n">splitOn</code> <code class="s">" "</code> <code class="o">$</code> <code class="n">substituteNoiseCharacters</code> <code class="o">$</code>
<code class="linenos">21 </code>       <code class="p">(</code><code class="n">replace</code> <code class="s">"."</code> <code class="s">" . "</code>
<code class="linenos">22 </code>        <code class="p">(</code><code class="n">replace</code> <code class="s">","</code> <code class="s">" , "</code> 
<code class="linenos">23 </code>         <code class="p">(</code><code class="n">replace</code> <code class="s">";"</code> <code class="s">" ; "</code> <code class="n">s</code><code class="p">)))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="nf">stopWords</code> <code class="ow">=</code> <code class="p">[</code><code class="s">"a"</code><code class="p">,</code> <code class="s">"the"</code><code class="p">,</code> <code class="s">"that"</code><code class="p">,</code> <code class="s">"of"</code><code class="p">,</code> <code class="s">"an"</code><code class="p">]</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="nf">toLower'</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">28 </code><code class="nf">toLower'</code> <code class="n">s</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="kr">if</code> <code class="n">isLower</code> <code class="n">x</code> <code class="kr">then</code> <code class="n">x</code> <code class="kr">else</code> <code class="p">(</code><code class="kt">C</code><code class="o">.</code><code class="n">toLower</code> <code class="n">x</code><code class="p">))</code> <code class="n">s</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="nf">removeStopWords</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">31 </code><code class="nf">removeStopWords</code> <code class="n">s</code> <code class="ow">=</code>
<code class="linenos">32 </code>  <code class="n">intercalate</code>
<code class="linenos">33 </code>     <code class="s">" "</code> <code class="o">$</code>
<code class="linenos">34 </code>    <code class="n">filter</code>
<code class="linenos">35 </code>      <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="n">notElem</code> <code class="p">(</code><code class="n">toLower'</code> <code class="n">x</code><code class="p">)</code> <code class="n">stopWords</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos">36 </code>      <code class="n">words</code> <code class="n">s</code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">39 </code>  <code class="kr">let</code> <code class="n">ct</code> <code class="ow">=</code> <code class="n">cleanText</code> <code class="s">"The[]@] cat, and all dog, escaped&amp;^. They were caught."</code>
<code class="linenos">40 </code>  <code class="n">print</code> <code class="n">ct</code>
<code class="linenos">41 </code>  <code class="kr">let</code> <code class="n">nn</code> <code class="ow">=</code> <code class="n">removeStopWords</code> <code class="n">ct</code>
<code class="linenos">42 </code>  <code class="n">print</code> <code class="n">nn</code>
</pre></div>

</figure>

<p>This example should be extended with additional noise characters and stop words, depending on your application.</p>

<p>Here is the output from this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="kt">TestCleanText</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">CleanText</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos">2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">TestCleanText</code>    <code class="p">(</code> <code class="kt">CleanText</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos">3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">TestCleanText</code><code class="o">.</code>
<code class="linenos">4 </code><code class="o">*</code><code class="kt">TestCleanText</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos">5 </code><code class="s">"The cat and all dog escaped . They were caught ."</code>
<code class="linenos">6 </code><code class="s">"cat dog escaped . They were caught ."</code>
</pre></div>

</figure>

<p>We will continue working with text in the next chapter.</p>


<h2 id="leanpub-auto-natural-language-processing-tools">Natural Language Processing Tools</h2>

<p>The tools developed in this chapter are modules you can reuse in your programs. We will develop a command line program that reads a line of text from STDIN and writes sematic information as output to STDOUT. I have used this in a Ruby program by piping input text data to a forked process and reading the output which is a semantic representation of the input text.</p>

<p>We will be using this example as an external dependency to a later example in the chapter <strong>Knowledge Graph Creator</strong>.</p>

<p>A few of the data files I provide in this example are fairly large. As an example the file <em>PeopleDbPedia.hs</em> which builds a map from people’s names to the Wikipedia/DBPedia URI for information about them, is 2.5 megabytes in size. The first time you run <em>stack build</em> in the project directory it will take a while, so you might want to start building the project in the directory <em>NlpTool</em> and let it run while you read this chapter.</p>

<p>Here are three examples using the NlpTool command line application developed in this chapter:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">Enter</code> <code class="nv">text</code> <code class="ss">(</code><code class="nv">all</code> <code class="nv">on</code> <code class="nv">one</code> <code class="nv">line</code><code class="ss">)</code>
<code class="nv">Canada</code> <code class="nv">and</code> <code class="nv">England</code> <code class="nv">signed</code> <code class="nv">a</code> <code class="nv">trade</code> <code class="nv">deal</code>.
<code class="nv">category</code>:	<code class="nv">economics</code>
<code class="nv">summary</code>:	<code class="nv">Canada</code> <code class="nv">and</code> <code class="nv">England</code> <code class="nv">signed</code> <code class="nv">a</code> <code class="nv">trade</code> <code class="nv">deal</code>. 
<code class="nv">countries</code>:	[[<code class="s2">"</code><code class="s">Canada</code><code class="s2">"</code>,<code class="s2">"</code><code class="s">&lt;http://dbpedia.org/resource/Canada&gt;</code><code class="s2">"</code>],
             [<code class="s2">"</code><code class="s">England</code><code class="s2">"</code>,<code class="s2">"</code><code class="s">&lt;http://dbpedia.org/resource/England&gt;</code><code class="s2">"</code>]]
<code class="nv">Enter</code> <code class="nv">text</code> <code class="ss">(</code><code class="nv">all</code> <code class="nv">on</code> <code class="nv">one</code> <code class="nv">line</code><code class="ss">)</code>
<code class="nv">President</code> <code class="nv">George</code> <code class="nv">W</code> <code class="nv">Bush</code> <code class="nv">asked</code> <code class="nv">Congress</code> <code class="k">for</code> <code class="nv">permission</code> <code class="nv">to</code> <code class="nv">invade</code> <code class="nv">Iraq</code>.
<code class="nv">category</code>:	<code class="nv">news_war</code>
<code class="nv">summary</code>:	<code class="nv">President</code> <code class="nv">George</code> <code class="nv">W</code> <code class="nv">Bush</code> <code class="nv">asked</code> <code class="nv">Congress</code> <code class="k">for</code> <code class="nv">permission</code> <code class="nv">to</code> <code class="nv">invade</code> <code class="nv">Iraq</code>. 
<code class="nv">people</code>:	[[<code class="s2">"</code><code class="s">George W Bush</code><code class="s2">"</code>,<code class="s2">"</code><code class="s">&lt;http://dbpedia.org/resource/George_W._Bush&gt;</code><code class="s2">"</code>]]
<code class="nv">countries</code>:	[[<code class="s2">"</code><code class="s">Iraq</code><code class="s2">"</code>,<code class="s2">""</code>]]
<code class="nv">Enter</code> <code class="nv">text</code> <code class="ss">(</code><code class="nv">all</code> <code class="nv">on</code> <code class="nv">one</code> <code class="nv">line</code><code class="ss">)</code>
<code class="nv">The</code> <code class="nv">British</code> <code class="nv">government</code> <code class="nv">is</code> <code class="nv">facing</code> <code class="nv">criticism</code> <code class="nv">from</code> <code class="nv">business</code> <code class="nv">groups</code> <code class="nv">over</code> <code class="nv">statements</code> <code class="nv">sugg</code>\
<code class="nv">esting</code> <code class="nv">the</code> <code class="nv">U</code>.<code class="nv">K</code>. <code class="nv">is</code> <code class="nv">heading</code> <code class="k">for</code> <code class="nv">a</code> <code class="nv">hard</code> <code class="nv">divorce</code> <code class="nv">from</code> <code class="nv">the</code> <code class="nv">European</code> <code class="nv">Union</code> â€” <code class="nv">and</code> <code class="nv">pressu</code>\
<code class="nv">re</code> <code class="nv">from</code> <code class="nv">lawmakers</code> <code class="nv">who</code> <code class="nv">want</code> <code class="nv">Parliament</code> <code class="nv">to</code> <code class="nv">have</code> <code class="nv">a</code> <code class="nv">vote</code> <code class="nv">on</code> <code class="nv">the</code> <code class="nv">proposed</code> <code class="k">exit</code> <code class="nv">terms</code>. <code class="nv">The</code>\
 <code class="nv">government</code><code class="s1">'</code><code class="s">s repeated emphasis on controlling immigration sent out "signs that the \</code>
<code class="nv">door</code> <code class="nv">is</code> <code class="nv">being</code> <code class="nv">closed</code>, <code class="nv">to</code> <code class="nv">an</code> <code class="nv">extent</code>, <code class="nv">on</code> <code class="nv">the</code> <code class="nv">open</code> <code class="nv">economy</code>, <code class="nv">that</code> <code class="nv">has</code> <code class="nv">helped</code> <code class="nv">fuel</code> <code class="nv">invest</code>\
<code class="nv">ment</code>,<code class="s2">"</code><code class="s"> the head of employers' group the Confederation of British Industry, Carolyn F\</code>
<code class="nv">airbairn</code>, <code class="nv">said</code> <code class="nv">in</code> <code class="nv">comments</code> <code class="nv">published</code> <code class="nv">Monday</code>. <code class="nv">Prime</code> <code class="nv">Minister</code> <code class="nv">Theresa</code> <code class="nv">May</code> <code class="nv">said</code> <code class="nv">last</code> <code class="nv">we</code>\
<code class="nv">ek</code> <code class="nv">that</code> <code class="nv">Britain</code> <code class="nv">would</code> <code class="nv">seek</code> <code class="nv">to</code> <code class="nv">retain</code> <code class="nv">a</code> <code class="nv">close</code> <code class="nv">relationship</code> <code class="nv">with</code> <code class="nv">the</code> <code class="mi">28</code><code class="o">-</code><code class="nv">nation</code> <code class="nv">bloc</code>, <code class="nv">w</code>\
<code class="nv">ith</code> <code class="nv">continued</code> <code class="nv">free</code> <code class="nv">trade</code> <code class="nv">in</code> <code class="nv">goods</code> <code class="nv">and</code> <code class="nv">services</code>. <code class="nv">But</code> <code class="nv">she</code> <code class="nv">said</code> <code class="nv">the</code> <code class="nv">U</code>.<code class="nv">K</code>. <code class="nv">wouldn</code><code class="s1">'</code><code class="s">t cede \</code>
<code class="nv">control</code> <code class="nv">over</code> <code class="nv">immigration</code>, <code class="nv">a</code> <code class="nv">conflict</code> <code class="nv">with</code> <code class="nv">the</code> <code class="nv">EU</code><code class="s1">'</code><code class="s">s principle of free movement among \</code>
<code class="nv">member</code> <code class="nv">states</code>.
<code class="nv">category</code>:	<code class="nv">economics</code>
<code class="nv">summary</code>:	<code class="nv">Prime</code> <code class="nv">Minister</code> <code class="nv">Theresa</code> <code class="nv">May</code> <code class="nv">said</code> <code class="nv">last</code> <code class="nv">week</code> <code class="nv">that</code> <code class="nv">Britain</code> <code class="nv">would</code> <code class="nv">seek</code> <code class="nv">to</code> <code class="nv">retain</code>\
 <code class="nv">a</code> <code class="nv">close</code> <code class="nv">relationship</code> <code class="nv">with</code> <code class="nv">the</code> <code class="mi">28</code><code class="o">-</code><code class="nv">nation</code> <code class="nv">bloc</code>, <code class="nv">with</code> <code class="nv">continued</code> <code class="nv">free</code> <code class="nv">trade</code> <code class="nv">in</code> <code class="nv">goods</code> <code class="nv">an</code>\
<code class="nv">d</code> <code class="nv">services</code>. 
</pre></div>

</figure>

<p><em>credit: news text from abcnews.com</em></p>

<h3 id="leanpub-auto-resolve-entities-in-text-to-dbpedia-uris">Resolve Entities in Text to DBPedia URIs</h3>

<p>The code for this application is in the directory <em>NlpTool</em>.</p>

<p>The software and data in this chapter can be used under the terms of either the GPL version 3 license or the Apache 2 license.</p>

<p>There are several automatically generated Haskell formatted data files that I created using Ruby scripts operating the Wikipedia data. For the purposes of this book I include these data-specific files for your use and enjoyment but we won’t spend much time discussing them. These files are:</p>

<ul>
  <li>BroadcastNetworkNamesDbPedia.hs</li>
  <li>CityNamesDbpedia.hs</li>
  <li>CompanyNamesDbpedia.hs</li>
  <li>CountryNamesDbpedia.hs</li>
  <li>PeopleDbPedia.hs</li>
  <li>PoliticalPartyNamesDbPedia.hs</li>
  <li>TradeUnionNamesDbPedia.hs</li>
  <li>UniversityNamesDbPedia.hs</li>
</ul>

<p>As an example, let’s look at a small sample of data in <em>PeopleDbPedia.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kr">module</code> <code class="nn">PeopleDbPedia</code> <code class="p">(</code><code class="nf">peopleMap</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="nf">peopleMap</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[</code>
<code class="linenos">6 </code>  <code class="p">(</code><code class="s">"Aaron Sorkin"</code><code class="p">,</code> <code class="s">"&lt;http://dbpedia.org/resource/Aaron_Sorkin&gt;"</code><code class="p">),</code>
<code class="linenos">7 </code>  <code class="p">(</code><code class="s">"Bill Clinton"</code><code class="p">,</code> <code class="s">"&lt;http://dbpedia.org/resource/Bill_Clinton&gt;"</code><code class="p">),</code>
<code class="linenos">8 </code>  <code class="p">(</code><code class="s">"George W Bush"</code><code class="p">,</code> <code class="s">"&lt;http://dbpedia.org/resource/George_W_Bush&gt;"</code><code class="p">),</code>
</pre></div>

</figure>

<p>There are 35,146 names in the file <em>PeopleDbPedia.hs</em>. I have built for eight different types of entity names: Haskell maps that take entity names (String) and maps the entity names into relevant DBPedia URIs. Simple in principle, but a lot of work preparing the data. As I mentioned, we will use these data-specific files to resolve entity references in text.</p>

<p>The next listing shows the file <em>Entities.hs</em>. In lines 5-7 I import the entity mapping files I just described. In this example and later code I make heavy use of the <strong>Data.Map</strong> and <strong>Data.Set</strong> modules in the <em>collections</em> library (see the NlpTools.cabal file).</p>

<p>The operator <strong><code>isSubsetOf</code></strong> defined in line 39 tests to see if a value is contained in a collection. The built-in function <strong>all</strong> applies a function or operator to all elements in a collection and returns a true value if the function or operator returns true applied to each element in the collection.</p>

<p>The local utility function <strong>namesHelper</strong> defined in lines 41-53 is simpler than it looks. The function <strong>filter</strong> in line 42 applies the inline function in lines 43-45 (this function returns true for <strong>Maybe</strong> values that contain data) to a second list defined in lines 48-55. This second list is calculated by mapping an inline function over the input argument <strong>ngrams</strong>. The inline function looks up an ngram in a DBPedia map (passed as the second function argument) and returns the lookup value if it is not empty and if it is empty looks up the same ngram  in a word map (last argument to this function).</p>

<p>The utility function <strong>namesHelper</strong> is then used to define functions to recognize company names, country names, people names, city names, broadcast network names, political party names, trade union names, and university names:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">-- Copyright 2014 by Mark Watson. All rights reserved. The software and data in this\</code>
<code class="linenos">  2 </code> <code class="n">project</code> <code class="n">can</code> <code class="n">be</code> <code class="n">used</code> <code class="n">under</code> <code class="n">the</code> <code class="n">terms</code> <code class="kr">of</code> <code class="n">either</code> <code class="n">the</code> <code class="kt">GPL</code> <code class="n">version</code> <code class="mi">3</code> <code class="n">license</code> <code class="n">or</code> <code class="n">the</code> <code class="kt">Apac</code><code class="nf">\</code>
<code class="linenos">  3 </code><code class="nf">he</code> <code class="mi">2</code> <code class="n">license</code><code class="o">.</code>
<code class="linenos">  4 </code>
<code class="linenos">  5 </code><code class="kr">module</code> <code class="nn">Entities</code> <code class="p">(</code><code class="nf">companyNames</code><code class="p">,</code> <code class="nf">peopleNames</code><code class="p">,</code>
<code class="linenos">  6 </code>                 <code class="nf">countryNames</code><code class="p">,</code> <code class="nf">cityNames</code><code class="p">,</code> <code class="nf">broadcastNetworkNames</code><code class="p">,</code>
<code class="linenos">  7 </code>                 <code class="nf">politicalPartyNames</code><code class="p">,</code> <code class="nf">tradeUnionNames</code><code class="p">,</code> <code class="nf">universityNames</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos">  8 </code>
<code class="linenos">  9 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 10 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Set</code> <code class="k">as</code> <code class="n">S</code>
<code class="linenos"> 11 </code><code class="kr">import</code> <code class="nn">Data.Char</code> <code class="p">(</code><code class="nf">toLower</code><code class="p">)</code>
<code class="linenos"> 12 </code><code class="kr">import</code> <code class="nn">Data.List</code> <code class="p">(</code><code class="nf">sort</code><code class="p">,</code> <code class="nf">intersect</code><code class="p">,</code> <code class="nf">intersperse</code><code class="p">)</code>
<code class="linenos"> 13 </code><code class="kr">import</code> <code class="nn">Data.Set</code> <code class="p">(</code><code class="nf">empty</code><code class="p">)</code>
<code class="linenos"> 14 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">isJust</code><code class="p">)</code>
<code class="linenos"> 15 </code>
<code class="linenos"> 16 </code><code class="kr">import</code> <code class="nn">Utils</code> <code class="p">(</code><code class="nf">splitWords</code><code class="p">,</code> <code class="nf">bigram</code><code class="p">,</code> <code class="nf">bigram_s</code><code class="p">,</code> <code class="nf">splitWordsKeepCase</code><code class="p">,</code>
<code class="linenos"> 17 </code>              <code class="nf">trigram</code><code class="p">,</code> <code class="nf">trigram_s</code><code class="p">,</code> <code class="nf">removeDuplicates</code><code class="p">)</code>
<code class="linenos"> 18 </code>
<code class="linenos"> 19 </code><code class="kr">import</code> <code class="nn">FirstNames</code> <code class="p">(</code><code class="nf">firstNames</code><code class="p">)</code>
<code class="linenos"> 20 </code><code class="kr">import</code> <code class="nn">LastNames</code> <code class="p">(</code><code class="nf">lastNames</code><code class="p">)</code>
<code class="linenos"> 21 </code><code class="kr">import</code> <code class="nn">NamePrefixes</code> <code class="p">(</code><code class="nf">namePrefixes</code><code class="p">)</code>
<code class="linenos"> 22 </code>
<code class="linenos"> 23 </code><code class="kr">import</code> <code class="nn">PeopleDbPedia</code> <code class="p">(</code><code class="nf">peopleMap</code><code class="p">)</code>
<code class="linenos"> 24 </code>
<code class="linenos"> 25 </code><code class="kr">import</code> <code class="nn">CountryNamesDbpedia</code> <code class="p">(</code><code class="nf">countryMap</code><code class="p">)</code>
<code class="linenos"> 26 </code><code class="kr">import</code> <code class="nn">CountryNames</code> <code class="p">(</code><code class="nf">countryNamesOneWord</code><code class="p">,</code> <code class="nf">countryNamesTwoWords</code><code class="p">,</code> <code class="nf">countryNamesThreeWor</code><code class="o">\</code>
<code class="linenos"> 27 </code><code class="nf">ds</code><code class="p">)</code>
<code class="linenos"> 28 </code>
<code class="linenos"> 29 </code><code class="kr">import</code> <code class="nn">CompanyNamesDbpedia</code> <code class="p">(</code><code class="nf">companyMap</code><code class="p">)</code>
<code class="linenos"> 30 </code><code class="kr">import</code> <code class="nn">CompanyNames</code> <code class="p">(</code><code class="nf">companyNamesOneWord</code><code class="p">,</code> <code class="nf">companyNamesTwoWords</code><code class="p">,</code> <code class="nf">companyNamesThreeWor</code><code class="o">\</code>
<code class="linenos"> 31 </code><code class="nf">ds</code><code class="p">)</code>
<code class="linenos"> 32 </code><code class="kr">import</code> <code class="nn">CityNamesDbpedia</code> <code class="p">(</code><code class="nf">cityMap</code><code class="p">)</code>
<code class="linenos"> 33 </code> 
<code class="linenos"> 34 </code><code class="kr">import</code> <code class="nn">BroadcastNetworkNamesDbPedia</code> <code class="p">(</code><code class="nf">broadcastNetworkMap</code><code class="p">)</code>
<code class="linenos"> 35 </code><code class="kr">import</code> <code class="nn">PoliticalPartyNamesDbPedia</code> <code class="p">(</code><code class="nf">politicalPartyMap</code><code class="p">)</code>
<code class="linenos"> 36 </code><code class="kr">import</code> <code class="nn">TradeUnionNamesDbPedia</code> <code class="p">(</code><code class="nf">tradeUnionMap</code><code class="p">)</code>
<code class="linenos"> 37 </code><code class="kr">import</code> <code class="nn">UniversityNamesDbPedia</code> <code class="p">(</code><code class="nf">universityMap</code><code class="p">)</code>
<code class="linenos"> 38 </code>
<code class="linenos"> 39 </code><code class="nf">xs</code> <code class="p">`</code><code class="n">isSubsetOf</code><code class="p">`</code> <code class="n">ys</code> <code class="ow">=</code> <code class="n">all</code> <code class="p">(`</code><code class="n">elem</code><code class="p">`</code> <code class="n">ys</code><code class="p">)</code> <code class="n">xs</code>
<code class="linenos"> 40 </code>    
<code class="linenos"> 41 </code><code class="nf">namesHelper</code> <code class="n">ngrams</code> <code class="n">dbPediaMap</code> <code class="n">wordMap</code> <code class="ow">=</code>
<code class="linenos"> 42 </code>  <code class="n">filter</code> 
<code class="linenos"> 43 </code>    <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="kr">case</code> <code class="n">x</code> <code class="kr">of</code>
<code class="linenos"> 44 </code>         <code class="p">(</code><code class="kr">_</code><code class="p">,</code> <code class="kt">Just</code> <code class="n">x</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kt">True</code>
<code class="linenos"> 45 </code>         <code class="kr">_</code> <code class="ow">-&gt;</code> <code class="kt">False</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos"> 46 </code>    <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">ngram</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">ngram</code><code class="p">,</code>
<code class="linenos"> 47 </code>                <code class="kr">let</code> <code class="n">v</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">lookup</code> <code class="n">ngram</code> <code class="n">dbPediaMap</code> <code class="kr">in</code>
<code class="linenos"> 48 </code>                <code class="kr">if</code> <code class="n">isJust</code> <code class="n">v</code>
<code class="linenos"> 49 </code>                   <code class="kr">then</code> <code class="n">return</code> <code class="p">(</code><code class="n">ngram</code><code class="p">,</code> <code class="n">v</code><code class="p">)</code>
<code class="linenos"> 50 </code>                   <code class="kr">else</code> <code class="kr">if</code> <code class="kt">S</code><code class="o">.</code><code class="n">member</code> <code class="n">ngram</code> <code class="n">wordMap</code>
<code class="linenos"> 51 </code>                           <code class="kr">then</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">ngram</code><code class="p">,</code> <code class="kt">Just</code> <code class="s">""</code><code class="p">)</code>
<code class="linenos"> 52 </code>                           <code class="kr">else</code> <code class="kt">Nothing</code><code class="p">))</code>
<code class="linenos"> 53 </code>        <code class="n">ngrams</code>   
<code class="linenos"> 54 </code>
<code class="linenos"> 55 </code><code class="nf">helperNames1W</code> <code class="ow">=</code> <code class="n">namesHelper</code>
<code class="linenos"> 56 </code>
<code class="linenos"> 57 </code><code class="nf">helperNames2W</code> <code class="n">wrds</code> <code class="ow">=</code> <code class="n">namesHelper</code> <code class="p">(</code><code class="n">bigram_s</code> <code class="n">wrds</code><code class="p">)</code>
<code class="linenos"> 58 </code>    
<code class="linenos"> 59 </code><code class="nf">helperNames3W</code> <code class="n">wrds</code> <code class="ow">=</code>  <code class="n">namesHelper</code> <code class="p">(</code><code class="n">trigram_s</code> <code class="n">wrds</code><code class="p">)</code>
<code class="linenos"> 60 </code>
<code class="linenos"> 61 </code><code class="nf">companyNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos"> 62 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos"> 63 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">companyMap</code> <code class="n">companyNamesOneWord</code> <code class="o">++</code>
<code class="linenos"> 64 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">companyMap</code> <code class="n">companyNamesTwoWords</code> <code class="o">++</code>
<code class="linenos"> 65 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">companyMap</code> <code class="n">companyNamesThreeWords</code> <code class="kr">in</code>
<code class="linenos"> 66 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos"> 67 </code>  
<code class="linenos"> 68 </code><code class="nf">countryNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos"> 69 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos"> 70 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">countryMap</code> <code class="n">countryNamesOneWord</code> <code class="o">++</code>
<code class="linenos"> 71 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">countryMap</code> <code class="n">countryNamesTwoWords</code> <code class="o">++</code>
<code class="linenos"> 72 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">countryMap</code> <code class="n">countryNamesThreeWords</code> <code class="kr">in</code>
<code class="linenos"> 73 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos"> 74 </code>
<code class="linenos"> 75 </code><code class="nf">peopleNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos"> 76 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos"> 77 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">peopleMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 78 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">peopleMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 79 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">peopleMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="kr">in</code>
<code class="linenos"> 80 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos"> 81 </code>
<code class="linenos"> 82 </code><code class="nf">cityNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos"> 83 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos"> 84 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">cityMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 85 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">cityMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 86 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">cityMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="kr">in</code>
<code class="linenos"> 87 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos"> 88 </code>
<code class="linenos"> 89 </code><code class="nf">broadcastNetworkNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos"> 90 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos"> 91 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">broadcastNetworkMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 92 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">broadcastNetworkMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 93 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">broadcastNetworkMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="kr">in</code>
<code class="linenos"> 94 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos"> 95 </code>
<code class="linenos"> 96 </code><code class="nf">politicalPartyNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos"> 97 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos"> 98 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">politicalPartyMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos"> 99 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">politicalPartyMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos">100 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">politicalPartyMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="kr">in</code>
<code class="linenos">101 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos">102 </code>
<code class="linenos">103 </code><code class="nf">tradeUnionNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">104 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos">105 </code>              <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">tradeUnionMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos">106 </code>              <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">tradeUnionMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos">107 </code>              <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">tradeUnionMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="kr">in</code>
<code class="linenos">108 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos">109 </code>
<code class="linenos">110 </code><code class="nf">universityNames</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">111 </code>  <code class="kr">let</code> <code class="n">cns</code> <code class="ow">=</code> <code class="n">removeDuplicates</code> <code class="o">$</code> <code class="n">sort</code> <code class="o">$</code>
<code class="linenos">112 </code>             <code class="n">helperNames1W</code> <code class="n">wrds</code> <code class="n">universityMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos">113 </code>             <code class="n">helperNames2W</code> <code class="n">wrds</code> <code class="n">universityMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="o">++</code>
<code class="linenos">114 </code>             <code class="n">helperNames3W</code> <code class="n">wrds</code> <code class="n">universityMap</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Set</code><code class="o">.</code><code class="n">empty</code> <code class="kr">in</code>
<code class="linenos">115 </code>  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="kt">Just</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="kt">Just</code> <code class="n">b</code><code class="p">))</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">))</code> <code class="n">cns</code>
<code class="linenos">116 </code>
<code class="linenos">117 </code>
<code class="linenos">118 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">119 </code>    <code class="kr">let</code> <code class="n">s</code> <code class="ow">=</code> <code class="s">"As read in the San Francisco Chronicle, the company is owned by John Sm</code><code class="se">\</code>
<code class="linenos">120 </code><code class="nf">ith</code><code class="p">,</code> <code class="kt">Bill</code> <code class="kt">Clinton</code><code class="p">,</code> <code class="kt">Betty</code> <code class="kt">Sanders</code><code class="p">,</code> <code class="n">and</code> <code class="kt">Dr</code><code class="o">.</code> <code class="kt">Ben</code> <code class="kt">Jones</code><code class="o">.</code> <code class="kt">Ben</code> <code class="kt">Jones</code> <code class="n">and</code> <code class="kt">Mr</code><code class="o">.</code> <code class="kt">John</code> <code class="kt">Smith</code> <code class="n">ar</code><code class="nf">\</code>
<code class="linenos">121 </code><code class="nf">e</code> <code class="n">childhood</code> <code class="n">friends</code> <code class="n">who</code> <code class="n">grew</code> <code class="n">up</code> <code class="kr">in</code> <code class="kt">Brazil</code><code class="p">,</code> <code class="kt">Canada</code><code class="p">,</code> <code class="kt">Buenos</code> <code class="kt">Aires</code><code class="p">,</code> <code class="n">and</code> <code class="n">the</code> <code class="kt">British</code> <code class="kt">Vir</code><code class="nf">\</code>
<code class="linenos">122 </code><code class="nf">gin</code> <code class="kt">Islands</code><code class="o">.</code> <code class="kt">Apple</code> <code class="kt">Computer</code> <code class="n">relased</code> <code class="n">a</code> <code class="n">new</code> <code class="n">version</code> <code class="kr">of</code> <code class="kt">OS</code> <code class="kt">X</code> <code class="n">yesterday</code><code class="o">.</code> <code class="kt">Brazil</code> <code class="kt">Brazil</code> <code class="kt">B</code><code class="nf">\</code>
<code class="linenos">123 </code><code class="nf">razil</code><code class="o">.</code> <code class="kt">John</code> <code class="kt">Smith</code> <code class="n">bought</code> <code class="n">stock</code> <code class="kr">in</code> <code class="kt">ConocoPhillips</code><code class="p">,</code> <code class="kt">Heinz</code><code class="p">,</code> <code class="kt">Hasbro</code><code class="p">,</code> <code class="n">and</code> <code class="kt">General</code> <code class="kt">Motors</code><code class="p">,</code><code class="nf">\</code>
<code class="linenos">124 </code> <code class="kt">Fox</code> <code class="kt">Sports</code> <code class="kt">Radio</code><code class="o">.</code> <code class="kt">I</code> <code class="n">listen</code> <code class="n">to</code> <code class="kt">B</code> <code class="kt">J</code> <code class="kt">Cole</code><code class="o">.</code> <code class="kt">Awami</code> <code class="kt">National</code> <code class="kt">Party</code> <code class="n">is</code> <code class="n">a</code> <code class="n">political</code> <code class="n">party</code><code class="o">.</code> <code class="nf">\</code>
<code class="linenos">125 </code><code class="kt">ALAEA</code> <code class="n">is</code> <code class="n">a</code> <code class="n">trade</code> <code class="n">union</code><code class="o">.</code> <code class="kt">She</code> <code class="n">went</code> <code class="n">to</code> <code class="kt">Brandeis</code> <code class="kt">University</code><code class="o">.</code><code class="s">"</code>
<code class="linenos">126 </code><code class="s">    --print $ humanNames s</code>
<code class="linenos">127 </code><code class="s">    print $ peopleNames $ splitWordsKeepCase s</code>
<code class="linenos">128 </code><code class="s">    print $ countryNames $ splitWordsKeepCase s</code>
<code class="linenos">129 </code><code class="s">    print $ companyNames $ splitWordsKeepCase s</code>
<code class="linenos">130 </code><code class="s">    print $ cityNames $ splitWordsKeepCase s</code>
<code class="linenos">131 </code><code class="s">    print $ broadcastNetworkNames $ splitWordsKeepCase s</code>
<code class="linenos">132 </code><code class="s">    print $ politicalPartyNames $ splitWordsKeepCase s</code>
<code class="linenos">133 </code><code class="s">    print $ tradeUnionNames $ splitWordsKeepCase s</code>
<code class="linenos">134 </code><code class="s">    print $ universityNames $ splitWordsKeepCase s</code>
</pre></div>

</figure>

<p>The following output is generated by running the test <strong>main</strong> function defined at the bottom of the file <em>app/NlpTool.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ stack build --fast --exec NlpTool-exe
<code class="linenos"> 2 </code>Building all executables <code class="k">for</code> <code class="sb">`</code>NlpTool<code class="s1">' once. After a successful build of all of them\</code>
<code class="linenos"> 3 </code><code class="s1">, only specified executables will be rebuilt.</code>
<code class="linenos"> 4 </code><code class="s1">NlpTool&gt; build (lib + exe)</code>
<code class="linenos"> 5 </code><code class="s1">Preprocessing library for NlpTool-0.1.0.0..</code>
<code class="linenos"> 6 </code><code class="s1">Building library for NlpTool-0.1.0.0..</code>
<code class="linenos"> 7 </code><code class="s1">Preprocessing executable '</code>NlpTool-exe<code class="s1">' for NlpTool-0.1.0.0..</code>
<code class="linenos"> 8 </code><code class="s1">Building executable '</code>NlpTool-exe<code class="err">'</code> <code class="k">for</code> NlpTool-0.1.0.0..
<code class="linenos"> 9 </code><code class="o">[</code><code class="m">1</code> of <code class="m">2</code><code class="o">]</code> Compiling Main
<code class="linenos">10 </code><code class="o">[</code><code class="m">2</code> of <code class="m">2</code><code class="o">]</code> Compiling Paths_NlpTool
<code class="linenos">11 </code>Linking .stack-work/dist/x86_64-osx/Cabal-2.4.0.1/build/NlpTool-exe/NlpTool-exe ...
<code class="linenos">12 </code>NlpTool&gt; copy/register
<code class="linenos">13 </code>Installing library <code class="k">in</code> /Users/markw/GITHUB/haskell_tutorial_cookbook_examples_private<code class="se">\</code>
<code class="linenos">14 </code>_new_edition/NlpTool/.stack-work/install/x86_64-osx/7a2928fbf8188dcb20f165f77b37045a<code class="se">\</code>
<code class="linenos">15 </code>5c413cc7f63913951296700a6b7e292d/8.6.5/lib/x86_64-osx-ghc-8.6.5/NlpTool-0.1.0.0-DXKb<code class="se">\</code>
<code class="linenos">16 </code>ucyA0S0AKOAcZGDl2H
<code class="linenos">17 </code>Installing executable NlpTool-exe <code class="k">in</code> /Users/markw/GITHUB/haskell_tutorial_cookbook_e<code class="se">\</code>
<code class="linenos">18 </code>xamples_private_new_edition/NlpTool/.stack-work/install/x86_64-osx/7a2928fbf8188dcb2<code class="se">\</code>
<code class="linenos">19 </code>0f165f77b37045a5c413cc7f63913951296700a6b7e292d/8.6.5/bin
<code class="linenos">20 </code>Registering library <code class="k">for</code> NlpTool-0.1.0.0..
<code class="linenos">21 </code>Enter text <code class="o">(</code>all on one line<code class="o">)</code>
<code class="linenos">22 </code>As <code class="nb">read</code> <code class="k">in</code> the San Francisco Chronicle, the company is owned by John Smith, Bill Cli<code class="se">\</code>
<code class="linenos">23 </code>nton, Betty Sanders, and Dr. Ben Jones. Ben Jones and Mr. John Smith are childhood f<code class="se">\</code>
<code class="linenos">24 </code>riends who grew up <code class="k">in</code> Brazil, Canada, Buenos Aires, and the British Virgin Islands. <code class="se">\</code>
<code class="linenos">25 </code>Apple Computer relased a new version of OS X yesterday. Brazil Brazil Brazil. John S<code class="se">\</code>
<code class="linenos">26 </code>mith bought stock <code class="k">in</code> ConocoPhillips, Heinz, Hasbro, and General Motors, Fox Sports R<code class="se">\</code>
<code class="linenos">27 </code>adio. I listen to B J Cole. Awami National Party is a political party. ALAEA is a tr<code class="se">\</code>
<code class="linenos">28 </code>ade union. She went to Brandeis University.
<code class="linenos">29 </code>category:	news_politics
<code class="linenos">30 </code>summary:	ALAEA is a trade union. Apple Computer relased a new version of OS X yester<code class="se">\</code>
<code class="linenos">31 </code>day.
<code class="linenos">32 </code>people:	<code class="o">[[</code><code class="s2">"B J Cole"</code>,<code class="s2">"&lt;http://dbpedia.org/resource/B._J._Cole&gt;"</code><code class="o">]]</code>
<code class="linenos">33 </code>companies:	<code class="o">[[</code><code class="s2">"Apple"</code>,<code class="s2">"&lt;http://dbpedia.org/resource/Apple&gt;"</code><code class="o">]</code>,<code class="o">[</code><code class="s2">"ConocoPhillips"</code>,<code class="s2">"&lt;http\</code>
<code class="linenos">34 </code><code class="s2">://dbpedia.org/resource/ConocoPhillips&gt;"</code><code class="o">]</code>,<code class="o">[</code><code class="s2">"Hasbro"</code>,<code class="s2">"&lt;http://dbpedia.org/resource/Ha\</code>
<code class="linenos">35 </code><code class="s2">sbro&gt;"</code><code class="o">]</code>,<code class="o">[</code><code class="s2">"Heinz"</code>,<code class="s2">"&lt;http://dbpedia.org/resource/Heinz&gt;"</code><code class="o">]</code>,<code class="o">[</code><code class="s2">"San Francisco Chronicle"</code>,<code class="s2">"\</code>
<code class="linenos">36 </code><code class="s2">&lt;http://dbpedia.org/resource/San_Francisco_Chronicle&gt;"</code><code class="o">]]</code>
<code class="linenos">37 </code>countries:	<code class="o">[[</code><code class="s2">"Brazil"</code>,<code class="s2">"&lt;http://dbpedia.org/resource/Brazil&gt;"</code><code class="o">]</code>,<code class="o">[</code><code class="s2">"Canada"</code>,<code class="s2">"&lt;http://dbp\</code>
<code class="linenos">38 </code><code class="s2">edia.org/resource/Canada&gt;"</code><code class="o">]]</code>
<code class="linenos">39 </code>Enter text <code class="o">(</code>all on one line<code class="o">)</code>
</pre></div>

</figure>

<p>Note that entities that are not recognized as Wikipedia objects don’t get recognized.</p>

<h3 id="leanpub-auto-bag-of-words-classification-model">Bag of Words Classification Model</h3>

<p>The file <em>Categorize.hs</em> contains a simple bag of words classification model. To prepare the classification models, I collected a large set of labelled text. Labels were “chemistry”, “computers”, etc. I ranked words based on how often they appeared in training texts for a classification category, normalized by how often they appeared in all training texts. This example uses two auto-generated and data-specific Haskell files, one for single words and the other for two adjacent word pairs:</p>

<ul>
  <li>Category1Gram.hs </li>
  <li>Category2Gram.hs</li>
</ul>

<p>In NLP work, single words are sometimes called 1grams and two word adjacent pairs are referred to as 2grams. Here is a small amount of data from <em>Category1Gram.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Category1Gram</code> <code class="p">(</code><code class="o">**</code><code class="nf">onegrams</code><code class="o">**</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">chemistry</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"chemical"</code><code class="p">,</code> <code class="mf">1.15</code><code class="p">),</code> <code class="p">(</code><code class="s">"atoms"</code><code class="p">,</code> <code class="mf">6.95</code><code class="p">),</code>
<code class="linenos"> 6 </code>                        <code class="p">(</code><code class="s">"reaction"</code><code class="p">,</code> <code class="mf">6.7</code><code class="p">),</code> <code class="p">(</code><code class="s">"energy"</code><code class="p">,</code> <code class="mf">6.05</code><code class="p">),</code>
<code class="linenos"> 7 </code>                          <code class="o">...</code> <code class="p">]</code>
<code class="linenos"> 8 </code><code class="nf">computers</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"software"</code><code class="p">,</code> <code class="mf">4.6</code><code class="p">),</code> <code class="p">(</code><code class="s">"network"</code><code class="p">,</code> <code class="mf">4.65</code><code class="p">),</code>
<code class="linenos"> 9 </code>                        <code class="p">(</code><code class="s">"linux"</code><code class="p">,</code> <code class="mf">3.6</code><code class="p">),</code> <code class="p">(</code><code class="s">"device"</code><code class="p">,</code> <code class="mf">3.55</code><code class="p">),</code> <code class="p">(</code><code class="s">"computers"</code><code class="p">,</code> <code class="mf">3.05</code><code class="p">),</code>
<code class="linenos">10 </code>                        <code class="p">(</code><code class="s">"storage"</code><code class="p">,</code> <code class="mf">2.7</code><code class="p">),</code> <code class="p">(</code><code class="s">"disk"</code><code class="p">,</code> <code class="mf">2.3</code><code class="p">),</code>
<code class="linenos">11 </code>                          <code class="o">...</code> <code class="p">]</code>
<code class="linenos">12 </code><code class="nf">etc</code><code class="o">.</code>                          
</pre></div>

</figure>

<p>Here is a small amount of data from <em>Category2Gram.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Category2Gram</code> <code class="p">(</code><code class="o">**</code><code class="nf">twograms</code><code class="o">**</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">chemistry</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"chemical reaction"</code><code class="p">,</code> <code class="mf">1.55</code><code class="p">),</code>
<code class="linenos"> 6 </code>                        <code class="p">(</code><code class="s">"atoms molecules"</code><code class="p">,</code> <code class="mf">0.6</code><code class="p">),</code> 
<code class="linenos"> 7 </code>                        <code class="p">(</code><code class="s">"periodic table"</code><code class="p">,</code> <code class="mf">0.5</code><code class="p">),</code>
<code class="linenos"> 8 </code>                        <code class="p">(</code><code class="s">"chemical reactions"</code><code class="p">,</code> <code class="mf">0.5</code><code class="p">),</code>
<code class="linenos"> 9 </code>                        <code class="p">(</code><code class="s">"carbon atom"</code><code class="p">,</code> <code class="mf">0.5</code><code class="p">),</code>
<code class="linenos">10 </code>                         <code class="o">...</code> <code class="p">]</code>
<code class="linenos">11 </code><code class="nf">computers</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"computer system"</code><code class="p">,</code> <code class="mf">0.9</code><code class="p">),</code>
<code class="linenos">12 </code>                        <code class="p">(</code><code class="s">"operating system"</code><code class="p">,</code> <code class="mf">0.75</code><code class="p">),</code>
<code class="linenos">13 </code>                        <code class="p">(</code><code class="s">"random memory"</code><code class="p">,</code> <code class="mf">0.65</code><code class="p">),</code>
<code class="linenos">14 </code>                        <code class="p">(</code><code class="s">"computer science"</code><code class="p">,</code> <code class="mf">0.65</code><code class="p">),</code>
<code class="linenos">15 </code>                        <code class="p">(</code><code class="s">"computer program"</code><code class="p">,</code> <code class="mf">0.6</code><code class="p">),</code>
<code class="linenos">16 </code>                         <code class="o">...</code> <code class="p">]</code>
<code class="linenos">17 </code><code class="nf">etc</code><code class="o">.</code>
</pre></div>

</figure>

<p>It is very common to use term frequencies for single words for classification models. One problem with using single words is that the evidence that any word gives for a classification is independent of the surrounding words in text being evaluated. By also using word pairs (two word combinations are often called 2grams or two-grams) we pick up patterns like “not good” giving evidence for negative sentiment even with the word “good” in text being evaluated. For my own work, I have a huge corpus of 1gram, 2gram, 3gram, and 4gram data sets. For the purposes of the following example program, I am only using 1gram and 2gram data.</p>

<p>The following listing shows the file <em>Categorize.hs</em>. Before looking at the entire example, let’s focus in on some of the functions I have defined for using the word frequency data to categorized text.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">stemWordsInString</code>
<code class="nf">stemWordsInString</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">stemWordsInString</code> <code class="s">"Banking industry is sometimes known for fraud."</code>
<code class="s">"bank industri is sometim known for fraud"</code>
</pre></div>

</figure>

<p><strong>stemScoredWordList</strong> is used to create a 1gram to word relevance score for each category. The keys are word stems.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">stemScoredWordList</code> <code class="n">onegrams</code> 
<code class="p">[(</code><code class="s">"chemistri"</code><code class="p">,</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"acid"</code><code class="p">,</code><code class="mf">1.15</code><code class="p">),(</code><code class="s">"acids"</code><code class="p">,</code><code class="mf">0.8</code><code class="p">),(</code><code class="s">"alcohol"</code><code class="p">,</code><code class="mf">0.95</code><code class="p">),(</code><code class="s">"atom"</code><code class="p">,</code><code class="mf">4.45</code><code class="p">)</code>
</pre></div>

</figure>

<p>Notice that “chemistri” is the stemmed version of “chemistry”, “bank” for “banks”, etc. <strong>stem2</strong> is a 2gram frequency score by category mapping where the keys are word stems:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">stem2</code>
<code class="p">[(</code><code class="s">"chemistry"</code><code class="p">,</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"atom molecul"</code><code class="p">,</code><code class="mf">0.6</code><code class="p">),(</code><code class="s">"carbon atom"</code><code class="p">,</code><code class="mf">0.5</code><code class="p">),(</code><code class="s">"carbon carbon"</code><code class="p">,</code><code class="mi">0</code><code class="o">.\</code>
<code class="mi">5</code><code class="p">),</code>
</pre></div>

</figure>
<p><strong>stem1</strong> is like <strong>stem2</strong>, but for stemmed 1grams, not 2grams:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">stem1</code>
<code class="p">[(</code><code class="s">"chemistry"</code><code class="p">,</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"acid"</code><code class="p">,</code><code class="mf">0.8</code><code class="p">),(</code><code class="s">"chang"</code><code class="p">,</code><code class="mf">1.05</code><code class="p">),(</code><code class="s">"charg"</code><code class="p">,</code><code class="mf">0.95</code><code class="p">),(</code><code class="s">"chemic"</code><code class="p">,</code><code class="mf">1.15</code><code class="p">),(</code><code class="nf">\</code>
<code class="s">"chemistri"</code><code class="p">,</code><code class="mf">1.45</code><code class="p">),</code>
</pre></div>

</figure>

<p><strong>score</strong> is called with a list or words and a word value mapping. Here is an example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">score</code>
<code class="nf">score</code>
  <code class="ow">::</code> <code class="p">(</code><code class="kt">Enum</code> <code class="n">t</code><code class="p">,</code> <code class="kt">Fractional</code> <code class="n">a</code><code class="p">,</code> <code class="kt">Num</code> <code class="n">t</code><code class="p">,</code> <code class="kt">Ord</code> <code class="n">a</code><code class="p">,</code> <code class="kt">Ord</code> <code class="n">k</code><code class="p">)</code> <code class="ow">=&gt;</code>
     <code class="p">[</code><code class="n">k</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[(</code><code class="n">t1</code><code class="p">,</code> <code class="kt">M</code><code class="o">.</code><code class="kt">Map</code> <code class="n">k</code> <code class="n">a</code><code class="p">)]</code> <code class="ow">-&gt;</code> <code class="p">[(</code><code class="n">t</code><code class="p">,</code> <code class="n">a</code><code class="p">)]</code>
<code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">score</code> <code class="p">[</code><code class="s">"atom"</code><code class="p">,</code> <code class="s">"molecule"</code><code class="p">]</code> <code class="n">onegrams</code> 
<code class="p">[(</code><code class="mi">0</code><code class="p">,</code><code class="mf">8.2</code><code class="p">),(</code><code class="mi">25</code><code class="p">,</code><code class="mf">2.4</code><code class="p">)]</code>
</pre></div>

</figure>

<p>This output is more than a little opaque. The pair (0, 8.2) means that the input words [“atom”, “molecule”] have a score of 8.2 for category indexed at 0 and the pair (25,2.4) means that the input words have a score of 2.4 for the category at index 25. The category at index 0 is chemistry and the category at index 25 is physics as we can see by using the higher level function <strong>bestCategories1</strong> that caluculates categories for a word sequence using 1gram word data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">bestCategories1</code>
<code class="nf">bestCategories1</code> <code class="ow">::</code> <code class="p">[[</code><code class="kt">Char</code><code class="p">]]</code> <code class="ow">-&gt;</code> <code class="p">[([</code><code class="kt">Char</code><code class="p">],</code> <code class="kt">Double</code><code class="p">)]</code>
<code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">bestCategories1</code> <code class="p">[</code><code class="s">"atom"</code><code class="p">,</code> <code class="s">"molecule"</code><code class="p">]</code>
<code class="p">[(</code><code class="s">"chemistry"</code><code class="p">,</code><code class="mf">8.2</code><code class="p">),(</code><code class="s">"physics"</code><code class="p">,</code><code class="mf">2.4</code><code class="p">)]</code>
</pre></div>

</figure>

<p>The top level function <strong>bestCategories</strong> uses 1gram data. Here is an example for using it:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Categorize</code><code class="o">&gt;</code> <code class="n">splitWords</code> <code class="s">"The chemist made a periodic table and explained a chemical </code><code class="se">\</code>
<code class="nf">reaction</code><code class="s">"</code>
<code class="s">["</code><code class="n">the</code><code class="s">","</code><code class="n">chemist</code><code class="s">","</code><code class="n">made</code><code class="s">","</code><code class="n">a</code><code class="s">","</code><code class="n">periodic</code><code class="s">","</code><code class="n">table</code><code class="s">","</code><code class="n">and</code><code class="s">","</code><code class="n">explained</code><code class="s">","</code><code class="n">a</code><code class="s">","</code><code class="n">chemical</code><code class="s">","</code><code class="n">rea</code><code class="nf">\</code>
<code class="nf">ction</code><code class="s">"]</code>
<code class="s">*Categorize&gt; bestCategories1 $ splitWords "</code><code class="kt">The</code> <code class="n">chemist</code> <code class="n">made</code> <code class="n">a</code> <code class="n">periodic</code> <code class="n">table</code> <code class="n">and</code> <code class="n">exp</code><code class="nf">\</code>
<code class="nf">lained</code> <code class="n">a</code> <code class="n">chemical</code> <code class="n">reaction</code><code class="s">"</code>
<code class="s">[("</code><code class="n">chemistry</code><code class="s">",11.25),("</code><code class="n">health_nutrition</code><code class="s">",1.2)]</code>
</pre></div>

</figure>

<p>Notice that these words were also classified as category “health_nutrition” but with a low score of 1.2. The score for “chemistry” is almost an order of magnitude larger. <strong>bestCategories</strong> sorts return values in “best first” order.</p>

<p><strong>splitWords</strong> is used to split a string into word tokens before calling <strong>bestCategories</strong>.</p>

<p>Here is the entire example in file <em>Categorize.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Categorize</code> <code class="p">(</code><code class="nf">bestCategories</code><code class="p">,</code> <code class="nf">splitWords</code><code class="p">,</code> <code class="nf">bigram</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.List</code> <code class="p">(</code><code class="nf">sortBy</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="nn">Category1Gram</code> <code class="p">(</code><code class="nf">onegrams</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">Category2Gram</code> <code class="p">(</code><code class="nf">twograms</code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="nn">Sentence</code> <code class="p">(</code><code class="nf">segment</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="kr">import</code> <code class="nn">Stemmer</code> <code class="p">(</code><code class="nf">stem</code><code class="p">)</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="kr">import</code> <code class="nn">Utils</code> <code class="p">(</code><code class="nf">splitWords</code><code class="p">,</code> <code class="nf">bigram</code><code class="p">,</code> <code class="nf">bigram_s</code><code class="p">)</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="nf">catnames1</code> <code class="ow">=</code> <code class="n">map</code> <code class="n">fst</code> <code class="n">onegrams</code>
<code class="linenos">16 </code><code class="nf">catnames2</code> <code class="ow">=</code> <code class="n">map</code> <code class="n">fst</code> <code class="n">twograms</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="nf">stemWordsInString</code> <code class="n">s</code> <code class="ow">=</code> <code class="n">init</code> <code class="o">$</code> <code class="n">concatMap</code> <code class="p">((</code><code class="o">++</code> <code class="s">" "</code><code class="p">)</code> <code class="o">.</code> <code class="n">stem</code><code class="p">)</code> <code class="p">(</code><code class="n">splitWords</code> <code class="n">s</code><code class="p">)</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="nf">stemScoredWordList</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">str</code><code class="p">,</code><code class="n">score</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="p">(</code><code class="n">stemWordsInString</code> <code class="n">str</code><code class="p">,</code> <code class="n">score</code><code class="p">))</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="nf">stem2</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="n">swl</code><code class="p">)</code> <code class="ow">-&gt;</code>
<code class="linenos">23 </code>              <code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">(</code><code class="n">stemScoredWordList</code> <code class="p">(</code><code class="kt">M</code><code class="o">.</code><code class="n">toList</code> <code class="n">swl</code><code class="p">))))</code>
<code class="linenos">24 </code>			<code class="n">twograms</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="nf">stem1</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="n">swl</code><code class="p">)</code> <code class="ow">-&gt;</code>
<code class="linenos">27 </code>              <code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">(</code><code class="n">stemScoredWordList</code> <code class="p">(</code><code class="kt">M</code><code class="o">.</code><code class="n">toList</code> <code class="n">swl</code><code class="p">))))</code>
<code class="linenos">28 </code>		    <code class="n">onegrams</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="nf">scoreCat</code> <code class="n">wrds</code> <code class="n">amap</code> <code class="ow">=</code>
<code class="linenos">31 </code>  <code class="n">sum</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code>  <code class="kt">M</code><code class="o">.</code><code class="n">findWithDefault</code> <code class="mf">0.0</code> <code class="n">x</code> <code class="n">amap</code><code class="p">)</code> <code class="n">wrds</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code><code class="nf">score</code> <code class="n">wrds</code> <code class="n">amap</code> <code class="ow">=</code>
<code class="linenos">34 </code> <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="n">b</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">b</code> <code class="o">&gt;</code> <code class="mf">0.9</code><code class="p">)</code> <code class="o">$</code> <code class="n">zip</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="p">]</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">s</code><code class="p">,</code> <code class="n">m</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">scoreCat</code> <code class="n">wrds</code> <code class="n">m</code><code class="p">)</code> <code class="n">amap</code>
<code class="linenos">35 </code> 
<code class="linenos">36 </code><code class="nf">cmpScore</code> <code class="p">(</code><code class="n">a1</code><code class="p">,</code> <code class="n">b1</code><code class="p">)</code> <code class="p">(</code><code class="n">a2</code><code class="p">,</code> <code class="n">b2</code><code class="p">)</code> <code class="ow">=</code> <code class="n">compare</code> <code class="n">b2</code> <code class="n">b1</code>
<code class="linenos">37 </code>                              
<code class="linenos">38 </code><code class="nf">bestCategoriesHelper</code> <code class="n">wrds</code> <code class="n">ngramMap</code> <code class="n">categoryNames</code><code class="ow">=</code>
<code class="linenos">39 </code>  <code class="kr">let</code> <code class="n">tg</code> <code class="ow">=</code> <code class="n">bigram_s</code> <code class="n">wrds</code> <code class="kr">in</code>
<code class="linenos">40 </code>    <code class="n">map</code> <code class="p">(</code><code class="n">first</code> <code class="p">(</code><code class="n">categoryNames</code> <code class="o">!!</code><code class="p">))</code> <code class="o">$</code> <code class="n">sortBy</code> <code class="n">cmpScore</code> <code class="o">$</code> <code class="n">score</code> <code class="n">wrds</code> <code class="n">ngramMap</code>
<code class="linenos">41 </code>       
<code class="linenos">42 </code><code class="nf">bestCategories1</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">43 </code>  <code class="n">take</code> <code class="mi">3</code> <code class="o">$</code> <code class="n">bestCategoriesHelper</code> <code class="n">wrds</code> <code class="n">onegrams</code> <code class="n">catnames1</code>
<code class="linenos">44 </code>
<code class="linenos">45 </code><code class="nf">bestCategories2</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">46 </code>  <code class="n">take</code> <code class="mi">3</code> <code class="o">$</code> <code class="n">bestCategoriesHelper</code> <code class="p">(</code><code class="n">bigram_s</code> <code class="n">wrds</code><code class="p">)</code> <code class="n">twograms</code> <code class="n">catnames2</code>
<code class="linenos">47 </code>       
<code class="linenos">48 </code><code class="nf">bestCategories1stem</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">49 </code>  <code class="n">take</code> <code class="mi">3</code> <code class="o">$</code> <code class="n">bestCategoriesHelper</code> <code class="n">wrds</code> <code class="n">stem1</code> <code class="n">catnames1</code>
<code class="linenos">50 </code>
<code class="linenos">51 </code><code class="nf">bestCategories2stem</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">52 </code>  <code class="n">take</code> <code class="mi">3</code> <code class="o">$</code> <code class="n">bestCategoriesHelper</code> <code class="p">(</code><code class="n">bigram_s</code> <code class="n">wrds</code><code class="p">)</code> <code class="n">stem2</code> <code class="n">catnames2</code>
<code class="linenos">53 </code>
<code class="linenos">54 </code><code class="nf">bestCategories</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">String</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[(</code><code class="kt">String</code><code class="p">,</code> <code class="kt">Double</code><code class="p">)]</code>
<code class="linenos">55 </code><code class="nf">bestCategories</code> <code class="n">wrds</code> <code class="ow">=</code>
<code class="linenos">56 </code>  <code class="kr">let</code> <code class="n">sum1</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">unionWith</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="p">(</code><code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="o">$</code> <code class="n">bestCategories1</code> <code class="n">wrds</code><code class="p">)</code> <code class="p">(</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="o">$</code> <code class="n">best</code><code class="nf">\</code>
<code class="linenos">57 </code><code class="kt">Categories2</code> <code class="n">wrds</code><code class="p">)</code>
<code class="linenos">58 </code>      <code class="n">sum2</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">unionWith</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="p">(</code><code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="o">$</code> <code class="n">bestCategories1stem</code> <code class="n">wrds</code><code class="p">)</code> <code class="p">(</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="o">$</code> <code class="nf">\</code>
<code class="linenos">59 </code><code class="nf">bestCategories2stem</code> <code class="n">wrds</code><code class="p">)</code> 
<code class="linenos">60 </code>  <code class="kr">in</code> <code class="n">sortBy</code> <code class="n">cmpScore</code> <code class="o">$</code> <code class="kt">M</code><code class="o">.</code><code class="n">toList</code> <code class="o">$</code> <code class="kt">M</code><code class="o">.</code><code class="n">unionWith</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code> <code class="n">sum1</code> <code class="n">sum2</code>
<code class="linenos">61 </code>      
<code class="linenos">62 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">63 </code>    <code class="kr">let</code> <code class="n">s</code> <code class="ow">=</code> <code class="s">"The sport of hocky is about 100 years old by ahdi dates. American Footb</code><code class="se">\</code>
<code class="linenos">64 </code><code class="nf">all</code> <code class="n">is</code> <code class="n">a</code> <code class="n">newer</code> <code class="n">sport</code><code class="o">.</code> <code class="kt">Programming</code> <code class="n">is</code> <code class="n">fun</code><code class="o">.</code> <code class="kt">Congress</code> <code class="n">passed</code> <code class="n">a</code> <code class="n">new</code> <code class="n">budget</code> <code class="n">that</code> <code class="n">might</code> <code class="n">he</code><code class="nf">\</code>
<code class="linenos">65 </code><code class="nf">lp</code> <code class="n">the</code> <code class="n">economy</code><code class="o">.</code> <code class="kt">The</code> <code class="n">frontier</code> <code class="n">initially</code> <code class="n">was</code> <code class="n">a</code> <code class="n">value</code> <code class="n">path</code><code class="o">.</code> <code class="kt">The</code> <code class="n">ai</code> <code class="n">research</code> <code class="kr">of</code> <code class="n">john</code> <code class="n">mcc</code><code class="nf">\</code>
<code class="linenos">66 </code><code class="nf">arthy</code><code class="o">.</code><code class="s">"</code>
<code class="linenos">67 </code><code class="s">    print $ bestCategories1 (splitWords s)    </code>
<code class="linenos">68 </code><code class="s">    print $ bestCategories1stem (splitWords s)</code>
<code class="linenos">69 </code><code class="s">    print $ score (splitWords s) onegrams</code>
<code class="linenos">70 </code><code class="s">    print $ score (bigram_s (splitWords s)) twograms</code>
<code class="linenos">71 </code><code class="s">    print $ bestCategories2 (splitWords s)</code>
<code class="linenos">72 </code><code class="s">    print $ bestCategories2stem (splitWords s)</code>
<code class="linenos">73 </code><code class="s">    print $ bestCategories (splitWords s)</code>
</pre></div>

</figure>

<p>Here is the output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ stack ghci
<code class="linenos"> 2 </code>:l Categorize.hs
<code class="linenos"> 3 </code>*Categorize&gt; main
<code class="linenos"> 4 </code><code class="o">[(</code><code class="s2">"computers_ai"</code>,17.900000000000002<code class="o">)</code>,<code class="o">(</code><code class="s2">"sports"</code>,9.75<code class="o">)</code>,<code class="o">(</code><code class="s2">"computers_ai_search"</code>,6.2<code class="o">)]</code>
<code class="linenos"> 5 </code><code class="o">[(</code><code class="s2">"computers_ai"</code>,18.700000000000003<code class="o">)</code>,<code class="o">(</code><code class="s2">"computers_ai_search"</code>,8.1<code class="o">)</code>,<code class="o">(</code><code class="s2">"computers_ai_lear\</code>
<code class="linenos"> 6 </code><code class="s2">ning"</code>,5.7<code class="o">)]</code>
<code class="linenos"> 7 </code><code class="o">[(</code><code class="m">2</code>,17.900000000000002<code class="o">)</code>,<code class="o">(</code><code class="m">3</code>,1.75<code class="o">)</code>,<code class="o">(</code><code class="m">4</code>,5.05<code class="o">)</code>,<code class="o">(</code><code class="m">6</code>,6.2<code class="o">)</code>,<code class="o">(</code><code class="m">9</code>,1.1<code class="o">)</code>,<code class="o">(</code><code class="m">10</code>,1.2<code class="o">)</code>,<code class="o">(</code><code class="m">21</code>,2.7<code class="o">)</code>,<code class="o">(</code><code class="m">26</code>,1.1<code class="o">)</code><code class="se">\</code>
<code class="linenos"> 8 </code>,<code class="o">(</code><code class="m">28</code>,1.6<code class="o">)</code>,<code class="o">(</code><code class="m">32</code>,9.75<code class="o">)]</code>
<code class="linenos"> 9 </code><code class="o">[(</code><code class="m">2</code>,2.55<code class="o">)</code>,<code class="o">(</code><code class="m">6</code>,1.0<code class="o">)</code>,<code class="o">(</code><code class="m">32</code>,2.2<code class="o">)]</code>
<code class="linenos">10 </code><code class="o">[(</code><code class="s2">"computers_ai"</code>,2.55<code class="o">)</code>,<code class="o">(</code><code class="s2">"sports"</code>,2.2<code class="o">)</code>,<code class="o">(</code><code class="s2">"computers_ai_search"</code>,1.0<code class="o">)]</code>
<code class="linenos">11 </code><code class="o">[(</code><code class="s2">"computers_ai"</code>,1.6<code class="o">)]</code>
<code class="linenos">12 </code><code class="o">[(</code><code class="s2">"computers_ai"</code>,40.75000000000001<code class="o">)</code>,<code class="o">(</code><code class="s2">"computers_ai_search"</code>,15.3<code class="o">)</code>,<code class="o">(</code><code class="s2">"sports"</code>,11.95<code class="o">)</code>,<code class="o">(</code><code class="s2">"\</code>
<code class="linenos">13 </code><code class="s2">computers_ai_learning"</code>,5.7<code class="o">)]</code>
</pre></div>

</figure>

<p>Given that the variable <strong>s</strong> contains some test text, line 4 of this output was generated by evaluating <strong>bestCategories1 (splitWords s)</strong>, lines 5-6 by evaluating <strong>bestCategories1stem (splitWords s)</strong>, lines 7-8 from <strong>score (splitWords s) onegrams</strong>, line 9 from <strong>core (bigram_s (splitWords s)) twograms</strong>, line 10 from <strong>bestCategories2 (splitWords s)</strong>, line 11 from <strong>bestCategories2stem (splitWords s)</strong>, and lines 12-13 from <strong>bestCategories (splitWords s)</strong>.</p>

<p>I called all of the utility fucntions in function <strong>main</strong> to demonstrate what they do but in practice I just call function <strong>bestCategories</strong> in my applications.</p>

<h3 id="leanpub-auto-text-summarization">Text Summarization</h3>

<p>This application uses both the <em>Categorize.hs</em> code and the 1gram data from the last section. The algorithm I devised for this example is based on a simple idea: we categorize text and keep track of which words provide the strongest evidence for the highest ranked categories. We then return a few sentences from the original text that contain the largest numbers of these important words.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">Summarize</code> <code class="p">(</code><code class="nf">summarize</code><code class="p">,</code> <code class="nf">summarizeS</code><code class="p">)</code> <code class="kr">where</code>

<code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="kr">import</code> <code class="nn">Data.List.Utils</code> <code class="p">(</code><code class="nf">replace</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromMaybe</code><code class="p">)</code>

<code class="kr">import</code> <code class="nn">Categorize</code> <code class="p">(</code><code class="nf">bestCategories</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Sentence</code> <code class="p">(</code><code class="nf">segment</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Utils</code> <code class="p">(</code><code class="nf">splitWords</code><code class="p">,</code> <code class="nf">bigram_s</code><code class="p">,</code> <code class="nf">cleanText</code><code class="p">)</code>

<code class="kr">import</code> <code class="nn">Category1Gram</code> <code class="p">(</code><code class="nf">onegrams</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Category2Gram</code> <code class="p">(</code><code class="nf">twograms</code><code class="p">)</code>

<code class="nf">scoreSentenceHelper</code> <code class="n">words</code> <code class="n">scoreMap</code> <code class="ow">=</code> <code class="c1">-- just use 1grams for now</code>
  <code class="n">sum</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">word</code> <code class="ow">-&gt;</code>  <code class="kt">M</code><code class="o">.</code><code class="n">findWithDefault</code> <code class="mf">0.0</code> <code class="n">word</code> <code class="n">scoreMap</code><code class="p">)</code> <code class="n">words</code>

<code class="nf">safeLookup</code> <code class="n">key</code> <code class="n">alist</code> <code class="ow">=</code>
  <code class="n">fromMaybe</code> <code class="mi">0</code> <code class="o">$</code> <code class="n">lookup</code> <code class="n">key</code> <code class="n">alist</code>
 
<code class="nf">scoreSentenceByBestCategories</code> <code class="n">words</code> <code class="n">catDataMaps</code> <code class="n">bestCategories</code> <code class="ow">=</code>
  <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="n">aMap</code><code class="p">)</code> <code class="ow">-&gt;</code> 
        <code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="n">safeLookup</code> <code class="n">category</code> <code class="n">bestCategories</code> <code class="o">*</code> 
                   <code class="n">scoreSentenceHelper</code> <code class="n">words</code> <code class="n">aMap</code><code class="p">))</code> <code class="n">catDataMaps</code>

<code class="nf">scoreForSentence</code> <code class="n">words</code> <code class="n">catDataMaps</code> <code class="n">bestCategories</code> <code class="ow">=</code>  
  <code class="n">sum</code> <code class="o">$</code> <code class="n">map</code> <code class="n">snd</code> <code class="o">$</code> <code class="n">scoreSentenceByBestCategories</code> <code class="n">words</code> <code class="n">catDataMaps</code> <code class="n">bestCategories</code>

<code class="nf">summarize</code> <code class="n">s</code> <code class="ow">=</code>
  <code class="kr">let</code> <code class="n">words</code> <code class="ow">=</code> <code class="n">splitWords</code> <code class="o">$</code> <code class="n">cleanText</code> <code class="n">s</code>
      <code class="n">bestCats</code> <code class="ow">=</code> <code class="n">bestCategories</code> <code class="n">words</code>
      <code class="n">sentences</code> <code class="ow">=</code> <code class="n">segment</code> <code class="n">s</code>
      <code class="n">result1grams</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">sentence</code> <code class="ow">-&gt;</code>
                           <code class="p">(</code><code class="n">sentence</code><code class="p">,</code>
                            <code class="n">scoreForSentence</code> <code class="p">(</code><code class="n">splitWords</code> <code class="n">sentence</code><code class="p">)</code>
                                             <code class="n">onegrams</code> <code class="n">bestCats</code><code class="p">))</code> 
                         <code class="n">sentences</code>
      <code class="n">result2grams</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="n">sentence</code> <code class="ow">-&gt;</code>
                           <code class="p">(</code><code class="n">sentence</code><code class="p">,</code>
                            <code class="n">scoreForSentence</code> <code class="p">(</code><code class="n">bigram_s</code> <code class="p">(</code><code class="n">splitWords</code> <code class="n">sentence</code><code class="p">))</code>
                                             <code class="n">twograms</code> <code class="n">bestCats</code><code class="p">))</code> 
                         <code class="n">sentences</code>
      <code class="n">mergedResults</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">toList</code> <code class="o">$</code> <code class="kt">M</code><code class="o">.</code><code class="n">unionWith</code> <code class="p">(</code><code class="o">+</code><code class="p">)</code>
                      <code class="p">(</code><code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="n">result1grams</code><code class="p">)</code> <code class="p">(</code><code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="n">result1grams</code><code class="p">)</code>
      <code class="n">c400</code> <code class="ow">=</code> <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">sentence</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">score</code> <code class="o">&gt;</code> <code class="mi">400</code><code class="p">)</code> <code class="n">mergedResults</code>
      <code class="n">c300</code> <code class="ow">=</code> <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">sentence</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">score</code> <code class="o">&gt;</code> <code class="mi">300</code><code class="p">)</code> <code class="n">mergedResults</code>
      <code class="n">c200</code> <code class="ow">=</code> <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">sentence</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">score</code> <code class="o">&gt;</code> <code class="mi">200</code><code class="p">)</code> <code class="n">mergedResults</code>
      <code class="n">c100</code> <code class="ow">=</code> <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">sentence</code><code class="p">,</code> <code class="n">score</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">score</code> <code class="o">&gt;</code> <code class="mi">100</code><code class="p">)</code> <code class="n">mergedResults</code>
      <code class="n">c000</code> <code class="ow">=</code> <code class="n">mergedResults</code> <code class="kr">in</code>
  <code class="kr">if</code> <code class="n">not</code> <code class="p">(</code><code class="n">null</code> <code class="n">c400</code><code class="p">)</code> <code class="kr">then</code> <code class="n">c400</code> <code class="kr">else</code> <code class="kr">if</code> <code class="n">not</code> <code class="p">(</code><code class="n">null</code> <code class="n">c300</code><code class="p">)</code> <code class="kr">then</code> <code class="n">c300</code> <code class="kr">else</code> <code class="kr">if</code> <code class="n">not</code> <code class="p">(</code><code class="n">null</code> <code class="n">c</code><code class="nf">\</code>
<code class="mi">200</code><code class="p">)</code> <code class="kr">then</code> <code class="n">c200</code> <code class="kr">else</code> <code class="kr">if</code> <code class="n">not</code> <code class="p">(</code><code class="n">null</code> <code class="n">c100</code><code class="p">)</code> <code class="kr">then</code> <code class="n">c100</code> <code class="kr">else</code> <code class="n">c000</code>

<code class="nf">summarizeS</code> <code class="n">s</code> <code class="ow">=</code>
  <code class="kr">let</code> <code class="n">a</code> <code class="ow">=</code> <code class="n">replace</code> <code class="s">"</code><code class="se">\"</code><code class="s">"</code> <code class="s">"'"</code> <code class="o">$</code> <code class="n">concatMap</code> <code class="p">(</code><code class="nf">\</code><code class="n">x</code> <code class="ow">-&gt;</code> <code class="n">fst</code> <code class="n">x</code> <code class="o">++</code> <code class="s">" "</code><code class="p">)</code> <code class="o">$</code> <code class="n">summarize</code> <code class="n">s</code> <code class="kr">in</code>
  <code class="kr">if</code> <code class="n">not</code> <code class="p">(</code><code class="n">null</code> <code class="n">a</code><code class="p">)</code> <code class="kr">then</code> <code class="n">a</code> <code class="kr">else</code> <code class="n">safeFirst</code> <code class="o">$</code> <code class="n">segment</code> <code class="n">s</code> <code class="kr">where</code>
    <code class="n">safeFirst</code> <code class="n">x</code> 
      <code class="o">|</code> <code class="n">length</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="mi">1</code> <code class="ow">=</code> <code class="n">head</code> <code class="n">x</code> <code class="o">++</code> <code class="n">x</code> <code class="o">!!</code> <code class="mi">1</code>
      <code class="o">|</code> <code class="n">not</code> <code class="p">(</code><code class="n">null</code> <code class="n">x</code><code class="p">)</code>   <code class="ow">=</code> <code class="n">head</code> <code class="n">x</code>
      <code class="o">|</code> <code class="n">otherwise</code>    <code class="ow">=</code> <code class="s">""</code>
      
<code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>     
  <code class="kr">let</code> <code class="n">s</code> <code class="ow">=</code> <code class="s">"Plunging European stocks, wobbly bonds and grave concerns about the healt</code><code class="se">\</code>
<code class="nf">h</code> <code class="kr">of</code> <code class="kt">Portuguese</code> <code class="n">lender</code> <code class="kt">Banco</code> <code class="kt">Espirito</code> <code class="kt">Santo</code> <code class="kt">SA</code> <code class="n">made</code> <code class="n">last</code> <code class="n">week</code> <code class="n">feel</code> <code class="n">like</code> <code class="n">a</code> <code class="n">rerun</code> <code class="kr">of</code> <code class="n">t</code><code class="nf">\</code>
<code class="nf">he</code> <code class="n">euro</code> <code class="n">crisis</code><code class="p">,</code> <code class="n">but</code> <code class="n">most</code> <code class="n">investors</code> <code class="n">say</code> <code class="n">it</code> <code class="n">was</code> <code class="n">no</code> <code class="n">more</code> <code class="n">than</code> <code class="n">a</code> <code class="n">blip</code> <code class="n">for</code> <code class="n">a</code> <code class="n">resurgent</code> <code class="n">re</code><code class="nf">\</code>
<code class="nf">gion</code><code class="o">.</code> <code class="kt">Banco</code> <code class="kt">Espirito</code> <code class="kt">Santo</code> <code class="n">has</code> <code class="n">been</code> <code class="kr">in</code> <code class="n">investorsâ</code><code class="err">€™</code> <code class="n">sights</code> <code class="n">since</code> <code class="kt">December</code><code class="p">,</code> <code class="n">when</code> <code class="kt">The</code> <code class="nf">\</code>
<code class="kt">Wall</code> <code class="kt">Street</code> <code class="kt">Journal</code> <code class="n">first</code> <code class="n">reported</code> <code class="n">on</code> <code class="n">accounting</code> <code class="n">irregularities</code> <code class="n">at</code> <code class="n">the</code> <code class="n">complex</code> <code class="n">firm</code><code class="o">.\</code>
 <code class="kt">Nerves</code> <code class="n">frayed</code> <code class="n">on</code> <code class="kt">Thursday</code> <code class="n">when</code> <code class="kt">Banco</code> <code class="kt">Espirito</code> <code class="kt">Santo's</code> <code class="n">parent</code> <code class="n">company</code> <code class="n">said</code> <code class="n">it</code> <code class="n">wouldn</code><code class="nf">\</code>
<code class="n">'t</code> <code class="n">be</code> <code class="n">able</code> <code class="n">to</code> <code class="n">meet</code> <code class="n">some</code> <code class="n">short</code><code class="o">-</code><code class="n">term</code> <code class="n">debt</code> <code class="n">obligations</code><code class="o">.</code><code class="s">"</code>
<code class="s">  print $ summarize s</code>
<code class="s">  print $ summarizeS s</code>
</pre></div>

</figure>

<p>Lazy evaluation allows us in function <strong>summarize</strong> to define summaries of various numbers of sentences, but not all of these possible summaries are calculated.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ stack ghci
*Main ... &gt; :l Summarize.hs
*Summarize&gt; main
<code class="o">[(</code><code class="s2">"Nerves frayed on Thursday when Banco Espirito Santo's parent company said it woul\</code>
<code class="s2">dn't be able to meet some short-term debt obligations."</code>,193.54500000000002<code class="o">)]</code>
<code class="s2">"Nerves frayed on Thursday when Banco Espirito Santo's parent company said it wouldn\</code>
<code class="s2">'t be able to meet some short-term debt obligations. "</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-part-of-speech-tagging">Part of Speech Tagging</h3>

<p>We close out this chapter with the Haskell version of my part of speech (POS) tagger that I originally wrote in Common Lisp, then converted to Ruby and Java. The file <em>LexiconData.hs</em> is similar to the lexical data files seen earlier: I am defining a map where keys a words and map values are POS tokens like <em>NNP</em> (proper noun), <em>RB</em> (adverb), etc. The file <em>README.md</em> contains a complete list of POS tag definitions.</p>

<p>The example code and data for this section is in the directory <em>FastTag</em>.</p>

<p>This listing shows a tiny representative part of the POS definitions in <em>LexiconData.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">lexicon</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code> <code class="p">[(</code><code class="s">"AARP"</code><code class="p">,</code> <code class="s">"NNP"</code><code class="p">),</code> <code class="p">(</code><code class="s">"Clinic"</code><code class="p">,</code> <code class="s">"NNP"</code><code class="p">),</code> <code class="p">(</code><code class="s">"Closed"</code><code class="p">,</code> <code class="s">"VBN"</code><code class="p">),</code>
                      <code class="p">(</code><code class="s">"Robert"</code><code class="p">,</code> <code class="s">"NNP"</code><code class="p">),</code> <code class="p">(</code><code class="s">"West-German"</code><code class="p">,</code> <code class="s">"JJ"</code><code class="p">),</code>
                      <code class="p">(</code><code class="s">"afterwards"</code><code class="p">,</code> <code class="s">"RB"</code><code class="p">),</code> <code class="p">(</code><code class="s">"arises"</code><code class="p">,</code> <code class="s">"VBZ"</code><code class="p">),</code>
					  <code class="p">(</code><code class="s">"attacked"</code><code class="p">,</code> <code class="s">"VBN"</code><code class="p">),</code> <code class="o">...</code><code class="p">]</code>
</pre></div>

</figure>

<p>Before looking at the code example listing, let’s see how the functions defined in <em>fasttag.hs</em> work in a GHCi repl:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code> <code class="kt">LexiconData</code><code class="o">&gt;</code> <code class="n">bigram</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"ran"</code><code class="p">,</code>
                           <code class="s">"around"</code><code class="p">,</code> <code class="s">"the"</code><code class="p">,</code> <code class="s">"tree"</code><code class="p">]</code>
<code class="p">[[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"dog"</code><code class="p">],[</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"ran"</code><code class="p">],[</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"around"</code><code class="p">],</code>
 <code class="p">[</code><code class="s">"around"</code><code class="p">,</code><code class="s">"the"</code><code class="p">],[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"tree"</code><code class="p">]]</code>
<code class="o">*</code><code class="kt">Main</code> <code class="kt">LexiconData</code><code class="o">&gt;</code> <code class="n">tagHelper</code> <code class="s">"car"</code>
<code class="p">[</code><code class="s">"car"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">]</code>
<code class="o">*</code><code class="kt">Main</code> <code class="kt">LexiconData</code><code class="o">&gt;</code> <code class="n">tagHelper</code> <code class="s">"run"</code>
<code class="p">[</code><code class="s">"run"</code><code class="p">,</code><code class="s">"VB"</code><code class="p">]</code>
<code class="o">*</code><code class="kt">Main</code> <code class="kt">LexiconData</code><code class="o">&gt;</code> <code class="n">substitute</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"ran"</code><code class="p">,</code> <code class="s">"around"</code><code class="p">,</code>
                               <code class="s">"the"</code><code class="p">,</code> <code class="s">"tree"</code><code class="p">]</code>
<code class="p">[[[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">],[</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">]],[[</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">],[</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">]],</code>
 <code class="p">[[</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">],[</code><code class="s">"around"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">]],[[</code><code class="s">"around"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">],[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">]],</code>
 <code class="p">[[</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">],[</code><code class="s">"tree"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">]]]</code>
<code class="o">*</code><code class="kt">Main</code> <code class="kt">LexiconData</code><code class="o">&gt;</code> <code class="n">fixTags</code> <code class="o">$</code>  <code class="n">substitute</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"ran"</code><code class="p">,</code> 
                                          <code class="s">"around"</code><code class="p">,</code> <code class="s">"the"</code><code class="p">,</code> <code class="s">"tree"</code><code class="p">]</code>
<code class="p">[</code><code class="s">"NN"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">]</code>
</pre></div>

</figure>

<p>Function <strong>bigram</strong> takes a list or words and returns a list of word pairs. We need the word pairs because parts of the tagging algorithm needs to see a word with its preceeding word. In an imperative language, I would loop over the words and for a word at index <strong>i</strong> I would have the word at index <strong>i - 1</strong>. In a functional language, we avoid using loops and in this case create a list of adjacent word pairs to avoid having to use an explicit loop. I like this style of functional programming but if you come from years of using imperative language like Java and C++ it takes some getting used to.</p>

<p><strong>tagHelper</strong> converts a word into a list of the word and its likely tag. <strong>substitute</strong> applies <strong>tagHelper</strong> to a list of words, getting the most probable tag for each word. The function <strong>fixTags</strong> will occasionally override the default word tags based on a few rules that are derived from Eric Brill’s paper <a href="http://aclweb.org/anthology/A92-1021">A Simple Rule-Based Part of Speech Tagger</a>.</p>

<p>Here is the entire example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.Strings</code> <code class="p">(</code><code class="nf">strEndsWith</code><code class="p">,</code> <code class="nf">strStartsWith</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Data.List</code> <code class="p">(</code><code class="nf">isInfixOf</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">LexiconData</code> <code class="p">(</code><code class="nf">lexicon</code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nf">bigram</code> <code class="ow">::</code> <code class="p">[</code><code class="n">a</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[[</code><code class="n">a</code><code class="p">]]</code>
<code class="linenos">10 </code><code class="nf">bigram</code> <code class="kt">[]</code> <code class="ow">=</code> <code class="kt">[]</code>
<code class="linenos">11 </code><code class="nf">bigram</code> <code class="p">[</code><code class="kr">_</code><code class="p">]</code> <code class="ow">=</code> <code class="kt">[]</code>
<code class="linenos">12 </code><code class="nf">bigram</code> <code class="n">xs</code> <code class="ow">=</code> <code class="n">take</code> <code class="mi">2</code> <code class="n">xs</code> <code class="kt">:</code> <code class="n">bigram</code> <code class="p">(</code><code class="n">tail</code> <code class="n">xs</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="nf">containsString</code> <code class="n">word</code> <code class="n">substring</code> <code class="ow">=</code> <code class="n">isInfixOf</code> <code class="n">substring</code> <code class="n">word</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="nf">fixTags</code> <code class="n">twogramList</code> <code class="ow">=</code>
<code class="linenos">17 </code>  <code class="n">map</code>
<code class="linenos">18 </code>  <code class="c1">-- in the following inner function, [last,current] might be bound,</code>
<code class="linenos">19 </code>  <code class="c1">-- for example, to [["dog","NN"],["ran","VBD"]]</code>
<code class="linenos">20 </code>  <code class="p">(</code><code class="nf">\</code><code class="p">[</code><code class="n">last</code><code class="p">,</code> <code class="n">current</code><code class="p">]</code> <code class="ow">-&gt;</code>
<code class="linenos">21 </code>    <code class="c1">-- rule 1: DT, {VBD | VBP} --&gt; DT, NN</code>
<code class="linenos">22 </code>    <code class="kr">if</code> <code class="n">last</code> <code class="o">!!</code> <code class="mi">1</code> <code class="o">==</code> <code class="s">"DT"</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code> <code class="o">==</code> <code class="s">"VBD"</code> <code class="o">||</code>
<code class="linenos">23 </code>                             <code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code> <code class="o">==</code> <code class="s">"VB"</code> <code class="o">||</code>
<code class="linenos">24 </code>                             <code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code> <code class="o">==</code> <code class="s">"VBP"</code><code class="p">)</code>
<code class="linenos">25 </code>    <code class="kr">then</code> <code class="s">"NN"</code> 
<code class="linenos">26 </code>    <code class="kr">else</code>
<code class="linenos">27 </code>      <code class="c1">-- rule 2: convert a noun to a number (CD) if "." appears in the word</code>
<code class="linenos">28 </code>      <code class="kr">if</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="o">!!</code> <code class="mi">0</code> <code class="o">==</code> <code class="sc">'N'</code> <code class="o">&amp;&amp;</code> <code class="n">containsString</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"."</code>
<code class="linenos">29 </code>      <code class="kr">then</code> <code class="s">"CD"</code>
<code class="linenos">30 </code>      <code class="kr">else</code>
<code class="linenos">31 </code>        <code class="c1">-- rule 3: convert a noun to a past participle if</code>
<code class="linenos">32 </code>        <code class="c1">--         words.get(i) ends with "ed"</code>
<code class="linenos">33 </code>        <code class="kr">if</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="o">!!</code> <code class="mi">0</code> <code class="o">==</code> <code class="sc">'N'</code> <code class="o">&amp;&amp;</code> <code class="n">strEndsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"ed"</code>
<code class="linenos">34 </code>        <code class="kr">then</code> <code class="s">"VBN"</code>
<code class="linenos">35 </code>        <code class="kr">else</code>
<code class="linenos">36 </code>          <code class="c1">-- rule 4: convert any type to adverb if it ends in "ly"</code>
<code class="linenos">37 </code>          <code class="kr">if</code> <code class="n">strEndsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"ly"</code>
<code class="linenos">38 </code>          <code class="kr">then</code> <code class="s">"RB"</code>
<code class="linenos">39 </code>          <code class="kr">else</code>
<code class="linenos">40 </code>            <code class="c1">-- rule 5: convert a common noun (NN or NNS) to an</code>
<code class="linenos">41 </code>            <code class="c1">--         adjective if it ends with "al"</code>
<code class="linenos">42 </code>            <code class="kr">if</code> <code class="n">strStartsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="s">"NN"</code> <code class="o">&amp;&amp;</code>
<code class="linenos">43 </code>               <code class="n">strEndsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="s">"al"</code>
<code class="linenos">44 </code>            <code class="kr">then</code> <code class="s">"JJ"</code>
<code class="linenos">45 </code>            <code class="kr">else</code>
<code class="linenos">46 </code>              <code class="c1">-- rule 6: convert a noun to a verb if the preceeding</code>
<code class="linenos">47 </code>              <code class="c1">--         word is "would"</code>
<code class="linenos">48 </code>              <code class="kr">if</code> <code class="n">strStartsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="s">"NN"</code> <code class="o">&amp;&amp;</code>
<code class="linenos">49 </code>                 <code class="p">(</code><code class="n">last</code> <code class="o">!!</code> <code class="mi">0</code><code class="p">)</code> <code class="o">==</code> <code class="s">"would"</code> <code class="c1">-- should be case insensitive</code>
<code class="linenos">50 </code>              <code class="kr">then</code> <code class="s">"VB"</code>
<code class="linenos">51 </code>              <code class="kr">else</code>
<code class="linenos">52 </code>                <code class="c1">-- rule 7: if a word has been categorized as a</code>
<code class="linenos">53 </code>                <code class="c1">--         common noun and it ends with "s",</code>
<code class="linenos">54 </code>                <code class="c1">--         then set its type to plural common noun (NNS)</code>
<code class="linenos">55 </code>                <code class="kr">if</code> <code class="n">strStartsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="s">"NN"</code> <code class="o">&amp;&amp;</code>
<code class="linenos">56 </code>                   <code class="n">strEndsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"s"</code>
<code class="linenos">57 </code>                <code class="kr">then</code> <code class="s">"NNS"</code>
<code class="linenos">58 </code>                <code class="kr">else</code>
<code class="linenos">59 </code>                  <code class="c1">-- rule 8: convert a common noun to a present</code>
<code class="linenos">60 </code>                  <code class="c1">--         participle verb (i.e., a gerand)</code>
<code class="linenos">61 </code>                  <code class="kr">if</code> <code class="n">strStartsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">)</code> <code class="s">"NN"</code> <code class="o">&amp;&amp;</code>
<code class="linenos">62 </code>                     <code class="n">strEndsWith</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"ing"</code>
<code class="linenos">63 </code>                  <code class="kr">then</code> <code class="s">"VBG"</code>
<code class="linenos">64 </code>                  <code class="kr">else</code> <code class="p">(</code><code class="n">current</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">65 </code> <code class="n">twogramList</code>
<code class="linenos">66 </code>  
<code class="linenos">67 </code><code class="nf">substitute</code> <code class="n">tks</code> <code class="ow">=</code> <code class="n">bigram</code> <code class="o">$</code> <code class="n">map</code> <code class="n">tagHelper</code> <code class="n">tks</code>
<code class="linenos">68 </code>
<code class="linenos">69 </code><code class="nf">tagHelper</code> <code class="n">token</code> <code class="ow">=</code>
<code class="linenos">70 </code>  <code class="kr">let</code> <code class="n">tags</code> <code class="ow">=</code> <code class="kt">M</code><code class="o">.</code><code class="n">findWithDefault</code> <code class="kt">[]</code> <code class="n">token</code> <code class="n">lexicon</code> <code class="kr">in</code>
<code class="linenos">71 </code>  <code class="kr">if</code> <code class="n">tags</code> <code class="o">==</code> <code class="kt">[]</code> <code class="kr">then</code> <code class="p">[</code><code class="n">token</code><code class="p">,</code> <code class="s">"NN"</code><code class="p">]</code> <code class="kr">else</code> <code class="p">[</code><code class="n">token</code><code class="p">,</code> <code class="n">tags</code><code class="p">]</code>
<code class="linenos">72 </code>
<code class="linenos">73 </code><code class="nf">tag</code> <code class="n">tokens</code> <code class="ow">=</code> <code class="n">fixTags</code> <code class="o">$</code> <code class="n">substitute</code> <code class="p">([</code><code class="s">""</code><code class="p">]</code> <code class="o">++</code> <code class="n">tokens</code><code class="p">)</code>
<code class="linenos">74 </code>
<code class="linenos">75 </code>
<code class="linenos">76 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">77 </code>  <code class="kr">let</code> <code class="n">tokens</code> <code class="ow">=</code> <code class="p">[</code><code class="s">"the"</code><code class="p">,</code> <code class="s">"dog"</code><code class="p">,</code> <code class="s">"ran"</code><code class="p">,</code> <code class="s">"around"</code><code class="p">,</code> <code class="s">"the"</code><code class="p">,</code> <code class="s">"tree"</code><code class="p">,</code> <code class="s">"while"</code><code class="p">,</code>
<code class="linenos">78 </code>                <code class="s">"the"</code><code class="p">,</code> <code class="s">"cat"</code><code class="p">,</code> <code class="s">"snaked"</code><code class="p">,</code> <code class="s">"around"</code><code class="p">,</code> <code class="s">"the"</code><code class="p">,</code> <code class="s">"trunk"</code><code class="p">,</code>
<code class="linenos">79 </code>                <code class="s">"while"</code><code class="p">,</code> <code class="s">"banking"</code><code class="p">,</code> <code class="s">"to"</code><code class="p">,</code> <code class="s">"the"</code><code class="p">,</code> <code class="s">"left"</code><code class="p">]</code>
<code class="linenos">80 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">tag</code> <code class="n">tokens</code>
<code class="linenos">81 </code>  <code class="n">print</code> <code class="o">$</code> <code class="n">zip</code> <code class="n">tokens</code> <code class="o">$</code> <code class="n">tag</code> <code class="n">tokens</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code> <code class="kt">LexiconData</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="p">[</code><code class="s">"DT"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">,</code>
 <code class="s">"NN"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">,</code><code class="s">"VBG"</code><code class="p">,</code><code class="s">"TO"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">,</code><code class="s">"VBN"</code><code class="p">]</code>
<code class="p">[(</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">),(</code><code class="s">"dog"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">),(</code><code class="s">"ran"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">),(</code><code class="s">"around"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">),</code>
 <code class="p">(</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">),(</code><code class="s">"tree"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">),(</code><code class="s">"while"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">),(</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">),</code>
 <code class="p">(</code><code class="s">"cat"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">),(</code><code class="s">"snaked"</code><code class="p">,</code><code class="s">"VBD"</code><code class="p">),(</code><code class="s">"around"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">),(</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">),</code>
 <code class="p">(</code><code class="s">"trunk"</code><code class="p">,</code><code class="s">"NN"</code><code class="p">),(</code><code class="s">"while"</code><code class="p">,</code><code class="s">"IN"</code><code class="p">),(</code><code class="s">"banking"</code><code class="p">,</code><code class="s">"VBG"</code><code class="p">),(</code><code class="s">"to"</code><code class="p">,</code><code class="s">"TO"</code><code class="p">),</code>
 <code class="p">(</code><code class="s">"the"</code><code class="p">,</code><code class="s">"DT"</code><code class="p">),(</code><code class="s">"left"</code><code class="p">,</code><code class="s">"VBN"</code><code class="p">)]</code>
</pre></div>

</figure>

<p>The README.md file contains definitions of the POS definitions. Here are the ones used in this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>DT Determiner               the,some
NN noun                     dog,cat,road
VBD verb, past tense        ate,ran
IN Preposition              of,in,by
</pre></div>

</figure>

<h3 id="leanpub-auto-natural-language-processing-wrap-up">Natural Language Processing Wrap Up</h3>

<p>NLP is a large topic. I have attempted to show you just the few tricks that I use often and are simple to implement. I hope that you reuse the code in this chapter in your own projects when you need to detect entities, classify text, summarize text, and assign part of speech tags to words in text.</p>


<h2 id="leanpub-auto-linked-data-and-the-semantic-web">Linked Data and the Semantic Web</h2>

<p>I am going to show you how to query semantic web data sources on the web and provide examples for how you might use this data in applications. I have written two previous books on the semantic web, one covering Common Lisp and the other covering JVM languages Java, Scala, Clojure, and Ruby. You can get free PDF versions on the <a href="http://www.markwatson.com/books/">book page of www.markwatson.com</a>. If you enjoy the light introduction in this chapter then please do download a free copy of my semantic web book for more material on RDF, RDFS, and SPARQL.</p>

<p>I like to think of the semantic web and linked data resources as:</p>

<ul>
  <li>A source of structured data on the web. These resources are called SPARQL endpoints.</li>
  <li>Data is represented by data triples: subject, predicate, and object. The subject of one triple can be the object of another triple. Predicates are relationships; a few examples: “owns”, “is part of”, “author of”, etc.</li>
  <li>Data that is accessed via the SPARQL query language.</li>
  <li>A source of data that may or may not be available. SPARQL endpoints are typically available for free use and they are sometimes unavailable. Although not covered here, I sometimes work around this problem by adding a caching layer to SPARQL queries (access key being a SPARQL query string, the value being the query results). This caching speeds up development and running unit tests, and sometimes saves a customer demo when a required SPARQL endpoint goes offline at an inconvenient time.</li>
</ul>

<p>DBPedia is the semantic web version of <a href="http://wiki.dbpedia.org/">Wikipedia</a>. The many millions of data triples that make up DBPedia are mostly derived from the structured “info boxes” on Wikipedia pages.</p>

<p>As you are learning SPARQL use the <a href="http://dbpedia.org/sparql">DBPedia SPARQL endpoint</a> to practice. As a practitioner who uses linked data, for any new project I start by identifying SPARQL endpoints for possibly useful data. I then interactively experiment with SPARQL queries to extract the data I need. Only when I am satisfied with the choice of SPARQL endpoints and SPARQL queries do I write any code to automatically fetch linked data for my application.</p>

<p><strong>Pro</strong> <strong>tip:</strong> I mentioned SPARQL query caching. I sometimes cache query results in a local database, saving the returned RDF data indexed by the SPARQL query. You can also store the cache timestamp and refresh the cache every few weeks as needed. In addition to making development and unit testing faster, your applications will be more resilient.</p>

<p>In the last chapter “Natural Language Processing Tools” we resolved entities in natural language text to DBPedia (semantic web SPAQL endpoint for Wikipedia) URIs. Here we will use some of these URIs to demonstrate fetching real world knowledge that you might want to use in applications.</p>

<h3 id="leanpub-auto-the-sparql-query-language">The SPARQL Query Language</h3>

<p>Example RDF N3 triples (subject, predicate, object) might look like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nl">&lt;http://www.markwatson.com&gt;</code>
  <code class="nl">&lt;http://dbpedia.org/ontology/owner&gt;</code>
  <code class="s">"Mark Watson"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Element of triples can be URIs or string constants. Triples are often written all on one line; I split it to three lines to fit the page width. Here the subject is the URI for my web site, the predicate is a URI defining an ownership relationship, and the object is a string literal.</p>

<p>If you want to see details for any property or other URI you see, then “follow your nose” and open the URI in a web browser. For example remove the brackets from the <a href="http://dbpedia.org/ontology/owner">owner property URI </a><a href="http://dbpedia.org/ontology/owner">http://dbpedia.org/ontology/owner</a> and open it in a web browser. For working with RDF data programatically, it is convenient using full URI. For humans reading RDF, the N3 notation is better because it supports defining URI standard prefixes for use as abbreviations; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">prefix</code> <code class="nn">ontology</code><code class="p">:</code> <code class="nl">&lt;http://dbpedia.org/ontology/&gt;</code>

<code class="nl">&lt;http://www.markwatson.com&gt;</code>
  <code class="nn">ontology</code><code class="p">:</code><code class="nt">owner</code>
  <code class="s">"Mark Watson"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>If you wanted to find all things that I own (assuming this data was in a public RDF repository, which it isn’t) then we might think to match the pattern:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">prefix</code> <code class="nn">ontology</code><code class="p">:</code> <code class="nl">&lt;http://dbpedia.org/ontology/&gt;</code>

<code class="nv">?subject</code> <code class="nn">ontology</code><code class="p">:</code><code class="nt">owner</code> <code class="s">"Mark Watson"</code>
</pre></div>

</figure>

<p>And return all URIs matching the variable <strong>?subject</strong> as the query result. This is the basic idea of making SPARQL queries.</p>

<p>The following SPARQL query will be implemented later in Haskell using the HSparql library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">prefix</code> <code class="nn">resource</code><code class="p">:</code> <code class="nl">&lt;http://dbpedia.org/resource/&gt;</code>
<code class="linenos">2 </code><code class="k">prefix</code> <code class="nn">dbpprop</code><code class="p">:</code> <code class="nl">&lt;http://dbpedia.org/property/&gt;</code>
<code class="linenos">3 </code><code class="k">prefix</code> <code class="nn">foaf</code><code class="p">:</code> <code class="nl">&lt;http://xmlns.com/foaf/0.1/&gt;</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="k">SELECT</code> <code class="o">*</code>
<code class="linenos">6 </code><code class="k">WHERE</code> <code class="p">{</code>
<code class="linenos">7 </code>    <code class="nv">?s</code> <code class="nn">dbpprop</code><code class="p">:</code><code class="nt">genre</code> <code class="nn">resource</code><code class="p">:</code><code class="nt">Web_browser</code> <code class="p">.</code>
<code class="linenos">8 </code>    <code class="nv">?s</code> <code class="nn">foaf</code><code class="p">:</code><code class="nt">name</code> <code class="nv">?name</code> <code class="p">.</code>
<code class="linenos">9 </code><code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>In this last SPARQL query example, the triple patterns we are trying to match are inside a <em>WHERE</em> clause. Notice that in the two triple patterns, the subject field of each is the variable <strong>?s</strong>. The first pattern matches all DBPedia triples with a predicate <a href="http://dbpedia.org/property/genre">http://dbpedia.org/property/genre</a> and an object equal to <a href="http://dbpedia.org/resource/Web_browser">http://dbpedia.org/resource/Web_browser</a>. We then find all triples with the same subject but with a predicate equal to <a href="http://xmlns.com/foaf/0.1/name">http://xmlns.com/foaf/0.1/name</a>.</p>

<p>Each result from this query will contain two values for variables <strong>?s</strong> and <strong>?name</strong>: a DBPedia URI for some thing and the name for that thing. Later we will run this query using Haskell code and you can see what the output might look like.</p>

<p>Sometimes when I am using a specific SPARQL query in an application, I don’t bother defining prefixes and just use URIs in the query. As an example, suppose I want to return the Wikipedia (or DBPedia) abstract for IBM. I might use a query such as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">select</code> <code class="o">*</code> <code class="k">where</code> <code class="p">{</code>
<code class="linenos">2 </code>  <code class="nl">&lt;http://dbpedia.org/resource/IBM&gt;</code>
<code class="linenos">3 </code>  <code class="nl">&lt;http://dbpedia.org/ontology/abstract&gt;</code>
<code class="linenos">4 </code>  <code class="nv">?o</code> <code class="p">.</code>
<code class="linenos">5 </code>  <code class="k">FILTER</code> <code class="nf">langMatches</code><code class="p">(</code><code class="nf">lang</code><code class="p">(</code><code class="nv">?o</code><code class="p">),</code> <code class="s">"EN"</code><code class="p">)</code>
<code class="linenos">6 </code><code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">100</code>
</pre></div>

</figure>

<p>If you try this query using the <a href="http://dbpedia.org/sparql/">web interface for DBPedia SPARQL queries</a> you get just one result because of the FILTER option that only returns English language results. You could also use FR for French results, GE for German results, etc.</p>

<h3 id="leanpub-auto-a-haskell-http-based-sparql-client">A Haskell HTTP Based SPARQL Client</h3>

<p>One approach to query the DBPedia SPARQL endpoint is to build a HTTP GET request, send it to the SPARQL endpoint server, and parse the returned XML response. We will start with this simple approach. You will recognize the SPARQL query from the last section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">HttpSparqlClient</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Network.HTTP.Conduit</code> <code class="p">(</code><code class="nf">simpleHttp</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="nn">Network.HTTP.Base</code> <code class="p">(</code><code class="nf">urlEncode</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">Text.XML.HXT.Core</code>
<code class="linenos"> 8 </code><code class="kr">import</code> <code class="nn">Text.HandsomeSoup</code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.ByteString.Lazy.Char8</code> <code class="k">as</code> <code class="n">B</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="nf">buildQuery</code> <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">12 </code><code class="nf">buildQuery</code> <code class="n">sparqlString</code> <code class="ow">=</code>
<code class="linenos">13 </code>  <code class="s">"http://dbpedia.org/sparql/?query="</code> <code class="o">++</code> <code class="n">urlEncode</code> <code class="n">sparqlString</code>
<code class="linenos">14 </code>  
<code class="linenos">15 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">16 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">17 </code>  <code class="kr">let</code> <code class="n">query</code> <code class="ow">=</code> <code class="n">buildQuery</code> <code class="s">"select * where {&lt;http://dbpedia.org/resource/IBM&gt; &lt;http://</code><code class="se">\</code>
<code class="linenos">18 </code><code class="nf">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ontology</code><code class="o">/</code><code class="n">abstract</code><code class="o">&gt;</code> <code class="o">?</code><code class="n">o</code> <code class="o">.</code> <code class="kt">FILTER</code> <code class="n">langMatches</code><code class="p">(</code><code class="n">lang</code><code class="p">(</code><code class="o">?</code><code class="n">o</code><code class="p">),</code> <code class="nf">\</code><code class="s">"EN</code><code class="se">\"</code><code class="s">)} LIMIT 100"</code>
<code class="linenos">19 </code>  <code class="n">res</code> <code class="ow">&lt;-</code> <code class="n">simpleHttp</code> <code class="n">query</code>
<code class="linenos">20 </code>  <code class="kr">let</code> <code class="n">doc</code> <code class="ow">=</code> <code class="n">readString</code> <code class="kt">[]</code>  <code class="p">(</code><code class="kt">B</code><code class="o">.</code><code class="n">unpack</code> <code class="n">res</code><code class="p">)</code>
<code class="linenos">21 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">Abstracts:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">22 </code>  <code class="n">abstracts</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"binding"</code> <code class="o">&gt;&gt;&gt;</code>
<code class="linenos">23 </code>                              <code class="p">(</code><code class="n">getAttrValue</code> <code class="s">"name"</code> <code class="o">&amp;&amp;&amp;</code> <code class="p">(</code><code class="n">deep</code> <code class="n">getText</code><code class="p">))</code>
<code class="linenos">24 </code>  <code class="n">print</code> <code class="n">abstracts</code>
</pre></div>

</figure>

<p>The function <strong>buildQuery</strong> defined in lined 11-13 takes any SPARQL query, URL encodes it so it can be passed as part of a URI, and builds a query string for the DBPedia SPARQL endpoint. The returned data is in XML format. In lines 23-24 I am using the <strong>XHT</strong> parsing library to extract the names (values bound to the variable <strong>?o</strong> in the query in line 17). I cover the use of <strong>HXT</strong> and the <strong>HandsomeSoup</strong> parsing libraries in the next chapter.</p>

<p>In the <strong>main</strong> function, we use the utility function <strong>simpleHttp</strong> in line 20 to fetch the results as a ByteString and in line 21 we unback this to a regular Haskell String.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kt">Prelude</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">HttpSparqlClient</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">HttpSparqlClient</code> <code class="p">(</code> <code class="kt">HttpSparqlClient</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">HttpSparqlClient</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">HttpSparqlClient</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kt">Abstracts:</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">[(</code><code class="s">"o"</code><code class="p">,</code><code class="s">"International Business Machines Corporation (commonly referred to as IBM) is </code><code class="se">\</code>
<code class="linenos"> 9 </code><code class="nf">an</code> <code class="kt">American</code> <code class="n">multinational</code> <code class="n">technology</code> <code class="n">and</code> <code class="n">consulting</code> <code class="n">corporation</code><code class="p">,</code> <code class="n">with</code> <code class="n">corporate</code> <code class="n">head</code><code class="nf">\</code>
<code class="linenos">10 </code><code class="nf">quarters</code> <code class="kr">in</code> <code class="kt">Armonk</code><code class="p">,</code> <code class="kt">New</code> <code class="kt">York</code><code class="o">.</code>
<code class="linenos">11 </code>  <code class="o">...</code><code class="p">)]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-querying-remote-sparql-endpoints">Querying Remote SPARQL Endpoints</h3>

<p>We will write some code in this section to make the example query to get the names of web browsers from DBPedia. In the last section we made a SPARQL query using fairly low level Haskell libraries. We will be using the high level library <em>HSparql</em> to build SPARQL queries and call the DBPedia SPARQL endpoint.</p>

<p>The example in this section can be found in <em>SparqlClient/TestSparqlClient.hs</em>. In the <strong>main</strong> function notice how I have commented out printouts of the raw query results. Because Haskell is type safe, extracting the values wrapped in query results requires knowing RDF element return types. I will explain this matching after the program listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">-- simple experiments with the excellent HSparql library</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Database.HSparql.Connection</code> <code class="p">(</code><code class="kt">BindingValue</code><code class="p">(</code><code class="kt">Bound</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">Data.RDF</code> <code class="k">hiding</code> <code class="p">(</code><code class="nf">triple</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="kr">import</code> <code class="nn">Database.HSparql.QueryGenerator</code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="nn">Database.HSparql.Connection</code> <code class="p">(</code><code class="nf">selectQuery</code><code class="p">)</code>
<code class="linenos">10 </code>    
<code class="linenos">11 </code><code class="nf">webBrowserSelect</code> <code class="ow">::</code> <code class="kt">Query</code> <code class="kt">SelectQuery</code>
<code class="linenos">12 </code><code class="nf">webBrowserSelect</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">13 </code>    <code class="n">resource</code> <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"dbprop"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://dbpedia.org/resource/"</code><code class="p">)</code>
<code class="linenos">14 </code>    <code class="n">dbpprop</code>  <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"dbpedia"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://dbpedia.org/property/"</code><code class="p">)</code>
<code class="linenos">15 </code>    <code class="n">foaf</code>     <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"foaf"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://xmlns.com/foaf/0.1/"</code><code class="p">)</code>
<code class="linenos">16 </code>    <code class="n">x</code>    <code class="ow">&lt;-</code> <code class="n">var</code>
<code class="linenos">17 </code>    <code class="n">name</code> <code class="ow">&lt;-</code> <code class="n">var</code>
<code class="linenos">18 </code>    <code class="n">triple</code> <code class="n">x</code> <code class="p">(</code><code class="n">dbpprop</code> <code class="o">.:.</code> <code class="s">"genre"</code><code class="p">)</code> <code class="p">(</code><code class="n">resource</code> <code class="o">.:.</code> <code class="s">"Web_browser"</code><code class="p">)</code>
<code class="linenos">19 </code>    <code class="n">triple</code> <code class="n">x</code> <code class="p">(</code><code class="n">foaf</code> <code class="o">.:.</code> <code class="s">"name"</code><code class="p">)</code> <code class="n">name</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>    <code class="n">return</code> <code class="kt">SelectQuery</code> <code class="p">{</code> <code class="n">queryVars</code> <code class="ow">=</code> <code class="p">[</code><code class="n">name</code><code class="p">]</code> <code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="nf">companyAbstractSelect</code> <code class="ow">::</code> <code class="kt">Query</code> <code class="kt">SelectQuery</code>
<code class="linenos">24 </code><code class="nf">companyAbstractSelect</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">25 </code>    <code class="n">resource</code> <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"dbprop"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://dbpedia.org/resource/"</code><code class="p">)</code>
<code class="linenos">26 </code>    <code class="n">ontology</code> <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"ontology"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://dbpedia.org/ontology/"</code><code class="p">)</code>
<code class="linenos">27 </code>    <code class="n">o</code> <code class="ow">&lt;-</code> <code class="n">var</code>
<code class="linenos">28 </code>    <code class="n">triple</code> <code class="p">(</code><code class="n">resource</code> <code class="o">.:.</code> <code class="s">"Edinburgh_University_Press"</code><code class="p">)</code> <code class="p">(</code><code class="n">ontology</code> <code class="o">.:.</code> <code class="s">"abstract"</code><code class="p">)</code> <code class="n">o</code>
<code class="linenos">29 </code>    <code class="n">return</code> <code class="kt">SelectQuery</code> <code class="p">{</code> <code class="n">queryVars</code> <code class="ow">=</code> <code class="p">[</code><code class="n">o</code><code class="p">]</code> <code class="p">}</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code><code class="nf">companyTypeSelect</code> <code class="ow">::</code> <code class="kt">Query</code> <code class="kt">SelectQuery</code>
<code class="linenos">32 </code><code class="nf">companyTypeSelect</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">33 </code>    <code class="n">resource</code> <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"dbprop"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://dbpedia.org/resource/"</code><code class="p">)</code>
<code class="linenos">34 </code>    <code class="n">ontology</code> <code class="ow">&lt;-</code> <code class="n">prefix</code> <code class="s">"ontology"</code> <code class="p">(</code><code class="n">iriRef</code> <code class="s">"http://dbpedia.org/ontology/"</code><code class="p">)</code>
<code class="linenos">35 </code>    <code class="n">o</code> <code class="ow">&lt;-</code> <code class="n">var</code>
<code class="linenos">36 </code>    <code class="n">triple</code> <code class="p">(</code><code class="n">resource</code> <code class="o">.:.</code> <code class="s">"Edinburgh_University_Press"</code><code class="p">)</code> <code class="p">(</code><code class="n">ontology</code> <code class="o">.:.</code> <code class="s">"type"</code><code class="p">)</code> <code class="n">o</code>
<code class="linenos">37 </code>    <code class="n">return</code> <code class="kt">SelectQuery</code> <code class="p">{</code> <code class="n">queryVars</code> <code class="ow">=</code> <code class="p">[</code><code class="n">o</code><code class="p">]</code> <code class="p">}</code>
<code class="linenos">38 </code>
<code class="linenos">39 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">40 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">41 </code>  <code class="n">sq1</code> <code class="ow">&lt;-</code> <code class="n">selectQuery</code> <code class="s">"http://dbpedia.org/sparql"</code> <code class="n">companyAbstractSelect</code>
<code class="linenos">42 </code>  <code class="c1">--putStrLn "\nRaw results of company abstract SPARQL query:\n"</code>
<code class="linenos">43 </code>  <code class="c1">--print sq1</code>
<code class="linenos">44 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">Web browser names extracted from the company abstract query results:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">45 </code>  <code class="kr">case</code> <code class="n">sq1</code> <code class="kr">of</code>
<code class="linenos">46 </code>    <code class="kt">Just</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">print</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">[</code><code class="kt">Bound</code> <code class="p">(</code><code class="kt">LNode</code> <code class="p">(</code><code class="kt">PlainLL</code> <code class="n">s</code> <code class="kr">_</code><code class="p">))]</code> <code class="ow">-&gt;</code> <code class="n">s</code><code class="p">)</code> <code class="n">a</code>
<code class="linenos">47 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">putStrLn</code> <code class="s">"nothing"</code>
<code class="linenos">48 </code>  <code class="n">sq2</code> <code class="ow">&lt;-</code> <code class="n">selectQuery</code> <code class="s">"http://dbpedia.org/sparql"</code> <code class="n">companyTypeSelect</code>
<code class="linenos">49 </code>  <code class="c1">--putStrLn "\nRaw results of company type SPARQL query:\n"</code>
<code class="linenos">50 </code>  <code class="c1">--print sq2</code>
<code class="linenos">51 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">Web browser names extracted from the company type query results:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">52 </code>  <code class="kr">case</code> <code class="n">sq2</code> <code class="kr">of</code>
<code class="linenos">53 </code>    <code class="kt">Just</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">print</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">[</code><code class="kt">Bound</code> <code class="p">(</code><code class="kt">UNode</code>  <code class="n">s</code><code class="p">)]</code> <code class="ow">-&gt;</code> <code class="n">s</code><code class="p">)</code> <code class="n">a</code>
<code class="linenos">54 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">putStrLn</code> <code class="s">"nothing"</code>
<code class="linenos">55 </code>  <code class="n">sq3</code> <code class="ow">&lt;-</code> <code class="n">selectQuery</code> <code class="s">"http://dbpedia.org/sparql"</code> <code class="n">webBrowserSelect</code>
<code class="linenos">56 </code>  <code class="c1">--putStrLn "\nRaw results of SPARQL query:\n"</code>
<code class="linenos">57 </code>  <code class="c1">--print sq3</code>
<code class="linenos">58 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">Web browser names extracted from the query results:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">59 </code>  <code class="kr">case</code> <code class="n">sq3</code> <code class="kr">of</code>
<code class="linenos">60 </code>    <code class="kt">Just</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">print</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">[</code><code class="kt">Bound</code> <code class="p">(</code><code class="kt">LNode</code> <code class="p">(</code><code class="kt">PlainLL</code> <code class="n">s</code> <code class="kr">_</code><code class="p">))]</code> <code class="ow">-&gt;</code> <code class="n">s</code><code class="p">)</code> <code class="n">a</code>
<code class="linenos">61 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">putStrLn</code> <code class="s">"nothing"</code>
</pre></div>

</figure>

<p><strong>Notes on matching result types of query results:</strong></p>

<p>You will notice how I have commented out print statements in the last example. When trying new queries you need to print out the results in order to know how to extract the wrapped query results. Let’s look at a few examples:</p>

<p>If we print the value for <strong>sq1</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Raw results of company abstract SPARQL query:

Just [[Bound (LNode (PlainLL "Edinburgh University Press ...
</pre></div>

</figure>

<p>we see that inside a <strong>Just</strong> we have a list of lists. Each inner list is a <strong>Bound</strong> wrapping types defined in HSparql. We would unwrap <strong>sq1</strong> using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="kr">case</code> <code class="n">sq1</code> <code class="kr">of</code>
<code class="linenos">2 </code>    <code class="kt">Just</code> <code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">print</code> <code class="o">$</code> <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">[</code><code class="kt">Bound</code> <code class="p">(</code><code class="kt">LNode</code> <code class="p">(</code><code class="kt">PlainLL</code> <code class="n">s</code> <code class="kr">_</code><code class="p">))]</code> <code class="ow">-&gt;</code> <code class="n">s</code><code class="p">)</code> <code class="n">a</code>
<code class="linenos">3 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">putStrLn</code> <code class="s">"nothing"</code>
</pre></div>

</figure>

<p>In a similar way I printed out the values of <strong>sq2</strong> and <strong>sq3</strong> to see the form os <strong>case</strong> statement I would need to unwrap them.</p>

<p>The output from this example with three queries to the DBPedia SPARQL endpoint is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">Web</code> <code class="n">browser</code> <code class="n">names</code> <code class="n">extracted</code> <code class="n">from</code> <code class="n">the</code> <code class="n">company</code> <code class="n">abstract</code> <code class="n">query</code> <code class="n">results</code> <code class="n">in</code> <code class="nl">sq1:</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">[</code><code class="s">"Edinburgh University Press </code><code class="se">\1</code><code class="s">95</code><code class="se">\16</code><code class="s">8 una casa editrice scientifica di libri accadem\</code>
<code class="linenos"> 4 </code><code class="s">ici e riviste, con sede a Edimburgo, in Scozia."</code><code class="p">,</code><code class="s">"Edinburgh University Press </code><code class="se">\1</code><code class="s">95</code><code class="se">\16</code><code class="s">\</code>
<code class="linenos"> 5 </code><code class="s">9 uma editora universit</code><code class="se">\1</code><code class="s">95</code><code class="se">\161</code><code class="s">ria com base em Edinburgh, Esc</code><code class="se">\1</code><code class="s">95</code><code class="se">\17</code><code class="s">9cia."</code><code class="p">,</code><code class="s">"Edinburg\</code>
<code class="linenos"> 6 </code><code class="s">h University Press is a scholarly publisher of academic books and journals, based in\</code>
<code class="linenos"> 7 </code><code class="s"> Edinburgh, Scotland."</code><code class="p">]</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">The</code> <code class="k">type</code> <code class="n">of</code> <code class="n">company</code> <code class="n">is</code> <code class="n">extracted</code> <code class="n">from</code> <code class="n">the</code> <code class="n">company</code> <code class="k">type</code> <code class="n">query</code> <code class="n">results</code> <code class="n">in</code> <code class="nl">sq2:</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">[</code><code class="s">"http://dbpedia.org/resource/Publishing"</code><code class="p">]</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">Web</code> <code class="n">browser</code> <code class="n">names</code> <code class="n">extracted</code> <code class="n">from</code> <code class="n">the</code> <code class="n">query</code> <code class="n">results</code> <code class="n">in</code> <code class="nl">sq3:</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="p">[</code><code class="s">"Grail"</code><code class="p">,</code><code class="s">"ViolaWWW"</code><code class="p">,</code><code class="s">"Kirix Strata"</code><code class="p">,</code><code class="s">"SharkWire Online"</code><code class="p">,</code><code class="s">"MacWeb"</code><code class="p">,</code><code class="s">"Camino"</code><code class="p">,</code><code class="s">"eww"</code><code class="p">,</code><code class="s">"TenFo\</code>
<code class="linenos">16 </code><code class="s">urFox"</code><code class="p">,</code><code class="s">"WiseStamp"</code><code class="p">,</code><code class="s">"X-Smiles"</code><code class="p">,</code><code class="s">"Netscape Navigator 2"</code><code class="p">,</code><code class="s">"SimpleTest"</code><code class="p">,</code><code class="s">"AWeb"</code><code class="p">,</code><code class="s">"IBrowse"</code><code class="p">,</code><code class="s">"\</code>
<code class="linenos">17 </code><code class="s">iCab"</code><code class="p">,</code><code class="s">"ANT Fresco"</code><code class="p">,</code><code class="s">"Netscape Navigator 9.0"</code><code class="p">,</code><code class="s">"HtmlUnit"</code><code class="p">,</code><code class="s">"ZAC Browser"</code><code class="p">,</code><code class="s">"ELinks"</code><code class="p">,</code><code class="s">"ANT G\</code>
<code class="linenos">18 </code><code class="s">alio"</code><code class="p">,</code><code class="s">"Nintendo DSi Browser"</code><code class="p">,</code><code class="s">"Nintendo DS Browser"</code><code class="p">,</code><code class="s">"Netscape Navigator"</code><code class="p">,</code><code class="s">"NetPositive\</code>
<code class="linenos">19 </code><code class="s">"</code><code class="p">,</code><code class="s">"OmniWeb"</code><code class="p">,</code><code class="s">"Abaco"</code><code class="p">,</code><code class="s">"Flock"</code><code class="p">,</code><code class="s">"Steel"</code><code class="p">,</code><code class="s">"Kazehakase"</code><code class="p">,</code><code class="s">"GNU IceCat"</code><code class="p">,</code><code class="s">"FreeWRL"</code><code class="p">,</code><code class="s">"UltraBrowse\</code>
<code class="linenos">20 </code><code class="s">r"</code><code class="p">,</code><code class="s">"AMosaic"</code><code class="p">,</code><code class="s">"NetCaptor"</code><code class="p">,</code><code class="s">"NetSurf"</code><code class="p">,</code><code class="s">"Netscape Browser"</code><code class="p">,</code><code class="s">"SlipKnot"</code><code class="p">,</code><code class="s">"ColorZilla"</code><code class="p">,</code><code class="s">"Inter\</code>
<code class="linenos">21 </code><code class="s">net Channel"</code><code class="p">,</code><code class="s">"Obigo Browser"</code><code class="p">,</code><code class="s">"Swiftfox"</code><code class="p">,</code><code class="s">"BumperCar"</code><code class="p">,</code><code class="s">"Swiftweasel"</code><code class="p">,</code><code class="s">"Swiftdove"</code><code class="p">,</code><code class="s">"IEs4L\</code>
<code class="linenos">22 </code><code class="s">inux"</code><code class="p">,</code><code class="s">"MacWWW"</code><code class="p">,</code><code class="s">"IBM Lotus Symphony"</code><code class="p">,</code><code class="s">"SlimBrowser"</code><code class="p">,</code><code class="s">"cURL"</code><code class="p">,</code><code class="s">"FoxyTunes"</code><code class="p">,</code><code class="s">"Iceweasel"</code><code class="p">,</code><code class="s">"Me\</code>
<code class="linenos">23 </code><code class="s">nuBox"</code><code class="p">,</code><code class="s">"Timberwolf web browser"</code><code class="p">,</code><code class="s">"Classilla"</code><code class="p">,</code><code class="s">"Rockmelt"</code><code class="p">,</code><code class="s">"Galeon"</code><code class="p">,</code><code class="s">"Links"</code><code class="p">,</code><code class="s">"Netscape Na\</code>
<code class="linenos">24 </code><code class="s">vigator"</code><code class="p">,</code><code class="s">"NCSA Mosaic"</code><code class="p">,</code><code class="s">"MidasWWW"</code><code class="p">,</code><code class="s">"w3m"</code><code class="p">,</code><code class="s">"PointerWare"</code><code class="p">,</code><code class="s">"Pogo Browser"</code><code class="p">,</code><code class="s">"Oregano"</code><code class="p">,</code><code class="s">"Avan\</code>
<code class="linenos">25 </code><code class="s">t Browser"</code><code class="p">,</code><code class="s">"Wget"</code><code class="p">,</code><code class="s">"NeoPlanet"</code><code class="p">,</code><code class="s">"Voyager"</code><code class="p">,</code><code class="s">"Amaya"</code><code class="p">,</code><code class="s">"Midori"</code><code class="p">,</code><code class="s">"Sleipnir"</code><code class="p">,</code><code class="s">"Tor"</code><code class="p">,</code><code class="s">"AOL Explo\</code>
<code class="linenos">26 </code><code class="s">rer"</code><code class="p">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-linked-data-and-semantic-web-wrap-up">Linked Data and Semantic Web Wrap Up</h3>

<p>If you enjoyed the material on linked data and DBPedia then please do get a free copy of one of my semantic web books <a href="http://www.markwatson.com/books/">on my website book page</a> as well as other SPARQL and linked data tutorials on the web.</p>

<p>Structured and sematically labelled data, when it is available, is much easier to process and use effectively than raw text and HTML collected from web sites.</p>


<h2 id="leanpub-auto-web-scraping">Web Scraping</h2>

<p>In my past work I usually used the Ruby scripting language for web scraping but as I use the Haskell language more often for projects both large and small I am now using Haskell for web scraping, data collection, and data cleaning tasks. If you worked through the tutorial chapter on impure Haskell programming then you already know most of what you need to understand this chapter. Here we will walk through a few short examples for common web scraping tasks.</p>

<p>Before we start a tutorial about web scraping I want to point out that much of the information on the web is copyright and the first thing that you should do is to read the terms of service for web sites to insure that your use of web scraped data conforms with the wishes of the persons or organizations who own the content and pay to run scraped web sites.</p>

<p>As we saw in the last chapter on linked data there is a huge amount of structured data available on the web via web services, semantic web/linked data markup, and APIs. That said, you will frequently find text (usually HTML) that is useful on web sites. However, this text is often at least partially unstructured and in a messy and frequently changing format because web pages are meant for human consumption and making them easy to parse and use by software agents is not a priority of web site owners.</p>

<p><strong>Note:</strong> It takes a while to fetch all of the libraries in the directory <em>WebScraping</em> so please do a <strong>stack build</strong> now to get these examples ready to experiment with while you read this chapter.</p>

<h3 id="leanpub-auto-using-the-wreq-library">Using the Wreq Library</h3>

<p>The <a href="http://www.serpentine.com/wreq/tutorial.html"><em>Wreq</em> library</a> is an easy way to fetch data from the web. The example in this section fetches DBPedia (i.e., the semantic web version of Wikipedia) data in JSON and RDF N3 formats, and also fetches the index page from my web site. I will introduce you to the <em>Lens</em> library for extracting data from data structures, and we will also use <em>Lens</em> in a later chapter when writing a program to play Backjack.</p>

<p>We will be using function <strong>get</strong> in the <strong>Network.Wreq</strong> module that has a type signature:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">get</code>
  <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="p">(</code><code class="kt">Response</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">ByteString</code><code class="o">.</code><code class="kt">Lazy</code><code class="o">.</code><code class="kt">Internal</code><code class="o">.</code><code class="kt">ByteString</code><code class="p">)</code>
</pre></div>

</figure>

<p>We will be using the <strong>OverloadedStrings</strong> language extension to facilitate using both <strong>[Char]</strong> strings and <strong>ByteString</strong> data types. Note: In the GHCi repl you can use <strong>:set -XOverloadedStrings</strong>.</p>

<p>We use function <strong>get</strong> to return JSON data; here is a bit of the JSON data returned from calling <strong>get</strong> using the URI for my web site:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kt">Response</code> <code class="p">{</code><code class="n">responseStatus</code> <code class="ow">=</code> <code class="kt">Status</code> <code class="p">{</code><code class="n">statusCode</code> <code class="ow">=</code> <code class="mi">200</code><code class="p">,</code> <code class="n">statusMessage</code> <code class="ow">=</code> <code class="s">"OK"</code><code class="p">},</code>
          <code class="n">responseVersion</code> <code class="ow">=</code> <code class="kt">HTTP</code><code class="o">/</code><code class="mf">1.1</code><code class="p">,</code>
          <code class="n">responseHeaders</code> <code class="ow">=</code>
		    <code class="p">[(</code><code class="s">"Date"</code><code class="p">,</code><code class="s">"Sat, 15 Oct 2016 16:00:59 GMT"</code><code class="p">),</code>
		     <code class="p">(</code><code class="s">"Content-Type"</code><code class="p">,</code><code class="s">"text/html"</code><code class="p">),</code>
             <code class="p">(</code><code class="s">"Transfer-Encoding"</code><code class="p">,</code><code class="s">"chunked"</code><code class="p">),</code>
             <code class="p">(</code><code class="s">"Connection"</code><code class="p">,</code><code class="s">"keep-alive"</code><code class="p">)],</code>
          <code class="n">responseBody</code> <code class="ow">=</code> <code class="s">"&lt;!DOCTYPE html&gt;</code><code class="se">\r\n</code><code class="s">&lt;html&gt;</code><code class="se">\r\n</code><code class="s">&lt;head&gt;&lt;title&gt;Mark Watson: con</code><code class="se">\</code>
<code class="nf">sultant</code> <code class="n">specializing</code> <code class="kr">in</code> <code class="n">artificial</code> <code class="n">intelligence</code><code class="p">,</code> <code class="n">natural</code> <code class="n">language</code> <code class="n">processing</code><code class="p">,</code> <code class="n">and</code> <code class="n">ma</code><code class="nf">\</code>
<code class="nf">chine\</code><code class="n">r</code><code class="nf">\</code><code class="n">n</code>    <code class="n">learning</code><code class="o">&lt;/</code><code class="n">title</code><code class="o">&gt;\</code><code class="n">r</code><code class="nf">\</code><code class="n">n</code>    <code class="o">&lt;</code><code class="n">meta</code> <code class="n">name</code><code class="o">=\</code><code class="s">"viewport</code><code class="se">\"</code><code class="s"> content=</code><code class="se">\"</code><code class="s">width=device-</code><code class="se">\</code>
<code class="nf">width</code><code class="p">,</code> <code class="n">initial</code><code class="o">-</code><code class="n">scale</code><code class="ow">=</code><code class="mf">1.0</code><code class="nf">\</code><code class="s">"&gt;</code><code class="se">\r\n</code><code class="s">    &lt;meta name=</code><code class="se">\"</code><code class="s">msvalidate.01</code><code class="se">\"</code><code class="s"> content=</code><code class="se">\"</code><code class="s">D980F894E9</code><code class="se">\</code>
<code class="mi">4</code><code class="kt">AA6335FB595676DFDD5E6</code><code class="nf">\</code><code class="s">"/&gt;</code><code class="se">\r\n</code><code class="s">    &lt;link href=</code><code class="se">\"</code><code class="s">/css/bootstrap.min.css</code><code class="se">\"</code><code class="s"> rel=</code><code class="se">\"</code><code class="s">styles</code><code class="se">\</code>
<code class="nf">heet\</code><code class="s">" type=</code><code class="se">\"</code><code class="s">text/css</code><code class="se">\"</code><code class="s">&gt;</code><code class="se">\r\n</code><code class="s">    &lt;link href=</code><code class="se">\"</code><code class="s">/css/bootstrap-theme.min.css</code><code class="se">\"</code><code class="s"> rel=</code><code class="se">\"</code><code class="s">s</code><code class="se">\</code>
<code class="nf">tylesheet\</code><code class="s">" type=</code><code class="se">\"</code><code class="s">text/css</code><code class="se">\"</code><code class="s">&gt;</code><code class="se">\r\n</code><code class="s">    &lt;link href=</code><code class="se">\"</code><code class="s">/css/mark.css</code><code class="se">\"</code><code class="s"> rel=</code><code class="se">\"</code><code class="s">stylesheet</code><code class="se">\\</code><code class="s"></code>
<code class="s">"</code> <code class="kr">type</code><code class="o">=\</code><code class="s">"text/css</code><code class="se">\"</code><code class="s">&gt;</code><code class="se">\r\n</code><code class="s">    &lt;link rel=</code><code class="se">\"</code><code class="s">manifest</code><code class="se">\"</code><code class="s"> href=</code><code class="se">\"</code><code class="s">/manifest.json</code><code class="se">\"</code><code class="s">&gt;</code><code class="se">\r\n</code><code class="s">    &lt;</code><code class="se">\</code>
<code class="nf">style</code> <code class="kr">type</code><code class="o">=\</code><code class="s">"text/css</code><code class="se">\"</code><code class="s">&gt;</code>
<code class="s">          body {</code><code class="se">\r\n</code><code class="s">        padding-top: 60px;</code><code class="se">\r\n</code><code class="s">    }&lt;/style&gt;</code><code class="se">\r\n\r\n</code><code class="s">    &lt;link rel</code><code class="se">\</code>
<code class="o">=\</code><code class="s">"canonical</code><code class="se">\"</code><code class="s"> href=https://www.markwatson.com/ /&gt;</code><code class="se">\r\n</code><code class="s">&lt;/head&gt;</code><code class="se">\r\n</code><code class="s">&lt;body  href=</code><code class="se">\"</code><code class="s">http:</code><code class="se">\</code>
<code class="o">//</code><code class="n">blog</code><code class="o">.</code><code class="n">markwatson</code><code class="o">.</code><code class="n">com</code><code class="nf">\</code><code class="s">"&gt;Blog&lt;/a&gt;&lt;/li&gt;</code><code class="se">\r\n</code><code class="s"></code>
<code class="s">          &lt;li class=</code><code class="se">\"\"</code><code class="s">&gt;&lt;a href=</code><code class="se">\"</code><code class="s">/books/</code><code class="se">\"</code><code class="s">&gt;My Books&lt;/a&gt;</code>
</pre></div>

</figure>

<p>As an example, the <em>Lens</em> expression for extracting the response status code is (<strong>r</strong> is the <strong>IO</strong> <strong>Response</strong> data returned from calling <strong>get</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="n">r</code> <code class="o">^.</code> <code class="n">responseStatus</code> <code class="o">.</code> <code class="n">statusCode</code><code class="p">)</code>
</pre></div>

</figure>

<p><strong>responseStatus</strong> digs into the top level response structure and <strong>statusCode</strong> digs further in to fetch the code 200. To get the actual contents of the web page we can use the <strong>responseBody</strong> function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="n">r</code> <code class="o">^.</code> <code class="n">responseBody</code><code class="p">)</code>
</pre></div>

</figure>

<p>Here is the code for the entire example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">-- reference: http://www.serpentine.com/wreq/tutorial.html</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kr">module</code> <code class="nn">HttpClientExample</code> <code class="kr">where</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">Network.Wreq</code>
<code class="linenos"> 8 </code><code class="kr">import</code> <code class="nn">Control.Lens</code>  <code class="c1">-- for ^. ^?</code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromJust</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="nf">fetchURI</code> <code class="n">uri</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">12 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"</code><code class="se">\n\n</code><code class="s">***  Fetching "</code> <code class="o">++</code> <code class="n">uri</code>
<code class="linenos">13 </code>  <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">get</code> <code class="n">uri</code>
<code class="linenos">14 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"status code: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">r</code> <code class="o">^.</code> <code class="n">responseStatus</code> <code class="o">.</code> <code class="n">statusCode</code><code class="p">))</code>
<code class="linenos">15 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"content type: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseHeader</code> <code class="s">"Content-Type"</code><code class="p">))</code>
<code class="linenos">16 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"respose body: "</code> <code class="o">++</code> <code class="n">show</code> <code class="p">(</code><code class="n">fromJust</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseBody</code><code class="p">))</code>
<code class="linenos">17 </code>  
<code class="linenos">18 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">19 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">20 </code>  <code class="c1">-- JSON from DBPedia</code>
<code class="linenos">21 </code>  <code class="n">fetchURI</code> <code class="s">"http://dbpedia.org/data/Sedona_Arizona.json"</code>
<code class="linenos">22 </code>  <code class="c1">-- N3 RDF from DBPedia</code>
<code class="linenos">23 </code>  <code class="n">fetchURI</code> <code class="s">"http://dbpedia.org/data/Sedona_Arizona.n3"</code>
<code class="linenos">24 </code>  <code class="c1">-- my web site</code>
<code class="linenos">25 </code>  <code class="n">fetchURI</code> <code class="s">"http://markwatson.com"</code>
</pre></div>

</figure>

<p>This example produces a lot of printout, so I a just showing a small bit here (the text from the body is not shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">HttpClientExample</code>
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">HttpClientExample</code> <code class="p">(</code> <code class="kt">HttpClientExample</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">HttpClientExample</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">HttpClientExample</code><code class="o">&gt;</code> <code class="n">main</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="o">***</code>  <code class="kt">Fetching</code> <code class="n">http</code><code class="kt">://</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="kr">data</code><code class="o">/</code><code class="kt">Sedona_Arizona</code><code class="o">.</code><code class="n">json</code>
<code class="linenos"> 7 </code><code class="nf">status</code> <code class="n">code</code><code class="kt">:</code> <code class="mi">200</code>
<code class="linenos"> 8 </code><code class="nf">content</code> <code class="kr">type</code><code class="kt">:</code> <code class="kt">Just</code> <code class="s">"application/json"</code>
<code class="linenos"> 9 </code><code class="nf">respose</code> <code class="n">body</code><code class="kt">:</code> <code class="s">"{</code><code class="se">\n</code><code class="s">  </code><code class="se">\"</code><code class="s">http://en.wikipedia.org/wiki/Sedona_Arizona</code><code class="se">\"</code><code class="s"> : { </code><code class="se">\"</code><code class="s">http://xml</code><code class="se">\</code>
<code class="linenos">10 </code><code class="nf">ns</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="n">foaf</code><code class="o">/</code><code class="mf">0.1</code><code class="o">/</code><code class="n">primaryTopic</code><code class="nf">\</code><code class="s">" : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">uri</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">value</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">http://dbpedi</code><code class="se">\</code>
<code class="linenos">11 </code><code class="nf">a</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">resource</code><code class="o">/</code><code class="kt">Sedona_Arizona</code><code class="nf">\</code><code class="s">" } ] } ,</code><code class="se">\n</code><code class="s">  </code><code class="se">\"</code><code class="s">http://dbpedia.org/resource/Sedona_Ariz</code><code class="se">\</code>
<code class="linenos">12 </code><code class="nf">ona\</code><code class="s">" : { </code><code class="se">\"</code><code class="s">http://www.w3.org/2002/07/owl#sameAs</code><code class="se">\"</code><code class="s"> : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">uri</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">value</code><code class="se">\</code>
<code class="linenos">13 </code><code class="se">\</code><code class="s">"</code> <code class="kt">:</code> <code class="nf">\</code><code class="s">"http://dbpedia.org/resource/Sedona_Arizona</code><code class="se">\"</code><code class="s"> } ] ,</code><code class="se">\n</code><code class="s">    </code><code class="se">\"</code><code class="s">http://www.w3.org/2</code><code class="se">\</code>
<code class="linenos">14 </code><code class="mi">000</code><code class="o">/</code><code class="mi">01</code><code class="o">/</code><code class="n">rdf</code><code class="o">-</code><code class="n">schema</code><code class="o">#</code><code class="n">label</code><code class="nf">\</code><code class="s">" : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">literal</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">value</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">Sedona Arizona</code><code class="se">\</code>
<code class="linenos">15 </code><code class="se">\</code><code class="s">"</code> <code class="p">,</code> <code class="nf">\</code><code class="s">"lang</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">en</code><code class="se">\"</code><code class="s"> } ] ,</code><code class="se">\n</code><code class="s">    </code><code class="se">\"</code><code class="s">http://xmlns.com/foaf/0.1/isPrimaryTopicOf</code><code class="se">\"</code><code class="s"> : [</code><code class="se">\</code>
<code class="linenos">16 </code> <code class="p">{</code> <code class="nf">\</code><code class="s">"type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">uri</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">value</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">http://en.wikipedia.org/wiki/Sedona_Arizona</code><code class="se">\"</code><code class="s"> }</code><code class="se">\</code>
<code class="linenos">17 </code> <code class="p">]</code> <code class="p">,</code><code class="nf">\</code><code class="n">n</code>    <code class="nf">\</code><code class="s">"http://www.w3.org/ns/prov#wasDerivedFrom</code><code class="se">\"</code><code class="s"> : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">uri</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">v</code><code class="se">\</code>
<code class="linenos">18 </code><code class="nf">alue\</code><code class="s">" : </code><code class="se">\"</code><code class="s">http://en.wikipedia.org/wiki/Sedona_Arizona?oldid=345939723</code><code class="se">\"</code><code class="s"> } ] ,</code><code class="se">\n</code><code class="s">    </code><code class="se">\</code>
<code class="linenos">19 </code><code class="se">\</code><code class="s">"</code><code class="n">http</code><code class="kt">://</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ontology</code><code class="o">/</code><code class="n">wikiPageID</code><code class="nf">\</code><code class="s">" : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">literal</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">value</code><code class="se">\"</code><code class="s"> :</code><code class="se">\</code>
<code class="linenos">20 </code> <code class="mi">11034313</code> <code class="p">,</code> <code class="nf">\</code><code class="s">"datatype</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">http://www.w3.org/2001/XMLSchema#integer</code><code class="se">\"</code><code class="s"> } ] ,</code><code class="se">\n</code><code class="s">    </code><code class="se">\\</code><code class="s"></code>
<code class="linenos">21 </code><code class="s">"</code><code class="n">http</code><code class="kt">://</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ontology</code><code class="o">/</code><code class="n">wikiPageRevisionID</code><code class="nf">\</code><code class="s">" : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">literal</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">va</code><code class="se">\</code>
<code class="linenos">22 </code><code class="nf">lue\</code><code class="s">" : 345939723 , </code><code class="se">\"</code><code class="s">datatype</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">http://www.w3.org/2001/XMLSchema#integer</code><code class="se">\"</code><code class="s"> } ] </code><code class="se">\</code>
<code class="linenos">23 </code><code class="p">,</code><code class="nf">\</code><code class="n">n</code>    <code class="nf">\</code><code class="s">"http://dbpedia.org/ontology/wikiPageRedirects</code><code class="se">\"</code><code class="s"> : [ { </code><code class="se">\"</code><code class="s">type</code><code class="se">\"</code><code class="s"> : </code><code class="se">\"</code><code class="s">uri</code><code class="se">\"</code><code class="s">, </code><code class="se">\\</code><code class="s"></code>
<code class="linenos">24 </code><code class="s">"</code><code class="n">value</code><code class="nf">\</code><code class="s">" : </code><code class="se">\"</code><code class="s">http://dbpedia.org/resource/Sedona,_Arizona</code><code class="se">\"</code><code class="s"> } ] }</code><code class="se">\n</code><code class="s">}</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="o">***</code>  <code class="kt">Fetching</code> <code class="n">http</code><code class="kt">://</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="kr">data</code><code class="o">/</code><code class="kt">Sedona_Arizona</code><code class="o">.</code><code class="n">n3</code>
<code class="linenos">27 </code><code class="nf">status</code> <code class="n">code</code><code class="kt">:</code> <code class="mi">200</code>
<code class="linenos">28 </code><code class="nf">content</code> <code class="kr">type</code><code class="kt">:</code> <code class="kt">Just</code> <code class="s">"text/n3; charset=UTF-8"</code>
<code class="linenos">29 </code><code class="nf">respose</code> <code class="n">body</code><code class="kt">:</code> <code class="s">"@prefix foaf:</code><code class="se">\t</code><code class="s">&lt;http://xmlns.com/foaf/0.1/&gt; .</code><code class="se">\n</code><code class="s">@prefix wikipedia-en:</code><code class="se">\\</code><code class="s"></code>
<code class="linenos">30 </code><code class="s">t&lt;http://en.wikipedia.org/wiki/&gt; .</code><code class="se">\n</code><code class="s">@prefix dbr:</code><code class="se">\t</code><code class="s">&lt;http://dbpedia.org/resource/&gt; .</code><code class="se">\n\</code>
<code class="linenos">31 </code><code class="nf">wikipedia</code><code class="o">-</code><code class="n">en</code><code class="kt">:Sedona_Arizona</code><code class="nf">\</code><code class="n">tfoaf</code><code class="kt">:</code><code class="n">primaryTopic</code><code class="nf">\</code><code class="n">tdbr</code><code class="kt">:Sedona_Arizona</code> <code class="o">.\</code><code class="n">n</code><code class="o">@</code><code class="n">prefix</code> <code class="n">owl</code><code class="kt">:\</code><code class="n">t</code><code class="nf">\</code>
<code class="linenos">32 </code><code class="o">&lt;</code><code class="n">http</code><code class="kt">://</code><code class="n">www</code><code class="o">.</code><code class="n">w3</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="mi">2002</code><code class="o">/</code><code class="mi">07</code><code class="o">/</code><code class="n">owl</code><code class="o">#&gt;</code> <code class="o">.\</code><code class="n">ndbr</code><code class="kt">:Sedona_Arizona</code><code class="nf">\</code><code class="n">towl</code><code class="kt">:</code><code class="n">sameAs</code><code class="nf">\</code><code class="n">tdbr</code><code class="kt">:Sedona_Arizo</code><code class="nf">\</code>
<code class="linenos">33 </code><code class="nf">na</code> <code class="o">.\</code><code class="n">n</code><code class="o">@</code><code class="n">prefix</code> <code class="n">rdfs</code><code class="kt">:\</code><code class="n">t</code><code class="o">&lt;</code><code class="n">http</code><code class="kt">://</code><code class="n">www</code><code class="o">.</code><code class="n">w3</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="mi">2000</code><code class="o">/</code><code class="mi">01</code><code class="o">/</code><code class="n">rdf</code><code class="o">-</code><code class="n">schema</code><code class="o">#&gt;</code> <code class="o">.\</code><code class="n">ndbr</code><code class="kt">:Sedona_Arizona</code><code class="nf">\</code><code class="n">t</code><code class="nf">\</code>
<code class="linenos">34 </code><code class="nf">rdfs</code><code class="kt">:</code><code class="n">label</code><code class="nf">\</code><code class="n">t</code><code class="nf">\</code><code class="s">"Sedona Arizona</code><code class="se">\"</code><code class="s">@en ;</code><code class="se">\n\t</code><code class="s">foaf:isPrimaryTopicOf</code><code class="se">\t</code><code class="s">wikipedia-en:Sedona_Ar</code><code class="se">\</code>
<code class="linenos">35 </code><code class="nf">izona</code> <code class="o">.\</code><code class="n">n</code><code class="o">@</code><code class="n">prefix</code> <code class="n">prov</code><code class="kt">:\</code><code class="n">t</code><code class="o">&lt;</code><code class="n">http</code><code class="kt">://</code><code class="n">www</code><code class="o">.</code><code class="n">w3</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ns</code><code class="o">/</code><code class="n">prov</code><code class="o">#&gt;</code> <code class="o">.\</code><code class="n">ndbr</code><code class="kt">:Sedona_Arizona</code><code class="nf">\</code><code class="n">tprov</code><code class="kt">:</code><code class="n">was</code><code class="nf">\</code>
<code class="linenos">36 </code><code class="kt">DerivedFrom</code><code class="nf">\</code><code class="n">t</code><code class="o">&lt;</code><code class="n">http</code><code class="kt">://</code><code class="n">en</code><code class="o">.</code><code class="n">wikipedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">wiki</code><code class="o">/</code><code class="kt">Sedona_Arizona</code><code class="o">?</code><code class="n">oldid</code><code class="ow">=</code><code class="mi">345939723</code><code class="o">&gt;</code> <code class="o">.\</code><code class="n">n</code><code class="o">@</code><code class="n">prefi</code><code class="nf">\</code>
<code class="linenos">37 </code><code class="nf">x</code> <code class="n">dbo</code><code class="kt">:\</code><code class="n">t</code><code class="o">&lt;</code><code class="n">http</code><code class="kt">://</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">ontology</code><code class="o">/&gt;</code> <code class="o">.\</code><code class="n">ndbr</code><code class="kt">:Sedona_Arizona</code><code class="nf">\</code><code class="n">tdbo</code><code class="kt">:</code><code class="n">wikiPageID</code><code class="nf">\</code><code class="n">t110343</code><code class="nf">\</code>
<code class="linenos">38 </code><code class="mi">13</code> <code class="p">;</code><code class="nf">\</code><code class="n">n</code><code class="nf">\</code><code class="n">tdbo</code><code class="kt">:</code><code class="n">wikiPageRevisionID</code><code class="nf">\</code><code class="n">t345939723</code> <code class="p">;</code><code class="nf">\</code><code class="n">n</code><code class="nf">\</code><code class="n">tdbo</code><code class="kt">:</code><code class="n">wikiPageRedirects</code><code class="nf">\</code><code class="n">t</code><code class="o">&lt;</code><code class="n">http</code><code class="kt">://</code><code class="n">dbpedi</code><code class="nf">\</code>
<code class="linenos">39 </code><code class="nf">a</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">resource</code><code class="o">/</code><code class="kt">Sedona</code><code class="p">,</code><code class="n">_Arizona</code><code class="o">&gt;</code> <code class="o">.</code><code class="s">"</code>
<code class="linenos">40 </code>
<code class="linenos">41 </code><code class="s">***  Fetching http://markwatson.com</code>
<code class="linenos">42 </code><code class="s">status code: 200</code>
<code class="linenos">43 </code><code class="s">content type: Just "</code><code class="n">text</code><code class="o">/</code><code class="n">html</code><code class="s">"</code>
<code class="linenos">44 </code><code class="s">respose body: "</code><code class="o">&lt;!</code><code class="kt">DOCTYPE</code> <code class="n">html</code><code class="o">&gt;\</code><code class="n">r</code><code class="nf">\</code><code class="n">n</code><code class="o">&lt;</code><code class="n">html</code><code class="o">&gt;\</code><code class="n">r</code><code class="nf">\</code><code class="n">n</code><code class="o">&lt;</code><code class="n">head</code><code class="o">&gt;&lt;</code><code class="n">title</code><code class="o">&gt;</code><code class="kt">Mark</code> <code class="kt">Watson:</code> <code class="n">consultant</code> <code class="n">spe</code><code class="nf">\</code>
<code class="linenos">45 </code><code class="nf">cializing</code> <code class="kr">in</code>  <code class="o">...</code>
</pre></div>

</figure>

<p>You might want to experiment in the GHCi repl with the <strong>get</strong> function and <em>Lens</em>. If so, this will get you started:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">set</code> <code class="o">-</code><code class="kt">XOverloadedStrings</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">get</code> <code class="s">"http://dbpedia.org/data/Sedona_Arizona.json"</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">r</code>
<code class="nf">r</code> <code class="ow">::</code> <code class="kt">Response</code> <code class="kt">ByteString</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="n">r</code> <code class="o">^.</code> <code class="n">responseStatus</code> <code class="o">.</code> <code class="n">statusCode</code><code class="p">)</code>
<code class="mi">200</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseHeader</code> <code class="s">"Content-Type"</code><code class="p">)</code>
<code class="kt">Just</code> <code class="s">"application/json"</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="n">fromJust</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseHeader</code> <code class="s">"Content-Type"</code><code class="p">)</code>
<code class="s">"application/json"</code>
<code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="p">(</code><code class="n">fromJust</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseBody</code><code class="p">))</code>
<code class="s">"{</code><code class="se">\n</code><code class="s">  </code><code class="se">\"</code><code class="s">http://en.wikipedia.org/wiki/Sedona_Arizona</code><code class="se">\"</code><code class="s"> : { ... not shown ... </code><code class="se">\"</code><code class="s"></code>
</pre></div>

</figure>

<p>In the following section we will use the <em>HandsomeSoup</em> library for parsing HTML.</p>

<h3 id="leanpub-auto-using-the-handsomesoup-library-for-parsing-html">Using the <strong>HandsomeSoup</strong> Library for Parsing HTML</h3>

<p>We will now use the <a href="https://github.com/egonSchiele/HandsomeSoup">Handsome Soup</a> library to parse HTML. Handsome Soup allows us to use CSS style selectors to extract specific elements from the HTML from a web page. The HXT lower level library provides modeling HTML (and XML) as a tree structure and an <a href="https://wiki.haskell.org/Arrow"><em>Arrow</em></a> style interface for traversing the tree structures and extract data. Arrows are a generalization of monads to manage calculations given a context. I will touch upon just enough material on Arrows for you to understand the examples in this chapter. Handsome Soup also provides a high level utility function <strong>fromUrl</strong> to fetch web pages; the type of <strong>fromUrl</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">fromUrl</code>
  <code class="ow">::</code> <code class="kt">String</code> <code class="ow">-&gt;</code> <code class="kt">IOSArrow</code> <code class="n">b</code> <code class="p">(</code><code class="kt">Data</code><code class="o">.</code><code class="kt">Tree</code><code class="o">.</code><code class="kt">NTree</code><code class="o">.</code><code class="kt">TypeDefs</code><code class="o">.</code><code class="kt">NTree</code> <code class="kt">XNode</code><code class="p">)</code>
</pre></div>

</figure>

<p>We will not work directly with the tree structure of the returned data, we will simply use the accessor functions to extract the data we need. Before looking at the example code listing, let’s look at this extraction process (<strong>doc</strong> is the tree structured data returned from calling <strong>fromUrl</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">links</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"a"</code> <code class="o">!</code> <code class="s">"href"</code>
</pre></div>

</figure>

<p>The <strong>runX</strong> function runs arrow computations for us. <strong>doc</strong> is a tree data structure, <strong>css</strong> allows us to pattern match on specific HTML elements.</p>

<p>Here we are using CSS style selection for all “a” anchor HTML elements and digging into the element to return the element attribute “href” value for each “a” anchor element. In a similar way, we can select all “img” image elements and dig down into the matched elements to fetch the “src” attributes:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">imageSrc</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"img"</code> <code class="o">!</code> <code class="s">"src"</code>
</pre></div>

</figure>

<p>We can get the full body text:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">allBodyText</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"body"</code> <code class="o">//&gt;</code> <code class="n">getText</code>
</pre></div>

</figure>

<p>The operator <strong>//&gt;</strong> applied to the function <strong>getText</strong> will get all text in all nested elements inside the <em>body</em> element. If we had used the operator <strong>/&gt;</strong> then we would only have fetched the text at the top level of the body element.</p>

<p>Here is the full example source listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">-- references: https://github.com/egonSchiele/HandsomeSoup</code>
<code class="linenos"> 4 </code><code class="c1">--             http://adit.io/posts/2012-04-14-working_with_HTML_in_haskell.html</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="kr">import</code> <code class="nn">Text.XML.HXT.Core</code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="nn">Text.HandsomeSoup</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">13 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">14 </code>  <code class="kr">let</code> <code class="n">doc</code> <code class="ow">=</code> <code class="n">fromUrl</code> <code class="s">"http://markwatson.com/"</code>
<code class="linenos">15 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n\n</code><code class="s"> ** LINKS:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">16 </code>  <code class="n">links</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"a"</code> <code class="o">!</code> <code class="s">"href"</code>
<code class="linenos">17 </code>  <code class="n">mapM_</code> <code class="n">putStrLn</code> <code class="n">links</code>
<code class="linenos">18 </code>  <code class="n">h2</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"h2"</code> <code class="o">!</code> <code class="s">"href"</code>
<code class="linenos">19 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n\n</code><code class="s"> ** ALL H2 ELEMENTS::</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">20 </code>  <code class="n">mapM_</code> <code class="n">putStrLn</code> <code class="n">h2</code>
<code class="linenos">21 </code>  <code class="n">imageSrc</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"img"</code> <code class="o">!</code> <code class="s">"src"</code>
<code class="linenos">22 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n\n</code><code class="s"> ** ALL IMG ELEMENTS:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">23 </code>  <code class="n">mapM_</code> <code class="n">putStrLn</code> <code class="n">imageSrc</code>
<code class="linenos">24 </code>  <code class="n">allBodyText</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"body"</code> <code class="o">//&gt;</code> <code class="n">getText</code>
<code class="linenos">25 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n\n</code><code class="s"> ** TEXT FROM BODY ELEMENT:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">26 </code>  <code class="n">mapM_</code> <code class="n">putStrLn</code> <code class="n">allBodyText</code>
<code class="linenos">27 </code>  <code class="n">pText</code> <code class="ow">&lt;-</code> <code class="n">runX</code> <code class="o">$</code> <code class="n">doc</code> <code class="o">&gt;&gt;&gt;</code> <code class="n">css</code> <code class="s">"p"</code> <code class="o">//&gt;</code> <code class="n">getText</code> <code class="c1">-- //&gt; gets all contained text</code>
<code class="linenos">28 </code>                                              <code class="c1">-- /&gt;  gets only directly</code>
<code class="linenos">29 </code>                                              <code class="c1">--     contained text</code>
<code class="linenos">30 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n\n</code><code class="s"> ** ALL P ELEMENTS:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">31 </code>  <code class="n">mapM_</code> <code class="n">putStrLn</code> <code class="n">pText</code>
</pre></div>

</figure>

<p>This example prints out several hundred lines; here is the first bit of output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="kt">Main</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">HandsomeSoupTest</code><code class="o">.</code><code class="n">hs</code> 
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">HandsomeSoupTest</code> <code class="p">(</code> <code class="kt">HandsomeSoupTest</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">HandsomeSoupTest</code><code class="o">.</code>
<code class="o">*</code><code class="kt">HandsomeSoupTest</code><code class="o">&gt;</code> <code class="n">main</code>
 <code class="o">**</code> <code class="kt">LINKS:</code>
<code class="o">/</code>
<code class="o">/</code><code class="n">consulting</code><code class="o">/</code>
<code class="nf">http</code><code class="kt">://</code><code class="n">blog</code><code class="o">.</code><code class="n">markwatson</code><code class="o">.</code><code class="n">com</code>
<code class="o">/</code><code class="n">books</code><code class="o">/</code>
<code class="o">/</code><code class="n">opensource</code><code class="o">/</code>
<code class="o">/</code><code class="n">fun</code><code class="o">/</code>
<code class="nf">https</code><code class="kt">://</code><code class="n">github</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="n">mark</code><code class="o">-</code><code class="n">watson</code>
<code class="nf">https</code><code class="kt">://</code><code class="n">plus</code><code class="o">.</code><code class="n">google</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="mi">117612439870300277560</code>
<code class="nf">https</code><code class="kt">://</code><code class="n">twitter</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="n">mark_l_watson</code>
<code class="nf">https</code><code class="kt">://</code><code class="n">www</code><code class="o">.</code><code class="n">wikidata</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">wiki</code><code class="o">/</code><code class="kt">Q18670263</code>
<code class="nf">http</code><code class="kt">://</code><code class="n">markwatson</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="n">index</code><code class="o">.</code><code class="n">rdf</code>
<code class="nf">http</code><code class="kt">://</code><code class="n">markwatson</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="n">index</code><code class="o">.</code><code class="n">ttl</code>

 <code class="o">**</code> <code class="kt">ALL</code> <code class="kt">IMG</code> <code class="kt">ELEMENTS:</code>
<code class="o">/</code><code class="n">pictures</code><code class="o">/</code><code class="kt">Markws</code><code class="o">.</code><code class="n">jpg</code>

 <code class="o">**</code> <code class="kt">TEXT</code> <code class="kt">FROM</code> <code class="kt">BODY</code> <code class="kt">ELEMENT:</code>
   <code class="o">...</code>
</pre></div>

</figure>

<p>I find HandsomeSoup to be very convenient for picking apart HTML data fetched from web pages. Writing a good spider for any given web site is a process of understanding how the HTML for the web site is structured and what information you need to collect. I strongly suggest that you work with the web page to be spider open in a web browser with “show source code” in another browser tab. Then open an interactive GHCi repl and experiment using the HandsomeSoup APIs to get the data you need.</p>

<h3 id="leanpub-auto-web-scraping-wrap-up">Web Scraping Wrap Up</h3>

<p>There are many Haskell library options for web scraping and cleaning data. In this chapter I showed you just what I use in my projects.</p>

<p>The material in this chapter and the chapters on text processing and linked data should be sufficient to get you started using online data sources in your applications.</p>


<h2 id="leanpub-auto-using-relational-databases">Using Relational Databases</h2>

<p>We will see how to use popular libraries for accessing the <em>sqlite</em> and <em>Postgres</em> (sometimes also called <em>PostgeSQL</em>) databases in this chapter. I assume that you are already familiar with <em>SQL</em>.</p>

<h3 id="leanpub-auto-database-access-for-sqlite">Database Access for Sqlite</h3>

<p>We will use the <a href="https://hackage.haskell.org/package/sqlite-simple">sqlite-simple</a> library in this section to access Sqlite databases and use the similar library <a href="https://hackage.haskell.org/package/postgresql-simple">postgresql-simple</a> in the next section for use with Postgres.</p>

<p>There are other good libraries for database connectivity like <a href="https://www.stackage.org/package/persistent">Persistent</a> but I like sqlite-simple and it has a gentle learning curve so that is what we will use here. You will learn the basics of database connectivity in this and the next section. Setting up and using <em>sqlite</em> is easy because the <em>sqlite-simple</em> library includes the compiled code for <em>sqlite</em> so configuration requires only the file path to the database file.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>  
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Database.SQLite.Simple</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="cm">{-</code>
<code class="linenos"> 8 </code><code class="cm">   Create sqlite database:</code>
<code class="linenos"> 9 </code><code class="cm">     sqlite3 test.db "create table test (id integer primary key, str text);"</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="cm">   This example is derived from the example at github.com/nurpax/sqlite-simple</code>
<code class="linenos">12 </code><code class="cm">-}</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">15 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">16 </code>  <code class="n">conn</code> <code class="ow">&lt;-</code> <code class="n">open</code> <code class="s">"test.db"</code>
<code class="linenos">17 </code>  <code class="c1">-- start by getting table names in database:</code>
<code class="linenos">18 </code>  <code class="kr">do</code>
<code class="linenos">19 </code>    <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code>
<code class="linenos">20 </code>      <code class="s">"SELECT name FROM sqlite_master WHERE type='table'"</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="p">[</code><code class="kt">Only</code> <code class="kt">String</code><code class="p">]</code>
<code class="linenos">21 </code>    <code class="n">print</code> <code class="s">"Table names in database test.db:"</code>
<code class="linenos">22 </code>    <code class="n">mapM_</code> <code class="p">(</code><code class="n">print</code> <code class="o">.</code> <code class="n">fromOnly</code><code class="p">)</code> <code class="n">r</code>
<code class="linenos">23 </code>  
<code class="linenos">24 </code>  <code class="c1">-- get the metadata for table test in test.db:</code>
<code class="linenos">25 </code>  <code class="kr">do</code>
<code class="linenos">26 </code>    <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code>
<code class="linenos">27 </code>          <code class="s">"SELECT sql FROM sqlite_master WHERE type='table' and name='test'"</code> <code class="ow">::</code>
<code class="linenos">28 </code>                <code class="kt">IO</code> <code class="p">[</code><code class="kt">Only</code> <code class="kt">String</code><code class="p">]</code>
<code class="linenos">29 </code>    <code class="n">print</code> <code class="s">"SQL to create table 'test' in database test.db:"</code>
<code class="linenos">30 </code>    <code class="n">mapM_</code> <code class="p">(</code><code class="n">print</code> <code class="o">.</code> <code class="n">fromOnly</code><code class="p">)</code> <code class="n">r</code>
<code class="linenos">31 </code>  
<code class="linenos">32 </code>  <code class="c1">-- add a row to table 'test' and then print out the rows in table 'test':</code>
<code class="linenos">33 </code>  <code class="kr">do</code>
<code class="linenos">34 </code>    <code class="n">execute</code> <code class="n">conn</code> <code class="s">"INSERT INTO test (str) VALUES (?)"</code>
<code class="linenos">35 </code>      <code class="p">(</code><code class="kt">Only</code> <code class="p">(</code><code class="s">"test string 2"</code> <code class="ow">::</code> <code class="kt">String</code><code class="p">))</code>
<code class="linenos">36 </code>    <code class="n">r2</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code> <code class="s">"SELECT * from test"</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="p">[(</code><code class="kt">Int</code><code class="p">,</code> <code class="kt">String</code><code class="p">)]</code>
<code class="linenos">37 </code>    <code class="n">print</code> <code class="s">"number of rows in table 'test':"</code>
<code class="linenos">38 </code>    <code class="n">print</code> <code class="p">(</code><code class="n">length</code> <code class="n">r2</code><code class="p">)</code>
<code class="linenos">39 </code>    <code class="n">print</code> <code class="s">"rows in table 'test':"</code>
<code class="linenos">40 </code>    <code class="n">mapM_</code> <code class="n">print</code>  <code class="n">r2</code>
<code class="linenos">41 </code>    
<code class="linenos">42 </code>  <code class="n">close</code> <code class="n">conn</code>
</pre></div>

</figure>

<p>The type <strong>Only</strong> used in line 20 acts as a container for a single value and is defined in the <em>simple-sqlite</em> library. It can also be used to pass values for queries like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">r</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code> <code class="s">"SELECT name FROM customers where id = ?"</code> <code class="p">(</code><code class="kt">Only</code> <code class="mi">4</code><code class="ow">::</code><code class="kt">Int</code><code class="p">)</code>
</pre></div>

</figure>

<p>To run this example start by creating a sqlite database that is stored in the file <em>test.db</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>sqlite3 test.db "create table test (id integer primary key, str text);"
</pre></div>

</figure>

<p>Then build and run the example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">stack</code> <code class="nv">build</code> <code class="o">--</code><code class="k">exec</code> <code class="nv">TestSqLite1</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-database-access-for-postgres">Database Access for Postgres</h3>

<p>Setting up and using a database in the last section was easy because the <em>sqlite-simple</em> library includes the compiled code for <em>sqlite</em> so configuration only requires the file path the the database file. The Haskel examples for Postgres will be similar to those for Sqlite. There is some complication in setting up Postgres if you do not already have it installed and configured.</p>

<p>In any case, you will need to have Postgres installed and set up with a user account for yourself. When I am installing and configuring Postgres on my Linux laptop, I create a database role <strong>markw</strong>. You will certainly create a different role/account name  so subsitute your role name for <strong>markw</strong> in the following code examples.</p>

<p>If you are using Ubuntu you can install Postgres and create a role using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>sudo apt-get update
sudo apt-get install postgresql postgresql-contrib postgresql-server-dev-9.5
sudo -u postgres createuser --interactive
Enter name of role to add: markw
Shall the new role be a superuser? (y/n) y
</pre></div>

</figure>

<p>We will need to install postgresql-server-dev-9.5 in order to use the Haskell Postgres bindings. Note that your version of Ubuntu Linux may have a different version of the server dev package which you can find using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>aptitude search postgresql-dev
</pre></div>

</figure>

<p>If you are using Mac OS X you can then install Postgres as an application which is convenient for development. A role is automatically created with the same name as your OS X “short name.” You can use the “Open psql” button on the interface to open a command line shell that functions like the <em>psql</em> command on Ubuntu (or other Linux distributions).</p>

<p>We will need to install postgresql-server-dev-9.5 in order to use the Haskell Postgres bindings. Note that your version of Ubuntu Linux may have a different version of the server dev package which you can find using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>aptitude search postgresql-dev
</pre></div>

</figure>

<p>You will then want to create a database named <strong>haskell</strong> and set the password for role/account <strong>markw</strong> to <strong>test1</strong> for running the example in this section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">createdb</code><code class="w"> </code><code class="n">haskell</code><code class="w"></code>
<code class="n">sudo</code><code class="w"> </code><code class="o">-</code><code class="n">u</code><code class="w"> </code><code class="n">postgres</code><code class="w"> </code><code class="n">psql</code><code class="w"></code>
<code class="n">postgres</code><code class="o">=</code><code class="err">#</code><code class="w"> </code><code class="k">alter</code><code class="w"> </code><code class="k">user</code><code class="w"> </code><code class="n">markw</code><code class="w"> </code><code class="n">encrypted</code><code class="w"> </code><code class="n">password</code><code class="w"> </code><code class="s1">'test1'</code><code class="p">;</code><code class="w"></code>
<code class="n">postgres</code><code class="o">=</code><code class="err">#</code><code class="w"> </code><code class="err">\</code><code class="n">q</code><code class="w"></code>

<code class="n">psql</code><code class="w"> </code><code class="o">-</code><code class="n">U</code><code class="w"> </code><code class="n">markw</code><code class="w"> </code><code class="n">haskell</code><code class="w"></code>
<code class="n">psql</code><code class="w"> </code><code class="p">(</code><code class="mf">9.5.4</code><code class="p">)</code><code class="w"></code>
<code class="n">Type</code><code class="w"> </code><code class="ss">"help"</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">help</code><code class="p">.</code><code class="w"></code>

<code class="n">haskell</code><code class="o">=</code><code class="err">#</code><code class="w"> </code><code class="k">create</code><code class="w"> </code><code class="nc">table</code><code class="w"> </code><code class="n">customers</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="w"> </code><code class="nc">int</code><code class="p">,</code><code class="w"> </code><code class="n">name</code><code class="w"> </code><code class="nc">text</code><code class="p">,</code><code class="w"> </code><code class="n">email</code><code class="w"> </code><code class="nc">text</code><code class="p">);</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="nc">TABLE</code><code class="w"></code>
<code class="n">haskell</code><code class="o">=</code><code class="err">#</code><code class="w">  </code><code class="k">insert</code><code class="w"> </code><code class="k">into</code><code class="w"> </code><code class="n">customers</code><code class="w"> </code><code class="k">values</code><code class="w"> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="w"> </code><code class="s1">'Acme Cement'</code><code class="p">,</code><code class="w"> </code><code class="s1">'info@acmecement.com'</code><code class="p">);</code><code class="w"></code>
<code class="k">INSERT</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="mi">1</code><code class="w"></code>
<code class="n">haskell</code><code class="o">=</code><code class="err">#</code><code class="w"> </code><code class="err">\</code><code class="n">q</code><code class="w"></code>
</pre></div>

</figure>

<p>If you are not familiar with using Postgres then take a minute to experiment with using the <em>psql</em> command line utility to connect to the database you just created and peform practice queries:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">markw</code><code class="o">=#</code> <code class="err">\</code><code class="k">c</code> <code class="n">haskell</code>
<code class="n">You</code> <code class="k">are</code> <code class="n">now</code> <code class="n">connected</code> <code class="k">to</code> <code class="k">database</code> <code class="ss">"haskell"</code> <code class="k">as</code> <code class="k">user</code> <code class="ss">"markw"</code><code class="p">.</code>
<code class="n">haskell</code><code class="o">=#</code> <code class="err">\</code><code class="n">d</code>
         <code class="n">List</code> <code class="k">of</code> <code class="n">relations</code>
 <code class="k">Schema</code> <code class="o">|</code>   <code class="n">Name</code>    <code class="o">|</code> <code class="k">Type</code>  <code class="o">|</code> <code class="k">Owner</code> 
<code class="c1">--------+-----------+-------+-------</code>
 <code class="k">public</code> <code class="o">|</code> <code class="n">customers</code> <code class="o">|</code> <code class="k">table</code> <code class="o">|</code> <code class="n">markw</code>
 <code class="k">public</code> <code class="o">|</code> <code class="n">links</code>     <code class="o">|</code> <code class="k">table</code> <code class="o">|</code> <code class="n">markw</code>
 <code class="k">public</code> <code class="o">|</code> <code class="n">products</code>  <code class="o">|</code> <code class="k">table</code> <code class="o">|</code> <code class="n">markw</code>
<code class="p">(</code><code class="mi">3</code> <code class="k">rows</code><code class="p">)</code>

<code class="n">haskell</code><code class="o">=#</code> <code class="k">select</code> <code class="o">*</code> <code class="k">from</code> <code class="n">customers</code><code class="p">;</code>
 <code class="n">id</code> <code class="o">|</code>      <code class="n">name</code>       <code class="o">|</code>        <code class="n">email</code>        
<code class="c1">----+-----------------+---------------------</code>
  <code class="mi">1</code> <code class="o">|</code> <code class="n">Acme</code> <code class="n">Cement</code>     <code class="o">|</code> <code class="n">info</code><code class="o">@</code><code class="n">acmecement</code><code class="p">.</code><code class="n">com</code>
  <code class="mi">2</code> <code class="o">|</code> <code class="n">Biff</code> <code class="n">Home</code> <code class="n">Sales</code> <code class="o">|</code> <code class="n">info</code><code class="o">@</code><code class="n">biff</code><code class="p">.</code><code class="n">com</code>
  <code class="mi">3</code> <code class="o">|</code> <code class="n">My</code> <code class="n">Pens</code>         <code class="o">|</code> <code class="n">info</code><code class="o">@</code><code class="n">mypens</code><code class="p">.</code><code class="n">com</code>
<code class="p">(</code><code class="mi">3</code> <code class="k">rows</code><code class="p">)</code>

<code class="n">haskell</code><code class="o">=#</code> <code class="k">select</code> <code class="o">*</code> <code class="k">from</code> <code class="n">products</code><code class="p">;</code>
 <code class="n">id</code> <code class="o">|</code>     <code class="n">name</code>      <code class="o">|</code> <code class="n">cost</code> 
<code class="c1">----+---------------+------</code>
  <code class="mi">1</code> <code class="o">|</code> <code class="n">Cement</code> <code class="n">bag</code>    <code class="o">|</code>  <code class="mi">2</code><code class="p">.</code><code class="mi">5</code>
  <code class="mi">2</code> <code class="o">|</code> <code class="n">Cheap</code> <code class="n">Pen</code>     <code class="o">|</code>  <code class="mi">1</code><code class="p">.</code><code class="mi">5</code>
  <code class="mi">3</code> <code class="o">|</code> <code class="n">Expensive</code> <code class="n">Pen</code> <code class="o">|</code> <code class="mi">14</code><code class="p">.</code><code class="mi">5</code>
<code class="p">(</code><code class="mi">3</code> <code class="k">rows</code><code class="p">)</code>

<code class="n">haskell</code><code class="o">=#</code> <code class="k">select</code> <code class="o">*</code> <code class="k">from</code> <code class="n">links</code><code class="p">;</code>
 <code class="n">id</code> <code class="o">|</code> <code class="n">customer_id</code> <code class="o">|</code> <code class="n">productid</code> 
<code class="c1">----+-------------+-----------</code>
  <code class="mi">1</code> <code class="o">|</code>           <code class="mi">1</code> <code class="o">|</code>         <code class="mi">1</code>
  <code class="mi">2</code> <code class="o">|</code>           <code class="mi">3</code> <code class="o">|</code>         <code class="mi">2</code>
  <code class="mi">3</code> <code class="o">|</code>           <code class="mi">3</code> <code class="o">|</code>         <code class="mi">3</code>
<code class="p">(</code><code class="mi">3</code> <code class="k">rows</code><code class="p">)</code>

<code class="n">haskell</code><code class="o">=#</code> 
</pre></div>

</figure>

<p>You can change default database settings using <strong>ConnectInfo</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kt">ConnectInfo</code>	 
  <code class="n">connectHost</code> <code class="ow">::</code> <code class="kt">String</code>
  <code class="n">connectPort</code> <code class="ow">::</code> <code class="kt">Word16</code>
  <code class="n">connectUser</code> <code class="ow">::</code> <code class="kt">String</code>
  <code class="n">connectPassword</code> <code class="ow">::</code> <code class="kt">String</code>
  <code class="n">connectDatabase</code> <code class="ow">::</code> <code class="kt">String</code>
</pre></div>

</figure>

<p>In the following example on lines 9-10 I use <strong>defaultConnectInfo</strong> that lets me override just some settings, leaving the rest set at default values. The code to access a database using <em>simple-postgresql</em> is similar to that in the last section, with a few API changes.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 4 </code>  
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Database.PostgreSQL.Simple</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos"> 8 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 9 </code>  <code class="n">conn</code> <code class="ow">&lt;-</code> <code class="n">connect</code> <code class="n">defaultConnectInfo</code> <code class="p">{</code> <code class="n">connectDatabase</code> <code class="ow">=</code> <code class="s">"haskell"</code><code class="p">,</code>
<code class="linenos">10 </code>                                       <code class="n">connectUser</code> <code class="ow">=</code> <code class="s">"markw"</code> <code class="p">}</code>
<code class="linenos">11 </code>  <code class="c1">-- start by getting table names in database:</code>
<code class="linenos">12 </code>  <code class="kr">do</code>
<code class="linenos">13 </code>    <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code> <code class="s">"SELECT name FROM customers"</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="p">[(</code><code class="kt">Only</code> <code class="kt">String</code><code class="p">)]</code>
<code class="linenos">14 </code>    <code class="n">print</code> <code class="s">"names and emails in table 'customers' in database haskell:"</code>
<code class="linenos">15 </code>    <code class="n">mapM_</code> <code class="p">(</code><code class="n">print</code> <code class="o">.</code> <code class="n">fromOnly</code><code class="p">)</code> <code class="n">r</code>
<code class="linenos">16 </code>  
<code class="linenos">17 </code>  <code class="c1">-- add a row to table 'test' and then print out the rows in table 'test':</code>
<code class="linenos">18 </code>  <code class="kr">do</code>
<code class="linenos">19 </code>    <code class="kr">let</code> <code class="n">rows</code> <code class="ow">::</code> <code class="p">[(</code><code class="kt">Int</code><code class="p">,</code> <code class="kt">String</code><code class="p">,</code> <code class="kt">String</code><code class="p">)]</code>
<code class="linenos">20 </code>        <code class="n">rows</code> <code class="ow">=</code> <code class="p">[(</code><code class="mi">4</code><code class="p">,</code> <code class="s">"Mary Smith"</code><code class="p">,</code> <code class="s">"marys@acme.com"</code><code class="p">)]</code>
<code class="linenos">21 </code>    <code class="n">executeMany</code> <code class="n">conn</code>
<code class="linenos">22 </code>      <code class="s">"INSERT INTO customers (id, name, email) VALUES (?,?,?)"</code> <code class="n">rows</code>
<code class="linenos">23 </code>    <code class="n">r2</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code> <code class="s">"SELECT * from customers"</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="p">[(</code><code class="kt">Int</code><code class="p">,</code> <code class="kt">String</code><code class="p">,</code> <code class="kt">String</code><code class="p">)]</code>
<code class="linenos">24 </code>    <code class="n">print</code> <code class="s">"number of rows in table 'customers':"</code>
<code class="linenos">25 </code>    <code class="n">print</code> <code class="p">(</code><code class="n">length</code> <code class="n">r2</code><code class="p">)</code>
<code class="linenos">26 </code>    <code class="n">print</code> <code class="s">"rows in table 'customers':"</code>
<code class="linenos">27 </code>    <code class="n">mapM_</code> <code class="n">print</code>  <code class="n">r2</code>
<code class="linenos">28 </code>    
<code class="linenos">29 </code>  <code class="n">close</code> <code class="n">conn</code>
</pre></div>

</figure>

<p>The type <strong>Only</strong> used in line 20 acts as a container for a single value and is defined in the <em>simple-postgresql</em> library. It can also be used to pass values for queries like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">r</code> <code class="ow">&lt;-</code> <code class="n">query_</code> <code class="n">conn</code> <code class="s">"SELECT name FROM customers where id = ?"</code> <code class="p">(</code><code class="kt">Only</code> <code class="mi">4</code><code class="ow">::</code><code class="kt">Int</code><code class="p">)</code>
</pre></div>

</figure>

<p>The monad mapping function <strong>mapM_</strong> using in line 22 is like <strong>mapM</strong> but is used when we do not need the resulting collection from executing the map operation. <strong>mapM_</strong> is used for side effects, in this case extracting the value for a collection of <strong>Only</strong> values and printing them. I removed some output from building the example in the following listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">$</code> <code class="kt">Database</code><code class="o">-</code><code class="n">postgres</code> <code class="n">git</code><code class="kt">:</code><code class="p">(</code><code class="n">master</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">stack</code> <code class="n">build</code> <code class="c1">--exec TestPostgres1</code>
<code class="kt">TestDatabase</code><code class="o">-</code><code class="mf">0.1</code><code class="o">.</code><code class="mf">0.0</code><code class="kt">:</code> <code class="n">build</code>
<code class="kt">Preprocessing</code> <code class="n">executable</code> <code class="kt">'TestPostgres1'</code> <code class="n">for</code> <code class="kt">TestDatabase</code><code class="o">-</code><code class="mf">0.1</code><code class="o">.</code><code class="mf">0.0</code><code class="o">...</code>
<code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Main</code>             <code class="p">(</code> <code class="kt">TestPostgres1</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> 

<code class="s">"names and emails in table 'customers' in database haskell:"</code>
<code class="s">"Acme Cement"</code>
<code class="s">"Biff Home Sales"</code>
<code class="s">"My Pens"</code>
<code class="s">"number of rows in table 'customers':"</code>
<code class="mi">4</code>
<code class="s">"rows in table 'customers':"</code>
<code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="s">"Acme Cement"</code><code class="p">,</code><code class="s">"info@acmecement.com"</code><code class="p">)</code>
<code class="p">(</code><code class="mi">2</code><code class="p">,</code><code class="s">"Biff Home Sales"</code><code class="p">,</code><code class="s">"info@biff.com"</code><code class="p">)</code>
<code class="p">(</code><code class="mi">3</code><code class="p">,</code><code class="s">"My Pens"</code><code class="p">,</code><code class="s">"info@mypens.com"</code><code class="p">)</code>
<code class="p">(</code><code class="mi">4</code><code class="p">,</code><code class="s">"Mary Smith"</code><code class="p">,</code><code class="s">"marys@acme.com"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Postgres is my default database and I use it unless there is a compelling reason not to. While work for specific customers has mandated using alternative data stores (e.g., BigTable while working at Google and MongoDB at Compass Labs), Postgres supports relational tables, free text search, and structured data like JSON.</p>


<h2 id="leanpub-auto-haskell-program-to-play-the-blackjack-card-game">Haskell Program to Play the Blackjack Card Game</h2>

<p>For much of my work using Haskell I deal mostly with pure code with smaller bits of impure code for network and file IO, etc. Realizing that my use case for using Haskell (mostly pure code) may not be typical, I wanted the last example “cookbook recipe” in this book to be an example dealing with changing state, a program to play the Blackjack card game.</p>

<p>The game state is maintained in the type <strong>Table</strong> that holds information on a randomized deck of cards, the number of players in addition to the game user and the card dealer, the cards in the current hand, and the number of betting chips that all players own. Table data is immutable so all of the major game playing functions take a table and any other required inputs, and generate a new table as the function result.</p>

<p>This example starts by asking how many players, besides the card dealer and the game user, should play a simulated Blackjack game. The game user controls when they want another card while the dealer and any other simulated players play automatically (they always hit when their card score is less than 17).</p>

<p>I define the types for playing cards and an entire card deck in the file <em>Card.hs</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Card</code> <code class="p">(</code><code class="kt">Card</code><code class="p">,</code> <code class="kt">Rank</code><code class="p">,</code> <code class="kt">Suit</code><code class="p">,</code> <code class="nf">orderedCardDeck</code><code class="p">,</code> <code class="nf">cardValue</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromMaybe</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Data.List</code> <code class="p">(</code><code class="nf">elemIndex</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">Data.Map</code> <code class="p">(</code><code class="nf">fromList</code><code class="p">,</code> <code class="nf">lookup</code><code class="p">,</code> <code class="nf">keys</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kr">data</code> <code class="kt">Card</code> <code class="ow">=</code> <code class="kt">Card</code> <code class="p">{</code> <code class="n">rank</code> <code class="ow">::</code> <code class="kt">Rank</code>
<code class="linenos"> 8 </code>                 <code class="p">,</code> <code class="n">suit</code> <code class="ow">::</code> <code class="kt">Suit</code> <code class="p">}</code>
<code class="linenos"> 9 </code>                 <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Eq</code><code class="p">,</code> <code class="kt">Show</code><code class="p">)</code>
<code class="linenos">10 </code>                 
<code class="linenos">11 </code><code class="kr">data</code> <code class="kt">Suit</code> <code class="ow">=</code> <code class="kt">Hearts</code> <code class="o">|</code> <code class="kt">Diamonds</code> <code class="o">|</code> <code class="kt">Clubs</code> <code class="o">|</code> <code class="kt">Spades</code>
<code class="linenos">12 </code>          <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Eq</code><code class="p">,</code> <code class="kt">Show</code><code class="p">,</code> <code class="kt">Enum</code><code class="p">,</code> <code class="kt">Ord</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="kr">data</code> <code class="kt">Rank</code> <code class="ow">=</code> <code class="kt">Two</code> <code class="o">|</code> <code class="kt">Three</code> <code class="o">|</code> <code class="kt">Four</code>
<code class="linenos">15 </code>          <code class="o">|</code> <code class="kt">Five</code> <code class="o">|</code> <code class="kt">Six</code> <code class="o">|</code> <code class="kt">Seven</code> <code class="o">|</code> <code class="kt">Eight</code>
<code class="linenos">16 </code>          <code class="o">|</code> <code class="kt">Nine</code> <code class="o">|</code> <code class="kt">Ten</code> <code class="o">|</code> <code class="kt">Jack</code>  <code class="o">|</code> <code class="kt">Queen</code> <code class="o">|</code> <code class="kt">King</code> <code class="o">|</code> <code class="kt">Ace</code>
<code class="linenos">17 </code>          <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Eq</code><code class="p">,</code> <code class="kt">Show</code><code class="p">,</code> <code class="kt">Enum</code><code class="p">,</code> <code class="kt">Ord</code><code class="p">)</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="nf">rankMap</code> <code class="ow">=</code> <code class="n">fromList</code> <code class="p">[(</code><code class="kt">Two</code><code class="p">,</code><code class="mi">2</code><code class="p">),</code> <code class="p">(</code><code class="kt">Three</code><code class="p">,</code><code class="mi">3</code><code class="p">),</code> <code class="p">(</code><code class="kt">Four</code><code class="p">,</code><code class="mi">4</code><code class="p">),</code> <code class="p">(</code><code class="kt">Five</code><code class="p">,</code><code class="mi">5</code><code class="p">),</code>
<code class="linenos">20 </code>                    <code class="p">(</code><code class="kt">Six</code><code class="p">,</code><code class="mi">6</code><code class="p">),</code> <code class="p">(</code><code class="kt">Seven</code><code class="p">,</code><code class="mi">7</code><code class="p">),</code> <code class="p">(</code><code class="kt">Eight</code><code class="p">,</code><code class="mi">8</code><code class="p">),</code> <code class="p">(</code><code class="kt">Nine</code><code class="p">,</code><code class="mi">9</code><code class="p">),</code>
<code class="linenos">21 </code>                    <code class="p">(</code><code class="kt">Ten</code><code class="p">,</code><code class="mi">10</code><code class="p">),</code> <code class="p">(</code><code class="kt">Jack</code><code class="p">,</code><code class="mi">10</code><code class="p">),</code> <code class="p">(</code><code class="kt">Queen</code><code class="p">,</code><code class="mi">10</code><code class="p">),</code>
<code class="linenos">22 </code>                    <code class="p">(</code><code class="kt">King</code><code class="p">,</code><code class="mi">10</code><code class="p">),</code> <code class="p">(</code><code class="kt">Ace</code><code class="p">,</code><code class="mi">11</code><code class="p">)]</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="nf">orderedCardDeck</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Card</code><code class="p">]</code>
<code class="linenos">25 </code><code class="nf">orderedCardDeck</code> <code class="ow">=</code> <code class="p">[</code><code class="kt">Card</code> <code class="n">rank</code> <code class="n">suit</code> <code class="o">|</code> <code class="n">rank</code> <code class="ow">&lt;-</code> <code class="n">keys</code> <code class="n">rankMap</code><code class="p">,</code>
<code class="linenos">26 </code>                                    <code class="n">suit</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="kt">Hearts</code> <code class="o">..</code> <code class="kt">Clubs</code><code class="p">]]</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="nf">cardValue</code> <code class="ow">::</code> <code class="kt">Card</code> <code class="ow">-&gt;</code> <code class="kt">Int</code>
<code class="linenos">29 </code><code class="nf">cardValue</code> <code class="n">aCard</code> <code class="ow">=</code>
<code class="linenos">30 </code>  <code class="kr">case</code> <code class="p">(</code><code class="kt">Data</code><code class="o">.</code><code class="kt">Map</code><code class="o">.</code><code class="n">lookup</code> <code class="p">(</code><code class="n">rank</code> <code class="n">aCard</code><code class="p">)</code> <code class="n">rankMap</code><code class="p">)</code> <code class="kr">of</code>
<code class="linenos">31 </code>    <code class="kt">Just</code> <code class="n">n</code> <code class="ow">-&gt;</code> <code class="n">n</code>
<code class="linenos">32 </code>    <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="mi">0</code> <code class="c1">-- should never happen</code>
</pre></div>

</figure>

<p>As usual, the best way to understand this code is to go to the GHCi repl:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Main</code> <code class="kt">Card</code> <code class="kt">RandomizedList</code> <code class="kt">Table</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">Card</code>
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">Card</code>             <code class="p">(</code> <code class="kt">Card</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">Card</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">Card</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">t</code> <code class="n">orderedCardDeck</code>
<code class="linenos"> 5 </code><code class="nf">orderedCardDeck</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Card</code><code class="p">]</code>
<code class="linenos"> 6 </code><code class="o">*</code><code class="kt">Card</code><code class="o">&gt;</code> <code class="n">orderedCardDeck</code>
<code class="linenos"> 7 </code><code class="p">[</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Two</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Hearts</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Two</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Diamonds</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Tw</code><code class="nf">\</code>
<code class="linenos"> 8 </code><code class="nf">o</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Clubs</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Three</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Hearts</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Three</code><code class="p">,</code>
<code class="linenos"> 9 </code>    <code class="o">...</code>
<code class="linenos">10 </code><code class="o">*</code><code class="kt">Card</code><code class="o">&gt;</code> <code class="n">head</code> <code class="n">orderedCardDeck</code>
<code class="linenos">11 </code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Two</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Hearts</code><code class="p">}</code>
<code class="linenos">12 </code><code class="o">*</code><code class="kt">Card</code><code class="o">&gt;</code> <code class="n">cardValue</code> <code class="o">$</code> <code class="n">head</code> <code class="n">orderedCardDeck</code>
<code class="linenos">13 </code><code class="mi">2</code>
</pre></div>

</figure>

<p>So, we have a sorted deck of cards and a utility function for returning the numerical value of a card (we always count ace cards as 11 points, deviating from standard Blackjack rules).</p>

<p>The next thing we need to get is randomly shuffled lists. The <a href="https://wiki.haskell.org/Random_shuffle">Haskell Wiki</a> has a good writeup on randomizing list elements and we are borrowing their function <strong>randomizedList</strong> (you can see the source code in the file <em>RandomizedList.hs</em>). Here is a sample use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="kt">Card</code><code class="o">&gt;</code> <code class="kt">:</code><code class="n">l</code> <code class="kt">RandomizedList</code><code class="o">.</code><code class="n">hs</code> 
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code> <code class="kr">of</code> <code class="mi">1</code><code class="p">]</code> <code class="kt">Compiling</code> <code class="kt">RandomizedList</code>   <code class="p">(</code> <code class="kt">RandomizedList</code><code class="o">.</code><code class="n">hs</code><code class="p">,</code> <code class="n">interpreted</code> <code class="p">)</code>
<code class="linenos"> 3 </code><code class="kt">Ok</code><code class="p">,</code> <code class="n">modules</code> <code class="n">loaded</code><code class="kt">:</code> <code class="kt">RandomizedList</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="o">*</code><code class="kt">RandomizedList</code><code class="o">&gt;</code> <code class="kr">import</code> <code class="nn">Card</code>
<code class="linenos"> 5 </code><code class="o">*</code><code class="kt">RandomizedList</code> <code class="kt">Card</code><code class="o">&gt;</code> <code class="n">randomizedList</code> <code class="n">orderedCardDeck</code>
<code class="linenos"> 6 </code><code class="p">[</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Queen</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Hearts</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Six</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Diamonds</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="nf">\</code>
<code class="linenos"> 7 </code><code class="kt">Five</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Clubs</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Five</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Diamonds</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Seven</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">C</code><code class="nf">\</code>
<code class="linenos"> 8 </code><code class="nf">lubs</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Three</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Hearts</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">rank</code> <code class="ow">=</code> <code class="kt">Four</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Diamonds</code><code class="p">},</code><code class="kt">Card</code> <code class="p">{</code><code class="n">r</code><code class="nf">\</code>
<code class="linenos"> 9 </code><code class="nf">ank</code> <code class="ow">=</code> <code class="kt">Ace</code><code class="p">,</code> <code class="n">suit</code> <code class="ow">=</code> <code class="kt">Hearts</code><code class="p">},</code>
<code class="linenos">10 </code>  <code class="o">...</code>
</pre></div>

</figure>

<p>Much of the complexity in this example is implemented in <em>Table.hs</em> which defines the type <strong>Table</strong> and several functions to deal and score hands of dealt cards:</p>

<ul>
  <li>createNewTable :: Players -&gt; Table. Players is the integer number of other players at the table.</li>
  <li>setPlayerBet :: Int -&gt; Table -&gt; Table. Given a new value to bet and a table, generate a new modified table.</li>
  <li>showTable :: Table -&gt; [Char]. Given a table, generate a string describing the table (in a format useful for development)</li>
  <li>initialDeal :: [Card] -&gt; Table -&gt; Int -&gt; Table. Given a randomized deck of cards, a table, and the number of other players, generate a new table.</li>
  <li>changeChipStack :: Int -&gt; Int -&gt; Table -&gt; Table. Given a player index (index order: user, dealer, and other players), a new number of betting chips for the player, and a table, then generate a new modified table.</li>
  <li>setCardDeck :: [Card] -&gt; Table -&gt; Table. Given a randomized card deck and a table, generate a new table containing the new randomized card list; all other table data is unchanged.</li>
  <li>dealCards :: Table -&gt; [Int] -&gt; Table. Given a table and a list of player indices for players wanting another card, generate a new modified table.</li>
  <li>resetTable :: [Card] -&gt; Table -&gt; Int -&gt; Table. Given a new randomized card deck, a table, and a new number of other players, generate a new table.</li>
  <li>scoreHands :: Table -&gt; Table. Given a table, score all dealt hands and generate a new table with these scores. There is no table type score data, rather, we “score” by changing the number of chips all of the players (inclding the dealer) has.</li>
  <li>dealCardToUser :: Table -&gt; Int -&gt; Table. For the game user, always deal a card. For the dealer and other players, deal another card if their hand score is less than 17.</li>
  <li>handOver :: Table -&gt; Bool. Determine if the current hand is over.</li>
  <li>setPlayerPasses :: Table -&gt; Table. Call this function when the payer passes. Other players and dealer are then played out automatically.</li>
</ul>

<p>The implementation in the file <em>Table.hs</em> is fairly simple, with the exception of the use of Haskell lenses to access nested data in the table type. I will discuss the use of lenses after the program listing, but: as you are reading the code look out for variables starting with the underscore character <strong>_</strong> that alerts the <em>Lens</em> system that it should create data accessors for these variables:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="cm">{-# LANGUAGE TemplateHaskell #-}</code>  <code class="c1">-- for makeLens</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="kr">module</code> <code class="nn">Table</code> <code class="p">(</code><code class="kt">Table</code> <code class="p">(</code><code class="o">..</code><code class="p">),</code> <code class="nf">createNewTable</code><code class="p">,</code> <code class="nf">setPlayerBet</code><code class="p">,</code> <code class="nf">showTable</code><code class="p">,</code> <code class="nf">initialDeal</code><code class="p">,</code>
<code class="linenos">  4 </code>              <code class="nf">changeChipStack</code><code class="p">,</code> <code class="nf">setCardDeck</code><code class="p">,</code> <code class="nf">dealCards</code><code class="p">,</code> <code class="nf">resetTable</code><code class="p">,</code> <code class="nf">scoreHands</code><code class="p">,</code>
<code class="linenos">  5 </code>              <code class="nf">dealCardToUser</code><code class="p">,</code> <code class="nf">handOver</code><code class="p">,</code> <code class="nf">setPlayerPasses</code><code class="p">)</code> <code class="kr">where</code>
<code class="linenos">  6 </code>  <code class="c1">-- note: export dealCardToUser only required for ghci development</code>
<code class="linenos">  7 </code>
<code class="linenos">  8 </code><code class="kr">import</code> <code class="nn">Control.Lens</code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code><code class="kr">import</code> <code class="nn">Card</code>
<code class="linenos"> 11 </code><code class="kr">import</code> <code class="nn">Data.Bool</code>
<code class="linenos"> 12 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromMaybe</code><code class="p">)</code>
<code class="linenos"> 13 </code>
<code class="linenos"> 14 </code><code class="kr">data</code> <code class="kt">Table</code> <code class="ow">=</code> <code class="kt">Table</code> <code class="p">{</code> <code class="n">_numPlayers</code> <code class="ow">::</code> <code class="kt">Int</code>
<code class="linenos"> 15 </code>                   <code class="p">,</code> <code class="n">_chipStacks</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Int</code><code class="p">]</code> <code class="c1">-- number of chips,</code>
<code class="linenos"> 16 </code>                                          <code class="c1">-- indexed by player index</code>
<code class="linenos"> 17 </code>                   <code class="p">,</code> <code class="n">_dealtCards</code> <code class="ow">::</code> <code class="p">[[</code><code class="kt">Card</code><code class="p">]]</code> <code class="c1">-- dealt cards for user,</code>
<code class="linenos"> 18 </code>                                             <code class="c1">-- dealer, and other players</code>
<code class="linenos"> 19 </code>                   <code class="p">,</code> <code class="n">_currentPlayerBet</code> <code class="ow">::</code> <code class="kt">Int</code>
<code class="linenos"> 20 </code>                   <code class="p">,</code> <code class="n">_userPasses</code>       <code class="ow">::</code> <code class="kt">Bool</code>
<code class="linenos"> 21 </code>                   <code class="p">,</code> <code class="n">_cardDeck</code>         <code class="ow">::</code> <code class="p">[</code><code class="kt">Card</code><code class="p">]</code>
<code class="linenos"> 22 </code>                   <code class="p">}</code>
<code class="linenos"> 23 </code>           <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="p">)</code>
<code class="linenos"> 24 </code>           
<code class="linenos"> 25 </code><code class="kr">type</code> <code class="kt">Players</code> <code class="ow">=</code> <code class="kt">Int</code>
<code class="linenos"> 26 </code>             
<code class="linenos"> 27 </code><code class="nf">createNewTable</code> <code class="ow">::</code> <code class="kt">Players</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos"> 28 </code><code class="nf">createNewTable</code> <code class="n">n</code> <code class="ow">=</code>
<code class="linenos"> 29 </code>  <code class="kt">Table</code> <code class="n">n</code>
<code class="linenos"> 30 </code>        <code class="p">[</code><code class="mi">500</code> <code class="o">|</code> <code class="kr">_</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">1</code> <code class="o">..</code> <code class="n">n</code><code class="p">]]</code> <code class="c1">-- give each player (incuding dealer) 10 chips</code>
<code class="linenos"> 31 </code>        <code class="p">[</code><code class="kt">[]</code> <code class="o">|</code> <code class="kr">_</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="n">n</code><code class="p">]]</code> <code class="c1">-- dealt cards for user and other players</code>
<code class="linenos"> 32 </code>                           <code class="c1">-- (we don't track dealer's chips)</code>
<code class="linenos"> 33 </code>        <code class="mi">20</code> <code class="c1">-- currentPlayerBet number of betting chips</code>
<code class="linenos"> 34 </code>        <code class="kt">False</code>
<code class="linenos"> 35 </code>        <code class="kt">[]</code> <code class="c1">-- placeholder for random shuffled card deck</code>
<code class="linenos"> 36 </code> 
<code class="linenos"> 37 </code><code class="nf">resetTable</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Card</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos"> 38 </code><code class="nf">resetTable</code> <code class="n">cardDeck</code> <code class="n">aTable</code> <code class="n">numberOfPlayers</code> <code class="ow">=</code>
<code class="linenos"> 39 </code>  <code class="kt">Table</code> <code class="n">numberOfPlayers</code>
<code class="linenos"> 40 </code>        <code class="p">(</code><code class="n">_chipStacks</code> <code class="n">aTable</code><code class="p">)</code>       <code class="c1">-- using Lens accessor</code>
<code class="linenos"> 41 </code>        <code class="p">[</code><code class="kt">[]</code> <code class="o">|</code> <code class="kr">_</code> <code class="ow">&lt;-</code> <code class="p">[</code><code class="mi">0</code><code class="o">..</code><code class="n">numberOfPlayers</code><code class="p">]]</code>
<code class="linenos"> 42 </code>        <code class="p">(</code><code class="n">_currentPlayerBet</code> <code class="n">aTable</code><code class="p">)</code> <code class="c1">-- using Lens accessor</code>
<code class="linenos"> 43 </code>        <code class="kt">False</code>
<code class="linenos"> 44 </code>        <code class="n">cardDeck</code>
<code class="linenos"> 45 </code>     
<code class="linenos"> 46 </code>     <code class="c1">-- Use lens extensions for type Table:</code>
<code class="linenos"> 47 </code>            
<code class="linenos"> 48 </code><code class="nf">makeLenses</code> <code class="kt">''Table</code>
<code class="linenos"> 49 </code> 
<code class="linenos"> 50 </code><code class="nf">showDealtCards</code> <code class="ow">::</code> <code class="p">[[</code><code class="kt">Card</code><code class="p">]]</code> <code class="ow">-&gt;</code> <code class="kt">String</code>
<code class="linenos"> 51 </code><code class="nf">showDealtCards</code> <code class="n">dc</code> <code class="ow">=</code>
<code class="linenos"> 52 </code>  <code class="p">(</code><code class="n">show</code> <code class="p">[</code><code class="n">map</code> <code class="n">cardValue</code> <code class="n">hand</code> <code class="o">|</code> <code class="n">hand</code> <code class="ow">&lt;-</code> <code class="n">dc</code><code class="p">])</code>
<code class="linenos"> 53 </code>
<code class="linenos"> 54 </code><code class="nf">setCardDeck</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Card</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos"> 55 </code><code class="nf">setCardDeck</code> <code class="n">newDeck</code> <code class="ow">=</code>
<code class="linenos"> 56 </code>  <code class="n">over</code> <code class="n">cardDeck</code> <code class="p">(</code><code class="nf">\</code><code class="kr">_</code> <code class="ow">-&gt;</code> <code class="n">newDeck</code><code class="p">)</code>  <code class="c1">-- change value to new card deck</code>
<code class="linenos"> 57 </code>
<code class="linenos"> 58 </code><code class="nf">dealCards</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Int</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos"> 59 </code><code class="nf">dealCards</code> <code class="n">aTable</code> <code class="n">playerIndices</code> <code class="ow">=</code>
<code class="linenos"> 60 </code>  <code class="n">last</code> <code class="o">$</code> <code class="n">scanl</code> <code class="n">dealCardToUser</code> <code class="n">aTable</code> <code class="n">playerIndices</code>
<code class="linenos"> 61 </code> 
<code class="linenos"> 62 </code><code class="nf">initialDeal</code> <code class="n">cardDeck</code> <code class="n">aTable</code> <code class="n">numberOfPlayers</code> <code class="ow">=</code>
<code class="linenos"> 63 </code>  <code class="n">dealCards</code>
<code class="linenos"> 64 </code>    <code class="p">(</code><code class="n">dealCards</code> <code class="p">(</code><code class="n">resetTable</code> <code class="n">cardDeck</code> <code class="n">aTable</code> <code class="n">numberOfPlayers</code><code class="p">)</code>
<code class="linenos"> 65 </code>               <code class="p">[</code><code class="mi">0</code> <code class="o">..</code> <code class="n">numberOfPlayers</code><code class="p">])</code>
<code class="linenos"> 66 </code>    <code class="p">[</code><code class="mi">0</code> <code class="o">..</code> <code class="n">numberOfPlayers</code><code class="p">]</code>
<code class="linenos"> 67 </code>    
<code class="linenos"> 68 </code><code class="nf">showTable</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 69 </code><code class="nf">showTable</code> <code class="n">aTable</code> <code class="ow">=</code>
<code class="linenos"> 70 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">Current table data:</code><code class="se">\n</code><code class="s">"</code> <code class="o">++</code>
<code class="linenos"> 71 </code>  <code class="s">"  Chipstacks: "</code> <code class="o">++</code>
<code class="linenos"> 72 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">    Player: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">head</code> <code class="p">(</code><code class="n">_chipStacks</code> <code class="n">aTable</code><code class="p">)))</code> <code class="o">++</code>
<code class="linenos"> 73 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">    Other players: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">tail</code> <code class="p">(</code><code class="n">_chipStacks</code> <code class="n">aTable</code><code class="p">)))</code> <code class="o">++</code>
<code class="linenos"> 74 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">  User cards: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">head</code> <code class="p">(</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">)))</code> <code class="o">++</code>
<code class="linenos"> 75 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">  Dealer cards: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">((</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">)</code> <code class="o">!!</code> <code class="mi">1</code><code class="p">))</code> <code class="o">++</code>
<code class="linenos"> 76 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">  Other player's cards: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">tail</code> <code class="p">(</code><code class="n">tail</code><code class="p">(</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">))))</code> <code class="o">++</code>
<code class="linenos"> 77 </code>  <code class="c1">-- "\n  Dealt cards: " ++ (show (_dealtCards aTable)) ++</code>
<code class="linenos"> 78 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">  Dealt card values: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">showDealtCards</code> <code class="p">(</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">))</code> <code class="o">++</code>
<code class="linenos"> 79 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">  Current player bet: "</code> <code class="o">++</code>
<code class="linenos"> 80 </code>  <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">_currentPlayerBet</code> <code class="n">aTable</code><code class="p">))</code> <code class="o">++</code>
<code class="linenos"> 81 </code>  <code class="s">"</code><code class="se">\n</code><code class="s">  Player pass: "</code> <code class="o">++</code>
<code class="linenos"> 82 </code>  <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">_userPasses</code> <code class="n">aTable</code><code class="p">))</code> <code class="o">++</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 83 </code>  
<code class="linenos"> 84 </code><code class="nf">clipScore</code> <code class="n">aTable</code> <code class="n">playerIndex</code> <code class="ow">=</code>
<code class="linenos"> 85 </code>  <code class="kr">let</code> <code class="n">s</code> <code class="ow">=</code> <code class="n">score</code> <code class="n">aTable</code> <code class="n">playerIndex</code> <code class="kr">in</code>
<code class="linenos"> 86 </code>    <code class="kr">if</code> <code class="n">s</code> <code class="o">&lt;</code> <code class="mi">22</code> <code class="kr">then</code> <code class="n">s</code> <code class="kr">else</code> <code class="mi">0</code>
<code class="linenos"> 87 </code>      
<code class="linenos"> 88 </code><code class="nf">scoreHands</code> <code class="n">aTable</code> <code class="ow">=</code>
<code class="linenos"> 89 </code>  <code class="kr">let</code> <code class="n">chipStacks2</code> <code class="ow">=</code> <code class="n">_chipStacks</code> <code class="n">aTable</code>
<code class="linenos"> 90 </code>      <code class="n">playerScore</code> <code class="ow">=</code> <code class="n">clipScore</code> <code class="n">aTable</code> <code class="mi">0</code>
<code class="linenos"> 91 </code>      <code class="n">dealerScore</code> <code class="ow">=</code> <code class="n">clipScore</code> <code class="n">aTable</code> <code class="mi">1</code>
<code class="linenos"> 92 </code>      <code class="n">otherScores</code> <code class="ow">=</code> <code class="n">map</code> <code class="p">(</code><code class="n">clipScore</code> <code class="n">aTable</code><code class="p">)</code> <code class="p">[</code><code class="mi">2</code><code class="o">..</code><code class="p">]</code>
<code class="linenos"> 93 </code>      <code class="n">newPlayerChipStack</code> <code class="ow">=</code> <code class="kr">if</code> <code class="n">playerScore</code> <code class="o">&gt;</code> <code class="n">dealerScore</code> <code class="kr">then</code>
<code class="linenos"> 94 </code>                             <code class="p">(</code><code class="n">head</code> <code class="n">chipStacks2</code><code class="p">)</code> <code class="o">+</code> <code class="p">(</code><code class="n">_currentPlayerBet</code> <code class="n">aTable</code><code class="p">)</code>
<code class="linenos"> 95 </code>                           <code class="kr">else</code>
<code class="linenos"> 96 </code>                             <code class="kr">if</code> <code class="n">playerScore</code> <code class="o">&lt;</code> <code class="n">dealerScore</code> <code class="kr">then</code>
<code class="linenos"> 97 </code>                                <code class="p">(</code><code class="n">head</code> <code class="n">chipStacks2</code><code class="p">)</code> <code class="o">-</code> <code class="p">(</code><code class="n">_currentPlayerBet</code> <code class="n">aTable</code><code class="p">)</code>
<code class="linenos"> 98 </code>                             <code class="kr">else</code> <code class="p">(</code><code class="n">head</code> <code class="n">chipStacks2</code><code class="p">)</code>
<code class="linenos"> 99 </code>      <code class="n">newOtherChipsStacks</code> <code class="ow">=</code>
<code class="linenos">100 </code>        <code class="n">map</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="kr">if</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="n">dealerScore</code> <code class="kr">then</code>
<code class="linenos">101 </code>                         <code class="n">y</code> <code class="o">+</code> <code class="mi">20</code>
<code class="linenos">102 </code>                       <code class="kr">else</code>
<code class="linenos">103 </code>                         <code class="kr">if</code> <code class="n">x</code> <code class="o">&lt;</code> <code class="n">dealerScore</code> <code class="kr">then</code>
<code class="linenos">104 </code>                           <code class="n">y</code> <code class="o">-</code> <code class="mi">20</code>
<code class="linenos">105 </code>                         <code class="kr">else</code> <code class="n">y</code><code class="p">)</code> 
<code class="linenos">106 </code>            <code class="p">(</code><code class="n">zip</code> <code class="n">otherScores</code> <code class="p">(</code><code class="n">tail</code> <code class="n">chipStacks2</code><code class="p">))</code>
<code class="linenos">107 </code>      <code class="n">newChipStacks</code>  <code class="ow">=</code> <code class="n">newPlayerChipStack</code><code class="kt">:</code><code class="n">newOtherChipsStacks</code>
<code class="linenos">108 </code>  <code class="kr">in</code>
<code class="linenos">109 </code>    <code class="n">over</code> <code class="n">chipStacks</code> <code class="p">(</code><code class="nf">\</code><code class="kr">_</code> <code class="ow">-&gt;</code> <code class="n">newChipStacks</code><code class="p">)</code> <code class="n">aTable</code>
<code class="linenos">110 </code>     
<code class="linenos">111 </code><code class="nf">setPlayerBet</code> <code class="ow">::</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos">112 </code><code class="nf">setPlayerBet</code> <code class="n">newBet</code> <code class="ow">=</code>
<code class="linenos">113 </code>  <code class="n">over</code> <code class="n">currentPlayerBet</code> <code class="p">(</code><code class="nf">\</code><code class="kr">_</code> <code class="ow">-&gt;</code> <code class="n">newBet</code><code class="p">)</code>  
<code class="linenos">114 </code>
<code class="linenos">115 </code><code class="nf">setPlayerPasses</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos">116 </code><code class="nf">setPlayerPasses</code> <code class="n">aTable</code> <code class="ow">=</code>
<code class="linenos">117 </code>  <code class="kr">let</code> <code class="n">numPlayers</code> <code class="ow">=</code> <code class="n">_numPlayers</code> <code class="n">aTable</code>
<code class="linenos">118 </code>      <code class="n">playerIndices</code> <code class="ow">=</code> <code class="p">[</code><code class="mi">1</code><code class="o">..</code><code class="n">numPlayers</code><code class="p">]</code>
<code class="linenos">119 </code>      <code class="n">t1</code> <code class="ow">=</code> <code class="n">over</code> <code class="n">userPasses</code> <code class="p">(</code><code class="nf">\</code><code class="kr">_</code> <code class="ow">-&gt;</code> <code class="kt">True</code><code class="p">)</code> <code class="n">aTable</code>
<code class="linenos">120 </code>      <code class="n">t2</code> <code class="ow">=</code> <code class="n">dealCards</code> <code class="n">t1</code> <code class="n">playerIndices</code>
<code class="linenos">121 </code>      <code class="n">t3</code> <code class="ow">=</code> <code class="n">dealCards</code> <code class="n">t2</code> <code class="n">playerIndices</code>
<code class="linenos">122 </code>      <code class="n">t4</code> <code class="ow">=</code> <code class="n">dealCards</code> <code class="n">t3</code> <code class="n">playerIndices</code>
<code class="linenos">123 </code>  <code class="kr">in</code>
<code class="linenos">124 </code>    <code class="n">t4</code>
<code class="linenos">125 </code>    
<code class="linenos">126 </code>    
<code class="linenos">127 </code><code class="nf">changeChipStack</code> <code class="ow">::</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos">128 </code><code class="nf">changeChipStack</code> <code class="n">playerIndex</code> <code class="n">newValue</code> <code class="ow">=</code>
<code class="linenos">129 </code>  <code class="n">over</code> <code class="n">chipStacks</code> <code class="p">(</code><code class="nf">\</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="o">&amp;</code> <code class="n">element</code> <code class="n">playerIndex</code> <code class="o">.~</code> <code class="n">newValue</code><code class="p">)</code>
<code class="linenos">130 </code>
<code class="linenos">131 </code><code class="nf">scoreOLD</code> <code class="n">aTable</code> <code class="n">playerIndex</code> <code class="ow">=</code>
<code class="linenos">132 </code>  <code class="kr">let</code> <code class="n">scores</code> <code class="ow">=</code> <code class="n">map</code> <code class="n">cardValue</code> <code class="p">((</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">)</code> <code class="o">!!</code> <code class="n">playerIndex</code><code class="p">)</code>
<code class="linenos">133 </code>      <code class="n">totalScore</code> <code class="ow">=</code> <code class="n">sum</code> <code class="n">scores</code> <code class="kr">in</code>
<code class="linenos">134 </code>    <code class="kr">if</code> <code class="n">totalScore</code> <code class="o">&lt;</code> <code class="mi">22</code> <code class="kr">then</code> <code class="n">totalScore</code> <code class="kr">else</code> <code class="mi">0</code>
<code class="linenos">135 </code>
<code class="linenos">136 </code><code class="nf">score</code> <code class="n">aTable</code> <code class="n">playerIndex</code> <code class="ow">=</code>
<code class="linenos">137 </code>  <code class="kr">let</code> <code class="n">scores</code> <code class="ow">=</code> <code class="n">map</code> <code class="n">cardValue</code> <code class="p">((</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">)</code> <code class="o">!!</code> <code class="n">playerIndex</code><code class="p">)</code>
<code class="linenos">138 </code>      <code class="n">totalScore</code> <code class="ow">=</code> <code class="n">sum</code> <code class="n">scores</code> <code class="kr">in</code>
<code class="linenos">139 </code>    <code class="n">totalScore</code>
<code class="linenos">140 </code>  
<code class="linenos">141 </code><code class="nf">dealCardToUser'</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos">142 </code><code class="nf">dealCardToUser'</code> <code class="n">aTable</code> <code class="n">playerIndex</code> <code class="ow">=</code>
<code class="linenos">143 </code>  <code class="kr">let</code> <code class="n">nextCard</code> <code class="ow">=</code> <code class="n">head</code> <code class="o">$</code> <code class="n">_cardDeck</code> <code class="n">aTable</code>
<code class="linenos">144 </code>      <code class="n">playerCards</code> <code class="ow">=</code> <code class="n">nextCard</code> <code class="kt">:</code> <code class="p">((</code><code class="n">_dealtCards</code> <code class="n">aTable</code><code class="p">)</code> <code class="o">!!</code> <code class="n">playerIndex</code><code class="p">)</code>
<code class="linenos">145 </code>      <code class="n">newTable</code> <code class="ow">=</code> <code class="n">over</code> <code class="n">cardDeck</code> <code class="p">(</code><code class="nf">\</code><code class="n">cd</code> <code class="ow">-&gt;</code> <code class="n">tail</code> <code class="n">cd</code><code class="p">)</code> <code class="n">aTable</code> <code class="kr">in</code>
<code class="linenos">146 </code>    <code class="n">over</code> <code class="n">dealtCards</code> <code class="p">(</code><code class="nf">\</code><code class="n">a</code> <code class="ow">-&gt;</code> <code class="n">a</code> <code class="o">&amp;</code> <code class="n">element</code> <code class="n">playerIndex</code> <code class="o">.~</code> <code class="n">playerCards</code><code class="p">)</code> <code class="n">newTable</code>
<code class="linenos">147 </code>
<code class="linenos">148 </code><code class="nf">dealCardToUser</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos">149 </code><code class="nf">dealCardToUser</code> <code class="n">aTable</code> <code class="n">playerIndex</code>
<code class="linenos">150 </code>  <code class="o">|</code> <code class="n">playerIndex</code> <code class="o">==</code> <code class="mi">0</code>  <code class="ow">=</code> <code class="n">dealCardToUser'</code> <code class="n">aTable</code> <code class="n">playerIndex</code> <code class="c1">-- user</code>
<code class="linenos">151 </code>  <code class="o">|</code> <code class="n">otherwise</code>         <code class="ow">=</code> <code class="kr">if</code> <code class="p">(</code><code class="n">score</code> <code class="n">aTable</code> <code class="n">playerIndex</code><code class="p">)</code> <code class="o">&lt;</code> <code class="mi">17</code> <code class="kr">then</code>
<code class="linenos">152 </code>                             <code class="n">dealCardToUser'</code> <code class="n">aTable</code> <code class="n">playerIndex</code>
<code class="linenos">153 </code>                        <code class="kr">else</code> <code class="n">aTable</code>
<code class="linenos">154 </code>  
<code class="linenos">155 </code><code class="nf">handOver</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Bool</code>
<code class="linenos">156 </code><code class="nf">handOver</code> <code class="n">aTable</code> <code class="ow">=</code>
<code class="linenos">157 </code>  <code class="n">_userPasses</code> <code class="n">aTable</code>
</pre></div>

</figure>

<p>In line 48 we use the function <strong>makeLenses</strong> to generate access functions for the type <strong>Table</strong>. We will look in some detail at lines 54-56 where we use the lense <strong>over</strong> function to modify a nested value in a table, returning a new table:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">setCardDeck</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Card</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Table</code>
<code class="linenos">2 </code><code class="nf">setCardDeck</code> <code class="n">newDeck</code> <code class="ow">=</code>
<code class="linenos">3 </code>  <code class="n">over</code> <code class="n">cardDeck</code> <code class="p">(</code><code class="nf">\</code><code class="kr">_</code> <code class="ow">-&gt;</code> <code class="n">newDeck</code><code class="p">)</code>
</pre></div>

</figure>

<p>The expression in line 3 evaluates to a partial function that takes another argument, a table, and returns a new table with the card deck modified. Function <strong>over</strong> expects a function as its second argument. In this example, the inline function ignores the argument it is called with, which would be the old card deck value, and returns the new card deck value which is placed in the table value.</p>

<p>Using lenses can greatly simplify the code to manipulate complex types.</p>

<p>Another place where I am using lenses is in the definition of function <strong>scoreHands</strong> (lines 88-109). On line 109 we are using the <strong>over</strong> function to replace the old player betting chip counts with the new value we have just calculated:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">over</code> <code class="n">chipStacks</code> <code class="p">(</code><code class="nf">\</code><code class="kr">_</code> <code class="ow">-&gt;</code> <code class="n">newChipStacks</code><code class="p">)</code> <code class="n">aTable</code>
</pre></div>

</figure>

<p>Similarly, we use <strong>over</strong> in line 113 to change the current player bet. In function <strong>handOver</strong> on line 157, notice how I am using the generated function <strong>_userPasses</strong> to extract the value of the user passes boolean flag from a table.</p>

<p>The function <strong>main</strong>, defined in the file <em>Main.hs</em>, uses the code we have just seen to represent a table and modify a table, is fairly simple. A main game loop repetitively accepts game user imput, and calls the appropriate functions to modify the current table, producing a new table. Remember that the table data is immutable: we always generate a new table from the old table when we need to modify it.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">Card</code>   <code class="c1">-- pure code</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Table</code>  <code class="c1">-- pure code</code>
<code class="linenos"> 5 </code><code class="kr">import</code> <code class="nn">RandomizedList</code>  <code class="c1">-- impure code</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="nf">printTable</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos"> 8 </code><code class="nf">printTable</code> <code class="n">aTable</code> <code class="ow">=</code>
<code class="linenos"> 9 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="n">showTable</code> <code class="n">aTable</code>
<code class="linenos">10 </code>  
<code class="linenos">11 </code><code class="nf">randomDeck</code> <code class="ow">=</code>
<code class="linenos">12 </code>  <code class="n">randomizedList</code> <code class="n">orderedCardDeck</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="nf">gameLoop</code> <code class="ow">::</code> <code class="kt">Table</code> <code class="ow">-&gt;</code> <code class="kt">Int</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="n">b</code>
<code class="linenos">15 </code><code class="nf">gameLoop</code> <code class="n">aTable</code> <code class="n">numberOfPlayers</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">16 </code>  <code class="n">printTable</code> <code class="n">aTable</code>
<code class="linenos">17 </code>  <code class="n">cardDeck</code> <code class="ow">&lt;-</code> <code class="n">randomDeck</code>
<code class="linenos">18 </code>  <code class="kr">if</code> <code class="p">(</code><code class="n">handOver</code> <code class="n">aTable</code><code class="p">)</code> <code class="kr">then</code>
<code class="linenos">19 </code>    <code class="kr">do</code>
<code class="linenos">20 </code>      <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">Hand over. State of table at the end of the game:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">21 </code>      <code class="n">printTable</code> <code class="n">aTable</code>
<code class="linenos">22 </code>      <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">Newly dealt hand:</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">23 </code>      <code class="n">gameLoop</code> <code class="p">(</code><code class="n">initialDeal</code> <code class="n">cardDeck</code> <code class="p">(</code><code class="n">scoreHands</code> <code class="n">aTable</code><code class="p">)</code>
<code class="linenos">24 </code>                                     <code class="n">numberOfPlayers</code><code class="p">)</code>
<code class="linenos">25 </code>                                     <code class="n">numberOfPlayers</code>
<code class="linenos">26 </code>  <code class="kr">else</code>
<code class="linenos">27 </code>    <code class="kr">do</code>
<code class="linenos">28 </code>      <code class="n">putStrLn</code> <code class="s">"Enter command:"</code>
<code class="linenos">29 </code>      <code class="n">putStrLn</code> <code class="s">"  h)it or set bet to 10, 20, 30; any other key to stay:"</code>
<code class="linenos">30 </code>      <code class="n">command</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
<code class="linenos">31 </code>      <code class="kr">if</code> <code class="n">elem</code> <code class="n">command</code> <code class="p">[</code><code class="s">"10"</code><code class="p">,</code> <code class="s">"20"</code><code class="p">,</code> <code class="s">"30"</code><code class="p">]</code> <code class="kr">then</code>
<code class="linenos">32 </code>        <code class="n">gameLoop</code> <code class="p">(</code><code class="n">setPlayerBet</code> <code class="p">(</code><code class="n">read</code> <code class="n">command</code><code class="p">)</code> <code class="n">aTable</code><code class="p">)</code> <code class="n">numberOfPlayers</code>
<code class="linenos">33 </code>      <code class="kr">else</code>
<code class="linenos">34 </code>        <code class="kr">if</code> <code class="n">command</code> <code class="o">==</code> <code class="s">"h"</code> <code class="kr">then</code>
<code class="linenos">35 </code>          <code class="n">gameLoop</code> <code class="p">(</code><code class="n">dealCards</code> <code class="n">aTable</code> <code class="p">[</code><code class="mi">0</code> <code class="o">..</code> <code class="n">numberOfPlayers</code><code class="p">])</code> <code class="n">numberOfPlayers</code>
<code class="linenos">36 </code>        <code class="kr">else</code>
<code class="linenos">37 </code>          <code class="n">gameLoop</code> <code class="p">(</code><code class="n">setPlayerPasses</code> <code class="p">(</code><code class="n">dealCards</code> <code class="n">aTable</code> <code class="p">[</code><code class="mi">1</code> <code class="o">..</code> <code class="n">numberOfPlayers</code><code class="p">]))</code>
<code class="linenos">38 </code>                    <code class="n">numberOfPlayers</code> 
<code class="linenos">39 </code>             <code class="c1">-- player stays (no new cards)</code>
<code class="linenos">40 </code>  
<code class="linenos">41 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="n">b</code>
<code class="linenos">42 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">43 </code>  <code class="n">putStrLn</code> <code class="s">"Start a game of Blackjack. Besides yourself, how many other"</code>
<code class="linenos">44 </code>  <code class="n">putStrLn</code> <code class="s">"players do you want at the table?"</code>
<code class="linenos">45 </code>  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
<code class="linenos">46 </code>  <code class="kr">let</code> <code class="n">num</code> <code class="ow">=</code> <code class="p">(</code><code class="n">read</code> <code class="n">s</code> <code class="ow">::</code> <code class="kt">Int</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code>
<code class="linenos">47 </code>  <code class="n">cardDeck</code> <code class="ow">&lt;-</code> <code class="n">randomDeck</code>
<code class="linenos">48 </code>  <code class="kr">let</code> <code class="n">aTable</code> <code class="ow">=</code> <code class="n">initialDeal</code> <code class="n">cardDeck</code> <code class="p">(</code><code class="n">createNewTable</code> <code class="n">num</code><code class="p">)</code> <code class="n">num</code>
<code class="linenos">49 </code>  <code class="n">gameLoop</code> <code class="n">aTable</code> <code class="n">num</code>
</pre></div>

</figure>

<p>I encourage you to try playing the game yourself, but if you don’t here is a sample game:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>*Main Card RandomizedList Table&gt; main
<code class="linenos"> 2 </code>Start a game of Blackjack. Besides yourself, how many other
<code class="linenos"> 3 </code>players do you want at the table?
<code class="linenos"> 4 </code>1
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>Current table data:
<code class="linenos"> 7 </code>  Chipstacks: 
<code class="linenos"> 8 </code>    Player: 500
<code class="linenos"> 9 </code>    Other players: [500]
<code class="linenos">10 </code>  User cards: [Card {rank = Three, suit = Clubs},Card {rank = Two, suit = Hearts}]
<code class="linenos">11 </code>  Dealer cards: [Card {rank = Queen, suit = Diamonds},Card {rank = Seven, suit = Clu\
<code class="linenos">12 </code>bs}]
<code class="linenos">13 </code>  Other player's cards: [[Card {rank = King, suit = Hearts},Card {rank = Six, suit =\
<code class="linenos">14 </code> Diamonds}]]
<code class="linenos">15 </code>  Dealt card values: [[3,2],[10,7],[10,6]]
<code class="linenos">16 </code>  Current player bet: 20
<code class="linenos">17 </code>  Player pass: False
<code class="linenos">18 </code>
<code class="linenos">19 </code>Enter command: h)it or set bet to 10, 20, 30; any other key to stay:
<code class="linenos">20 </code>h
<code class="linenos">21 </code>
<code class="linenos">22 </code>Current table data:
<code class="linenos">23 </code>  Chipstacks: 
<code class="linenos">24 </code>    Player: 500
<code class="linenos">25 </code>    Other players: [500]
<code class="linenos">26 </code>  User cards: [Card {rank = Six, suit = Hearts},Card {rank = Three, suit = Clubs},Ca\
<code class="linenos">27 </code>rd {rank = Two, suit = Hearts}]
<code class="linenos">28 </code>  Dealer cards: [Card {rank = Queen, suit = Diamonds},Card {rank = Seven, suit = Clu\
<code class="linenos">29 </code>bs}]
<code class="linenos">30 </code>  Other player's cards: [[Card {rank = Eight, suit = Hearts},Card {rank = King, suit\
<code class="linenos">31 </code> = Hearts},Card {rank = Six, suit = Diamonds}]]
<code class="linenos">32 </code>  Dealt card values: [[6,3,2],[10,7],[8,10,6]]
<code class="linenos">33 </code>  Current player bet: 20
<code class="linenos">34 </code>  Player pass: False
<code class="linenos">35 </code>
<code class="linenos">36 </code>Enter command: h)it or set bet to 10, 20, 30; any other key to stay:
<code class="linenos">37 </code>h
<code class="linenos">38 </code>
<code class="linenos">39 </code>Current table data:
<code class="linenos">40 </code>  Chipstacks: 
<code class="linenos">41 </code>    Player: 500
<code class="linenos">42 </code>    Other players: [500]
<code class="linenos">43 </code>  User cards: [Card {rank = King, suit = Clubs},Card {rank = Six, suit = Hearts},Car\
<code class="linenos">44 </code>d {rank = Three, suit = Clubs},Card {rank = Two, suit = Hearts}]
<code class="linenos">45 </code>  Dealer cards: [Card {rank = Queen, suit = Diamonds},Card {rank = Seven, suit = Clu\
<code class="linenos">46 </code>bs}]
<code class="linenos">47 </code>  Other player's cards: [[Card {rank = Eight, suit = Hearts},Card {rank = King, suit\
<code class="linenos">48 </code> = Hearts},Card {rank = Six, suit = Diamonds}]]
<code class="linenos">49 </code>  Dealt card values: [[10,6,3,2],[10,7],[8,10,6]]
<code class="linenos">50 </code>  Current player bet: 20
<code class="linenos">51 </code>  Player pass: False
<code class="linenos">52 </code>
<code class="linenos">53 </code>Enter command: h)it or set bet to 10, 20, 30; any other key to stay:
<code class="linenos">54 </code>
<code class="linenos">55 </code>Current table data:
<code class="linenos">56 </code>  Chipstacks: 
<code class="linenos">57 </code>    Player: 500
<code class="linenos">58 </code>    Other players: [500]
<code class="linenos">59 </code>  User cards: [Card {rank = King, suit = Clubs},Card {rank = Six, suit = Hearts},Car\
<code class="linenos">60 </code>d {rank = Three, suit = Clubs},Card {rank = Two, suit = Hearts}]
<code class="linenos">61 </code>  Dealer cards: [Card {rank = Queen, suit = Diamonds},Card {rank = Seven, suit = Clu\
<code class="linenos">62 </code>bs}]
<code class="linenos">63 </code>  Other player's cards: [[Card {rank = Eight, suit = Hearts},Card {rank = King, suit\
<code class="linenos">64 </code> = Hearts},Card {rank = Six, suit = Diamonds}]]
<code class="linenos">65 </code>  Dealt card values: [[10,6,3,2],[10,7],[8,10,6]]
<code class="linenos">66 </code>  Current player bet: 20
<code class="linenos">67 </code>  Player pass: True
<code class="linenos">68 </code>
<code class="linenos">69 </code>Hand over. State of table at the end of the game:
<code class="linenos">70 </code>
<code class="linenos">71 </code>Current table data:
<code class="linenos">72 </code>  Chipstacks: 
<code class="linenos">73 </code>    Player: 520
<code class="linenos">74 </code>    Other players: [520]
<code class="linenos">75 </code>  User cards: [Card {rank = King, suit = Clubs},Card {rank = Six, suit = Hearts},Car\
<code class="linenos">76 </code>d {rank = Three, suit = Clubs},Card {rank = Two, suit = Hearts}]
<code class="linenos">77 </code>  Dealer cards: [Card {rank = Queen, suit = Diamonds},Card {rank = Seven, suit = Clu\
<code class="linenos">78 </code>bs}]
<code class="linenos">79 </code>  Other player's cards: [[Card {rank = Eight, suit = Hearts},Card {rank = King, suit\
<code class="linenos">80 </code> = Hearts},Card {rank = Six, suit = Diamonds}]]
<code class="linenos">81 </code>  Dealt card values: [[10,6,3,2],[10,7],[8,10,6]]
<code class="linenos">82 </code>  Current player bet: 20
<code class="linenos">83 </code>  Player pass: True
</pre></div>

</figure>

<p>Here the game user has four cards with values of [10,6,3,2] for a winning score of 21. The dealer has [10,7] for a score of 17 and the other player has [8,10,6], a value greater than 21 so the player went “bust.”</p>

<p>I hope that you enjoyed this last example that demonstrates a reasonable approach for managing state when using immutable data.</p>


<h2 id="leanpub-auto-section-3---larger-projects">Section 3 - Larger Projects</h2>

<p>This section is new for the second edition of this book. So far we have covered the basics of Haskell programming and seen many examples. In this section we look at a few new projects that I derived from my own work and these new examples will hopefully further encourage you to think of novel uses for Haskell in your own work.</p>

<p>The project <strong>knowledge_graph_creator</strong> helps to automate the process of creating Knowledge Graphs from raw text input and generates data for both the Neo4J open source graph database as well as RDF data for use in semantic web and linked data applications. I have also implemented this same application in Common Lisp that is also a new example in the latest edition of my book <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, Or The Savvy Programmer’s Secret Weapon</a> (released September 2019).</p>

<p>The next two chapters in this section are similar in that they both use examples of using Python for Natural Language Processing (NLP) tasks, wrapping the Python code as a REST service, and then writing Haskell clients for these services.</p>

<p>The project <strong>HybridHaskellPythonNlp</strong> uses web services written in Python for natural language processing. The Python web services use the SpaCy library.</p>

<p>The project <strong>HybridHaskellPythonCorefAnaphoraResolution</strong> uses web services written in Python to allow Haskell applications to use deep learning models created with TensorFlow and Keras.</p>

<p>In these last two examples I use REST APIs to access code written in Python. A good alternative that I don’t cover in this book is using the <a href="https://www.servant.dev/">servant library</a> for generating distributed applications.</p>


<h2 id="leanpub-auto-knowledge-graph-creator">Knowledge Graph Creator</h2>

<p>The large project described here processes raw text inputs and generates data for knowledge graphs in formats for both the Neo4J graph database and in RDF format for semantic web and linked data applications.</p>

<p>This application works by identifying entities in text. Example entity types are people, companies, country names, city names, broadcast network names, political party names, and university names. We saw earlier code for detecting entities in the chapter on natural language processing (NLP) and we will reuse this code. We will discuss later three strategies for reusing code from different projects.</p>

<p>The following figure shows part of a Neo4J Knowledge Graph created with the example code. This graph has shortened labels in displayed nodes but Neo4J offers a web browser-based console that lets you interactively explore Knowledge Graphs. We don’t cover setting up Neo4J here so please use the <a href="https://neo4j.com/docs/operations-manual/current/introduction/">Neo4J documentation</a>. As an introduction to RDF data, the semantic web, and linked data you can get free copies of my two books <a href="http://markwatson.com/opencontentdata/book_lisp.pdf">Practical Semantic Web and Linked Data Applications, Common Lisp Edition</a> and <a href="http://markwatson.com/opencontentdata/book_java.pdf">Practical Semantic Web and Linked Data Applications, Java, Scala, Clojure, and JRuby Edition</a>.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 60%">
    <img src="images/neo4j.jpg" alt="Part of a Knowledge Graph shown in Neo4J web application console" style="width: 100%">
    <figcaption>Part of a Knowledge Graph shown in Neo4J web application console</figcaption>
  </figure>
</div>


<p>There are two versions of this project that deal with generating duplicate data in  two ways:</p>

<ul>
  <li>As either Neo4J Cypher data or RDF triples data are created, store generated data in a SQLite embedded database. Check this database before writing new output data.</li>
  <li>Ignore the problem of generating duplicate data and filter out duplicates in the outer processing pipeline that uses the Knowledge Graph Creator as one processing step.</li>
</ul>

<p>For my own work I choose the second method since filtering duplicates is as easy as a few Makefile targets (the following listing is in the file <strong>Makefile</strong> in the directory
<strong>haskell_tutorial_cookbook_examples/knowledge_graph_creator_pure</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>all: gendata rdf cypher

gendata:
	stack build --fast --exec Dev-exe

rdf:
	<code class="nb">echo</code> <code class="s2">"Removing duplicate RDF statements"</code>
	awk <code class="s1">'!visited[$$0]++'</code> out.n3 &gt; output.n3
	rm -f out.n3

cypher:
	<code class="nb">echo</code> <code class="s2">"Removing duplicate Cypher statements"</code>
	awk <code class="s1">'!visited[$$0]++'</code> out.cypher &gt; output.cypher
	rm -f out.cypher
</pre></div>

</figure>

<p>The Haskell KGCreator application we develop here writes output files <em>out.n3</em> (N3 is a RDF data format) and <em>out.cypher</em> (Cypher is the import output format and query language for the Neo4J open source and commercial graph database). The <strong>awk</strong> commands remove duplicate lines and write de-duplicated data to <em>output.n3</em> and <em>output.cypher</em>.</p>

<p>We will use this second approach but the next section provides sufficient information and a link to alternative code in case you are interested in using SQLite to prevent duplicate data generation.</p>

<h4 id="leanpub-auto-notes-for-using-sqlite-to-avoid-duplicates-optional-material">Notes for Using SQLite to Avoid Duplicates (Optional Material)</h4>

<p>We saw two methods of avoiding duplicates in  generated data in the last section. If you want to use the first method for avoiding generating duplicate data, I leave it as an exercise but here are some notes to get you started: you can then modify the example code by using the utility function <strong>Blackboard.h</strong> in the directory <strong>knowledge_graph_creator_pure/src/fileutils</strong> and implement the logic seen below for checking new generated data to see if it is in the SQLite database. This first method as it also is a good example for wrapping the embedded SQLite library in an IO Monad and is left as an exercise, otherwise skip this section.</p>

<p>Before you write either an RDF statement or a Neo4J Cypher data import statement, check to see if the statement has already been written using something like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">check</code> <code class="ow">&lt;-</code> <code class="n">blackboard_check_key</code> <code class="n">new_data_uri</code>
  <code class="kr">if</code> <code class="n">check</code>
     <code class="o">....</code>
</pre></div>

</figure>

<p>and after writing a RDF statement or a Neo4J Cypher data import statement, write it to the temportary SQLite database using something like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">blackboard_write</code> <code class="n">newStatementString</code>
</pre></div>

</figure>

<p>For the rest of the chapter we will use the approach of not keeping track of generated data in SQLite and instead remove duplicates during postprocessing using the standard <strong>awk</strong> command line utility.</p>

<p>This section is optional. In the rest of this chapter we use the example code in <strong>knowledge_graph_creator_pure</strong>.</p>

<h3 id="leanpub-auto-code-layout-for-the-kgcreator-project-and-strategies-for-sharing-haskell-code-between-projects">Code Layout For the KGCreator Project and strategies for sharing Haskell code between projects</h3>

<p>We will reuse the code for finding entities that we studied in an earlier chapter. There are several ways to reuse code from multiple local Haskell projects:</p>

<ul>
  <li>In a project’s cabal file, use relative paths to the source code for other projects. This is my preferred way to work but has the drawback that the stack command <em>sdist</em> to make a distribution tarball will not work with relative paths. If this is a problem for you then create relative symbolic file links to the source directories in other projects.</li>
  <li>In your project’s stack.yaml file, add the other project’s name and path as a <em>extra-deps</em>.</li>
  <li>In library projects, define a <em>packages</em> definition and install the library globally on your system.</li>
</ul>

<p>I almost always use the first method on my projects with dependencies on other local projects I work on and this is also the approach we use here. The relevant lines in the file KGCreator.cabal are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nf">library</code>
<code class="linenos"> 2 </code>  <code class="n">exposed</code><code class="o">-</code><code class="n">modules</code><code class="kt">:</code>
<code class="linenos"> 3 </code>      <code class="kt">CorefWebClient</code>
<code class="linenos"> 4 </code>      <code class="kt">NlpWebClient</code>
<code class="linenos"> 5 </code>      <code class="kt">ClassificationWebClient</code>
<code class="linenos"> 6 </code>      <code class="kt">DirUtils</code>
<code class="linenos"> 7 </code>      <code class="kt">FileUtils</code>
<code class="linenos"> 8 </code>      <code class="kt">BlackBoard</code>
<code class="linenos"> 9 </code>      <code class="kt">GenTriples</code>
<code class="linenos">10 </code>      <code class="kt">GenNeo4jCypher</code>
<code class="linenos">11 </code>      <code class="kt">Apis</code>
<code class="linenos">12 </code>      <code class="kt">Categorize</code>
<code class="linenos">13 </code>      <code class="kt">NlpUtils</code>
<code class="linenos">14 </code>      <code class="kt">Summarize</code>
<code class="linenos">15 </code>      <code class="kt">Entities</code>
<code class="linenos">16 </code>  <code class="n">other</code><code class="o">-</code><code class="n">modules</code><code class="kt">:</code>
<code class="linenos">17 </code>      <code class="kt">Paths_KGCreator</code>
<code class="linenos">18 </code>      <code class="kt">BroadcastNetworkNamesDbPedia</code>
<code class="linenos">19 </code>      <code class="kt">Category1Gram</code>
<code class="linenos">20 </code>      <code class="kt">Category2Gram</code>
<code class="linenos">21 </code>      <code class="kt">CityNamesDbpedia</code>
<code class="linenos">22 </code>      <code class="kt">CompanyNamesDbpedia</code>
<code class="linenos">23 </code>      <code class="kt">CountryNamesDbpedia</code>
<code class="linenos">24 </code>      <code class="kt">PeopleDbPedia</code>
<code class="linenos">25 </code>      <code class="kt">PoliticalPartyNamesDbPedia</code>
<code class="linenos">26 </code>      <code class="kt">Sentence</code>
<code class="linenos">27 </code>      <code class="kt">Stemmer</code>
<code class="linenos">28 </code>      <code class="kt">TradeUnionNamesDbPedia</code>
<code class="linenos">29 </code>      <code class="kt">UniversityNamesDbPedia</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code>  <code class="n">hs</code><code class="o">-</code><code class="n">source</code><code class="o">-</code><code class="n">dirs</code><code class="kt">:</code>
<code class="linenos">32 </code>      <code class="n">src</code>
<code class="linenos">33 </code>      <code class="n">src</code><code class="o">/</code><code class="n">webclients</code>
<code class="linenos">34 </code>      <code class="n">src</code><code class="o">/</code><code class="n">fileutils</code>
<code class="linenos">35 </code>      <code class="n">src</code><code class="o">/</code><code class="n">sw</code>
<code class="linenos">36 </code>      <code class="n">src</code><code class="o">/</code><code class="n">toplevel</code>
<code class="linenos">37 </code>      <code class="o">../</code><code class="kt">NlpTool</code><code class="o">/</code><code class="n">src</code><code class="o">/</code><code class="n">nlp</code>
<code class="linenos">38 </code>      <code class="o">../</code><code class="kt">NlpTool</code><code class="o">/</code><code class="n">src</code><code class="o">/</code><code class="n">nlp</code><code class="o">/</code><code class="kr">data</code>
</pre></div>

</figure>

<p>This is a standard looking <em>cabal</em> file except for lines 37 and 38 where the source paths reference the example code for the <strong>NlpTool</strong> application developed in a previous chapter. The exposed module <strong>BlackBoard</strong> (line 8) is not used but I leave it in the <em>cabal</em> file in case you want to experiment with recording generated data in SQLite to avoid data duplication. You are likely to also want to use <strong>BlackBoard</strong> if you modify this example to continuously process incoming data in a production system. This is left as an exercise.</p>

<p>Before going into too much detail on the implementation let’s look at the layout of the project code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>src/fileutils:
<code class="linenos"> 2 </code>BlackBoard.hs	DirUtils.hs	FileUtils.hs
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code>../NlpTool/src/nlp:
<code class="linenos"> 5 </code>Categorize.hs	Entities.hs	NlpUtils.hs	Sentence.hs	Stemmer.hs	Summarize.hs	data
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code>../NlpTool/src/nlp/data:
<code class="linenos"> 8 </code>BroadcastNetworkNamesDbPedia.hs	CompanyNamesDbpedia.hs		TradeUnionNamesDbPedia.hs
<code class="linenos"> 9 </code>Category1Gram.hs		CountryNamesDbpedia.hs		UniversityNamesDbPedia.hs
<code class="linenos">10 </code>Category2Gram.hs		PeopleDbPedia.hs
<code class="linenos">11 </code>CityNamesDbpedia.hs		PoliticalPartyNamesDbPedia.hs
<code class="linenos">12 </code>
<code class="linenos">13 </code>src/sw:
<code class="linenos">14 </code>GenNeo4jCypher.hs	GenTriples.hs
<code class="linenos">15 </code>
<code class="linenos">16 </code>src/toplevel:
<code class="linenos">17 </code>Apis.hs
</pre></div>

</figure>

<p>As mentioned before, we are using the Haskell source fies in a relative path <strong>../NlpTool/src/…</strong> and the local <strong>src</strong> directory. We discuss this code in the next few sections.</p>

<h3 id="leanpub-auto-the-main-event-detecting-entities-in-text">The Main Event: Detecting Entities in Text</h3>

<p>A primary task in KGCreator is to identify entities (people, places, etc.) in text and then we will create RDF and Neo4J Cypher data statements using these entities, knowledge of the origin of text data and general relationships between entities.</p>

<p>We will use the top level code that we developed earlier that is located in the directory <strong>../NlpTool/src/nlp</strong> (please see the chapter <strong>Natural Language Processing Tools</strong> for more detail):</p>

<ul>
  <li>Categorize.hs - categorizes text into categories like news, religion, business, politics, science, etc.</li>
  <li>Entities.hs - identifies entities like people, companies, places, new broadcast networks, labor unions, etc. in text</li>
  <li>Summarize.hs - creates an extractive summary of text</li>
</ul>

<p>The KGCreator Haskell application looks in a specified directory for text files to process. For each file with a <strong>.txt</strong> extension there should be a matching file with the extension <strong>.meta</strong> that contains a single line: the URI of the web location where the corresponding text was found. The reason we need this is that we want to create graph knowledge data from information found in text sources and the original location of the data is important to preserve. In other words, we want to know where the data elements in our knowledge graph came from.</p>

<p>We have not looked at an example of using command line arguments yet so let’s go into some detail on how we do this.
Previously when we have defined an output target executable in our <strong>.cabal</strong> file,
in this case <em>KGCreator-exe</em>, we could use stack to build the executable and run it with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>stack build --fast --exec KGCreator-exe<code class="s2">"</code>
</pre></div>

</figure>

<p>Now, we have an executable that requires two arguments: a source input directory and the file root for generated RDF and Cypher output files. We can pass command line arguments using this notation:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>stack build --fast --exec <code class="s2">"KGCreator-exe test_data outtest"</code>
</pre></div>

</figure>

<p>The two command line arguments are:</p>

<ul>
  <li>
<strong>test_data</strong> which is the file path of a local directory containing the input files</li>
  <li>
<strong>outtest</strong> which is the root file name for generated Neo4J Cypher and RDF output files</li>
</ul>

<p>If you are using KGCreator in production, then you will want to copy the compiled and linked executable file <strong>KGCreator-exe</strong> to somewhere on your <em>PATH</em> like <em>/usr/local/bin</em>.</p>

<p>The following listing shows the file <strong>app/Main.hs</strong>, the main program for this example that handles command line arguments and calls two top level functions in <strong>src/toplevel/Apis.hs</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">System.Environment</code> <code class="p">(</code><code class="nf">getArgs</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="kr">import</code> <code class="nn">Apis</code> <code class="p">(</code><code class="nf">processFilesToRdf</code><code class="p">,</code> <code class="nf">processFilesToNeo4j</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos"> 7 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 8 </code>  <code class="n">args</code> <code class="ow">&lt;-</code> <code class="n">getArgs</code>
<code class="linenos"> 9 </code>  <code class="kr">case</code> <code class="n">args</code> <code class="kr">of</code>
<code class="linenos">10 </code>    <code class="kt">[]</code> <code class="ow">-&gt;</code> <code class="ne">error</code> <code class="s">"must supply an input directory containing text and meta files"</code>
<code class="linenos">11 </code>    <code class="p">[</code><code class="kr">_</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="ne">error</code> <code class="s">"in addition to an input directory, also specify a root file name f</code><code class="se">\</code>
<code class="linenos">12 </code><code class="nf">or</code> <code class="n">the</code> <code class="n">generated</code> <code class="kt">RDF</code> <code class="n">and</code> <code class="kt">Cypher</code> <code class="n">files</code><code class="s">"</code>
<code class="linenos">13 </code><code class="s">    [inputDir, outputFileRoot] -&gt; do</code>
<code class="linenos">14 </code><code class="s">        processFilesToRdf   inputDir $ outputFileRoot ++ "</code><code class="o">.</code><code class="n">n3</code><code class="s">"</code>
<code class="linenos">15 </code><code class="s">        processFilesToNeo4j inputDir $ outputFileRoot ++ "</code><code class="o">.</code><code class="n">cypher</code><code class="s">"</code>
<code class="linenos">16 </code><code class="s">    _ -&gt; error "</code><code class="n">too</code> <code class="n">many</code> <code class="n">arguments</code><code class="s">"</code>
</pre></div>

</figure>

<p>Here we use <strong>getArgs</strong> in line8 to fetch a list of command line arguments and verify that at least two arguments have been provided. Then we call the functions <strong>processFilesToRdf</strong> and <strong>processFilesToNeo4j</strong> and the functions they call in the next three sections.</p>

<h3 id="leanpub-auto-utility-code-for-generating-rdf">Utility Code for Generating RDF</h3>

<p>The code for generating RDF and for generating Neo4J Cypher data is similar. We start with the code to generate RDF triples. Before we look at the code, let’s start with a few lines of generated RDF:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>&lt;http://dbpedia.org/resource/The_Wall_Street_Journal&gt; 
  &lt;http://knowledgebooks.com/schema/aboutCompanyName&gt; 
  "Wall Street Journal" .
&lt;https://newsshop.com/june/z902.html&gt;
  &lt;http://knowledgebooks.com/schema/containsCountryDbPediaLink&gt;
  &lt;http://dbpedia.org/resource/Canada&gt; .
</pre></div>

</figure>

<p>The next listing shows the file <strong>src/sw/GenTriples.hs</strong> that finds entities like broadcast network names, city names, company names, people’s names, political party names, and university names in text and generates RDF triple data. If you need to add more entity types for your own applications, then use the following steps:</p>

<ul>
  <li>Look at the format of entity data for the <strong>NlpTool</strong> example and add names for the new entity type you  are adding.</li>
  <li>Add a utility function to find instances of the new entity type to <strong>NlpTools</strong>. For example, if you are adding a new entity type “park names”, then copy the code for <strong>companyNames</strong> to <strong>parkNames</strong>, modify as necessary, and export <strong>parkNames</strong>.</li>
  <li>In the following code, add new code for the new entity helper function after lines 10, 97, 151, and 261. Use the code for <strong>companyNames</strong> as an example.</li>
</ul>

<p>The map *category_to_uri_map** created in lines 36 to 84 maps a topic name to a linked Data URI that describes the topic. For example, we would not refer to an information source as being about the topic “economics”, but would instead refer to a linked data URI like <strong><a href="http://knowledgebooks.com/schema/topic/economics">http://knowledgebooks.com/schema/topic/economics</a></strong>. The utility function <strong>uri_from_categor</strong> takes a text description of a topic like “economy” and converts it to an appropriate URI using the map *category_to_uri_map**.</p>

<p>The utility function <strong>textToTriple</strong> takes a file path to a text input file and a path to  meta file path, calculates the text string representing the generated triples for the input text file, and returns the result wrapped in an IO monad.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="kr">module</code> <code class="nn">GenTriples</code>
<code class="linenos">  2 </code>  <code class="p">(</code> <code class="nf">textToTriples</code>
<code class="linenos">  3 </code>  <code class="p">,</code> <code class="nf">category_to_uri_map</code>
<code class="linenos">  4 </code>  <code class="p">)</code> <code class="kr">where</code>
<code class="linenos">  5 </code>
<code class="linenos">  6 </code><code class="kr">import</code> <code class="nn">Categorize</code> <code class="p">(</code><code class="nf">bestCategories</code><code class="p">)</code>
<code class="linenos">  7 </code><code class="kr">import</code> <code class="nn">Entities</code>
<code class="linenos">  8 </code>  <code class="p">(</code> <code class="nf">broadcastNetworkNames</code>
<code class="linenos">  9 </code>  <code class="p">,</code> <code class="nf">cityNames</code>
<code class="linenos"> 10 </code>  <code class="p">,</code> <code class="nf">companyNames</code>
<code class="linenos"> 11 </code>  <code class="p">,</code> <code class="nf">countryNames</code>
<code class="linenos"> 12 </code>  <code class="p">,</code> <code class="nf">peopleNames</code>
<code class="linenos"> 13 </code>  <code class="p">,</code> <code class="nf">politicalPartyNames</code>
<code class="linenos"> 14 </code>  <code class="p">,</code> <code class="nf">tradeUnionNames</code>
<code class="linenos"> 15 </code>  <code class="p">,</code> <code class="nf">universityNames</code>
<code class="linenos"> 16 </code>  <code class="p">)</code>
<code class="linenos"> 17 </code><code class="kr">import</code> <code class="nn">FileUtils</code>
<code class="linenos"> 18 </code>  <code class="p">(</code> <code class="kt">MyMeta</code>
<code class="linenos"> 19 </code>  <code class="p">,</code> <code class="nf">filePathToString</code>
<code class="linenos"> 20 </code>  <code class="p">,</code> <code class="nf">filePathToWordTokens</code>
<code class="linenos"> 21 </code>  <code class="p">,</code> <code class="nf">readMetaFile</code>
<code class="linenos"> 22 </code>  <code class="p">,</code> <code class="nf">uri</code>
<code class="linenos"> 23 </code>  <code class="p">)</code>
<code class="linenos"> 24 </code><code class="kr">import</code> <code class="nn">Summarize</code> <code class="p">(</code><code class="nf">summarize</code><code class="p">,</code> <code class="nf">summarizeS</code><code class="p">)</code>
<code class="linenos"> 25 </code>
<code class="linenos"> 26 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 27 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromMaybe</code><code class="p">)</code>
<code class="linenos"> 28 </code>
<code class="linenos"> 29 </code><code class="nf">generate_triple</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 30 </code><code class="nf">generate_triple</code> <code class="n">s</code> <code class="n">p</code> <code class="n">o</code> <code class="ow">=</code> <code class="n">s</code> <code class="o">++</code> <code class="s">"  "</code> <code class="o">++</code> <code class="n">p</code> <code class="o">++</code> <code class="s">"  "</code> <code class="o">++</code> <code class="n">o</code> <code class="o">++</code> <code class="s">" .</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 31 </code>
<code class="linenos"> 32 </code><code class="nf">make_literal</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 33 </code><code class="nf">make_literal</code> <code class="n">s</code> <code class="ow">=</code> <code class="s">"</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">s</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">"</code>
<code class="linenos"> 34 </code>
<code class="linenos"> 35 </code><code class="nf">category_to_uri_map</code> <code class="ow">::</code> <code class="kt">M</code><code class="o">.</code><code class="kt">Map</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 36 </code><code class="nf">category_to_uri_map</code> <code class="ow">=</code>
<code class="linenos"> 37 </code>  <code class="kt">M</code><code class="o">.</code><code class="n">fromList</code>
<code class="linenos"> 38 </code>    <code class="p">[</code> <code class="p">(</code><code class="s">"news_weather"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/weather&gt;"</code><code class="p">)</code>
<code class="linenos"> 39 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"news_war"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/war&gt;"</code><code class="p">)</code>
<code class="linenos"> 40 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"economics"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/economics&gt;"</code><code class="p">)</code>
<code class="linenos"> 41 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"news_economy"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/economics&gt;"</code><code class="p">)</code>
<code class="linenos"> 42 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"news_politics"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/politics&gt;"</code><code class="p">)</code>
<code class="linenos"> 43 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"religion"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/religion&gt;"</code><code class="p">)</code>
<code class="linenos"> 44 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"religion_buddhism"</code>
<code class="linenos"> 45 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/religion/buddhism&gt;"</code><code class="p">)</code>
<code class="linenos"> 46 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"religion_islam"</code>
<code class="linenos"> 47 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/religion/islam&gt;"</code><code class="p">)</code>
<code class="linenos"> 48 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"religion_christianity"</code>
<code class="linenos"> 49 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/religion/christianity&gt;"</code><code class="p">)</code>
<code class="linenos"> 50 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"religion_hinduism"</code>
<code class="linenos"> 51 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/religion/hinduism&gt;"</code><code class="p">)</code>
<code class="linenos"> 52 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"religion_judaism"</code>
<code class="linenos"> 53 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/religion/judaism&gt;"</code><code class="p">)</code>
<code class="linenos"> 54 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"chemistry"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/chemistry&gt;"</code><code class="p">)</code>
<code class="linenos"> 55 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"computers"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers&gt;"</code><code class="p">)</code>
<code class="linenos"> 56 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"computers_ai"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/ai&gt;"</code><code class="p">)</code>
<code class="linenos"> 57 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers_ai_datamining"</code>
<code class="linenos"> 58 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/ai/datamining&gt;"</code><code class="p">)</code>
<code class="linenos"> 59 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers_ai_learning"</code>
<code class="linenos"> 60 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/ai/learning&gt;"</code><code class="p">)</code>
<code class="linenos"> 61 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers_ai_nlp"</code>
<code class="linenos"> 62 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/ai/nlp&gt;"</code><code class="p">)</code>
<code class="linenos"> 63 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers_ai_search"</code>
<code class="linenos"> 64 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/ai/search&gt;"</code><code class="p">)</code>
<code class="linenos"> 65 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers_ai_textmining"</code>
<code class="linenos"> 66 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/ai/textmining&gt;"</code><code class="p">)</code>
<code class="linenos"> 67 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers/programming"</code>
<code class="linenos"> 68 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/programming&gt;"</code><code class="p">)</code>
<code class="linenos"> 69 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers_microsoft"</code>
<code class="linenos"> 70 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/microsoft&gt;"</code><code class="p">)</code>
<code class="linenos"> 71 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers/programming/ruby"</code>
<code class="linenos"> 72 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/programming/ruby&gt;"</code><code class="p">)</code>
<code class="linenos"> 73 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"computers/programming/lisp"</code>
<code class="linenos"> 74 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/computers/programming/lisp&gt;"</code><code class="p">)</code>
<code class="linenos"> 75 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"health"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/health&gt;"</code><code class="p">)</code>
<code class="linenos"> 76 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"health_exercise"</code>
<code class="linenos"> 77 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/health/exercise&gt;"</code><code class="p">)</code>
<code class="linenos"> 78 </code>    <code class="p">,</code> <code class="p">(</code> <code class="s">"health_nutrition"</code>
<code class="linenos"> 79 </code>      <code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/health/nutrition&gt;"</code><code class="p">)</code>
<code class="linenos"> 80 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"mathematics"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/mathematics&gt;"</code><code class="p">)</code>
<code class="linenos"> 81 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"news_music"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/music&gt;"</code><code class="p">)</code>
<code class="linenos"> 82 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"news_physics"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/physics&gt;"</code><code class="p">)</code>
<code class="linenos"> 83 </code>    <code class="p">,</code> <code class="p">(</code><code class="s">"news_sports"</code><code class="p">,</code> <code class="s">"&lt;http://knowledgebooks.com/schema/topic/sports&gt;"</code><code class="p">)</code>
<code class="linenos"> 84 </code>    <code class="p">]</code>
<code class="linenos"> 85 </code>
<code class="linenos"> 86 </code><code class="nf">uri_from_category</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 87 </code><code class="nf">uri_from_category</code> <code class="n">key</code> <code class="ow">=</code>
<code class="linenos"> 88 </code>  <code class="n">fromMaybe</code> <code class="p">(</code><code class="s">"</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">key</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">"</code><code class="p">)</code> <code class="o">$</code> <code class="kt">M</code><code class="o">.</code><code class="n">lookup</code> <code class="n">key</code> <code class="n">category_to_uri_map</code>
<code class="linenos"> 89 </code>
<code class="linenos"> 90 </code><code class="nf">textToTriples</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 91 </code><code class="nf">textToTriples</code> <code class="n">file_path</code> <code class="n">meta_file_path</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 92 </code>  <code class="n">word_tokens</code> <code class="ow">&lt;-</code> <code class="n">filePathToWordTokens</code> <code class="n">file_path</code>
<code class="linenos"> 93 </code>  <code class="n">contents</code> <code class="ow">&lt;-</code> <code class="n">filePathToString</code> <code class="n">file_path</code>
<code class="linenos"> 94 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"** contents:</code><code class="se">\n</code><code class="s">"</code> <code class="o">++</code> <code class="n">contents</code> <code class="o">++</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 95 </code>  <code class="n">meta_data</code> <code class="ow">&lt;-</code> <code class="n">readMetaFile</code> <code class="n">meta_file_path</code>
<code class="linenos"> 96 </code>  <code class="kr">let</code> <code class="n">people</code> <code class="ow">=</code> <code class="n">peopleNames</code> <code class="n">word_tokens</code>
<code class="linenos"> 97 </code>  <code class="kr">let</code> <code class="n">companies</code> <code class="ow">=</code> <code class="n">companyNames</code> <code class="n">word_tokens</code>
<code class="linenos"> 98 </code>  <code class="kr">let</code> <code class="n">countries</code> <code class="ow">=</code> <code class="n">countryNames</code> <code class="n">word_tokens</code>
<code class="linenos"> 99 </code>  <code class="kr">let</code> <code class="n">cities</code> <code class="ow">=</code> <code class="n">cityNames</code> <code class="n">word_tokens</code>
<code class="linenos">100 </code>  <code class="kr">let</code> <code class="n">broadcast_networks</code> <code class="ow">=</code> <code class="n">broadcastNetworkNames</code> <code class="n">word_tokens</code>
<code class="linenos">101 </code>  <code class="kr">let</code> <code class="n">political_parties</code> <code class="ow">=</code> <code class="n">politicalPartyNames</code> <code class="n">word_tokens</code>
<code class="linenos">102 </code>  <code class="kr">let</code> <code class="n">trade_unions</code> <code class="ow">=</code> <code class="n">tradeUnionNames</code> <code class="n">word_tokens</code>
<code class="linenos">103 </code>  <code class="kr">let</code> <code class="n">universities</code> <code class="ow">=</code> <code class="n">universityNames</code> <code class="n">word_tokens</code>
<code class="linenos">104 </code>  <code class="kr">let</code> <code class="n">a_summary</code> <code class="ow">=</code> <code class="n">summarizeS</code> <code class="n">contents</code>
<code class="linenos">105 </code>  <code class="kr">let</code> <code class="n">the_categories</code> <code class="ow">=</code> <code class="n">bestCategories</code> <code class="n">word_tokens</code>
<code class="linenos">106 </code>  <code class="kr">let</code> <code class="n">filtered_categories</code> <code class="ow">=</code>
<code class="linenos">107 </code>        <code class="n">map</code> <code class="p">(</code><code class="n">uri_from_category</code> <code class="o">.</code> <code class="n">fst</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos">108 </code>        <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">value</code> <code class="o">&gt;</code> <code class="mf">0.3</code><code class="p">)</code> <code class="n">the_categories</code>
<code class="linenos">109 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">filtered_categories:"</code>
<code class="linenos">110 </code>  <code class="n">print</code> <code class="n">filtered_categories</code>
<code class="linenos">111 </code>  <code class="c1">--putStrLn "a_summary:"</code>
<code class="linenos">112 </code>  <code class="c1">--print a_summary</code>
<code class="linenos">113 </code>  <code class="c1">--print $ summarize contents</code>
<code class="linenos">114 </code>
<code class="linenos">115 </code>  <code class="kr">let</code> <code class="n">summary_triples</code> <code class="ow">=</code>
<code class="linenos">116 </code>        <code class="n">generate_triple</code>
<code class="linenos">117 </code>          <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">118 </code>          <code class="s">"&lt;http://knowledgebooks.com/schema/summaryOf&gt;"</code> <code class="o">$</code>
<code class="linenos">119 </code>        <code class="s">"</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">a_summary</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">"</code>
<code class="linenos">120 </code>  <code class="kr">let</code> <code class="n">category_triples</code> <code class="ow">=</code>
<code class="linenos">121 </code>        <code class="n">concat</code>
<code class="linenos">122 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">123 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">124 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/news/category/&gt;"</code>
<code class="linenos">125 </code>            <code class="n">cat</code>
<code class="linenos">126 </code>          <code class="o">|</code> <code class="n">cat</code> <code class="ow">&lt;-</code> <code class="n">filtered_categories</code>
<code class="linenos">127 </code>          <code class="p">]</code>
<code class="linenos">128 </code>  <code class="kr">let</code> <code class="n">people_triples1</code> <code class="ow">=</code>
<code class="linenos">129 </code>        <code class="n">concat</code>
<code class="linenos">130 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">131 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">132 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsPersonDbPediaLink&gt;"</code>
<code class="linenos">133 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">134 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">people</code>
<code class="linenos">135 </code>          <code class="p">]</code>
<code class="linenos">136 </code>  <code class="kr">let</code> <code class="n">people_triples2</code> <code class="ow">=</code>
<code class="linenos">137 </code>        <code class="n">concat</code>
<code class="linenos">138 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">139 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">140 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutPersonName&gt;"</code>
<code class="linenos">141 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">142 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">people</code>
<code class="linenos">143 </code>          <code class="p">]</code>
<code class="linenos">144 </code>  <code class="kr">let</code> <code class="n">company_triples1</code> <code class="ow">=</code>
<code class="linenos">145 </code>        <code class="n">concat</code>
<code class="linenos">146 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">147 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">148 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsCompanyDbPediaLink&gt;"</code>
<code class="linenos">149 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">150 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">companies</code>
<code class="linenos">151 </code>          <code class="p">]</code>
<code class="linenos">152 </code>  <code class="kr">let</code> <code class="n">company_triples2</code> <code class="ow">=</code>
<code class="linenos">153 </code>        <code class="n">concat</code>
<code class="linenos">154 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">155 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">156 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutCompanyName&gt;"</code>
<code class="linenos">157 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">158 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">companies</code>
<code class="linenos">159 </code>          <code class="p">]</code>
<code class="linenos">160 </code>  <code class="kr">let</code> <code class="n">country_triples1</code> <code class="ow">=</code>
<code class="linenos">161 </code>        <code class="n">concat</code>
<code class="linenos">162 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">163 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">164 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsCountryDbPediaLink&gt;"</code>
<code class="linenos">165 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">166 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">countries</code>
<code class="linenos">167 </code>          <code class="p">]</code>
<code class="linenos">168 </code>  <code class="kr">let</code> <code class="n">country_triples2</code> <code class="ow">=</code>
<code class="linenos">169 </code>        <code class="n">concat</code>
<code class="linenos">170 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">171 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">172 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutCountryName&gt;"</code>
<code class="linenos">173 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">174 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">countries</code>
<code class="linenos">175 </code>          <code class="p">]</code>
<code class="linenos">176 </code>  <code class="kr">let</code> <code class="n">city_triples1</code> <code class="ow">=</code>
<code class="linenos">177 </code>        <code class="n">concat</code>
<code class="linenos">178 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">179 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">180 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsCityDbPediaLink&gt;"</code>
<code class="linenos">181 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">182 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">cities</code>
<code class="linenos">183 </code>          <code class="p">]</code>
<code class="linenos">184 </code>  <code class="kr">let</code> <code class="n">city_triples2</code> <code class="ow">=</code>
<code class="linenos">185 </code>        <code class="n">concat</code>
<code class="linenos">186 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">187 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">188 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutCityName&gt;"</code>
<code class="linenos">189 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">190 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">cities</code>
<code class="linenos">191 </code>          <code class="p">]</code>
<code class="linenos">192 </code>  <code class="kr">let</code> <code class="n">bnetworks_triples1</code> <code class="ow">=</code>
<code class="linenos">193 </code>        <code class="n">concat</code>
<code class="linenos">194 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">195 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">196 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsBroadCastDbPediaLink&gt;"</code>
<code class="linenos">197 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">198 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">broadcast_networks</code>
<code class="linenos">199 </code>          <code class="p">]</code>
<code class="linenos">200 </code>  <code class="kr">let</code> <code class="n">bnetworks_triples2</code> <code class="ow">=</code>
<code class="linenos">201 </code>        <code class="n">concat</code>
<code class="linenos">202 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">203 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">204 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutBroadCastName&gt;"</code>
<code class="linenos">205 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">206 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">broadcast_networks</code>
<code class="linenos">207 </code>          <code class="p">]</code>
<code class="linenos">208 </code>  <code class="kr">let</code> <code class="n">pparties_triples1</code> <code class="ow">=</code>
<code class="linenos">209 </code>        <code class="n">concat</code>
<code class="linenos">210 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">211 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">212 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsPoliticalPartyDbPediaLink&gt;"</code>
<code class="linenos">213 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">214 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">political_parties</code>
<code class="linenos">215 </code>          <code class="p">]</code>
<code class="linenos">216 </code>  <code class="kr">let</code> <code class="n">pparties_triples2</code> <code class="ow">=</code>
<code class="linenos">217 </code>        <code class="n">concat</code>
<code class="linenos">218 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">219 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">220 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutPoliticalPartyName&gt;"</code>
<code class="linenos">221 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">222 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">political_parties</code>
<code class="linenos">223 </code>          <code class="p">]</code>
<code class="linenos">224 </code>  <code class="kr">let</code> <code class="n">unions_triples1</code> <code class="ow">=</code>
<code class="linenos">225 </code>        <code class="n">concat</code>
<code class="linenos">226 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">227 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">228 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsTradeUnionDbPediaLink&gt;"</code>
<code class="linenos">229 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">230 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">trade_unions</code>
<code class="linenos">231 </code>          <code class="p">]</code>
<code class="linenos">232 </code>  <code class="kr">let</code> <code class="n">unions_triples2</code> <code class="ow">=</code>
<code class="linenos">233 </code>        <code class="n">concat</code>
<code class="linenos">234 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">235 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">236 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutTradeUnionName&gt;"</code>
<code class="linenos">237 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">238 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">trade_unions</code>
<code class="linenos">239 </code>          <code class="p">]</code>
<code class="linenos">240 </code>  <code class="kr">let</code> <code class="n">universities_triples1</code> <code class="ow">=</code>
<code class="linenos">241 </code>        <code class="n">concat</code>
<code class="linenos">242 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">243 </code>            <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">244 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/containsUniversityDbPediaLink&gt;"</code>
<code class="linenos">245 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">246 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">universities</code>
<code class="linenos">247 </code>          <code class="p">]</code>
<code class="linenos">248 </code>  <code class="kr">let</code> <code class="n">universities_triples2</code> <code class="ow">=</code>
<code class="linenos">249 </code>        <code class="n">concat</code>
<code class="linenos">250 </code>          <code class="p">[</code> <code class="n">generate_triple</code>
<code class="linenos">251 </code>            <code class="p">(</code><code class="n">snd</code> <code class="n">pair</code><code class="p">)</code>
<code class="linenos">252 </code>            <code class="s">"&lt;http://knowledgebooks.com/schema/aboutTradeUnionName&gt;"</code>
<code class="linenos">253 </code>            <code class="p">(</code><code class="n">make_literal</code> <code class="p">(</code><code class="n">fst</code> <code class="n">pair</code><code class="p">))</code>
<code class="linenos">254 </code>          <code class="o">|</code> <code class="n">pair</code> <code class="ow">&lt;-</code> <code class="n">universities</code>
<code class="linenos">255 </code>          <code class="p">]</code>
<code class="linenos">256 </code>  <code class="n">return</code> <code class="o">$</code>
<code class="linenos">257 </code>    <code class="n">concat</code>
<code class="linenos">258 </code>      <code class="p">[</code> <code class="n">people_triples1</code>
<code class="linenos">259 </code>      <code class="p">,</code> <code class="n">people_triples2</code>
<code class="linenos">260 </code>      <code class="p">,</code> <code class="n">company_triples1</code>
<code class="linenos">261 </code>      <code class="p">,</code> <code class="n">company_triples2</code>
<code class="linenos">262 </code>      <code class="p">,</code> <code class="n">country_triples1</code>
<code class="linenos">263 </code>      <code class="p">,</code> <code class="n">country_triples2</code>
<code class="linenos">264 </code>      <code class="p">,</code> <code class="n">city_triples1</code>
<code class="linenos">265 </code>      <code class="p">,</code> <code class="n">city_triples2</code>
<code class="linenos">266 </code>      <code class="p">,</code> <code class="n">bnetworks_triples1</code>
<code class="linenos">267 </code>      <code class="p">,</code> <code class="n">bnetworks_triples2</code>
<code class="linenos">268 </code>      <code class="p">,</code> <code class="n">pparties_triples1</code>
<code class="linenos">269 </code>      <code class="p">,</code> <code class="n">pparties_triples2</code>
<code class="linenos">270 </code>      <code class="p">,</code> <code class="n">unions_triples1</code>
<code class="linenos">271 </code>      <code class="p">,</code> <code class="n">unions_triples2</code>
<code class="linenos">272 </code>      <code class="p">,</code> <code class="n">universities_triples1</code>
<code class="linenos">273 </code>      <code class="p">,</code> <code class="n">universities_triples2</code>
<code class="linenos">274 </code>      <code class="p">,</code> <code class="n">category_triples</code>
<code class="linenos">275 </code>      <code class="p">,</code> <code class="n">summary_triples</code>
<code class="linenos">276 </code>      <code class="p">]</code>
</pre></div>

</figure>

<p>The code in this file could be shortened but having repetitive code for each entity type hopefully makes it easier for you to understand how it works.</p>

<h3 id="leanpub-auto-utility-code-for-generating-cypher-input-data-for-neo4j">Utility Code for Generating Cypher Input Data for Neo4J</h3>

<p>Now we will generate Neo4J Cypher data. In order to keep the implementation simple, both the RDF and Cypher generation code starts with raw text and performs the NLP analysis to find entities. This example could be refactored to perform the NLP analysis just one time but in practice you will likely be working with either RDF or NEO4J and so you will probably extract just the code you need from this example (i.e., either the RDF or Cypher generation code).</p>

<p>Before we look at the code, let’s start with a few lines of generated Neo4J Cypher import data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="n">newsshop_com_june_z902_html_news</code><code class="p">)</code><code class="o">-[</code><code class="n">:ContainsCompanyDbPediaLink</code><code class="o">]-&gt;</code><code class="p">(</code><code class="n">Wall_Stree</code><code class="err">\</code><code class="w"></code>
<code class="n">t_Journal</code><code class="p">)</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="nl">Canada</code><code class="p">:</code><code class="n">Entity</code><code class="w"> </code><code class="err">{</code><code class="nl">name</code><code class="p">:</code><code class="ss">"Canada"</code><code class="p">,</code><code class="w"> </code><code class="nl">uri</code><code class="p">:</code><code class="ss">"&lt;http://dbpedia.org/resource/Canada&gt;"</code><code class="err">}</code><code class="p">)</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="n">newsshop_com_june_z902_html_news</code><code class="p">)</code><code class="o">-[</code><code class="n">:ContainsCountryDbPediaLink</code><code class="o">]-&gt;</code><code class="p">(</code><code class="n">Canada</code><code class="p">)</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="n">summary_of_abcnews_go_com_US_violent_long_lasting_tornadoes_threaten_oklahom</code><code class="err">\</code><code class="w"></code>
<code class="nl">a_texas_storyid63146361</code><code class="p">:</code><code class="n">Summary</code><code class="w"> </code><code class="err">{</code><code class="nl">name</code><code class="p">:</code><code class="ss">"summary_of_abcnews_go_com_US_violent_long_las\</code>
<code class="ss">ting_tornadoes_threaten_oklahoma_texas_storyid63146361"</code><code class="p">,</code><code class="w"> </code><code class="nl">uri</code><code class="p">:</code><code class="ss">"&lt;https://abcnews.go.co\</code>
<code class="ss">m/US/violent-long-lasting-tornadoes-threaten-oklahoma-texas/story?id=63146361&gt;"</code><code class="p">,</code><code class="w"> </code><code class="nf">sum</code><code class="err">\</code><code class="w"></code>
<code class="nl">mary</code><code class="p">:</code><code class="ss">"Part of the system that delivered severe weather to the central U.S. over the \</code>
<code class="ss">weekend is moving into the Northeast today, producing strong to severe storms -- dam\</code>
<code class="ss">aging winds, hail or isolated tornadoes can't be ruled out. Severe weather is foreca\</code>
<code class="ss">st to continue on Tuesday, with the western storm moving east into the Midwest and p\</code>
<code class="ss">arts of the mid-Mississippi Valley."</code><code class="err">}</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>The following listing shows the file <strong>src/sw/GenNeo4jCypher.hs</strong>. This code is very similar to the code for generating RDF in the last section. The same notes for adding your own new entity notes in the last section are also relevant here.</p>

<p>Notice that we import in line 29 the map <strong>category_to_uri_map</strong> that was defined in the last section. The function <strong>neo4j_category_node_defs</strong> defined in lines 35 to 43 creates category graph nodes for each category in the map <strong>category_to_uri_map</strong>.  These nodes will be referenced by graph nodes created in the functions <strong>create_neo4j_node</strong>, <strong>create_neo4j_lin</strong>, <strong>create_summary_node</strong>, and <strong>create_entity_node</strong>. The top level function is <strong>textToCypher</strong> that is similar to the function <strong>textToTriples</strong> in the last section.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="kr">module</code> <code class="nn">GenNeo4jCypher</code>
<code class="linenos">  4 </code>  <code class="p">(</code> <code class="nf">textToCypher</code>
<code class="linenos">  5 </code>  <code class="p">,</code> <code class="nf">neo4j_category_node_defs</code>
<code class="linenos">  6 </code>  <code class="p">)</code> <code class="kr">where</code>
<code class="linenos">  7 </code>
<code class="linenos">  8 </code><code class="kr">import</code> <code class="nn">Categorize</code> <code class="p">(</code><code class="nf">bestCategories</code><code class="p">)</code>
<code class="linenos">  9 </code><code class="kr">import</code> <code class="nn">Data.List</code> <code class="p">(</code><code class="nf">isInfixOf</code><code class="p">)</code>
<code class="linenos"> 10 </code><code class="kr">import</code> <code class="nn">Data.Char</code> <code class="p">(</code><code class="nf">toLower</code><code class="p">)</code>
<code class="linenos"> 11 </code><code class="kr">import</code> <code class="nn">Data.String.Utils</code> <code class="p">(</code><code class="nf">replace</code><code class="p">)</code>
<code class="linenos"> 12 </code><code class="kr">import</code> <code class="nn">Entities</code>
<code class="linenos"> 13 </code>  <code class="p">(</code> <code class="nf">broadcastNetworkNames</code>
<code class="linenos"> 14 </code>  <code class="p">,</code> <code class="nf">cityNames</code>
<code class="linenos"> 15 </code>  <code class="p">,</code> <code class="nf">companyNames</code>
<code class="linenos"> 16 </code>  <code class="p">,</code> <code class="nf">countryNames</code>
<code class="linenos"> 17 </code>  <code class="p">,</code> <code class="nf">peopleNames</code>
<code class="linenos"> 18 </code>  <code class="p">,</code> <code class="nf">politicalPartyNames</code>
<code class="linenos"> 19 </code>  <code class="p">,</code> <code class="nf">tradeUnionNames</code>
<code class="linenos"> 20 </code>  <code class="p">,</code> <code class="nf">universityNames</code>
<code class="linenos"> 21 </code>  <code class="p">)</code>
<code class="linenos"> 22 </code><code class="kr">import</code> <code class="nn">FileUtils</code>
<code class="linenos"> 23 </code>  <code class="p">(</code> <code class="kt">MyMeta</code>
<code class="linenos"> 24 </code>  <code class="p">,</code> <code class="nf">filePathToString</code>
<code class="linenos"> 25 </code>  <code class="p">,</code> <code class="nf">filePathToWordTokens</code>
<code class="linenos"> 26 </code>  <code class="p">,</code> <code class="nf">readMetaFile</code>
<code class="linenos"> 27 </code>  <code class="p">,</code> <code class="nf">uri</code>
<code class="linenos"> 28 </code>  <code class="p">)</code>
<code class="linenos"> 29 </code><code class="kr">import</code> <code class="nn">GenTriples</code> <code class="p">(</code><code class="nf">category_to_uri_map</code><code class="p">)</code>
<code class="linenos"> 30 </code><code class="kr">import</code> <code class="nn">Summarize</code> <code class="p">(</code><code class="nf">summarize</code><code class="p">,</code> <code class="nf">summarizeS</code><code class="p">)</code>
<code class="linenos"> 31 </code>
<code class="linenos"> 32 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Data.Map</code> <code class="k">as</code> <code class="n">M</code>
<code class="linenos"> 33 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromMaybe</code><code class="p">)</code>
<code class="linenos"> 34 </code><code class="kr">import</code> <code class="nn">Database.SQLite.Simple</code>
<code class="linenos"> 35 </code>
<code class="linenos"> 36 </code><code class="c1">-- for debug:</code>
<code class="linenos"> 37 </code><code class="kr">import</code> <code class="nn">Data.Typeable</code> <code class="p">(</code><code class="nf">typeOf</code><code class="p">)</code>
<code class="linenos"> 38 </code>
<code class="linenos"> 39 </code><code class="nf">neo4j_category_node_defs</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 40 </code><code class="nf">neo4j_category_node_defs</code> <code class="ow">=</code>
<code class="linenos"> 41 </code>  <code class="n">replace</code>
<code class="linenos"> 42 </code>    <code class="s">"/"</code>
<code class="linenos"> 43 </code>    <code class="s">"_"</code>
<code class="linenos"> 44 </code>    <code class="o">$</code> <code class="n">concat</code>
<code class="linenos"> 45 </code>    <code class="p">[</code> <code class="s">"CREATE ("</code> <code class="o">++</code> <code class="n">c</code> <code class="o">++</code> <code class="s">":CategoryType {name:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">c</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">})</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 46 </code>    <code class="o">|</code> <code class="n">c</code> <code class="ow">&lt;-</code> <code class="kt">M</code><code class="o">.</code><code class="n">keys</code> <code class="n">category_to_uri_map</code>
<code class="linenos"> 47 </code>    <code class="p">]</code>
<code class="linenos"> 48 </code>
<code class="linenos"> 49 </code><code class="nf">uri_from_category</code> <code class="ow">::</code> <code class="n">p</code> <code class="ow">-&gt;</code> <code class="n">p</code>
<code class="linenos"> 50 </code><code class="nf">uri_from_category</code> <code class="n">s</code> <code class="ow">=</code> <code class="n">s</code> <code class="c1">-- might want the full version from GenTriples</code>
<code class="linenos"> 51 </code>
<code class="linenos"> 52 </code><code class="nf">repl</code> <code class="ow">::</code> <code class="kt">Char</code> <code class="ow">-&gt;</code> <code class="kt">Char</code>
<code class="linenos"> 53 </code><code class="nf">repl</code> <code class="sc">'-'</code> <code class="ow">=</code> <code class="sc">'_'</code>
<code class="linenos"> 54 </code><code class="nf">repl</code> <code class="sc">'/'</code> <code class="ow">=</code> <code class="sc">'_'</code>
<code class="linenos"> 55 </code><code class="nf">repl</code> <code class="sc">'.'</code> <code class="ow">=</code> <code class="sc">'_'</code>
<code class="linenos"> 56 </code><code class="nf">repl</code> <code class="n">c</code> <code class="ow">=</code> <code class="n">c</code>
<code class="linenos"> 57 </code>
<code class="linenos"> 58 </code><code class="nf">filterChars</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 59 </code><code class="nf">filterChars</code> <code class="ow">=</code> <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="n">c</code> <code class="ow">-&gt;</code> <code class="n">c</code> <code class="o">/=</code> <code class="sc">'?'</code> <code class="o">&amp;&amp;</code> <code class="n">c</code> <code class="o">/=</code> <code class="sc">'='</code> <code class="o">&amp;&amp;</code> <code class="n">c</code> <code class="o">/=</code> <code class="sc">'&lt;'</code> <code class="o">&amp;&amp;</code> <code class="n">c</code> <code class="o">/=</code> <code class="sc">'&gt;'</code><code class="p">)</code>
<code class="linenos"> 60 </code>
<code class="linenos"> 61 </code><code class="nf">create_neo4j_node</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">([</code><code class="kt">Char</code><code class="p">],</code> <code class="p">[</code><code class="kt">Char</code><code class="p">])</code>
<code class="linenos"> 62 </code><code class="nf">create_neo4j_node</code> <code class="n">uri</code> <code class="ow">=</code>
<code class="linenos"> 63 </code>  <code class="kr">let</code> <code class="n">name</code> <code class="ow">=</code>
<code class="linenos"> 64 </code>        <code class="p">(</code><code class="n">map</code> <code class="n">repl</code> <code class="p">(</code><code class="n">filterChars</code>
<code class="linenos"> 65 </code>                    <code class="p">(</code><code class="n">replace</code> <code class="s">"https://"</code> <code class="s">""</code> <code class="p">(</code><code class="n">replace</code> <code class="s">"http://"</code> <code class="s">""</code> <code class="n">uri</code><code class="p">))))</code> <code class="o">++</code>
<code class="linenos"> 66 </code>                    <code class="s">"_"</code> <code class="o">++</code>
<code class="linenos"> 67 </code>                    <code class="p">(</code><code class="n">map</code> <code class="n">toLower</code> <code class="n">node_type</code><code class="p">)</code>
<code class="linenos"> 68 </code>      <code class="n">node_type</code> <code class="ow">=</code>
<code class="linenos"> 69 </code>        <code class="kr">if</code> <code class="n">isInfixOf</code> <code class="s">"dbpedia"</code> <code class="n">uri</code>
<code class="linenos"> 70 </code>          <code class="kr">then</code> <code class="s">"DbPedia"</code>
<code class="linenos"> 71 </code>          <code class="kr">else</code> <code class="s">"News"</code>
<code class="linenos"> 72 </code>      <code class="n">new_node</code> <code class="ow">=</code>
<code class="linenos"> 73 </code>        <code class="s">"CREATE ("</code> <code class="o">++</code>
<code class="linenos"> 74 </code>        <code class="n">name</code> <code class="o">++</code> <code class="s">":"</code> <code class="o">++</code>
<code class="linenos"> 75 </code>        <code class="n">node_type</code> <code class="o">++</code> <code class="s">" {name:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="p">(</code><code class="n">replace</code> <code class="s">" "</code> <code class="s">"_"</code> <code class="n">name</code><code class="p">)</code> <code class="o">++</code>
<code class="linenos"> 76 </code>        <code class="s">"</code><code class="se">\"</code><code class="s">, uri:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">uri</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">})</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 77 </code>   <code class="kr">in</code> <code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">new_node</code><code class="p">)</code>
<code class="linenos"> 78 </code>
<code class="linenos"> 79 </code><code class="nf">create_neo4j_link</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 80 </code><code class="nf">create_neo4j_link</code> <code class="n">node1</code> <code class="n">linkName</code> <code class="n">node2</code> <code class="ow">=</code>
<code class="linenos"> 81 </code>  <code class="s">"CREATE ("</code> <code class="o">++</code> <code class="n">node1</code> <code class="o">++</code> <code class="s">")-[:"</code> <code class="o">++</code> <code class="n">linkName</code> <code class="o">++</code> <code class="s">"]-&gt;("</code> <code class="o">++</code> <code class="n">node2</code> <code class="o">++</code> <code class="s">")</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 82 </code>
<code class="linenos"> 83 </code><code class="nf">create_summary_node</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 84 </code><code class="nf">create_summary_node</code> <code class="n">uri</code> <code class="n">summary</code> <code class="ow">=</code>
<code class="linenos"> 85 </code>  <code class="kr">let</code> <code class="n">name</code> <code class="ow">=</code>
<code class="linenos"> 86 </code>        <code class="s">"summary_of_"</code> <code class="o">++</code>
<code class="linenos"> 87 </code>        <code class="p">(</code><code class="n">map</code> <code class="n">repl</code> <code class="o">$</code>
<code class="linenos"> 88 </code>         <code class="n">filterChars</code> <code class="p">(</code><code class="n">replace</code> <code class="s">"https://"</code> <code class="s">""</code> <code class="p">(</code><code class="n">replace</code> <code class="s">"http://"</code> <code class="s">""</code> <code class="n">uri</code><code class="p">)))</code>
<code class="linenos"> 89 </code>      <code class="n">s1</code> <code class="ow">=</code> <code class="s">"CREATE ("</code> <code class="o">++</code> <code class="n">name</code> <code class="o">++</code> <code class="s">":Summary {name:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">name</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">, uri:</code><code class="se">\"</code><code class="s">"</code>
<code class="linenos"> 90 </code>      <code class="n">s2</code> <code class="ow">=</code> <code class="n">uri</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">, summary:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="n">summary</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">})</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 91 </code>   <code class="kr">in</code> <code class="n">s1</code> <code class="o">++</code> <code class="n">s2</code>
<code class="linenos"> 92 </code>
<code class="linenos"> 93 </code><code class="nf">create_entity_node</code> <code class="ow">::</code> <code class="p">([</code><code class="kt">Char</code><code class="p">],</code> <code class="p">[</code><code class="kt">Char</code><code class="p">])</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos"> 94 </code><code class="nf">create_entity_node</code> <code class="n">entity_pair</code> <code class="ow">=</code> 
<code class="linenos"> 95 </code>  <code class="s">"CREATE ("</code> <code class="o">++</code> <code class="p">(</code><code class="n">replace</code> <code class="s">" "</code> <code class="s">"_"</code> <code class="p">(</code><code class="n">fst</code> <code class="n">entity_pair</code><code class="p">))</code> <code class="o">++</code> 
<code class="linenos"> 96 </code>  <code class="s">":Entity {name:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code> <code class="p">(</code><code class="n">fst</code> <code class="n">entity_pair</code><code class="p">)</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">, uri:</code><code class="se">\"</code><code class="s">"</code> <code class="o">++</code>
<code class="linenos"> 97 </code>  <code class="p">(</code><code class="n">snd</code> <code class="n">entity_pair</code><code class="p">)</code> <code class="o">++</code> <code class="s">"</code><code class="se">\"</code><code class="s">})</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 98 </code>
<code class="linenos"> 99 </code><code class="nf">create_contains_entity</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">([</code><code class="kt">Char</code><code class="p">],</code> <code class="p">[</code><code class="kt">Char</code><code class="p">])</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">100 </code><code class="nf">create_contains_entity</code> <code class="n">relation_name</code> <code class="n">source_uri</code> <code class="n">entity_pair</code> <code class="ow">=</code>
<code class="linenos">101 </code>  <code class="kr">let</code> <code class="n">new_person_node</code> <code class="ow">=</code> <code class="n">create_entity_node</code> <code class="n">entity_pair</code>
<code class="linenos">102 </code>      <code class="n">new_link</code> <code class="ow">=</code> <code class="n">create_neo4j_link</code> <code class="n">source_uri</code>
<code class="linenos">103 </code>                   <code class="n">relation_name</code>
<code class="linenos">104 </code>                   <code class="p">(</code><code class="n">replace</code> <code class="s">" "</code> <code class="s">"_"</code> <code class="p">(</code><code class="n">fst</code> <code class="n">entity_pair</code><code class="p">))</code>
<code class="linenos">105 </code>  <code class="kr">in</code>
<code class="linenos">106 </code>    <code class="p">(</code><code class="n">new_person_node</code> <code class="o">++</code> <code class="n">new_link</code><code class="p">)</code>
<code class="linenos">107 </code>
<code class="linenos">108 </code><code class="nf">entity_node_helper</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="p">[([</code><code class="kt">Char</code><code class="p">],</code> <code class="p">[</code><code class="kt">Char</code><code class="p">])]</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">109 </code><code class="nf">entity_node_helper</code> <code class="n">relation_name</code> <code class="n">node_name</code> <code class="n">entity_list</code> <code class="ow">=</code>
<code class="linenos">110 </code>  <code class="n">concat</code> <code class="p">[</code><code class="n">create_contains_entity</code>
<code class="linenos">111 </code>           <code class="n">relation_name</code> <code class="n">node_name</code> <code class="n">entity</code> <code class="o">|</code> <code class="n">entity</code> <code class="ow">&lt;-</code> <code class="n">entity_list</code><code class="p">]</code>
<code class="linenos">112 </code>
<code class="linenos">113 </code><code class="nf">textToCypher</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">114 </code><code class="nf">textToCypher</code> <code class="n">file_path</code> <code class="n">meta_file_path</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">115 </code>  <code class="kr">let</code> <code class="n">prelude_nodes</code> <code class="ow">=</code> <code class="n">neo4j_category_node_defs</code>
<code class="linenos">116 </code>  <code class="n">putStrLn</code> <code class="s">"+++++++++++++++++ prelude node defs:"</code>
<code class="linenos">117 </code>  <code class="n">print</code> <code class="n">prelude_nodes</code>
<code class="linenos">118 </code>  <code class="n">word_tokens</code> <code class="ow">&lt;-</code> <code class="n">filePathToWordTokens</code> <code class="n">file_path</code>
<code class="linenos">119 </code>  <code class="n">contents</code> <code class="ow">&lt;-</code> <code class="n">filePathToString</code> <code class="n">file_path</code>
<code class="linenos">120 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"** contents:</code><code class="se">\n</code><code class="s">"</code> <code class="o">++</code> <code class="n">contents</code> <code class="o">++</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">121 </code>  <code class="n">meta_data</code> <code class="ow">&lt;-</code> <code class="n">readMetaFile</code> <code class="n">meta_file_path</code>
<code class="linenos">122 </code>  <code class="n">putStrLn</code> <code class="s">"++ meta_data:"</code>
<code class="linenos">123 </code>  <code class="n">print</code> <code class="n">meta_data</code>
<code class="linenos">124 </code>  <code class="kr">let</code> <code class="n">people</code> <code class="ow">=</code> <code class="n">peopleNames</code> <code class="n">word_tokens</code>
<code class="linenos">125 </code>  <code class="kr">let</code> <code class="n">companies</code> <code class="ow">=</code> <code class="n">companyNames</code> <code class="n">word_tokens</code>
<code class="linenos">126 </code>  <code class="n">putStrLn</code> <code class="s">"^^^^ companies:"</code>
<code class="linenos">127 </code>  <code class="n">print</code> <code class="n">companies</code>
<code class="linenos">128 </code>  <code class="kr">let</code> <code class="n">countries</code> <code class="ow">=</code> <code class="n">countryNames</code> <code class="n">word_tokens</code>
<code class="linenos">129 </code>  <code class="kr">let</code> <code class="n">cities</code> <code class="ow">=</code> <code class="n">cityNames</code> <code class="n">word_tokens</code>
<code class="linenos">130 </code>  <code class="kr">let</code> <code class="n">broadcast_networks</code> <code class="ow">=</code> <code class="n">broadcastNetworkNames</code> <code class="n">word_tokens</code>
<code class="linenos">131 </code>  <code class="kr">let</code> <code class="n">political_parties</code> <code class="ow">=</code> <code class="n">politicalPartyNames</code> <code class="n">word_tokens</code>
<code class="linenos">132 </code>  <code class="kr">let</code> <code class="n">trade_unions</code> <code class="ow">=</code> <code class="n">tradeUnionNames</code> <code class="n">word_tokens</code>
<code class="linenos">133 </code>  <code class="kr">let</code> <code class="n">universities</code> <code class="ow">=</code> <code class="n">universityNames</code> <code class="n">word_tokens</code>
<code class="linenos">134 </code>  <code class="kr">let</code> <code class="n">a_summary</code> <code class="ow">=</code> <code class="n">summarizeS</code> <code class="n">contents</code>
<code class="linenos">135 </code>  <code class="kr">let</code> <code class="n">the_categories</code> <code class="ow">=</code> <code class="n">bestCategories</code> <code class="n">word_tokens</code>
<code class="linenos">136 </code>  <code class="kr">let</code> <code class="n">filtered_categories</code> <code class="ow">=</code>
<code class="linenos">137 </code>        <code class="n">map</code> <code class="p">(</code><code class="n">uri_from_category</code> <code class="o">.</code> <code class="n">fst</code><code class="p">)</code> <code class="o">$</code>
<code class="linenos">138 </code>        <code class="n">filter</code> <code class="p">(</code><code class="nf">\</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">value</code> <code class="o">&gt;</code> <code class="mf">0.3</code><code class="p">)</code> <code class="n">the_categories</code>
<code class="linenos">139 </code>  <code class="n">putStrLn</code> <code class="s">"</code><code class="se">\n</code><code class="s">filtered_categories:"</code>
<code class="linenos">140 </code>  <code class="n">print</code> <code class="n">filtered_categories</code>
<code class="linenos">141 </code>  <code class="kr">let</code> <code class="p">(</code><code class="n">node1_name</code><code class="p">,</code> <code class="n">node1</code><code class="p">)</code> <code class="ow">=</code> <code class="n">create_neo4j_node</code> <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code>
<code class="linenos">142 </code>  <code class="kr">let</code> <code class="n">summary1</code> <code class="ow">=</code> <code class="n">create_summary_node</code> <code class="p">(</code><code class="n">uri</code> <code class="n">meta_data</code><code class="p">)</code> <code class="n">a_summary</code>
<code class="linenos">143 </code>  <code class="kr">let</code> <code class="n">category1</code> <code class="ow">=</code>
<code class="linenos">144 </code>        <code class="n">concat</code>
<code class="linenos">145 </code>          <code class="p">[</code> <code class="n">create_neo4j_link</code> <code class="n">node1_name</code> <code class="s">"Category"</code> <code class="n">cat</code>
<code class="linenos">146 </code>          <code class="o">|</code> <code class="n">cat</code> <code class="ow">&lt;-</code> <code class="n">filtered_categories</code>
<code class="linenos">147 </code>          <code class="p">]</code>
<code class="linenos">148 </code>  <code class="kr">let</code> <code class="n">pp</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsPersonDbPediaLink"</code> <code class="n">node1_name</code> <code class="n">people</code>
<code class="linenos">149 </code>  <code class="kr">let</code> <code class="n">cmpny</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsCompanyDbPediaLink"</code> <code class="n">node1_name</code> <code class="n">companies</code>
<code class="linenos">150 </code>  <code class="kr">let</code> <code class="n">cntry</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsCountryDbPediaLink"</code> <code class="n">node1_name</code> <code class="n">countries</code>
<code class="linenos">151 </code>  <code class="kr">let</code> <code class="n">citys</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsCityDbPediaLink"</code> <code class="n">node1_name</code> <code class="n">cities</code>
<code class="linenos">152 </code>  <code class="kr">let</code> <code class="n">bnet</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsBroadcastNetworkDbPediaLink"</code>
<code class="linenos">153 </code>                                <code class="n">node1_name</code> <code class="n">broadcast_networks</code>
<code class="linenos">154 </code>  <code class="kr">let</code> <code class="n">ppart</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsPoliticalPartyDbPediaLink"</code>
<code class="linenos">155 </code>                                <code class="n">node1_name</code> <code class="n">political_parties</code>
<code class="linenos">156 </code>  <code class="kr">let</code> <code class="n">tunion</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsTradeUnionDbPediaLink"</code>
<code class="linenos">157 </code>                                  <code class="n">node1_name</code> <code class="n">trade_unions</code>
<code class="linenos">158 </code>  <code class="kr">let</code> <code class="n">uni</code> <code class="ow">=</code> <code class="n">entity_node_helper</code> <code class="s">"ContainsUniversityDbPediaLink"</code>
<code class="linenos">159 </code>                               <code class="n">node1_name</code> <code class="n">universities</code>
<code class="linenos">160 </code>  <code class="n">return</code> <code class="o">$</code> <code class="n">concat</code> <code class="p">[</code><code class="n">node1</code><code class="p">,</code> <code class="n">summary1</code><code class="p">,</code> <code class="n">category1</code><code class="p">,</code> <code class="n">pp</code><code class="p">,</code> <code class="n">cmpny</code><code class="p">,</code> <code class="n">cntry</code><code class="p">,</code> <code class="n">citys</code><code class="p">,</code> <code class="n">bnet</code><code class="p">,</code>
<code class="linenos">161 </code>                   <code class="n">ppart</code><code class="p">,</code> <code class="n">tunion</code><code class="p">,</code> <code class="n">uni</code><code class="p">]</code>
</pre></div>

</figure>

<p>Because the top level function is <strong>textToCypher</strong> returns a string wrapped in a monad, it is possible to add “debug”” print statements in <strong>textToCypher</strong>. I left many such debug statements in the example code to help you understand the data that is being operated on. I leave it as an exercise to remove these print statements if you use this code in your own projects and no longer need to see the debug output.</p>

<h3 id="leanpub-auto-top-level-api-code-for-handling-knowledge-graph-data-generation">Top Level API Code for Handling Knowledge Graph Data Generation</h3>

<p>So far we have looked at processing command line arguments and processing individual input files. Now we look at higher level utility APIs for processing an entire directory of input files. The following listing shows the file API.hs that contains the two top level helper functions we saw in <strong>app/Main.hs</strong>.</p>

<p>The functions <strong>processFilesToRdf</strong> and <strong>processFilesToNeo4j</strong> both have the function type signature <strong>FilePath-&gt;FilePath-&gt;IO()</strong> and are very similar except for calling different helper functions to generate RDF triples or Cypher input graph data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Apis</code>
<code class="linenos"> 2 </code>  <code class="p">(</code> <code class="nf">processFilesToRdf</code>
<code class="linenos"> 3 </code>  <code class="p">,</code> <code class="nf">processFilesToNeo4j</code>
<code class="linenos"> 4 </code>  <code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kr">import</code> <code class="nn">FileUtils</code>
<code class="linenos"> 7 </code><code class="kr">import</code> <code class="nn">GenNeo4jCypher</code>
<code class="linenos"> 8 </code><code class="kr">import</code> <code class="nn">GenTriples</code> <code class="p">(</code><code class="nf">textToTriples</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="kr">import</code> <code class="k">qualified</code> <code class="nn">Database.SQLite.Simple</code> <code class="k">as</code> <code class="n">SQL</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="kr">import</code> <code class="nn">Control.Monad</code> <code class="p">(</code><code class="nf">mapM</code><code class="p">)</code>
<code class="linenos">13 </code><code class="kr">import</code> <code class="nn">Data.String.Utils</code> <code class="p">(</code><code class="nf">replace</code><code class="p">)</code>
<code class="linenos">14 </code><code class="kr">import</code> <code class="nn">System.Directory</code> <code class="p">(</code><code class="nf">getDirectoryContents</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="kr">import</code> <code class="nn">Data.Typeable</code> <code class="p">(</code><code class="nf">typeOf</code><code class="p">)</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="nf">processFilesToRdf</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">19 </code><code class="nf">processFilesToRdf</code> <code class="n">dirPath</code> <code class="n">outputRdfFilePath</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">20 </code>  <code class="n">files</code> <code class="ow">&lt;-</code> <code class="n">getDirectoryContents</code> <code class="n">dirPath</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="p">[</code><code class="kt">FilePath</code><code class="p">]</code>
<code class="linenos">21 </code>  <code class="kr">let</code> <code class="n">filtered_files</code> <code class="ow">=</code> <code class="n">filter</code> <code class="n">isTextFile</code> <code class="n">files</code>
<code class="linenos">22 </code>  <code class="kr">let</code> <code class="n">full_paths</code> <code class="ow">=</code> <code class="p">[</code><code class="n">dirPath</code> <code class="o">++</code> <code class="s">"/"</code> <code class="o">++</code> <code class="n">fn</code> <code class="o">|</code> <code class="n">fn</code> <code class="ow">&lt;-</code> <code class="n">filtered_files</code><code class="p">]</code>
<code class="linenos">23 </code>  <code class="n">putStrLn</code> <code class="s">"full_paths:"</code>
<code class="linenos">24 </code>  <code class="n">print</code> <code class="n">full_paths</code>
<code class="linenos">25 </code>  <code class="kr">let</code> <code class="n">r</code> <code class="ow">=</code>
<code class="linenos">26 </code>        <code class="p">[</code><code class="n">textToTriples</code> <code class="n">fp1</code> <code class="p">(</code><code class="n">replace</code> <code class="s">".txt"</code> <code class="s">".meta"</code> <code class="n">fp1</code><code class="p">)</code>
<code class="linenos">27 </code>        <code class="o">|</code>
<code class="linenos">28 </code>        <code class="n">fp1</code> <code class="ow">&lt;-</code> <code class="n">full_paths</code><code class="p">]</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">IO</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]]</code>
<code class="linenos">29 </code>  <code class="n">tripleL</code> <code class="ow">&lt;-</code>
<code class="linenos">30 </code>    <code class="n">mapM</code> <code class="p">(</code><code class="nf">\</code><code class="n">fp</code> <code class="ow">-&gt;</code> <code class="n">textToTriples</code> <code class="n">fp</code> <code class="p">(</code><code class="n">replace</code> <code class="s">".txt"</code> <code class="s">".meta"</code> <code class="n">fp</code><code class="p">))</code> <code class="n">full_paths</code>
<code class="linenos">31 </code>  <code class="kr">let</code> <code class="n">tripleS</code> <code class="ow">=</code> <code class="n">concat</code> <code class="n">tripleL</code>
<code class="linenos">32 </code>  <code class="n">putStrLn</code> <code class="n">tripleS</code>
<code class="linenos">33 </code>  <code class="n">writeFile</code> <code class="n">outputRdfFilePath</code> <code class="n">tripleS</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code><code class="nf">processFilesToNeo4j</code> <code class="ow">::</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">FilePath</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos">36 </code><code class="nf">processFilesToNeo4j</code> <code class="n">dirPath</code> <code class="n">outputRdfFilePath</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">37 </code>  <code class="n">files</code> <code class="ow">&lt;-</code> <code class="n">getDirectoryContents</code> <code class="n">dirPath</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="p">[</code><code class="kt">FilePath</code><code class="p">]</code>
<code class="linenos">38 </code>  <code class="kr">let</code> <code class="n">filtered_files</code> <code class="ow">=</code> <code class="n">filter</code> <code class="n">isTextFile</code> <code class="n">files</code>
<code class="linenos">39 </code>  <code class="kr">let</code> <code class="n">full_paths</code> <code class="ow">=</code> <code class="p">[</code><code class="n">dirPath</code> <code class="o">++</code> <code class="s">"/"</code> <code class="o">++</code> <code class="n">fn</code> <code class="o">|</code> <code class="n">fn</code> <code class="ow">&lt;-</code> <code class="n">filtered_files</code><code class="p">]</code>
<code class="linenos">40 </code>  <code class="n">putStrLn</code> <code class="s">"full_paths:"</code>
<code class="linenos">41 </code>  <code class="n">print</code> <code class="n">full_paths</code>
<code class="linenos">42 </code>  <code class="kr">let</code> <code class="n">prelude_node_defs</code> <code class="ow">=</code> <code class="n">neo4j_category_node_defs</code>
<code class="linenos">43 </code>  <code class="n">putStrLn</code>
<code class="linenos">44 </code>    <code class="p">(</code><code class="s">"+++++  type of prelude_node_defs is: "</code> <code class="o">++</code>
<code class="linenos">45 </code>     <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">typeOf</code> <code class="n">prelude_node_defs</code><code class="p">)))</code>
<code class="linenos">46 </code>  <code class="n">print</code> <code class="n">prelude_node_defs</code>
<code class="linenos">47 </code>  <code class="n">cypher_dataL</code> <code class="ow">&lt;-</code>
<code class="linenos">48 </code>    <code class="n">mapM</code> <code class="p">(</code><code class="nf">\</code><code class="n">fp</code> <code class="ow">-&gt;</code> <code class="n">textToCypher</code> <code class="n">fp</code> <code class="p">(</code><code class="n">replace</code> <code class="s">".txt"</code> <code class="s">".meta"</code> <code class="n">fp</code><code class="p">))</code> <code class="n">full_paths</code>
<code class="linenos">49 </code>  <code class="kr">let</code> <code class="n">cypher_dataS</code> <code class="ow">=</code> <code class="n">concat</code> <code class="n">cypher_dataL</code>
<code class="linenos">50 </code>  <code class="n">putStrLn</code> <code class="n">cypher_dataS</code>
<code class="linenos">51 </code>  <code class="n">writeFile</code> <code class="n">outputRdfFilePath</code> <code class="o">$</code> <code class="n">prelude_node_defs</code> <code class="o">++</code> <code class="n">cypher_dataS</code>
</pre></div>

</figure>

<p>Since both of these functions return IO monads, I could add “debug” print statements that should be helpful in understanding the data being operated on.</p>

<h3 id="leanpub-auto-wrapup-for-automating-the-creation-of-knowledge-graphs">Wrapup for Automating the Creation of Knowledge Graphs</h3>

<p>The code in this chapter will provide you with a good start for creating both test knowledge graphs and for generating data for production. In practice, generated data should be reviewed before use and additional data manually generated as needed. It is good practice to document required manual changes because this documentation can be used in the requirements for updating the code in this chapter to more closely match your knowledge graph requirements.</p>


<h2 id="leanpub-auto-hybrid-haskell-and-python-natural-language-processing">Hybrid Haskell and Python Natural Language Processing</h2>

<p>Here we will write a Haskell client for using a Natural Language Processing (NLP) server written in Python. There is some common material in this chapter and the next chapter <em>Hybrid Haskell and Python For Coreference Resolution</em> because I wanted both chapters to be self contained.</p>

<h3 id="leanpub-auto-example-use-of-the-haskell-nlp-client">Example Use of the Haskell NLP Client</h3>

<p>Before learning how to use the Python NLP server code and understand the code for the Haskell client code, let’s look at an example of running the client code so you understand the type of processing that we are performing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ stack build --fast --exec HybridHaskellPythonNlp-exe
<code class="linenos">2 </code>Enter text <code class="o">(</code>all on one line<code class="o">)</code>
<code class="linenos">3 </code>John Smith went to Mexico to see the Pepsi plant
<code class="linenos">4 </code>response from NLP server:
<code class="linenos">5 </code>NlpResponse <code class="o">{</code><code class="nv">entities</code> <code class="o">=</code> <code class="o">[</code><code class="s2">"John Smith/PERSON"</code>,<code class="s2">"Mexico/GPE"</code>,<code class="s2">"Pepsi/ORG"</code><code class="o">]</code>,
<code class="linenos">6 </code>             <code class="nv">tokens</code> <code class="o">=</code> <code class="o">[</code><code class="s2">"John"</code>,<code class="s2">"Smith"</code>,<code class="s2">"went"</code>,<code class="s2">"to"</code>,<code class="s2">"Mexico"</code>,<code class="s2">"to"</code>,<code class="s2">"see"</code>,<code class="s2">"the"</code>,<code class="s2">"Pepsi"</code>,<code class="se">\</code>
<code class="linenos">7 </code><code class="s2">"plant"</code><code class="o">]}</code>
<code class="linenos">8 </code>Enter text <code class="o">(</code>all on one line<code class="o">)</code>
</pre></div>

</figure>

<p>Notice on line 5 that each of the three entities is tagged with the entity type. <strong>GPE</strong> is the tag for a country and the tag <strong>ORG</strong> can refer to an entity that is a company or a non-profit organization.</p>

<p>There is some overlap in functionality between the Python SpaCy NLP library and my pure Haskell code in the <strong>NLP</strong> <strong>Tools</strong> chapter. SpaCy has the advantage of using state of the art deep learning models.</p>

<h3 id="leanpub-auto-setting-up-the-python-nlp-server">Setting up the Python NLP Server</h3>

<p>I assume that you have some familiarity with using Python. If not, you will still be able to follow these directions assuming that you have the utilities <strong>pip</strong>, and <strong>python</strong> installed. I recommend installing Python and Pip using <a href="https://anaconda.org/anaconda/conda">Anaconda</a>.</p>

<p>The server code is in the subdirectory <strong>HybridHaskellPythonNlp/python_spacy_nlp_server</strong> where you will work when performing a one time initialization. After the server is installed you can then run it from the command line from any directory on your laptop.</p>

<p>I recommend that you use virtual Python environments when using Python applications to separate the dependencies required for each application or development project. Here I assume that you are running in a Python version 3.6 (or higher) version environment. First install the dependencies:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">pip</code> <code class="n">install</code> <code class="o">-</code><code class="n">U</code> <code class="n">spacy</code>
<code class="linenos">2 </code><code class="n">python</code> <code class="o">-</code><code class="n">m</code> <code class="n">spacy</code> <code class="n">download</code> <code class="n">en</code>
<code class="linenos">3 </code><code class="n">pip</code> <code class="n">install</code> <code class="n">falcon</code>
</pre></div>

</figure>

<p>Then change directory to the subdirectory <strong>HybridHaskellPythonNlp/python_spacy_nlp_server</strong> and install the NLP server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>cd HybridHaskellPythonNlp/python_spacy_nlp_server
<code class="linenos">2 </code>python setup.py install
</pre></div>

</figure>

<p>Once you install the server, you can run it from any directory on your laptop or server using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>spacynlpserver
</pre></div>

</figure>

<p>I use deep learning models written in Python using TensorFlow or PyTorch in applications I write in Haskell or Common Lisp. While it is possible to directly embed models in Haskell and Common Lisp, I find it much easier and developer friendly to wrap deep learning models I use a REST services as I have done here. Often deep learning models only require about a gigabyte of memory and using pre-trained models has lightweight CPU resource needs so while I am developing on my laptop I might have two or three models running and available as wrapped REST services. For production, I configure both the Python services and my Haskell and Common Lisp applications to start automatically on system startup.</p>

<p>This is not a Python programming book and I will not discuss the simple Python wrapping code but if you are also a Python developer you can easily read and understand the code.</p>

<h3 id="leanpub-auto-understanding-the-haskell-nlp-client-code">Understanding the Haskell NLP Client Code</h3>

<p>The Python server returns JSON file. We saw earlier the use of the Haskell <strong>aeson</strong> library for parsing JSON data stored as a string into Haskell native data. We also used the <strong>wreq</strong> library to access remote web services. We use both of these libraries here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code><code class="cm">{-# LANGUAGE DeriveDataTypeable #-}</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="c1">-- reference: http://www.serpentine.com/wreq/tutorial.html</code>
<code class="linenos"> 5 </code><code class="kr">module</code> <code class="nn">NlpWebClient</code>
<code class="linenos"> 6 </code>  <code class="p">(</code> <code class="nf">nlpClient</code><code class="p">,</code> <code class="kt">NlpResponse</code>
<code class="linenos"> 7 </code>  <code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="nn">Control.Lens</code>
<code class="linenos">10 </code><code class="kr">import</code> <code class="nn">Data.ByteString.Lazy.Char8</code> <code class="p">(</code><code class="nf">unpack</code><code class="p">)</code>
<code class="linenos">11 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromJust</code><code class="p">)</code>
<code class="linenos">12 </code><code class="kr">import</code> <code class="nn">Network.URI.Encode</code> <code class="k">as</code> <code class="n">E</code> <code class="c1">-- encode is also in Data.Aeson</code>
<code class="linenos">13 </code><code class="kr">import</code> <code class="nn">Network.Wreq</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="kr">import</code> <code class="nn">Text.JSON.Generic</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="kr">data</code> <code class="kt">NlpResponse</code> <code class="ow">=</code> <code class="kt">NlpResponse</code> <code class="p">{</code><code class="n">entities</code><code class="ow">::</code><code class="p">[</code><code class="kt">String</code><code class="p">],</code> <code class="n">tokens</code><code class="ow">::</code><code class="p">[</code><code class="kt">String</code><code class="p">]}</code> <code class="kr">deriving</code> <code class="p">(</code><code class="kt">Show</code><code class="nf">\</code>
<code class="linenos">18 </code><code class="p">,</code> <code class="kt">Data</code><code class="p">,</code> <code class="kt">Typeable</code><code class="p">)</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="nf">base_url</code> <code class="ow">=</code> <code class="s">"http://127.0.0.1:8008?text="</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="nf">nlpClient</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="kt">NlpResponse</code>
<code class="linenos">23 </code><code class="nf">nlpClient</code> <code class="n">query</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">24 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"</code><code class="se">\n\n</code><code class="s">***  Processing "</code> <code class="o">++</code> <code class="n">query</code>
<code class="linenos">25 </code>  <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">get</code> <code class="o">$</code> <code class="n">base_url</code> <code class="o">++</code> <code class="p">(</code><code class="kt">E</code><code class="o">.</code><code class="n">encode</code> <code class="n">query</code><code class="p">)</code> <code class="o">++</code> <code class="s">"&amp;no_detail=1"</code>
<code class="linenos">26 </code>  <code class="kr">let</code> <code class="n">ret</code> <code class="ow">=</code> <code class="p">(</code><code class="n">decodeJSON</code> <code class="p">(</code><code class="n">unpack</code> <code class="p">(</code><code class="n">fromJust</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseBody</code><code class="p">))))</code> <code class="ow">::</code> <code class="kt">NlpResponse</code>
<code class="linenos">27 </code>  <code class="n">return</code> <code class="n">ret</code>
</pre></div>

</figure>

<p>The main command line program for using the client library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>

<code class="kr">import</code> <code class="nn">NlpWebClient</code>
    
<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
  <code class="n">putStrLn</code> <code class="s">"Enter text (all on one line)"</code>
  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
  <code class="n">response</code> <code class="ow">&lt;-</code> <code class="p">(</code><code class="n">nlpClient</code> <code class="n">s</code><code class="p">)</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="kt">NlpResponse</code>
  <code class="n">putStr</code> <code class="s">"response from NLP server:</code><code class="se">\n</code><code class="s">"</code>
  <code class="n">putStrLn</code> <code class="o">$</code> <code class="n">show</code> <code class="n">response</code>
  <code class="n">main</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrapup-for-using-the-python-spacy-nlp-service">Wrapup for Using the Python SpaCy NLP Service</h3>

<p>The example in this chapter shows a technique that I often use for using libraries and frameworks that are not written in Haskell: wrap the service implemented in another programming language is a REST web service. While it is possible to use a foreign function interface (FFI) to call out to code written in other languages I find for my own work that I prefer calling out to a separate service especially when I run other services on remote servers so I do not need to run them on my development laptop. For production it is also useful to be able to easily scale horizontally across servers.</p>


<h2 id="leanpub-auto-hybrid-haskell-and-python-for-coreference-resolution">Hybrid Haskell and Python For Coreference Resolution</h2>

<p>Here we will write a Haskell client for using a server written in Python that performs coreference resolution (more on this later). There is some common material in this chapter and the last chapter <em>Hybrid Haskell and Python Natural Language Processing</em> because I wanted both chapters to be self contained. The code for this chapter can be found in the subdirectory <strong>HybridHaskellPythonCorefAnaphoraResolution</strong>.</p>

<p>Coreference resolution is also called anaphora resolution and is the process for replacing pronouns in text with the original nouns, proper nouns, or noun phrases that the pronouns refer to.</p>

<p>Before discussing setting up the Python library for performing coreference analysis and the Haskell client, let’s run the client so you can see and understand anaphora resolution:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code> $ <code class="nv">stack</code> <code class="nv">build</code> <code class="o">--</code><code class="nv">fast</code> <code class="o">--</code><code class="k">exec</code> <code class="nv">HybridHaskellPythonCorefAnaphoraResolution</code><code class="o">-</code><code class="nv">exe</code>
<code class="linenos"> 2 </code><code class="nv">Enter</code> <code class="nv">text</code> <code class="ss">(</code><code class="nv">all</code> <code class="nv">on</code> <code class="nv">one</code> <code class="nv">line</code><code class="ss">)</code>
<code class="linenos"> 3 </code><code class="nv">John</code> <code class="nv">Smith</code> <code class="nv">drove</code> <code class="nv">a</code> <code class="nv">car</code>. <code class="nv">He</code> <code class="nv">liked</code> <code class="nv">it</code>.
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="o">***</code>  <code class="nv">Processing</code> <code class="nv">John</code><code class="o">%</code><code class="mi">20</code><code class="nv">Smith</code><code class="o">%</code><code class="mi">20</code><code class="nv">drove</code><code class="o">%</code><code class="mi">20</code><code class="nv">a</code><code class="o">%</code><code class="mi">20</code><code class="nv">car</code>.<code class="o">%</code><code class="mi">20</code><code class="nv">He</code><code class="o">%</code><code class="mi">20</code><code class="nv">liked</code><code class="o">%</code><code class="mi">20</code><code class="nv">it</code>.
<code class="linenos"> 7 </code><code class="nv">status</code> <code class="nv">code</code>: <code class="mi">200</code>
<code class="linenos"> 8 </code><code class="nv">content</code> <code class="nv">type</code>: <code class="nv">Just</code> <code class="s2">"</code><code class="s">application/text</code><code class="s2">"</code>
<code class="linenos"> 9 </code><code class="nv">response</code> <code class="nv">body</code>: <code class="nv">John</code> <code class="nv">Smith</code> <code class="nv">drove</code> <code class="nv">a</code> <code class="nv">car</code>. <code class="nv">John</code> <code class="nv">Smith</code> <code class="nv">liked</code> <code class="nv">a</code> <code class="nv">car</code>.
<code class="linenos">10 </code><code class="nv">response</code> <code class="nv">from</code> <code class="nv">coreference</code> <code class="nv">server</code>:	<code class="s2">"</code><code class="s">John Smith drove a car. John Smith liked a car.</code><code class="s2">"</code>
<code class="linenos">11 </code><code class="nv">Enter</code> <code class="nv">text</code> <code class="ss">(</code><code class="nv">all</code> <code class="nv">on</code> <code class="nv">one</code> <code class="nv">line</code><code class="ss">)</code>
</pre></div>

</figure>

<p>In this example notice that the words “He” and “it” in the second sentence are replaced by “John Smith” and “a car” which makes it easier to write information extraction applications.</p>

<h3 id="leanpub-auto-installing-the-python-coreference-server">Installing the Python Coreference Server</h3>

<p>I recommend that you use virtual Python environments when using Python applications to separate the dependencies required for each application or development project. Here I assume that you are running in a Python version 3.6 (or higher) version environment. If you want to install the <strong>neuralcoref</strong> library using <strong>pip</strong> you must use and older version of <strong>spaCy</strong>. First install the dependencies:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>pip install spacy==2.1.0
<code class="linenos">2 </code>pip install neuralcoref 
<code class="linenos">3 </code>pip install falcon
</pre></div>

</figure>

<p>As I write this chapter the <em>neuralcoref</em> model and library require a slightly older version of <strong>spaCy</strong> (the current latest version is 2.3.0).</p>

<p>If you want to instead use the latest version of <strong>spaCy</strong> then install <strong>neuralcoref</strong> from source:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>pip install spacy
<code class="linenos">2 </code>git clone https://github.com/huggingface/neuralcoref.git
<code class="linenos">3 </code>cd neuralcoref
<code class="linenos">4 </code>python setup.py install
<code class="linenos">5 </code>pip install falcon
</pre></div>

</figure>

<p>After installing all dependencies, then change directory to the subdirectory <strong>python_coreference_anaphora_resolution_server</strong> and install the coref server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>cd python_coreference_anaphora_resolution_server
<code class="linenos">2 </code>python setup.py install
</pre></div>

</figure>

<p>Once you install the server, you can run it from any directory on your laptop or server using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>corefserver
</pre></div>

</figure>

<p>I use deep learning models written in Python using TensorFlow or PyTorch in applications I write in Haskell or Common Lisp. While it is possible to directly embed models in Haskell and Common Lisp, I find it much easier and developer friendly to wrap deep learning models I use a REST services as I have done here. Often deep learning models only require about a gigabyte of memory and using pre-trained models has lightweight CPU resource needs so while I am developing on my laptop I might have two or three models running and available as wrapped REST services. For production, I configure both the Python services and my Haskell and Common Lisp applications to start automatically on system startup.</p>

<p>This is not a Python programming book and I will not discuss the simple Python wrapping code but if you are also a Python developer you can easily read and understand the code.</p>

<h3 id="leanpub-auto-understanding-the-haskell-coreference-client-code">Understanding the Haskell Coreference Client Code</h3>

<p>The code for the library for fetching data from the Python service is in the subdirectory <strong>src</strong> in the file <strong>CorefWebClient.hs</strong>.</p>

<p>We will use techniques for accessing remote web services using the <strong>wreq</strong> library and using the <strong>lens</strong> library for accessing the response from the Python server. Here the response is plain text with pronouns replaced by the nouns that they represent. We don’t use the <strong>aeson</strong> library to parse JSON data as we did in the previous chapter.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">-- reference: http://www.serpentine.com/wreq/tutorial.html</code>
<code class="linenos"> 4 </code><code class="kr">module</code> <code class="nn">CorefWebClient</code>
<code class="linenos"> 5 </code>  <code class="p">(</code> <code class="nf">corefClient</code>
<code class="linenos"> 6 </code>  <code class="p">)</code> <code class="kr">where</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="kr">import</code> <code class="nn">Control.Lens</code>
<code class="linenos"> 9 </code><code class="kr">import</code> <code class="nn">Data.ByteString.Lazy.Char8</code> <code class="p">(</code><code class="nf">unpack</code><code class="p">)</code>
<code class="linenos">10 </code><code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">fromJust</code><code class="p">)</code>
<code class="linenos">11 </code><code class="kr">import</code> <code class="nn">Network.URI.Encode</code> <code class="p">(</code><code class="nf">encode</code><code class="p">)</code>
<code class="linenos">12 </code><code class="kr">import</code> <code class="nn">Network.Wreq</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="nf">base_url</code> <code class="ow">=</code> <code class="s">"http://127.0.0.1:8000?text="</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="nf">corefClient</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code> <code class="ow">-&gt;</code> <code class="kt">IO</code> <code class="p">[</code><code class="kt">Char</code><code class="p">]</code>
<code class="linenos">17 </code><code class="nf">corefClient</code> <code class="n">query</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos">18 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"</code><code class="se">\n\n</code><code class="s">***  Processing "</code> <code class="o">++</code> <code class="p">(</code><code class="n">encode</code> <code class="n">query</code><code class="p">)</code>
<code class="linenos">19 </code>  <code class="n">r</code> <code class="ow">&lt;-</code> <code class="n">get</code> <code class="o">$</code> <code class="n">base_url</code> <code class="o">++</code> <code class="p">(</code><code class="n">encode</code> <code class="n">query</code><code class="p">)</code> <code class="o">++</code> <code class="s">"&amp;no_detail=1"</code>
<code class="linenos">20 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"status code: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">r</code> <code class="o">^.</code> <code class="n">responseStatus</code> <code class="o">.</code> <code class="n">statusCode</code><code class="p">))</code>
<code class="linenos">21 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"content type: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">show</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseHeader</code> <code class="s">"Content-Type"</code><code class="p">))</code>
<code class="linenos">22 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="s">"response body: "</code> <code class="o">++</code> <code class="p">(</code><code class="n">unpack</code> <code class="p">(</code><code class="n">fromJust</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseBody</code><code class="p">)))</code>
<code class="linenos">23 </code>  <code class="n">return</code> <code class="o">$</code> <code class="n">unpack</code> <code class="p">(</code><code class="n">fromJust</code> <code class="p">(</code><code class="n">r</code> <code class="o">^?</code> <code class="n">responseBody</code><code class="p">))</code>
</pre></div>

</figure>

<p>The code for the main application is in the subdirectory <strong>app</strong> in the file <strong>Main.hs</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kr">module</code> <code class="nn">Main</code> <code class="kr">where</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kr">import</code> <code class="nn">CorefWebClient</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="linenos"> 6 </code><code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
<code class="linenos"> 7 </code>  <code class="n">putStrLn</code> <code class="s">"Enter text (all on one line)"</code>
<code class="linenos"> 8 </code>  <code class="n">s</code> <code class="ow">&lt;-</code> <code class="n">getLine</code>
<code class="linenos"> 9 </code>  <code class="n">response</code> <code class="ow">&lt;-</code> <code class="n">corefClient</code> <code class="n">s</code>
<code class="linenos">10 </code>  <code class="n">putStr</code> <code class="s">"response from coreference server:</code><code class="se">\t</code><code class="s">"</code>
<code class="linenos">11 </code>  <code class="n">putStrLn</code> <code class="o">$</code> <code class="n">show</code> <code class="n">response</code>
<code class="linenos">12 </code>  <code class="n">main</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrapup-for-using-the-python-coreference-nlp-service">Wrapup for Using the Python Coreference NLP Service</h3>

<p>The example in this chapter is fairly simple but shows a technique that I often use for using libraries and frameworks that are not written in Haskell: wrap the service implemented in another programming language is a REST web service. While it is possible to use a foreign function interface (FFI) to call out to code written in other languages I find for my own work that I prefer calling out to a separate service, especially when I run other services on remote servers so I do not need to run them on my development laptop. For production it is also useful to be able to easily scale horizontally across servers.</p>


<h2 id="leanpub-auto-book-wrap-up">Book Wrap Up</h2>

<p>As I mentioned in the Preface, I had a slow start learning Haskell because I tried to learn too much at one time. In this book I have attempted to show you a subset of Haskell that is sufficient to write interesting programs - a gentle introduction.</p>

<p>Haskell beginners often dislike the large error listings from the compiler. The correct attitude is to recognize that these error messages are there to help you. That is easier said than done, but try to be happy when the compiler points out an error - in the long run I find using Haskell’s <em>fussy</em> compiler saves me time and lets me refactor code knowing that if I miss something in my refactoring the compiler will immediately let me know what needs to be fixed.</p>

<p>The other thing that I hope you learned working through this book is how effective repl based programming is. Most code I write, unless it is very trivial, starts its life in a GHCi repl. When you are working with somene else’s Haskell code it is similarly useful to have their code loaded in a repl as you read.</p>

<p>I have been programming professionally for forty years and I use many programming languages. Once I worked my way through early difficulties using Haskell it has become a favorite programming language. I hope that you enjoy Haskell development as much as I do.</p>


<h2 id="leanpub-auto-appendix-a---haskell-tools-setup">Appendix A - Haskell Tools Setup</h2>

<p>I recommend that if you are new to Haskell that you at least do a minimal installation of <em>stack</em> and work through the first chapter using an interactive REPL. After experimenting with the REPL then do please come back to Appendix A and install support for the editor of your choice (or an IDE) and hlint.</p>

<h3 id="leanpub-auto-stack">stack</h3>

<p>I assume that you have the Haskell package manager <em>stack</em> installed. If you have not installed <em>stack</em> yet please follow <a href="http://docs.haskellstack.org/en/stable/README.html">these directions</a>.</p>

<p>After installing stack and running it you will have a directory “.stack” in your home directory where stack will keep compiled libraries and configuration data. You will want to create a file “~/.stack/config.yaml” with contents similar to my stack configuration file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">templates</code><code class="kt">:</code>
<code class="linenos">2 </code>  <code class="n">params</code><code class="kt">:</code>
<code class="linenos">3 </code>      <code class="n">author</code><code class="o">-</code><code class="n">email</code><code class="kt">:</code> <code class="n">markw</code><code class="o">@</code><code class="n">markwatson</code><code class="o">.</code><code class="n">com</code>
<code class="linenos">4 </code>      <code class="n">author</code><code class="o">-</code><code class="n">name</code><code class="kt">:</code> <code class="kt">Mark</code> <code class="kt">Watson</code>
<code class="linenos">5 </code>      <code class="n">category</code><code class="kt">:</code> <code class="n">dev</code>
<code class="linenos">6 </code>      <code class="n">copyright</code><code class="kt">:</code> <code class="kt">Copyright</code> <code class="mi">2016</code> <code class="kt">Mark</code> <code class="kt">Watson</code><code class="o">.</code> <code class="kt">All</code> <code class="n">rights</code> <code class="n">reserved</code>
<code class="linenos">7 </code>      <code class="n">github</code><code class="o">-</code><code class="n">username</code><code class="kt">:</code> <code class="n">mark</code><code class="o">-</code><code class="n">watson</code>
</pre></div>

</figure>

<p>Replace my name and email address with yours. You might also want to install the package manager Cabal and the “lint” program hlint:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ stack install cabal-install
$ stack install hlint
</pre></div>

</figure>

<p>These installs might take a while so go outside for ten minutes and get some fresh air.</p>

<p>You should get in the habit of running hlint on your code and consider trying to remove all or at least most warnings. You can customize the types of warnings hlint shows: <a href="https://github.com/ndmitchell/hlint#readme">read the documentation for hlint</a>.</p>

<h4 id="leanpub-auto-creating-a-new-stack-project">Creating a New Stack Project</h4>

<p>I have already created stack projects for the examples in this book. When you have worked through them, then please refer to the <a href="https://docs.haskellstack.org/en/stable/README/#start-your-new-project">stack documentation for creating projects</a>.</p>

<h3 id="leanpub-auto-emacs-setup">Emacs Setup</h3>

<p>There are several good alternatives to using the Emacs editor:</p>

<ul>
  <li>GEdit on Linux</li>
  <li>TextMate on OS X</li>
  <li>IntelliJ with the Haskell plugin (all platforms)</li>
</ul>

<p>I use all three of these alternatives on occasion, but Emacs with <em>haskell-mode</em> is my favorite environment. There are instructions for adding <em>haskell-mode</em> to Emacs on the <a href="https://github.com/haskell/haskell-mode">project home page on github</a>. If you follow these instructions you will have syntax hiliting and Emacs will understand Haskell indentation rules.</p>

<h3 id="leanpub-auto-do-you-want-more-of-an-ide-like-development-environment">Do you want more of an IDE-like Development Environment?</h3>

<p>I recommend and use the <a href="https://commercialhaskell.github.io/intero/">Intero Emacs package</a> to get auto completions and real time syntax error warnings. <strong>Intero</strong> is designed to work with <em>stack</em>.</p>

<p>I add the following to the bottom of my .emacs file:</p>

<p>(add-hook ‘haskell-mode-hook ‘intero-mode)</p>

<p>and if Intero is too “heavy weight” for my current project, then I comment out the add-hook expression. Intero can increase the startup time for Emacs for editing Haskell files. That said, I almost always keep Intero enabled in my Emacs environment.</p>

<h3 id="leanpub-auto-hlint">hlint</h3>

<p><strong>hlint</strong> is a wonderful tool for refining your knowledge and use of the Haskell language. After writing new code and checking that it works, then run <strong>hlint</strong> for suggestions on how to improve your code.</p>

<p>Install <strong>hlint</strong> using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">stack</code> <code class="n">install</code> <code class="n">hlint</code>
</pre></div>

</figure>

</div>
</body>
</html>
