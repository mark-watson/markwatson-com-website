<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Loving Common Lisp, or the Savvy Programmer&#39;s Secret Weapon</title>
  <link href="stylesheet.css" rel="stylesheet" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJNL6DY9ZQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MJNL6DY9ZQ');
    </script>

</head>
<body dir="" class="lfm">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-cover-material-copyright-and-license'>Cover Material, Copyright, and License</a>
    <ul>
      <li>
        <a href='#leanpub-auto-this-book-is-licensed-with-creative-commons-attribution-cc-by-version-3'>This book is licensed with Creative Commons Attribution CC BY Version 3</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-notes-on-the-eighth-edition-published-august-2022'>Notes on the Eighth Edition Published August 2022</a>
      </li>
      <li>
        <a href='#leanpub-auto-notes-on-the-seventh-edition-published-march-2021'>Notes on the Seventh Edition Published March 2021</a>
      </li>
      <li>
        <a href='#leanpub-auto-notes-on-the-sixth-edition-published-june-2020'>Notes on the Sixth Edition Published June 2020</a>
      </li>
      <li>
        <a href='#leanpub-auto-notes-on-the-fifth-edition-published-september-2019'>Notes on the Fifth Edition Published September 2019</a>
      </li>
      <li>
        <a href='#leanpub-auto-why-use-common-lisp'>Why Use Common Lisp?</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-request-from-the-author'>A Request from the Author</a>
      </li>
      <li>
        <a href='#leanpub-auto-older-book-editions'>Older Book Editions</a>
      </li>
      <li>
        <a href='#leanpub-auto-acknowledgments'>Acknowledgments</a>
      </li>
      <li>
        <a href='#leanpub-auto-setting-up-your-common-lisp-development-system-and-quicklisp'>Setting Up Your Common Lisp Development System and Quicklisp</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#introduction'>Introduction</a>
    <ul>
      <li>
        <a href='#leanpub-auto-why-did-i-write-this-book'>Why Did I Write this Book?</a>
      </li>
      <li>
        <a href='#leanpub-auto-free-software-tools-for-common-lisp-programming'>Free Software Tools for Common Lisp Programming</a>
      </li>
      <li>
        <a href='#leanpub-auto-making-book-examples-run-portably-on-most-common-lisp-implementations'>Making Book Examples Run Portably on Most Common Lisp Implementations</a>
      </li>
      <li>
        <a href='#leanpub-auto-how-is-lisp-different-from-languages-like-java-and-c'>How is Lisp Different from Languages like Java and C++?</a>
      </li>
      <li>
        <a href='#leanpub-auto-advantages-of-working-in-a-lisp-environment'>Advantages of Working in a Lisp Environment</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-common-lisp-basics'>Common Lisp Basics</a>
    <ul>
      <li>
        <a href='#leanpub-auto-getting-started-with-sbcl'>Getting Started with SBCL</a>
      </li>
      <li>
        <a href='#leanpub-auto-making-the-repl-nicer-using-rlwrap'>Making the repl Nicer using rlwrap</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-basics-of-lisp-programming'>The Basics of Lisp Programming</a>
      </li>
      <li>
        <a href='#leanpub-auto-symbols'>Symbols</a>
      </li>
      <li>
        <a href='#leanpub-auto-operations-on-lists'>Operations on Lists</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-arrays-and-vectors'>Using Arrays and Vectors</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-strings'>Using Strings</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-hash-tables'>Using Hash Tables</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-eval-to-evaluate-lisp-forms'>Using Eval to Evaluate Lisp Forms</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-a-text-editor-to-edit-lisp-source-files'>Using a Text Editor to Edit Lisp Source Files</a>
      </li>
      <li>
        <a href='#leanpub-auto-recovering-from-errors'>Recovering from Errors</a>
      </li>
      <li>
        <a href='#leanpub-auto-garbage-collection'>Garbage Collection</a>
      </li>
      <li>
        <a href='#leanpub-auto-loading-your-working-environment-quickly'>Loading your Working Environment Quickly</a>
      </li>
      <li>
        <a href='#leanpub-auto-functional-programming-concepts'>Functional Programming Concepts</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#quicklisp'>Quicklisp</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-quicklisp-to-find-packages'>Using Quicklisp to Find Packages</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-quicklisp-to-configure-emacs-and-slime'>Using Quicklisp to Configure Emacs and Slime</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-defining-lisp-functions'>Defining Lisp Functions</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-lambda-forms'>Using Lambda Forms</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-recursion'>Using Recursion</a>
      </li>
      <li>
        <a href='#leanpub-auto-closures'>Closures</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-function-eval'>Using the Function eval</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-defining-common-lisp-macros'>Defining Common Lisp Macros</a>
    <ul>
      <li>
        <a href='#leanpub-auto-example-macro'>Example Macro</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-splicing-operator'>Using the Splicing Operator</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-macroexpand-1'>Using macroexpand-1</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-common-lisp-loop-macros'>Using Common Lisp Loop Macros</a>
    <ul>
      <li>
        <a href='#leanpub-auto-dolist'>dolist</a>
      </li>
      <li>
        <a href='#leanpub-auto-dotimes'>dotimes</a>
      </li>
      <li>
        <a href='#leanpub-auto-do'>do</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-loop-special-form-to-iterate-over-vectors-or-arrays'>Using the loop Special Form to Iterate Over Vectors or Arrays</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#package_system'>Common Lisp Package System</a>
  </li>
  <li>
    <a href='#input_output'>Input and Output</a>
    <ul>
      <li>
        <a href='#leanpub-auto-the-lisp-read-and-read-line-functions'>The Lisp read and read-line Functions</a>
      </li>
      <li>
        <a href='#leanpub-auto-lisp-printing-functions'>Lisp Printing Functions</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#plotlib'>Plotting Data</a>
    <ul>
      <li>
        <a href='#leanpub-auto-implementing-the-library'>Implementing the Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-packaging-as-a-quicklisp-project'>Packaging as a Quicklisp Project</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#clos_chapter'>Common Lisp Object System - CLOS</a>
    <ul>
      <li>
        <a href='#leanpub-auto-example-of-using-a-clos-class'>Example of Using a CLOS Class</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementation-of-the-htmlstream-class'>Implementation of the HTMLstream Class</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-defstruct-or-clos'>Using Defstruct or CLOS</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-heuristically-guided-search'>Heuristically Guided Search</a>
  </li>
  <li>
    <a href='#network_prog'>Network Programming</a>
    <ul>
      <li>
        <a href='#leanpub-auto-an-introduction-to-drakma'>An introduction to Drakma</a>
      </li>
      <li>
        <a href='#leanpub-auto-an-introduction-to-hunchentoot'>An introduction to Hunchentoot</a>
      </li>
      <li>
        <a href='#leanpub-auto-complete-rest-client-server-example-using-json-for-data-serialization'>Complete REST Client Server Example Using JSON for Data Serialization</a>
      </li>
      <li>
        <a href='#leanpub-auto-network-programming-wrap-up'>Network Programming Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-microsoft-bing-search-apis'>Using the Microsoft Bing Search APIs</a>
    <ul>
      <li>
        <a href='#leanpub-auto-getting-an-access-key-for-microsoft-bing-search-apis'>Getting an Access Key for Microsoft Bing Search APIs</a>
      </li>
      <li>
        <a href='#leanpub-auto-example-search-script'>Example Search Script</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-accessing-relational-databases'>Accessing Relational Databases</a>
    <ul>
      <li>
        <a href='#leanpub-auto-database-wrap-up'>Database Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#nosql_chapter'>Using MongoDB, Solr NoSQL Data Stores</a>
    <ul>
      <li>
        <a href='#leanpub-auto-mongodb'>MongoDB</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-common-lisp-solr-client'>A Common Lisp Solr Client</a>
      </li>
      <li>
        <a href='#leanpub-auto-nosql-wrapup'>NoSQL Wrapup</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#nlp_chapter'>Natural Language Processing</a>
    <ul>
      <li>
        <a href='#leanpub-auto-loading-and-running-the-nlp-library'>Loading and Running the NLP Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-part-of-speech-tagging'>Part of Speech Tagging</a>
      </li>
      <li>
        <a href='#leanpub-auto-categorizing-text'>Categorizing Text</a>
      </li>
      <li>
        <a href='#leanpub-auto-detecting-peoples-names-and-place-names'>Detecting People’s Names and Place Names</a>
      </li>
      <li>
        <a href='#leanpub-auto-summarizing-text'>Summarizing Text</a>
      </li>
      <li>
        <a href='#leanpub-auto-text-mining'>Text Mining</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#information_gathering'>Information Gathering</a>
    <ul>
      <li>
        <a href='#leanpub-auto-dbpedia-lookup-service'>DBPedia Lookup Service</a>
      </li>
      <li>
        <a href='#leanpub-auto-web-spiders'>Web Spiders</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-apache-nutch'>Using Apache Nutch</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-1'>Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-cl-machine-learning-library'>Using The CL Machine-Learning Library</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-the-clml-data-loading-and-access-apis'>Using the CLML Data Loading and Access APIs</a>
      </li>
      <li>
        <a href='#leanpub-auto-k-means-clustering-of-cancer-data-set'>K-Means Clustering of Cancer Data Set</a>
      </li>
      <li>
        <a href='#leanpub-auto-svm-classification-of-cancer-data-set'>SVM Classification of Cancer Data Set</a>
      </li>
      <li>
        <a href='#leanpub-auto-clml-wrap-up'>CLML Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#backprop'>Backpropagation Neural Networks</a>
  </li>
  <li>
    <a href='#leanpub-auto-hopfield-neural-networks'>Hopfield Neural Networks</a>
  </li>
  <li>
    <a href='#leanpub-auto-using-python-deep-learning-models-in-common-lisp-with-a-web-services-interface'>Using Python Deep Learning Models In Common Lisp With a Web Services Interface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-setting-up-the-python-web-services-used-in-this-chapter'>Setting up the Python Web Services Used in this Chapter</a>
      </li>
      <li>
        <a href='#leanpub-auto-installing-the-spacy-nlp-services'>Installing the spaCY NLP Services</a>
      </li>
      <li>
        <a href='#leanpub-auto-installing-the-coreference-nlp-services'>Installing the Coreference NLP Services</a>
      </li>
      <li>
        <a href='#leanpub-auto-common-lisp-client-for-the-spacy-nlp-web-services'>Common Lisp Client for the spaCy NLP Web Services</a>
      </li>
      <li>
        <a href='#leanpub-auto-common-lisp-client-for-the-coreference-nlp-web-services'>Common Lisp Client for the Coreference NLP Web Services</a>
      </li>
      <li>
        <a href='#leanpub-auto-trouble-shooting-possible-problems---skip-if-this-example-works-on-your-system'>Trouble Shooting Possible Problems - Skip if this Example Works on Your System</a>
      </li>
      <li>
        <a href='#leanpub-auto-python-interop-wrap-up'>Python Interop Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-py4cl-library-to-embed-python-in-common-lisp'>Using the PY4CL Library to Embed Python in Common Lisp</a>
    <ul>
      <li>
        <a href='#leanpub-auto-project-structure-building-the-python-wrapper-and-running-an-example'>Project Structure, Building the Python Wrapper, and Running an Example</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementation-of-spacy-py4cl'>Implementation of spacy-py4cl</a>
      </li>
      <li>
        <a href='#leanpub-auto-trouble-shooting-possible-problems---skip-if-this-example-works-on-your-system-1'>Trouble Shooting Possible Problems - Skip if this Example Works on Your System</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-for-using-py4cl'>Wrap-up for Using Py4CL</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-semantic-web-and-linked-data'>Semantic Web and Linked Data</a>
    <ul>
      <li>
        <a href='#leanpub-auto-resource-description-framework-rdf-data-model'>Resource Description Framework (RDF) Data Model</a>
      </li>
      <li>
        <a href='#rdfs'>Extending RDF with RDF Schema</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-sparql-query-language'>The SPARQL Query Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-case-study-using-sparql-to-find-information-about-board-of-directors-members-of-corporations-and-organizations'>Case Study: Using SPARQL to Find Information about Board of Directors Members of Corporations and Organizations</a>
      </li>
      <li>
        <a href='#leanpub-auto-installing-the-apache-jena-fuseki-rdf-server'>Installing the Apache Jena Fuseki RDF Server</a>
      </li>
      <li>
        <a href='#leanpub-auto-common-lisp-client-examples-for-the-apache-jena-fuseki-rdf-server'>Common Lisp Client Examples for the Apache Jena Fuseki RDF Server</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgcreator'>Automatically Generating Data for Knowledge Graphs</a>
    <ul>
      <li>
        <a href='#leanpub-auto-implementation-notes'>Implementation Notes</a>
      </li>
      <li>
        <a href='#leanpub-auto-generating-rdf-data'>Generating RDF Data</a>
      </li>
      <li>
        <a href='#leanpub-auto-generating-data-for-the-neo4j-graph-database'>Generating Data for the Neo4j Graph Database</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementing-the-top-level-application-apis'>Implementing the Top Level Application APIs</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementing-the-web-interface'>Implementing The Web Interface</a>
      </li>
      <li>
        <a href='#leanpub-auto-creating-a-standalone-application-using-sbcl'>Creating a Standalone Application Using SBCL</a>
      </li>
      <li>
        <a href='#leanpub-auto-augmenting-rdf-triples-in-a-knowledge-graph-using-dbpedia'>Augmenting RDF Triples in a Knowledge Graph Using DBPedia</a>
      </li>
      <li>
        <a href='#leanpub-auto-kgcreator-wrap-up'>KGCreator Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgsampler'>Knowledge Graph Sampler for Creating Small Custom Knowledge Graphs</a>
  </li>
  <li>
    <a href='#kgncommon'>Knowledge Graph Navigator Common Library Implementation</a>
    <ul>
      <li>
        <a href='#leanpub-auto-example-output'>Example Output</a>
      </li>
      <li>
        <a href='#leanpub-auto-project-configuration-and-running-the-application'>Project Configuration and Running the Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-review-of-nlp-utilities-used-in-application'>Review of NLP Utilities Used in Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-developing-low-level-sparql-utilities'>Developing Low-Level SPARQL Utilities</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementing-the-caching-layer'>Implementing the Caching Layer</a>
      </li>
      <li>
        <a href='#leanpub-auto-utilities-in-the-main-library-file-kgn-commonlisp'>Utilities in the Main Library File kgn-common.lisp</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-2'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgntext'>Knowledge Graph Navigator Text-Based User Interface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-example-output-1'>Example Output</a>
      </li>
      <li>
        <a href='#leanpub-auto-text-user-interface-implementation'>Text User Interface Implementation</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-3'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgncapi'>Knowledge Graph Navigator User Interface Using LispWorks CAPI</a>
    <ul>
      <li>
        <a href='#leanpub-auto-project-configuration-and-running-the-application-1'>Project Configuration and Running the Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-utilities-to-colorize-sparql-and-generated-output'>Utilities to Colorize SPARQL and Generated Output</a>
      </li>
      <li>
        <a href='#leanpub-auto-main-implementation-file-kgn-capi-uilisp'>Main Implementation File kgn-capi-ui.lisp</a>
      </li>
      <li>
        <a href='#leanpub-auto-user-interface-utilites-file-user-interfacelisp'>User Interface Utilites File user-interface.lisp</a>
      </li>
      <li>
        <a href='#leanpub-auto-user-interface-capi-options-panes-definition-file-option-panelisp'>User Interface CAPI Options Panes Definition File option-pane.lisp</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-lispworks-capi-ui-toolkit'>Using LispWorks CAPI UI Toolkit</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-4'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-openai-apis'>Using the OpenAI APIs</a>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-hugging-face-deep-learning-natural-language-processing-apis'>Using the Hugging Face Deep Learning Natural Language Processing APIs</a>
  </li>
  <li>
    <a href='#leanpub-auto-using-custom-deep-learning-models-hosted-on-google-colab'>Using Custom Deep Learning Models Hosted on Google Colab</a>
  </li>
  <li>
    <a href='#leanpub-auto-using-common-lisp-with-wolframone'>Using Common Lisp with Wolfram/One</a>
  </li>
  <li>
    <a href='#leanpub-auto-software-architecture-for-common-lisp-projects'>Software Architecture for Common Lisp Projects</a>
    <ul>
      <li>
        <a href='#leanpub-auto-general-principles-of-light-weight-software-architecture'>General Principles of Light Weight Software Architecture</a>
      </li>
      <li>
        <a href='#leanpub-auto-specific-requirements-and-techniques-for-architecting-systems-developed-in-common-lisp'>Specific Requirements and Techniques for Architecting Systems Developed in Common Lisp</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-book-wrapup'>Book Wrapup</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="lfm">
<h2 id="leanpub-auto-cover-material-copyright-and-license">Cover Material, Copyright, and License</h2>

<p>Copyright 2011-2022 Mark Watson. </p>

<h3 id="leanpub-auto-this-book-is-licensed-with-creative-commons-attribution-cc-by-version-3">This book is licensed with Creative Commons Attribution CC BY Version 3</h3>


<p>This eBook will be updated occasionally so please periodically check the <a href="https://leanpub.com/lovinglisp">leanpub.com web page for this book</a> for updates.</p>

<p>This is the eighth edition released August 2022.</p>

<p>Please visit the <a href="http://markwatson.com">author’s website</a>.</p>

<p>If you found a copy of this book on the web and find it of value then please consider buying a copy at <a href="https://leanpub.com/lovinglisp">leanpub.com/lovinglisp</a> to support the author and fund work for future updates.  You can also download a free copy from  Leanpub by setting the price to zero. Please look at <a href="https://markwatson.com/#books">my website</a> for other books and materials.</p>

<h2 id="leanpub-auto-preface">Preface</h2>

<h3 id="leanpub-auto-notes-on-the-eighth-edition-published-august-2022">Notes on the Eighth Edition Published August 2022</h3>

<p>The main change is splitting the Knowledge Graph Navigator (KGN) chapter that features the LispWorks CAPI UI APIs into three chapters for  a library for KGN functionality, a text based (console) UI, and a CAPI based UI. I added examples using the OpenAI GPT-3 APIs. There are other small corrections and improvements.</p>

<h3 id="leanpub-auto-notes-on-the-seventh-edition-published-march-2021">Notes on the Seventh Edition Published March 2021</h3>

<p>I added two short chapters to the previous edition:
Knowledge Graph Sampler for Creating Small Custom Knowledge Graphs and Using Common Lisp With Wolfram/One.</p>

<h3 id="leanpub-auto-notes-on-the-sixth-edition-published-june-2020">Notes on the Sixth Edition Published June 2020</h3>

<p>Two examples optionally use the CAPI user interface toolkit provided with <a href="https://lispworks.com">LispWorks Common Lisp</a> and work with the free personal edition. The first CAPI application is <a href="http://knowledgegraphnavigator.com">Knowledge Graph Navigator</a> and the second CAPI example is <a href="http://kgcreator.com">Knowledge Graph Creator</a>. Both of these examples build up utilities for working with Knowledge Graphs and the Semantic Web.</p>

<p>I expand the Plot Library chapter to generate either PNG graphics files or if you are using the free personal edition of LispWorks you can also direct plotting output to a new window in interactive programs.</p>

<p>I added a new chapter on using the py4cl library to embed Python libraries and application code into a Common Lisp system. I provide new examples for embedding spaCy and TensorFlow applications in Common Lisp applications. In earlier editions, I used a web services interface to wrap Python code using spaCy and TensorFlow. I am leaving that chapter intact, renaming it from “Using Python Deep Learning Models In Common Lisp” to “Using Python Deep Learning Models In Common Lisp With a Web Services Interface.” The new chapter for this edition is “Using the PY4CL Library to Embed Python in Common Lisp.”</p>

<h3 id="leanpub-auto-notes-on-the-fifth-edition-published-september-2019">Notes on the Fifth Edition Published September 2019</h3>

<p>There were two chapters added:</p>

<ul>
  <li>A complete application for processing text to generate data for Knowledge Graphs (targeting the open source Neo4J graph database and also support RDF semantic web/linked data).</li>
  <li>A library for accessing the state of the art spaCy natural language processing (NLP) library and also a state of the art deep learning model. These models are implemented in thin Python wrappers that use Python libraries like spaCy, PyTorch, and TensorFlow. These examples replace a simple hybrid Java and Common Lisp example in previous editions.</li>
</ul>

<p>I have added text and explanations as appropriate throughout the book and I removed the CouchDB examples.</p>

<p>I have made large changes to how the code for this book is packaged. I have reorganized the example code on GitHub by providing the examples as multiple Quicklisp libraries or applications. I now do this with all of my Common Lisp code and it makes it easier to write smaller libraries that can be composed into larger applications. In my own workflow, I also like to use Makefile targets to build standalone applications that can be run on other computers without installing Lisp development environments. Please follow the directions at the end of the Preface for configuring Quicklisp for easy builds and use of the example software for this book.</p>

<h3 id="leanpub-auto-why-use-common-lisp">Why Use Common Lisp?</h3>

<p>Why Common Lisp? Isn’t Common Lisp an old language? Do many people still use Common Lisp?</p>

<p>I believe that using Lisp languages like Common Lisp, Clojure, Racket, and Scheme are all secret weapons useful in agile software development. An interactive development process and live production updates feel like a breath of fresh air if you have development on <em>heavy</em> <em>weight</em> like Java Enterprise Edition (JEE).</p>

<p>Yes, Common Lisp is an old language but with age comes stability and extremely good compiler technology. There is also a little inconsistency between different Common Lisp systems in such things as handling threads but with a little up front knowledge you can choose which Common Lisp systems will support your requirements.</p>

<h3 id="leanpub-auto-a-request-from-the-author">A Request from the Author</h3>

<p>I spent time writing this book to help you, dear reader. I release this book under the Creative Commons License and set the minimum purchase price to $0.00 (free!) in order to reach the most readers. Under this license you can share a PDF version of this book with your friends and coworkers and I encourage you to do so. If you found this book on the web (or it was given to you) and if it provides value to you then please consider doing one of the following to support my future writing efforts and also to support future updates to this book:</p>

<ul>
  <li>Purchase a copy of this book <a href="https://leanpub.com/lovinglisp/">leanpub.com/lovinglisp/</a> or any other of my leanpub books at <a href="https://leanpub.com/u/markwatson">https://leanpub.com/u/markwatson</a>
</li>
  <li><a href="https://markwatson.com/">Hire me as a consultant</a></li>
</ul>

<p>I enjoy writing and your support helps me write new editions and updates for my books and to develop new book projects. Thank you!</p>

<h3 id="leanpub-auto-older-book-editions">Older Book Editions</h3>

<p>The fourth edition of this book was released in May 2017 and the major changes were:</p>

<ul>
  <li>Added an example application KGCreator that processes text data to automatically generate data for Knowledge Graphs. This example application supports the Neo4J graph database as well as semantic web/linked data systems. The major changes were:</li>
  <li>Added a backpropagation neural network example</li>
  <li>Added a deep learning example using the Java based Armed Bear Common Lisp with the popular DeepLearning4j library</li>
  <li>Added a heuristic search example</li>
  <li>Added two machine learning examples (K-Means clustering and SVM classification) using the CLML library</li>
  <li>A few edits to the previous text</li>
</ul>

<p>The third edition was released in October 2014. The major changes made in the 2014 edition are:</p>

<ul>
  <li>I reworked the chapter <strong>Common</strong> <strong>Lisp</strong> <strong>Basics</strong>.</li>
  <li>I added material to the chapter on using QuickLisp.</li>
</ul>

<p>The second edition was released in 2013 and was derived from the version that I distributed on my web site and I moved production of the book to <a href="https://leanpub.com/u/markwatson">leanpub.com</a>.</p>

<h3 id="leanpub-auto-acknowledgments">Acknowledgments</h3>

<p>I would like to thank <a href="https://en.wikipedia.org/wiki/Jans_Aasman">Jans Aasman</a> for contributing as technical editor for the fourth edition of this book. Jans is CEO of <a href="http://franz.com/">Franz.com</a> which sells <a href="http://franz.com/products/allegro-common-lisp/">Allegro Common Lisp</a> as well as tools for semantic web and linked data applications.</p>

<p>I would like to thank the following people who made suggestions for improving previous editions of this book:</p>

<p>Sam Steingold, Andrew Philpot, Kenny Tilton, Mathew Villeneuve, Eli Draluk, Erik Winkels, Adam Shimali, and Paolo Amoroso.</p>

<p>I would like to also thank several people who pointed out typo errors in this book and for specific suggestions:  Martin Lightheart, Tong-Kiat Tan, Rainer Joswig, Gerold Rupprecht, HN member rurban, David Cortesi. I would like to thank the following Reddit /r/lisp readers who pointed out mistakes in the fifth edition of this book: arnulfslayer, rpiirp, and itmuckel. I would like to thank Ted Briscoe for pointing out a problem with the spacy web client example in the 6th edition.</p>

<p>I would like to thank Paul Graham for coining the phrase “The Secret Weapon” (in his excellent paper “Beating the Averages”) in discussing the advantages of Lisp and giving me permission to reuse his phrase.</p>

<h5 id="leanpub-auto-i-would-especially-like-to-thank-my-wife-carol-watson-for-her-fine-work-in-editing-this-book">I would especially like to thank my wife Carol Watson for her fine work in editing this book.</h5>

<h3 id="leanpub-auto-setting-up-your-common-lisp-development-system-and-quicklisp">Setting Up Your Common Lisp Development System and Quicklisp</h3>

<p>These instructions assume the use of SBCL. See comments for LispWorks, Franz Common Lisp, and Closure Common List at the end of this section. I assume that you have installed SBCL and Quicklisp by following the instructions at <a href="https://lisp-lang.org/learn/getting-started/">lisp-lang.org/learn/getting-started</a>. These instructions also guide you through installing the Slime extensions for Emacs. I use both Emacs + Slime and VSCode with Common Lisp plugins for editing Common Lisp. If you like VSCode then I recommend Yasuhiro Matsumoto’s Lisp plugin for syntax highlighting. For both Emacs and VSCode I usually run a separate REPL in a terminal window and don’t run an editor-integrated REPL. I think that I am in the minority in using a separate REPL running in a shell.</p>

<p>I have been using Common Lisp since about 1982 and Quicklisp (developed and maintained by <a href="https://www.xach.com">Zach Beane</a>) has been the most revolutionary change in my Common Lisp development (even more so than getting a hardware Lisp Machine and the availability of Coral Common Lisp on the Macintosh).</p>

<p>You can follow the directions on the main GitHub repository for this book: <a href="https://github.com/mark-watson/loving-common-lisp">https://github.com/mark-watson/loving-common-lisp</a> to get the examples set up to run on your computer. Starting with the 8th edition, I have a new scheme for distributing the book examples on GitHub:</p>

<ul>
  <li>A few short example Common Lisp code snippets are still kept in the main repository for the book: <a href="https://github.com/mark-watson/loving-common-lisp">https://github.com/mark-watson/loving-common-lisp</a>.</li>
  <li>The longer examples are now stored in separate GitHub repositories to facilitate using them as reusable Quicklisp libraries.</li>
  <li>Clone the main GitHub repository and copy the <a href="https://raw.githubusercontent.com/mark-watson/loving-common-lisp/master/Makefile">Makefile</a> to the directory <strong>~/quicklisp/local-projects/</strong> on your computer.</li>
  <li>Change directory to <strong>~/quicklisp/local-projects/</strong> and run the <strong>Makefile</strong> target <strong>make fetch</strong> to copy all separate GitHub repositories to subdirectories of <strong>~/quicklisp/local-projects/</strong>.</li>
  <li>You can now load any book example using Quicklisp, for example: <strong>(ql:quickload :sparql)</strong>.</li>
</ul>

<p>For example, the subdirectory loving-common-lisp/src/spacy-py4cl contains a package named <strong>spacy-py4cl</strong> that can now be accessed from any directory on your system using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">$</code> <code class="n">sbcl</code>
<code class="linenos">2 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"spacy-py4cl"</code><code class="p">)</code>
<code class="linenos">3 </code><code class="o">*</code> <code class="p">(</code><code class="n">spacy</code><code class="o">-</code><code class="n">py4cl</code><code class="p">:</code><code class="n">nlp</code> <code class="s2">"My sister has a dog Henry. She loves him."</code><code class="p">)</code>
<code class="linenos">4 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">x</code> <code class="p">(</code><code class="n">spacy</code><code class="o">-</code><code class="n">py4cl</code><code class="p">:</code><code class="n">nlp</code> <code class="s2">"President Bill Clinton went to Congress. He gave a spe</code><code class="se">\</code>
<code class="linenos">5 </code><code class="s2">ech on taxes and Mexico."</code><code class="p">))</code>
</pre></div>

</figure>

<p>This example uses the deep learning NLP models in spaCy which is a Python library - see the chapter on NLP for details on installing the Python dependencies. Note that only a few examples in this book require Python dependencies.</p>

<p>I have used the SBCL implementation of Common Lisp in this book. There are many fine Common Lisp implementations from Franz, LispWorks, Clozure Common Lisp, etc. I usually use LispWorks for my professional development work. If you have any great difficulty adopting the examples to your choice of Common Lisp implementations and performing web search does not suggest a solution then you can reach me through my web site, <a href="https://markwatson.com">markwatson.com</a>.</p>


<h2 id="introduction">Introduction</h2>

<p>This book is intended to get you, the reader, programming quickly in Common Lisp. Although the Lisp programming language is often associated with artificial intelligence, this introduction is on general Common Lisp programming techniques. Later we will look at general example applications and artificial intelligence examples.</p>

<p>The Common Lisp program examples are distributed <a href="https://github.com/mark-watson/loving-common-lisp">on the github repo for this book</a>.</p>

<h3 id="leanpub-auto-why-did-i-write-this-book">Why Did I Write this Book?</h3>

<p>Why the title “Loving Common Lisp”? Simple! I have been using Lisp for almost 40 years and seldom do I find a better match between a programming language and the programming job at hand. I am not a total fanatic on Lisp, however. I often use Python for deep learning. I like Ruby, Java and Javascript for server side programming, and the few years that I spent working on Nintendo video games and virtual reality systems for SAIC and Disney, I found C++ to be a good bet because of stringent runtime performance requirements. For some jobs, I find the logic-programming paradigm useful: I also enjoy the Prolog language.</p>

<p>In any case, I love programming in Lisp, especially the industry standard Common Lisp. As I wrote the second edition of this book over a decade ago, I had been using Common Lisp almost exclusively for an artificial intelligence project for a health care company and for commercial product development. While working on the third edition of this book, I was not using Common Lisp professionally but since the release of the Quicklisp Common Lisp package manager I have found myself enjoying using Common Lisp more for small side projects. I use Quicklisp throughout in the third edition example code so you can easily install required libraries. For the fourth and fifth editions of this book I have added more examples using neural networks and deep learning. In this new sixth edition I have added a complete application that uses CAP for the user interface.</p>

<p>As programmers, we all (hopefully) enjoy applying our experience and brains for tackling interesting problems. My wife and I recently watched a two-night 7-hour PBS special “Joseph Campbell, and the Power of Myths.” Campbell, a college professor for almost 40 years, said that he always advised his students to “follow their bliss” and not to settle for jobs and avocations that are not what they truly want to do. That said I always feel that when a job calls for using Java, Python or other languages besides Lisp, that even though I may get a lot of pleasure from the job I am not following my bliss.</p>

<p>My goal in this book is to introduce you to one of my favorite programming languages, Common Lisp. I assume that you already know how to program in another language but if you are a complete beginner you can still master the material in this book with some effort. I challenge you to make this effort.</p>

<h3 id="leanpub-auto-free-software-tools-for-common-lisp-programming">Free Software Tools for Common Lisp Programming</h3>

<p>There are several Common Lisp compilers and runtime tools available for free on the web:</p>

<ul>
  <li>CLISP – licensed under the GNU GPL and is available for Windows, Macintosh, and Linux/Unix</li>
  <li>Clozure Common Lisp (CCL) – open source with good Mac OS X and Linux support</li>
  <li>CMU Common Lisp – open source implementation</li>
  <li>SBCL – derived from CMU Common Lisp</li>
  <li>ECL – compiles using a separate C/C++ compiler</li>
  <li>ABCL – Armed Bear Common Lisp for the JVM</li>
</ul>

<p>There are also fine commercial Common Lisp products:</p>

<ul>
  <li>LispWorks – high quality and reasonably priced system for Windows and Linux. No charge for distributing compiled applications <a href="http://www.lispworks.com">lispworks.com</a>
</li>
  <li>Allegro Common Lisp - high quality, great support and higher cost. <a href="http://franz.com">franz.com</a>
</li>
  <li>MCL – Macintosh Common Lisp. I used this Lisp environment in the late 1980s. MCL was so good that I gave away my Xerox 1108 Lisp Machine and switched to a Mac and MCL for my development work. Now open source but only runs on the old MacOS</li>
</ul>

<p>I currently (mostly) use SBCL, CCL, and LispWorks. The SBCL compiler produces very fast code and the compiler warning can be of great value in finding potential problems with your code. Like CCL because it compiles quickly so is often preferable for development.</p>

<p>For working through this book, I will assume that you are using SBCL or CCL. For the example in the last chapter you will need LispWorks and the free Personal edition is fine for the purposes of experimenting with the example application and the CAPI user interface library.</p>

<h3 id="leanpub-auto-making-book-examples-run-portably-on-most-common-lisp-implementations">Making Book Examples Run Portably on Most Common Lisp Implementations</h3>

<p>Many of the book examples require making web service calls. In general when I am writing Common Lisp applications that require making REST calls I prefer using 3rd party Common Lisp libraries like Drakma or Dexador. However it is sometimes a little tricky to set up Common Lisp on different operating systems and CPU architectures with <strong>libopenssl</strong>, <strong>libcrypto</strong>, etc. Because of this, in book examples I run the external <strong>curl</strong> program using <strong>uiop:run-program</strong> and collect the output as a string that is then parsed as JSON or CSV data. The overhead of starting an external process is very small compared to calling a web service so in your own applications you can either follow my example of using <strong>curl</strong> or use the Drakma or Dexador libraries. Using the Apple M1 processor on macOS can be particularly problematic with OpenSSL issues.</p>

<p>I also use the excellent Common Lisp to Python bridge library <strong>py4cl</strong> in a few book examples. Usually <strong>py4cl</strong> installs without problems. </p>

<h3 id="leanpub-auto-how-is-lisp-different-from-languages-like-java-and-c">How is Lisp Different from Languages like Java and C++?</h3>

<p>This is a trick question! Lisp is slightly more similar to Java than C++ because of automated memory management so we will start by comparing Lisp and Java.</p>

<p>In Java, variables are strongly typed while in Common Lisp values are strongly typed. For example, consider the Java code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  Float x = new Float(3.14f);
<code class="linenos">2 </code>  String s = "the cat ran" ;
<code class="linenos">3 </code>  Object any_object = null;
<code class="linenos">4 </code>  any_object = s;
<code class="linenos">5 </code>  x = s;  // illegal: generates a
<code class="linenos">6 </code>          // compilation error
</pre></div>

</figure>

<p>Here, in Java, variables are strongly typed so a variable x of type Float can’t legally be assigned a string value: the code in line 5 would generate a compilation error. Lisp code can assign a value to a variable and then reassign another value of a different type.</p>

<p>Java and Lisp both provide automatic memory management. In either language, you can create new data structures and not worry about freeing memory when the data is no longer used, or to be more precise, is no longer referenced.</p>

<p>Common Lisp is an ANSI standard language. Portability between different Common Lisp implementations and on different platforms is very good. I have used Clozure Common Lisp, SBCL, Allegro Lisp (from Franz Inc), LispWorks, and CLISP that all run well on Windows, Mac OS X, and Linux. As a Common Lisp developer you will have great flexibility in tools and platforms.</p>

<p>ANSI Common Lisp was the first object oriented language to become an ANSI standard language. The Common Lisp Object System (CLOS) is probably the best platform for object oriented programming.</p>

<p>In C++ programs, a common bug that affects a program’s efficiency is forgetting to free memory that is no longer used. In a virtual memory system, the effect of a program’s increasing memory usage is usually just poorer system performance but can lead to system crashes or failures if all available virtual memory is exhausted. A worse type of C++ error is to free memory and then try to use it. Can you say “program crash”? C programs suffer from the same types of memory related errors.</p>

<p>Since computer processing power is usually much less expensive than the costs of software development, it is almost always worth while to give up a few percent of runtime efficiency and let the programming environment of runtime libraries manage memory for you. Languages like Lisp, Ruby, Python, and Java are said to perform automatic garbage collection.</p>

<p>I have written six books on Java, and I have been quoted as saying that for me, programming in Java is about twice as efficient (in terms of my time) as programming in C++. I base this statement on approximately ten years of C++ experience on projects for SAIC, PacBell, Angel Studios, Nintendo, and Disney. I find Common Lisp and other Lisp languages like Clojure and Scheme to be about twice as efficient (again, in terms of my time) as Java. That is correct: I am claiming a four times increase in my programming productivity when using Common Lisp vs. C++.</p>

<p>What do I mean by programming productivity? Simple: for a given job, how long does it take me to design, code, debug, and later maintain the software for a given task.</p>

<h3 id="leanpub-auto-advantages-of-working-in-a-lisp-environment">Advantages of Working in a Lisp Environment</h3>

<p>We will soon see that Lisp is not just a language; it is also a programming environment and runtime environment.</p>

<p>The beginning of this book introduces the basics of Lisp programming. In later chapters, we will develop interesting and non-trivial programs in Common Lisp that I argue would be more difficult to implement in other languages and programming environments.</p>

<p>The big win in programming in a Lisp environment is that you can set up an environment and interactively write new code and test new code in small pieces. We will cover programming with large amounts of data in the <a href="#nlp_chapter">Chapter on Natural Language Processing</a>, but let me share a a general use case for work that I do that is far more efficient in Lisp:</p>

<p>Much of my Lisp programming used to be writing commercial natural language processing (NLP) programs for my company www.knowledgebooks.com. My Lisp NLP code uses a large amount of memory resident data; for example: hash tables for different types of words, hash tables for text categorization, 200,000 proper nouns for place names (cities, counties, rivers, etc.), and about 40,000 common first and last names of various nationalities.</p>

<p>If I was writing my NLP products in C++, I would probably use a relational database to store this data because if I read all of this data into memory for each test run of a C++ program, I would wait 30 seconds every time that I ran a program test. When I start working in any Common Lisp environment, I do have to load the linguistic data into memory one time, but then can code/test/code/test… for hours with no startup overhead for reloading the data that my programs need to run. Because of the interactive nature of Lisp development, I can test small bits of code when tracking down errors and when writing new code.</p>

<p>It is a personal preference, but I find the combination of the stable Common Lisp language and an iterative Lisp programming environment to be much more productive than other languages and programming environments.</p>


<h2 id="leanpub-auto-common-lisp-basics">Common Lisp Basics</h2>

<p>The material in this chapter will serve as an introduction to Common Lisp. I have attempted to make this book a self contained resource for learning Common Lisp and to provide code examples to perform common tasks. If you already know Common Lisp and bought this book for the code examples later in this book then you can probably skip this chapter.</p>

<p>For working through this chapter we will be using the interactive shell, or <strong>repl</strong>, built into SBCL and other Common Lisp systems. For this chapter it is sufficient for you to <a href="http://www.sbcl.org/platform-table.html">download and install SBCL</a>. Please install SBCL right now, if you have not already done so.</p>

<h3 id="leanpub-auto-getting-started-with-sbcl">Getting Started with SBCL</h3>

<p>When we start SBCL, we see an introductory message and then an input prompt. We will start with a short tutorial, walking you through a session using SBCL repl (other Common LISP systems are very similar). A repl is an interactive console where you type expressions and see the results of evaluating these expressions. An expression can be a large block of code pasted into the repl, using the <strong>load</strong> function to load Lisp code into the repl, calling functions to test them, etc. Assuming that SBCL is installed on your system, start SBCL by running the SBCL program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">%</code> <code class="n">sbcl</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="n">running</code> <code class="n">SBCL</code> <code class="n">from</code><code class="p">:</code> <code class="o">/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="n">sbcl</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="n">This</code> <code class="k">is</code> <code class="n">SBCL</code> <code class="mf">2.0</code><code class="o">.</code><code class="mi">2</code><code class="p">,</code> <code class="n">an</code> <code class="n">implementation</code> <code class="n">of</code> <code class="n">ANSI</code> <code class="n">Common</code> <code class="n">Lisp</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="n">More</code> <code class="n">information</code> <code class="n">about</code> <code class="n">SBCL</code> <code class="k">is</code> <code class="n">available</code> <code class="n">at</code> <code class="o">&lt;</code><code class="n">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="o">.</code><code class="n">sbcl</code><code class="o">.</code><code class="n">org</code><code class="o">/&gt;.</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="n">SBCL</code> <code class="k">is</code> <code class="n">free</code> <code class="n">software</code><code class="p">,</code> <code class="n">provided</code> <code class="k">as</code> <code class="k">is</code><code class="p">,</code> <code class="n">with</code> <code class="n">absolutely</code> <code class="n">no</code> <code class="n">warranty</code><code class="o">.</code>
<code class="linenos"> 7 </code><code class="n">It</code> <code class="k">is</code> <code class="n">mostly</code> <code class="ow">in</code> <code class="n">the</code> <code class="n">public</code> <code class="n">domain</code><code class="p">;</code> <code class="n">some</code> <code class="n">portions</code> <code class="n">are</code> <code class="n">provided</code> <code class="n">under</code>
<code class="linenos"> 8 </code><code class="n">BSD</code><code class="o">-</code><code class="n">style</code> <code class="n">licenses</code><code class="o">.</code>  <code class="n">See</code> <code class="n">the</code> <code class="n">CREDITS</code> <code class="ow">and</code> <code class="n">COPYING</code> <code class="n">files</code> <code class="ow">in</code> <code class="n">the</code>
<code class="linenos"> 9 </code><code class="n">distribution</code> <code class="k">for</code> <code class="n">more</code> <code class="n">information</code><code class="o">.</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">x</code> <code class="mf">1.0</code><code class="p">)</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="n">X</code>
<code class="linenos">14 </code><code class="o">*</code> <code class="n">x</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="mf">1.0</code>
<code class="linenos">17 </code><code class="o">*</code> <code class="p">(</code><code class="o">+</code> <code class="n">x</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="mf">2.0</code>
<code class="linenos">20 </code><code class="o">*</code> <code class="n">x</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="mf">1.0</code>
<code class="linenos">23 </code><code class="o">*</code> <code class="p">(</code><code class="n">setq</code> <code class="n">x</code> <code class="p">(</code><code class="o">+</code> <code class="n">x</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="mf">2.0</code>
<code class="linenos">26 </code><code class="o">*</code> <code class="n">x</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="mf">2.0</code>
<code class="linenos">29 </code><code class="o">*</code> <code class="p">(</code><code class="n">setq</code> <code class="n">x</code> <code class="s2">"the dog chased the cat"</code><code class="p">)</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code><code class="s2">"the dog chased the cat"</code>
<code class="linenos">32 </code><code class="o">*</code> <code class="n">x</code>
<code class="linenos">33 </code>
<code class="linenos">34 </code><code class="s2">"the dog chased the cat"</code>
<code class="linenos">35 </code><code class="o">*</code> <code class="p">(</code><code class="n">quit</code><code class="p">)</code>
</pre></div>

</figure>

<p>We started by defining a new variable x in line 11. Notice how the value of the <strong>defvar</strong> macro is the symbol that is defined. The Lisp reader prints <strong>X</strong> capitalized because symbols are made upper case (we will look at the exception later).</p>

<p>In Lisp, a variable can reference any data type. We start by assigning a floating point value to the variable <strong>x</strong>, using the <strong>+</strong> function to add 1 to <strong>x</strong> in line 17, using the <strong>setq</strong> function to change the value of <strong>x</strong> in lines 23 and 29 first to another floating point value and finally setting <strong>x</strong> to a string value. One thing that you will have noticed: function names always occur first, then the arguments to a function. Also, parenthesis is used to separate expressions.</p>

<p>I learned to program Lisp in 1976 and my professor half-jokingly told us that Lisp was an acronym for “Lots-of Irritating Superfluous Parenthesis.” There may be some truth in this when you are just starting with Lisp programming, but you will quickly get used to the parenthesis, especially if you use an editor like Emacs that automatically indents Lisp code for you and highlights the opening parenthesis for every closing parenthesis that you type. Many other editors support coding in Lisp but I personally use Emacs or sometimes VScode (with Common Lisp plugins) to edit Lisp code.</p>

<p>Before you proceed to the next chapter, please take the time to install SBCL on your computer and try typing some expressions into the Lisp listener. If you get errors, or want to quit, try using the quit function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (+ 1 2 3 4)
<code class="linenos">2 </code>
<code class="linenos">3 </code>10
<code class="linenos">4 </code>* (quit)
<code class="linenos">5 </code>Bye.
</pre></div>

</figure>

<p>If you get an error you can enter <strong>help</strong> to get options for handling an error. When I get an error and have a good idea of what caused the error then I just enter <strong>:a:</strong> to abort out of the error).</p>

<p>As we discussed in the introduction, there are many different Lisp programming environments that you can choose from. I recommend a free set of tools: Emacs, Quicklisp, slime, and SBCL. Emacs is a fine text editor that is extensible to work well with many programming languages and document types (e.g., HTML and XML). Slime is an Emacs extension package that greatly facilitates Lisp development. SBCL is a robust Common Lisp compiler and runtime system that is often used in production.</p>

<p>We will cover the Quicklisp package manager and using Quicklisp to setup Slime and Emacs in a later chapter. </p>

<p>I will not spend much time covering the use of Emacs as a text editor in this book since you can try most of the example code snippets in the book text by copying and then pasting them into a SBCL repl and by loading the book example source files directly into a repl. If you already use Emacs then I recommend that you do set up Slime sooner rather than later and start using it for development. If you are not already an Emacs user and do not mind spending the effort to learn Emacs, then search the web first for an Emacs tutorial. That said, you will easily be able to use the example code from this book using any text editor you like with a SBCL repl. I don’t use the vi or vim editors but if vi is your weapon of choice for editing text then a web search for “common lisp vi vim repl” should get you going for developing Common Lisp code with vi or vim. If you are not already an Emacs or vi user then using VSCode with a Common Lisp plugin is recommended.</p>

<p>Here, we will assume that under Windows, Unix, Linux, or Mac OS X you will use one command window to run SBCL and a separate editor that can edit plain text files.</p>

<h3 id="leanpub-auto-making-the-repl-nicer-using-rlwrap">Making the repl Nicer using rlwrap</h3>

<p>While reading the last section you (hopefully!) played with the SBCL interactive repl. If you haven’t played with the repl, I won’t get too judgmental except to say that if you do not play with the examples as you read you will not get the full benefit from this book.</p>

<p>Did you notice that the backspace key does not work in the SBCL repl? The way to fix this is to install the GNU <strong>rlwrap</strong> utility. On OS X, assuming that you have <a href="http://mxcl.github.io/homebrew/">homebrew</a> installed, install rlwrap with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>brew install rlwrap
</pre></div>

</figure>

<p>If you are running Ubuntu Linux, install rlwrap using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>sudo apt-get install rlwrap
</pre></div>

</figure>

<p>You can then create an alias for bash or zsh using something like the following to define a command <strong>rsbcl</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>alias rsbcl='rlwrap sbcl'
</pre></div>

</figure>

<p>This is fine, just remember to run <strong>sbcl</strong> if you don’t need rlwrap command line editing or run <strong>rsbcl</strong> when you do need command line editing. That said, I find that I <em>always</em> want to run SBCL with command line editing, so I redefine <em>sbcl</em> on my computers using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">-&gt;</code>  <code class="o">~</code>  <code class="nf">which</code> <code class="n">sbcl</code>
<code class="linenos">2 </code><code class="o">/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="n">sbcl</code><code class="o">/</code><code class="n">sbcl</code>
<code class="linenos">3 </code><code class="o">-&gt;</code>  <code class="o">~</code>  <code class="n">alias</code> <code class="n">sbcl</code><code class="o">=</code><code class="s">'rlwrap /Users/markw/sbcl/sbcl'</code>
</pre></div>

</figure>

<p>This alias is different on my laptops and servers, since I don’t usually install SBCL in the default installation directory. For each of my computers, I add an appropriate alias in my .zshrc file (if I am running zsh) or my .bashrc file (if I am running bash).</p>

<h3 id="leanpub-auto-the-basics-of-lisp-programming">The Basics of Lisp Programming</h3>

<p>Although we will use SBCL in this book, any Common Lisp environment will do fine. In previous sections, we saw the top-level Lisp prompt and how we could type any expression that would be evaluated:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>* 1
<code class="linenos"> 2 </code>1
<code class="linenos"> 3 </code>* 3.14159
<code class="linenos"> 4 </code>3.14159
<code class="linenos"> 5 </code>* "the dog bit the cat"
<code class="linenos"> 6 </code>"the dog bit the cat"
<code class="linenos"> 7 </code>* (defun my-add-one (x)
<code class="linenos"> 8 </code>(+ x 1))
<code class="linenos"> 9 </code>MY-ADD-ONE
<code class="linenos">10 </code>* (my-add-one -10)
<code class="linenos">11 </code>-9
</pre></div>

</figure>

<p>Notice that when we defined the function my-add-one in lines 7 and 8, we split the definition over two lines and on line 8 you don’t see the “*” prompt from SBCL – this lets you know that you have not yet entered a complete expression. The top level Lisp evaluator counts parentheses and considers a form to be complete when the number of closing parentheses equals the number of opening parentheses and an expression is complete when the parentheses match. I tend to count in my head, adding one for every opening parentheses and subtracting one for every closing parentheses – when I get back down to zero then the expression is complete. When we evaluate a number (or a variable), there are no parentheses, so evaluation proceeds when we hit a new line (or carriage return).</p>

<p>The Lisp reader by default tries to evaluate any form that you enter. There is a reader macro <strong>‘</strong> that prevents the evaluation of an expression. You can either use the <strong>‘</strong> character or <strong>quote</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (+ 1 2)
<code class="linenos">2 </code>3
<code class="linenos">3 </code>* '(+ 1 2)
<code class="linenos">4 </code>(+ 1 2)
<code class="linenos">5 </code>* (quote (+ 1 2))
<code class="linenos">6 </code>(+ 1 2)
<code class="linenos">7 </code>* 
</pre></div>

</figure>

<p>Lisp supports both global and local variables. Global variables can be declared using <strong>defvar</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code> <code class="s2">"cat"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="o">*</code><code class="n">X</code><code class="o">*</code>
<code class="linenos"> 3 </code><code class="o">*</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code>
<code class="linenos"> 4 </code><code class="s2">"cat"</code>
<code class="linenos"> 5 </code><code class="o">*</code> <code class="p">(</code><code class="n">setq</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code> <code class="s2">"dog"</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="s2">"dog"</code>
<code class="linenos"> 7 </code><code class="o">*</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code>
<code class="linenos"> 8 </code><code class="s2">"dog"</code>
<code class="linenos"> 9 </code><code class="o">*</code> <code class="p">(</code><code class="n">setq</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="linenos">10 </code><code class="mf">3.14159</code>
<code class="linenos">11 </code><code class="o">*</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code>
<code class="linenos">12 </code><code class="mf">3.14159</code>
</pre></div>

</figure>

<p>One thing to be careful of when defining global variables with <strong>defvar</strong>: the declared global variable is dynamically scoped. We will discuss dynamic versus lexical scoping later, but for now a warning: if you define a global variable avoid redefining the same variable name inside functions. Lisp programmers usually use a global variable naming convention of beginning and ending dynamically scoped global variables with the * character. If you follow this naming convention and also do not use the * character in local variable names, you will stay out of trouble. For convenience, I do not always follow this convention in short examples in this book.</p>

<p>Lisp variables have no type. Rather, values assigned to variables have a type. In this last example, the variable x was set to a string, then to a floating-point number. Lisp types support inheritance and can be thought of as a hierarchical tree with the type t at the top. (Actually, the type hierarchy is a DAG, but we can ignore that for now.) Common Lisp also has powerful object oriented programming facilities in the Common Lisp Object System (CLOS) that we will discuss in a later chapter.</p>

<p>Here is a partial list of types (note that indentation denotes being a subtype of the preceding type):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>t  [top level type (all other types are a sub-type)]
<code class="linenos"> 2 </code>     sequence
<code class="linenos"> 3 </code>          list
<code class="linenos"> 4 </code>          array
<code class="linenos"> 5 </code>               vector
<code class="linenos"> 6 </code>                    string
<code class="linenos"> 7 </code>     number
<code class="linenos"> 8 </code>          float
<code class="linenos"> 9 </code>          rational
<code class="linenos">10 </code>               integer
<code class="linenos">11 </code>               ratio
<code class="linenos">12 </code>          complex
<code class="linenos">13 </code>     character
<code class="linenos">14 </code>     symbol
<code class="linenos">15 </code>     structure
<code class="linenos">16 </code>     function
<code class="linenos">17 </code>     hash-table
</pre></div>

</figure>

<p>We can use the <strong>typep</strong> function to test the type of value of any variable or expression or use <strong>type-of</strong> to get type information of any value):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>* (setq x '(1 2 3))
<code class="linenos"> 2 </code>(1 2 3)
<code class="linenos"> 3 </code>* (typep x 'list)
<code class="linenos"> 4 </code>T
<code class="linenos"> 5 </code>* (typep x 'sequence)
<code class="linenos"> 6 </code>T
<code class="linenos"> 7 </code>* (typep x 'number)
<code class="linenos"> 8 </code>NIL
<code class="linenos"> 9 </code>* (typep (+ 1 2 3) 'number)
<code class="linenos">10 </code>T
<code class="linenos">11 </code>* (type-of 3.14159)
<code class="linenos">12 </code>single-float
<code class="linenos">13 </code>* (type-of "the dog ran quickly")
<code class="linenos">14 </code>(simple-array character (19))
<code class="linenos">15 </code>* (type-of 100193)
<code class="linenos">16 </code>(integer 0 4611686018427387903)
</pre></div>

</figure>

<p>A useful feature of all ANSI standard Common Lisp implementations’ top-level listener is that it sets * to the value of the last expression evaluated. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (+ 1 2 3 4 5)
<code class="linenos">2 </code>15
<code class="linenos">3 </code>* *
<code class="linenos">4 </code>15
<code class="linenos">5 </code>* (setq x *)
<code class="linenos">6 </code>15
<code class="linenos">7 </code>* x
<code class="linenos">8 </code>15
</pre></div>

</figure>

<p>All Common Lisp environments set * to the value of the last expression evaluated. This example may be slightly confusing because * is also the prompt character in the SBCL repl that indicates that you can enter a new expression for evaluation. For example in line 3, the first * character is the repl prompt and the second * we type in to see that value of the previous expression that we typed into the repl.</p>

<p>Frequently, when you are interactively testing new code, you will call a function that you just wrote with test arguments; it is useful to save intermediate results for later testing. It is the ability to create complex data structures and then experiment with code that uses or changes these data structures that makes Lisp programming environments so effective.</p>

<p>Common Lisp is a lexically scoped language that means that variable declarations and function definitions can be nested and that the same variable names can be used in nested let forms; when a variable is used, the current let form is searched for a definition of that variable and if it is not found, then the next outer let form is searched. Of course, this search for the correct declaration of a variable is done at compile time so there need not be extra runtime overhead. We can nest <strong>defun</strong> special form inside each other and inside <strong>let</strong> expressions but this defines the nested functions globally. We use the special forms <strong>flet</strong> and <strong>labels</strong> to define functions inside a scoped environment. Functions defined inside a <strong>labels</strong> special form can be recursive while functions defined inside a <strong>flet</strong> special form cannot be recursive. Consider the following example in the file <strong>nested.lisp</strong> (all example files are in the <strong>src</strong> directory):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">flet</code> <code class="p">((</code><code class="nv">add-one</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 2 </code>         <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos"> 3 </code>       <code class="p">(</code><code class="nv">add-two</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 4 </code>         <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="mi">2</code><code class="p">)))</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"redefined variables: ~A  ~A~%"</code> <code class="p">(</code><code class="nv">add-one</code> <code class="mi">100</code><code class="p">)</code> <code class="p">(</code><code class="nv">add-two</code> <code class="mi">100</code><code class="p">)))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">a</code> <code class="mf">3.14</code><code class="p">))</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">test2</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="nv">test2</code> <code class="nv">a</code><code class="p">))</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="nv">test2</code> <code class="mi">50</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">15 </code>      <code class="p">(</code><code class="nv">y</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">16 </code>  <code class="c1">;; define a test function nested inside a let statement:</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="k">flet</code> <code class="p">((</code><code class="nv">test</code> <code class="p">(</code><code class="nv">a</code> <code class="nv">b</code><code class="p">)</code>
<code class="linenos">18 </code>           <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">z</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">a</code> <code class="nv">b</code><code class="p">)))</code>
<code class="linenos">19 </code>             <code class="c1">;; define a helper function nested inside a let/function/let:</code>
<code class="linenos">20 </code>             <code class="p">(</code><code class="k">flet</code> <code class="p">((</code><code class="nv">nested-function</code> <code class="p">(</code><code class="nv">a</code><code class="p">)</code>
<code class="linenos">21 </code>                      <code class="p">(</code><code class="nb">+</code> <code class="nv">a</code> <code class="nv">a</code><code class="p">)))</code>
<code class="linenos">22 </code>               <code class="p">(</code><code class="nv">nested-function</code> <code class="nv">z</code><code class="p">)))))</code>
<code class="linenos">23 </code>    <code class="c1">;; call nested function 'test':</code>
<code class="linenos">24 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"test result is ~A~%"</code> <code class="p">(</code><code class="nv">test</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">))))</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">z</code> <code class="mi">10</code><code class="p">))</code>
<code class="linenos">27 </code>  <code class="p">(</code><code class="k">labels</code> <code class="p">((</code><code class="nv">test-recursion</code> <code class="p">(</code><code class="nv">a</code><code class="p">)</code>
<code class="linenos">28 </code>             <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"test-recursion ~A~%"</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">a</code> <code class="nv">z</code><code class="p">))</code>
<code class="linenos">29 </code>             <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="nv">a</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">30 </code>                 <code class="p">(</code><code class="nv">test-recursion</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">a</code> <code class="mi">1</code><code class="p">)))))</code>
<code class="linenos">31 </code>    <code class="p">(</code><code class="nv">test-recursion</code> <code class="mi">5</code><code class="p">)))</code>
</pre></div>

</figure>

<p>We define a top level <strong>flet</strong> special form in lines 1-5 that defines two nested functions <strong>add-one</strong> and <strong>add-two</strong> and then calls each nested function in the body of the <strong>flet</strong> special form. For many years I have used nested <strong>defun</strong> special forms inside <strong>let</strong> expressions for defining local functions and you will notice this use in a few later examples. However, functions defined inside <strong>defun</strong> special forms have global visibility so they are not hidden in the local context where they are defined. The example of a nested <strong>defun</strong> in lines 7-12 shows that the function <strong>test2</strong> has global visibility inside the current package.</p>

<p>Functions defined inside of a <strong>flet</strong> special form have access to variables defined in the outer scope containing the <strong>flet</strong> (also applies to <strong>labels</strong>). We see this in lines 14-24 where the local variables <strong>x</strong> and <strong>y</strong> defined in the <strong>let</strong> expression are visible inside the function <strong>nested-function</strong> defined inside the <strong>flet</strong>.</p>

<p>The final example in lines 26-31 shows a recursive function defined inside a <strong>labels</strong> special form.</p>

<p>Assuming that we started SBCL in the <strong>src</strong> directory we can then use the Lisp load function to evaluate the contents of the file <strong>nested.lisp</strong> in the sub-directory <strong>code_snippets_for_book</strong> using the <strong>load</strong> function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"./code_snippets_for_book/nested.lisp"</code><code class="p">)</code>
<code class="n">redefined</code> <code class="n">variables</code><code class="p">:</code> <code class="mi">101</code>  <code class="mi">102</code>

<code class="mf">3.14</code> 
<code class="mi">50</code> <code class="n">test</code> <code class="n">result</code> <code class="k">is</code> <code class="mi">6</code>
<code class="n">test</code><code class="o">-</code><code class="n">recursion</code> <code class="mi">15</code>
<code class="n">test</code><code class="o">-</code><code class="n">recursion</code> <code class="mi">14</code>
<code class="n">test</code><code class="o">-</code><code class="n">recursion</code> <code class="mi">13</code>
<code class="n">test</code><code class="o">-</code><code class="n">recursion</code> <code class="mi">12</code>
<code class="n">test</code><code class="o">-</code><code class="n">recursion</code> <code class="mi">11</code>
<code class="n">test</code><code class="o">-</code><code class="n">recursion</code> <code class="mi">10</code>
<code class="n">T</code>
<code class="o">*</code>
</pre></div>

</figure>

<p>The function <strong>load</strong> returned a value of <strong>t</strong> (prints in upper case as <strong>T</strong>) after successfully loading the file.</p>

<p>We will use Common Lisp vectors and arrays frequently in later chapters, but will also briefly introduce them here. A singly dimensioned array is also called a vector. Although there are often more efficient functions for handling vectors, we will just look at generic functions that handle any type of array, including vectors. Common Lisp provides support for functions with the same name that take different argument types; we will discuss this in some detail when we cover this in the later chapter on CLOS. We will start by defining three vectors <strong>v1</strong>, <strong>v2</strong>, and <strong>v3</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (setq v1 (make-array '(3)))
<code class="linenos">2 </code>#(NIL NIL NIL)
<code class="linenos">3 </code>* (setq v2 (make-array '(4) :initial-element "lisp is good"))
<code class="linenos">4 </code>#("lisp is good" "lisp is good" "lisp is good" "lisp is good")
<code class="linenos">5 </code>* (setq v3 #(1 2 3 4 "cat" '(99 100)))
<code class="linenos">6 </code>#(1 2 3 4 "cat" '(99 100))
</pre></div>

</figure>

<p>In line 1, we are defining a one-dimensional array, or vector, with three elements. In line 3 we specify the default value assigned to each element of the array <em>v2</em>. In line 5 I use the form for specifying array literals using the special character #. The function <strong>aref</strong> can be used to access any element in an array:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (aref v3 3)
4
* (aref v3 5)
'(99 100)
* 
</pre></div>

</figure>

<p>Notice how indexing of arrays is zero-based; that is, indices start at zero for the first element of a sequence. Also notice that array elements can be any Lisp data type. So far, we have used the special operator <strong>setq</strong> to set the value of a variable. Common Lisp has a generalized version of <strong>setq</strong> called <strong>setf</strong> that can set any value in a list, array, hash table, etc. You can use <strong>setf</strong> instead of <strong>setq</strong> in all cases, but not vice-versa. Here is a simple example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* v1
#(NIL NIL NIL)
* (setf (aref v1 1) "this is a test") 
"this is a test"
* v1
#(NIL "this is a test" NIL)
* 
</pre></div>

</figure>

<p>When writing new code or doing quick programming experiments, it is often easiest (i.e., quickest to program) to use lists to build interesting data structures. However, as programs mature, it is common to modify them to use more efficient (at runtime) data structures like arrays and hash tables.</p>

<h3 id="leanpub-auto-symbols">Symbols</h3>

<p>We will discuss symbols in more detail the <a href="#package_system">Chapter on Common Lisp Packages</a>. For now, it is enough for you to understand that symbols can be names that refer to variables. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">&gt;</code> <code class="p">(</code><code class="n">defvar</code> <code class="o">*</code><code class="n">cat</code><code class="o">*</code> <code class="s2">"bowser"</code><code class="p">)</code>
<code class="o">*</code><code class="n">CAT</code><code class="o">*</code>
<code class="o">*</code> <code class="o">*</code><code class="n">cat</code><code class="o">*</code>
<code class="s2">"bowser"</code>
<code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="o">*</code><code class="n">l</code><code class="o">*</code> <code class="p">(</code><code class="n">list</code> <code class="o">*</code><code class="n">cat</code><code class="o">*</code><code class="p">))</code>
<code class="o">*</code><code class="n">L</code><code class="o">*</code>
<code class="o">*</code> <code class="o">*</code><code class="n">l</code><code class="o">*</code>
<code class="p">(</code><code class="s2">"bowser"</code><code class="p">)</code>
<code class="o">*</code>
</pre></div>

</figure>

<p>Note that the first <strong>defvar</strong> returns the defined symbol as its value. Symbols are almost always converted to upper case. An exception to this “upper case rule” is when we define symbols that may contain white space using vertical bar characters:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="o">|</code><code class="n">a</code> <code class="n">symbol</code> <code class="n">with</code> <code class="n">Space</code> <code class="n">Characters</code><code class="o">|</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="o">|</code><code class="n">a</code> <code class="n">symbol</code> <code class="n">with</code> <code class="n">Space</code> <code class="n">Characters</code><code class="o">|</code>
<code class="o">*</code> <code class="o">|</code><code class="n">a</code> <code class="n">symbol</code> <code class="n">with</code> <code class="n">Space</code> <code class="n">Characters</code><code class="o">|</code>
<code class="mf">3.14159</code>
<code class="o">*</code> 
</pre></div>

</figure>

<h3 id="leanpub-auto-operations-on-lists">Operations on Lists</h3>

<p>Lists are a fundamental data structure of Common Lisp. In this section, we will look at some of the more commonly used functions that operate on lists. All of the functions described in this section have something in common: they do not modify their arguments.</p>

<p>In Lisp, a cons cell is a data structure containing two pointers. Usually, the first pointer in a cons cell will point to the first element in a list and the second pointer will point to another cons representing the start of the rest of the original list.</p>

<p>The function cons takes two arguments that it stores in the two pointers of a new cons data structure. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (cons 1 2)
(1 . 2)
* (cons 1 '(2 3 4))
(1 2 3 4)
* 
</pre></div>

</figure>

<p>The first form evaluates to a cons data structure while the second evaluates to a cons data structure that is also a proper list. The difference is that in the second case the second pointer of the freshly created cons data structure points to another cons cell.</p>

<p>First, we will declare two global variables <strong>l1</strong> and <strong>l2</strong> that we will use in our examples. The list <strong>l1</strong> contains five elements and the list <strong>l2</strong> contains four elements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">l1</code> <code class="s1">'(1 2 (3) 4 (5 6)))</code>
<code class="n">L1</code>
<code class="o">*</code> <code class="p">(</code><code class="n">length</code> <code class="n">l1</code><code class="p">)</code>

<code class="mi">5</code>
<code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">l2</code> <code class="s1">'(the "dog" calculated 3.14159))</code>
<code class="n">L2</code>
<code class="o">*</code> <code class="n">l1</code>
<code class="p">(</code><code class="mi">1</code> <code class="mi">2</code> <code class="p">(</code><code class="mi">3</code><code class="p">)</code> <code class="mi">4</code> <code class="p">(</code><code class="mi">5</code> <code class="mi">6</code><code class="p">))</code>
<code class="o">*</code> <code class="n">l2</code>
<code class="p">(</code><code class="n">THE</code> <code class="s2">"dog"</code> <code class="n">CALCULATED</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="o">&gt;</code>
</pre></div>

</figure>

<p>You can also use the function <strong>list</strong> to create a new list; the arguments passed to function list are the elements of the created list:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (list 1 2 3 'cat "dog")
(1 2 3 CAT "dog")
*
</pre></div>

</figure>

<p>The function <strong>car</strong> returns the first element of a list and the function <strong>cdr</strong> returns a list with its first element removed (but does not modify its argument):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (car l1)
1
* (cdr l1)
(2 (3) 4 (5 6))
*
</pre></div>

</figure>

<p>Using combinations of <strong>car</strong> and <strong>cdr</strong> calls can be used to extract any element of a list:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (car (cdr l1))
2
* (cadr l1)
2
*
</pre></div>

</figure>

<p>Notice that we can combine calls to <strong>car</strong> and <strong>cdr</strong> into a single function call, in this case the function <strong>cadr</strong>. Common Lisp defines all functions of the form <strong>cXXr</strong>, <strong>cXXXr</strong>, and <strong>cXXXXr</strong> where <strong>X</strong> can be either <strong>a</strong> or <strong>d</strong>.</p>

<p>Suppose that we want to extract the value 5 from the nested list <strong>l1</strong>. Some experimentation with using combinations of <strong>car</strong> and <strong>cdr</strong> gets the job done:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* l1
(1 2 (3) 4 (5 6))
* (cadr l1)
2
* (caddr l1)
(3)
(car (caddr l1))
3
* (caar (last l1))
5
* (caar (cddddr l1))

5
*
</pre></div>

</figure>

<p>The function <strong>last</strong> returns the last <strong>cdr</strong> of a list (i.e., the last element, in a list):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (last l1)
((5 6))
*
</pre></div>

</figure>

<p>Common list supplies alternative functions to <strong>car</strong> and <strong>cdr</strong> that you might find more readable: <strong>first</strong>, <strong>second</strong>, <strong>third</strong>, <strong>fourth</strong>, and <strong>rest</strong>. Here are some examples:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code> <code class="s1">'(1 2 3 4 5))</code>

<code class="o">*</code><code class="n">X</code><code class="o">*</code>
<code class="o">*</code> <code class="p">(</code><code class="n">first</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code><code class="p">)</code>

<code class="mi">1</code>
<code class="o">*</code> <code class="p">(</code><code class="n">rest</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code><code class="p">)</code>

<code class="p">(</code><code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code><code class="p">)</code>
<code class="o">*</code> <code class="p">(</code><code class="n">second</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code><code class="p">)</code>

<code class="mi">2</code>
<code class="o">*</code> <code class="p">(</code><code class="n">third</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code><code class="p">)</code>

<code class="mi">3</code>
<code class="o">*</code> <code class="p">(</code><code class="n">fourth</code> <code class="o">*</code><code class="n">x</code><code class="o">*</code><code class="p">)</code>

<code class="mi">4</code>
</pre></div>

</figure>

<p>The function <strong>nth</strong> takes two arguments: an index of a top-level list element and a list. The first index argument is zero based:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* l1
(1 2 (3) 4 (5 6))
* (nth 0 l1)
1
* (nth 1 l1)
2
* (nth 2 l1)
(3)
*
</pre></div>

</figure>

<p>The function <strong>cons</strong> adds an element to the beginning of a list and returns as its value a new list (it does not modify its arguments). An element added to the beginning of a list can be any Lisp data type, including another list:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (cons 'first l1)
(FIRST 1 2 (3) 4 (5 6))
* (cons '(1 2 3) '(11 22 33))
((1 2 3) 11 22 33)
* 
</pre></div>

</figure>

<p>The function <strong>append</strong> takes two lists as arguments and returns as its value the two lists appended together:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* l1
(1 2 (3) 4 (5 6))
* l2
('THE "dog" 'CALCULATED 3.14159)
* (append l1 l2)
(1 2 (3) 4 (5 6) THE "dog" CALCULATED 3.14159)
* (append '(first) l1)
(FIRST 1 2 (3) 4 (5 6))
* 
</pre></div>

</figure>

<p>A frequent error that beginning Lisp programmers make is not understanding shared structures in lists. Consider the following example where we generate a list y by reusing three copies of the list x:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (setq x '(0 0 0 0))
(0 0 0 0)
* (setq y (list x x x))
((0 0 0 0) (0 0 0 0) (0 0 0 0))
* (setf (nth 2 (nth 1 y)) 'x)
X
* x
(0 0 X 0)
* y
((0 0 X 0) (0 0 X 0) (0 0 X 0))
* (setq z '((0 0 0 0) (0 0 0 0) (0 0 0 0)))
((0 0 0 0) (0 0 0 0) (0 0 0 0))
* (setf (nth 2 (nth 1 z)) 'x)
X
* z
((0 0 0 0) (0 0 X 0) (0 0 0 0))
* 
</pre></div>

</figure>

<p>When we change the shared structure referenced by the variable <strong>x</strong> that change is reflected three times in the list <strong>y</strong>. When we create the list stored in the variable <strong>z</strong> we are not using a shared structure.</p>

<h3 id="leanpub-auto-using-arrays-and-vectors">Using Arrays and Vectors</h3>

<p>Using lists is easy but the time spent accessing a list element is proportional to the length of the list. Arrays and vectors are more efficient at runtime than long lists because list elements are kept on a linked-list that must be searched. Accessing any element of a short list is fast, but for sequences with thousands of elements, it is faster to use vectors and arrays.</p>

<p>By default, elements of arrays and vectors can be any Lisp data type. There are options when creating arrays to tell the Common Lisp compiler that a given array or vector will only contain a single data type (e.g., floating point numbers) but we will not use these options in this book.</p>

<p>Vectors are a specialization of arrays; vectors are arrays that only have one dimension. For efficiency, there are functions that only operate on vectors, but since array functions also work on vectors, we will concentrate on arrays. In the next section, we will look at character strings that are a specialization of vectors.</p>

<p>We could use the generalized <strong>make-sequence</strong> function to make a singularly dimensioned array (i.e., a vector). Restart sbcl and try:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">x</code> <code class="p">(</code><code class="n">make</code><code class="o">-</code><code class="n">sequence</code> <code class="s1">'vector 5 :initial-element 0))</code>
<code class="n">X</code>
<code class="o">*</code> <code class="n">x</code>
<code class="c1">#(0 0 0 0 0)</code>
<code class="o">*</code> 
</pre></div>

</figure>

<p>In this example, notice the print format for vectors that looks like a list with a proceeding # character. As seen in the last section, we use the function <strong>make-array</strong> to create arrays:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">y</code> <code class="p">(</code><code class="n">make</code><code class="o">-</code><code class="n">array</code> <code class="s1">'(2 3) :initial-element 1))</code>
<code class="n">Y</code>
<code class="o">*</code> <code class="n">y</code>
<code class="c1">#2A((1 1 1) (1 1 1))</code>
<code class="o">&gt;</code>
</pre></div>

</figure>

<p>Notice the print format of an array: it looks like a list proceeded by a # character and the integer number of dimensions.</p>

<p>Instead of using <strong>make-sequence</strong> to create vectors, we can pass an integer as the first argument of <strong>make-array</strong> instead of a list of dimension values. We can also create a vector by using the function <strong>vector</strong> and providing the vector contents as arguments:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (make-array 10)  
#(NIL NIL NIL NIL NIL NIL NIL NIL NIL NIL)
* (vector 1 2 3 'cat)
#(1 2 3 CAT)
* 
</pre></div>

</figure>

<p>The function <strong>aref</strong> is used to access sequence elements. The first argument is an array and the remaining argument(s) are array indices. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* x
#(0 0 0 0 0)
* (aref x 2)
0
* (setf (aref x 2) "parrot")
"parrot"
* x
#(0 0 "parrot" 0 0)
* (aref x 2)
"parrot"
* y
#2A((1 1 1) (1 1 1))
* (setf (aref y 1 2) 3.14159)
3.14159
* y
#2A((1 1 1) (1 1 3.14159))
* 
</pre></div>

</figure>

<h3 id="leanpub-auto-using-strings">Using Strings</h3>

<p>It is likely that even your first Lisp programs will involve the use of character strings. In this section, we will cover the basics: creating strings, concatenating strings to create new strings, for substrings in a string, and extracting substrings from longer strings. The string functions that we will look at here do not modify their arguments; rather, they return new strings as values. For efficiency, Common Lisp does include destructive string functions that do modify their arguments but we will not discuss these destructive functions here.</p>

<p>We saw earlier that a string is a type of vector, which in turn is a type of array (which in turn is a type of sequence). A full coverage of the Common Lisp type system is outside the scope of this tutorial introduction to Common Lisp; a very good treatment of Common Lisp types is in Guy Steele’s “Common Lisp, The Language” which is available both in print and for free on the web. Many of the built in functions for handling strings are actually more general because they are defined for the type sequence. The Common Lisp Hyperspec is another great free resource that you can find on the web. I suggest that you download an HTML version of Guy Steele’s excellent reference book and the Common Lisp Hyperspec and keep both on your computer. If you continue using Common Lisp, eventually you will want to read all of Steele’s book and use the Hyperspec for reference.</p>

<p>The following text was captured from input and output from a Common Lisp repl. First, we will declare two global variables <strong>s1</strong> and <strong>space</strong> that contain string values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">s1</code> <code class="s2">"the cat ran up the tree"</code><code class="p">)</code>
<code class="n">S1</code>
<code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">space</code> <code class="s2">" "</code><code class="p">)</code>
<code class="n">SPACE</code>
<code class="o">*</code> 
</pre></div>

</figure>

<p>One of the most common operations on strings is to concatenate two or more strings into a new string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (concatenate 'string s1 space "up the tree")
"the cat ran up the tree up the tree"
*
</pre></div>

</figure>

<p>Notice that the first argument of the function <strong>concatenate</strong> is the type of the sequence that the function should return; in this case, we want a string. Another common string operation is search for a substring:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (search "ran" s1)
8
* (search "zzzz" s1)
NIL
*
</pre></div>

</figure>

<p>If the search string (first argument to function search) is not found, function search returns nil, otherwise search returns an index into the second argument string. Function <strong>search</strong> takes several optional keyword arguments (see the next chapter for a discussion of keyword arguments):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="p">(</code><code class="nb">search</code> <code class="nv">search-string</code> <code class="nv">a-longer-string</code> <code class="ss">:from-end</code> <code class="ss">:test</code>
                                        <code class="ss">:test-not</code> <code class="ss">:key</code>
                                        <code class="ss">:start1</code> <code class="ss">:start2</code>
                                        <code class="ss">:end1</code> <code class="ss">:end2</code><code class="p">)</code>
</pre></div>

</figure>

<p>For our discussion, we will just use the keyword argument <strong>:start2</strong> for specifying the starting search index in the second argument string and the <strong>:from-end</strong> flag to specify that search should start at the end of the second argument string and proceed backwards to the beginning of the string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="ss">(</code><code class="nv">search</code> <code class="s2">"</code><code class="s"> </code><code class="s2">"</code> <code class="nv">s1</code><code class="ss">)</code>
<code class="mi">3</code>
<code class="o">*</code> <code class="ss">(</code><code class="nv">search</code> <code class="s2">"</code><code class="s"> </code><code class="s2">"</code> <code class="nv">s1</code> :<code class="nv">start2</code> <code class="mi">5</code><code class="ss">)</code>
<code class="mi">7</code>
<code class="o">*</code> <code class="ss">(</code><code class="nv">search</code> <code class="s2">"</code><code class="s"> </code><code class="s2">"</code> <code class="nv">s1</code> :<code class="nv">from</code><code class="o">-</code><code class="k">end</code> <code class="nv">t</code><code class="ss">)</code>
<code class="mi">18</code>
<code class="o">*</code>
</pre></div>

</figure>

<p>The sequence function <strong>subseq</strong> can be used for strings to extract a substring from a longer string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (subseq s1 8)
"ran up the tree"
&gt;
</pre></div>

</figure>

<p>Here, the second argument specifies the starting index; the substring from the starting index to the end of the string is returned. An optional third index argument specifies one greater than the last character index that you want to extract:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (subseq s1 8 11)
"ran"
*
</pre></div>

</figure>

<p>It is frequently useful to remove white space (or other) characters from the beginning or end of a string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (string-trim '(#\space #\z #\a) " a boy said pez")
"boy said pe"
* 
</pre></div>

</figure>

<p>The character #\space is the space character. Other common characters that are trimmed are #\tab and #\newline. There are also utility functions for making strings upper or lower case:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (string-upcase "The dog bit the cat.")
"THE DOG BIT THE CAT."
* (string-downcase "The boy said WOW!")
"the boy said wow!"
&gt;
</pre></div>

</figure>

<p>We have not yet discussed equality of variables. The function <strong>eq</strong> returns true if two variables refer to the same data in memory. The function <strong>eql</strong> returns true if the arguments refer to the same data in memory or if they are equal numbers or characters. The function <strong>equal</strong> is more lenient: it returns true if two variables print the same when evaluated. More formally, function <strong>equal</strong> returns true if the <strong>car</strong> and <strong>cdr</strong> recursively equal to each other. An example will make this clearer:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">x</code> <code class="s1">'(1 2 3))</code>
<code class="n">X</code>
<code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">y</code> <code class="s1">'(1 2 3))</code>
<code class="n">Y</code>
<code class="o">*</code> <code class="p">(</code><code class="n">eql</code> <code class="n">x</code> <code class="n">y</code><code class="p">)</code>
<code class="n">NIL</code>
<code class="o">*</code> <code class="p">(</code><code class="n">equal</code> <code class="n">x</code> <code class="n">y</code><code class="p">)</code>
<code class="n">T</code>
<code class="o">*</code> <code class="n">x</code>
<code class="p">(</code><code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code><code class="p">)</code>
<code class="o">*</code> <code class="n">y</code>
<code class="p">(</code><code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code><code class="p">)</code>
<code class="o">*</code> 
</pre></div>

</figure>

<p>For strings, the function <strong>string=</strong> is slightly more efficient than using the function <strong>equal</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (eql "cat" "cat")
NIL
* (equal "cat" "cat")
T
* (string= "cat" "cat")
T
* 
</pre></div>

</figure>

<p>Common Lisp strings are sequences of characters. The function <strong>char</strong> is used to extract individual characters from a string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* s1
"the cat ran up the tree"
* (char s1 0)
#\t
* (char s1 1)
#\h
* 
</pre></div>

</figure>

<h3 id="leanpub-auto-using-hash-tables">Using Hash Tables</h3>

<p>Hash tables are an extremely useful data type. While it is true that you can get the same effect by using lists and the <strong>assoc</strong> function, hash tables are much more efficient than lists if the lists contain many elements. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">x</code> <code class="s1">'((1 2) ("animal" "dog")))</code>
<code class="n">X</code>
<code class="o">*</code> <code class="p">(</code><code class="n">assoc</code> <code class="mi">1</code> <code class="n">x</code><code class="p">)</code>
<code class="p">(</code><code class="mi">1</code> <code class="mi">2</code><code class="p">)</code>
<code class="o">*</code> <code class="p">(</code><code class="n">assoc</code> <code class="s2">"animal"</code> <code class="n">x</code><code class="p">)</code>
<code class="n">NIL</code>
<code class="o">*</code> <code class="p">(</code><code class="n">assoc</code> <code class="s2">"animal"</code> <code class="n">x</code> <code class="p">:</code><code class="n">test</code> <code class="c1">#'equal)</code>
<code class="p">(</code><code class="s2">"animal"</code> <code class="s2">"dog"</code><code class="p">)</code>
<code class="o">*</code>
</pre></div>

</figure>

<p>The second argument to function <strong>assoc</strong> is a list of cons cells. Function <strong>assoc</strong> searches for a sub-list (in the second argument) that has its <strong>car</strong> (i.e., first element) equal to the first argument to function <strong>assoc</strong>. The perhaps surprising thing about this example is that <strong>assoc</strong> seems to work with an integer as the first argument but not with a string. The reason for this is that by default the test for equality is done with <strong>eql</strong> that tests two variables to see if they refer to the same memory location or if they are identical if they are numbers. In the last call to <strong>assoc</strong> we used “:test #’equal” to make <strong>assoc</strong> use the function <strong>equal</strong> to test for equality.</p>

<p>The problem with using lists and <strong>assoc</strong> is that they are very inefficient for large lists. We will see that it is no more difficult to code with hash tables.</p>

<p>A hash table stores associations between key and value pairs, much like our last example using the <strong>assoc</strong> function. By default, hash tables use <strong>eql</strong> to test for equality when looking for a key match.  We will duplicate the previous example using hash tables:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">h</code> <code class="p">(</code><code class="n">make</code><code class="o">-</code><code class="nb">hash</code><code class="o">-</code><code class="n">table</code><code class="p">))</code>
<code class="n">H</code>
<code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="p">(</code><code class="n">gethash</code> <code class="mi">1</code> <code class="n">h</code><code class="p">)</code> <code class="mi">2</code><code class="p">)</code>
<code class="mi">2</code>
<code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="p">(</code><code class="n">gethash</code> <code class="s2">"animal"</code> <code class="n">h</code><code class="p">)</code> <code class="s2">"dog"</code><code class="p">)</code>
<code class="s2">"dog"</code>
<code class="o">*</code> <code class="p">(</code><code class="n">gethash</code> <code class="mi">1</code> <code class="n">h</code><code class="p">)</code>
<code class="mi">2</code> <code class="p">;</code>
<code class="n">T</code>
<code class="o">*</code> <code class="p">(</code><code class="n">gethash</code> <code class="s2">"animal"</code> <code class="n">h</code><code class="p">)</code>
<code class="n">NIL</code> <code class="p">;</code>
<code class="n">NIL</code>
<code class="o">*</code>
</pre></div>

</figure>

<p>Notice that <strong>gethash</strong> returns multiple values: the first value is the value matching the key passed as the first argument to function <strong>gethash</strong> and the second returned value is true if the key was found and nil otherwise. The second returned value could be useful if hash values are nil.</p>

<p>Since we have not yet seen how to handle multiple returned values from a function, we will digress and do so here (there are many ways to handle multiple return values and we are just covering one of them):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (multiple-value-setq (a b) (gethash 1 h))
2
* a
2
* b
T
* 
</pre></div>

</figure>

<p>Assuming that variables <strong>a</strong> and <strong>b</strong> are already declared, the variable <strong>a</strong> will be set to the first returned value from <strong>gethash</strong> and the variable <strong>b</strong> will be set to the second returned value.</p>

<p>If we use symbols as hash table keys, then using <strong>eql</strong> for testing for equality with hash table keys is fine:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (setf (gethash 'bb h) 'aa)
AA
* (gethash 'bb h)
AA ;
T
* 
</pre></div>

</figure>

<p>However, we saw that <strong>eql</strong> will not match keys with character string values. The function <strong>make-hash-table</strong> has optional key arguments and one of them will allow us to use strings as hash key values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  (make-hash-table &amp;key :test :size :rehash-size :rehash-threshold)
</pre></div>

</figure>

<p>Here, we are only interested in the first optional key argument :test that allows us to use the function equal to test for equality when matching hash table keys. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">h2</code> <code class="p">(</code><code class="n">make</code><code class="o">-</code><code class="nb">hash</code><code class="o">-</code><code class="n">table</code> <code class="p">:</code><code class="n">test</code> <code class="c1">#'equal))</code>
<code class="n">H2</code>
<code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="p">(</code><code class="n">gethash</code> <code class="s2">"animal"</code> <code class="n">h2</code><code class="p">)</code> <code class="s2">"dog"</code><code class="p">)</code>
<code class="s2">"dog"</code>
<code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="p">(</code><code class="n">gethash</code> <code class="s2">"parrot"</code> <code class="n">h2</code><code class="p">)</code> <code class="s2">"Brady"</code><code class="p">)</code>
<code class="s2">"Brady"</code>
<code class="o">*</code> <code class="p">(</code><code class="n">gethash</code> <code class="s2">"parrot"</code> <code class="n">h2</code><code class="p">)</code>
<code class="s2">"Brady"</code> <code class="p">;</code>
<code class="n">T</code>
<code class="o">*</code> 
</pre></div>

</figure>

<p>It is often useful to be able to enumerate all the key and value pairs in a hash table. Here is a simple example of doing this by first defining a function <strong>my-print</strong> that takes two arguments, a key and a value. We can then use the <strong>maphash</strong> function to call our new function <strong>my-print</strong> with every key and value pair in a hash table:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (defun my-print (a-key a-value)
        (format t "key: ~A value: ~A~\%" a-key a-value))          
MY-PRINT
* (maphash #'my-print h2)
key: parrot value: Brady
key: animal value: dog
NIL
* 
</pre></div>

</figure>

<p>The function <strong>my-print</strong> is applied to each key/value pair in the hash table. There are a few other useful hash table functions that we demonstrate here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>* (hash-table-count h2)
2
* (remhash "animal" h2)
T
* (hash-table-count h2)
1
* (clrhash h2)
#S(HASH-TABLE EQUAL)
* (hash-table-count h2)
0
* 
</pre></div>

</figure>

<p>The function <strong>hash-table-count</strong> returns the number of key and value pairs in a hash table. The function <strong>remhash</strong> can be used to remove a single key and value pair from a hash table. The function <strong>clrhash</strong> clears out a hash table by removing all key and value pairs in a hash table.</p>

<p>It is interesting to note that <strong>clrhash</strong> and <strong>remhash</strong> are the first Common Lisp functions that we have seen so far that modify any of its arguments, except for <strong>setq</strong> and <strong>setf</strong> that are macros and not functions.</p>

<h3 id="leanpub-auto-using-eval-to-evaluate-lisp-forms">Using Eval to Evaluate Lisp Forms</h3>

<p>We have seen how we can type arbitrary Lisp expressions in the Lisp repl listener and then they are evaluated. We will see in the <a href="#input_output">Chapter on Input and Output</a> that the Lisp function <strong>read</strong> evaluates lists (or forms) and indeed the Lisp repl uses function read.</p>

<p>In this section, we will use the function <strong>eval</strong> to evaluate arbitrary Lisp expressions inside a program. As a simple example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">x</code> <code class="s1">'(+ 1 2 3 4 5))</code>
<code class="n">X</code>
<code class="o">*</code> <code class="n">x</code>
<code class="p">(</code><code class="o">+</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code><code class="p">)</code>
<code class="o">*</code> <code class="p">(</code><code class="n">eval</code> <code class="n">x</code><code class="p">)</code>
<code class="mi">15</code>
<code class="o">*</code> 
</pre></div>

</figure>

<p>Using the function <strong>eval</strong>, we can build lists containing Lisp code and evaluate generated code inside our own programs. We get the effect of “data is code”. A classic Lisp program, the OPS5 expert system tool, stored snippets of Lisp code in a network data structure and used the function eval to execute Lisp code stored in the network. A warning: the use of <strong>eval</strong> is likely to be inefficient in non-compiled code. For efficiency, the OPS5 program contained its own version of <strong>eval</strong> that only interpreted a subset of Lisp used in the network.</p>

<h3 id="leanpub-auto-using-a-text-editor-to-edit-lisp-source-files">Using a Text Editor to Edit Lisp Source Files</h3>

<p>I usually use Emacs, but we will briefly discuss the editor vi also. If you use vi (e.g., enter “vi nested.lisp”) the first thing that you should do is to configure vi to indicate matching opening parentheses whenever a closing parentheses is typed; you do this by typing “:set sm” after vi is running.</p>

<p>If you choose to learn Emacs, enter the following in your .emacs file (or your _emacs file in your home directory if you are running Windows): </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="p">(</code><code class="nv">set-default</code> <code class="ss">'auto-mode-alist</code>
<code class="linenos">2 </code>               <code class="p">(</code><code class="nb">append</code> <code class="o">'</code><code class="p">((</code><code class="s">"\\.lisp$"</code> <code class="o">.</code> <code class="nv">lisp-mode</code><code class="p">)</code>
<code class="linenos">3 </code>                         <code class="p">(</code><code class="s">"\\.lsp$"</code> <code class="o">.</code> <code class="nv">lisp-mode</code><code class="p">)</code>
<code class="linenos">4 </code>                         <code class="p">(</code><code class="s">"\\.cl$"</code> <code class="o">.</code> <code class="nv">lisp-mode</code><code class="p">))</code>
<code class="linenos">5 </code>                       <code class="nv">auto-mode-alist</code><code class="p">))</code>
</pre></div>

</figure>

<p>Now, whenever you open a file with the extension of “lisp”, “lsp”, or “cl” (for “Common Lisp”) then Emacs will automatically use a Lisp editing mode. I recommend searching the web using keywords “Emacs tutorial” to learn how to use the basic Emacs editing commands - we will not repeat this information here.</p>

<p>I do my professional Lisp programming using free software tools: Emacs, SBCL, Clozure Common Lisp, and Clojure. I will show you how to configure Emacs and Slime in the last section of the <a href="#quicklisp">Chapter on Quicklisp</a>.</p>

<h3 id="leanpub-auto-recovering-from-errors">Recovering from Errors</h3>

<p>When you enter forms (or expressions) in a Lisp repl listener, you will occasionally make a mistake and an error will be thrown. Here is an example where I am not showing all of the output when entering <strong>help</strong> when an error is thrown:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">defun</code><code class="w"> </code><code class="n">my</code><code class="o">-</code><code class="k">add</code><code class="o">-</code><code class="n">one</code><code class="w"> </code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="o">+</code><code class="w"> </code><code class="n">x</code><code class="w"> </code><code class="mi">1</code><code class="p">))</code><code class="w"></code>

<code class="n">MY</code><code class="o">-</code><code class="k">ADD</code><code class="o">-</code><code class="n">ONE</code><code class="w"></code>
<code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">my</code><code class="o">-</code><code class="k">add</code><code class="o">-</code><code class="n">one</code><code class="w"> </code><code class="mi">10</code><code class="p">)</code><code class="w"></code>

<code class="mi">11</code><code class="w"></code>
<code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">my</code><code class="o">-</code><code class="k">add</code><code class="o">-</code><code class="n">one</code><code class="w"> </code><code class="mf">3.14159</code><code class="p">)</code><code class="w"></code>

<code class="mf">4.14159</code><code class="w"></code>
<code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">my</code><code class="o">-</code><code class="k">add</code><code class="o">-</code><code class="n">one</code><code class="w"> </code><code class="ss">"cat"</code><code class="p">)</code><code class="w"></code>

<code class="n">debugger</code><code class="w"> </code><code class="n">invoked</code><code class="w"> </code><code class="k">on</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="n">SIMPLE</code><code class="o">-</code><code class="n">TYPE</code><code class="o">-</code><code class="nl">ERROR</code><code class="p">:</code><code class="w"> </code><code class="n">Argument</code><code class="w"> </code><code class="n">X</code><code class="w"> </code><code class="k">is</code><code class="w"> </code><code class="ow">not</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="nl">NUMBER</code><code class="p">:</code><code class="w"> </code><code class="ss">"cat"</code><code class="w"></code>

<code class="n">Type</code><code class="w"> </code><code class="n">HELP</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">debugger</code><code class="w"> </code><code class="n">help</code><code class="p">,</code><code class="w"> </code><code class="ow">or</code><code class="w"> </code><code class="p">(</code><code class="n">SB</code><code class="o">-</code><code class="nl">EXT</code><code class="p">:</code><code class="k">EXIT</code><code class="p">)</code><code class="w"> </code><code class="k">to</code><code class="w"> </code><code class="k">exit</code><code class="w"> </code><code class="k">from</code><code class="w"> </code><code class="n">SBCL</code><code class="p">.</code><code class="w"></code>

<code class="n">restarts</code><code class="w"> </code><code class="p">(</code><code class="n">invokable</code><code class="w"> </code><code class="k">by</code><code class="w"> </code><code class="n">number</code><code class="w"> </code><code class="ow">or</code><code class="w"> </code><code class="k">by</code><code class="w"> </code><code class="n">possibly</code><code class="o">-</code><code class="n">abbreviated</code><code class="w"> </code><code class="n">name</code><code class="p">)</code><code class="err">:</code><code class="w"></code>
<code class="w">  </code><code class="mi">0</code><code class="err">:</code><code class="w"> </code><code class="o">[</code><code class="n">ABORT</code><code class="o">]</code><code class="w"> </code><code class="k">Exit</code><code class="w"> </code><code class="n">debugger</code><code class="p">,</code><code class="w"> </code><code class="n">returning</code><code class="w"> </code><code class="k">to</code><code class="w"> </code><code class="k">top</code><code class="w"> </code><code class="k">level</code><code class="p">.</code><code class="w"></code>

<code class="p">(</code><code class="n">SB</code><code class="o">-</code><code class="nl">KERNEL</code><code class="p">:</code><code class="n">TWO</code><code class="o">-</code><code class="n">ARG</code><code class="o">-+</code><code class="w"> </code><code class="ss">"cat"</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="w"></code>
<code class="mi">0</code><code class="err">]</code><code class="w"> </code><code class="n">help</code><code class="w"></code>

<code class="n">The</code><code class="w"> </code><code class="n">debug</code><code class="w"> </code><code class="n">prompt</code><code class="w"> </code><code class="k">is</code><code class="w"> </code><code class="nf">square</code><code class="w"> </code><code class="n">brackets</code><code class="p">,</code><code class="w"> </code><code class="k">with</code><code class="w"> </code><code class="n">number</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="w"> </code><code class="n">indicating</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="k">current</code><code class="w"></code>
<code class="w">  </code><code class="n">control</code><code class="w"> </code><code class="n">stack</code><code class="w"> </code><code class="k">level</code><code class="w"> </code><code class="ow">and</code><code class="p">,</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">you</code><code class="s1">'ve entered the debugger recursively, how</code>
<code class="s1">  deeply recursed you are.</code>

<code class="s1"> ...</code>

<code class="s1">Getting in and out of the debugger:</code>
<code class="s1">  TOPLEVEL, TOP  exits debugger and returns to top level REPL</code>
<code class="s1">  RESTART        invokes restart numbered as shown (prompt if not given).</code>
<code class="s1">  ERROR          prints the error condition and restart cases.</code>

<code class="s1"> ...</code>

<code class="s1">Inspecting frames:</code>
<code class="s1">  BACKTRACE [n]  shows n frames going down the stack.</code>
<code class="s1">  LIST-LOCALS, L lists locals in current frame.</code>
<code class="s1">  PRINT, P       displays function call for current frame.</code>
<code class="s1">  SOURCE [n]     displays frame'</code><code class="n">s</code><code class="w"> </code><code class="n">source</code><code class="w"> </code><code class="n">form</code><code class="w"> </code><code class="k">with</code><code class="w"> </code><code class="n">n</code><code class="w"> </code><code class="n">levels</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="n">enclosing</code><code class="w"> </code><code class="n">forms</code><code class="p">.</code><code class="w"></code>

<code class="nl">Stepping</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="k">START</code><code class="w"> </code><code class="n">Selects</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="k">CONTINUE</code><code class="w"> </code><code class="n">restart</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="n">one</code><code class="w"> </code><code class="ow">exists</code><code class="w"> </code><code class="ow">and</code><code class="w"> </code><code class="n">starts</code><code class="w"></code>
<code class="w">        </code><code class="n">single</code><code class="o">-</code><code class="n">stepping</code><code class="p">.</code><code class="w"> </code><code class="n">Single</code><code class="w"> </code><code class="n">stepping</code><code class="w"> </code><code class="n">affects</code><code class="w"> </code><code class="k">only</code><code class="w"> </code><code class="n">code</code><code class="w"> </code><code class="n">compiled</code><code class="w"> </code><code class="k">with</code><code class="w"></code>
<code class="w">        </code><code class="k">under</code><code class="w"> </code><code class="n">high</code><code class="w"> </code><code class="n">DEBUG</code><code class="w"> </code><code class="n">optimization</code><code class="w"> </code><code class="n">quality</code><code class="p">.</code><code class="w"> </code><code class="n">See</code><code class="w"> </code><code class="k">User</code><code class="w"> </code><code class="n">Manual</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">details</code><code class="p">.</code><code class="w"></code>
<code class="w">  </code><code class="n">STEP</code><code class="w">  </code><code class="n">Steps</code><code class="w"> </code><code class="k">into</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="k">current</code><code class="w"> </code><code class="n">form</code><code class="p">.</code><code class="w"></code>
<code class="w">  </code><code class="k">NEXT</code><code class="w">  </code><code class="n">Steps</code><code class="w"> </code><code class="k">over</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="k">current</code><code class="w"> </code><code class="n">form</code><code class="p">.</code><code class="w"></code>
<code class="w">  </code><code class="k">OUT</code><code class="w">   </code><code class="n">Stops</code><code class="w"> </code><code class="n">stepping</code><code class="w"> </code><code class="n">temporarily</code><code class="p">,</code><code class="w"> </code><code class="n">but</code><code class="w"> </code><code class="n">resumes</code><code class="w"> </code><code class="n">it</code><code class="w"> </code><code class="k">when</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="n">topmost</code><code class="w"> </code><code class="n">frame</code><code class="w"> </code><code class="n">that</code><code class="w"></code>
<code class="w">        </code><code class="n">was</code><code class="w"> </code><code class="n">stepped</code><code class="w"> </code><code class="k">into</code><code class="w"> </code><code class="k">returns</code><code class="p">.</code><code class="w"></code>
<code class="w">  </code><code class="n">STOP</code><code class="w">  </code><code class="n">Stops</code><code class="w"> </code><code class="n">single</code><code class="o">-</code><code class="n">stepping</code><code class="p">.</code><code class="w"></code>

<code class="w"> </code><code class="p">...</code><code class="w"></code>

<code class="mi">0</code><code class="err">]</code><code class="w"> </code><code class="n">list</code><code class="o">-</code><code class="n">locals</code><code class="w"></code>
<code class="n">SB</code><code class="o">-</code><code class="nl">DEBUG</code><code class="p">:</code><code class="err">:</code><code class="n">ARG</code><code class="o">-</code><code class="mi">0</code><code class="w">  </code><code class="o">=</code><code class="w">  </code><code class="ss">"cat"</code><code class="w"></code>
<code class="n">SB</code><code class="o">-</code><code class="nl">DEBUG</code><code class="p">:</code><code class="err">:</code><code class="n">ARG</code><code class="o">-</code><code class="mi">1</code><code class="w">  </code><code class="o">=</code><code class="w">  </code><code class="mi">1</code><code class="w"></code>

<code class="mi">0</code><code class="err">]</code><code class="w"> </code><code class="n">backtrace</code><code class="w"> </code><code class="mi">2</code><code class="w"></code>

<code class="n">Backtrace</code><code class="w"> </code><code class="k">for</code><code class="err">:</code><code class="w"> </code><code class="err">#</code><code class="o">&lt;</code><code class="n">SB</code><code class="o">-</code><code class="nl">THREAD</code><code class="p">:</code><code class="n">THREAD</code><code class="w"> </code><code class="ss">"main thread"</code><code class="w"> </code><code class="n">RUNNING</code><code class="w"> </code><code class="err">{</code><code class="mi">1002</code><code class="n">AC32F3</code><code class="err">}</code><code class="o">&gt;</code><code class="w"></code>
<code class="mi">0</code><code class="err">:</code><code class="w"> </code><code class="p">(</code><code class="n">SB</code><code class="o">-</code><code class="nl">KERNEL</code><code class="p">:</code><code class="n">TWO</code><code class="o">-</code><code class="n">ARG</code><code class="o">-+</code><code class="w"> </code><code class="ss">"cat"</code><code class="w"> </code><code class="mi">1</code><code class="p">)</code><code class="w"></code>
<code class="mi">1</code><code class="err">:</code><code class="w"> </code><code class="p">(</code><code class="n">MY</code><code class="o">-</code><code class="k">ADD</code><code class="o">-</code><code class="n">ONE</code><code class="w"> </code><code class="ss">"cat"</code><code class="p">)</code><code class="w"></code>
<code class="mi">0</code><code class="err">]</code><code class="w"> </code><code class="err">:</code><code class="mi">0</code><code class="w"></code>

<code class="o">*</code><code class="w"></code>
</pre></div>

</figure>

<p>Here, I first used the backtrace command <strong>:bt</strong> to print the sequence of function calls that caused the error. If it is obvious where the error is in the code that I am working on then I do not bother using the backtrace command. I then used the abort command <strong>:a</strong> to recover back to the top level Lisp listener (i.e., back to the greater than prompt). Sometimes, you must type <strong>:a</strong> more than once to fully recover to the top level greater than prompt.</p>

<h3 id="leanpub-auto-garbage-collection">Garbage Collection</h3>

<p>Like other languages like Java and Python, Common Lisp provides garbage collection (GC) or automatic memory management.</p>

<p>In simple terms, GC occurs to free memory in a Lisp environment that is no longer accessible by any global variable (or function closure, which we will cover in the next chapter). If a global variable <strong>*variable-1*</strong> is first set to a list and then if we later then set <strong>*variable-1*</strong> to, for example nil, and if the data referenced in the original list is not referenced by any other accessible data, then this now unused data is subject to GC.</p>

<p>In practice, memory for Lisp data is allocated in time ordered batches and ephemeral or generational garbage collectors garbage collect recent memory allocations far more often than memory that has been allocated for a longer period of time.</p>

<h3 id="leanpub-auto-loading-your-working-environment-quickly">Loading your Working Environment Quickly</h3>

<p>When you start using Common Lisp for large projects, you will likely have many files to load into your Lisp environment when you start working. Most Common Lisp implementations have a function called <strong>defsystem</strong> that works somewhat like the Unix make utility. While I strongly recommend <strong>defsystem</strong> for large multi-person projects, I usually use a simpler scheme when working on my own: I place a file <strong>loadit.lisp</strong> in the top directory of each project that I work on. For any project, its <strong>loadit.lisp</strong> file loads all source files and initializes any global data for the project. </p>

<p>The last two chapters of this book provide example applications that are configured to work with Quicklisp, which we will study in the next chapter.</p>

<p>Another good technique is to create a Lisp image containing all the code and data for all your projects. There is an example of this in the first section of the <a href="#nlp_chapter">Chapter on NLP</a>. In this example, it takes a few minutes to load the code and data for my NLP (natural language processing) library so when I am working with it I like to be able to quickly load a SBCL Lisp image.</p>

<p>All Common Lisp implementations have a mechanism for dumping a working image containing code and data.</p>

<h3 id="leanpub-auto-functional-programming-concepts">Functional Programming Concepts</h3>

<p>There are two main styles for doing Common Lisp development. Object oriented programming is well supported (see the <a href="#clos_chapter">Chapter on CLOS</a>) as is functional programming. In a nut shell, functional programming means that we should write functions with no side effects. First let me give you a non-functional example with side effects:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defun</code> <code class="nv">non-functional-example</code> <code class="p">(</code><code class="nb">car</code><code class="p">)</code>
  <code class="p">(</code><code class="nv">set-color</code> <code class="nb">car</code> <code class="s">"red"</code><code class="p">))</code>
</pre></div>

</figure>

<p>This example using CLOS is non-functional because we modify the value of an argument to the function. Some functional languages like the Lisp Clojure language and the Haskell language dissuade you from modifying arguments to functions. With Common Lisp you should make a decision on which approach you like to use.</p>

<p>Functional programming means that we avoid maintaining state inside of functions and treat data as immutable (i.e., once an object is created, it is never modified). We could modify the last example to be function by creating a new car object inside the function, copy the attributes of the car passed as an object, change the color to “red” of the new car object, and return the new car instance as the value of the function.</p>

<p>Functional programming prevents many types of programming errors, makes unit testing simpler, and makes programming for modern multi-core CPUs easier because read-only objects are inherently thread safe. Modern best practices for the Java language also prefer immutable data objects and a functional approach.</p>


<h2 id="quicklisp">Quicklisp</h2>

<p>For several decades managing packages and libraries was a manual process when developing Lisp systems. I used to package the source code for specific versions of libraries as part of my Common Lisp projects. Early package management systems mk-defsystem and ASDF were very useful, but I did not totally give up my practice keeping third party library source code with my projects until Zach Beane created the <a href="http://www.quicklisp.org/">Quicklisp package system</a>. You will need to have Quicklisp installed for many of the examples later in this book so please take the time to install it now as per the instructions on the Quicklisp web site.</p>

<h3 id="leanpub-auto-using-quicklisp-to-find-packages">Using Quicklisp to Find Packages</h3>

<p>We will need the Common Lisp Hunchentoot library later in the <a href="#network_prog">Chapter on Network Programming</a> so we will install it now using Quicklisp as an example for getting started with Quicklisp.</p>

<p>We already know the package name we want, but as an example of discovering packages let’s start by using Quicklisp to search for all packages with “hunchentoot” in the package name:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>* (ql:system-apropos "hunchentoot")
<code class="linenos"> 2 </code>#&lt;SYSTEM clack-handler-hunchentoot / clack-20131111-git / quicklisp 2013-11-11&gt;
<code class="linenos"> 3 </code>#&lt;SYSTEM hunchentoot / hunchentoot-1.2.21 / quicklisp 2013-11-11&gt;
<code class="linenos"> 4 </code>#&lt;SYSTEM hunchentoot-auth / hunchentoot-auth-20101107-git / quicklisp 2013-11-11&gt;
<code class="linenos"> 5 </code>#&lt;SYSTEM hunchentoot-cgi / hunchentoot-cgi-20121125-git / quicklisp 2013-11-11&gt;
<code class="linenos"> 6 </code>#&lt;SYSTEM hunchentoot-dev / hunchentoot-1.2.21 / quicklisp 2013-11-11&gt;
<code class="linenos"> 7 </code>#&lt;SYSTEM hunchentoot-single-signon / hunchentoot-single-signon-20131111-git / quickl\
<code class="linenos"> 8 </code>isp 2013-11-11&gt;
<code class="linenos"> 9 </code>#&lt;SYSTEM hunchentoot-test / hunchentoot-1.2.21 / quicklisp 2013-11-11&gt;
<code class="linenos">10 </code>#&lt;SYSTEM hunchentoot-vhost / hunchentoot-vhost-20110418-git / quicklisp 2013-11-11&gt;
</pre></div>

</figure>

<p>We want the base package seen in line 3 and we can install the base package as seen in the following example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">hunchentoot</code><code class="p">)</code>
<code class="linenos">2 </code><code class="n">To</code> <code class="nb">load</code> <code class="s2">"hunchentoot"</code><code class="p">:</code>
<code class="linenos">3 </code>  <code class="n">Load</code> <code class="mi">1</code> <code class="n">ASDF</code> <code class="n">system</code><code class="p">:</code>
<code class="linenos">4 </code>    <code class="n">hunchentoot</code>
<code class="linenos">5 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s2">"hunchentoot"</code>
<code class="linenos">6 </code><code class="o">.......</code>
<code class="linenos">7 </code><code class="p">(:</code><code class="n">HUNCHENTOOT</code><code class="p">)</code>
</pre></div>

</figure>

<p>In line 1, I refer to the package name using a symbol :hunchentoot but using the string “hunchentoot” would have worked the same. The first time you <strong>ql:quickload</strong> a library you may see additional printout and it takes longer to load because the source code is downloaded from the web and cached locally in the directory <strong>~/quicklisp/local-projects</strong>. In most of the rest of this book, when I install or use a package by calling the <strong>ql:quickload</strong> function I do not show the output from this function in the repl listings.</p>

<p>Now, we can use the fantastically useful Common Lisp function <strong>apropos</strong> to see what was just installed:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>* (apropos "hunchentoot")
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code>HUNCHENTOOT::*CLOSE-HUNCHENTOOT-STREAM* (bound)
<code class="linenos"> 4 </code>HUNCHENTOOT:*HUNCHENTOOT-DEFAULT-EXTERNAL-FORMAT* (bound)
<code class="linenos"> 5 </code>HUNCHENTOOT::*HUNCHENTOOT-STREAM*
<code class="linenos"> 6 </code>HUNCHENTOOT:*HUNCHENTOOT-VERSION* (bound)
<code class="linenos"> 7 </code>HUNCHENTOOT:HUNCHENTOOT-CONDITION
<code class="linenos"> 8 </code>HUNCHENTOOT:HUNCHENTOOT-ERROR (fbound)
<code class="linenos"> 9 </code>HUNCHENTOOT::HUNCHENTOOT-OPERATION-NOT-IMPLEMENTED-OPERATION (fbound)
<code class="linenos">10 </code>HUNCHENTOOT::HUNCHENTOOT-SIMPLE-ERROR
<code class="linenos">11 </code>HUNCHENTOOT::HUNCHENTOOT-SIMPLE-WARNING
<code class="linenos">12 </code>HUNCHENTOOT::HUNCHENTOOT-WARN (fbound)
<code class="linenos">13 </code>HUNCHENTOOT:HUNCHENTOOT-WARNING
<code class="linenos">14 </code>HUNCHENTOOT-ASD:*HUNCHENTOOT-VERSION* (bound)
<code class="linenos">15 </code>HUNCHENTOOT-ASD::HUNCHENTOOT
<code class="linenos">16 </code>:HUNCHENTOOT (bound)
<code class="linenos">17 </code>:HUNCHENTOOT-ASD (bound)
<code class="linenos">18 </code>:HUNCHENTOOT-DEV (bound)
<code class="linenos">19 </code>:HUNCHENTOOT-NO-SSL (bound)
<code class="linenos">20 </code>:HUNCHENTOOT-TEST (bound)
<code class="linenos">21 </code>:HUNCHENTOOT-VERSION (bound)
<code class="linenos">22 </code>* 
</pre></div>

</figure>

<p>As long as you are thinking about the new tool Quicklisp that is now in your tool chest, you should install most of the packages and libraries that you will need for working through the rest of this book. I will show the statements needed to load more libraries without showing the output printed in the repl as each package is loaded:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"clsql"</code><code class="p">)</code>
<code class="linenos">2 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"clsql-postgresql"</code><code class="p">)</code>
<code class="linenos">3 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"clsql-mysql"</code><code class="p">)</code>
<code class="linenos">4 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"clsql-sqlite3"</code><code class="p">)</code>
<code class="linenos">5 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">drakma</code><code class="p">)</code>
<code class="linenos">6 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">hunchentoot</code><code class="p">)</code>
<code class="linenos">7 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">cl</code><code class="o">-</code><code class="n">json</code><code class="p">)</code>
<code class="linenos">8 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"clouchdb"</code><code class="p">)</code>  <code class="p">;;</code> <code class="k">for</code> <code class="n">CouchDB</code> <code class="n">access</code>
<code class="linenos">9 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"sqlite"</code><code class="p">)</code>
</pre></div>

</figure>

<p>You need to have the Postgres and MySQL client developer libraries installed on your system for the <strong>clsql-postgresql</strong> and <strong>clsql-mysql</strong> installations to work. If you are unlikely to use relational databases with Common Lisp then you might skip the effort of installing Postgres and MySQL. The example in the <a href="#kgn">Chapter on the Knowledge Graph Navigator</a> uses the SQLite database for caching. You don’t need any extra dependencies for the <strong>sqlite</strong> package.</p>

<h3 id="leanpub-auto-using-quicklisp-to-configure-emacs-and-slime">Using Quicklisp to Configure Emacs and Slime</h3>

<p>I assume that you have Emacs installed on your system. In a repl you can setup the Slime package that allows Emacs to connect to a running Lisp environment:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"quicklisp-slime-helper"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Pay attention to the output in the repl. On my system the output contained the following:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">[package quicklisp-slime-helper]</code>
<code class="linenos">2 </code><code class="na">slime-helper.el installed in "/Users/markw/quicklisp/slime-helper.el"</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="na">To use, add this to your ~/.emacs:</code>
<code class="linenos">5 </code>
<code class="linenos">6 </code>  <code class="na">(load (expand-file-name "~/quicklisp/slime-helper.el"))</code>
<code class="linenos">7 </code>  <code class="c1">;; Replace "sbcl" with the path to your implementation</code>
<code class="linenos">8 </code>  <code class="na">(setq inferior-lisp-program "sbcl")</code>
</pre></div>

</figure>

<p>If you installed <strong>rlwrap</strong> and defined an alias for running SBCL, make sure you set the inferior lisp program to the absolute path of the SBCL executable; on my system I set the following in my <strong>.emacs</strong> file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  (setq inferior-lisp-program "/Users/markw/sbcl/sbcl")
</pre></div>

</figure>

<p>I am not going to cover using Emacs and Slime, there are many good tutorials on the web you can read.</p>

<p>In later chapters we will write libraries and applications as Quicklisp projects so that you will be able to load your own libraries, making it easier to write small libraries that you can compose into larger applications.</p>


<h2 id="leanpub-auto-defining-lisp-functions">Defining Lisp Functions</h2>

<p>In the previous chapter, we defined a few simple functions. In this chapter, we will discuss how to write functions that take a variable number of arguments, optional arguments, and keyword arguments.</p>

<p>The special form <strong>defun</strong> is used to define new functions either in Lisp source files or at the top level Lisp listener prompt. Usually, it is most convenient to place function definitions in a source file and use the function <strong>load</strong> to load them into our Lisp working environment.</p>

<p>In general, it is bad form to use global variables inside Lisp functions. Rather, we prefer to pass all required data into a function via its argument list and to get the results of the function as the value (or values) returned from a function. Note that if we do require global variables, it is customary to name them with beginning and ending * characters; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*lexical-hash-table*</code>
<code class="linenos">2 </code>        <code class="p">(</code><code class="nb">make-hash-table</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code> <code class="ss">:size</code> <code class="mi">5000</code><code class="p">))</code>
</pre></div>

</figure>

<p>Then in this example, if you see the variable <strong>*lexical-hash-table*</strong> inside a function definition, you will know that at least by naming convention, that this is a global variable.</p>

<p>In Chapter 1, we saw an example of using lexically scoped local variables inside a function definition (in the example file <strong>nested.lisp</strong>).</p>

<p>There are several options for defining the arguments that a function can take. The fastest way to introduce the various options is with a few examples.</p>

<p>First, we can use the <strong>&amp;aux</strong> keyword to declare local variables for use in a function definition:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (defun test (x &amp;aux y)
<code class="linenos">2 </code>       (setq y (list x x))
<code class="linenos">3 </code>       y)
<code class="linenos">4 </code>TEST
<code class="linenos">5 </code>* (test 'cat)
<code class="linenos">6 </code>(CAT CAT)
<code class="linenos">7 </code>* (test 3.14159)
<code class="linenos">8 </code>(3.14159 3.14159)
</pre></div>

</figure>

<p>It is considered better coding style to use the <strong>let</strong> special operator for defining auxiliary local variables; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (defun test (x)
<code class="linenos">2 </code>       (let ((y (list x x)))
<code class="linenos">3 </code>         y))
<code class="linenos">4 </code>TEST
<code class="linenos">5 </code>* (test "the dog bit the cat")
<code class="linenos">6 </code>("the dog bit the cat" "the dog bit the cat")
<code class="linenos">7 </code>* 
</pre></div>

</figure>

<p>You will probably not use <strong>&amp;aux</strong> very often, but there are two other options for specifying function arguments: <strong>&amp;optional</strong> and <strong>&amp;key</strong>.</p>

<p>The following code example shows how to use optional function arguments. Note that optional arguments must occur after required arguments.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>* (defun test (a &amp;optional b (c 123))
<code class="linenos"> 2 </code>        (format t "a=~A b=~A c=~A~%" a b c))
<code class="linenos"> 3 </code>TEST
<code class="linenos"> 4 </code>* (test 1)
<code class="linenos"> 5 </code>a=1 b=NIL c=123
<code class="linenos"> 6 </code>NIL
<code class="linenos"> 7 </code>* (test 1 2)
<code class="linenos"> 8 </code>a=1 b=2 c=123
<code class="linenos"> 9 </code>NIL
<code class="linenos">10 </code>* (test 1 2 3)
<code class="linenos">11 </code>a=1 b=2 c=3
<code class="linenos">12 </code>NIL
<code class="linenos">13 </code>* (test 1 2 "Italian Greyhound")
<code class="linenos">14 </code>a=1 b=2 c=Italian Greyhound
<code class="linenos">15 </code>NIL
<code class="linenos">16 </code>* 
</pre></div>

</figure>

<p>In this example, the optional argument <strong>b</strong> was not given a default value so if unspecified it will default to nil. The optional argument <strong>c</strong> is given a default value of 123.</p>

<p>We have already seen the use of keyword arguments in built-in Lisp functions. Here is an example of how to specify key word arguments in your functions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>* (defun test (a &amp;key b c)
<code class="linenos"> 2 </code>        (format t "a=~A b=~A c=~A~%" a b c))
<code class="linenos"> 3 </code>TEST
<code class="linenos"> 4 </code>* (test 1)
<code class="linenos"> 5 </code>a=1 b=NIL c=NIL
<code class="linenos"> 6 </code>NIL
<code class="linenos"> 7 </code>* (test 1 :c 3.14159)
<code class="linenos"> 8 </code>a=1 b=NIL c=3.14159
<code class="linenos"> 9 </code>NIL
<code class="linenos">10 </code>* (test "cat" :b "dog")
<code class="linenos">11 </code>a=cat b=dog c=NIL
<code class="linenos">12 </code>NIL
<code class="linenos">13 </code>* 
</pre></div>

</figure>

<h3 id="leanpub-auto-using-lambda-forms">Using Lambda Forms</h3>

<p>It is often useful to define unnamed functions. We can define an unnamed function using <strong>lambda</strong>; for example, let’s look at the example file <strong>src/lambda1.lisp</strong>. But first, we will introduce the Common Lisp function <strong>funcall</strong> that takes one or more arguments; the first argument is a function and any remaining arguments are passed to the function bound to the first argument. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (funcall 'print 'cat)
<code class="linenos">2 </code>CAT 
<code class="linenos">3 </code>CAT
<code class="linenos">4 </code>* (funcall '+ 1 2)
<code class="linenos">5 </code>3
<code class="linenos">6 </code>* (funcall #'- 2 3)
<code class="linenos">7 </code>-1
<code class="linenos">8 </code>* 
</pre></div>

</figure>

<p>In the first two calls to <strong>funcall</strong> here, we simply quote the function name that we want to call. In the third example, we use a better notation by quoting with <strong>#’</strong>. We use the <strong>#’</strong> characters to quote a function name.</p>

<p>Consider the following repl listing where we will look at a primary difference between quoting a symbol using <strong>‘</strong> and with <strong>#’</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">$</code> <code class="nv">ccl</code>
<code class="linenos">2 </code><code class="nv">Clozure</code> <code class="nv">Common</code> <code class="nv">Lisp</code> <code class="nv">Version</code> <code class="mf">1.12</code>  <code class="nv">DarwinX8664</code>
<code class="linenos">3 </code><code class="nv">?</code> <code class="ss">'barfoo531</code>
<code class="linenos">4 </code><code class="nv">BARFOO531</code>
<code class="linenos">5 </code><code class="nv">?</code> <code class="p">(</code><code class="nb">apropos</code> <code class="s">"barfoo"</code><code class="p">)</code>
<code class="linenos">6 </code><code class="nv">BARFOO531</code>
<code class="linenos">7 </code><code class="nv">?</code> <code class="nf">#'</code><code class="nv">bar987</code>
<code class="linenos">8 </code><code class="nb">&gt;</code> <code class="nv">Error:</code> <code class="nv">Undefined</code> <code class="nv">function:</code> <code class="nv">BAR987</code>
</pre></div>

</figure>

<p>On line three we create a new symbol <strong>BARFOO531</strong> that is interned as you can see from looking at all interned symbols containing the string “barfoo”. Line 7 throws an error because <strong>#’</strong> does not intern a new symbol.</p>

<p>Here is the example file <strong>src/lambda1.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test</code> <code class="p">()</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">my-func</code>
<code class="linenos">3 </code>          <code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="mi">1</code><code class="p">))))</code>
<code class="linenos">4 </code>    <code class="p">(</code><code class="nb">funcall</code> <code class="nv">my-func</code> <code class="mi">1</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Here, we define a function using <strong>lambda</strong> and set the value of the local variable <strong>my-func</strong> to the unnamed function’s value.  Here is output from the function test:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (test)
<code class="linenos">2 </code>2
<code class="linenos">3 </code>
<code class="linenos">4 </code>* 
</pre></div>

</figure>

<p>The ability to use functions as data is surprisingly useful. For now, we will look at a simple example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">f1</code> <code class="c1">#'(lambda (x) (+ x 1)))</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="n">F1</code>
<code class="linenos"> 4 </code><code class="o">*</code> <code class="p">(</code><code class="n">funcall</code> <code class="n">f1</code> <code class="mi">100</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="mi">101</code>
<code class="linenos"> 7 </code><code class="o">*</code> <code class="p">(</code><code class="n">funcall</code> <code class="c1">#'print 100)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="mi">100</code> 
<code class="linenos">10 </code><code class="mi">100</code>
</pre></div>

</figure>

<p>Notice that the second call to function <strong>testfn</strong> prints “100” twice: the first time as a side effect of calling the function <strong>print</strong> and the second time as the returned value of <strong>testfn</strong> (the function <strong>print</strong> returns what it is printing as its value).</p>

<h3 id="leanpub-auto-using-recursion">Using Recursion</h3>

<p>Later, we will see how to use special Common Lisp macros for programming repetitive loops. In this section, we will use recursion for both coding simple loops and as an effective way to solve a variety of problems that can be expressed naturally using recursion.</p>

<p>As usual, the example programs for this section are found in the <strong>src</strong> directory. In the file <strong>src/recursion1.lisp</strong>, we see our first example of recursion:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">;; a simple loop using recursion</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">recursion1</code> <code class="p">(</code><code class="nv">value</code><code class="p">)</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"entering recursion1(~A)~\%"</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&lt;</code> <code class="nv">value</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">6 </code>      <code class="p">(</code><code class="nv">recursion1</code> <code class="p">(</code><code class="nb">1+</code> <code class="nv">value</code><code class="p">))))</code>
</pre></div>

</figure>

<p>This example is simple, but it is useful for discussing a few points. First, notice how the function <strong>recursion1</strong> calls itself with an argument value of one greater than its own input argument only if the input argument “value” is less than 5. This test keeps the function from getting in an infinite loop. Here is some sample output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"recursion1.lisp"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">recursion1</code><code class="o">.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos"> 3 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">recursion1</code><code class="o">.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="n">T</code>
<code class="linenos"> 5 </code><code class="o">*</code> <code class="p">(</code><code class="n">recursion1</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="linenos">10 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code>
<code class="linenos">11 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="linenos">12 </code><code class="n">NIL</code>
<code class="linenos">13 </code><code class="o">*</code> <code class="p">(</code><code class="n">recursion1</code> <code class="o">-</code><code class="mi">3</code><code class="p">)</code>
<code class="linenos">14 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="o">-</code><code class="mi">3</code><code class="p">)</code>
<code class="linenos">15 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code>
<code class="linenos">16 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">17 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="linenos">18 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos">19 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
<code class="linenos">20 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="linenos">21 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code>
<code class="linenos">22 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="linenos">23 </code><code class="n">NIL</code>
<code class="linenos">24 </code><code class="o">*</code> <code class="p">(</code><code class="n">recursion1</code> <code class="mi">20</code><code class="p">)</code>
<code class="linenos">25 </code><code class="n">entering</code> <code class="n">recursion1</code><code class="p">(</code><code class="mi">20</code><code class="p">)</code>
<code class="linenos">26 </code><code class="n">NIL</code>
<code class="linenos">27 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>Why did the call on line 24 not loop via recursion? Because the input argument is not less than 5, no recursion occurs.</p>

<h3 id="leanpub-auto-closures">Closures</h3>

<p>We have seen that functions can take other functions as arguments and return new functions as values. A function that references an outer lexically scoped variable is called a <em>closure</em>. The example file <strong>src/closure1.lisp</strong> contains a simple example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">fortunes</code>
<code class="linenos"> 2 </code>        <code class="o">'</code><code class="p">(</code><code class="s">"You will become a great Lisp Programmer"</code>
<code class="linenos"> 3 </code>          <code class="s">"The force will not be with you"</code>
<code class="linenos"> 4 </code>          <code class="s">"Take time for meditation"</code><code class="p">))</code>
<code class="linenos"> 5 </code>       <code class="p">(</code><code class="nv">len</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">fortunes</code><code class="p">))</code>
<code class="linenos"> 6 </code>       <code class="p">(</code><code class="nv">index</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">fortune</code> <code class="p">()</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">new-fortune</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">index</code> <code class="nv">fortunes</code><code class="p">)))</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">index</code> <code class="p">(</code><code class="nb">1+</code> <code class="nv">index</code><code class="p">))</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;=</code> <code class="nv">index</code> <code class="nv">len</code><code class="p">)</code> <code class="p">(</code><code class="k">setq</code> <code class="nv">index</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">11 </code>      <code class="nv">new-fortune</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Here the function <strong>fortune</strong> is defined inside a <strong>let</strong> form. Because the local variable <strong>fortunes</strong> is referenced inside the function <strong>fortune</strong>, the variable <strong>fortunes</strong> exists after the <strong>let</strong> form is evaluated. It is important to understand that usually a local variable defined inside a <strong>let</strong> form “goes out of scope” and can no longer be referenced after the <strong>let</strong> form is evaluated.</p>

<p>However, in this example, there is no way to access the contents of the variable <strong>fortunes</strong> except by calling the function <strong>fortune</strong>. At a minimum, closures are a great way to hide variables. Here is some output from loading the <strong>src/closure1.lisp</strong> file and calling the function fortune several times:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"closure1.lisp"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">closure1</code><code class="o">.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos"> 3 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">closure1</code><code class="o">.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="n">T</code>
<code class="linenos"> 5 </code><code class="o">*</code> <code class="p">(</code><code class="n">fortune</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="s2">"You will become a great Lisp Programmer"</code>
<code class="linenos"> 7 </code><code class="o">*</code> <code class="p">(</code><code class="n">fortune</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="s2">"The force will not be with you"</code>
<code class="linenos"> 9 </code><code class="o">*</code> <code class="p">(</code><code class="n">fortune</code><code class="p">)</code>
<code class="linenos">10 </code><code class="s2">"Take time for meditation"</code>
<code class="linenos">11 </code><code class="o">*</code> <code class="p">(</code><code class="n">fortune</code><code class="p">)</code>
<code class="linenos">12 </code><code class="s2">"You will become a great Lisp Programmer"</code>
<code class="linenos">13 </code><code class="o">*</code> 
</pre></div>

</figure>

<h3 id="leanpub-auto-using-the-function-eval">Using the Function eval</h3>

<p>In Lisp languages we often say that code is data. The function <strong>eval</strong> can be used to execute code that is stored as Lisp data. Let’s look at an example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">ccl</code>
<code class="linenos"> 2 </code><code class="nv">Clozure</code> <code class="nv">Common</code> <code class="nv">Lisp</code> <code class="nv">Version</code> <code class="mf">1.12</code>  <code class="nv">DarwinX8664</code>
<code class="linenos"> 3 </code><code class="nv">?</code> <code class="o">'</code><code class="p">(</code><code class="nb">+</code> <code class="mi">1</code> <code class="mf">2.2</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nb">+</code> <code class="mi">1</code> <code class="mf">2.2</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="nv">?</code> <code class="p">(</code><code class="nb">eval</code> <code class="o">'</code><code class="p">(</code><code class="nb">+</code> <code class="mi">1</code> <code class="mf">2.2</code><code class="p">))</code>
<code class="linenos"> 6 </code><code class="mf">3.2</code>
<code class="linenos"> 7 </code><code class="nv">?</code> <code class="p">(</code><code class="nb">eval</code> <code class="o">'</code><code class="p">(</code><code class="nb">defun</code> <code class="nv">foo2</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="nv">x</code><code class="p">)))</code>
<code class="linenos"> 8 </code><code class="nv">FOO2</code>
<code class="linenos"> 9 </code><code class="nv">?</code> <code class="p">(</code><code class="nv">foo2</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos">10 </code><code class="mi">8</code>
</pre></div>

</figure>

<p>I leave it up to you, dear reader, how often you are motivated to use <strong>eval</strong>. In forty years of using Lisp languages my principle use of <strong>eval</strong> has been in modifying the standard version of the <a href="https://github.com/sharplispers/ops5">Ops5 programming language for production systems</a> to support things like multiple data worlds and new actions to spawn off new data worlds and to remove them. Ops5 works by finding common expressions in a set of production rules (also referred to as “expert systems”) and factoring them into a network (a Rete network if you want to look it up) with common expressions in rules stored in just a single place. <strong>eval</strong> is used a lot in Ops5 and I used it for my extensions to Ops5.</p>


<h2 id="leanpub-auto-defining-common-lisp-macros">Defining Common Lisp Macros</h2>

<p>We saw in the last chapter how the Lisp function <strong>eval</strong> could be used to evaluate arbitrary Lisp code stored in lists. Because <strong>eval</strong> is inefficient, a better way to generate Lisp code automatically is to define macro expressions that are expanded inline when they are used. In most Common Lisp systems, using <strong>eval</strong> requires the Lisp compiler to compile a form on-the-fly which is not very efficient. Some Lisp implementations use an interpreter for eval which is likely to be faster but might lead to obscure bugs if the interpreter and compiled code do not function identically.</p>

<p>The ability to add functionality and syntax to the Common Lisp language, to in effect extend the language as needed, is truly a super power of languages like Common Lisp and Scheme.</p>

<h3 id="leanpub-auto-example-macro">Example Macro</h3>

<p>The file <strong>src/macro1.lisp</strong> contains both a simple macro and a function that uses the macro. This macro example is a bit contrived since it could be just a function definition, but it does show the process of creating and using a macro. We are using the <strong>gensym</strong> function to define a new unique symbol to reference a temporary variable:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; first simple macro example:</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defmacro</code> <code class="nv">double-list</code> <code class="p">(</code><code class="nv">a-list</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">ret</code> <code class="p">(</code><code class="nb">gensym</code><code class="p">)))</code>
<code class="linenos"> 5 </code>    <code class="o">`</code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="o">,</code><code class="nv">ret</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos"> 6 </code>       <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">x</code> <code class="o">,</code><code class="nv">a-list</code><code class="p">)</code>
<code class="linenos"> 7 </code>         <code class="p">(</code><code class="k">setq</code> <code class="o">,</code><code class="nv">ret</code> <code class="p">(</code><code class="nb">append</code> <code class="o">,</code><code class="nv">ret</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">x</code> <code class="nv">x</code><code class="p">))))</code>
<code class="linenos"> 8 </code>       <code class="o">,</code><code class="nv">ret</code><code class="p">)))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="c1">;; use the macro:</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="nv">double-list</code> <code class="nv">x</code><code class="p">))</code>
</pre></div>

</figure>

<p>The backquote character seen at the beginning of line 5 is used to quote a list in a special way: nothing in the list is evaluated during macro expansion unless it is immediately preceded by a comma character. In this case, we specify <strong>,a-list</strong> because we want the value of the macro’s argument a-list to be substituted into the specially quoted list. We will look at <strong>dolist</strong> in some detail in the next chapter but for now it is sufficient to understand that <strong>dolist</strong> is used to iterate through the top-level elements of a list, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (dolist (x '("the" "cat" "bit" "the" "rat"))
<code class="linenos">2 </code>       (print x))
<code class="linenos">3 </code>"the" 
<code class="linenos">4 </code>"cat" 
<code class="linenos">5 </code>"bit" 
<code class="linenos">6 </code>"the" 
<code class="linenos">7 </code>"rat" 
<code class="linenos">8 </code>NIL
<code class="linenos">9 </code>* 
</pre></div>

</figure>

<p>Notice that the  example macro <strong>double-list</strong> itself uses the macro <strong>dolist</strong>. It is common to nest macros in the same way functions can be nested.</p>

<p>Returning to our macro example in the file <strong>src/macro1.lisp</strong>, we will try the function <strong>test</strong> that uses the macro <strong>double-list</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"macro1.lisp"</code><code class="p">)</code>
<code class="linenos">2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">macro1</code><code class="o">.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos">3 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">macro1</code><code class="o">.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos">4 </code><code class="n">T</code>
<code class="linenos">5 </code><code class="o">*</code> <code class="p">(</code><code class="n">test</code> <code class="s1">'(1 2 3))</code>
<code class="linenos">6 </code><code class="p">(</code><code class="mi">1</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">7 </code><code class="o">*</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-using-the-splicing-operator">Using the Splicing Operator</h3>

<p>Another similar example is in the file <strong>src/macro2.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; another macro example that uses ,@:</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defmacro</code> <code class="nv">double-args</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">args</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="o">`</code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">ret</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos"> 5 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">x</code> <code class="o">,@</code><code class="nv">args</code><code class="p">)</code>
<code class="linenos"> 6 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">append</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">x</code> <code class="nv">x</code><code class="p">))))</code>
<code class="linenos"> 7 </code>    <code class="nv">ret</code><code class="p">))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="c1">;; use the macro:</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nv">double-args</code> <code class="nv">x</code><code class="p">))</code>
</pre></div>

</figure>

<p>Here, the splicing operator ,@ is used to substitute in the list args in the macro double-args.</p>

<h3 id="leanpub-auto-using-macroexpand-1">Using macroexpand-1</h3>

<p>The function <strong>macroexpand-1</strong> is used to transform macros with arguments into new Lisp expressions. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (defmacro double (a-number)                       
<code class="linenos">2 </code>        (list '+ a-number a-number))
<code class="linenos">3 </code>DOUBLE
<code class="linenos">4 </code>* (macroexpand-1 '(double n))
<code class="linenos">5 </code>(+ N N) ;
<code class="linenos">6 </code>T
<code class="linenos">7 </code>* 
</pre></div>

</figure>

<p>Writing macros is an effective way to extend the Lisp language because you can control the code passed to the Common Lisp compiler. In both macro example files, when the function <strong>test</strong> was defined, the macro expansion is done before the compiler processes the code. We will see in the next chapter several useful macros included in Common Lisp.</p>

<p>We have only “scratched the surface” looking at macros; the interested reader is encouraged to search the web using, for example, “Common Lisp macros.” There are two books in particular that I recommend that take a deep dive into Common Lisp macros: Paul Graham’s “On Lisp” and Doug Hoyte’s “Let Over Lambda.” Both are deep books and will change the way you experience software development. A good plan of study is spending a year absorbing “On Lisp” before tackling “Let Over Lambda.”</p>


<h2 id="leanpub-auto-using-common-lisp-loop-macros">Using Common Lisp Loop Macros</h2>

<p>In this chapter, we will discuss several useful macros for performing iteration (we saw how to use recursion for iteration in Chapter 2):</p>

<ul>
  <li>dolist – a simple way to process the elements of a list</li>
  <li>dotimes – a simple way to iterate with an integer valued loop variable</li>
  <li>do – the most general looping macro</li>
  <li>loop – a complex looping macro that I almost never use in my own code because it does not look “Lisp like.” I don’t use the loop macro in this book. Many programmers do like the loop macro so you are likely to see it when reading other people’s code.</li>
</ul>

<h3 id="leanpub-auto-dolist">dolist</h3>

<p>We saw a quick example of <strong>dolist</strong> in the last chapter. The arguments of the <strong>dolist</strong> macro are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>   <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">a-variable</code> <code class="nv">a-list</code> <code class="nv">[optional-result-value]</code><code class="p">)</code>   <code class="o">...</code><code class="nv">body...</code> <code class="p">)</code>
</pre></div>

</figure>

<p>Usually, the <strong>dolist</strong> macro returns nil as its value, but we can add a third optional argument which will be returned as the generated expression’s value; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (dolist (a '(1 2) 'done) (print a))
<code class="linenos">2 </code>1 
<code class="linenos">3 </code>2 
<code class="linenos">4 </code>DONE
<code class="linenos">5 </code>* (dolist (a '(1 2)) (print a))
<code class="linenos">6 </code>1 
<code class="linenos">7 </code>2 
<code class="linenos">8 </code>NIL
<code class="linenos">9 </code>* 
</pre></div>

</figure>

<p>The first argument to the <strong>dolist</strong> macro is a local lexically scoped variable. Once the code generated by the <strong>dolist</strong> macro finishes executing, this variable is undefined.</p>

<h3 id="leanpub-auto-dotimes">dotimes</h3>

<p>The <strong>dotimes</strong> macro is used when you need a loop with an integer loop index.  The arguments of the <strong>dotimes</strong> macro are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>   <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">an-index-variable</code> <code class="nv">max-index-plus-one</code> <code class="nv">[optional-result-value]</code><code class="p">)</code>
         <code class="o">...</code><code class="nv">body...</code> <code class="p">)</code>
</pre></div>

</figure>

<p>Usually, the <strong>dotimes</strong> macro returns nil as its value, but we can add a third optional argument that will be returned as the generated expression’s value; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="ss">(</code><code class="nv">dotimes</code> <code class="ss">(</code><code class="nv">i</code> <code class="mi">3</code> <code class="s2">"</code><code class="s">all-done-with-test-dotimes-loop</code><code class="s2">"</code><code class="ss">)</code> <code class="ss">(</code><code class="nv">print</code> <code class="nv">i</code><code class="ss">))</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="mi">0</code> 
<code class="linenos">4 </code><code class="mi">1</code> 
<code class="linenos">5 </code><code class="mi">2</code> 
<code class="linenos">6 </code><code class="s2">"</code><code class="s">all-done-with-test-dotimes-loop</code><code class="s2">"</code>
<code class="linenos">7 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>As with the <strong>dolist</strong> macro, you will often use a let form inside a <strong>dotimes</strong> macro to declare additional temporary (lexical) variables.</p>

<h3 id="leanpub-auto-do">do</h3>

<p>The <strong>do</strong> macro is more general purpose than either <strong>dotimes</strong> or <strong>dolist</strong> but it is more complicated to use. Here is the general form for using the <strong>do</strong> looping macro:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="p">(</code><code class="nb">do</code> <code class="p">((</code><code class="nv">variable-1</code> <code class="nv">variable-1-init-value</code> <code class="nv">variable-1-update-expression</code><code class="p">)</code>
          <code class="p">(</code><code class="nv">variable-2</code> <code class="nv">variable-2-init-value</code> <code class="nv">variable-2-update-expression</code><code class="p">)</code>
          <code class="o">.</code>
          <code class="o">.</code>
          <code class="p">(</code><code class="nv">variable-N</code> <code class="nv">variable-N-init-value</code> <code class="nv">variable-N-update-expression</code><code class="p">))</code>
        <code class="p">(</code><code class="nv">loop-termination-test</code>  <code class="nv">loop-return-value</code><code class="p">)</code>
        <code class="nv">optional-variable-declarations</code>
        <code class="nv">expressions-to-be-executed-inside-the-loop</code><code class="p">)</code>
</pre></div>

</figure>

<p>There is a similar macro <strong>do*</strong> that is analogous to <strong>let*</strong> in that loop variable values can depend on the values or previously declared loop variable values.</p>

<p>As a simple example, here is a loop to print out the integers from 0 to 3. This example is in the file <strong>src/do1.lisp</strong>:</p>

<p>;; example do macro use</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">do</code> <code class="p">((</code><code class="nv">i</code> <code class="mi">0</code> <code class="p">(</code><code class="nb">1+</code> <code class="nv">i</code><code class="p">)))</code>
        <code class="p">((</code><code class="nb">&gt;</code> <code class="nv">i</code> <code class="mi">3</code><code class="p">)</code> <code class="s">"value-of-do-loop"</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">print</code> <code class="nv">i</code><code class="p">))</code>
</pre></div>

</figure>

<p>In this example, we only declare one loop variable so we might as well as used the simpler <strong>dotimes</strong> macro.</p>

<p>Here we load the file <strong>src/do1.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"do1.lisp"</code><code class="p">)</code>
<code class="linenos">2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">do1</code><code class="o">.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos">3 </code><code class="mi">0</code> 
<code class="linenos">4 </code><code class="mi">1</code> 
<code class="linenos">5 </code><code class="mi">2</code> 
<code class="linenos">6 </code><code class="mi">3</code> 
<code class="linenos">7 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">do1</code><code class="o">.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos">8 </code><code class="n">T</code>
<code class="linenos">9 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>You will notice that we do not see the return value of the do loop (i.e., the string “value-of-do-loop”) because the top-level form that we are evaluating is a call to the function <strong>load</strong>; we do see the return value of <strong>load</strong> printed. If we had manually typed this example loop in the Lisp listener, then you would see the final value value-of-do-loop printed.</p>

<h3 id="leanpub-auto-using-the-loop-special-form-to-iterate-over-vectors-or-arrays">Using the loop Special Form to Iterate Over Vectors or Arrays</h3>

<p>We previousely used <strong>dolist</strong> to iterate over elements in lists. For efficiency we will often use vectors (one dimensional arrays) and we can use <strong>loop</strong> to similarly handle vectors:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="p">(</code><code class="nb">loop</code> <code class="nv">for</code> <code class="nv">td</code> <code class="nv">across</code> <code class="nv">testdata</code>
     <code class="nb">do</code>
       <code class="p">(</code><code class="nb">print</code> <code class="nv">td</code><code class="p">))))</code>
</pre></div>

</figure>

<p>where <strong>testdata</strong> is a one dimensional array (a vector) and inside the <strong>do</strong> block the local variable <strong>td</strong> is assigned to each element in the vector.</p>


<h2 id="package_system">Common Lisp Package System</h2>

<p>In later chapters we will see two complete applications that are defined as Quicklisp projects: the <a href="#kgcreator">chapter on the Knowledge Graph Creator</a> and the <a href="#kgn">chapter on the Knowledge Graph Navigator</a>. Another example for setting up a Quicklib project can be seen in the chapter <a href="#plotlib">Plotting Data</a>.</p>

<p>While these later chapters provide practical examples for bundling up your own projects in packages, the material here will give you general background information that you should know.</p>

<p>In the simple examples that we have seen so far, all newly created Lisp symbols have been placed in the default package. You can always check the current package by evaluating the expression <em>package</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>&gt; *package*
#&lt;PACKAGE COMMON-LISP-USER&gt;
&gt; 
</pre></div>

</figure>

<p>As we will use in the following example, the package <strong>:cl</strong> is an alias for <strong>:common-lisp-user</strong>.</p>

<p>We will define a new package :my-new-package and two functions <strong>foo1</strong> and <strong>foo2</strong> inside the package. Externally to this package, assuming that it is loaded, we can access <strong>foo2</strong> using <strong>my-new-package:foo2</strong>. <strong>foo1</strong> is not exported so it cannot be accessed this way. However, we can always start a symbol name with a package name and two colon characters if we want to use a symbol defined in another package so we can use <strong>my-new-package::foo1</strong>. Using <strong>::</strong> allows us access to symbols not explicitly exported.</p>

<p>When I leave package <strong>:my-new-package</strong> in line 22 and return to package <strong>:cl</strong>, and try to access <strong>my-new-package:foo1</strong> notice that an error is thrown.</p>

<p>On line 3 we define the alias <strong>:p1</strong> for the package <strong>:my-new-package</strong> and we use this alias in line 44. The main point of the following example is that we define two functions in a package but only export one of these functions. By default the other function is not visible outside of the new package.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">defpackage</code><code class="w"> </code><code class="ss">"MY-NEW-PACKAGE"</code><code class="w"></code>
<code class="linenos"> 2 </code><code class="w">    </code><code class="p">(</code><code class="err">:</code><code class="k">use</code><code class="w"> </code><code class="err">:</code><code class="n">cl</code><code class="p">)</code><code class="w"></code>
<code class="linenos"> 3 </code><code class="w">    </code><code class="p">(</code><code class="err">:</code><code class="n">nicknames</code><code class="w"> </code><code class="ss">"P1"</code><code class="p">)</code><code class="w"></code>
<code class="linenos"> 4 </code><code class="w">    </code><code class="p">(</code><code class="err">:</code><code class="n">export</code><code class="w"> </code><code class="err">:</code><code class="n">FOO2</code><code class="p">))</code><code class="w"></code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="err">#</code><code class="o">&lt;</code><code class="n">PACKAGE</code><code class="w"> </code><code class="ss">"MY-NEW-PACKAGE"</code><code class="o">&gt;</code><code class="w"></code>
<code class="linenos"> 7 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="ow">in</code><code class="o">-</code><code class="n">package</code><code class="w"> </code><code class="n">my</code><code class="o">-</code><code class="k">new</code><code class="o">-</code><code class="n">package</code><code class="p">)</code><code class="w"></code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="err">#</code><code class="o">&lt;</code><code class="n">PACKAGE</code><code class="w"> </code><code class="ss">"MY-NEW-PACKAGE"</code><code class="o">&gt;</code><code class="w"></code>
<code class="linenos">10 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">defun</code><code class="w"> </code><code class="n">foo1</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="ss">"foo1"</code><code class="p">)</code><code class="w"></code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="n">FOO1</code><code class="w"></code>
<code class="linenos">13 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">defun</code><code class="w"> </code><code class="n">foo2</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="ss">"foo2"</code><code class="p">)</code><code class="w"></code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="n">FOO2</code><code class="w"></code>
<code class="linenos">16 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">foo1</code><code class="p">)</code><code class="w"></code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="ss">"foo1"</code><code class="w"></code>
<code class="linenos">19 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">foo2</code><code class="p">)</code><code class="w"></code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="ss">"foo2"</code><code class="w"></code>
<code class="linenos">22 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="ow">in</code><code class="o">-</code><code class="n">package</code><code class="w"> </code><code class="err">:</code><code class="n">cl</code><code class="p">)</code><code class="w"></code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="err">#</code><code class="o">&lt;</code><code class="n">PACKAGE</code><code class="w"> </code><code class="ss">"COMMON-LISP"</code><code class="o">&gt;</code><code class="w"></code>
<code class="linenos">25 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">my</code><code class="o">-</code><code class="k">new</code><code class="o">-</code><code class="nl">package</code><code class="p">:</code><code class="n">foo2</code><code class="p">)</code><code class="w"></code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="ss">"foo2"</code><code class="w"></code>
<code class="linenos">28 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">my</code><code class="o">-</code><code class="k">new</code><code class="o">-</code><code class="nl">package</code><code class="p">:</code><code class="n">foo1</code><code class="p">)</code><code class="w"></code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="n">debugger</code><code class="w"> </code><code class="n">invoked</code><code class="w"> </code><code class="k">on</code><code class="w"> </code><code class="n">a</code><code class="w"> </code><code class="n">SB</code><code class="o">-</code><code class="nc">INT</code><code class="err">:</code><code class="n">SIMPLE</code><code class="o">-</code><code class="n">READER</code><code class="o">-</code><code class="n">PACKAGE</code><code class="o">-</code><code class="n">ERROR</code><code class="w"> </code><code class="ow">in</code><code class="w"> </code><code class="n">thread</code><code class="w"></code>
<code class="linenos">31 </code><code class="err">#</code><code class="o">&lt;</code><code class="n">THREAD</code><code class="w"> </code><code class="ss">"main thread"</code><code class="w"> </code><code class="n">RUNNING</code><code class="w"> </code><code class="err">{</code><code class="mi">1001</code><code class="n">F1ECE3</code><code class="err">}</code><code class="o">&gt;</code><code class="err">:</code><code class="w"></code>
<code class="linenos">32 </code><code class="w">  </code><code class="n">The</code><code class="w"> </code><code class="n">symbol</code><code class="w"> </code><code class="ss">"FOO1"</code><code class="w"> </code><code class="k">is</code><code class="w"> </code><code class="ow">not</code><code class="w"> </code><code class="k">external</code><code class="w"> </code><code class="ow">in</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="n">MY</code><code class="o">-</code><code class="k">NEW</code><code class="o">-</code><code class="n">PACKAGE</code><code class="w"> </code><code class="n">package</code><code class="p">.</code><code class="w"></code>
<code class="linenos">33 </code>
<code class="linenos">34 </code><code class="w">    </code><code class="nl">Stream</code><code class="p">:</code><code class="w"> </code><code class="err">#</code><code class="o">&lt;</code><code class="n">SYNONYM</code><code class="o">-</code><code class="n">STREAM</code><code class="w"> </code><code class="err">:</code><code class="n">SYMBOL</code><code class="w"> </code><code class="n">SB</code><code class="o">-</code><code class="nl">SYS</code><code class="p">:</code><code class="o">*</code><code class="n">STDIN</code><code class="o">*</code><code class="w"> </code><code class="err">{</code><code class="mi">100001</code><code class="n">C343</code><code class="err">}</code><code class="o">&gt;</code><code class="w"></code>
<code class="linenos">35 </code>
<code class="linenos">36 </code><code class="n">Type</code><code class="w"> </code><code class="n">HELP</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code class="n">debugger</code><code class="w"> </code><code class="n">help</code><code class="p">,</code><code class="w"> </code><code class="ow">or</code><code class="w"> </code><code class="p">(</code><code class="n">SB</code><code class="o">-</code><code class="nl">EXT</code><code class="p">:</code><code class="k">EXIT</code><code class="p">)</code><code class="w"> </code><code class="k">to</code><code class="w"> </code><code class="k">exit</code><code class="w"> </code><code class="k">from</code><code class="w"> </code><code class="n">SBCL</code><code class="p">.</code><code class="w"></code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="n">restarts</code><code class="w"> </code><code class="p">(</code><code class="n">invokable</code><code class="w"> </code><code class="k">by</code><code class="w"> </code><code class="n">number</code><code class="w"> </code><code class="ow">or</code><code class="w"> </code><code class="k">by</code><code class="w"> </code><code class="n">possibly</code><code class="o">-</code><code class="n">abbreviated</code><code class="w"> </code><code class="n">name</code><code class="p">)</code><code class="err">:</code><code class="w"></code>
<code class="linenos">39 </code><code class="w">  </code><code class="mi">0</code><code class="err">:</code><code class="w"> </code><code class="o">[</code><code class="n">CONTINUE</code><code class="o">]</code><code class="w"> </code><code class="k">Use</code><code class="w"> </code><code class="n">symbol</code><code class="w"> </code><code class="n">anyway</code><code class="p">.</code><code class="w"></code>
<code class="linenos">40 </code><code class="w">  </code><code class="mi">1</code><code class="err">:</code><code class="w"> </code><code class="o">[</code><code class="n">ABORT   </code><code class="o">]</code><code class="w"> </code><code class="k">Exit</code><code class="w"> </code><code class="n">debugger</code><code class="p">,</code><code class="w"> </code><code class="n">returning</code><code class="w"> </code><code class="k">to</code><code class="w"> </code><code class="k">top</code><code class="w"> </code><code class="k">level</code><code class="p">.</code><code class="w"></code>
<code class="linenos">41 </code>
<code class="linenos">42 </code><code class="o">*</code><code class="w"> </code><code class="mi">1</code><code class="w"></code>
<code class="linenos">43 </code><code class="w"> </code>
<code class="linenos">44 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="nl">p1</code><code class="p">:</code><code class="n">foo2</code><code class="p">)</code><code class="w"></code>
<code class="linenos">45 </code>
<code class="linenos">46 </code><code class="ss">"foo2"</code><code class="w"></code>
</pre></div>

</figure>

<p>Since we specified a nickname in the <strong>defpackage</strong> expression, Common Lisp allows the use of the nickname (in this case <strong>P1</strong>) in calling function <strong>foo2</strong> that is exported from package :my-new-package.</p>

<p>Near the end of the last example, we switched back to the default package COMMON-LISP-USER so we had to specify the package name for the function <strong>foo2</strong> on line 42.</p>

<p>What about the error on line 28 where <strong>my-new-package:foo1</strong> is undefined because the function <strong>foo1</strong> is not exported (see line 4)? It turns out that you can easily use symbols not exported from a package by using <strong>::</strong> instead of a single <strong>:</strong>. Here, this would be defined: <strong>(my-new-package::foo1)</strong>.</p>

<p>When you are writing very large Common Lisp programs, it is useful to be able to break up the program into different modules and place each module and all its required data in different name spaces by creating new packages. Remember that all symbols, including variables, generated symbols, CLOS methods, functions, and macros are in some package.</p>

<p>For small packages I sometimes put a <strong>defpackage</strong> expression at the top of the file immediately followed by an in-package expression to switch to the new package. In the general case, please properly use separate <strong>project</strong> and <strong>asdf</strong> files as I do in the later chapters <a href="#kgcreator">Knowledge Graph Creator</a> and <a href="#kgn">Knowledge Graph Navigator</a>.</p>


<h2 id="input_output">Input and Output</h2>

<p>We will see that the input and output of Lisp data is handled using streams. Streams are powerful abstractions that support common libraries of functions for writing to the terminal, files, sockets, and to strings.</p>

<p>In all cases, if an input or output function is called without specifying a stream, the default for input stream is <strong>*standard-input*</strong> and the default for output stream is <strong>*standard-output*</strong>. These default streams are connected to the Lisp listener that we discussed in Chapter 2. In the later chapter <a href="#kgn">Knowledge Graph Navigator</a> that supports a user interface, we will again use output streams bound to different scrolling output areas of the application window to write color-hilighted text. The stream formalism is general purpose, covering many common I/O use cases.</p>

<h3 id="leanpub-auto-the-lisp-read-and-read-line-functions">The Lisp read and read-line Functions</h3>

<p>The function <strong>read</strong> is used to read one Lisp expression. Function read stops reading after reading one expression and ignores new line characters. We will look at a simple example of reading a file <strong>test.dat</strong> using the example Lisp program in the file <strong>read-test-1.lisp</strong>. Both of these files can be found in the directory <strong>src/code_snippets_for_book</strong> that came bundled with this web book. Start your Lisp program in the src directory. The contents of the file <strong>test.dat</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="mf">1</code> <code class="mf">2</code> <code class="mf">3</code>
<code class="linenos">2 </code><code class="mf">4</code> <code class="s">"the cat bit the rat"</code>
<code class="linenos">3 </code>        <code class="kr">read</code> <code class="n">with</code><code class="o">-</code><code class="kr">open</code><code class="o">-</code><code class="n">file</code>
</pre></div>

</figure>

<p>In the function <strong>read-test-1</strong>, we use the macro with-open-file to read from a file. To write to a file (which we will do later), we can use the keyword arguments <strong>:direction :output</strong>. The first argument to the macro <strong>with-open-file</strong> is a symbol that is bound to a newly created input stream (or an output stream if we are writing a file); this symbol can then be used in calling any function that expects a stream argument.</p>

<p>Notice that we call the function <strong>read</strong> with three arguments: an input stream, a flag to indicate if an error should be thrown if there is an I/O error (e.g., reaching the end of a file), and the third argument is the value that function <strong>read</strong> should return if the end of the file (or stream) is reached. When calling <strong>read</strong> with these three arguments, either the next expression from the file <strong>test.dat</strong> will be returned, or the value nil will be returned when the end of the file is reached. If we do reach the end of the file, the local variable <strong>x</strong> will be assigned the value nil and the function return will break out of the <strong>dotimes</strong> loop. One big advantage of using the macro <strong>with-open-file</strong> over using the open function (which we will not cover) is that the file stream is automatically closed when leaving the code generated by the <strong>with-open-file macro</strong>. The contents of file <strong>read-test-1.lisp</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defun</code> <code class="nv">read-test-1</code> <code class="p">()</code>
  <code class="s">"read a maximum of 1000 expressions from the file 'test.dat'"</code>
  <code class="p">(</code><code class="nb">with-open-file</code>
   <code class="p">(</code><code class="nv">input-stream</code> <code class="s">"test.dat"</code> <code class="ss">:direction</code> <code class="ss">:input</code><code class="p">)</code>
   <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="mi">1000</code><code class="p">)</code>
     <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code> <code class="p">(</code><code class="nb">read</code> <code class="nv">input-stream</code> <code class="no">nil</code> <code class="no">nil</code><code class="p">)))</code>
       <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">return</code><code class="p">))</code> <code class="c1">;; break out of the 'dotimes' loop</code>
       <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"next expression in file: ~S~%"</code> <code class="nv">x</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>Here is the output that you will see if you load the file read-test-1.lisp and execute the expression (read-test-1):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"read-test-1.lisp"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">read</code><code class="o">-</code><code class="n">test</code><code class="o">-</code><code class="mf">1.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos"> 3 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">read</code><code class="o">-</code><code class="n">test</code><code class="o">-</code><code class="mf">1.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="n">T</code>
<code class="linenos"> 5 </code><code class="o">*</code> <code class="p">(</code><code class="n">read</code><code class="o">-</code><code class="n">test</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="mi">1</code>
<code class="linenos"> 7 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="mi">2</code>
<code class="linenos"> 8 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="mi">3</code>
<code class="linenos"> 9 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="mi">4</code>
<code class="linenos">10 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="s2">"the cat bit the rat"</code>
<code class="linenos">11 </code><code class="n">NIL</code>
</pre></div>

</figure>

<p>Note: the string “the cat bit the rat” prints as a string (with quotes) because we used a ~S  instead of a ~A  in the format string in the call to function <strong>format</strong>.</p>

<p>In this last example, we passed the file name as a string to the macro <strong>with-open-file</strong>. This is not generally portable across all operating systems. Instead, we could have created a pathname object and passed that instead. The <strong>pathname</strong> function can take eight different keyword arguments, but we will use only the two most common in the example in the file <strong>read-test-2.lisp</strong> in the <strong>src</strong> directory. The following listing shows just the differences between this example and the last:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">a-path-name</code>
          <code class="p">(</code><code class="nb">make-pathname</code> <code class="ss">:directory</code> <code class="s">"testdata"</code>
                         <code class="ss">:name</code> <code class="s">"test.dat"</code><code class="p">)))</code>
    <code class="p">(</code><code class="nb">with-open-file</code>
     <code class="p">(</code><code class="nv">input-stream</code> <code class="nv">a-path-name</code> <code class="ss">:direction</code> <code class="ss">:input</code><code class="p">)</code>
</pre></div>

</figure>

<p>Here, we are specifying that we want to use the file <strong>test.dat</strong> in the subdirectory <strong>testdata</strong>. Note: I almost never use pathnames. Instead, I specify files using a string and the character / as a directory delimiter. I find this to be portable for the Macintosh, Windows, and Linux operating systems using all Common Lisp implementations.</p>

<p>The file <strong>readline-test.lisp</strong> is identical to the file <strong>read-test-1.lisp</strong> except that we call function <strong>readline</strong> instead of the function <strong>read</strong> and we change the output format message to indicate that an entire line of text has been read</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defun</code> <code class="nv">readline-test</code> <code class="p">()</code>
  <code class="s">"read a maximum of 1000 expressions from the file 'test.dat'"</code>
  <code class="p">(</code><code class="nb">with-open-file</code>
   <code class="p">(</code><code class="nv">input-stream</code> <code class="s">"test.dat"</code> <code class="ss">:direction</code> <code class="ss">:input</code><code class="p">)</code>
   <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="mi">1000</code><code class="p">)</code>
     <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code> <code class="p">(</code><code class="nb">read-line</code> <code class="nv">input-stream</code> <code class="no">nil</code> <code class="no">nil</code><code class="p">)))</code>
       <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">return</code><code class="p">))</code> <code class="c1">;; break out of the 'dotimes' loop</code>
       <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"next line in file: ~S~%"</code> <code class="nv">x</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>When we execute the expression (readline-test), notice that the string contained in the second line of the input file has the quote characters escaped:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"readline-test.lisp"</code><code class="p">)</code>
<code class="linenos">2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">readline</code><code class="o">-</code><code class="n">test</code><code class="o">.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos">3 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">readline</code><code class="o">-</code><code class="n">test</code><code class="o">.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos">4 </code><code class="n">T</code>
<code class="linenos">5 </code><code class="o">*</code> <code class="p">(</code><code class="n">readline</code><code class="o">-</code><code class="n">test</code><code class="p">)</code>
<code class="linenos">6 </code><code class="n">next</code> <code class="n">line</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="s2">"1 2 3"</code>
<code class="linenos">7 </code><code class="n">next</code> <code class="n">line</code> <code class="ow">in</code> <code class="n">file</code><code class="p">:</code> <code class="s2">"4 </code><code class="se">\"</code><code class="s2">the cat bit the rat</code><code class="se">\"</code><code class="s2">"</code>
<code class="linenos">8 </code><code class="n">NIL</code>
<code class="linenos">9 </code><code class="o">*</code>
</pre></div>

</figure>

<p>We can also create an input stream from the contents of a string. The file <strong>read-from-string-test.lisp</strong> is very similar to the example file <strong>read-test-1.lisp</strong> except that we use the macro <strong>with-input-from-string</strong> (notice how I escaped the quote characters used inside the test string):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defun</code> <code class="nv">read-from-string-test</code> <code class="p">()</code>
  <code class="s">"read a maximum of 1000 expressions from a string"</code>
  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">str</code> <code class="s">"1 2 \"My parrot is named Brady.\" (11 22)"</code><code class="p">))</code>
    <code class="p">(</code><code class="nb">with-input-from-string</code>
     <code class="p">(</code><code class="nv">input-stream</code> <code class="nv">str</code><code class="p">)</code>
     <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="mi">1000</code><code class="p">)</code>
       <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code> <code class="p">(</code><code class="nb">read</code> <code class="nv">input-stream</code> <code class="no">nil</code> <code class="no">nil</code><code class="p">)))</code>
         <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">return</code><code class="p">))</code> <code class="c1">;; break out of the 'dotimes' loop</code>
         <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"next expression in string: ~S~%"</code> <code class="nv">x</code><code class="p">))))))</code>
</pre></div>

</figure>

<p>We see the following output when we load the file <strong>read-from-string-test.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"read-from-string-test.lisp"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">file</code> <code class="n">read</code><code class="o">-</code><code class="n">from</code><code class="o">-</code><code class="n">string</code><code class="o">-</code><code class="n">test</code><code class="o">.</code><code class="n">lisp</code> <code class="o">...</code>
<code class="linenos"> 3 </code><code class="p">;;</code> <code class="n">Loading</code> <code class="n">of</code> <code class="n">file</code> <code class="n">read</code><code class="o">-</code><code class="n">from</code><code class="o">-</code><code class="n">string</code><code class="o">-</code><code class="n">test</code><code class="o">.</code><code class="n">lisp</code> <code class="k">is</code> <code class="n">finished</code><code class="o">.</code>
<code class="linenos"> 4 </code><code class="n">T</code>
<code class="linenos"> 5 </code><code class="o">*</code> <code class="p">(</code><code class="n">read</code><code class="o">-</code><code class="n">from</code><code class="o">-</code><code class="n">string</code><code class="o">-</code><code class="n">test</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">string</code><code class="p">:</code> <code class="mi">1</code>
<code class="linenos"> 7 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">string</code><code class="p">:</code> <code class="mi">2</code>
<code class="linenos"> 8 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">string</code><code class="p">:</code> <code class="s2">"My parrot is named Brady."</code>
<code class="linenos"> 9 </code><code class="n">next</code> <code class="n">expression</code> <code class="ow">in</code> <code class="n">string</code><code class="p">:</code> <code class="p">(</code><code class="mi">11</code> <code class="mi">22</code><code class="p">)</code>
<code class="linenos">10 </code><code class="n">NIL</code>
<code class="linenos">11 </code><code class="o">*</code>
</pre></div>

</figure>

<p>We have seen how the stream abstraction is useful for allowing the same operations on a variety of stream data. In the next section, we will see that this generality also applies to the Lisp printing functions.</p>

<h3 id="leanpub-auto-lisp-printing-functions">Lisp Printing Functions</h3>

<p>All of the printing functions that we will look at in this section take an optional last argument that is an output stream. The exception is the format function that can take a stream value as its first argument (or <strong>t</strong> to indicate <strong>*standard-output*</strong>, or a <strong>nil</strong> value to indicate that format should return a string value).</p>

<p>Here is an example of specifying the optional stream argument: </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (print "testing")
<code class="linenos">2 </code>
<code class="linenos">3 </code>"testing" 
<code class="linenos">4 </code>"testing"
<code class="linenos">5 </code>* (print "testing" *standard-output*)
<code class="linenos">6 </code>
<code class="linenos">7 </code>"testing" 
<code class="linenos">8 </code>"testing"
<code class="linenos">9 </code>*
</pre></div>

</figure>

<p>The function <strong>print</strong> prints Lisp objects so that they can be read back using function read. The corresponding function <strong>princ</strong> is used to print for “human consumption”. For example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (print "testing")
<code class="linenos">2 </code>
<code class="linenos">3 </code>"testing" 
<code class="linenos">4 </code>"testing"
<code class="linenos">5 </code>* (princ "testing")
<code class="linenos">6 </code>testing
<code class="linenos">7 </code>"testing"
<code class="linenos">8 </code>* 
</pre></div>

</figure>

<p>Both <strong>print</strong> and <strong>princ</strong> return their first argument as their return value, which you see in the previous output. Notice that <strong>princ</strong> also does not print a new line character, so <strong>princ</strong> is often used with <strong>terpri</strong> (which also takes an optional stream argument).</p>

<p>We have also seen many examples in this book of using the <strong>format</strong> function. Here is a different use of format, building a string by specifying the value nil for the first argument:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (let ((l1 '(1 2))
<code class="linenos">2 </code>           (x 3.14159))
<code class="linenos">3 </code>       (format nil "~A~A" l1 x))
<code class="linenos">4 </code>"(1 2)3.14159"
<code class="linenos">5 </code>* 
</pre></div>

</figure>

<p>We have not yet seen an example of writing to a file. Here, we will use the <strong>with-open-file</strong> macro with options to write a file and to delete any existing file with the same name:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">with-open-file</code> <code class="p">(</code><code class="nv">out-stream</code> <code class="s">"test1.dat"</code>
                   <code class="ss">:direction</code> <code class="ss">:output</code>
                   <code class="ss">:if-exists</code> <code class="ss">:supersede</code><code class="p">)</code>
       <code class="p">(</code><code class="nb">print</code> <code class="s">"the cat ran down the road"</code> <code class="nv">out-stream</code><code class="p">)</code>
       <code class="p">(</code><code class="nb">format</code> <code class="nv">out-stream</code> <code class="s">"1 + 2 is: ~A~%"</code> <code class="p">(</code><code class="nb">+</code> <code class="mi">1</code> <code class="mi">2</code><code class="p">))</code>
       <code class="p">(</code><code class="nb">princ</code> <code class="s">"Stoking!!"</code> <code class="nv">out-stream</code><code class="p">)</code>
       <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out-stream</code><code class="p">))</code>
</pre></div>

</figure>

<p>Here is the result of evaluating this expression (i.e., the contents of the newly created file <strong>test1.dat</strong> in the <strong>src</strong> directory):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c">% cat test1.dat </code><code class="w"></code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="s">"the cat ran down the road"</code><code class="w"> </code><code class="mi">1</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="mi">2</code><code class="w"> </code><code class="n">is</code><code class="p">:</code><code class="w"> </code><code class="mi">3</code><code class="w"></code>
<code class="linenos">4 </code><code class="n">Stoking</code>!!<code class="w"></code>
</pre></div>

</figure>

<p>Notice that <strong>print</strong> generates a new line character before printing its argument.</p>


<h2 id="plotlib">Plotting Data</h2>

<p>We will use Zach Beane’s <a href="http://xach.com/lisp/vecto/">vecto library</a> for plotting data with the results written to files. Ideally we would like to have interactive plotting capability but for the purposes of this book I need to support the combinations of all Common Lisp implementations on multiple operating systems. Interactive plotting libraries are usually implementation and OS dependent. We will use the <strong>plotlib</strong> example we develop in the later chapter <a href="#backprop">Backpropagation Neural Networks</a>.</p>

<h3 id="leanpub-auto-implementing-the-library">Implementing the Library</h3>

<p>The examples here are all contained in the directory <strong>src/plotlib</strong> and is packaged as a Quicklisp loadable library. This library will be used in later chapters.</p>

<p>When I work on my macOS laptop, I leave the output graphics file open in the Preview App and whenever I rerun a program producing graphics in the REPL, making the preview App window active refreshes the graphics display.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 90px">
    <img src="images/test-plotlib.png" alt="PNG file generated by running plotlib test" style="width: 100%">
    <figcaption>PNG file generated by running plotlib test</figcaption>
  </figure>
</div>


<p>The following listing shows the file <em>plotlib.lisp</em> that is a simple wrapper for the <em>vecto</em> Common Lisp plotting library. Please note that I only implemented wrappers for <em>vecto</em> functionality that I need for later examples in this book, so the following code is not particularly general but should be easy enough for you to extend for the specific needs of your projects.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; Misc. plotting examples using the vecto library</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:vecto</code><code class="p">)</code> <code class="c1">;; Zach Beane's plotting library</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:plotlib</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:vecto</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:plotlib</code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="c1">;; the coordinate (0,0) is the lower left corner of the plotting area.</code>
<code class="linenos">10 </code><code class="c1">;; Increasing the y coordinate is "up page" and increasing x is "to the right"</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="c1">;; fills a rectangle with a gray-scale value</code>
<code class="linenos">13 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-fill-rect</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">y</code> <code class="nv">width</code> <code class="nv">height</code> <code class="nv">gscale</code><code class="p">)</code> <code class="c1">; 0 &lt; gscale &lt; 1</code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="nv">set-rgb-fill</code> <code class="nv">gscale</code> <code class="nv">gscale</code> <code class="nv">gscale</code><code class="p">)</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="nv">rectangle</code> <code class="nv">x</code> <code class="nv">y</code> <code class="nv">width</code> <code class="nv">height</code><code class="p">)</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="nv">fill-path</code><code class="p">))</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="c1">;; plots a frame rectangle</code>
<code class="linenos">19 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-frame-rect</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">y</code> <code class="nv">width</code> <code class="nv">height</code><code class="p">)</code>
<code class="linenos">20 </code>  <code class="p">(</code><code class="nv">set-line-width</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="nv">set-rgb-fill</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="nv">rectangle</code> <code class="nv">x</code> <code class="nv">y</code> <code class="nv">width</code> <code class="nv">height</code><code class="p">)</code>
<code class="linenos">23 </code>  <code class="p">(</code><code class="nv">stroke</code><code class="p">))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-line</code><code class="p">(</code><code class="nv">x1</code> <code class="nv">y1</code> <code class="nv">x2</code> <code class="nv">y2</code><code class="p">)</code>
<code class="linenos">26 </code>  <code class="p">(</code><code class="nv">set-line-width</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">27 </code>  <code class="p">(</code><code class="nv">set-rgb-fill</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">28 </code>  <code class="p">(</code><code class="nv">move-to</code> <code class="nv">x1</code> <code class="nv">y1</code><code class="p">)</code>
<code class="linenos">29 </code>  <code class="p">(</code><code class="nv">line-to</code> <code class="nv">x2</code> <code class="nv">y2</code><code class="p">)</code>
<code class="linenos">30 </code>  <code class="p">(</code><code class="nv">stroke</code><code class="p">))</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-string</code><code class="p">(</code><code class="nv">x</code> <code class="nv">y</code> <code class="nv">str</code><code class="p">)</code>
<code class="linenos">33 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">font</code> <code class="p">(</code><code class="nv">get-font</code> <code class="s">"OpenSans-Regular.ttf"</code><code class="p">)))</code>
<code class="linenos">34 </code>    <code class="p">(</code><code class="nv">set-font</code> <code class="nv">font</code> <code class="mi">15</code><code class="p">)</code>
<code class="linenos">35 </code>    <code class="p">(</code><code class="nv">set-rgb-fill</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">36 </code>    <code class="p">(</code><code class="nv">draw-string</code> <code class="nv">x</code> <code class="nv">y</code> <code class="nv">str</code><code class="p">)))</code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-string-bold</code><code class="p">(</code><code class="nv">x</code> <code class="nv">y</code> <code class="nv">str</code><code class="p">)</code>
<code class="linenos">39 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">font</code> <code class="p">(</code><code class="nv">get-font</code> <code class="s">"OpenSans-Bold.ttf"</code><code class="p">)))</code>
<code class="linenos">40 </code>    <code class="p">(</code><code class="nv">set-font</code> <code class="nv">font</code> <code class="mi">15</code><code class="p">)</code>
<code class="linenos">41 </code>    <code class="p">(</code><code class="nv">set-rgb-fill</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">42 </code>    <code class="p">(</code><code class="nv">draw-string</code> <code class="nv">x</code> <code class="nv">y</code> <code class="nv">str</code><code class="p">)))</code>
<code class="linenos">43 </code>
<code class="linenos">44 </code>
<code class="linenos">45 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test-plotlib</code> <code class="p">(</code><code class="nv">file</code><code class="p">)</code>
<code class="linenos">46 </code>  <code class="p">(</code><code class="nv">with-canvas</code> <code class="p">(</code><code class="ss">:width</code> <code class="mi">90</code> <code class="ss">:height</code> <code class="mi">90</code><code class="p">)</code>
<code class="linenos">47 </code>    <code class="p">(</code><code class="nv">plot-fill-rect</code> <code class="mi">5</code> <code class="mi">10</code> <code class="mi">15</code> <code class="mi">30</code> <code class="mf">0.2</code><code class="p">)</code> <code class="c1">; black</code>
<code class="linenos">48 </code>    <code class="p">(</code><code class="nv">plot-fill-rect</code> <code class="mi">25</code> <code class="mi">30</code> <code class="mi">30</code> <code class="mi">7</code> <code class="mf">0.7</code><code class="p">)</code> <code class="c1">; medium gray</code>
<code class="linenos">49 </code>    <code class="p">(</code><code class="nv">plot-frame-rect</code> <code class="mi">10</code> <code class="mi">50</code> <code class="mi">30</code> <code class="mi">7</code><code class="p">)</code>
<code class="linenos">50 </code>    <code class="p">(</code><code class="nv">plot-line</code> <code class="mi">90</code> <code class="mi">5</code> <code class="mi">10</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">51 </code>    <code class="p">(</code><code class="nv">plot-string</code> <code class="mi">10</code> <code class="mi">65</code> <code class="s">"test 1 2 3"</code><code class="p">)</code>
<code class="linenos">52 </code>    <code class="p">(</code><code class="nv">plot-string-bold</code> <code class="mi">10</code> <code class="mi">78</code> <code class="s">"Hello"</code><code class="p">)</code>
<code class="linenos">53 </code>    <code class="p">(</code><code class="nv">save-png</code> <code class="nv">file</code><code class="p">)))</code>
<code class="linenos">54 </code>
<code class="linenos">55 </code><code class="c1">;;(test-plotlib "test-plotlib.png")</code>
</pre></div>

</figure>

<p>This plot library is used in later examples in the chapters on search, backpropagation neural networks and Hopfield neural networks. I prefer using implementation and operating specific plotting libraires for generating interactive plots, but the advantage of writing plot data to a file using the <strong>vecto</strong> library is that the code is portable across operating systems and Common Lisp implementations.</p>

<h3 id="leanpub-auto-packaging-as-a-quicklisp-project">Packaging as a Quicklisp Project</h3>

<p>The two files <strong>src/plotlib/plotlib.asd</strong> <strong>src/plotlib/package.lisp</strong> configure the library. The file <strong>package.lisp</strong> defines the required library <strong>vecto</strong> and lists the functions that are publicly exported from the library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:plotlib</code>
  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:vecto</code><code class="p">)</code>
  <code class="p">(</code><code class="ss">:export</code> <code class="nv">save-png</code> <code class="nv">plot-fill-rect</code> <code class="nv">plot-frame-rect</code>
     <code class="nv">plot-size-rect</code> <code class="nv">plot-line</code> <code class="nv">plot-string</code> <code class="nv">plot-string-bold</code>
     <code class="nv">pen-width</code><code class="p">))</code>
</pre></div>

</figure>

<p>To run the test function provided with this library you load the library and preface exported function names with the package name <strong>plotlib:</strong> as in this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"plotlib"</code><code class="p">)</code>
<code class="p">(</code><code class="nv">plotlib::test-plotlib</code> <code class="s">"test-plotlib.png"</code><code class="p">)</code>
</pre></div>

</figure>

<p>In addition to a <strong>package.lisp</strong> file we also use a file with the extension <strong>.asd</strong></p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:plotlib</code>
  <code class="ss">:description</code> <code class="s">"Describe plotlib here"</code>
  <code class="ss">:author</code> <code class="s">"mark.watson@gmail.com"</code>
  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:vecto</code><code class="p">)</code>
  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
               <code class="p">(</code><code class="ss">:file</code> <code class="s">"plotlib"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>If you have specified a dependency that is not already downloaded to your computer, Quicklisp will install the dependency for you.</p>


<h2 id="clos_chapter">Common Lisp Object System - CLOS</h2>

<p>CLOS was the first ANSI standardized object oriented programming facility. While I do not use classes and objects as often in my Common Lisp programs as I do when using Java and Smalltalk, it is difficult to imagine a Common Lisp program of any size that did not define and use at least a few CLOS classes. </p>

<p>The example program for this chapter in the file <strong>src/loving_snippets/HTMLstream.lisp</strong>. I used this CLOS class about ten years ago in a demo for my commercial natural language processing product to automatically generate demo web pages.</p>

<p>We are going to start our discussion of CLOS somewhat backwards by first looking at a short test function that uses the <strong>HTMLstream</strong> class. Once we see how to use this example CLOS class, we will introduce a small subset of CLOS by discussing in some detail the implementation of the <strong>HTMLstream</strong> class and finally, at the end of the chapter, see a few more CLOS programming techniques. This book only provides a brief introduction to CLOS; the interested reader is encouraged to do a web search for “CLOS tutorial”.</p>

<p>The macros and functions defined to implement CLOS are a standard part of Common Lisp. Common Lisp supports generic functions, that is, different functions with the same name that are distinguished by different argument types.</p>

<h3 id="leanpub-auto-example-of-using-a-clos-class">Example of Using a CLOS Class</h3>

<p>The file <strong>src/loving_snippets/HTMLstream.lisp</strong> contains a short test program at the end of the file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test</code> <code class="p">(</code><code class="k">&amp;aux</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">2 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'HTMLstream</code><code class="p">))</code>
<code class="linenos">3 </code>    <code class="p">(</code><code class="nv">set-header</code> <code class="nv">x</code> <code class="s">"test page"</code><code class="p">)</code>
<code class="linenos">4 </code>    <code class="p">(</code><code class="nv">add-element</code> <code class="nv">x</code> <code class="s">"test text - this could be any element"</code><code class="p">)</code>
<code class="linenos">5 </code>    <code class="p">(</code><code class="nv">add-table</code>
<code class="linenos">6 </code>         <code class="nv">x</code>
<code class="linenos">7 </code>         <code class="o">'</code><code class="p">((</code><code class="s">"&lt;b&gt;Key phrase&lt;/b&gt;"</code> <code class="s">"&lt;b&gt;Ranking value&lt;/b&gt;"</code><code class="p">)</code>
<code class="linenos">8 </code>           <code class="p">(</code><code class="s">"this is a test"</code> <code class="mf">3.3</code><code class="p">)))</code>
<code class="linenos">9 </code>    <code class="p">(</code><code class="nv">get-html-string</code> <code class="nv">x</code><code class="p">))</code>
</pre></div>

</figure>

<p>The generic function <strong>make-instance</strong> takes the following arguments:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    make-instance class-name &amp;rest initial-arguments &amp;key ...
</pre></div>

</figure>

<p>There are four generic functions used in the function test:</p>

<ul>
  <li>set-header - required to initialize class and also defines the page title</li>
  <li>add-element - used to insert a string that defines any type of HTML element</li>
  <li>add-table - takes a list of lists and uses the list data to construct an HTML table</li>
  <li>get-html-string - closes the stream and returns all generated HTML data as a string</li>
</ul>

<p>The first thing to notice in the function test is that the first argument for calling each of these generic functions is an instance of the class <strong>HTMLstream</strong>. You are free to also define a function, for example, add-element that does not take an instance of the class <strong>HTMLstream</strong> as the first function argument and calls to <strong>add-element</strong> will be routed correctly to the correct function definition.</p>

<p>We will see that the macro <strong>defmethod</strong> acts similarly to <strong>defun</strong> except that it also allows us to define many methods (i.e., functions for a class) with the same function name that are differentiated by different argument types and possibly different numbers of arguments.</p>

<h3 id="leanpub-auto-implementation-of-the-htmlstream-class">Implementation of the HTMLstream Class</h3>

<p>The class <strong>HTMLstream</strong> is very simple and will serve as a reasonable introduction to CLOS programming. Later we will see more complicated class examples that use multiple inheritance. Still, this is a good example because the code is simple and the author uses this class frequently (some proof that it is useful!). The code fragments listed in this section are all contained in the file <strong>src/loving_snippets/HTMLstream.lisp</strong>. We start defining a new class using the macro <strong>defclass</strong> that takes the following arguments:   </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nb">defclass</code> <code class="nb">class-name</code> <code class="nv">list-of-super-classes</code>
<code class="linenos">2 </code>             <code class="nv">list-of-slot-specifications</code> <code class="nv">class-specifications</code>
</pre></div>

</figure>

<p>The class definition for <strong>HTMLstream</strong> is fairly simple:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defclass</code> <code class="nv">HTMLstream</code> <code class="p">()</code>
<code class="linenos">2 </code>  <code class="p">((</code><code class="nv">out</code> <code class="ss">:accessor</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">3 </code>  <code class="p">(</code><code class="ss">:documentation</code> <code class="s">"Provide HTML generation services"</code><code class="p">))</code>
</pre></div>

</figure>

<p>Here, the class name is <strong>HTMLstream</strong>, the list of super classes is an empty list (), the list of slot specifications contains only one slot specification for the slot named <strong>out</strong> and there is only one class specification: a documentation string. Slots are like instance variables in languages like Java and Smalltalk. Most CLOS classes inherit from at least one super class but we will wait until the next section to see examples of inheritance. There is only one slot (or instance variable) and we define an accessor variable with the same name as the slot name. This is a personal preference of mine to name read/write accessor variables with the same name as the slot.</p>

<p>The method <strong>set-header</strong> initializes the string output stream used internally by an instance of this class. This method uses convenience macro <strong>with-accessors</strong> that binds a local set of local variable to one or more class slot accessors. We will list the entire method then discuss it: </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defmethod</code> <code class="nv">set-header</code> <code class="p">((</code><code class="nv">ho</code> <code class="nv">HTMLstream</code><code class="p">)</code> <code class="nv">title</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="nb">with-accessors</code>
<code class="linenos">3 </code>      <code class="p">((</code><code class="nv">out</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">4 </code>      <code class="nv">ho</code>
<code class="linenos">5 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="nv">out</code> <code class="p">(</code><code class="nb">make-string-output-stream</code><code class="p">))</code>
<code class="linenos">6 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;HTML&gt;&lt;head&gt;&lt;title&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">7 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="nv">title</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">8 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;/title&gt;&lt;/head&gt;&lt;BODY&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">9 </code>    <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The first interesting thing to notice about the <strong>defmethod</strong> is the argument list: there are two arguments <strong>ho</strong> and <strong>title</strong> but we are constraining the argument ho to be either a member of the class <strong>HTMLstream</strong> or a subclass of <strong>HTMLstream</strong>. Now, it makes sense that since we are passing an instance of the class <strong>HTMLstream</strong> to this generic function (or method – I use the terms “generic function” and “method” interchangeably) that we would want access to the slot defined for this class. The convenience macro <strong>with-accessors</strong> is exactly what we need to get read and write access to the slot inside a generic function (or method) for this class. In the term <strong>((out out))</strong>, the first out is local variable bound to the value of the slot named out for this instance <strong>ho</strong> of class <strong>HTMLstream</strong>. Inside the <strong>with-accessors</strong> macro, we can now use <strong>setf</strong> to set the slot value to a new string output stream. Note: we have not covered the Common Lisp type <strong>string-output-stream</strong> yet in this book, but we will explain its use on the next page.</p>

<p>By the time a call to the method <strong>set-header</strong> (with arguments of an <strong>HTMLstream</strong> instance and a string title) finishes, the instance has its slot set to a new <strong>string-output-stream</strong> and HTML header information is written to the newly created string output stream. Note: this string output stream is now available for use by any class methods called after <strong>set-header</strong>.</p>

<p>There are several methods defined in the file <strong>src/loving_snippets/HTMLstream.lisp</strong>, but we will look at just four of them: <strong>add-H1</strong>, <strong>add-element</strong>, <strong>add-table</strong>, and <strong>get-html-string</strong>. The remaining methods are very similar to <strong>add-H1</strong> and the reader can read the code in the source file.</p>

<p>As in the method set-header, the method <strong>add-H1</strong> uses the macro with-accessors to access the stream output stream slot as a local variable out. In <strong>add-H1</strong> we use the function <strong>princ</strong> that we discussed in Chapter on Input and Output to write HTML text to the string output stream:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defmethod</code> <code class="nv">add-H1</code> <code class="p">((</code><code class="nv">ho</code> <code class="nv">HTMLstream</code><code class="p">)</code> <code class="nv">some-text</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="nb">with-accessors</code>
<code class="linenos">3 </code>   <code class="p">((</code><code class="nv">out</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">4 </code>   <code class="nv">ho</code>
<code class="linenos">5 </code>   <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;H1&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">6 </code>   <code class="p">(</code><code class="nb">princ</code> <code class="nv">some-text</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">7 </code>   <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;/H1&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">8 </code>   <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The method <strong>add-element</strong> is very similar to <strong>add-H1</strong> except the string passed as the second argument element is written directly to the stream output stream slot:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defmethod</code> <code class="nv">add-element</code> <code class="p">((</code><code class="nv">ho</code> <code class="nv">HTMLstream</code><code class="p">)</code> <code class="nv">element</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="nb">with-accessors</code>
<code class="linenos">3 </code>      <code class="p">((</code><code class="nv">out</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">4 </code>      <code class="nv">ho</code>
<code class="linenos">5 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="nv">element</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">6 </code>    <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The method <strong>add-table</strong> converts a list of lists into an HTML table. The Common Lisp function <strong>princ-to-string</strong> is a useful utility function for writing the value of any variable to a string. The functions <strong>string-left-trim</strong> and <strong>string-right-trim</strong> are string utility functions that take two arguments: a list of characters and a string and respectively remove these characters from either the left or right side of a string. Note: another similar function that takes the same arguments is <strong>string-trim</strong> that removes characters from both the front (left) and end (right) of a string. All three of these functions do not modify the second string argument; they return a new string value. Here is the definition of the <strong>add-table</strong> method:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defmethod</code> <code class="nv">add-table</code> <code class="p">((</code><code class="nv">ho</code> <code class="nv">HTMLstream</code><code class="p">)</code> <code class="nv">table-data</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="nb">with-accessors</code>
<code class="linenos"> 3 </code>      <code class="p">((</code><code class="nv">out</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos"> 4 </code>      <code class="nv">ho</code>
<code class="linenos"> 5 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;TABLE BORDER=\"1\" WIDTH=\"100\%\"&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos"> 6 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">d</code> <code class="nv">table-data</code><code class="p">)</code>
<code class="linenos"> 7 </code>      <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos"> 8 </code>      <code class="p">(</code><code class="nb">princ</code> <code class="s">"  &lt;TR&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">w</code> <code class="nv">d</code><code class="p">)</code>
<code class="linenos">11 </code>        <code class="p">(</code><code class="nb">princ</code> <code class="s">"    &lt;TD&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">12 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">str</code> <code class="p">(</code><code class="nb">princ-to-string</code> <code class="nv">w</code><code class="p">)))</code>
<code class="linenos">13 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">string-left-trim</code> <code class="o">'</code><code class="p">(</code><code class="sc">#\(</code><code class="p">)</code> <code class="nv">str</code><code class="p">))</code>
<code class="linenos">14 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">string-right-trim</code> <code class="o">'</code><code class="p">(</code><code class="sc">#\)</code><code class="p">)</code> <code class="nv">str</code><code class="p">))</code>
<code class="linenos">15 </code>          <code class="p">(</code><code class="nb">princ</code> <code class="nv">str</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;/TD&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">18 </code>      <code class="p">(</code><code class="nb">princ</code> <code class="s">"  &lt;/TR&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">20 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;/TABLE&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The method <strong>get-html-string</strong> gets the string stored in the string output stream slot by using the function <strong>get-output-stream-string</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defmethod</code> <code class="nv">get-html-string</code> <code class="p">((</code><code class="nv">ho</code> <code class="nv">HTMLstream</code><code class="p">))</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="nb">with-accessors</code>
<code class="linenos">3 </code>      <code class="p">((</code><code class="nv">out</code> <code class="nv">out</code><code class="p">))</code>
<code class="linenos">4 </code>      <code class="nv">ho</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="nb">princ</code> <code class="s">"&lt;/BODY&gt;&lt;/HTML&gt;"</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">6 </code>  <code class="p">(</code><code class="nb">terpri</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">7 </code>  <code class="p">(</code><code class="nb">get-output-stream-string</code> <code class="nv">out</code><code class="p">)))</code>
</pre></div>

</figure>

<p>CLOS is a rich framework for object oriented programming, providing a superset of features found in languages like Java, Ruby, and Smalltalk. I have barely scratched the surface in this short CLOS example for generating HTML. Later in the book, whenever you see calls to <strong>make-instance</strong>, that lets you know we are using CLOS even if I don’t specifically mention CLOS in the examples.</p>

<h3 id="leanpub-auto-using-defstruct-or-clos">Using Defstruct or CLOS</h3>

<p>You might notice from my own code that I use Common Lisp <strong>defstruct</strong> macros to define data structures more often than I use CLOS. The <strong>defclass</strong> macro used to create CLOS classes are much more flexible but for simple data structures I find that using <strong>defstruct</strong> is much more concise. In the simplest case, a <strong>defstruct</strong> can just be a name of the new type followed by slot names. For each slot like <strong>my-slot-1</strong> accessor functions are generated automatically. Here is a simple example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">$</code> <code class="nv">ccl</code>
<code class="linenos">2 </code><code class="nv">Clozure</code> <code class="nv">Common</code> <code class="nv">Lisp</code> <code class="nv">Version</code> <code class="mf">1.12</code>  <code class="nv">DarwinX8664</code>
<code class="linenos">3 </code><code class="nv">?</code> <code class="p">(</code><code class="nb">defstruct</code> <code class="nv">struct1</code> <code class="nv">s1</code> <code class="nv">s2</code><code class="p">)</code>
<code class="linenos">4 </code><code class="nv">STRUCT1</code>
<code class="linenos">5 </code><code class="nv">?</code> <code class="p">(</code><code class="nv">make-struct1</code> <code class="ss">:s1</code> <code class="mi">1</code> <code class="ss">:s2</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">6 </code><code class="l l-Other">#S</code><code class="p">(</code><code class="nv">STRUCT1</code> <code class="ss">:S1</code> <code class="mi">1</code> <code class="ss">:S2</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">7 </code><code class="nv">?</code> <code class="p">(</code><code class="nv">struct1-s1</code> <code class="p">(</code><code class="nv">make-struct1</code> <code class="ss">:s1</code> <code class="mi">1</code> <code class="ss">:s2</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">8 </code><code class="mi">1</code>
</pre></div>

</figure>

<p>We defined a struct <strong>struct1</strong> on line3 with two slots names <strong>s1</strong> and <strong>s2</strong>, show the use of the automatically generated constructor <strong>make-struct1</strong> on line 5, and one of the two automatically generated accessor functions <strong>struct1-s1</strong> on line 7. The names of accessor functions are formed with the structure name and the slot name.</p>


<h2 id="leanpub-auto-heuristically-guided-search">Heuristically Guided Search</h2>

<p>We represent search space as a graph: nodes and links between the nodes. The following figure shows the simple graph that we use as an example, finding a route from node <strong>n1</strong> to node <strong>n11</strong>:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 289px">
    <img src="images/search-route.png" alt="Plot of best route using the plotlib utilities" style="width: 100%">
    <figcaption>Plot of best route using the plotlib utilities</figcaption>
  </figure>
</div>


<p>The following example code uses a heuristic for determining which node to try first from any specific location: move to the node that is closest spatially to the goal node. We see that this heuristic will not always work to produce the most efficient search but we will still get to the goal node. As an example in which the heuristic does not work, consider when we start at node <strong>n1</strong> in the lower left corner of the figure. The search algorithm can add nodes <strong>n2</strong> and <strong>n4</strong> to the nodes to search list and will search using node <strong>n4</strong> first since <strong>n4</strong> is closer to the goal node <strong>n11</strong> than node <strong>n2</strong>. In this case, the search will eventually need to back up trying the path <strong>n1</strong> to <strong>n2</strong>. Despite this example of the heuristic not working to decrease search time, in general, for large search spaces (i.e., graphs with many nodes and edges) it can dramatically decrease search time.</p>

<p>The main function <strong>A*search</strong> starting in line 5 extends to line 151 because all search utility functions are nested (lexically scoped) inside the mani function. The actual code for the main function <strong>A*search</strong> is in lines 150 and 151.</p>

<p>The data representing nodes in this implementation is globally scoped (see the definitions on lines 155-165 in the “throw away test code” near the bottom of the file) and we set the property <strong>path-list</strong> to store the nodes directy connected to each node (set in function <strong>init-path-list</strong> in lines 36-52). I originally wrote this code in 1990 which explains it non-functional style using globally scoped node variables.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">;; Perform a heuristic A* search between the start and goal nodes:</code>
<code class="linenos">  2 </code><code class="c1">;;</code>
<code class="linenos">  3 </code><code class="c1">;; Copyright 1990, 2017 by Mark Watson</code>
<code class="linenos">  4 </code>
<code class="linenos">  5 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">A*search</code> <code class="p">(</code><code class="nv">nodes</code> <code class="nv">paths</code> <code class="nv">start</code> <code class="nv">goal</code> <code class="k">&amp;aux</code> <code class="nv">possible-paths</code> <code class="nv">best</code><code class="p">)</code>
<code class="linenos">  6 </code>
<code class="linenos">  7 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">Y-coord</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">truncate</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">x</code><code class="p">)))</code>
<code class="linenos">  8 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">X-coord</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">truncate</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">x</code><code class="p">)))</code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">dist-between-points</code> <code class="p">(</code><code class="nv">point1</code> <code class="nv">point2</code><code class="p">)</code>
<code class="linenos"> 11 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x-dif</code> <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nv">X-coord</code> <code class="nv">point2</code><code class="p">)</code> <code class="p">(</code><code class="nv">X-coord</code> <code class="nv">point1</code><code class="p">)))</code>
<code class="linenos"> 12 </code>          <code class="p">(</code><code class="nv">y-dif</code> <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nv">Y-coord</code> <code class="nv">point2</code><code class="p">)</code> <code class="p">(</code><code class="nv">Y-coord</code> <code class="nv">point1</code><code class="p">))))</code>
<code class="linenos"> 13 </code>      <code class="p">(</code><code class="nb">sqrt</code> <code class="p">(</code><code class="nb">+</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">x-dif</code> <code class="nv">x-dif</code><code class="p">)</code>  <code class="p">(</code><code class="nb">*</code> <code class="nv">y-dif</code> <code class="nv">y-dif</code><code class="p">)))))</code>
<code class="linenos"> 14 </code>
<code class="linenos"> 15 </code>  <code class="p">(</code><code class="k">setq</code> <code class="nv">possible-paths</code>
<code class="linenos"> 16 </code>        <code class="p">(</code><code class="nb">list</code>
<code class="linenos"> 17 </code>         <code class="p">(</code><code class="nb">list</code>
<code class="linenos"> 18 </code>          <code class="p">(</code><code class="nv">dist-between-points</code>
<code class="linenos"> 19 </code>           <code class="p">(</code><code class="nb">eval</code> <code class="nv">start</code><code class="p">)</code>
<code class="linenos"> 20 </code>           <code class="p">(</code><code class="nb">eval</code> <code class="nv">goal</code><code class="p">))</code>
<code class="linenos"> 21 </code>          <code class="mi">0</code>
<code class="linenos"> 22 </code>          <code class="p">(</code><code class="nb">list</code> <code class="nv">start</code><code class="p">))))</code>
<code class="linenos"> 23 </code>
<code class="linenos"> 24 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">init-network</code> <code class="p">()</code>
<code class="linenos"> 25 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">paths</code> <code class="p">(</code><code class="nv">init-lengths</code> <code class="nv">paths</code><code class="p">))</code>
<code class="linenos"> 26 </code>    <code class="p">(</code><code class="nv">init-path-list</code> <code class="nv">nodes</code> <code class="nv">paths</code><code class="p">))</code>
<code class="linenos"> 27 </code>
<code class="linenos"> 28 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">init-lengths</code> <code class="p">(</code><code class="nv">pathlist</code><code class="p">)</code>
<code class="linenos"> 29 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">new-path-list</code> <code class="nv">pathlength</code> <code class="nv">path-with-length</code><code class="p">)</code>
<code class="linenos"> 30 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">path</code> <code class="nv">pathlist</code><code class="p">)</code>
<code class="linenos"> 31 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">pathlength</code> <code class="p">(</code><code class="nv">slow-path-length</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos"> 32 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">path-with-length</code> <code class="p">(</code><code class="nb">append</code> <code class="nv">path</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">pathlength</code><code class="p">)))</code>
<code class="linenos"> 33 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">new-path-list</code> <code class="p">(</code><code class="nb">cons</code> <code class="nv">path-with-length</code> <code class="nv">new-path-list</code><code class="p">)))</code>
<code class="linenos"> 34 </code>      <code class="nv">new-path-list</code><code class="p">))</code>
<code class="linenos"> 35 </code>
<code class="linenos"> 36 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">init-path-list</code> <code class="p">(</code><code class="nv">nodes</code> <code class="nv">paths</code><code class="p">)</code>
<code class="linenos"> 37 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">node</code> <code class="nv">nodes</code><code class="p">)</code>
<code class="linenos"> 38 </code>      <code class="p">(</code><code class="nb">setf</code>
<code class="linenos"> 39 </code>       <code class="p">(</code><code class="nb">get</code> <code class="nv">node</code> <code class="ss">'path-list</code><code class="p">)</code>
<code class="linenos"> 40 </code>       <code class="c1">;; let returns all paths connected to node:</code>
<code class="linenos"> 41 </code>       <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">path-list</code><code class="p">)</code>
<code class="linenos"> 42 </code>         <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">path</code> <code class="nv">paths</code><code class="p">)</code>
<code class="linenos"> 43 </code>           <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">node</code> <code class="p">(</code><code class="nv">start-node-name</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos"> 44 </code>               <code class="p">(</code><code class="k">setq</code> <code class="nv">path-list</code>
<code class="linenos"> 45 </code>                     <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nv">end-node-name</code> <code class="nv">path</code><code class="p">)</code>
<code class="linenos"> 46 </code>                                 <code class="p">(</code><code class="nv">path-length</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos"> 47 </code>                           <code class="nv">path-list</code><code class="p">))</code>
<code class="linenos"> 48 </code>               <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">node</code> <code class="p">(</code><code class="nv">end-node-name</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos"> 49 </code>                   <code class="p">(</code><code class="k">setq</code> <code class="nv">path-list</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nv">start-node-name</code> <code class="nv">path</code><code class="p">)</code>
<code class="linenos"> 50 </code>                                               <code class="p">(</code><code class="nv">path-length</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos"> 51 </code>                                         <code class="nv">path-list</code><code class="p">)))))</code>
<code class="linenos"> 52 </code>         <code class="nv">path-list</code> <code class="p">))))</code>
<code class="linenos"> 53 </code>
<code class="linenos"> 54 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">slow-path-length</code> <code class="p">(</code><code class="nv">path</code><code class="p">)</code>
<code class="linenos"> 55 </code>    <code class="p">(</code><code class="nv">dist-between-points</code> <code class="p">(</code><code class="nv">start-node</code> <code class="nv">path</code><code class="p">)</code> <code class="p">(</code><code class="nv">end-node</code> <code class="nv">path</code><code class="p">)))</code>
<code class="linenos"> 56 </code>
<code class="linenos"> 57 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">path-length</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 58 </code>
<code class="linenos"> 59 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">start-node</code> <code class="p">(</code><code class="nv">path</code><code class="p">)</code> <code class="p">(</code><code class="nb">eval</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">path</code><code class="p">)))</code>
<code class="linenos"> 60 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">end-node</code> <code class="p">(</code><code class="nv">path</code><code class="p">)</code> <code class="p">(</code><code class="nb">eval</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">path</code><code class="p">)))</code>
<code class="linenos"> 61 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">start-node-name</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 62 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">end-node-name</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 63 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">first-on-path</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 64 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">goal-node</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 65 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">distance-to-that-node</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 66 </code>
<code class="linenos"> 67 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">enumerate-children</code> <code class="p">(</code><code class="nv">node</code> <code class="nv">goal</code><code class="p">)</code>
<code class="linenos"> 68 </code>    <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">start-to-lead-node-dist</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">node</code><code class="p">))</code> <code class="c1">;; distance already calculated</code>
<code class="linenos"> 69 </code>           <code class="p">(</code><code class="nv">path</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">node</code><code class="p">))</code>
<code class="linenos"> 70 </code>           <code class="p">(</code><code class="nv">lead-node</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">path</code><code class="p">)))</code>
<code class="linenos"> 71 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nv">get-stored-path</code> <code class="nv">lead-node</code> <code class="nv">goal</code><code class="p">)</code>
<code class="linenos"> 72 </code>          <code class="p">(</code><code class="nv">consider-best-path</code> <code class="nv">lead-node</code> <code class="nv">goal</code> <code class="nv">path</code> <code class="nv">start-to-lead-node-dist</code><code class="p">)</code>
<code class="linenos"> 73 </code>          <code class="p">(</code><code class="nv">consider-all-nodes</code> <code class="nv">lead-node</code> <code class="nv">goal</code> <code class="nv">path</code> <code class="nv">start-to-lead-node-dist</code><code class="p">))))</code>
<code class="linenos"> 74 </code>
<code class="linenos"> 75 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">consider-best-path</code> <code class="p">(</code><code class="nv">lead-node</code> <code class="nv">goal</code> <code class="nv">path</code> <code class="nv">distance-to-here</code><code class="p">)</code>
<code class="linenos"> 76 </code>    <code class="p">(</code><code class="k">let*</code> <code class="p">(</code>
<code class="linenos"> 77 </code>           <code class="p">(</code><code class="nv">first-node</code> <code class="p">(</code><code class="nv">get-first-node-in-path</code> <code class="nv">lead-node</code> <code class="nv">goal</code><code class="p">))</code>
<code class="linenos"> 78 </code>           <code class="p">(</code><code class="nv">dist-to-first</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">distance-to-here</code>
<code class="linenos"> 79 </code>                             <code class="p">(</code><code class="nv">get-stored-dist</code> <code class="nv">lead-node</code> <code class="nv">first-node</code><code class="p">)))</code>
<code class="linenos"> 80 </code>           <code class="p">(</code><code class="nv">total-estimate</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">distance-to-here</code>
<code class="linenos"> 81 </code>                              <code class="p">(</code><code class="nv">get-stored-dist</code> <code class="nv">lead-node</code> <code class="nv">goal</code><code class="p">)))</code>
<code class="linenos"> 82 </code>           <code class="p">(</code><code class="nv">new-path</code> <code class="p">(</code><code class="nb">cons</code> <code class="nv">first-node</code> <code class="nv">path</code><code class="p">)))</code>
<code class="linenos"> 83 </code>      <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">total-estimate</code> <code class="nv">dist-to-first</code> <code class="nv">new-path</code><code class="p">))))</code>
<code class="linenos"> 84 </code>
<code class="linenos"> 85 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">get-stored-path</code> <code class="p">(</code><code class="nv">start</code> <code class="nv">goal</code><code class="p">)</code>
<code class="linenos"> 86 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">start</code> <code class="nv">goal</code><code class="p">)</code>
<code class="linenos"> 87 </code>        <code class="p">(</code><code class="nb">list</code> <code class="nv">start</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 88 </code>        <code class="p">(</code><code class="nb">assoc</code> <code class="nv">goal</code> <code class="p">(</code><code class="nb">get</code> <code class="nv">start</code> <code class="ss">'path-list</code><code class="p">))))</code>
<code class="linenos"> 89 </code>
<code class="linenos"> 90 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">node-not-in-path</code> <code class="p">(</code><code class="nv">node</code> <code class="nv">path</code><code class="p">)</code>
<code class="linenos"> 91 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">path</code><code class="p">)</code>
<code class="linenos"> 92 </code>        <code class="no">t</code>
<code class="linenos"> 93 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">node</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos"> 94 </code>            <code class="no">nil</code>
<code class="linenos"> 95 </code>            <code class="p">(</code><code class="nv">node-not-in-path</code> <code class="nv">node</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">path</code><code class="p">)))))</code>
<code class="linenos"> 96 </code>
<code class="linenos"> 97 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">consider-all-nodes</code> <code class="p">(</code><code class="nv">lead-node</code> <code class="nv">goal</code> <code class="nv">path</code> <code class="nv">start-to-lead-node-dist</code><code class="p">)</code>
<code class="linenos"> 98 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">dist-to-first</code> <code class="nv">total-estimate</code> <code class="nv">new-path</code> <code class="nv">new-nodes</code><code class="p">)</code>
<code class="linenos"> 99 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">node</code> <code class="p">(</code><code class="nv">collect-linked-nodes</code> <code class="nv">lead-node</code><code class="p">))</code>
<code class="linenos">100 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nv">node-not-in-path</code> <code class="nv">node</code> <code class="nv">path</code><code class="p">)</code>
<code class="linenos">101 </code>            <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">102 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">dist-to-first</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">start-to-lead-node-dist</code>
<code class="linenos">103 </code>                                     <code class="p">(</code><code class="nv">get-stored-dist</code> <code class="nv">lead-node</code> <code class="nv">node</code><code class="p">)))</code>
<code class="linenos">104 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">total-estimate</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">dist-to-first</code>
<code class="linenos">105 </code>                                      <code class="p">(</code><code class="nv">dist-between-points</code>
<code class="linenos">106 </code>                                       <code class="p">(</code><code class="nb">eval</code> <code class="nv">node</code><code class="p">)</code>
<code class="linenos">107 </code>                                       <code class="p">(</code><code class="nb">eval</code>  <code class="nv">goal</code><code class="p">))))</code>
<code class="linenos">108 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">new-path</code> <code class="p">(</code><code class="nb">cons</code> <code class="nv">node</code> <code class="nv">path</code><code class="p">))</code>
<code class="linenos">109 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">new-nodes</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">total-estimate</code>
<code class="linenos">110 </code>                                          <code class="nv">dist-to-first</code>
<code class="linenos">111 </code>                                          <code class="nv">new-path</code><code class="p">)</code>
<code class="linenos">112 </code>                                    <code class="nv">new-nodes</code><code class="p">)))))</code>
<code class="linenos">113 </code>      <code class="nv">new-nodes</code><code class="p">))</code>
<code class="linenos">114 </code>
<code class="linenos">115 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">collect-linked-nodes</code> <code class="p">(</code><code class="nv">node</code><code class="p">)</code>
<code class="linenos">116 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">links</code><code class="p">)</code>
<code class="linenos">117 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">link</code> <code class="p">(</code><code class="nb">get</code> <code class="nv">node</code> <code class="ss">'path-list</code><code class="p">))</code>
<code class="linenos">118 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nv">first-on-path</code> <code class="nv">link</code><code class="p">))</code>
<code class="linenos">119 </code>            <code class="p">(</code><code class="k">setq</code> <code class="nv">links</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nv">goal-node</code> <code class="nv">link</code><code class="p">)</code> <code class="nv">links</code><code class="p">))))</code>
<code class="linenos">120 </code>      <code class="nv">links</code><code class="p">))</code>
<code class="linenos">121 </code>
<code class="linenos">122 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">get-stored-dist</code> <code class="p">(</code><code class="nv">node1</code> <code class="nv">node2</code><code class="p">)</code>
<code class="linenos">123 </code>    <code class="p">(</code><code class="nv">distance-to-that-node</code> <code class="p">(</code><code class="nv">get-stored-path</code> <code class="nv">node1</code> <code class="nv">node2</code><code class="p">)))</code>
<code class="linenos">124 </code>
<code class="linenos">125 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">collect-ascending-search-list-order</code> <code class="p">(</code><code class="nv">a</code> <code class="nv">l</code><code class="p">)</code>
<code class="linenos">126 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">l</code><code class="p">)</code>
<code class="linenos">127 </code>        <code class="p">(</code><code class="nb">list</code> <code class="nv">a</code><code class="p">)</code>
<code class="linenos">128 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&lt;</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">a</code><code class="p">)</code> <code class="p">(</code><code class="nb">caar</code> <code class="nv">l</code><code class="p">))</code>
<code class="linenos">129 </code>            <code class="p">(</code><code class="nb">cons</code> <code class="nv">a</code> <code class="nv">l</code><code class="p">)</code>
<code class="linenos">130 </code>            <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">l</code><code class="p">)</code> <code class="p">(</code><code class="nv">Collect-ascending-search-list-order</code> <code class="nv">a</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">l</code><code class="p">))))))</code>
<code class="linenos">131 </code>
<code class="linenos">132 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">get-first-node-in-path</code> <code class="p">(</code><code class="nv">start</code> <code class="nv">goal</code><code class="p">)</code>
<code class="linenos">133 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">first-node</code><code class="p">)</code>
<code class="linenos">134 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">first-node</code>  <code class="p">(</code><code class="nv">first-on-path</code> <code class="p">(</code><code class="nv">get-stored-path</code> <code class="nv">start</code> <code class="nv">goal</code><code class="p">)))</code>
<code class="linenos">135 </code>      <code class="p">(</code><code class="k">if</code> <code class="nv">first-node</code> <code class="nv">first-node</code> <code class="nv">goal</code><code class="p">)))</code>
<code class="linenos">136 </code>
<code class="linenos">137 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">a*-helper</code> <code class="p">()</code>
<code class="linenos">138 </code>    <code class="p">(</code><code class="k">if</code> <code class="nv">possible-paths</code>
<code class="linenos">139 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">140 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nv">best</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">possible-paths</code><code class="p">))</code>
<code class="linenos">141 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nv">possible-paths</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">possible-paths</code><code class="p">))</code>
<code class="linenos">142 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">first</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">best</code><code class="p">))</code> <code class="nv">goal</code><code class="p">)</code>
<code class="linenos">143 </code>              <code class="nv">best</code>
<code class="linenos">144 </code>              <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">145 </code>                <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">child</code> <code class="p">(</code><code class="nv">enumerate-children</code> <code class="nv">best</code> <code class="nv">goal</code><code class="p">))</code>
<code class="linenos">146 </code>                  <code class="p">(</code><code class="k">setq</code> <code class="nv">possible-paths</code>
<code class="linenos">147 </code>                        <code class="p">(</code><code class="nv">collect-ascending-search-list-order</code>
<code class="linenos">148 </code>                         <code class="nv">child</code> <code class="nv">possible-paths</code><code class="p">)))</code>
<code class="linenos">149 </code>                <code class="p">(</code><code class="nv">a*-helper</code><code class="p">))))))</code>
<code class="linenos">150 </code>  <code class="p">(</code><code class="nv">init-network</code><code class="p">)</code>
<code class="linenos">151 </code>  <code class="p">(</code><code class="nb">reverse</code> <code class="p">(</code><code class="nb">caddr</code> <code class="p">(</code><code class="nv">a*-helper</code><code class="p">))))</code>
<code class="linenos">152 </code>
<code class="linenos">153 </code><code class="c1">;;      Throw away test code:</code>
<code class="linenos">154 </code>
<code class="linenos">155 </code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">n1</code> <code class="o">'</code><code class="p">(</code><code class="mi">30</code> <code class="mi">201</code><code class="p">))</code>
<code class="linenos">156 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n2</code> <code class="o">'</code><code class="p">(</code><code class="mi">25</code> <code class="mi">140</code><code class="p">))</code>
<code class="linenos">157 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n3</code> <code class="o">'</code><code class="p">(</code><code class="mi">55</code> <code class="mi">30</code><code class="p">))</code>
<code class="linenos">158 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n4</code> <code class="o">'</code><code class="p">(</code><code class="mi">105</code> <code class="mi">190</code><code class="p">))</code>
<code class="linenos">159 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n5</code> <code class="o">'</code><code class="p">(</code><code class="mi">95</code> <code class="mi">110</code><code class="p">))</code>
<code class="linenos">160 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n6</code> <code class="o">'</code><code class="p">(</code><code class="mi">140</code> <code class="mi">22</code><code class="p">))</code>
<code class="linenos">161 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n7</code> <code class="o">'</code><code class="p">(</code><code class="mi">160</code> <code class="mi">150</code><code class="p">))</code>
<code class="linenos">162 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n8</code> <code class="o">'</code><code class="p">(</code><code class="mi">170</code> <code class="mi">202</code><code class="p">))</code>
<code class="linenos">163 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n9</code> <code class="o">'</code><code class="p">(</code><code class="mi">189</code> <code class="mi">130</code><code class="p">))</code>
<code class="linenos">164 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n10</code> <code class="o">'</code><code class="p">(</code><code class="mi">200</code> <code class="mi">55</code><code class="p">))</code>
<code class="linenos">165 </code><code class="p">(</code><code class="nb">defvar</code>  <code class="nv">n11</code> <code class="o">'</code><code class="p">(</code><code class="mi">205</code> <code class="mi">201</code><code class="p">))</code>
<code class="linenos">166 </code>
<code class="linenos">167 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nv">A*search</code>
<code class="linenos">168 </code>        <code class="o">'</code><code class="p">(</code><code class="nv">n1</code> <code class="nv">n2</code> <code class="nv">n3</code> <code class="nv">n4</code> <code class="nv">n5</code> <code class="nv">n6</code> <code class="nv">n7</code> <code class="nv">n8</code> <code class="nv">n9</code> <code class="nv">n10</code> <code class="nv">n11</code><code class="p">)</code> <code class="c1">;; nodes</code>
<code class="linenos">169 </code>        <code class="o">'</code><code class="p">((</code><code class="nv">n1</code> <code class="nv">n2</code><code class="p">)</code> <code class="p">(</code><code class="nv">n2</code> <code class="nv">n3</code><code class="p">)</code> <code class="p">(</code><code class="nv">n3</code> <code class="nv">n5</code><code class="p">)</code> <code class="p">(</code><code class="nv">n3</code> <code class="nv">n6</code><code class="p">)</code> <code class="p">(</code><code class="nv">n6</code> <code class="nv">n10</code><code class="p">)</code> <code class="c1">;; paths</code>
<code class="linenos">170 </code>          <code class="p">(</code><code class="nv">n9</code> <code class="nv">n10</code><code class="p">)</code> <code class="p">(</code><code class="nv">n7</code> <code class="nv">n9</code><code class="p">)</code> <code class="p">(</code><code class="nv">n1</code> <code class="nv">n4</code><code class="p">)</code> <code class="p">(</code><code class="nv">n4</code> <code class="nv">n2</code><code class="p">)</code> <code class="p">(</code><code class="nv">n5</code> <code class="nv">n8</code><code class="p">)</code>
<code class="linenos">171 </code>          <code class="p">(</code><code class="nv">n8</code> <code class="nv">n4</code><code class="p">)</code> <code class="p">(</code><code class="nv">n7</code> <code class="nv">n11</code><code class="p">))</code>
<code class="linenos">172 </code>        <code class="ss">'n1</code> <code class="ss">'n11</code><code class="p">))</code> <code class="c1">;; starting and goal nodes</code>
</pre></div>

</figure>

<p>The following example in the repl shows the calculation of the path that we saw in the figure of the graph search space.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">$</code> <code class="n">sbcl</code>
<code class="linenos">2 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"astar_search.lisp"</code><code class="p">)</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="p">(</code><code class="n">N1</code> <code class="n">N2</code> <code class="n">N3</code> <code class="n">N6</code> <code class="n">N10</code> <code class="n">N9</code> <code class="n">N7</code> <code class="n">N11</code><code class="p">)</code> 
<code class="linenos">5 </code><code class="n">T</code>
<code class="linenos">6 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>There are many types of search: breadth first as we used here, depth first, with heuristics to optimize search dependent on the type of search space.</p>


<h2 id="network_prog">Network Programming</h2>

<p>Distributed computing is pervasive: you need to look no further than the World Wide Web, Internet chat, etc. Of course, as a Lisp programmer, you will want to do at least some of your network programming in Lisp! The previous editions of this book provided low level socket network programming examples. I decided that for this new edition, I would remove those examples and instead encourage you to “move further up the food chain” and work at a higher level of abstraction that makes sense for the projects you will likely be developing. Starting in the 1980s, a lot of my work entailed low level socket programming for distributed networked applications. As I write this, it is 2013, and there are better ways to structure distributed applications.</p>

<p>Specifically, since many of the examples later in this book fetch information from the web and linked data sources, we will start be learning how to use Edi Weitz’s <a href="http://weitz.de/drakma/">Drakma HTTP client library</a>. In order to have a complete client server example we will also look briefly at Edi Weitz’s <a href="http://weitz.de/hunchentoot/">Hunchentoot web server</a> that uses JSON as a data serialization format. I used to use XML for data serialization but JSON has many advantages: easier for a human to read and it plays nicely with Javascript code and some data stores like Postgres (new in versions 9.x), MongoDB, and CouchDB that support JSON as a native data format.</p>

<p>The code snippets in the first two sections of this chapter are derived from examples in the Drackma and Hunchentoot documentation.</p>

<h3 id="leanpub-auto-an-introduction-to-drakma">An introduction to Drakma</h3>

<p>Edi Weitz’s <a href="http://weitz.de/drakma/">Drakma library</a> supports fetching data via HTTP requests. As you can see in the Drakma documentation, you can use this library for authenticated HTTP requests (i.e., allow you to access web sites that require a login), support HTTP GET and PUT operations, and deal with cookies. The top level API that we will use is <strong>drakma:http-request</strong> that returns multiple values. In the following example, I want only the first three values, and ignore the others like the original URI that was fetched and an IO stream object. We use the built-in Common Lisp macro <strong>multiple-value-setq</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">drakma</code><code class="p">)</code>
<code class="linenos">2 </code><code class="o">*</code> <code class="p">(</code><code class="n">multiple</code><code class="o">-</code><code class="n">value</code><code class="o">-</code><code class="n">setq</code>
<code class="linenos">3 </code>    <code class="p">(</code><code class="n">data</code> <code class="n">http</code><code class="o">-</code><code class="n">response</code><code class="o">-</code><code class="n">code</code> <code class="n">headers</code><code class="p">)</code>
<code class="linenos">4 </code>    <code class="p">(</code><code class="n">drakma</code><code class="p">:</code><code class="n">http</code><code class="o">-</code><code class="n">request</code> <code class="s2">"http://markwatson.com"</code><code class="p">))</code>
</pre></div>

</figure>

<p>I manually formatted the last statement I entered in the last repl listing and I will continue to manually edit the repl listings in the rest of this book to make them more easily readable.</p>

<p>The following shows some of the data bound to the variables <strong>data</strong>, <strong>http-response-code</strong>, and <strong>headers</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* data
<code class="linenos">2 </code>
<code class="linenos">3 </code>"<code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="linenos">4 </code><code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
<code class="linenos">5 </code>  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="linenos">6 </code>	<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Mark Watson: Consultant and Author<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The value of <strong>http-response-code</strong> is 200 which means that there were no errors:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* http-response-code
<code class="linenos">2 </code>
<code class="linenos">3 </code>200
</pre></div>

</figure>

<p>The HTTP response headers will be useful in many applications; for fetching the home page of my web site the headers are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="nt">headers</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">((</code><code class="p">:</code><code class="nd">SERVER</code> <code class="o">.</code> <code class="s2">"nginx/1.1.19"</code><code class="o">)</code>
<code class="linenos"> 4 </code> <code class="o">(</code><code class="p">:</code><code class="nd">DATE</code> <code class="o">.</code> <code class="s2">"Fri, 05 Jul 2013 15:18:27 GMT"</code><code class="o">)</code>
<code class="linenos"> 5 </code> <code class="o">(</code><code class="p">:</code><code class="nd">CONTENT-TYPE</code> <code class="o">.</code> <code class="s2">"text/html; charset=utf-8"</code><code class="o">)</code>
<code class="linenos"> 6 </code> <code class="o">(</code><code class="p">:</code><code class="nd">TRANSFER-ENCODING</code> <code class="o">.</code> <code class="s2">"chunked"</code><code class="o">)</code>
<code class="linenos"> 7 </code> <code class="o">(</code><code class="p">:</code><code class="nd">CONNECTION</code> <code class="o">.</code> <code class="s2">"close"</code><code class="o">)</code>
<code class="linenos"> 8 </code> <code class="o">(</code><code class="p">:</code><code class="nd">SET-COOKIE</code>
<code class="linenos"> 9 </code>   <code class="o">.</code>
<code class="linenos">10 </code>   <code class="s2">"ring-session=cec5d7ba-e4da-4bf4-b05e-aff670e0dd10;Path=/"</code><code class="o">))</code>
</pre></div>

</figure>

<p>We will use Drakma later in this book for several examples. In the next section we will write a web app using Hunchentoot and test it with a Drakma client.</p>

<h3 id="leanpub-auto-an-introduction-to-hunchentoot">An introduction to Hunchentoot</h3>

<p>Edi Weitz’s <a href="http://weitz.de/hunchentoot/">Hunchentoot project</a> is a flexible library for writing web applications and web services. We will also use Edi’s CL-WHO library in this section for generating HTML from Lisp code. Hunchentoot will be installed the first time you quick load it in the example code for this section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"hunchentoot"</code><code class="p">)</code>
</pre></div>

</figure>

<p>I will use only <a href="http://weitz.de/hunchentoot/#easy-handlers">easy handler framework</a> in the Hunchentoot examples in this section. I leave it to you to read the <a href="http://weitz.de/hunchentoot/#acceptors">documentation on using custom acceptors</a> after you experiment with the examples in this section.</p>

<p>The following code will work for both multi-threading installations of SBCL and single thread installations (e.g., some default installations of SBCL on OS X):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:hunchentoot</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:cl-who</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">:cl-user</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="nv">hdemo</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">:cl</code>
<code class="linenos"> 7 </code>        <code class="ss">:cl-who</code>
<code class="linenos"> 8 </code>        <code class="ss">:hunchentoot</code><code class="p">))</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">:hdemo</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*h*</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'easy-acceptor</code> <code class="ss">:port</code> <code class="mi">3000</code><code class="p">))</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="c1">;; define a handler with the arbitrary name my-greetings:</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="p">(</code><code class="nv">define-easy-handler</code> <code class="p">(</code><code class="nv">my-greetings</code> <code class="ss">:uri</code> <code class="s">"/hello"</code><code class="p">)</code> <code class="p">(</code><code class="nv">name</code><code class="p">)</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">hunchentoot:content-type*</code><code class="p">)</code> <code class="s">"text/html"</code><code class="p">)</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="nv">with-html-output-to-string</code> <code class="p">(</code><code class="vg">*standard-output*</code> <code class="no">nil</code> <code class="ss">:prologue</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="ss">:html</code>
<code class="linenos">19 </code>     <code class="p">(</code><code class="ss">:head</code> <code class="p">(</code><code class="ss">:title</code> <code class="s">"hunchentoot test"</code><code class="p">))</code>
<code class="linenos">20 </code>     <code class="p">(</code><code class="ss">:body</code>
<code class="linenos">21 </code>      <code class="p">(</code><code class="ss">:h1</code> <code class="s">"hunchentoot form demo"</code><code class="p">)</code>
<code class="linenos">22 </code>      <code class="p">(</code><code class="ss">:form</code>
<code class="linenos">23 </code>       <code class="ss">:method</code> <code class="ss">:post</code>
<code class="linenos">24 </code>       <code class="p">(</code><code class="ss">:input</code> <code class="ss">:type</code> <code class="ss">:text</code>
<code class="linenos">25 </code>	       <code class="ss">:name</code> <code class="s">"name"</code>
<code class="linenos">26 </code>	       <code class="ss">:value</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">27 </code>       <code class="p">(</code><code class="ss">:input</code> <code class="ss">:type</code> <code class="ss">:submit</code> <code class="ss">:value</code> <code class="s">"Submit your name"</code><code class="p">))</code>
<code class="linenos">28 </code>      <code class="p">(</code><code class="ss">:p</code> <code class="s">"Hello "</code> <code class="p">(</code><code class="nv">str</code> <code class="nv">name</code><code class="p">))))))</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="p">(</code><code class="nv">hunchentoot:start</code> <code class="vg">*h*</code><code class="p">)</code>
</pre></div>

</figure>

<p>In lines 5 through 9 we create an use a new package that includes support for generating HTML in Lisp code (CL-WHO) and the Hunchentoot library). On line 11 we create an instance of an easy acceptor on port 3000 that provides useful default behaviors for providing HTTP services.</p>

<p>The Hunchentoot macro <strong>define-easy-handler</strong> is used in lines 15 through 28 to define an HTTP request handler and add it to the easy acceptor instance. The first argument, <strong>my-greetings</strong> in this example, is an arbitrary name and the keyword <strong>:uri</strong> argument provides a URL pattern that the easy acceptor server object uses to route requests to this handler. For example, when you run this example on your computer, this URL routing pattern would handle requests like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>http://localhost:3000/hello
</pre></div>

</figure>

<p>In lines 17 through 28 we are using the CL-WHO library to generate HTML for a web page. As you might guess, <strong>:html</strong> generates the outer &lt;html&gt;&lt;/html&gt; tags for a web page. Line 19 would generate HTML like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="nt">&lt;head&gt;</code>
<code class="linenos">2 </code>	<code class="nt">&lt;title&gt;</code>hunchentoot test<code class="nt">&lt;/title&gt;</code>
<code class="linenos">3 </code>  <code class="nt">&lt;/head&gt;</code>
</pre></div>

</figure>

<p>Lines 22 through 27 generate an HTML input form and line 28 displays any value generated when the user entered text in the input filed and clicked the submit button. Notice the definition of the argument <strong>name</strong> in line 1 in the definition of the easy handler. If the argument <strong>name</strong> is not defined, the <strong>nil</strong> value will be displayed in line 28 as an empty string.</p>

<p>You should run this example and access the generated web page in a web browser, and enter text, submit, etc. You can also fetch the generated page HTML using the Drakma library that we saw in the last section. Here is a code snippet using the Drakma client library to access this last example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="o">(</code><code class="nt">drakma</code><code class="p">:</code><code class="nd">http-request</code> <code class="s2">"http://127.0.0.1:3000/hello?name=Mark"</code><code class="o">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="s2">"Hello Mark"</code>
<code class="linenos"> 4 </code><code class="nt">200</code>
<code class="linenos"> 5 </code><code class="o">((</code><code class="p">:</code><code class="nd">CONTENT-LENGTH</code> <code class="o">.</code> <code class="s2">"10"</code><code class="o">)</code>
<code class="linenos"> 6 </code> <code class="o">(</code><code class="p">:</code><code class="nd">DATE</code> <code class="o">.</code> <code class="s2">"Fri, 05 Jul 2013 15:57:22 GMT"</code><code class="o">)</code>
<code class="linenos"> 7 </code> <code class="o">(</code><code class="p">:</code><code class="nd">SERVER</code> <code class="o">.</code> <code class="s2">"Hunchentoot 1.2.18"</code><code class="o">)</code>
<code class="linenos"> 8 </code> <code class="o">(</code><code class="p">:</code><code class="nd">CONNECTION</code> <code class="o">.</code> <code class="s2">"Close"</code><code class="o">)</code>
<code class="linenos"> 9 </code> <code class="o">(</code><code class="p">:</code><code class="nd">CONTENT-TYPE</code> <code class="o">.</code> <code class="s2">"text/plain; charset=utf-8"</code><code class="o">))</code>
<code class="linenos">10 </code><code class="err">#</code><code class="o">&lt;</code><code class="nt">PURI</code><code class="p">:</code><code class="nd">URI</code> <code class="nt">http</code><code class="o">://</code><code class="nt">127</code><code class="p">.</code><code class="nc">0</code><code class="p">.</code><code class="nc">0</code><code class="p">.</code><code class="nc">1</code><code class="p">:</code><code class="nd">3000</code><code class="o">/</code><code class="nt">hello</code><code class="o">?</code><code class="nt">name</code><code class="o">=</code><code class="nt">Mark</code><code class="o">&gt;</code>
<code class="linenos">11 </code><code class="err">#</code><code class="o">&lt;</code><code class="nt">FLEXI-STREAMS</code><code class="p">:</code><code class="nd">FLEXI-IO-STREAM</code> <code class="p">{</code><code class="err">10095654A3</code><code class="p">}</code><code class="o">&gt;</code>
<code class="linenos">12 </code><code class="nt">T</code>
<code class="linenos">13 </code><code class="s2">"OK"</code>
</pre></div>

</figure>

<p>We will use both Drackma and Hunchentoot in the next section.</p>

<h3 id="leanpub-auto-complete-rest-client-server-example-using-json-for-data-serialization">Complete REST Client Server Example Using JSON for Data Serialization</h3>

<p>A reasonable way to build modern distributed systems is to write REST web services that serve JSON data to client applications. These client applications might be rich web apps written in Javascript, other web services, and applications running on smartphones that fetch and save data to a remote web service.</p>

<p>We will use the <strong>cl-json</strong> Quicklisp package to encode Lisp data into a string representing JSON encoded data. Here is a quick example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">cl</code><code class="o">-</code><code class="n">json</code><code class="p">)</code>
<code class="linenos">2 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">y</code> <code class="p">(</code><code class="n">list</code> <code class="p">(</code><code class="n">list</code> <code class="s1">'(cat . "the cat ran") '</code><code class="p">(</code><code class="n">dog</code> <code class="o">.</code> <code class="mi">101</code><code class="p">))</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code><code class="p">))</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="n">Y</code>
<code class="linenos">5 </code><code class="o">*</code> <code class="n">y</code>
<code class="linenos">6 </code>
<code class="linenos">7 </code><code class="p">(((</code><code class="n">CAT</code> <code class="o">.</code> <code class="s2">"the cat ran"</code><code class="p">)</code> <code class="p">(</code><code class="n">DOG</code> <code class="o">.</code> <code class="mi">101</code><code class="p">))</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">8 </code><code class="o">*</code> <code class="p">(</code><code class="n">json</code><code class="p">:</code><code class="n">encode</code><code class="o">-</code><code class="n">json</code><code class="o">-</code><code class="n">to</code><code class="o">-</code><code class="n">string</code> <code class="n">y</code><code class="p">)</code>
<code class="linenos">9 </code><code class="s2">"[{</code><code class="se">\"</code><code class="s2">cat</code><code class="se">\"</code><code class="s2">:</code><code class="se">\"</code><code class="s2">the cat ran</code><code class="se">\"</code><code class="s2">,</code><code class="se">\"</code><code class="s2">dog</code><code class="se">\"</code><code class="s2">:101},1,2,3,4,5]"</code>
</pre></div>

</figure>

<p>The following list shows the contents of the file <strong>src/web-hunchentoot-json.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:hunchentoot</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:cl-json</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*h*</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'hunchentoot:easy-acceptor</code> <code class="ss">:port</code> <code class="mi">3000</code><code class="p">))</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="c1">;; define a handler with the name animal:</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="nv">hunchentoot:define-easy-handler</code> <code class="p">(</code><code class="nv">animal</code> <code class="ss">:uri</code> <code class="s">"/animal"</code><code class="p">)</code> <code class="p">(</code><code class="nv">name</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="nb">print</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">hunchentoot:content-type*</code><code class="p">)</code> <code class="s">"text/plain"</code><code class="p">)</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="nb">cond</code>
<code class="linenos">12 </code>    <code class="p">((</code><code class="nb">string-equal</code> <code class="nv">name</code> <code class="s">"cat"</code><code class="p">)</code>
<code class="linenos">13 </code>     <code class="p">(</code><code class="nv">json:encode-json-to-string</code>
<code class="linenos">14 </code>       <code class="p">(</code><code class="nb">list</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="nb">list</code>
<code class="linenos">16 </code>         <code class="o">'</code><code class="p">(</code><code class="nv">average_weight</code> <code class="o">.</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos">17 </code>         <code class="o">'</code><code class="p">(</code><code class="nv">friendly</code> <code class="o">.</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos">18 </code>        <code class="s">"A cat can live indoors or outdoors."</code><code class="p">)))</code>
<code class="linenos">19 </code>    <code class="p">((</code><code class="nb">string-equal</code> <code class="nv">name</code> <code class="s">"dog"</code><code class="p">)</code>
<code class="linenos">20 </code>     <code class="p">(</code><code class="nv">json:encode-json-to-string</code>
<code class="linenos">21 </code>       <code class="p">(</code><code class="nb">list</code>
<code class="linenos">22 </code>        <code class="p">(</code><code class="nb">list</code>
<code class="linenos">23 </code>         <code class="o">'</code><code class="p">(</code><code class="nv">average_weight</code> <code class="o">.</code> <code class="mi">40</code><code class="p">)</code>
<code class="linenos">24 </code>         <code class="o">'</code><code class="p">(</code><code class="nv">friendly</code> <code class="o">.</code> <code class="no">t</code><code class="p">))</code>
<code class="linenos">25 </code>        <code class="s">"A dog is a loyal creature, much valued by humans."</code><code class="p">)))</code>
<code class="linenos">26 </code>    <code class="p">(</code><code class="no">t</code>
<code class="linenos">27 </code>     <code class="p">(</code><code class="nv">json:encode-json-to-string</code>
<code class="linenos">28 </code>       <code class="p">(</code><code class="nb">list</code>
<code class="linenos">29 </code>        <code class="p">()</code>
<code class="linenos">30 </code>        <code class="s">"unknown type of animal"</code><code class="p">)))))</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="p">(</code><code class="nv">hunchentoot:start</code> <code class="vg">*h*</code><code class="p">)</code>
</pre></div>

</figure>

<p>This example is very similar to the web application example in the last section. The difference is that this application is not intended to be viewed on a web page because it returns JSON data as HTTP responses. The easy handler definition on line 8 specifies a handler argument <strong>name</strong>. In lines 12 and 19 we check to see if the value of the argument <strong>name</strong> is “cat” or “dog” and if it is, we return the appropriate JSON example data for those animals. If there is no match, the default <strong>cond</strong> clause starting on line 26 returns a warning string as a JSON encoded string.</p>

<p>While running this test service, in one repl, you can ue the Drakma library in another repl to test it (not all output is shown in the next listing):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">drakma</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="o">*</code> <code class="p">(</code><code class="n">drakma</code><code class="p">:</code><code class="n">http</code><code class="o">-</code><code class="n">request</code> <code class="s2">"http://127.0.0.1:3000/animal?name=dog"</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="s2">"[{</code><code class="se">\"</code><code class="s2">average_weight</code><code class="se">\"</code><code class="s2">:40,</code>
<code class="linenos"> 5 </code>   \<code class="s2">"friendly</code><code class="se">\"</code><code class="s2">:true},</code>
<code class="linenos"> 6 </code>   \<code class="s2">"A dog is a loyal creature, much valued by humans.</code><code class="se">\"</code><code class="s2">]"</code>
<code class="linenos"> 7 </code><code class="mi">200</code>
<code class="linenos"> 8 </code><code class="o">*</code> <code class="p">(</code><code class="n">drakma</code><code class="p">:</code><code class="n">http</code><code class="o">-</code><code class="n">request</code> <code class="s2">"http://127.0.0.1:3000/animal?name=cat"</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="s2">"[{</code><code class="se">\"</code><code class="s2">average_weight</code><code class="se">\"</code><code class="s2">:10,</code>
<code class="linenos">11 </code>   \<code class="s2">"friendly</code><code class="se">\"</code><code class="s2">:null},</code>
<code class="linenos">12 </code>   \<code class="s2">"A cat can live indoors or outdoors.</code><code class="se">\"</code><code class="s2">]"</code>
<code class="linenos">13 </code><code class="mi">200</code>
</pre></div>

</figure>

<p>You can use the <strong>cl-json</strong> library to decode a string containing JSON data to Lisp data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">cl</code><code class="o">-</code><code class="n">json</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="n">To</code> <code class="nb">load</code> <code class="s2">"cl-json"</code><code class="p">:</code>
<code class="linenos"> 3 </code>  <code class="n">Load</code> <code class="mi">1</code> <code class="n">ASDF</code> <code class="n">system</code><code class="p">:</code>
<code class="linenos"> 4 </code>    <code class="n">cl</code><code class="o">-</code><code class="n">json</code>
<code class="linenos"> 5 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s2">"cl-json"</code>
<code class="linenos"> 6 </code><code class="o">.</code>
<code class="linenos"> 7 </code><code class="p">(:</code><code class="n">CL</code><code class="o">-</code><code class="n">JSON</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="o">*</code> <code class="p">(</code><code class="n">cl</code><code class="o">-</code><code class="n">json</code><code class="p">:</code><code class="n">decode</code><code class="o">-</code><code class="n">json</code><code class="o">-</code><code class="n">from</code><code class="o">-</code><code class="n">string</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="n">drakma</code><code class="p">:</code><code class="n">http</code><code class="o">-</code><code class="n">request</code> <code class="s2">"http://127.0.0.1:3000/animal?name=dog"</code><code class="p">))</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(((:</code><code class="n">AVERAGE</code><code class="o">--</code><code class="n">WEIGHT</code> <code class="o">.</code> <code class="mi">40</code><code class="p">)</code> <code class="p">(:</code><code class="n">FRIENDLY</code> <code class="o">.</code> <code class="n">T</code><code class="p">))</code>
<code class="linenos">12 </code> <code class="s2">"A dog is a loyal creature, much valued by humans."</code><code class="p">)</code>
</pre></div>

</figure>

<p>For most of my work, REST web services are “read-only” in the sense that clients don’t modify state on the server. However, there are use cases where a client application might want to; for example, letting clients add new animals to the last example.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defparameter</code> <code class="vg">*animal-hash*</code> <code class="p">(</code><code class="nb">make-hash-table</code><code class="p">))</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">;; handle HTTP POST requests:</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nv">hunchentoot:define-easy-handler</code> <code class="p">(</code><code class="nv">some-handler</code> <code class="ss">:uri</code> <code class="s">"/add"</code><code class="p">)</code> <code class="p">(</code><code class="nv">json-data</code><code class="p">)</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">hunchentoot:content-type*</code><code class="p">)</code> <code class="s">"text/plain"</code><code class="p">)</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">data-string</code> <code class="p">(</code><code class="nv">hunchentoot:raw-post-data</code> <code class="ss">:force-text</code> <code class="no">t</code><code class="p">))</code>
<code class="linenos"> 7 </code>         <code class="p">(</code><code class="nv">data</code> <code class="p">(</code><code class="nv">cl-json:decode-json-from-string</code> <code class="nv">json-data</code><code class="p">))</code>
<code class="linenos"> 8 </code>         <code class="c1">;; assume that the name of the animal is a hashed value:</code>
<code class="linenos"> 9 </code>         <code class="p">(</code><code class="nv">animal-name</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"name"</code> <code class="nv">data</code><code class="p">)))</code>
<code class="linenos">10 </code>     <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">animal-name</code> <code class="vg">*animal-hash*</code><code class="p">)</code> <code class="nv">data</code><code class="p">))</code>
<code class="linenos">11 </code>  <code class="s">"OK"</code><code class="p">)</code>
</pre></div>

</figure>

<p>In line 4 we are defining an additional easy handler with a handler argument <strong>json-data</strong>. This data is assumed to be a string encoding of JSON data which is decoded into Lisp data in lines 6 and 7. We save the data to the global variable <em>animal-hash</em>.</p>

<p>In this example, we are storing data sent from a client in an in-memory hash table. In a real application new data might be stored in a database.</p>

<h3 id="leanpub-auto-network-programming-wrap-up">Network Programming Wrap Up</h3>

<p>You have learned the basics for writing web services and writing clients to use web services. Later, we will use web services written in Python by writing Common Lisp clients: we will wrap retrained deep learning models and access them from Common Lisp.</p>


<h2 id="leanpub-auto-using-the-microsoft-bing-search-apis">Using the Microsoft Bing Search APIs</h2>

<p>I have used the Bing search APIs for many years. Microsoft Bing supports several commercial search engine services, including my favorite search engine Duck Duck Go. Bing is now part of the Azure infrastructure that is branded as “Cognitive Services.” You should find the example code for this chapter relatively easy to extend to other Azure Cognitive Services that you might need to use.</p>

<p>You will need to register with Microsoft’s Azure search service to use the material in this chapter. It is likely that you view search as a manual human-centered activity. I hope to expand your thinking to considering applications that automate search, finding information on the web, and automatically organizing information.</p>

<p>While the example code uses only the search APIs, with some modification it can be extended to work with all REST APIs provided by <a href="https://azure.microsoft.com/en-us/services/cognitive-services/">Azure Cognitive Services</a> that include: analyzing text to get user intent, general language understanding, detecting key phrases and entity names, translate between languages, converting between speech and text, and various computer vision services. These services are generally free or very low cost for a few thousand API calls a month, with increased cost for production deployments. Microsoft spends about $1 billion a year in research and development for Azure Cognitive Services.</p>

<h3 id="leanpub-auto-getting-an-access-key-for-microsoft-bing-search-apis">Getting an Access Key for Microsoft Bing Search APIs</h3>

<p>You will need to set up an Azure account if you don’t already have one. I use the Bing search APIs fairly often for research but I have never spent more than about a dollar a month and usually I get no bill at all. For personal use it is a very inexpensive service.</p>

<p>You start by going to the web page <a href="https://azure.microsoft.com/en-us/try/cognitive-services/">https://azure.microsoft.com/en-us/try/cognitive-services/</a> and sign up for an access key. The Search APIs sign up is currently in the fourth tab in this web form. When you navigate to the Search APIs tab, select the option Bing Search APIs v7. You will get an API key that you need to store in an environment variable that you will soon need:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">export</code> <code class="nv">BING_SEARCH_V7_SUBSCRIPTION_KEY</code><code class="o">=</code>1e97834341d2291191c772b7371ad5b7
</pre></div>

</figure>

<p>That is not my real subscription key!</p>

<p>You also set the Bing search API as an environment variable:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">export</code> <code class="nv">BING_SEARCH_V7_ENDPOINT</code><code class="o">=</code>https://api.cognitive.microsoft.com/bing/v7.0/search
</pre></div>

</figure>

<h3 id="leanpub-auto-example-search-script">Example Search Script</h3>

<p>Instead of using a pure Common Lisp HTTP client library I often prefer using the <strong>curl</strong> command run in a separate process. The <strong>curl</strong> utility handles all possible authentication modes, handles headers, response data in several formats, etc. We capture the output from <strong>curl</strong> in a string that in turn gets processed by a JSON library.</p>

<p>It takes very little Common Lisp code to access the Bing search APIs. The function <strong>websearch</strong> makes a generic web search query. The function <strong>get-wikidata-uri</strong> uses the <strong>websearch</strong> function by adding “site:wikidata.org” to the query and returning only the WikiData URI for the original search term. We will later see several examples. I will list the entire library with comments to follow:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:bing</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-wikidata-uri</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">sr</code> <code class="p">(</code><code class="nv">websearch</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"site:wikidata.org "</code> <code class="nv">query</code><code class="p">))))</code>
<code class="linenos"> 5 </code>    <code class="p">(</code><code class="nb">cadar</code> <code class="nv">sr</code><code class="p">)))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">websearch</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">key</code> <code class="p">(</code><code class="nv">uiop:getenv</code> <code class="s">"BING_SEARCH_V7_SUBSCRIPTION_KEY"</code><code class="p">))</code>
<code class="linenos"> 9 </code>         <code class="p">(</code><code class="nv">endpoint</code> <code class="p">(</code><code class="nv">uiop:getenv</code> <code class="s">"BING_SEARCH_V7_ENDPOINT"</code><code class="p">))</code>
<code class="linenos">10 </code>         <code class="p">(</code><code class="nv">command</code>
<code class="linenos">11 </code>          <code class="p">(</code><code class="nb">concatenate</code>
<code class="linenos">12 </code>	   <code class="ss">'string</code>
<code class="linenos">13 </code>	   <code class="s">"curl -v -X GET \""</code>  <code class="nv">endpoint</code> <code class="s">"?q="</code>
<code class="linenos">14 </code>	   <code class="p">(</code><code class="nv">drakma:url-encode</code> <code class="nv">query</code> <code class="ss">:utf-8</code><code class="p">)</code>
<code class="linenos">15 </code>	   <code class="s">"&amp;mkt=en-US&amp;limit=4\""</code>
<code class="linenos">16 </code>	   <code class="s">" -H \"Ocp-Apim-Subscription-Key: "</code> <code class="nv">key</code> <code class="s">"\""</code><code class="p">))</code>
<code class="linenos">17 </code>         <code class="p">(</code><code class="nv">response</code>
<code class="linenos">18 </code>          <code class="p">(</code><code class="nv">uiop:run-program</code> <code class="nv">command</code> <code class="ss">:output</code> <code class="ss">:string</code><code class="p">)))</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nb">with-input-from-string</code>
<code class="linenos">20 </code>	<code class="p">(</code><code class="nv">s</code> <code class="nv">response</code><code class="p">)</code>
<code class="linenos">21 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">json-as-list</code> <code class="p">(</code><code class="nv">json:decode-json</code> <code class="nv">s</code><code class="p">))</code>
<code class="linenos">22 </code>             <code class="p">(</code><code class="nb">values</code> <code class="p">(</code><code class="nb">cdadr</code> <code class="p">(</code><code class="nb">cddr</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">2</code> <code class="nv">json-as-list</code><code class="p">)))))</code>
<code class="linenos">23 </code>	<code class="p">(</code><code class="nb">mapcar</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">24 </code>                    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">name</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:name</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">25 </code>			  <code class="p">(</code><code class="nv">display-uri</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:display-url</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">26 </code>			  <code class="p">(</code><code class="nv">snippet</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:snippet</code> <code class="nv">x</code><code class="p">)))</code>
<code class="linenos">27 </code>		      <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">name</code><code class="p">)</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">display-uri</code><code class="p">)</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">snippet</code><code class="p">))))</code>
<code class="linenos">28 </code>		<code class="nb">values</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>We get the Bing access key and the search API endpoint in lines 8-9. Lines 10-16 create a complete call to the <strong>curl* command line utility. We spawn a process to run **curl</strong> and capture the string output in the variable <strong>response</strong> in lines 17-18. You might want to add a few print statements to see typical values for the variables <strong>command</strong> and <strong>response</strong>. The response data is JSON data encoded in a string, with straightforward code in lines 19-28 to parse out the values we want.</p>

<p>The following repl listing shows this library in use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ sbcl
This is SBCL <code class="m">2</code>.0.2, an implementation of ANSI Common Lisp.
* <code class="o">(</code>ql:quickload <code class="s2">"bing"</code><code class="o">)</code>
To load <code class="s2">"bing"</code>:
  Load <code class="m">1</code> ASDF system:
    bing
<code class="p">;</code> Loading <code class="s2">"bing"</code>
..............
<code class="o">(</code><code class="s2">"bing"</code><code class="o">)</code>
* <code class="o">(</code>bing:get-wikidata-uri <code class="s2">"Sedona Arizona"</code><code class="o">)</code>
<code class="s2">"https://www.wikidata.org/wiki/Q80041"</code>
* <code class="o">(</code>bing:websearch <code class="s2">"Berlin"</code><code class="o">)</code>
<code class="o">((</code><code class="s2">"Berlin - Wikipedia"</code> <code class="s2">"https://en.wikipedia.org/wiki/Berlin"</code>
  <code class="s2">"Berlin (/ bɜːrˈlɪn /; German: [bɛʁˈliːn] (listen)) is the capital and largest cit\</code>
<code class="s2">y of Germany by both area and population. Its 3,769,495 (2019) inhabitants make it t\</code>
<code class="s2">he most populous city proper of the European Union. The city is one of Germany's 16 \</code>
<code class="s2">federal states."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"THE 15 BEST Things to Do in Berlin - 2020 (with Photos ..."</code>
  <code class="s2">"https://www.tripadvisor.com/Attractions-g187323-Activities-Berlin.html"</code>
  <code class="s2">"Book your tickets online for the top things to do in Berlin, Germany on Tripadvis\</code>
<code class="s2">or: See 571,599 traveler reviews and photos of Berlin tourist attractions. Find what\</code>
<code class="s2"> to do today, this weekend, or in August. We have reviews of the best places to see \</code>
<code class="s2">in Berlin. Visit top-rated &amp; must-see attractions."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin - Official Website of the City of Berlin, Capital ..."</code>
  <code class="s2">"https://www.berlin.de/en"</code>
  <code class="s2">"Official Website of Berlin: Information about the Administration, Events, Culture\</code>
<code class="s2">, Tourism, Hotels and Hotel Booking, Entertainment, Tickets, Public Transport, Polit\</code>
<code class="s2">ical System, Local Authorities and Business in Berlin."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin | History, Map, Population, Attractions, &amp; Facts ..."</code>
  <code class="s2">"https://www.britannica.com/place/Berlin"</code>
  <code class="s2">"Berlin is situated about 112 miles (180 km) south of the Baltic Sea, 118 miles (1\</code>
<code class="s2">90 km) north of the Czech-German border, 110 miles (177 km) east of the former inner\</code>
<code class="s2">-German border, and 55 miles (89 km) west of Poland. It lies in the wide glacial val\</code>
<code class="s2">ley of the Spree River, which runs through the centre of the city."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin travel | Germany - Lonely Planet"</code>
  <code class="s2">"https://www.lonelyplanet.com/germany/berlin"</code>
  <code class="s2">"Welcome to Berlin Berlin's combo of glamour and grit is bound to mesmerise all th\</code>
<code class="s2">ose keen to explore its vibrant culture, cutting-edge architecture, fabulous food, i\</code>
<code class="s2">ntense parties and tangible history."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin 2020: Best of Berlin, Germany Tourism - Tripadvisor"</code>
  <code class="s2">"https://www.tripadvisor.com/Tourism-g187323"</code>
  <code class="s2">"Berlin is an edgy city, from its fashion to its architecture to its charged polit\</code>
<code class="s2">ical history. The Berlin Wall is a sobering reminder of the hyper-charged postwar at\</code>
<code class="s2">mosphere, and yet the graffiti art that now covers its remnants has become symbolic \</code>
<code class="s2">of social progress."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin 2020: Best of Berlin, OH Tourism - Tripadvisor"</code>
  <code class="s2">"https://www.tripadvisor.com/Tourism-g50087-Berlin_Ohio-Vacations.html"</code>
  <code class="s2">"Berlin Tourism: Tripadvisor has 11,137 reviews of Berlin Hotels, Attractions, and\</code>
<code class="s2"> Restaurants making it your best Berlin resource."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin (band) - Wikipedia"</code> <code class="s2">"https://en.wikipedia.org/wiki/Berlin_(band)"</code>
  <code class="s2">"Berlin is the alias for vocalist Terri Nunn, as well as the American new wave ban\</code>
<code class="s2">d she fronts, having been originally formed in Orange County, California. The band g\</code>
<code class="s2">ained mainstream-commercial success with singles including \" Sex (I'm A...) \", \" \</code>
<code class="s2">No More Words \" and the chart-topping \" Take My Breath Away \" from the 1986 film \</code>
<code class="s2">Top Gun."</code><code class="o">)</code>
 <code class="o">(</code><code class="s2">"Berlin's official travel website - visitBerlin.de"</code>
  <code class="s2">"https://www.visitberlin.de/en"</code>
  <code class="s2">"Berlin's way to a metropolis 100 Years of Greater Berlin In 1920, modern Berlin w\</code>
<code class="s2">as born at one fell swoop. 8 cities, 59 rural communities and 27 manor districts uni\</code>
<code class="s2">te to form \"Greater Berlin\""</code><code class="o">))</code>
* 
</pre></div>

</figure>

<p>I have been using the Bing search APIs for many years. They are a standard part of my application building toolkit.</p>

<h3 id="leanpub-auto-wrap-up">Wrap-up</h3>

<p>You can check out the wide range of <a href="https://azure.microsoft.com/en-us/try/cognitive-services/">Congitive Services</a> on the Azure site. Available APIs include: language detection, speech recognition, vision libraries for object recognition, web search, and anomaly detection in data.</p>

<p>In addition to using automated web scraping to get data for my personal research, I often use automated web search. I find the Microsoft’s Azure Bing search APIs are the most convenient to use and I like paying for services that I use.</p>


<h2 id="leanpub-auto-accessing-relational-databases">Accessing Relational Databases</h2>

<p>There are good options for accessing relational databases from Common Lisp. Personally I almost always use Postgres and in the past I used either native foreign client libraries or the socket interface to Postgres. Recently, I decided to switch to <a href="http://clsql.b9.com/">CLSQL</a>  which provides a common interface for accessing Postgres, MySQL, SQLite, and Oracle databases. There are also several recent forks of CLSQL on github. We will use CLSQL in examples in this book. Hopefully while reading the <a href="#quicklisp">Chapter on Quicklisp</a> you installed CLSQL and the back end for one or more databases that you use for your projects. </p>

<p>For some database applications when I know that I will always use the embedded SQLite database (i.e., that I will never want to switch to Postgres of another database) I will just use the <strong>sqlite</strong> library as I do in chapter <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<p>If you have not installed CLSQL yet, then please install it now:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"clsql"</code><code class="p">)</code>
</pre></div>

</figure>

<p>You also need to install one or more CLSQL backends, depending on which relational databases you use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"clsql-postgresql"</code><code class="p">)</code>
<code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"clsql-mysql"</code><code class="p">)</code>
<code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"clsql-sqlite3"</code><code class="p">)</code>
</pre></div>

</figure>

<p>The directory <strong>src/clsql_examples</strong> contains the standalone example files for this chapter.</p>

<p>While I often prefer hand crafting SQL queries, there seems to be a general movement in software development towards the data mapper or active record design patterns. CLSQL provides Object Relational Mapping (ORM) functionality to CLOS. </p>

<p>You will need to create a new database <strong>news</strong> in order to follow along with the examples in this chapter and later in this book. I will use Postgres for examples in this chapter and use the following to create a new database (my account is “markw” and the following assumes that I have Postgres configured to not require a password for this account when accessing the database from “localhost”):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">-&gt;</code>  <code class="o">~</code>  <code class="n">psql</code>
<code class="linenos">2 </code><code class="n">psql</code> <code class="p">(</code><code class="mf">9.1.4</code><code class="p">)</code>
<code class="linenos">3 </code><code class="kr">Type</code> <code class="s">"help"</code> <code class="n">for</code> <code class="n">help</code><code class="p">.</code>
<code class="linenos">4 </code><code class="n">markw</code><code class="o">=</code><code class="err">#</code> <code class="n">create</code> <code class="n">database</code> <code class="n">news</code><code class="p">;</code>
<code class="linenos">5 </code><code class="n">CREATE</code> <code class="n">DATABASE</code>
</pre></div>

</figure>

<p>We will use three example programs that you can find in the <strong>src/clsql_examples</strong> directory in the book repository on github:</p>

<ul>
  <li>clsql_create_news_schema.lisp to create table “articles” in database “news”</li>
  <li>clsql_write_to_news.lisp to write test data to table “articles”</li>
  <li>clsql_read_from_news.lisp to read from the table “articles”</li>
</ul>

<p>The following listing shows the file <strong>src/clsql_examples/clsql_create_news_schema.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:clsql</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:clsql-postgresql</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="c1">;; Postgres connection specification:</code>
<code class="linenos"> 5 </code><code class="c1">;;    (host db user password &amp;optional port options tty).</code>
<code class="linenos"> 6 </code><code class="c1">;; The first argument to **clsql:connect** is a connection</code>
<code class="linenos"> 7 </code><code class="c1">;; specification list:</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nv">clsql:connect</code> <code class="o">'</code><code class="p">(</code><code class="s">"localhost"</code> <code class="s">"news"</code> <code class="s">"markw"</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">10 </code>               <code class="ss">:database-type</code> <code class="ss">:postgresql</code><code class="p">)</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="nv">clsql:def-view-class</code> <code class="nv">articles</code> <code class="p">()</code>
<code class="linenos">13 </code>  <code class="p">((</code><code class="nv">id</code>
<code class="linenos">14 </code>    <code class="ss">:db-kind</code> <code class="ss">:key</code>
<code class="linenos">15 </code>    <code class="ss">:db-constraints</code> <code class="ss">:not-null</code>
<code class="linenos">16 </code>    <code class="ss">:type</code> <code class="nc">integer</code>
<code class="linenos">17 </code>    <code class="ss">:initarg</code> <code class="ss">:id</code><code class="p">)</code>
<code class="linenos">18 </code>   <code class="p">(</code><code class="nv">uri</code>
<code class="linenos">19 </code>    <code class="ss">:accessor</code> <code class="nv">uri</code>
<code class="linenos">20 </code>    <code class="ss">:type</code> <code class="p">(</code><code class="nb">string</code> <code class="mi">60</code><code class="p">)</code>
<code class="linenos">21 </code>    <code class="ss">:initarg</code> <code class="ss">:uri</code><code class="p">)</code>
<code class="linenos">22 </code>   <code class="p">(</code><code class="nv">title</code>
<code class="linenos">23 </code>    <code class="ss">:accessor</code> <code class="nv">title</code>
<code class="linenos">24 </code>    <code class="ss">:type</code> <code class="p">(</code><code class="nb">string</code> <code class="mi">90</code><code class="p">)</code>
<code class="linenos">25 </code>    <code class="ss">:initarg</code> <code class="ss">:title</code><code class="p">)</code>
<code class="linenos">26 </code>   <code class="p">(</code><code class="nv">text</code>
<code class="linenos">27 </code>    <code class="ss">:accessor</code> <code class="nv">text</code>
<code class="linenos">28 </code>    <code class="ss">:type</code> <code class="p">(</code><code class="nb">string</code> <code class="mi">500</code><code class="p">)</code>
<code class="linenos">29 </code>    <code class="ss">:nulls-ok</code> <code class="no">t</code>
<code class="linenos">30 </code>    <code class="ss">:initarg</code> <code class="ss">:text</code><code class="p">)))</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">create-articles-table</code> <code class="p">()</code>
<code class="linenos">33 </code>  <code class="p">(</code><code class="nv">clsql:create-view-from-class</code> <code class="ss">'articles</code><code class="p">))</code>
</pre></div>

</figure>

<p>In this repl listing, we create the database table “articles” using the function <strong>create-articles-table</strong> that we just defined:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">-&gt;</code>  <code class="n">src</code> <code class="n">git</code><code class="p">:(</code><code class="k">master</code><code class="p">)</code> <code class="n">sbcl</code>
<code class="linenos">2 </code><code class="p">(</code><code class="n">running</code> <code class="n">SBCL</code> <code class="n">from</code><code class="p">:</code> <code class="o">/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="n">sbcl</code><code class="p">)</code>
<code class="linenos">3 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"clsql_create_news_schema.lisp"</code><code class="p">)</code>
<code class="linenos">4 </code><code class="o">*</code> <code class="p">(</code><code class="n">create</code><code class="o">-</code><code class="n">articles</code><code class="o">-</code><code class="n">table</code><code class="p">)</code>
<code class="linenos">5 </code><code class="n">NOTICE</code><code class="p">:</code>  <code class="n">CREATE</code> <code class="n">TABLE</code> <code class="o">/</code> <code class="n">PRIMARY</code> <code class="n">KEY</code> <code class="n">will</code> <code class="n">create</code> <code class="n">implicit</code> <code class="n">index</code>
<code class="linenos">6 </code>         <code class="s2">"article_pk"</code> <code class="k">for</code> <code class="n">table</code> <code class="s2">"articles"</code>
<code class="linenos">7 </code><code class="n">T</code>
<code class="linenos">8 </code><code class="o">*</code>
</pre></div>

</figure>

<p>The following listing shows the file <strong>src/clsql_examples/clsql_write_to_news.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:clsql</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:clsql-postgresql</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="c1">;; Open connection to database and create CLOS class and database view</code>
<code class="linenos"> 5 </code><code class="c1">;; for table 'articles':</code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">load</code> <code class="s">"clsql_create_news_schema.lisp"</code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*a1*</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="nb">make-instance</code>
<code class="linenos">10 </code>    <code class="ss">'article</code>
<code class="linenos">11 </code>    <code class="ss">:uri</code> <code class="s">"http://test.com"</code>
<code class="linenos">12 </code>    <code class="ss">:title</code> <code class="s">"Trout Season is Open on Oak Creek"</code>
<code class="linenos">13 </code>    <code class="ss">:text</code> <code class="s">"State Fish and Game announced the opening of trout season"</code><code class="p">))</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="p">(</code><code class="nv">clsql:update-records-from-instance</code> <code class="vg">*a1*</code><code class="p">)</code>
<code class="linenos">16 </code><code class="c1">;; modify a slot value and update database:</code>
<code class="linenos">17 </code><code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">slot-value</code> <code class="vg">*a1*</code> <code class="ss">'title</code><code class="p">)</code> <code class="s">"Trout season is open on Oak Creek!!!"</code><code class="p">)</code>
<code class="linenos">18 </code><code class="p">(</code><code class="nv">clsql:update-records-from-instance</code> <code class="vg">*a1*</code><code class="p">)</code>
<code class="linenos">19 </code><code class="c1">;; warning: the last statement changes the "id" column in the table</code>
</pre></div>

</figure>

<p>You should load the file <strong>clsql_write_to_news.lisp</strong> one time in a repl to create the test data. The following listing shows file <strong>clsql_read_from_news.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:clsql</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:clsql-postgresql</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="c1">;; Open connection to database and create CLOS class and database view</code>
<code class="linenos"> 5 </code><code class="c1">;; for table 'articles':</code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">load</code> <code class="s">"clsql_create_news_schema.lisp"</code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">pp-article</code> <code class="p">(</code><code class="nv">article</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code>
<code class="linenos">10 </code>    <code class="s">"~%URI: ~S ~%Title: ~S ~%Text: ~S ~%"</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="nb">slot-value</code> <code class="nv">article</code> <code class="ss">'uri</code><code class="p">)</code>
<code class="linenos">12 </code>    <code class="p">(</code><code class="nb">slot-value</code> <code class="nv">article</code> <code class="ss">'title</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="nb">slot-value</code> <code class="nv">article</code> <code class="ss">'text</code><code class="p">)))</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">a</code> <code class="p">(</code><code class="nv">clsql:select</code> <code class="ss">'article</code><code class="p">))</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="nv">pp-article</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">a</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Loading the file <strong>clsql_read_from_news.lisp</strong> produces the following output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>URI: "http://test.com" 
<code class="linenos">2 </code>Title: "Trout season is open on Oak Creek!!!" 
<code class="linenos">3 </code>Text: "State Fish and Game announced the opening of trout season"
<code class="linenos">4 </code>
<code class="linenos">5 </code>URI: "http://example.com" 
<code class="linenos">6 </code>Title: "Longest day of year" 
<code class="linenos">7 </code>Text: "The summer solstice is on Friday."
</pre></div>

</figure>

<p>You can also embed SQL where clauses in queries:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">a</code> <code class="p">(</code><code class="nv">clsql:select</code> <code class="ss">'article</code> <code class="ss">:where</code> <code class="s">"title like '%season%'"</code><code class="p">))</code>
  <code class="p">(</code><code class="nv">pp-article</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">a</code><code class="p">)))</code>
</pre></div>

</figure>

<p>which produces this output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>URI: "http://test.com" 
<code class="linenos">2 </code>Title: "Trout season is open on Oak Creek!!!" 
<code class="linenos">3 </code>Text: "State Fish and Game announced the opening of
<code class="linenos">4 </code>       trout season" 
</pre></div>

</figure>

<p>In this example, I am using a SQL <strong>like</strong> expression to perform partial text matching.</p>

<h3 id="leanpub-auto-database-wrap-up">Database Wrap Up</h3>

<p>You learned the basics for accessing relational databases. When I am designing new systems for processing data I like to think of my Common Lisp code as being purely functional: my Lisp functions accept arguments that they do not modify and return results. I like to avoid side effects, that is changing global state. When I do have to handle mutable state (or data) I prefer storing mutable state in an external database. I use this same approach when I use the Haskell functional programming language.</p>


<h2 id="nosql_chapter">Using MongoDB, Solr NoSQL Data Stores</h2>

<p>Non-relational data stores are commonly used for applications that don’t need either full relational algebra or must scale.</p>

<p>The MongoDB example code is in the file <strong>src/loving_snippets/mongo_news.lisp</strong>. The Solr example code is in the subdirectories <strong>src/solr_examples</strong>.</p>

<p><strong>Note for the fifth edition:</strong> The Common Lisp cl-mongo library is now unsupported for versions of MongoDB later than 2.6 (released in 2016). You can install an <a href="https://www.mongodb.org/dl/osx">old version of MongoDB for macOS</a> or for <a href="https://www.mongodb.org/dl/linux">Linux</a>. I have left the MongoDB examples in this section but I can’t recommend that you use cl-mongo and MongoDB for any serious applications.</p>

<p>Brewer’s CAP theorem states that a distributed data storage system comprised of multiple nodes can be robust to two of three of the following guarantees: all nodes always have a <strong>C</strong>onsistent view of the state of data, general <strong>A</strong>vailablity of data if not all nodes are functioning, and <strong>P</strong>artition tolerance so clients can still communicate with the data storage system when parts of the system are unavailable because of network failures. The basic idea is that different applications have different requirements and sometimes it makes sense to reduce system cost or improve scalability by easing back on one of these requirements.</p>

<p>A good example is that some applications may not need transactions (the first guarantee) because it is not important if clients sometimes get data that is a few seconds out of date.</p>

<p>MongoDB allows you to choose consistency vs. availability vs. efficiency. </p>

<p>I cover the Solr indexing and search service (based on Lucene) both because a Solr indexed document store is a type of NoSQL data store and also because I believe that you will find Solr very useful for building systems, if you don’t already use it.</p>

<h3 id="leanpub-auto-mongodb">MongoDB</h3>

<p>The following discussion of MongoDB is based on just my personal experience, so I am not covering all use cases. I have used MongoDB for:</p>

<ul>
  <li>Small clusters of MongoDB nodes to analyze social media data, mostly text mining and sentiment analysis. In all cases for each application I ran MongoDB with one write master (i.e., I wrote data to this one node but did not use it for reads) and multiple read-only slave nodes. Each slave node would run on the same server that was usually performing a single bit of analytics.</li>
  <li>Multiple very large independent clusters for web advertising. Problems faced included trying to have some level of consistency across data centers. Replica sets were used within each data center.</li>
  <li>Running a single node MongoDB instance for low volume data collection and analytics.</li>
</ul>

<p>One of the advantages of MongoDB is that it is very “developer friendly” because it supports ad-hoc document schemas and interactive queries. I mentioned that MongoDB allows you to choose consistency vs. availability vs. efficiency. When you perform MongoDB writes you can specify some granularity of what constitutes a “successful write” by requiring that a write is performed at a specific number of nodes before the client gets acknowledgement that the write was successful.  This requirement adds overhead to each write operation and can cause writes to fail if some nodes are not available.</p>

<p>The <a href="http://docs.mongodb.org/manual/">MongoDB online documentation</a> is very good. You don’t have to read it in order to have fun playing with the following Common Lisp and MongoDB examples, but if you find that MongoDB is a good fit for your needs after playing with these examples then you should read the documentation. I usually install MongoDB myself but it is sometimes convenient to use a hosting service. There are several well regarded services and I have used <a href="https://www.mongohq.com/">MongoHQ</a>.</p>

<p>At this time there is no official Common Lisp support for accessing MongoDB but there is a useful project by Alfons Haffmans’ <a href="https://github.com/fons/cl-mongo">cl-mongo</a> that will allow us to write Common Lisp client applications and have access to most of the capabilities of MongoDB. </p>

<p>The file <strong>src/mongo_news.lisp</strong> contains the example code used in the next three sessions.</p>

<h4 id="leanpub-auto-adding-documents">Adding Documents</h4>

<p>The following repl listing shows the <strong>cl-mongo</strong> APIs for creating a new document, adding elements (attributes) to it, and inserting it in a MongoDB data store:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"cl-mongo"</code><code class="p">)</code>

<code class="p">(</code><code class="nv">cl-mongo:db.use</code> <code class="s">"news"</code><code class="p">)</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">add-article</code> <code class="p">(</code><code class="nv">uri</code> <code class="nv">title</code> <code class="nv">text</code><code class="p">)</code>
  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">doc</code> <code class="p">(</code><code class="nv">cl-mongo:make-document</code><code class="p">)))</code>
	<code class="p">(</code><code class="nv">cl-mongo:add-element</code> <code class="s">"uri"</code> <code class="nv">uri</code> <code class="nv">doc</code><code class="p">)</code>
	<code class="p">(</code><code class="nv">cl-mongo:add-element</code> <code class="s">"title"</code> <code class="nv">title</code> <code class="nv">doc</code><code class="p">)</code>
	<code class="p">(</code><code class="nv">cl-mongo:add-element</code> <code class="s">"text"</code> <code class="nv">text</code> <code class="nv">doc</code><code class="p">)</code>
	<code class="p">(</code><code class="nv">cl-mongo:db.insert</code> <code class="s">"article"</code> <code class="nv">doc</code><code class="p">)))</code>

<code class="c1">;; add a test document:</code>
<code class="p">(</code><code class="nv">add-article</code> <code class="s">"http://test.com"</code> <code class="s">"article title 1"</code> <code class="s">"article text 1"</code><code class="p">)</code>
</pre></div>

</figure>

<p>In this example, three string attributes were added to a new document before it was saved.</p>

<h4 id="leanpub-auto-fetching-documents-by-attribute">Fetching Documents by Attribute</h4>

<p>We will start by fetchng and pretty-printing all documents in the collection <strong>articles</strong> and fetching all articles a list of nested lists where the inner nested lists are document URI, title, and text:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">print-articles</code> <code class="p">()</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="nv">cl-mongo:pp</code> <code class="p">(</code><code class="nv">cl-mongo:iter</code> <code class="p">(</code><code class="nv">cl-mongo:db.find</code> <code class="s">"article"</code> <code class="ss">:all</code><code class="p">))))</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="c1">;; for each document, use the cl-mongo:get-element on</code>
<code class="linenos"> 5 </code><code class="c1">;; each element we want to save:</code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">article-results-&gt;lisp-data</code> <code class="p">(</code><code class="nv">mdata</code><code class="p">)</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">ret</code> <code class="o">'</code><code class="p">()))</code>
<code class="linenos"> 8 </code>    <code class="c1">;;(print (list "size of result=" (length mdata)))</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">a</code> <code class="nv">mdata</code><code class="p">)</code>
<code class="linenos">10 </code>      <code class="c1">;;(print a)</code>
<code class="linenos">11 </code>      <code class="p">(</code><code class="nb">push</code>
<code class="linenos">12 </code>        <code class="p">(</code><code class="nb">list</code>
<code class="linenos">13 </code>         <code class="p">(</code><code class="nv">cl-mongo:get-element</code> <code class="s">"uri"</code> <code class="nv">a</code><code class="p">)</code>
<code class="linenos">14 </code>         <code class="p">(</code><code class="nv">cl-mongo:get-element</code> <code class="s">"title"</code> <code class="nv">a</code><code class="p">)</code>
<code class="linenos">15 </code>         <code class="p">(</code><code class="nv">cl-mongo:get-element</code> <code class="s">"text"</code> <code class="nv">a</code><code class="p">))</code>
<code class="linenos">16 </code>        <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos">17 </code>    <code class="nv">ret</code><code class="p">))</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-articles</code> <code class="p">()</code>
<code class="linenos">20 </code>  <code class="p">(</code><code class="nv">article-results-&gt;lisp-data</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nv">cl-mongo:db.find</code> <code class="s">"article"</code> <code class="ss">:all</code><code class="p">))))</code>
</pre></div>

</figure>

<p>Output for these two functions looks like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">print</code><code class="o">-</code><code class="n">articles</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">{</code>
<code class="linenos"> 4 </code>  <code class="s">"_id"</code> <code class="o">-&gt;</code> <code class="n">objectid</code><code class="p">(</code><code class="mi">99778</code><code class="n">A792EBB4F76B82F75C6</code><code class="p">)</code>
<code class="linenos"> 5 </code>  <code class="s">"uri"</code>  <code class="o">-&gt;</code>  <code class="n">http</code><code class="o">://</code><code class="n">test</code><code class="p">.</code><code class="n">com</code><code class="o">/</code><code class="mi">3</code>
<code class="linenos"> 6 </code>  <code class="s">"title"</code>  <code class="o">-&gt;</code>  <code class="n">article</code> <code class="n">title</code> <code class="mi">3</code>
<code class="linenos"> 7 </code>  <code class="s">"text"</code>  <code class="o">-&gt;</code>  <code class="n">article</code> <code class="n">text</code> <code class="mi">3</code>
<code class="linenos"> 8 </code><code class="p">}</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">{</code>
<code class="linenos">11 </code>  <code class="s">"_id"</code> <code class="o">-&gt;</code> <code class="n">objectid</code><code class="p">(</code><code class="n">D47DEF3CFDB44DEA92FD9E56</code><code class="p">)</code>
<code class="linenos">12 </code>  <code class="s">"uri"</code>  <code class="o">-&gt;</code>  <code class="n">http</code><code class="o">://</code><code class="n">test</code><code class="p">.</code><code class="n">com</code><code class="o">/</code><code class="mi">2</code>
<code class="linenos">13 </code>  <code class="s">"title"</code>  <code class="o">-&gt;</code>  <code class="n">article</code> <code class="n">title</code> <code class="mi">2</code>
<code class="linenos">14 </code>  <code class="s">"text"</code>  <code class="o">-&gt;</code>  <code class="n">article</code> <code class="n">text</code> <code class="mi">2</code>
<code class="linenos">15 </code><code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="o">*</code> <code class="p">(</code><code class="n">get</code><code class="o">-</code><code class="n">articles</code><code class="p">)</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="p">((</code><code class="s">"http://test.com/2"</code> <code class="s">"article title 2"</code> <code class="s">"article text 2"</code><code class="p">)</code>
<code class="linenos">20 </code> <code class="p">(</code><code class="s">"http://test.com/3"</code> <code class="s">"article title 3"</code> <code class="s">"article text 3"</code><code class="p">))</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-fetching-documents-by-regular-expression-text-search">Fetching Documents by Regular Expression Text Search</h4>

<p>By reusing the function <strong>article-results-&gt;lisp-data</strong> defined in the last section, we can also search for JSON documents using regular expressions matching attribute values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; find documents where substring 'str' is in the title:</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">search-articles-title</code> <code class="p">(</code><code class="nv">str</code><code class="p">)</code>
<code class="linenos"> 3 </code>  <code class="p">(</code><code class="nv">article-results-&gt;lisp-data</code>
<code class="linenos"> 4 </code>    <code class="p">(</code><code class="nb">cadr</code>
<code class="linenos"> 5 </code>      <code class="p">(</code><code class="nv">cl-mongo:iter</code>
<code class="linenos"> 6 </code>       <code class="p">(</code><code class="nv">cl-mongo:db.find</code>
<code class="linenos"> 7 </code>         <code class="s">"article"</code>
<code class="linenos"> 8 </code>         <code class="p">(</code><code class="nv">cl-mongo:kv</code>
<code class="linenos"> 9 </code>            <code class="s">"title"</code>     <code class="nv">//</code> <code class="nv">TITLE</code> <code class="nv">ATTRIBUTE</code>
<code class="linenos">10 </code>            <code class="p">(</code><code class="nv">cl-mongo:kv</code> <code class="s">"$regex"</code> <code class="nv">str</code><code class="p">))</code> <code class="ss">:limit</code> <code class="mi">10</code><code class="p">)))))</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="c1">;; find documents where substring 'str' is in the text element:</code>
<code class="linenos">13 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">search-articles-text</code> <code class="p">(</code><code class="nv">str</code><code class="p">)</code> 
<code class="linenos">14 </code>  <code class="p">(</code><code class="nv">article-results-&gt;lisp-data</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nb">cadr</code>
<code class="linenos">16 </code>      <code class="p">(</code><code class="nv">cl-mongo:db.find</code>
<code class="linenos">17 </code>        <code class="s">"article"</code>
<code class="linenos">18 </code>        <code class="p">(</code><code class="nv">cl-mongo:kv</code>
<code class="linenos">19 </code>           <code class="s">"text"</code>        <code class="nv">//</code> <code class="nv">TEXT</code> <code class="nv">ATTRIBUTE</code>
<code class="linenos">20 </code>           <code class="p">(</code><code class="nv">cl-mongo:kv</code> <code class="s">"$regex"</code> <code class="nv">str</code><code class="p">))</code> <code class="ss">:limit</code> <code class="mi">10</code><code class="p">))))</code>
</pre></div>

</figure>

<p>I set the limit to return a maximum of ten documents. If you do not set the limit, this example code only returns one search result. The following repl listing shows the results from calling function <strong>search-articles-text</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>* (SEARCH-ARTICLES-TEXT "text")
<code class="linenos">2 </code>
<code class="linenos">3 </code>(("http://test.com/2" "article title 2" "article text 2")
<code class="linenos">4 </code> ("http://test.com/3" "article title 3" "article text 3"))
<code class="linenos">5 </code>* (SEARCH-ARTICLES-TEXT "3")
<code class="linenos">6 </code>
<code class="linenos">7 </code>(("http://test.com/3" "article title 3" "article text 3"))
</pre></div>

</figure>

<p>I find using MongoDB to be especially effective when experimenting with data and code. The schema free JSON document format, using interactive queries using the <a href="http://docs.mongodb.org/manual/mongo/">mongo shell</a>, and easy to use client libraries like <strong>clouchdb</strong> for Common Lisp will let you experiment with a lot of ideas in a short period of time. The following listing shows the use of the interactive <strong>mongo</strong> <strong>shell</strong>. The database <strong>news</strong> is the database used in the MongoDB examples in this chapter; you will notice that I also have other databases for other projects on my laptop:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">-&gt;</code>  <code class="n">src</code> <code class="n">git</code><code class="o">:</code><code class="p">(</code><code class="n">master</code><code class="p">)</code> <code class="n">mongo</code>
<code class="linenos"> 2 </code><code class="n">MongoDB</code> <code class="n">shell</code> <code class="n">version</code><code class="o">:</code> <code class="mf">2.4.5</code>
<code class="linenos"> 3 </code><code class="n">connecting</code> <code class="n">to</code><code class="o">:</code> <code class="n">test</code>
<code class="linenos"> 4 </code><code class="o">&gt;</code> <code class="n">show</code> <code class="n">dbs</code>
<code class="linenos"> 5 </code><code class="n">kbsportal</code>	<code class="mf">0.03125</code><code class="n">GB</code>
<code class="linenos"> 6 </code><code class="n">knowledgespace</code>	<code class="mf">0.03125</code><code class="n">GB</code>
<code class="linenos"> 7 </code><code class="kr">local</code>	<code class="p">(</code><code class="n">empty</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="n">mark_twitter</code>	<code class="mf">0.0625</code><code class="n">GB</code>
<code class="linenos"> 9 </code><code class="n">myfocus</code>	<code class="mf">0.03125</code><code class="n">GB</code>
<code class="linenos">10 </code><code class="n">news</code>	<code class="mf">0.03125</code><code class="n">GB</code>
<code class="linenos">11 </code><code class="n">nyt</code>	<code class="mf">0.125</code><code class="n">GB</code>
<code class="linenos">12 </code><code class="n">twitter</code>	<code class="mf">0.125</code><code class="n">GB</code>
<code class="linenos">13 </code><code class="o">&gt;</code> <code class="n">use</code> <code class="n">news</code>
<code class="linenos">14 </code><code class="n">switched</code> <code class="n">to</code> <code class="n">db</code> <code class="n">news</code>
<code class="linenos">15 </code><code class="o">&gt;</code> <code class="n">show</code> <code class="n">collections</code>
<code class="linenos">16 </code><code class="n">article</code>
<code class="linenos">17 </code><code class="n">system</code><code class="p">.</code><code class="n">indexes</code>
<code class="linenos">18 </code><code class="o">&gt;</code> <code class="n">db</code><code class="p">.</code><code class="n">article</code><code class="p">.</code><code class="n">find</code><code class="p">()</code>
<code class="linenos">19 </code><code class="p">{</code> <code class="s">"uri"</code> <code class="o">:</code> <code class="s">"http://test.com/3"</code><code class="p">,</code>
<code class="linenos">20 </code> <code class="s">"title"</code> <code class="o">:</code> <code class="s">"article title 3"</code><code class="p">,</code>
<code class="linenos">21 </code> <code class="s">"text"</code> <code class="o">:</code> <code class="s">"article text 3"</code><code class="p">,</code>
<code class="linenos">22 </code> <code class="s">"_id"</code> <code class="o">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s">"99778a792ebb4f76b82f75c6"</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos">23 </code><code class="p">{</code> <code class="s">"uri"</code> <code class="o">:</code> <code class="s">"http://test.com/2"</code><code class="p">,</code>
<code class="linenos">24 </code> <code class="s">"title"</code> <code class="o">:</code> <code class="s">"article title 2"</code><code class="p">,</code>
<code class="linenos">25 </code> <code class="s">"text"</code> <code class="o">:</code> <code class="s">"article text 2"</code><code class="p">,</code>
<code class="linenos">26 </code> <code class="s">"_id"</code> <code class="o">:</code> <code class="n">ObjectId</code><code class="p">(</code><code class="s">"d47def3cfdb44dea92fd9e56"</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos">27 </code><code class="o">&gt;</code> 
</pre></div>

</figure>

<p>Line 1 of this listing shows starting the mongo shell. Line 4 shows how to list all databases in the data store. In line 13 I select the database “news” to use. Line 15 prints out the names of all collections in the current database “news”. Line 18 prints out all documents in the “articles” collection. You can read the <a href="http://docs.mongodb.org/manual/mongo/">documentation for the mongo shell</a> for more options like selective queries, adding indices, etc.</p>

<p>When you run a MongoDB service on your laptop, also try the <a href="http://localhost:28017/">admin interface on http://localhost:28017/</a>.</p>

<h3 id="leanpub-auto-a-common-lisp-solr-client">A Common Lisp Solr Client</h3>

<p>The Lucene project is one of the most widely used Apache Foundation projects. Lucene is a flexible library for preprocessing and indexing text, and searching text. I have personally used Lucene on so many projects that it would be difficult to count them. The <a href="https://lucene.apache.org/solr/">Apache Solr Project</a> adds a network interface to the Lucene text indexer and search engine. Solr also adds other utility features to Lucene:</p>

<ul>
  <li>While Lucene is a library to embed in your programs, Solr is a complete system.</li>
  <li>Solr provides good defaults for preprocessing and indexing text and also provides rich support for managing structured data.</li>
  <li>Provides both XML and JSON APIs using HTTP and REST.</li>
  <li>Supports faceted search, geospatial search, and provides utilities for highlighting search terms in surrounding text of search results.</li>
  <li>If your system ever grows to a very large number of users, Solr supports scaling via replication.</li>
</ul>

<p>I hope that you will find the Common Lisp example Solr client code in the following sections helps you make Solr part of large systems that you write using Common Lisp.</p>

<h4 id="leanpub-auto-installing-solr">Installing Solr</h4>

<p>Download a <a href="https://lucene.apache.org/solr/downloads.html">binary Solr distribution</a> and un-tar or un-zip this Solr distribution, cd to the distribution directory, then cd to the example directory and run:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code> ~/solr/example&gt;  java -jar start.jar
</pre></div>

</figure>

<p>You can access the Solr Admin Web App at <a href="http://localhost:8983/solr/#/">http://localhost:8983/solr/#/</a>. This web app can be seen in the following screen shot:</p>


<div class="figure-wrapper center">
  <figure id="solr1" class="image" style="width: 468px">
    <img src="images/solr1.png" alt="Solr Admin Web App" style="width: 100%">
    <figcaption>Solr Admin Web App</figcaption>
  </figure>
</div>


<p>There is no data in the Solr example index yet, so following the Solr tutorial instructions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code> ~/&gt; cd ~/solr/example/exampledocs
<code class="linenos"> 2 </code> ~/solr/example/exampledocs&gt; java -jar post.jar *.xml
<code class="linenos"> 3 </code>SimplePostTool version 1.5
<code class="linenos"> 4 </code>Posting files to base url http://localhost:8983/solr/update
<code class="linenos"> 5 </code>        using content-type application/xml..
<code class="linenos"> 6 </code>POSTing file gb18030-example.xml
<code class="linenos"> 7 </code>POSTing file hd.xml
<code class="linenos"> 8 </code>POSTing file ipod_other.xml
<code class="linenos"> 9 </code>POSTing file ipod_video.xml
<code class="linenos">10 </code>POSTing file manufacturers.xml
<code class="linenos">11 </code>POSTing file mem.xml
<code class="linenos">12 </code>POSTing file money.xml
<code class="linenos">13 </code>POSTing file monitor.xml
<code class="linenos">14 </code>POSTing file monitor2.xml
<code class="linenos">15 </code>POSTing file mp500.xml
<code class="linenos">16 </code>POSTing file sd500.xml
<code class="linenos">17 </code>POSTing file solr.xml
<code class="linenos">18 </code>POSTing file utf8-example.xml
<code class="linenos">19 </code>POSTing file vidcard.xml
<code class="linenos">20 </code>14 files indexed.
<code class="linenos">21 </code>COMMITting Solr index changes
<code class="linenos">22 </code>           to http://localhost:8983/solr/update..
<code class="linenos">23 </code>Time spent: 0:00:00.480
</pre></div>

</figure>

<p>You will learn how to add documents to Solr directly in your Common Lisp programs in a later section.</p>

<p>Assuming that you have a fast Internet connection so that downloading Solr was quick, you have hopefully spent less than five or six minutes getting Solr installed and running with enough example search data for the Common Lisp client examples we will play with. Solr is a great tool for storing, indexing, and searching data. I recommend that you put off reading the official Solr documentation for now and instead work through the Common Lisp examples in the next two sections. Later, if you want to use Solr then you will need to carefully read the Solr documentation.</p>

<h4 id="leanpub-auto-solrs-rest-interface">Solr’s REST Interface</h4>

<p>The <a href="https://wiki.apache.org/solr/SolJSON">Solr REST Interface Documentation</a> documents how to perform search using HTTP GET requests. All we need to do is implement this in Common Lisp which you will see is easy.</p>

<p>Assuming that you have Solr running and the example data loaded, we can try searching for documents with, for example, the word “British” using the URL <a href="http://localhost:8983/solr/select?q=British">http://localhost:8983/solr/select?q=British</a>. This is a REST request URL and you can use utilities like <strong>curl</strong> or <strong>wget</strong> to fetch the XML data. I fetched the data in a web browser, as seen in the following screen shot of a Firefox web browser (I like the way Firefox formats and displays XML data):</p>


<div class="figure-wrapper center">
  <figure id="solr2" class="image" style="width: 337px">
    <img src="images/solr2.png" alt="Solr Search Results as XML Data" style="width: 100%">
    <figcaption>Solr Search Results as XML Data</figcaption>
  </figure>
</div>


<p>The attributes in the returned search results need some explanation. We indexed several example XML data files, one of which contained the following XML element that we just saw as a search result:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nt">&lt;doc&gt;</code>
<code class="linenos"> 2 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"id"</code><code class="nt">&gt;</code>GBP<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 3 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"name"</code><code class="nt">&gt;</code>One British Pound<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 4 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"manu"</code><code class="nt">&gt;</code>U.K.<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 5 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"manu_id_s"</code><code class="nt">&gt;</code>uk<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 6 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"cat"</code><code class="nt">&gt;</code>currency<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 7 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"features"</code><code class="nt">&gt;</code>Coins and notes<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 8 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"price_c"</code><code class="nt">&gt;</code>1,GBP<code class="nt">&lt;/field&gt;</code>
<code class="linenos"> 9 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"inStock"</code><code class="nt">&gt;</code>true<code class="nt">&lt;/field&gt;</code>
<code class="linenos">10 </code><code class="nt">&lt;/doc&gt;</code>
</pre></div>

</figure>

<p>So, the search result has the same attributes as the structured XML data that was added to the Solr search index. Solr’s capability for indexing structured data is a superset of just indexing plain text. If for example we were indexing news stories, then example input data might look like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nt">&lt;doc&gt;</code>
<code class="linenos">2 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"id"</code><code class="nt">&gt;</code>new_story_0001<code class="nt">&lt;/field&gt;</code>
<code class="linenos">3 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"title"</code><code class="nt">&gt;</code>Fishing Season Opens<code class="nt">&lt;/field&gt;</code>
<code class="linenos">4 </code>  <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"text"</code><code class="nt">&gt;</code>Fishing season opens on Friday in Oak Creek.<code class="nt">&lt;/field&gt;</code>
<code class="linenos">5 </code><code class="nt">&lt;/doc&gt;</code>
</pre></div>

</figure>

<p>With this example, a search result that returned this document as a result would return attributes <strong>id</strong>, <strong>title</strong>, and <strong>text</strong>, and the values of these three attributes.</p>

<p>By default the Solr web service returns XML data as seen in the last screen shot. For our examples, I prefer using JSON so we are going to always add a request parameter <strong>wt=json</strong> to all REST calls. The following screen shot shows the same data returned in JSON serialization format instead of XML format of a Chrome web browser (I like the way Chrome formats and displays JSON data with the JSONView Chrome Browser extension):</p>


<div class="figure-wrapper center">
  <figure id="solr3" class="image" style="width: 272px">
    <img src="images/solr3.png" alt="Solr Search Results as JSON Data" style="width: 100%">
    <figcaption>Solr Search Results as JSON Data</figcaption>
  </figure>
</div>


<p>You can read the full JSON REST Solr documentation later, but for our use here we will use the following search patterns:</p>

<ul>
  <li>http://localhost:8983/solr/select?q=British+One&amp;wt=json - search for documents with either of the words “British” or “one” in them. Note that in URIs that the “+” character is used to encode a space character. If you wanted a “+” character you would encode it with “%2B” and a space character is encoded as “%20”. The default Solr search option is an OR of the search terms, unlike, for example, Google Search.</li>
  <li>http://localhost:8983/solr/select?q=British+AND+one&amp;wt=json - search for documents that contain both of the words “British” and “one” in them. The search term in plain text is “British AND one”.</li>
</ul>

<h4 id="leanpub-auto-common-lisp-solr-client-for-search">Common Lisp Solr Client for Search</h4>

<p>As we sawearlier in <a href="#network_prog">Network Programming</a> it is fairly simple to use the <strong>drakma</strong> and <strong>cl-json</strong> Common Lisp libraries to call REST services that return JSON data. The function <strong>do-search</strong> defined in the next listing (all the Solr example code is in the file <strong>src/solr-client.lisp</strong>) constructs a query URI as we saw in the last section and uses the <strong>Drackma</strong> library to perform an HTTP GET operation and the <strong>cl-json library</strong> to parse the returned string containing JSON data into Lisp data structures: </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:drakma</code><code class="p">)</code>
<code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:cl-json</code><code class="p">)</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">do-search</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">terms</code><code class="p">)</code>
  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">query-string</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~{~A~^+AND+~}"</code> <code class="nv">terms</code><code class="p">)))</code>
   <code class="p">(</code><code class="nv">cl-json:decode-json-from-string</code>
     <code class="p">(</code><code class="nv">drakma:http-request</code>
       <code class="p">(</code><code class="nb">concatenate</code> 
        <code class="ss">'string</code>
        <code class="s">"http://localhost:8983/solr/select?q="</code>
        <code class="nv">query-string</code>
        <code class="s">"&amp;wt=json"</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>This example code does return the search results as Lisp list data; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="s s-Atom">do</code><code class="o">-</code><code class="s s-Atom">search</code> <code class="s2">"British"</code> <code class="s2">"one"</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">((</code><code class="s s-Atom">:</code><code class="nv">RESPONSE</code><code class="o">-</code><code class="nv">HEADER</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">STATUS</code> <code class="p">.</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:*</code><code class="nv">Q</code><code class="o">-</code><code class="nv">TIME</code> <code class="p">.</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PARAMS</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">Q</code> <code class="p">.</code> <code class="s2">"British+AND+one"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">WT</code> <code class="p">.</code> <code class="s2">"json"</code><code class="p">)))</code>
<code class="linenos"> 5 </code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">RESPONSE</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NUM</code><code class="o">-</code><code class="nv">FOUND</code> <code class="p">.</code> <code class="mi">6</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">START</code> <code class="p">.</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">DOCS</code>
<code class="linenos"> 7 </code>   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"GBP"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One British Pound"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"U.K."</code><code class="p">)</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"uk"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,GBP"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">11 </code>    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917628379136</code><code class="p">))</code>
<code class="linenos">12 </code>   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"USD"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One Dollar"</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Bank of America"</code><code class="p">)</code>
<code class="linenos">14 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"boa"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos">16 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,USD"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">17 </code>    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917624184832</code><code class="p">))</code>
<code class="linenos">18 </code>   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"EUR"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One Euro"</code><code class="p">)</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"European Union"</code><code class="p">)</code>
<code class="linenos">20 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"eu"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos">22 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,EUR"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">23 </code>    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917626281984</code><code class="p">))</code>
<code class="linenos">24 </code>   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"NOK"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One Krone"</code><code class="p">)</code>
<code class="linenos">25 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Bank of Norway"</code><code class="p">)</code>
<code class="linenos">26 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"nor"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code>
<code class="linenos">27 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos">28 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,NOK"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">29 </code>    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917631524864</code><code class="p">))</code>
<code class="linenos">30 </code>   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"0579B002"</code><code class="p">)</code>
<code class="linenos">31 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"Canon PIXMA MP500 All-In-One Photo Printer"</code><code class="p">)</code>
<code class="linenos">32 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Canon Inc."</code><code class="p">)</code>
<code class="linenos">33 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"canon"</code><code class="p">)</code>
<code class="linenos">34 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"electronics"</code> <code class="s2">"multifunction printer"</code>
<code class="linenos">35 </code>     <code class="s2">"printer"</code> <code class="s2">"scanner"</code> <code class="s2">"copier"</code><code class="p">)</code>
<code class="linenos">36 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Multifunction ink-jet color photo printer"</code>
<code class="linenos">37 </code>     <code class="s2">"Flatbed scanner, optical scan resolution of 1,200 x 2,400 dpi"</code>
<code class="linenos">38 </code>     <code class="s2">"2.5\" color LCD preview screen"</code> <code class="s2">"Duplex Copying"</code>
<code class="linenos">39 </code>     <code class="s2">"Printing speed up to 29ppm black, 19ppm color"</code> <code class="s2">"Hi-Speed USB"</code>
<code class="linenos">40 </code>     <code class="s2">"memory card: CompactFlash, Micro Drive, SmartMedia,</code>
<code class="linenos">41 </code><code class="s2">      Memory Stick, Memory Stick Pro, SD Card, and MultiMediaCard"</code><code class="p">)</code>
<code class="linenos">42 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">WEIGHT</code> <code class="p">.</code> <code class="mf">352.0</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code> <code class="p">.</code> <code class="mf">179.99</code><code class="p">)</code>
<code class="linenos">43 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"179.99,USD"</code><code class="p">)</code>
<code class="linenos">44 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">POPULARITY</code> <code class="p">.</code> <code class="mi">6</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">45 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">STORE</code> <code class="p">.</code> <code class="s2">"45.19214,-93.89941"</code><code class="p">)</code>
<code class="linenos">46 </code>    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917651447808</code><code class="p">))</code>
<code class="linenos">47 </code>   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"SOLR1000"</code><code class="p">)</code>
<code class="linenos">48 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"Solr, the Enterprise Search Server"</code><code class="p">)</code>
<code class="linenos">49 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Apache Software Foundation"</code><code class="p">)</code>
<code class="linenos">50 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"software"</code> <code class="s2">"search"</code><code class="p">)</code>
<code class="linenos">51 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Advanced Full-Text Search Capabilities using Lucene"</code>
<code class="linenos">52 </code>     <code class="s2">"Optimized for High Volume Web Traffic"</code>
<code class="linenos">53 </code>     <code class="s2">"Standards Based Open Interfaces - XML and HTTP"</code>
<code class="linenos">54 </code>     <code class="s2">"Comprehensive HTML Administration Interfaces"</code>
<code class="linenos">55 </code>     <code class="s2">"Scalability - Efficient Replication to other Solr Search Servers"</code>
<code class="linenos">56 </code>     <code class="s2">"Flexible and Adaptable with XML configuration and Schema"</code>
<code class="linenos">57 </code>     <code class="s2">"Good unicode support: hÃ©llo (hello with an accent over the e)"</code><code class="p">)</code>
<code class="linenos">58 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code> <code class="p">.</code> <code class="mf">0.0</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"0,USD"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">POPULARITY</code> <code class="p">.</code> <code class="mi">10</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">59 </code>    <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">INCUBATIONDATE</code><code class="s s-Atom">--</code><code class="nv">DT</code> <code class="p">.</code> <code class="s2">"2006-01-17T00:00:00Z"</code><code class="p">)</code>
<code class="linenos">60 </code>    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917671370752</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>I might modify the search function to return just the fetched documents as a list, discarding the returned Solr meta data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="nf">cdr</code> <code class="p">(</code><code class="nf">cadddr</code> <code class="p">(</code><code class="nf">cadr</code> <code class="p">(</code><code class="s s-Atom">do</code><code class="o">-</code><code class="s s-Atom">search</code> <code class="s2">"British"</code> <code class="s2">"one"</code><code class="p">))))</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"GBP"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One British Pound"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"U.K."</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"uk"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,GBP"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos"> 6 </code>  <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917628379136</code><code class="p">))</code>
<code class="linenos"> 7 </code> <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"USD"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One Dollar"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Bank of America"</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"boa"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,USD"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917624184832</code><code class="p">))</code>
<code class="linenos">11 </code> <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"EUR"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One Euro"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"European Union"</code><code class="p">)</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"eu"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,EUR"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">14 </code>  <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917626281984</code><code class="p">))</code>
<code class="linenos">15 </code> <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"NOK"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"One Krone"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Bank of Norway"</code><code class="p">)</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"nor"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"currency"</code><code class="p">)</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Coins and notes"</code><code class="p">)</code>
<code class="linenos">18 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"1,NOK"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">19 </code>  <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917631524864</code><code class="p">))</code>
<code class="linenos">20 </code> <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"0579B002"</code><code class="p">)</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"Canon PIXMA MP500 All-In-One Photo Printer"</code><code class="p">)</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Canon Inc."</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code><code class="s s-Atom">--</code><code class="nv">ID</code><code class="s s-Atom">--</code><code class="nv">S</code> <code class="p">.</code> <code class="s2">"canon"</code><code class="p">)</code>
<code class="linenos">23 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"electronics"</code> <code class="s2">"multifunction printer"</code> <code class="s2">"printer"</code>
<code class="linenos">24 </code>   <code class="s2">"scanner"</code> <code class="s2">"copier"</code><code class="p">)</code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Multifunction ink-jet color photo printer"</code>
<code class="linenos">26 </code>   <code class="s2">"Flatbed scanner, optical scan resolution of 1,200 x 2,400 dpi"</code>
<code class="linenos">27 </code>   <code class="s2">"2.5\" color LCD preview screen"</code> <code class="s2">"Duplex Copying"</code>
<code class="linenos">28 </code>   <code class="s2">"Printing speed up to 29ppm black, 19ppm color"</code> <code class="s2">"Hi-Speed USB"</code>
<code class="linenos">29 </code>   <code class="s2">"memory card: CompactFlash, Micro Drive, SmartMedia, Memory Stick,</code>
<code class="linenos">30 </code><code class="s2">    Memory Stick Pro, SD Card, and MultiMediaCard"</code><code class="p">)</code>
<code class="linenos">31 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">WEIGHT</code> <code class="p">.</code> <code class="mf">352.0</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code> <code class="p">.</code> <code class="mf">179.99</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"179.99,USD"</code><code class="p">)</code>
<code class="linenos">32 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">POPULARITY</code> <code class="p">.</code> <code class="mi">6</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">STORE</code> <code class="p">.</code> <code class="s2">"45.19214,-93.89941"</code><code class="p">)</code>
<code class="linenos">33 </code>  <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917651447808</code><code class="p">))</code>
<code class="linenos">34 </code> <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"SOLR1000"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NAME</code> <code class="p">.</code> <code class="s2">"Solr, the Enterprise Search Server"</code><code class="p">)</code>
<code class="linenos">35 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">MANU</code> <code class="p">.</code> <code class="s2">"Apache Software Foundation"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CAT</code> <code class="s2">"software"</code> <code class="s2">"search"</code><code class="p">)</code>
<code class="linenos">36 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">FEATURES</code> <code class="s2">"Advanced Full-Text Search Capabilities using Lucene"</code>
<code class="linenos">37 </code>   <code class="s2">"Optimized for High Volume Web Traffic"</code>
<code class="linenos">38 </code>   <code class="s2">"Standards Based Open Interfaces - XML and HTTP"</code>
<code class="linenos">39 </code>   <code class="s2">"Comprehensive HTML Administration Interfaces"</code>
<code class="linenos">40 </code>   <code class="s2">"Scalability - Efficient Replication to other Solr Search Servers"</code>
<code class="linenos">41 </code>   <code class="s2">"Flexible and Adaptable with XML configuration and Schema"</code>
<code class="linenos">42 </code>   <code class="s2">"Good unicode support: hÃ©llo (hello with an accent over the e)"</code><code class="p">)</code>
<code class="linenos">43 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code> <code class="p">.</code> <code class="mf">0.0</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PRICE</code><code class="s s-Atom">--</code><code class="nv">C</code> <code class="p">.</code> <code class="s2">"0,USD"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">POPULARITY</code> <code class="p">.</code> <code class="mi">10</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">IN</code><code class="o">-</code><code class="nv">STOCK</code> <code class="p">.</code> <code class="nv">T</code><code class="p">)</code>
<code class="linenos">44 </code>  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">INCUBATIONDATE</code><code class="s s-Atom">--</code><code class="nv">DT</code> <code class="p">.</code> <code class="s2">"2006-01-17T00:00:00Z"</code><code class="p">)</code>
<code class="linenos">45 </code>  <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440194917671370752</code><code class="p">)))</code>
</pre></div>

</figure>

<p>There are a few more important details if you want to add Solr search to your Common Lisp applications. When there are many search results you might want to fetch a limited number of results and then “page” through them. The following strings can be added to the end of a search query:</p>

<ul>
  <li>&amp;rows=2 this example returns a maximum of two “rows” or two query results.</li>
  <li>&amp;start=4 this example skips the first 4 available results</li>
</ul>

<p>A query that combines skipping results and limiting the number of returned results looks like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>http://localhost:8983/solr/select?q=British+One&amp;wt=json&amp;start=2&amp;rows=2
</pre></div>

</figure>

<h4 id="leanpub-auto-common-lisp-solr-client-for-adding-documents">Common Lisp Solr Client for Adding Documents</h4>

<p>In the last example we relied on adding example documents to the Solr search index using the directions for setting up a new Solr installation. In a real application, in addition to performing search requests for indexed documents you will need to add new documents from your Lisp applications. Using the Drakma we will see that it is very easy to add documents.</p>

<p>We need to construct a bit of XML containing new documents in the form:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nt">&lt;add&gt;</code>
<code class="linenos">2 </code>    <code class="nt">&lt;doc&gt;</code>
<code class="linenos">3 </code>        <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"id"</code><code class="nt">&gt;</code>123456<code class="nt">&lt;/field&gt;</code>
<code class="linenos">4 </code>        <code class="nt">&lt;field</code> <code class="na">name=</code><code class="s">"title"</code><code class="nt">&gt;</code>Fishing Season<code class="nt">&lt;/field&gt;</code>
<code class="linenos">5 </code>    <code class="nt">&lt;/doc&gt;</code>
<code class="linenos">6 </code><code class="nt">&lt;/add&gt;</code>
</pre></div>

</figure>

<p>You can specify whatever field names (attributes) that are required for your application. You can also pass multiple <strong>&lt;doc&gt;&lt;/doc&gt;</strong> elements in one add request. We will want to specify documents in a Lisp-like way: a list of cons values where each cons value is a field name and a value. For the last XML document example we would like an API that lets us just deal with Lisp data like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code> <code class="p">(</code><code class="nv">do-add</code> <code class="o">'</code><code class="p">((</code><code class="s">"id"</code> <code class="o">.</code> <code class="s">"12345"</code><code class="p">)</code>
           <code class="p">(</code><code class="s">"title"</code> <code class="o">.</code> <code class="s">"Fishing Season"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>One thing to note: the attribute names and values must be passed as strings. Other data types like integers, floating point numbers, structs, etc. will not work.</p>

<p>This is nicer than having to use XML, right? The first thing we need is a function to convert a list of cons values to XML. I could have used the XML Builder functionality in the <strong>cxml</strong> library that is available via Quicklisp, but for something this simple I just wrote it in pure Common Lisp with no other dependencies (also in the example file <strong>src/solr-client.lisp</strong>) :</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">keys-values-to-xml-string</code>  <code class="p">(</code><code class="nv">keys-values-list</code><code class="p">)</code>
<code class="linenos"> 2 </code> <code class="p">(</code><code class="nb">with-output-to-string</code> <code class="p">(</code><code class="nc">stream</code><code class="p">)</code>
<code class="linenos"> 3 </code>   <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="s">"&lt;add&gt;&lt;doc&gt;"</code><code class="p">)</code>
<code class="linenos"> 4 </code>   <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">kv</code> <code class="nv">keys-values-list</code><code class="p">)</code>
<code class="linenos"> 5 </code>     <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="s">"&lt;field name=\""</code><code class="p">)</code>
<code class="linenos"> 6 </code>     <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">kv</code><code class="p">))</code>
<code class="linenos"> 7 </code>     <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="s">"\"&gt;"</code><code class="p">)</code>
<code class="linenos"> 8 </code>     <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">kv</code><code class="p">))</code>
<code class="linenos"> 9 </code>     <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="s">"\"&lt;/field&gt;"</code><code class="p">))</code>
<code class="linenos">10 </code>   <code class="p">(</code><code class="nb">format</code> <code class="nc">stream</code> <code class="s">"&lt;/doc&gt;&lt;/add&gt;"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The macro <strong>with-output-to-string</strong> on line 2 of the listing is my favorite way to generate strings. Everything written to the variable <strong>stream</strong> inside the macro call is appended to a string; this string is the return value of the macro.</p>

<p>The following function adds documents to the Solr document input queue but does not actually index them:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">do-add</code> <code class="p">(</code><code class="nv">keys-values-list</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="nv">drakma:http-request</code>
<code class="linenos">3 </code>   <code class="s">"http://localhost:8983/solr/update"</code>
<code class="linenos">4 </code>   <code class="ss">:method</code> <code class="ss">:post</code>
<code class="linenos">5 </code>   <code class="ss">:content-type</code> <code class="s">"application/xml"</code>
<code class="linenos">6 </code>   <code class="ss">:content</code> <code class="p">(</code> <code class="nv">keys-values-to-xml-string</code>  <code class="nv">keys-values-list</code><code class="p">)))</code>
</pre></div>

</figure>

<p>You have noticed in line 3 that I am accessing a Solr server running on <strong>localhost</strong> and not a remote server. In an application using a remote Solr server you would need to modify this to reference your server; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>"http://solr.knowledgebooks.com:8983/solr/update"
</pre></div>

</figure>

<p>For efficiency Solr does not immediately add new documents to the index until you commit the additions. The following function should be called after you are done adding documents to actually add them to the index:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defun</code> <code class="nv">commit-adds</code> <code class="p">()</code>
  <code class="p">(</code><code class="nv">drakma:http-request</code>
   <code class="s">"http://localhost:8983/solr/update"</code>
   <code class="ss">:method</code> <code class="ss">:post</code>
   <code class="ss">:content-type</code> <code class="s">"application/xml"</code>
   <code class="ss">:content</code> <code class="s">"&lt;commit&gt;&lt;/commit&gt;"</code><code class="p">))</code>
</pre></div>

</figure>

<p>Notice that all we need is an empty element <strong>&lt;commit&gt;&lt;/commit&gt;</strong> that signals the Solr server that it should index all recently added documents. The following repl listing shows everything working together (I am assuming that the contents of the file <strong>src/solr-client.lisp</strong> has been loaded); not all of the output is shown in this listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">*</code> <code class="p">(</code><code class="s s-Atom">do</code><code class="o">-</code><code class="s s-Atom">add</code> <code class="err">'</code><code class="p">((</code><code class="s2">"id"</code> <code class="p">.</code> <code class="s2">"12345"</code><code class="p">)</code> <code class="p">(</code><code class="s2">"title"</code> <code class="p">.</code> <code class="s2">"Fishing Season"</code><code class="p">)))</code>

<code class="mi">200</code>
<code class="p">((</code><code class="s s-Atom">:</code><code class="nv">CONTENT</code><code class="o">-</code><code class="nv">TYPE</code> <code class="p">.</code> <code class="s2">"application/xml; charset=UTF-8"</code><code class="p">)</code>
 <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CONNECTION</code> <code class="p">.</code> <code class="s2">"close"</code><code class="p">))</code>
<code class="s s-Atom">#&lt;</code><code class="nv">PURI</code><code class="s s-Atom">:</code><code class="nv">URI</code> <code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="nn">localhost</code><code class="p">:</code><code class="mi">8983</code><code class="o">/</code><code class="s s-Atom">solr</code><code class="o">/</code><code class="s s-Atom">update</code><code class="o">&gt;</code>
<code class="s s-Atom">#&lt;</code><code class="nv">FLEXI</code><code class="o">-</code><code class="nv">STREAMS</code><code class="s s-Atom">:</code><code class="nv">FLEXI</code><code class="o">-</code><code class="nv">IO</code><code class="o">-</code><code class="nv">STREAM</code> <code class="p">{</code><code class="mi">1009193133</code><code class="p">}</code><code class="o">&gt;</code>
<code class="nv">T</code>
<code class="s2">"OK"</code>
<code class="o">*</code> <code class="p">(</code><code class="s s-Atom">commit</code><code class="o">-</code><code class="s s-Atom">adds</code><code class="p">)</code>

<code class="mi">200</code>
<code class="p">((</code><code class="s s-Atom">:</code><code class="nv">CONTENT</code><code class="o">-</code><code class="nv">TYPE</code> <code class="p">.</code> <code class="s2">"application/xml; charset=UTF-8"</code><code class="p">)</code>
 <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">CONNECTION</code> <code class="p">.</code> <code class="s2">"close"</code><code class="p">))</code>
<code class="s s-Atom">#&lt;</code><code class="nv">PURI</code><code class="s s-Atom">:</code><code class="nv">URI</code> <code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="nn">localhost</code><code class="p">:</code><code class="mi">8983</code><code class="o">/</code><code class="s s-Atom">solr</code><code class="o">/</code><code class="s s-Atom">update</code><code class="o">&gt;</code>
<code class="s s-Atom">#&lt;</code><code class="nv">FLEXI</code><code class="o">-</code><code class="nv">STREAMS</code><code class="s s-Atom">:</code><code class="nv">FLEXI</code><code class="o">-</code><code class="nv">IO</code><code class="o">-</code><code class="nv">STREAM</code> <code class="p">{</code><code class="mi">10031</code><code class="nv">F20B3</code><code class="p">}</code><code class="o">&gt;</code>
<code class="nv">T</code>
<code class="s2">"OK"</code>
<code class="o">*</code> <code class="p">(</code><code class="s s-Atom">do</code><code class="o">-</code><code class="s s-Atom">search</code> <code class="s2">"fishing"</code><code class="p">)</code>

<code class="p">((</code><code class="s s-Atom">:</code><code class="nv">RESPONSE</code><code class="o">-</code><code class="nv">HEADER</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">STATUS</code> <code class="p">.</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:*</code><code class="nv">Q</code><code class="o">-</code><code class="nv">TIME</code> <code class="p">.</code> <code class="mi">2</code><code class="p">)</code>
  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">PARAMS</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">Q</code> <code class="p">.</code> <code class="s2">"fishing"</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">WT</code> <code class="p">.</code> <code class="s2">"json"</code><code class="p">)))</code>
 <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">RESPONSE</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">NUM</code><code class="o">-</code><code class="nv">FOUND</code> <code class="p">.</code> <code class="mi">1</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">START</code> <code class="p">.</code> <code class="mi">0</code><code class="p">)</code>
  <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">DOCS</code>
   <code class="p">((</code><code class="s s-Atom">:</code><code class="nv">ID</code> <code class="p">.</code> <code class="s2">"12345\""</code><code class="p">)</code> <code class="p">(</code><code class="s s-Atom">:</code><code class="nv">TITLE</code> <code class="s2">"Fishing Season\""</code><code class="p">)</code>
    <code class="p">(:-</code><code class="o">-</code><code class="nv">VERSION</code><code class="s s-Atom">--</code> <code class="p">.</code> <code class="mi">1440293991717273600</code><code class="p">)))))</code>
<code class="o">*</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-common-lisp-solr-client-wrap-up">Common Lisp Solr Client Wrap Up</h4>

<p>Solr has a lot of useful features that we have not used here like supporting faceted search (drilling down in previous search results), geolocation search, and looking up indexed documents by attribute. In the examples I have shown you, all text fields are indexed but Solr optionally allows you fine control over indexing, spelling correction, word stemming, etc.</p>

<p>Solr is a very capable tool for storing, indexing, and searching data. I have seen Solr used effectively on projects as a replacement for a relational database or other NoSQL data stores like CouchDB or MongoDB. There is a higher overhead for modifying or removing data in Solr so for applications that involve frequent modifications to stored data Solr might not be a good choice.</p>

<h3 id="leanpub-auto-nosql-wrapup">NoSQL Wrapup</h3>

<p>There are more convenient languages than Common Lisp to use for accessing MongoDB. To be honest, my favorites are Ruby and Clojure. That said, for applications where the advantages of Common Lisp are compelling, it is good to know that your Common Lisp applications can play nicely with MongoDB.</p>

<p>I am a polyglot programmer: I like to use the best programming language for any specific job. When we design and build systems with more than one programming language, there are several options to share data:</p>

<ul>
  <li>Use foreign function interfaces to call one language from another from inside one process.</li>
  <li>Use a service architecture and send requests using REST or SOAP.</li>
  <li>Use shared data stores, like relational databases, MongoDB, CouchDB and Solr.</li>
</ul>

<p>Hopefully this chapter and the last chapter will provide most of what you need for the last option.</p>



<h2 id="nlp_chapter">Natural Language Processing</h2>

<p>Natural Language Processing (NLP) is the automated processing of natural language text with several goals:</p>

<ul>
  <li>Determine the parts of speech (POS tagging) of words based on the surrounding words.</li>
  <li>Detect if two text documents are similar.</li>
  <li>Categorize text (e.g., is it about the economy, politics, sports, etc.)</li>
  <li>Summarize text</li>
  <li>Determine the sentiment of text</li>
  <li>Detect names (e.g., place names, people’s names, product names, etc.)</li>
</ul>

<p>We will use a library that I wrote that performs POS tagging, categorization (classification), summarization, and detects proper names.</p>

<p>My example code for this chapter is contained in separate Quicklisp projects located in the subdirectories:</p>

<ul>
  <li>
<strong>src/fasttag</strong>: performs part of speech tagging and tokenizes text</li>
  <li>
<strong>src/categorize_summarize</strong>: performs categorization (e.g., detects the topic of text is news, politics, economy, etc.) and text summarization</li>
  <li>
<strong>src/kbnlp</strong>: the top level APIs for my pure Common Lisp natural language processing (NLP) code. In later chapters we will take a different approach by using Python deep learning models for NLP that we call as a web service. I use both approaches in my own work.</li>
</ul>

<p>I worked on this Lisp code, and also similar code in Java, from about 2001 to 2011, and again in 2019 for my application for generating knowledge graph data automatically (this is an example in a later chapter). I am going to begin the next section with a quick explanation of how to run the example code. If you find the examples interesting then you can also read the rest of this chapter where I explain how the code works.</p>

<p>The approach that I used in my library for categorization (word counts) is now dated. I recommend that you consider taking Andrew Ng’s course on Machine Learning on the free online Coursera system and then take one of the Coursera NLP classes for a more modern treatment of NLP.</p>

<p>In addition to the code for my library you might also find the linguistic data in <strong>src/linguistic_data</strong> useful.</p>

<h3 id="leanpub-auto-loading-and-running-the-nlp-library">Loading and Running the NLP Library</h3>

<p>I repackaged the NLP example code into one long file. The code used to be split over 18 source files. The code should be loaded from the <strong>src/kbnlp</strong> directory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">%</code>  <code class="n">loving</code><code class="o">-</code><code class="n">common</code><code class="o">-</code><code class="n">lisp</code> <code class="n">git</code><code class="p">:(</code><code class="k">master</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">cd</code> <code class="n">src</code><code class="o">/</code><code class="n">kbnlp</code>
<code class="linenos">2 </code><code class="o">%</code>  <code class="n">src</code><code class="o">/</code><code class="n">kbnlp</code> <code class="n">git</code><code class="p">:(</code><code class="k">master</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">sbcl</code>
<code class="linenos">3 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"kbnlp"</code><code class="p">)</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="s2">"Startng to load data...."</code> 
<code class="linenos">6 </code><code class="s2">"....done loading data."</code> 
<code class="linenos">7 </code><code class="o">*</code>
</pre></div>

</figure>

<p>This also loads the projects in <strong>src/fasttag</strong> and <strong>src/categorize_summarize</strong>.</p>

<p>Unfortunately, it takes about a minute using SBCL to load the required linguistic data so I recommend creating a Lisp image that can be reloaded to avoid the time required to load the data: </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">*</code><code class="w"> </code><code class="p">(</code><code class="n">sb</code><code class="o">-</code><code class="n">ext</code><code class="p">:</code><code class="nb">save</code><code class="o">-</code><code class="n">lisp</code><code class="o">-</code><code class="n">and</code><code class="o">-</code><code class="n">die</code><code class="w"> </code><code class="s">"nlp-image"</code><code class="w"> </code><code class="p">:</code><code class="n">purify</code><code class="w"> </code><code class="n">t</code><code class="p">)</code><code class="w"></code>
<code class="linenos">2 </code><code class="p">[</code><code class="n">undoing</code><code class="w"> </code><code class="n">binding</code><code class="w"> </code><code class="nb">stack</code><code class="w"> </code><code class="n">and</code><code class="w"> </code><code class="n">other</code><code class="w"> </code><code class="n">enclosing</code><code class="w"> </code><code class="n">state</code><code class="k">...</code><code class="c"> done]</code><code class="w"></code>
<code class="linenos">3 </code><code class="p">[</code><code class="n">saving</code><code class="w"> </code><code class="n">current</code><code class="w"> </code><code class="n">Lisp</code><code class="w"> </code><code class="nb">image</code><code class="w"> </code><code class="n">into</code><code class="w"> </code><code class="n">nlp</code><code class="o">-</code><code class="nb">image</code><code class="p">:</code><code class="w"></code>
<code class="linenos">4 </code><code class="n">writing</code><code class="w"> </code><code class="s">5280</code><code class="w"> </code><code class="s">bytes</code><code class="w"> </code><code class="s">from</code><code class="w"> </code><code class="s">the</code><code class="w"> </code><code class="s">read-only</code><code class="w"> </code><code class="s">space</code><code class="w"> </code><code class="s">at</code><code class="w"> </code><code class="s">0x0x20000000</code><code class="w"></code>
<code class="linenos">5 </code><code class="n">writing</code><code class="w"> </code><code class="s">3088</code><code class="w"> </code><code class="s">bytes</code><code class="w"> </code><code class="s">from</code><code class="w"> </code><code class="s">the</code><code class="w"> </code><code class="s">static</code><code class="w"> </code><code class="s">space</code><code class="w"> </code><code class="s">at</code><code class="w"> </code><code class="s">0x0x20100000</code><code class="w"></code>
<code class="linenos">6 </code><code class="n">writing</code><code class="w"> </code><code class="s">80052224</code><code class="w"> </code><code class="s">bytes</code><code class="w"> </code><code class="s">from</code><code class="w"> </code><code class="s">the</code><code class="w"> </code><code class="s">dynamic</code><code class="w"> </code><code class="s">space</code><code class="w"> </code><code class="s">at</code><code class="w"> </code><code class="s">0x0x1000000000</code><code class="w"></code>
<code class="linenos">7 </code><code class="n">done</code><code class="p">]</code><code class="w"></code>
<code class="linenos">8 </code><code class="c">%  src git:(master) &gt; ls -lh nlp-image</code><code class="w"></code>
<code class="linenos">9 </code><code class="o">-</code><code class="n">rw</code><code class="o">-</code><code class="n">r</code><code class="o">--</code><code class="n">r</code><code class="o">--</code><code class="w">  </code><code class="mi">1</code><code class="w"> </code><code class="n">markw</code><code class="w">  </code><code class="n">staff</code><code class="w">    </code>76<code class="n">M</code><code class="w"> </code><code class="n">Jul</code><code class="w"> </code><code class="mi">13</code><code class="w"> </code><code class="mi">12</code><code class="p">:</code><code class="mi">49</code><code class="w"> </code><code class="n">nlp</code><code class="o">-</code><code class="nb">image</code><code class="w"></code>
</pre></div>

</figure>

<p>In line 1 in this repl listing, I use the SBCL built-in function <strong>save-lisp-and-die</strong> to create the Lisp image file. Using <strong>save-lisp-and-die</strong> is a great technique to use whenever it takes a while to set up your work environment. Saving a Lisp image for use the next time you work on a Common Lisp project is reminiscent of working in Smalltalk where your work is saved between sessions in an image file.</p>

<p>Note: I often use Clozure-CL (CCL) instead of SBCL for developing my NLP libraries because CCL loads my data files much faster than SBCL.</p>

<p>You can now start SBCL with the NLP library and data preloaded using the Lisp image that you just created:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">%</code>  <code class="n">src</code> <code class="n">git</code><code class="p">:(</code><code class="k">master</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">sbcl</code> <code class="o">--</code><code class="n">core</code> <code class="n">nlp</code><code class="o">-</code><code class="n">image</code> 
<code class="linenos"> 2 </code><code class="o">*</code> <code class="p">(</code><code class="ow">in</code><code class="o">-</code><code class="n">package</code> <code class="p">:</code><code class="n">kbnlp</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="c1">#&lt;PACKAGE "KBNLP"&gt;</code>
<code class="linenos"> 5 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code>
<code class="linenos"> 6 </code>   <code class="o">*</code><code class="n">x</code><code class="o">*</code>
<code class="linenos"> 7 </code>   <code class="p">(</code><code class="n">make</code><code class="o">-</code><code class="n">text</code><code class="o">-</code><code class="n">object</code>
<code class="linenos"> 8 </code>     <code class="s2">"President Bob Smith talked to Congress about the economy and taxes"</code><code class="p">))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="o">*</code><code class="n">X</code><code class="o">*</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="o">*</code> <code class="o">*</code><code class="n">X</code><code class="o">*</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="c1">#S(TEXT</code>
<code class="linenos">15 </code>   <code class="p">:</code><code class="n">URL</code> <code class="s2">""</code>
<code class="linenos">16 </code>   <code class="p">:</code><code class="n">TITLE</code> <code class="s2">""</code>
<code class="linenos">17 </code>   <code class="p">:</code><code class="n">SUMMARY</code> <code class="s2">"&lt;no summary&gt;"</code>
<code class="linenos">18 </code>   <code class="p">:</code><code class="n">CATEGORY</code><code class="o">-</code><code class="n">TAGS</code> <code class="p">((</code><code class="s2">"news_politics.txt"</code> <code class="mf">0.01648</code><code class="p">)</code>
<code class="linenos">19 </code>                   <code class="p">(</code><code class="s2">"news_economy.txt"</code> <code class="mf">0.01601</code><code class="p">))</code>
<code class="linenos">20 </code>   <code class="p">:</code><code class="n">KEY</code><code class="o">-</code><code class="n">WORDS</code> <code class="n">NIL</code>
<code class="linenos">21 </code>   <code class="p">:</code><code class="n">KEY</code><code class="o">-</code><code class="n">PHRASES</code> <code class="n">NIL</code>
<code class="linenos">22 </code>   <code class="p">:</code><code class="n">HUMAN</code><code class="o">-</code><code class="n">NAMES</code> <code class="p">(</code><code class="s2">"President Bob Smith"</code><code class="p">)</code>
<code class="linenos">23 </code>   <code class="p">:</code><code class="n">PLACE</code><code class="o">-</code><code class="n">NAMES</code> <code class="n">NIL</code>
<code class="linenos">24 </code>   <code class="p">:</code><code class="n">TEXT</code> <code class="c1">#("President" "Bob" "Smith" "talked" "to" "Congress" "about" "the"</code>
<code class="linenos">25 </code>           <code class="s2">"economy"</code> <code class="s2">"and"</code> <code class="s2">"taxes"</code><code class="p">)</code>
<code class="linenos">26 </code>   <code class="p">:</code><code class="n">TAGS</code> <code class="c1">#("NNP" "NNP" "NNP" "VBD" "TO" "NNP" "IN" "DT" "NN" "CC" "NNS")</code>
<code class="linenos">27 </code>   <code class="p">:</code><code class="n">STEMS</code> <code class="c1">#("presid" "bob" "smith" "talk" "to" "congress" "about" "the"</code>
<code class="linenos">28 </code>            <code class="s2">"economi"</code> <code class="s2">"and"</code> <code class="s2">"tax"</code><code class="p">))</code>
<code class="linenos">29 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>At the end of the file <strong>src/knowledgebooks_nlp.lisp</strong> in comments is some test code that processes much more text so that a summary is also generated; here is a bit of the output you will see if you load the test code into your repl:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="ss">(</code>:<code class="nv">SUMMARY</code>
<code class="linenos"> 2 </code>  <code class="s2">"</code><code class="s">Often those amendments are an effort to change government policy</code>
<code class="linenos"> 3 </code>   <code class="nv">by</code> <code class="nv">adding</code> <code class="nv">or</code> <code class="nv">subtracting</code> <code class="nv">money</code> <code class="k">for</code> <code class="nv">carrying</code> <code class="nv">it</code> <code class="nv">out</code>. <code class="nv">The</code> <code class="nv">initial</code>
<code class="linenos"> 4 </code>   <code class="nv">surge</code> <code class="nv">in</code> <code class="nv">foreclosures</code> <code class="nv">in</code> <code class="mi">2007</code> <code class="nv">and</code> <code class="mi">2008</code> <code class="nv">was</code> <code class="nv">tied</code> <code class="nv">to</code> <code class="nv">subprime</code>
<code class="linenos"> 5 </code>   <code class="nv">mortgages</code> <code class="nv">issued</code> <code class="nv">during</code> <code class="nv">the</code> <code class="nv">housing</code> <code class="nv">boom</code> <code class="nv">to</code> <code class="nv">people</code> <code class="nv">with</code> <code class="nv">shaky</code>
<code class="linenos"> 6 </code>   <code class="nv">credit</code>. <code class="mi">2</code> <code class="nv">trillion</code> <code class="nv">in</code> <code class="nv">annual</code> <code class="nv">appropriations</code> <code class="nv">bills</code> <code class="k">for</code> <code class="nv">funding</code>
<code class="linenos"> 7 </code>   <code class="nv">most</code> <code class="nv">government</code> <code class="nv">programs</code> — <code class="nv">usually</code> <code class="nv">low</code> <code class="nv">profile</code> <code class="nv">legislation</code> <code class="nv">that</code>
<code class="linenos"> 8 </code>   <code class="nv">typically</code> <code class="nv">dominates</code> <code class="nv">the</code> <code class="nv">work</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">House</code> <code class="nv">in</code> <code class="nv">June</code> <code class="nv">and</code> <code class="nv">July</code>.
<code class="linenos"> 9 </code>   <code class="nv">Bill</code> <code class="nv">Clinton</code> <code class="nv">said</code> <code class="nv">that</code> <code class="nv">banking</code> <code class="nv">in</code> <code class="nv">Europe</code> <code class="nv">is</code> <code class="nv">a</code> <code class="nv">good</code> <code class="nv">business</code>.
<code class="linenos">10 </code>   <code class="nv">These</code> <code class="nv">days</code> <code class="nv">homeowners</code> <code class="nv">who</code> <code class="nv">got</code> <code class="nv">fixed</code> <code class="nv">rate</code> <code class="nv">prime</code> <code class="nv">mortgages</code> <code class="nv">because</code>
<code class="linenos">11 </code>   <code class="nv">they</code> <code class="nv">had</code> <code class="nv">good</code> <code class="nv">credit</code> <code class="nv">cannot</code> <code class="nv">make</code> <code class="nv">their</code> <code class="nv">payments</code> <code class="nv">because</code> <code class="nv">they</code> <code class="nv">are</code>
<code class="linenos">12 </code>   <code class="nv">out</code> <code class="nv">of</code> <code class="nv">work</code>. <code class="nv">The</code> <code class="nv">question</code> <code class="nv">is</code> <code class="nv">whether</code> <code class="nv">or</code> <code class="nv">not</code> <code class="nv">the</code> <code class="nv">US</code> <code class="nv">dollar</code> <code class="nv">remains</code>
<code class="linenos">13 </code>   <code class="nv">the</code> <code class="nv">world</code> <code class="nv">s</code> <code class="nv">reserve</code> <code class="nv">currency</code> <code class="k">if</code> <code class="nv">not</code> <code class="nv">the</code> <code class="nv">US</code> <code class="nv">economy</code> <code class="nv">will</code> <code class="nv">face</code>
<code class="linenos">14 </code>   <code class="nv">a</code> <code class="nv">depression</code>.<code class="s2">"</code>
<code class="linenos">15 </code><code class="nl">:CATEGORY</code><code class="o">-</code><code class="nv">TAGS</code> <code class="ss">((</code><code class="s2">"</code><code class="s">news_politics.txt</code><code class="s2">"</code> <code class="mi">0</code>.<code class="mi">38268</code><code class="ss">)</code>
<code class="linenos">16 </code>                <code class="ss">(</code><code class="s2">"</code><code class="s">news_economy.txt</code><code class="s2">"</code> <code class="mi">0</code>.<code class="mi">31182</code><code class="ss">)</code>
<code class="linenos">17 </code>                <code class="ss">(</code><code class="s2">"</code><code class="s">news_war.txt</code><code class="s2">"</code> <code class="mi">0</code>.<code class="mi">20174</code><code class="ss">))</code>
<code class="linenos">18 </code><code class="nl">:HUMAN</code><code class="o">-</code><code class="nv">NAMES</code> <code class="ss">(</code><code class="s2">"</code><code class="s">President Bill Clinton</code><code class="s2">"</code><code class="ss">)</code>
<code class="linenos">19 </code><code class="nl">:PLACE</code><code class="o">-</code><code class="nv">NAMES</code> <code class="ss">(</code><code class="s2">"</code><code class="s">Florida</code><code class="s2">"</code><code class="ss">))</code>
</pre></div>

</figure>

<p>The top-level function <strong>make-text-object</strong> takes one required argument that can be either a string containing text or an array of strings where each string is a word or punctuation. Function <strong>make-text-object</strong> has two optional keyword parameters: the URL where the text was found and a title.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">make-text-object</code> <code class="p">(</code><code class="nv">words</code> <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">url</code> <code class="s">""</code><code class="p">)</code> <code class="p">(</code><code class="nv">title</code> <code class="s">""</code><code class="p">))</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">typep</code> <code class="nv">words</code> <code class="ss">'string</code><code class="p">)</code> <code class="p">(</code><code class="k">setq</code> <code class="nv">words</code> <code class="p">(</code><code class="nv">words-from-string</code> <code class="nv">words</code><code class="p">)))</code>
<code class="linenos"> 3 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">txt-obj</code> <code class="p">(</code><code class="nv">make-text</code> <code class="ss">:text</code> <code class="nv">words</code> <code class="ss">:url</code> <code class="nv">url</code> <code class="ss">:title</code> <code class="nv">title</code><code class="p">)))</code>
<code class="linenos"> 4 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">text-tags</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nv">part-of-speech-tagger</code> <code class="nv">words</code><code class="p">))</code>
<code class="linenos"> 5 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">text-stems</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nv">stem-text</code> <code class="nv">txt-obj</code><code class="p">))</code>
<code class="linenos"> 6 </code>    <code class="c1">;; note: we must find human and place names before calling</code>
<code class="linenos"> 7 </code>    <code class="c1">;; pronoun-resolution:</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">names-places</code> <code class="p">(</code><code class="nv">find-names-places</code> <code class="nv">txt-obj</code><code class="p">)))</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">text-human-names</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">names-places</code><code class="p">))</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">text-place-names</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">names-places</code><code class="p">)))</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">text-category-tags</code> <code class="nv">txt-obj</code><code class="p">)</code>
<code class="linenos">12 </code>          <code class="p">(</code><code class="nb">mapcar</code>
<code class="linenos">13 </code>            <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">14 </code>                <code class="p">(</code><code class="nb">list</code>
<code class="linenos">15 </code>                  <code class="p">(</code><code class="nb">car</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">16 </code>                  <code class="p">(</code><code class="nb">/</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">x</code><code class="p">)</code> <code class="mf">1000000.0</code><code class="p">)))</code>
<code class="linenos">17 </code>            <code class="p">(</code><code class="nv">get-word-list-category</code> <code class="p">(</code><code class="nv">text-text</code> <code class="nv">txt-obj</code><code class="p">))))</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">text-summary</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nv">summarize</code> <code class="nv">txt-obj</code><code class="p">))</code>
<code class="linenos">19 </code>    <code class="nv">txt-obj</code><code class="p">))</code>
</pre></div>

</figure>

<p>In line 2, we check if this function was called with a string containing text in which case the function <strong>words-from-string</strong> is used to tokenize the text into an array of string tokens. Line two defines the local variable <strong>txt-obj</strong> with the value of a new text object with only three slots (attributes) defined: <strong>text</strong>, <strong>url</strong>, and <strong>title</strong>. Line 4 sets the slot <strong>text-tags</strong> to the part of speech tokens using the function <strong>part-of-speech-tagger</strong>. We use the function <strong>find-names-places</strong> in line 8 to get person and place names and store these values in the text object. In lines 11 through 17 we use the function <strong>get-word-list-category</strong> to set the categories in the text object. In line 18 we similarly use the function <strong>summarize</strong> to calculate a summary of the text and also store it in the text object. We will discuss these NLP helper functions throughout the rest of this chapter.</p>

<p>The function <strong>make-text-object</strong> returns a struct that is defined as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defstruct</code> <code class="nv">text</code>
  <code class="nv">url</code>
  <code class="nv">title</code>
  <code class="nv">summary</code>
  <code class="nv">category-tags</code>
  <code class="nv">key-words</code>
  <code class="nv">key-phrases</code>
  <code class="nv">human-names</code>
  <code class="nv">place-names</code>
  <code class="nv">text</code>
  <code class="nv">tags</code>
  <code class="nv">stems</code><code class="p">)</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-part-of-speech-tagging">Part of Speech Tagging</h3>

<p>This tagger is the Common Lisp implementation of my FastTag open source project. I based this project on Eric Brill’s PhD thesis (1995). He used machine learning on annotated text to learn tagging rules. I used a subset of the tagging rules that he generated that were most often used when he tested his tagger. I hand coded his rules in Lisp (and Ruby, Java, and Pascal). My tagger is less accurate, but it is fast - thus the name FastTag.</p>

<p>If you just need part of speech tagging (and not summarization, categorization, and top level APIs used in the last section) you can load:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"fasttag"</code><code class="p">)</code>
</pre></div>

</figure>

<p>You can find the tagger implementation in the function <strong>part-of-speech-tagger</strong>. We already saw sample output from the tagger in the last section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>:TEXT #("President" "Bob" "Smith" "talked" "to" "Congress" "about" "the"
<code class="linenos">2 </code>        "economy" "and" "taxes")
<code class="linenos">3 </code>:TAGS #("NNP" "NNP" "NNP" "VBD" "TO" "NNP" "IN" "DT" "NN" "CC" "NNS")
</pre></div>

</figure>

<p>The following table shows the meanings of the tags and a few example words:</p>

<table>
  <thead>
    <tr>
      <th>Tag</th>
      <th>Definition</th>
      <th>Example words</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CC</td>
      <td>Coord Conjuncn</td>
      <td>and, but, or</td>
    </tr>
    <tr>
      <td>NN</td>
      <td>Noun, sing. or mass</td>
      <td>dog</td>
    </tr>
    <tr>
      <td>CD</td>
      <td>Cardinal number</td>
      <td>one, two</td>
    </tr>
    <tr>
      <td>NNS</td>
      <td>Noun, plural</td>
      <td>dogs, cats</td>
    </tr>
    <tr>
      <td>DT</td>
      <td>Determiner</td>
      <td>the, some</td>
    </tr>
    <tr>
      <td>NNP</td>
      <td>Proper noun, sing.</td>
      <td>Edinburgh</td>
    </tr>
    <tr>
      <td>EX</td>
      <td>Existential there</td>
      <td>there</td>
    </tr>
    <tr>
      <td>NNPS</td>
      <td>Proper noun, plural</td>
      <td>Smiths</td>
    </tr>
    <tr>
      <td>FW</td>
      <td>Foreign Word</td>
      <td>mon dieu</td>
    </tr>
    <tr>
      <td>PDT</td>
      <td>Predeterminer</td>
      <td>all, both</td>
    </tr>
    <tr>
      <td>IN</td>
      <td>Preposition</td>
      <td>of, in, by</td>
    </tr>
    <tr>
      <td>POS</td>
      <td>Possessive ending</td>
      <td>’s</td>
    </tr>
    <tr>
      <td>JJ</td>
      <td>Adjective</td>
      <td>big</td>
    </tr>
    <tr>
      <td>PP</td>
      <td>Personal pronoun</td>
      <td>I, you, she</td>
    </tr>
    <tr>
      <td>JJR</td>
      <td>Adj., comparative</td>
      <td>bigger</td>
    </tr>
    <tr>
      <td>PP$</td>
      <td>Possessive pronoun</td>
      <td>my, one’s</td>
    </tr>
    <tr>
      <td>JJS</td>
      <td>Adj., superlative</td>
      <td>biggest</td>
    </tr>
    <tr>
      <td>RB</td>
      <td>Adverb</td>
      <td>quickly</td>
    </tr>
    <tr>
      <td>LS</td>
      <td>List item marker</td>
      <td>1, One</td>
    </tr>
    <tr>
      <td>RBR</td>
      <td>Adverb, comparative</td>
      <td>faster</td>
    </tr>
    <tr>
      <td>MD</td>
      <td>Modal</td>
      <td>can, should</td>
    </tr>
    <tr>
      <td>RBS</td>
      <td>Adverb, superlative</td>
      <td>fastest</td>
    </tr>
    <tr>
      <td>RP</td>
      <td>Particle</td>
      <td>up, off</td>
    </tr>
    <tr>
      <td>WP$</td>
      <td>Possessive-Wh</td>
      <td>whose</td>
    </tr>
    <tr>
      <td>SYM</td>
      <td>Symbol</td>
      <td>+, %, &amp;</td>
    </tr>
    <tr>
      <td>WRB</td>
      <td>Wh-adverb</td>
      <td>how, where</td>
    </tr>
    <tr>
      <td>TO</td>
      <td>“to”</td>
      <td>to</td>
    </tr>
    <tr>
      <td>$</td>
      <td>Dollar sign</td>
      <td>$</td>
    </tr>
    <tr>
      <td>UH</td>
      <td>Interjection</td>
      <td>oh, oops</td>
    </tr>
    <tr>
      <td>#</td>
      <td>Pound sign</td>
      <td>#</td>
    </tr>
    <tr>
      <td>VB</td>
      <td>verb, base form</td>
      <td>eat, run</td>
    </tr>
    <tr>
      <td>”</td>
      <td>quote</td>
      <td>”</td>
    </tr>
    <tr>
      <td>VBD</td>
      <td>verb, past tense</td>
      <td>ate</td>
    </tr>
    <tr>
      <td>VBG</td>
      <td>verb, gerund</td>
      <td>eating</td>
    </tr>
    <tr>
      <td>(</td>
      <td>Left paren</td>
      <td>(</td>
    </tr>
    <tr>
      <td>VBN</td>
      <td>verb, past part</td>
      <td>eaten</td>
    </tr>
    <tr>
      <td>)</td>
      <td>Right paren</td>
      <td>)</td>
    </tr>
    <tr>
      <td>VBP</td>
      <td>Verb, present</td>
      <td>eat</td>
    </tr>
    <tr>
      <td>,</td>
      <td>Comma</td>
      <td>,</td>
    </tr>
    <tr>
      <td>VBZ</td>
      <td>Verb, present</td>
      <td>eats</td>
    </tr>
    <tr>
      <td>.</td>
      <td>Sent-final punct</td>
      <td>. ! ?</td>
    </tr>
    <tr>
      <td>WDT</td>
      <td>Wh-determiner</td>
      <td>which, that</td>
    </tr>
    <tr>
      <td>:</td>
      <td>Mid-sent punct.</td>
      <td>: ; —</td>
    </tr>
    <tr>
      <td>WP</td>
      <td>Wh pronoun</td>
      <td>who, what</td>
    </tr>
  </tbody>

</table>

<p>The function <strong>part-of-speech-tagger</strong> loops through all input words and initially assigns the most likely part of speech as specified in the lexicon. Then a subset of Brill’s rules are applied. Rules operate on the current word and the previous word.</p>

<p>As an example Common Lisp implementation of a rule, look for words that are tagged as common nouns, but end in “ing” so they should be a gerand (verb form):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="c1">; rule 8: convert a common noun to a present </code>
  <code class="c1">;         participle verb (i.e., a gerand)</code>
  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">search</code> <code class="s">"NN"</code> <code class="nv">r</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">i</code> <code class="p">(</code><code class="nb">search</code> <code class="s">"ing"</code> <code class="nv">w</code> <code class="ss">:from-end</code> <code class="no">t</code><code class="p">)))</code>
      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">w</code><code class="p">)</code> <code class="mi">3</code><code class="p">))</code>
          <code class="p">(</code><code class="k">setq</code> <code class="nv">r</code> <code class="s">"VBG"</code><code class="p">))))</code>
</pre></div>

</figure>

<p>You can find the lexicon data in the file <strong>src/linguistic_data/FastTagData.lisp</strong>. This file is List code instead of plain data (that in retrospect would be better because it would load faster) and looks like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">lex-hash</code> <code class="p">(</code><code class="nb">make-hash-table</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code> <code class="ss">:size</code> <code class="mi">110000</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"shakeup"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"NN"</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"Laurance"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"NNP"</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"expressing"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"VBG"</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"citybred"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"JJ"</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"negative"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"JJ"</code> <code class="s">"NN"</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"investors"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"NNS"</code> <code class="s">"NNPS"</code><code class="p">))</code>
<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"founding"</code> <code class="nv">lex-hash</code><code class="p">)</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"NN"</code> <code class="s">"VBG"</code> <code class="s">"JJ"</code><code class="p">))</code>
</pre></div>

</figure>

<p>I generated this file automatically from lexicon data using a small Ruby script. Notice that words can have more than one possible part of speech. The most common part of speech for a word is the first entry in the lexicon.</p>

<h3 id="leanpub-auto-categorizing-text">Categorizing Text</h3>

<p>The code to categorize text is fairly simple using a technique often called “bag of words.” I collected sample text in several different categories and for each category (like politics, sports, etc.) I calculated the evidence or weight that words contribute to supporting a category. For example, the word “president” has a strong weight for the category “politics” but not for the category “sports.” The reason is that the word “president” occurs frequently in articles and books about politics. The data file that contains the word weightings for each category is <strong>src/data/cat-data-tables.lisp</strong>. You can look at this file; here is a very small part of it:</p>

<p>If you only need categorization and not the other libraries developed in this chapter, you can just load this library and run the example in the comment at the bottom of the file <strong>categorize_summarize.lisp</strong>:</p>

<p>({lang=”lisp”,linenos=off}
<span class="strikethrough"></span><span class="strikethrough"></span>
(ql:quickload “categorize_summarize”)
(defvar x “President Bill Clinton &lt;&lt;2 pages text no shown&gt;&gt; “)
(defvar words1 (myutils:words-from-string x))
(print words1)
(setq cats1 (categorize_summarize:categorize words1))
(print cats1)
(defvar sum1 (categorize_summarize:summarize words1 cats1))
(print sum1)
<span class="strikethrough"></span><span class="strikethrough"></span></p>

<p>Let’s look at the implementation, starting with creating hash tables for storing word count data for each category or topic:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1">;;;  Starting topic: news_economy.txt</code>

<code class="p">(</code><code class="nb">setf</code> <code class="vg">*h*</code> <code class="p">(</code><code class="nb">make-hash-table</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code> <code class="ss">:size</code> <code class="mi">1000</code><code class="p">))</code>

  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"news"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">3915</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"debt"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">3826</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"money"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">1809</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"work"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">1779</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"business"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">1631</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"tax"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">1572</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="s">"poverty"</code> <code class="vg">*h*</code><code class="p">)</code> <code class="mi">1512</code><code class="p">)</code>
</pre></div>

</figure>

<p>This file was created by a simple Ruby script (not included with the book’s example code) that processes a list of sub-directories, one sub-directory per category. The following listing shows the implementation of function <strong>get-word-list-category</strong> that calculates category tags for input text:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-word-list-category</code> <code class="p">(</code><code class="nv">words</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 3 </code>        <code class="p">(</code><code class="nv">ss</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 4 </code>        <code class="p">(</code><code class="nv">cat-hash</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 5 </code>        <code class="p">(</code><code class="nv">word</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 6 </code>        <code class="p">(</code><code class="nv">len</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">words</code><code class="p">))</code>
<code class="linenos"> 7 </code>        <code class="p">(</code><code class="nv">num-categories</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">categoryHashtables</code><code class="p">))</code>
<code class="linenos"> 8 </code>        <code class="p">(</code><code class="nv">category-score-accumulation-array</code>
<code class="linenos"> 9 </code>          <code class="p">(</code><code class="nb">make-array</code> <code class="nv">num-categories</code> <code class="ss">:initial-element</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="nb">defun</code> <code class="nv">list-sort</code> <code class="p">(</code><code class="nv">list-to-sort</code><code class="p">)</code>
<code class="linenos">12 </code>      <code class="c1">;;(pprint list-to-sort)</code>
<code class="linenos">13 </code>      <code class="p">(</code><code class="nb">sort</code> <code class="nv">list-to-sort</code>
<code class="linenos">14 </code>	    <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">list-element-1</code> <code class="nv">list-element-2</code><code class="p">)</code>
<code class="linenos">15 </code>		<code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">list-element-1</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">list-element-2</code><code class="p">)))))</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="nb">do</code> <code class="p">((</code><code class="nv">k</code> <code class="mi">0</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">k</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">18 </code>        <code class="p">((</code><code class="nb">equal</code> <code class="nv">k</code> <code class="nv">len</code><code class="p">))</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="nv">word</code> <code class="p">(</code><code class="nb">string-downcase</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">words</code> <code class="nv">k</code><code class="p">)))</code>
<code class="linenos">20 </code>      <code class="p">(</code><code class="nb">do</code> <code class="p">((</code><code class="nv">i</code> <code class="mi">0</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">i</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">21 </code>          <code class="p">((</code><code class="nb">equal</code> <code class="nv">i</code> <code class="nv">num-categories</code><code class="p">))</code>
<code class="linenos">22 </code>        <code class="p">(</code><code class="nb">setf</code> <code class="nv">cat-hash</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="nv">categoryHashtables</code><code class="p">))</code>
<code class="linenos">23 </code>        <code class="p">(</code><code class="nb">setf</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">word</code> <code class="nv">cat-hash</code><code class="p">))</code>
<code class="linenos">24 </code>        <code class="p">(</code><code class="k">if</code> <code class="nv">x</code>
<code class="linenos">25 </code>            <code class="p">(</code><code class="nb">setf</code> 
<code class="linenos">26 </code>              <code class="p">(</code><code class="nb">aref</code> <code class="nv">category-score-accumulation-array</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">27 </code>              <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">category-score-accumulation-array</code> <code class="nv">i</code><code class="p">))))))</code>
<code class="linenos">28 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="nv">ss</code> <code class="o">'</code><code class="p">())</code>
<code class="linenos">29 </code>    <code class="p">(</code><code class="nb">do</code> <code class="p">((</code><code class="nv">i</code> <code class="mi">0</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">i</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">30 </code>        <code class="p">((</code><code class="nb">equal</code> <code class="nv">i</code> <code class="nv">num-categories</code><code class="p">))</code>
<code class="linenos">31 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">category-score-accumulation-array</code> <code class="nv">i</code><code class="p">)</code> <code class="mf">0.01</code><code class="p">)</code>
<code class="linenos">32 </code>          <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">33 </code>            <code class="nv">ss</code>
<code class="linenos">34 </code>            <code class="p">(</code><code class="nb">cons</code>
<code class="linenos">35 </code>              <code class="p">(</code><code class="nb">list</code>
<code class="linenos">36 </code>                <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="nv">categoryNames</code><code class="p">)</code>
<code class="linenos">37 </code>                <code class="p">(</code><code class="nb">round</code> <code class="p">(</code><code class="nb">*</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">category-score-accumulation-array</code> <code class="nv">i</code><code class="p">)</code> <code class="mi">10</code><code class="p">)))</code>
<code class="linenos">38 </code>              <code class="nv">ss</code><code class="p">))))</code>
<code class="linenos">39 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="nv">ss</code> <code class="p">(</code><code class="nv">list-sort</code> <code class="nv">ss</code><code class="p">))</code>
<code class="linenos">40 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">cutoff</code> <code class="p">(</code><code class="nb">/</code> <code class="p">(</code><code class="nb">cadar</code> <code class="nv">ss</code><code class="p">)</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">41 </code>          <code class="p">(</code><code class="nv">results-array</code> <code class="o">'</code><code class="p">()))</code>
<code class="linenos">42 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">hit</code> <code class="nv">ss</code><code class="p">)</code>
<code class="linenos">43 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">hit</code><code class="p">)</code> <code class="nv">cutoff</code><code class="p">)</code>
<code class="linenos">44 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="nv">results-array</code> <code class="p">(</code><code class="nb">cons</code> <code class="nv">hit</code> <code class="nv">results-array</code><code class="p">))))</code>
<code class="linenos">45 </code>      <code class="p">(</code><code class="nb">reverse</code> <code class="nv">results-array</code><code class="p">))))</code>
</pre></div>

</figure>

<p>On thing to notice in this listing is lines 11 through 15 where I define a nested function <strong>list-sort</strong> that takes a list of sub-lists and sorts the sublists based on the second value (which is a number) in the sublists. I often nest functions when the “inner” functions are only used in the “outer” function.</p>

<p>Lines 2 through 9 define several local variables used in the outer function. The global variable <strong>categoryHashtables</strong> is a list of word weighting score hash tables, one for each category. The local variable <strong>category-score-accumulation-array</strong> is initialized to an array containing the number zero in each element and will be used to “keep score” of each category. The highest scored categories will be the return value for the outer function.</p>

<p>Lines 17 through 27 are two nested loops. The outer loop is over each word in the input word array. The inner loop is over the number of categories. The logic is simple: for each word check to see if it has a weighting score in each category’s word weighting score hash table and if it is, increment the matching category’s score.</p>

<p>The local variable <strong>ss</strong> is set to an empty list on line 28 and in the loop in lines 29 through 38 I am copying over categories and their scores when the score is over a threshold value of 0.01. We sort the list in <strong>ss</strong> on line 39 using the inner function and then return the categories with a score greater than the median category score.</p>

<h3 id="leanpub-auto-detecting-peoples-names-and-place-names">Detecting People’s Names and Place Names</h3>

<p>The code for detecting people and place names is in the top level API code in the package defined in <strong>src/kbnlp</strong>. This package is loaded using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kbnlp"</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kbnlp:make-text-object</code> <code class="s">"President Bill Clinton ran for president of the USA"</code><code class="p">)</code>
</pre></div>

</figure>

<p>The functions that support identifying people’s names and place names in text are in the Common Lisp package <strong>kb nlp:</strong>:</p>

<ul>
  <li>find-names (words tags exclusion-list) – words is an array of strings for the words in text, tags are the parts of speech tags (from FastTag), and the exclusion list is a an array of words that you want to exclude from being considered as parts of people’s names. The list of found names records starting and stopping indices for names in the array words.</li>
  <li>not-in-list-find-names-helper (a-list start end) – returns true if a found name is not already been added to a list for saving people’s names in text</li>
  <li>find-places (words exclusion-list) – this is similar to find-names, but it finds place names.  The list of found place names records starting and stopping indices for place names in the array words.</li>
  <li>not-in-list-find-places-helper (a-list start end) – returns true if a found place name is not already been added to a list for saving place names in text</li>
  <li>build-list-find-name-helper (v indices) – This converts lists of start/stop word indices to strings containing the names</li>
  <li>find-names-places (txt-object) – this is the top level function that your application will call. It takes a <strong>defstruct</strong> <strong>text</strong> object as input and modifies the <strong>defstruct</strong> <strong>text</strong> by adding people’s and place names it finds in the text. You saw an example of this earlier in this chapter.</li>
</ul>

<p>I will let you read the code and just list the top level function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">find-names-places</code> <code class="p">(</code><code class="nv">txt-object</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">words</code> <code class="p">(</code><code class="nv">text-text</code> <code class="nv">txt-object</code><code class="p">))</code>
<code class="linenos"> 3 </code>	 <code class="p">(</code><code class="nv">tags</code> <code class="p">(</code><code class="nv">text-tags</code> <code class="nv">txt-object</code><code class="p">))</code>
<code class="linenos"> 4 </code>	 <code class="p">(</code><code class="nv">place-indices</code> <code class="p">(</code><code class="nv">find-places</code> <code class="nv">words</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos"> 5 </code>	 <code class="p">(</code><code class="nv">name-indices</code> <code class="p">(</code><code class="nv">find-names</code> <code class="nv">words</code> <code class="nv">tags</code> <code class="nv">place-indices</code><code class="p">))</code>
<code class="linenos"> 6 </code>	 <code class="p">(</code><code class="nv">name-list</code>
<code class="linenos"> 7 </code>	   <code class="p">(</code><code class="nb">remove-duplicates</code>
<code class="linenos"> 8 </code>	     <code class="p">(</code><code class="nv">build-list-find-name-helper</code> <code class="nv">words</code> <code class="nv">name-indices</code><code class="p">)</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">))</code>
<code class="linenos"> 9 </code>	 <code class="p">(</code><code class="nv">place-list</code>
<code class="linenos">10 </code>	   <code class="p">(</code><code class="nb">remove-duplicates</code>
<code class="linenos">11 </code>	     <code class="p">(</code><code class="nv">build-list-find-name-helper</code> <code class="nv">words</code> <code class="nv">place-indices</code><code class="p">)</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">)))</code>
<code class="linenos">12 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">ret</code> <code class="o">'</code><code class="p">()))</code>
<code class="linenos">13 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">name-list</code><code class="p">)</code>
<code class="linenos">14 </code>	<code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">search</code> <code class="s">" "</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">15 </code>	    <code class="p">(</code><code class="k">setq</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">cons</code> <code class="nv">x</code> <code class="nv">ret</code><code class="p">))))</code>
<code class="linenos">16 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">name-list</code> <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="nb">list</code>
<code class="linenos">18 </code>     <code class="p">(</code><code class="nv">remove-shorter-names</code> <code class="nv">name-list</code><code class="p">)</code>
<code class="linenos">19 </code>     <code class="p">(</code><code class="nv">remove-shorter-names</code> <code class="nv">place-list</code><code class="p">))))</code>
</pre></div>

</figure>

<p>In line 2 we are using the slot accessor <strong>text-text</strong> to fetch the array of word tokens from the text object. In lines 3, 4, and 5 we are doing the same for part of speech tags, place name indices in the words array, and person names indices in the words array.</p>

<p>In lines 6 through 11 we are using the function <strong>build-list-find-name-helper</strong> twice to construct the person names and place names as strings given the indices in the words array. We are also using the Common Lisp built-in function <strong>remove-duplicates</strong> to get rid of duplicate names.</p>

<p>In lines 12 through 16 we are discarding any persons names that do not contain a space, that is, only keep names that are at least two word tokens. Lines 17 through 19 define the return value for the function: a list of lists of people and place names using the function <strong>remove-shorter-names</strong> twice to remove shorter versions of the same names from the lists. For example, if we had two names “Mr. John Smith” and “John Smith” then we would want to drop the shorter name “John Smith” from the return list.</p>

<h3 id="leanpub-auto-summarizing-text">Summarizing Text</h3>

<p>The code for summarizing text is located in the directory <strong>src/categorize_summarize</strong> and can be loaded using:</p>

<p>({lang=”lisp”,linenos=off}
<span class="strikethrough"></span><span class="strikethrough"></span>
(ql:quickload “categorize_summarize”)
<span class="strikethrough"></span><span class="strikethrough"></span></p>

<p>The code for summarization depends on the categorization code we saw earlier.</p>

<p>There are many applications for summarizing text. As an example, if you are writing a document management system you will certainly want to use something like Solr to provide search functionality. Solr will return highlighted matches in snippets of indexed document field values. Using summarization, when you add documents to a Solr (or other) search index you could create a new unindexed field that contains a document summary. Then when the users of your system see search results they will see the type of highlighted matches in snippets they are used to seeing in Google, Bing, or DuckDuckGo search results, and, they will see a summary of the document.</p>

<p>Sounds good? The problem to solve is getting good summaries of text and the technique used may have to be modified depending on the type of text you are trying to summarize. There are two basic techniques for summarization: a practical way that almost everyone uses, and an area of research that I believe has so far seen little practical application. The techniques are sentence extraction and abstraction of text into a shorter form by combining and altering sentences. We will use sentence extraction.</p>

<p>How do we choose which sentences in text to extract for the summary? The idea I had in 1999 was simple. Since I usually categorize text in my NLP processing pipeline why not use the words that gave the strongest evidence for categorizing text, and find the sentences with the largest number of these words. As a concrete example, if I categorize text as being “politics”, I identify the words in the text like “president”, “congress”, “election”, etc. that triggered the “politics” classification, and find the sentences with the largest concentrations of these words.</p>

<p>Summarization is something that you will probably need to experiment with depending on your application. My old summarization code contained a lot of special cases, blocks of commented out code, etc. I have attempted to shorten and simplify my old summarization code for the purposes of this book as much as possible and still maintain useful functionality.</p>

<p>The function for summarizing text is fairly simple because when the function <strong>summarize</strong> is called by the top level NLP library function <strong>make-text-object</strong>, the input text has already been categorized. Remember from the example at the beginning of the chapter that the category data looks like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>:CATEGORY-TAGS (("news_politics.txt" 0.38268)
<code class="linenos">2 </code>                ("news_economy.txt" 0.31182)
<code class="linenos">3 </code>                ("news_war.txt" 0.20174))
</pre></div>

</figure>

<p>This category data is saved in the local variable <strong>cats</strong> on line 4 of the following listing.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">summarize</code> <code class="p">(</code><code class="nv">txt-obj</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">words</code> <code class="p">(</code><code class="nv">text-text</code> <code class="nv">txt-obj</code><code class="p">))</code>
<code class="linenos"> 3 </code>         <code class="p">(</code><code class="nv">num-words</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">words</code><code class="p">))</code>
<code class="linenos"> 4 </code>         <code class="p">(</code><code class="nv">cats</code> <code class="p">(</code><code class="nv">text-category-tags</code> <code class="nv">txt-obj</code><code class="p">))</code>
<code class="linenos"> 5 </code>         <code class="p">(</code><code class="nv">sentence-count</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 6 </code>         <code class="nv">best-sentences</code> <code class="nv">sentence</code> <code class="p">(</code><code class="nv">score</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos"> 7 </code>    <code class="c1">;; loop over sentences:</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">num-words</code><code class="p">)</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">word</code> <code class="p">(</code><code class="nb">svref</code> <code class="nv">words</code> <code class="nv">i</code><code class="p">)))</code>
<code class="linenos">10 </code>        <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">cat</code> <code class="nv">cats</code><code class="p">)</code>
<code class="linenos">11 </code>          <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">hash</code> <code class="p">(</code><code class="nb">gethash</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">cat</code><code class="p">)</code> <code class="nv">categoryToHash</code><code class="p">))</code>
<code class="linenos">12 </code>                 <code class="p">(</code><code class="nv">value</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">word</code> <code class="nv">hash</code><code class="p">)))</code>
<code class="linenos">13 </code>            <code class="p">(</code><code class="k">if</code> <code class="nv">value</code>
<code class="linenos">14 </code>                <code class="p">(</code><code class="k">setq</code> <code class="nv">score</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">score</code> <code class="p">(</code><code class="nb">*</code> <code class="mf">0.01</code> <code class="nv">value</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">cat</code><code class="p">)))))))</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="nb">push</code> <code class="nv">word</code> <code class="nv">sentence</code><code class="p">)</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">or</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">word</code> <code class="s">"."</code><code class="p">)</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">word</code> <code class="s">"!"</code><code class="p">)</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">word</code> <code class="s">";"</code><code class="p">))</code>
<code class="linenos">17 </code>            <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">18 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">sentence</code> <code class="p">(</code><code class="nb">reverse</code> <code class="nv">sentence</code><code class="p">))</code>
<code class="linenos">19 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">score</code> <code class="p">(</code><code class="nb">/</code> <code class="nv">score</code> <code class="p">(</code><code class="nb">1+</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">sentence</code><code class="p">))))</code>
<code class="linenos">20 </code>              <code class="p">(</code><code class="k">setq</code> <code class="nv">sentence-count</code> <code class="p">(</code><code class="nb">1+</code> <code class="nv">sentence-count</code><code class="p">))</code>
<code class="linenos">21 </code>              <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~%~A : ~A~%"</code> <code class="nv">sentence</code> <code class="nv">score</code><code class="p">)</code>
<code class="linenos">22 </code>              <code class="c1">;; process this sentence:</code>
<code class="linenos">23 </code>              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code>
<code class="linenos">24 </code>                   <code class="p">(</code><code class="nb">&gt;</code> <code class="nv">score</code> <code class="mf">0.4</code><code class="p">)</code>
<code class="linenos">25 </code>                   <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">sentence</code><code class="p">)</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos">26 </code>                   <code class="p">(</code><code class="nb">&lt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">sentence</code><code class="p">)</code> <code class="mi">30</code><code class="p">))</code>
<code class="linenos">27 </code>                  <code class="p">(</code><code class="k">progn</code>
<code class="linenos">28 </code>                    <code class="p">(</code><code class="k">setq</code> <code class="nv">sentence</code>
<code class="linenos">29 </code>                          <code class="p">(</code><code class="nb">reduce</code>
<code class="linenos">30 </code>                           <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">y</code><code class="p">)</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">x</code> <code class="s">" "</code> <code class="nv">y</code><code class="p">))</code>
<code class="linenos">31 </code>                           <code class="p">(</code><code class="nb">coerce</code> <code class="nv">sentence</code> <code class="ss">'list</code><code class="p">)))</code>
<code class="linenos">32 </code>                    <code class="p">(</code><code class="nb">push</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">sentence</code> <code class="nv">score</code><code class="p">)</code> <code class="nv">best-sentences</code><code class="p">)))</code>
<code class="linenos">33 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="nv">sentence</code> <code class="no">nil</code> <code class="nv">score</code> <code class="mi">0</code><code class="p">)))))</code>
<code class="linenos">34 </code>    <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">35 </code>     <code class="nv">best-sentences</code>
<code class="linenos">36 </code>     <code class="p">(</code><code class="nb">sort</code>
<code class="linenos">37 </code>      <code class="nv">best-sentences</code>
<code class="linenos">38 </code>      <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">y</code><code class="p">)</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">y</code><code class="p">)))))</code>
<code class="linenos">39 </code>    <code class="p">(</code><code class="k">if</code> <code class="nv">best-sentences</code>
<code class="linenos">40 </code>        <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">41 </code>         <code class="p">(</code><code class="nb">reduce</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">y</code><code class="p">)</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">x</code> <code class="s">" "</code> <code class="nv">y</code><code class="p">))</code>
<code class="linenos">42 </code>                 <code class="p">(</code><code class="nb">mapcar</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">x</code><code class="p">))</code> <code class="nv">best-sentences</code><code class="p">))</code>
<code class="linenos">43 </code>         <code class="s">" ."</code> <code class="s">"."</code><code class="p">)</code>
<code class="linenos">44 </code>        <code class="s">"&lt;no summary&gt;"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The nested loops in lines 8 through 33 look a little complicated, so let’s walk through it. Our goal is to calculate an importance score for each word token in the input text and to then select a few sentences containing highly scored words. The outer loop is over the word tokens in the input text. For each word token we loop over the list of categories, looking up the current word in each category hash and incrementing the score for the current word token. As we increment the word token scores we also look for sentence breaks and save sentences.</p>

<p>The complicated bit of code in lines 16 through 32 where I construct sentences and their scores, and store sentences with a score above a threshold value in the list <strong>best-sentences</strong>. After the two nested loops, in lines 34 through 44 we simply sort the sentences by score and select the “best” sentences for the summary. The extracted sentences are no longer in their original order, which can have strange effects, but I like seeing the most relevant sentences first. </p>

<h3 id="leanpub-auto-text-mining">Text Mining</h3>

<p>Text mining in general refers to finding data in unstructured text. We have covered several text mining techniques in this chapter:</p>

<ul>
  <li>Named entity recognition - the NLP library covered in this chapter recognizes person and place entity names. I leave it as an exercise for you to extend this library to handle company and product names. You can start by collecting company and product names in the files <strong>src/kbnlp/linguistic_data/names/names.companies</strong> and <strong>src/kbnlp/data/names/names.products</strong> and extend the library code.</li>
  <li>Categorizing text - you can increase the accuracy of categorization by adding more weighted words/terms that support categories. If you are already using Java in the systems you build, I recommend the Apache OpenNLP library that is more accurate than the simpler “bag of words” approach I used in my Common Lisp NLP library. If you use Python, then I recommend that you also try the NLTK library.</li>
  <li>Summarizing text.</li>
</ul>

<p>In the next chapter I am going to cover another “data centric” topic: performing information gathering on the web. You will likely find some synergy between being able to use NLP to create structured data from unstructured text.</p>


<h2 id="information_gathering">Information Gathering</h2>

<p>This chapter covers information gathering on the web using data sources and general techniques that I have found useful. When I was planning this new book edition I had intended to also cover some basics for using the Semantic Web from Common Lisp, basically distilling some of the data from my previous book “Practical Semantic Web and Linked Data Applications, Common Lisp Edition” published in 2011. However since a <a href="http://markwatson.com/#books/">free PDF is now available for that book</a> I decided to just refer you to my previous work if you are interested in the Semantic Web and Linked Data. You can also find the Java edition of this previous book on my web site.</p>

<p>Gathering information from the web in realtime has some real advantages:</p>

<ul>
  <li>You don’t need to worry about storing data locally.</li>
  <li>Information is up to date (depending on which web data resources you choose to use).</li>
</ul>

<p>There are also a few things to consider:</p>

<ul>
  <li>Data on the web may have legal restrictions on its use so be sure to read the terms and conditions on web sites that you would like to use.</li>
  <li>Authorship and validity of data may be questionable.</li>
</ul>

<h3 id="leanpub-auto-dbpedia-lookup-service">DBPedia Lookup Service</h3>

<p>Wikipedia is a great source of information. As you may know, you can download a <a href="https://en.wikipedia.org/wiki/Wikipedia:Database_download">data dump of all Wikipedia data</a> with or without version information and comments. When I want fast access to the entire Wikipedia set of English language articles I choose the second option and just get the current pages with no comments of versioning information. <a href="http://download.wikimedia.org/enwiki/latest/enwiki-latest-pages-articles.xml.bz2">This is the direct download link for current Wikipedia articles.</a> There are no comments or user pages in this GZIP file. This is not as much data as you might think, only about 9 gigabytes compressed or about 42 gigabytes uncompressed.</p>

<p>To load and run an example, try:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"dbpedia"</code><code class="p">)</code>
<code class="p">(</code><code class="nv">dbpedia:dbpedia-lookup</code> <code class="s">"berlin"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Wikipedia is a great resource to have on hand but I am going to show you in this section how to access the Semantic Web version or Wikipedia, <a href="http://dbpedia.org/">DBPedia</a> using the DBPedia Lookup Service in the next code listing that shows the contents of the example file <strong>dbpedia-lookup.lisp</strong> in the directory <strong>src/dbpedia</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:drakma</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:babel</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="ss">:s-xml</code><code class="p">)</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="c1">;; utility from http://cl-cookbook.sourceforge.net/strings.html#manip:</code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">replace-all</code> <code class="p">(</code><code class="nb">string</code> <code class="nv">part</code> <code class="nv">replacement</code> <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">test</code> <code class="nf">#'</code><code class="nb">char=</code><code class="p">))</code>
<code class="linenos"> 7 </code>  <code class="s">"Returns a new string in which all the occurrences of the part </code>
<code class="linenos"> 8 </code><code class="s">is replaced with replacement."</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="nb">with-output-to-string</code> <code class="p">(</code><code class="nv">out</code><code class="p">)</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="nb">loop</code> <code class="nv">with</code> <code class="nv">part-length</code> <code class="nb">=</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">part</code><code class="p">)</code>
<code class="linenos">11 </code>       <code class="nv">for</code> <code class="nv">old-pos</code> <code class="nb">=</code> <code class="mi">0</code> <code class="nv">then</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">pos</code> <code class="nv">part-length</code><code class="p">)</code>
<code class="linenos">12 </code>       <code class="nv">for</code> <code class="nv">pos</code> <code class="nb">=</code> <code class="p">(</code><code class="nb">search</code> <code class="nv">part</code> <code class="nb">string</code>
<code class="linenos">13 </code>                         <code class="ss">:start2</code> <code class="nv">old-pos</code>
<code class="linenos">14 </code>                         <code class="ss">:test</code> <code class="nv">test</code><code class="p">)</code>
<code class="linenos">15 </code>       <code class="nb">do</code> <code class="p">(</code><code class="nb">write-string</code> <code class="nb">string</code> <code class="nv">out</code>
<code class="linenos">16 </code>                        <code class="ss">:start</code> <code class="nv">old-pos</code>
<code class="linenos">17 </code>                        <code class="ss">:end</code> <code class="p">(</code><code class="nb">or</code> <code class="nv">pos</code> <code class="p">(</code><code class="nb">length</code> <code class="nb">string</code><code class="p">)))</code>
<code class="linenos">18 </code>       <code class="nb">when</code> <code class="nv">pos</code> <code class="nb">do</code> <code class="p">(</code><code class="nb">write-string</code> <code class="nv">replacement</code> <code class="nv">out</code><code class="p">)</code>
<code class="linenos">19 </code>       <code class="nv">while</code> <code class="nv">pos</code><code class="p">)))</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="nb">defstruct</code> <code class="nv">dbpedia-data</code> <code class="nv">uri</code> <code class="nv">label</code> <code class="nv">description</code><code class="p">)</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-lookup</code> <code class="p">(</code><code class="nv">search-string</code><code class="p">)</code>
<code class="linenos">24 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">s-str</code> <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">search-string</code> <code class="s">" "</code> <code class="s">"+"</code><code class="p">))</code>
<code class="linenos">25 </code>         <code class="p">(</code><code class="nv">s-uri</code> 
<code class="linenos">26 </code>          <code class="p">(</code><code class="nb">concatenate</code>
<code class="linenos">27 </code>           <code class="ss">'string</code>
<code class="linenos">28 </code>           <code class="s">"http://lookup.dbpedia.org/api/search.asmx/KeywordSearch?QueryString="</code>
<code class="linenos">29 </code>           <code class="nv">s-str</code><code class="p">))</code>
<code class="linenos">30 </code>         <code class="p">(</code><code class="nv">response-body</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">31 </code>         <code class="p">(</code><code class="nv">response-status</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">32 </code>         <code class="p">(</code><code class="nv">response-headers</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">33 </code>         <code class="p">(</code><code class="nv">xml</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">34 </code>         <code class="nv">ret</code><code class="p">)</code>
<code class="linenos">35 </code>    <code class="p">(</code><code class="nb">multiple-value-setq</code>
<code class="linenos">36 </code>        <code class="p">(</code><code class="nv">response-body</code> <code class="nv">response-status</code> <code class="nv">response-headers</code><code class="p">)</code>
<code class="linenos">37 </code>      <code class="p">(</code><code class="nv">drakma:http-request</code>
<code class="linenos">38 </code>       <code class="nv">s-uri</code>
<code class="linenos">39 </code>       <code class="ss">:method</code> <code class="ss">:get</code>
<code class="linenos">40 </code>       <code class="ss">:accept</code> <code class="s">"application/xml"</code><code class="p">))</code>
<code class="linenos">41 </code>    <code class="c1">;; (print (list "raw response body as XML:" response-body))</code>
<code class="linenos">42 </code>    <code class="c1">;;(print (list ("status:" response-status "headers:" response-headers)))</code>
<code class="linenos">43 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="nv">xml</code>
<code class="linenos">44 </code>          <code class="p">(</code><code class="nv">s-xml:parse-xml-string</code>
<code class="linenos">45 </code>           <code class="p">(</code><code class="nv">babel:octets-to-string</code> <code class="nv">response-body</code><code class="p">)))</code>
<code class="linenos">46 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">r</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">xml</code><code class="p">))</code>
<code class="linenos">47 </code>      <code class="c1">;; assumption: data is returned in the order:</code>
<code class="linenos">48 </code>      <code class="c1">;;   1. label</code>
<code class="linenos">49 </code>      <code class="c1">;;   2. DBPedia URI for more information</code>
<code class="linenos">50 </code>      <code class="c1">;;   3. description</code>
<code class="linenos">51 </code>      <code class="p">(</code><code class="nb">push</code>
<code class="linenos">52 </code>       <code class="p">(</code><code class="nv">make-dbpedia-data</code>
<code class="linenos">53 </code>        <code class="ss">:uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">2</code> <code class="nv">r</code><code class="p">))</code>
<code class="linenos">54 </code>        <code class="ss">:label</code> <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">1</code> <code class="nv">r</code><code class="p">))</code>
<code class="linenos">55 </code>        <code class="ss">:description</code>
<code class="linenos">56 </code>        <code class="p">(</code><code class="nb">string-trim</code>
<code class="linenos">57 </code>         <code class="o">'</code><code class="p">(</code><code class="sc">#\Space</code> <code class="sc">#\NewLine</code> <code class="sc">#\Tab</code><code class="p">)</code>
<code class="linenos">58 </code>         <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">3</code> <code class="nv">r</code><code class="p">))))</code>
<code class="linenos">59 </code>       <code class="nv">ret</code><code class="p">))</code>
<code class="linenos">60 </code>    <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos">61 </code>
<code class="linenos">62 </code><code class="c1">;; (dbpedia-lookup "berlin")</code>
</pre></div>

</figure>

<p>I am only capturing the attributes for DBPedia URI, label and description in this example code. If you uncomment line 41 and look at the entire response body from the call to DBPedia Lookup, you can see other attributes that you might want to capture in your applications.</p>

<p>Here is a sample call to the function <strong>dbpedia:dbpedia-lookup</strong> (only some of the returned data is shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s2">"dbpedia"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="o">*</code> <code class="p">(</code><code class="n">dbpedia</code><code class="p">:</code><code class="n">dbpedia</code><code class="o">-</code><code class="n">lookup</code> <code class="s2">"berlin"</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="c1">#S(DBPEDIA-DATA</code>
<code class="linenos"> 5 </code>  <code class="p">:</code><code class="n">URI</code> <code class="s2">"http://dbpedia.org/resource/Berlin"</code>
<code class="linenos"> 6 </code>  <code class="p">:</code><code class="n">LABEL</code> <code class="s2">"Berlin"</code>
<code class="linenos"> 7 </code>  <code class="p">:</code><code class="n">DESCRIPTION</code>
<code class="linenos"> 8 </code>  <code class="s2">"Berlin is the capital city of Germany and one of the 16 states of Germany.</code>
<code class="linenos"> 9 </code>   <code class="n">With</code> <code class="n">a</code> <code class="n">population</code> <code class="n">of</code> <code class="mf">3.5</code> <code class="n">million</code> <code class="n">people</code><code class="p">,</code> <code class="n">Berlin</code> <code class="k">is</code> <code class="n">Germany</code><code class="s1">'s largest city</code>
<code class="linenos">10 </code>   <code class="ow">and</code> <code class="k">is</code> <code class="n">the</code> <code class="n">second</code> <code class="n">most</code> <code class="n">populous</code> <code class="n">city</code> <code class="n">proper</code> <code class="ow">and</code> <code class="n">the</code> <code class="n">eighth</code> <code class="n">most</code> <code class="n">populous</code>
<code class="linenos">11 </code>   <code class="n">urban</code> <code class="n">area</code> <code class="ow">in</code> <code class="n">the</code> <code class="n">European</code> <code class="n">Union</code><code class="o">.</code> <code class="n">Located</code> <code class="ow">in</code> <code class="n">northeastern</code> <code class="n">Germany</code><code class="p">,</code> <code class="n">it</code> <code class="k">is</code>
<code class="linenos">12 </code>   <code class="n">the</code> <code class="n">center</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Berlin</code><code class="o">-</code><code class="n">Brandenburg</code> <code class="n">Metropolitan</code> <code class="n">Region</code><code class="p">,</code> <code class="n">which</code> <code class="n">has</code> <code class="mf">5.9</code>
<code class="linenos">13 </code>   <code class="n">million</code> <code class="n">residents</code> <code class="n">from</code> <code class="n">over</code> <code class="mi">190</code> <code class="n">nations</code><code class="o">.</code> <code class="n">Located</code> <code class="ow">in</code> <code class="n">the</code> <code class="n">European</code> <code class="n">Plains</code><code class="p">,</code>
<code class="linenos">14 </code>   <code class="n">Berlin</code> <code class="k">is</code> <code class="n">influenced</code> <code class="n">by</code> <code class="n">a</code> <code class="n">temperate</code> <code class="n">seasonal</code> <code class="n">climate</code><code class="o">.</code><code class="s2">")</code>
<code class="linenos">15 </code> <code class="o">...</code><code class="p">)</code>
</pre></div>

</figure>

<p>Wikipedia, and the DBPedia linked data for of Wikipedia are great sources of online data. If you get creative, you will be able to think of ways to modify the systems you build to pull data from DPPedia. One warning: Semantic Web/Linked Data sources on the web are not available 100% of the time. If your business applications depend on having the DBPedia always available then you can follow the instructions on the <a href="http://dbpedia.org">DBPedia web site</a> to install the service on one of your own servers.</p>

<h3 id="leanpub-auto-web-spiders">Web Spiders</h3>

<p>When you write web spiders to collect data from the web there are two things to consider:</p>

<ul>
  <li>Make sure you read the terms of service for web sites whose data you want to use. I have found that calling or emailing web site owners explaining how I want to use the data on their site usually works to get permission.</li>
  <li>Make sure you don’t access a site too quickly. It is polite to wait a second or two between fetching pages and other assets from a web site.</li>
</ul>

<p>We have already used the Drakma web client library in this book. See the files <strong>src/dbpedia/dbpedia-lookup.lisp</strong> (covered in the last section) and <strong>src/solr_examples/solr-client.lisp</strong> (covered in the <a href="#nosql_chapter">Chapter on NoSQL</a>). Paul Nathan has written library using Drakma to crawl a web site with an example to print out links as they are found. His code is available under the AGPL license at <a href="http://articulate-lisp.com/examples/trotter.html">articulate-lisp.com/src/web-trotter.lisp</a> and I recommend that as a starting point.</p>

<p>I find it is sometimes easier during development to make local copies of a web site so that I don’t have to use excess resources from web site hosts. Assuming that you have the <strong>wget</strong> utility installed, you can mirror a site like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>wget -m -w 2 http://knowledgebooks.com/
<code class="linenos">2 </code>wget -mk -w 2 http://knowledgebooks.com/
</pre></div>

</figure>

<p>Both of these examples have a two-second delay between HTTP requests for resources. The option <strong>-m</strong> indicates to recursively follow all links on the web site. The <strong>-w</strong> <strong>2</strong> option delays for two seconds between requests. The option <strong>-mk</strong> converts URI references to local file references on your local mirror. The second example on line 2 is more convenient.</p>

<p>We covered reading from local files in the <a href="#input_output">Chapter on Input and Output</a>. One trick I use is to simply concatenate all web pages into one file. Assuming that you created a local mirror of a web site, cd to the top level directory and use something like this:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>cd knowledgebooks.com
<code class="linenos">2 </code>cat *.html */*.html &gt; ../web_site.html
</pre></div>

</figure>

<p>You can then open the file, search for text in in <strong>p</strong>, <strong>div</strong>, <strong>h1</strong>, etc. HTML elements to process an entire web site as one file.</p>

<h3 id="leanpub-auto-using-apache-nutch">Using Apache Nutch</h3>

<p><a href="https://nutch.apache.org/">Apache Nutch</a>, like Solr, is built on Lucene search technology. I use Nutch as a “search engine in a box” when I need to spider web sites and I want a local copy with a good search index.</p>

<p>Nutch handles a different developer’s use case over Solr which we covered in the <a href="#nosql_chapter">Chapter on NoSQL</a>. As we saw, Solr is an effective tool for indexing and searching structured data as documents. With very little setup, Nutch can be set up to automatically keep an up to date index of a list of web sites, and optionally follow links to some desired depth from these “seed” web sites.</p>

<p>You can use the same Common Lisp client code that we used for Solr with one exception; you will need to change the root URI for the search service to:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code> http://localhost:8080/opensearch?query=
</pre></div>

</figure>

<p>So the modified client code <strong>src/solr_examples/solr-client.lisp</strong> needs one line changed:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">do-search</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">terms</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">query-string</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~{~A~^+AND+~}"</code> <code class="nv">terms</code><code class="p">)))</code>
<code class="linenos">3 </code>   <code class="p">(</code><code class="nv">cl-json:decode-json-from-string</code>
<code class="linenos">4 </code>     <code class="p">(</code><code class="nv">drakma:http-request</code>
<code class="linenos">5 </code>       <code class="p">(</code><code class="nb">concatenate</code> 
<code class="linenos">6 </code>        <code class="ss">'string</code>
<code class="linenos">7 </code>        <code class="s">"http://localhost:8080/opensearch?query="</code>
<code class="linenos">8 </code>        <code class="nv">query-string</code>
<code class="linenos">9 </code>        <code class="s">"&amp;wt=json"</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>Early versions of Nutch were very simple to install and configure. Later versions of Nutch have been more complex, more performant, and have more services, but it will take you longer to get set up than earlier versions. If you just want to experiment with Nutch, you might want to start with an earlier version.</p>

<p>The <a href="http://www.opensearch.org/Home">OpenSearch.org</a> web site contains many public OpenSearch services that you might want to try. If you want to modify the example client code in <strong>src/solr-client.lisp</strong> a good start is OpenSearch services that return JSON data and <a href="http://www.opensearch.org/Community/JSON_Formats">OpenSearch Community JSON formats web page</a> is a good place to start. Some of the services on this web page like the New York Times service require that you sign up for a developer’s API key.</p>

<p>When I start writing an application that requires web data (no matter which programming language I am using) I start by finding services that may provide the type of data I need and do my initial development with a web browser with plugin support to nicely format XML and JSON data. I do a lot of exploring and take a lot of notes before I write any code.</p>

<h3 id="leanpub-auto-wrap-up-1">Wrap Up</h3>

<p>I tried to provide some examples and advice in this short chapter to show you that even though other languages like Ruby and Python have more libraries and tools for gathering information from the web, Common Lisp has good libraries for information gathering also and they are easily used via Quicklisp.</p>


<h2 id="leanpub-auto-using-the-cl-machine-learning-library">Using The CL Machine-Learning Library</h2>

<p>The CL Machine-Learning (CLML) library was originally developed by MSI (NTT DATA Mathematical Systems Inc. in Japan) and is supported by many developers. You should visit the <a href="https://github.com/mmaul/clml">CLML web page</a> for project documentation and follow the installation directions and read about the project before using the examples in this chapter. However if you just want to quickly try the following CLML examples then you can install CLML using Quicklisp:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">mkdir</code> <code class="o">-</code><code class="n">p</code> <code class="o">~/</code><code class="n">quicklisp</code><code class="o">/</code><code class="n">local</code><code class="o">-</code><code class="n">projects</code>
<code class="linenos">2 </code><code class="n">cd</code> <code class="o">~/</code><code class="n">quicklisp</code><code class="o">/</code><code class="n">local</code><code class="o">-</code><code class="n">projects</code>
<code class="linenos">3 </code><code class="n">git</code> <code class="n">clone</code> <code class="n">https</code><code class="p">:</code><code class="o">//</code><code class="n">github</code><code class="o">.</code><code class="n">com</code><code class="o">/</code><code class="n">mmaul</code><code class="o">/</code><code class="n">clml</code><code class="o">.</code><code class="n">git</code>
<code class="linenos">4 </code><code class="n">sbcl</code> <code class="o">--</code><code class="n">dynamic</code><code class="o">-</code><code class="n">space</code><code class="o">-</code><code class="n">size</code> <code class="mi">2560</code>
<code class="linenos">5 </code><code class="o">&gt;</code> <code class="p">(</code><code class="n">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="p">:</code><code class="n">clml</code> <code class="p">:</code><code class="n">verbose</code> <code class="n">t</code><code class="p">)</code>
</pre></div>

</figure>

<p>The installation will take a while to run but after installation using the libraries via quickload is fast. You can now run the example Quicklisp project <strong>src/clml_examples</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">sbcl</code> <code class="nv">--dynamic-space-size</code> <code class="mi">2560</code>
<code class="nb">*</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"clmltest"</code><code class="p">)</code>
<code class="nb">*</code> <code class="p">(</code><code class="nv">clmltest:clml-tests-example</code><code class="p">)</code>
</pre></div>

</figure>

<p>Please be patient the first time you run this because the first time you load the example project, the one time installation of CLML will take a while to run but after installation then the example project loads quickly. CLML installation involves downloading and installing BLAS, LAPACK, and other libraries.</p>

<p>Other resources for CLML are the <a href="https://github.com/mmaul/clml.tutorials">tutorials</a> and <a href="https://github.com/mmaul/clml.extras">contributed extensions</a> that include support for plotting (using several libraries) and for fetching data sets.</p>

<p>Although CLML is fairly portable we will be using SBCL and we need to increase the heap space when starting SBCL when we want to use the CLML library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>sbcl --dynamic-space-size 5000
</pre></div>

</figure>

<p>You can refer to the documentation at <a href="https://github.com/mmaul/clml">https://github.com/mmaul/clml</a>. This documentation lists the packages with some information for each package but realistically I keep the source code for CLML in an editor or IDE and read source code while writing code that uses CLML. I will show you with short examples how to use the KNN (K nearest neighbors) and SVM (support vector machines) APIs. We will not cover other useful CLML APIs like time series processing, Naive Bayes, PCA (principle component analysis) and general matrix and tensor operations.</p>

<p>Even though the learning curve is a bit steep, CLML provides a lot of functionality for machine learning, dealing with time series data, and general matrix and tensor operations.</p>

<h3 id="leanpub-auto-using-the-clml-data-loading-and-access-apis">Using the CLML Data Loading and Access APIs</h3>

<p>The CLML project uses several data sets and since the few that we will use are small files, they are included in the book’s repository in directory <em>machine_learning_data</em> under the <em>src</em> directory. The first few lines of <em>labeled_cancer_training_data.csv</em> are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Cl.thickness,Cell.size,Cell.shape,Marg.adhesion,Epith.c.size,Bare.nuclei,Bl.cromatin\
,Normal.nucleoli,Mitoses,Class
5,4,4,5,7,10,3,2,1,benign
6,8,8,1,3,4,3,7,1,benign
8,10,10,8,7,10,9,7,1,malignant
2,1,2,1,2,1,3,1,1,benign
</pre></div>

</figure>

<p>The first line in the CSV data files specifies names for each attribute with the name of the last column being “Class” which here takes on values <em>benign</em> or <em>malignant</em>. Later, the goal will be to create models that are constructed from training data and then make predictions of the “Class” of new input data. We will look at how to build and use machine learning models later but here we concentrate on reading and using input data.</p>

<p>The example file <em>clml_data_apis.lisp</em> shows how to open a file and loop over the values for each row:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; note; run SBCL using: sbcl --dynamic-space-size 2560</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="o">'</code><code class="p">(</code><code class="ss">:clml</code>
<code class="linenos"> 4 </code>                <code class="ss">:clml.hjs</code><code class="p">))</code> <code class="c1">; read data sets</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:clml-data-test</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:clml.hjs.read-data</code><code class="p">))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:clml-data-test</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">read-data</code> <code class="p">()</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">train1</code>
<code class="linenos">13 </code>         <code class="p">(</code><code class="nv">clml.hjs.read-data:read-data-from-file</code>
<code class="linenos">14 </code>          <code class="s">"./machine_learning_data/labeled_cancer_training_data.csv"</code>
<code class="linenos">15 </code>          <code class="ss">:type</code> <code class="ss">:csv</code>
<code class="linenos">16 </code>          <code class="ss">:csv-type-spec</code> <code class="p">(</code><code class="nb">append</code>
<code class="linenos">17 </code>                           <code class="p">(</code><code class="nb">make-list</code> <code class="mi">9</code> <code class="ss">:initial-element</code> <code class="ss">'double-float</code><code class="p">)</code>
<code class="linenos">18 </code>                           <code class="o">'</code><code class="p">(</code><code class="nc">symbol</code><code class="p">)))))</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nv">loop-over-and-print-data</code> <code class="nv">train1</code><code class="p">)))</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">loop-over-and-print-data</code> <code class="p">(</code><code class="nv">clml-data-set</code><code class="p">)</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="nb">print</code> <code class="s">"Loop over and print a CLML data set:"</code><code class="p">)</code>
<code class="linenos">23 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">testdata</code> <code class="p">(</code><code class="nv">clml.hjs.read-data:dataset-points</code> <code class="nv">clml-data-set</code><code class="p">)))</code>
<code class="linenos">24 </code>    <code class="p">(</code><code class="nb">loop</code> <code class="nv">for</code> <code class="nv">td</code> <code class="nv">across</code> <code class="nv">testdata</code>
<code class="linenos">25 </code>       <code class="nb">do</code>
<code class="linenos">26 </code>         <code class="p">(</code><code class="nb">print</code> <code class="nv">td</code><code class="p">))))</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="p">(</code><code class="nv">read-data</code><code class="p">)</code>
</pre></div>

</figure>

<p>The function <strong>read-data</strong> defined in lines 11-19 uses the utility function <strong>clml.hjs.read-data:read-data-from-file</strong> to read a CSV (comma separated value) spreadsheet file from disk. The CSV file is expected to contain  10 columns (set in lines 17-18) with the first nine columns containing floating point values and the last column text data.</p>

<p>The function <strong>loop-over-and-print-data</strong> defined in lines 21-26 reads the CLML data set object, looping over each data sample (i.e., each row in the original spreadsheet file) and printing it.</p>

<p>Here is some output from loading this file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="n">sbcl</code> <code class="o">--</code><code class="n">dynamic</code><code class="o">-</code><code class="n">space</code><code class="o">-</code><code class="n">size</code> <code class="mi">2560</code>
<code class="linenos"> 2 </code><code class="n">This</code> <code class="k">is</code> <code class="n">SBCL</code> <code class="mf">1.3</code><code class="o">.</code><code class="mi">16</code><code class="p">,</code> <code class="n">an</code> <code class="n">implementation</code> <code class="n">of</code> <code class="n">ANSI</code> <code class="n">Common</code> <code class="n">Lisp</code><code class="o">.</code>
<code class="linenos"> 3 </code><code class="n">More</code> <code class="n">information</code> <code class="n">about</code> <code class="n">SBCL</code> <code class="k">is</code> <code class="n">available</code> <code class="n">at</code> <code class="o">&lt;</code><code class="n">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="o">.</code><code class="n">sbcl</code><code class="o">.</code><code class="n">org</code><code class="o">/&gt;.</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">SBCL</code> <code class="k">is</code> <code class="n">free</code> <code class="n">software</code><code class="p">,</code> <code class="n">provided</code> <code class="k">as</code> <code class="k">is</code><code class="p">,</code> <code class="n">with</code> <code class="n">absolutely</code> <code class="n">no</code> <code class="n">warranty</code><code class="o">.</code>
<code class="linenos"> 6 </code><code class="n">It</code> <code class="k">is</code> <code class="n">mostly</code> <code class="ow">in</code> <code class="n">the</code> <code class="n">public</code> <code class="n">domain</code><code class="p">;</code> <code class="n">some</code> <code class="n">portions</code> <code class="n">are</code> <code class="n">provided</code> <code class="n">under</code>
<code class="linenos"> 7 </code><code class="n">BSD</code><code class="o">-</code><code class="n">style</code> <code class="n">licenses</code><code class="o">.</code>  <code class="n">See</code> <code class="n">the</code> <code class="n">CREDITS</code> <code class="ow">and</code> <code class="n">COPYING</code> <code class="n">files</code> <code class="ow">in</code> <code class="n">the</code>
<code class="linenos"> 8 </code><code class="n">distribution</code> <code class="k">for</code> <code class="n">more</code> <code class="n">information</code><code class="o">.</code>
<code class="linenos"> 9 </code><code class="o">*</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"clml_data_apis.lisp"</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="s2">"Loop over and print a CLML data set:"</code> 
<code class="linenos">12 </code><code class="c1">#(5.0d0 4.0d0 4.0d0 5.0d0 7.0d0 10.0d0 3.0d0 2.0d0 1.0d0 |benign|) </code>
<code class="linenos">13 </code><code class="c1">#(6.0d0 8.0d0 8.0d0 1.0d0 3.0d0 4.0d0 3.0d0 7.0d0 1.0d0 |benign|) </code>
<code class="linenos">14 </code><code class="c1">#(8.0d0 10.0d0 10.0d0 8.0d0 7.0d0 10.0d0 9.0d0 7.0d0 1.0d0 |malignant|) </code>
<code class="linenos">15 </code><code class="c1">#(2.0d0 1.0d0 2.0d0 1.0d0 2.0d0 1.0d0 3.0d0 1.0d0 1.0d0 |benign|) </code>
</pre></div>

</figure>

<p>In the next section we will use the same cancer data training file, and another test data in the same format to cluster this cancer data into similar sets, one set for non-malignant and one for malignant samples.</p>

<h3 id="leanpub-auto-k-means-clustering-of-cancer-data-set">K-Means Clustering of Cancer Data Set</h3>

<p>We will now read the same University of Wisconsin cancer data set and cluster the input samples (one sample per row of the spreadsheet file) into similar classes. We will find after training a model that the data is separated into two clusters, representing non-malignant and malignant samples.</p>

<p>The function <strong>cancer-data-cluster-example-read-data</strong> defined in lines 33-47 is very similar to the function <strong>read-data</strong> in the last section except here we read in two data files: one for training and one for testing.</p>

<p>The function <strong>cluster-using-k-nn</strong> defined in lines 13-30 uses the training and test data objects to first train a model and then to test it with test data that was previously used for training. Notice how we call this function in line 47: the first two arguments are the two data set objects, the third is the string “Class” that is the label for the 10th column of the original spreadsheet CSV files, and the last argument is the type of distance measurement used to compare two data samples (i.e., comparing any two rows of the training CSV data file).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; note; run SBCL using: sbcl --dynamic-space-size 2560</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="o">'</code><code class="p">(</code><code class="ss">:clml</code>
<code class="linenos"> 4 </code>                <code class="ss">:clml.hjs</code> <code class="c1">; utilities</code>
<code class="linenos"> 5 </code>                <code class="ss">:clml.clustering</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:clml-knn-cluster-example1</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:clml.hjs.read-data</code><code class="p">))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:clml-knn-cluster-example1</code><code class="p">)</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="c1">;; folowing is derived from test code in CLML:</code>
<code class="linenos">13 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">cluster-using-k-nn</code> <code class="p">(</code><code class="nv">test</code> <code class="nv">train</code> <code class="nv">objective-param-name</code>  <code class="nv">manhattan</code><code class="p">)</code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">original-data-column-length</code><code class="p">)</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">original-data-column-length</code>
<code class="linenos">16 </code>          <code class="p">(</code><code class="nb">length</code> <code class="p">(</code><code class="nb">aref</code> <code class="p">(</code><code class="nv">clml.hjs.read-data:dataset-points</code> <code class="nv">train</code><code class="p">)</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">k</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">18 </code>           <code class="p">(</code><code class="nv">k-nn-estimator</code>
<code class="linenos">19 </code>            <code class="p">(</code><code class="nv">clml.nearest-search.k-nn:k-nn-analyze</code> <code class="nv">train</code>
<code class="linenos">20 </code>              <code class="nv">k</code>
<code class="linenos">21 </code>              <code class="nv">objective-param-name</code> <code class="ss">:all</code>
<code class="linenos">22 </code>              <code class="ss">:distance</code> <code class="nv">manhattan</code> <code class="ss">:normalize</code> <code class="no">t</code><code class="p">)))</code>
<code class="linenos">23 </code>      <code class="p">(</code><code class="nb">loop</code> <code class="nv">for</code> <code class="nv">data</code> <code class="nv">across</code>
<code class="linenos">24 </code>          <code class="p">(</code><code class="nv">dataset-points</code>
<code class="linenos">25 </code>            <code class="p">(</code><code class="nv">clml.nearest-search.k-nn:k-nn-estimate</code> <code class="nv">k-nn-estimator</code> <code class="nv">test</code><code class="p">))</code>
<code class="linenos">26 </code>         <code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">data</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">data</code> <code class="nv">original-data-column-length</code><code class="p">))</code>
<code class="linenos">27 </code>         <code class="nb">do</code>
<code class="linenos">28 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"Correct: ~a~%"</code> <code class="nv">data</code><code class="p">)</code>
<code class="linenos">29 </code>         <code class="nv">else</code> <code class="nb">do</code>
<code class="linenos">30 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"Wrong:   ~a~%"</code> <code class="nv">data</code><code class="p">)))))</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="c1">;; folowing is derived from test code in CLML:</code>
<code class="linenos">33 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">cancer-data-cluster-example-read-data</code> <code class="p">()</code>
<code class="linenos">34 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">train1</code>
<code class="linenos">35 </code>         <code class="p">(</code><code class="nv">clml.hjs.read-data:read-data-from-file</code>
<code class="linenos">36 </code>          <code class="s">"./machine_learning_data/labeled_cancer_training_data.csv"</code>
<code class="linenos">37 </code>          <code class="ss">:type</code> <code class="ss">:csv</code>
<code class="linenos">38 </code>          <code class="ss">:csv-type-spec</code> <code class="p">(</code><code class="nb">append</code> <code class="p">(</code><code class="nb">make-list</code> <code class="mi">9</code> <code class="ss">:initial-element</code> <code class="ss">'double-float</code><code class="p">)</code>
<code class="linenos">39 </code>                                 <code class="o">'</code><code class="p">(</code><code class="nc">symbol</code><code class="p">))))</code>
<code class="linenos">40 </code>        <code class="p">(</code><code class="nv">test1</code>
<code class="linenos">41 </code>         <code class="p">(</code><code class="nv">clml.hjs.read-data:read-data-from-file</code>
<code class="linenos">42 </code>          <code class="s">"./machine_learning_data/labeled_cancer_test_data.csv"</code>
<code class="linenos">43 </code>          <code class="ss">:type</code> <code class="ss">:csv</code>
<code class="linenos">44 </code>          <code class="ss">:csv-type-spec</code> <code class="p">(</code><code class="nb">append</code> <code class="p">(</code><code class="nb">make-list</code> <code class="mi">9</code> <code class="ss">:initial-element</code> <code class="ss">'double-float</code><code class="p">)</code>
<code class="linenos">45 </code>                                 <code class="o">'</code><code class="p">(</code><code class="nc">symbol</code><code class="p">)))))</code>
<code class="linenos">46 </code>    <code class="c1">;;(print test1)</code>
<code class="linenos">47 </code>    <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nv">cluster-using-k-nn</code> <code class="nv">test1</code> <code class="nv">train1</code> <code class="s">"Class"</code> <code class="ss">:double-manhattan</code><code class="p">))))</code>
<code class="linenos">48 </code>
<code class="linenos">49 </code><code class="p">(</code><code class="nv">cancer-data-cluster-example-read-data</code><code class="p">)</code>
</pre></div>

</figure>

<p>The following listing shows the output from running the last code example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>Number of self-misjudgement : 13
<code class="linenos"> 2 </code>Correct: #(benign 5.0d0 1.0d0 1.0d0 1.0d0 2.0d0 1.0d0 3.0d0 1.0d0 1.0d0 benign)
<code class="linenos"> 3 </code>Correct: #(benign 3.0d0 1.0d0 1.0d0 1.0d0 2.0d0 2.0d0 3.0d0 1.0d0 1.0d0 benign)
<code class="linenos"> 4 </code>Correct: #(benign 4.0d0 1.0d0 1.0d0 3.0d0 2.0d0 1.0d0 3.0d0 1.0d0 1.0d0 benign)
<code class="linenos"> 5 </code>Correct: #(benign 1.0d0 1.0d0 1.0d0 1.0d0 2.0d0 10.0d0 3.0d0 1.0d0 1.0d0 benign)
<code class="linenos"> 6 </code>Correct: #(benign 2.0d0 1.0d0 1.0d0 1.0d0 2.0d0 1.0d0 1.0d0 1.0d0 5.0d0 benign)
<code class="linenos"> 7 </code>Correct: #(benign 1.0d0 1.0d0 1.0d0 1.0d0 1.0d0 1.0d0 3.0d0 1.0d0 1.0d0 benign)
<code class="linenos"> 8 </code>Wrong:   #(benign 5.0d0 3.0d0 3.0d0 3.0d0 2.0d0 3.0d0 4.0d0 4.0d0 1.0d0
<code class="linenos"> 9 </code>           malignant)
<code class="linenos">10 </code>Correct: #(malignant 8.0d0 7.0d0 5.0d0 10.0d0 7.0d0 9.0d0 5.0d0 5.0d0 4.0d0
<code class="linenos">11 </code>           malignant)
<code class="linenos">12 </code>Correct: #(benign 4.0d0 1.0d0 1.0d0 1.0d0 2.0d0 1.0d0 2.0d0 1.0d0 1.0d0 benign)
<code class="linenos">13 </code>Correct: #(malignant 10.0d0 7.0d0 7.0d0 6.0d0 4.0d0 10.0d0 4.0d0 1.0d0 2.0d0
<code class="linenos">14 </code>           malignant)
<code class="linenos">15 </code> ...
</pre></div>

</figure>

<h3 id="leanpub-auto-svm-classification-of-cancer-data-set">SVM Classification of Cancer Data Set</h3>

<p>We will now reuse the same cancer data set but use a different way to classify data into non-malignant and malignant categories: Support Vector Machines (SVM). SVMs are linear classifiers which means that they work best when data is linearly separable. In the case of the cancer data, there are nine dimensions of values that (hopefully) predict one of the two output classes (or categories). If we think of the first 9 columns of data as defining a 9-dimensional space, then SVM will work well when a 8-dimensional hyperplane separates the samples into the two output classes (categories).</p>

<p>To make this simpler to visualize, if we just had two input columns, that defines a two-dimensional space, and if a straight line can separate most of the examples into the two output categories, then the data is linearly separable so SVM is a good technique to use. The SVM algorithm is effectively determining the parameters defining this one-dimensional line (or in the cancer data case, the 9-dimensional hyperspace).</p>

<p>What if data is not linearly separable? Then use the backpropagation neural network code in the chapter “Backpropagation Neural Networks” or the deep learning code in the chapter “Using Armed Bear Common Lisp With DeepLearning4j” to create a model.</p>

<p>SVM is very efficient so it often makes sense to first try SVM and if trained models are not accurate enough then use neural networks, including deep learning.</p>

<p>The following listing of file <em>clml_svm_classifier.lisp</em> shows how to read data, build a model and evaluate the model with different test data. In line 15 we use the function <strong>clml.svm.mu:svm</strong> that requires the type of kernel function to use, the training data, and testing data. Just for reference, we usually use Gaussian kernel functions for processing numeric data and linear kernel functions for handling text in natural language processing applications. Here we use a Gaussian kernel.</p>

<p>The function <strong>cancer-data-svm-example-read-data</strong> defined on line 40 differs from how we read and processed data earlier because we need to separate out the <em>positive</em> and <em>negative</em> training examples. The data is split in the lexically scoped function in lines 42-52. The last block of code in lines 54-82 is just top-level test code that gets executed when the file <em>clml_svm_classifier.lisp</em> is loaded.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; note; run SBCL using: sbcl --dynamic-space-size 2560</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="o">'</code><code class="p">(</code><code class="ss">:clml</code>
<code class="linenos"> 4 </code>                <code class="ss">:clml.hjs</code> <code class="c1">; utilities</code>
<code class="linenos"> 5 </code>                <code class="ss">:clml.svm</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:clml-svm-classifier-example1</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:clml.hjs.read-data</code><code class="p">))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:clml-svm-classifier-example1</code><code class="p">)</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">svm-classifier-test</code> <code class="p">(</code><code class="nv">kernel</code> <code class="nv">train</code> <code class="nv">test</code><code class="p">)</code>
<code class="linenos">13 </code>  <code class="s">"train and test are lists of lists, with first elements being negative</code>
<code class="linenos">14 </code><code class="s">   samples and the second elements being positive samples"</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">decision-function</code> <code class="p">(</code><code class="nv">clml.svm.mu:svm</code> <code class="nv">kernel</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">train</code><code class="p">)</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">train</code><code class="p">)))</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="nv">correct-positives</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="p">(</code><code class="nv">wrong-positives</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">18 </code>        <code class="p">(</code><code class="nv">correct-negatives</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="p">(</code><code class="nv">wrong-negatives</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">20 </code>    <code class="c1">;; type: #&lt;CLOSURE (LAMBDA (CLML.SVM.MU::Z) :IN CLML.SVM.MU::DECISION)&gt;</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">decision-function</code><code class="p">)</code>
<code class="linenos">22 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="s">"***** NEGATIVE TESTS: calling decision function:"</code><code class="p">)</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="nb">terpri</code><code class="p">)</code>
<code class="linenos">24 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">neg</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">test</code><code class="p">))</code>  <code class="c1">;; negative test examples</code>
<code class="linenos">25 </code>      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">prediction</code> <code class="p">(</code><code class="nb">funcall</code> <code class="nv">decision-function</code> <code class="nv">neg</code><code class="p">)))</code>
<code class="linenos">26 </code>        <code class="p">(</code><code class="nb">print</code> <code class="nv">prediction</code><code class="p">)</code>
<code class="linenos">27 </code>        <code class="p">(</code><code class="k">if</code> <code class="nv">prediction</code> <code class="p">(</code><code class="nb">incf</code> <code class="nv">wrong-negatives</code><code class="p">)</code> <code class="p">(</code><code class="nb">incf</code> <code class="nv">correct-negatives</code><code class="p">))))</code>
<code class="linenos">28 </code>    <code class="p">(</code><code class="nb">princ</code> <code class="s">"***** POSITIVE TESTS: calling decision function:"</code><code class="p">)</code>
<code class="linenos">29 </code>    <code class="p">(</code><code class="nb">terpri</code><code class="p">)</code>
<code class="linenos">30 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">pos</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">test</code><code class="p">))</code> <code class="c1">;; positive test examples</code>
<code class="linenos">31 </code>      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">prediction</code> <code class="p">(</code><code class="nb">funcall</code> <code class="nv">decision-function</code> <code class="nv">pos</code><code class="p">)))</code>
<code class="linenos">32 </code>        <code class="p">(</code><code class="nb">print</code> <code class="nv">prediction</code><code class="p">)</code>
<code class="linenos">33 </code>        <code class="p">(</code><code class="k">if</code> <code class="nv">prediction</code> <code class="p">(</code><code class="nb">incf</code> <code class="nv">correct-positives</code><code class="p">)</code> <code class="p">(</code><code class="nb">incf</code> <code class="nv">wrong-positives</code><code class="p">))))</code>
<code class="linenos">34 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"Number of correct negatives ~a~%"</code> <code class="nv">correct-negatives</code><code class="p">)</code>
<code class="linenos">35 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"Number of wrong negatives ~a~%"</code> <code class="nv">wrong-negatives</code><code class="p">)</code>
<code class="linenos">36 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"Number of correct positives ~a~%"</code> <code class="nv">correct-positives</code><code class="p">)</code>
<code class="linenos">37 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"Number of wrong positives ~a~%"</code> <code class="nv">wrong-positives</code><code class="p">)))</code>
<code class="linenos">38 </code>
<code class="linenos">39 </code>
<code class="linenos">40 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">cancer-data-svm-example-read-data</code> <code class="p">()</code>
<code class="linenos">41 </code>
<code class="linenos">42 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">split-positive-negative-cases</code> <code class="p">(</code><code class="nv">data</code><code class="p">)</code>
<code class="linenos">43 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">negative-cases</code> <code class="o">'</code><code class="p">())</code>
<code class="linenos">44 </code>          <code class="p">(</code><code class="nv">positive-cases</code> <code class="o">'</code><code class="p">()))</code>
<code class="linenos">45 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">d</code> <code class="nv">data</code><code class="p">)</code>
<code class="linenos">46 </code>        <code class="c1">;;(print (list "*  d=" d))</code>
<code class="linenos">47 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">symbol-name</code> <code class="p">(</code><code class="nb">first</code> <code class="p">(</code><code class="nb">last</code> <code class="nv">d</code><code class="p">)))</code> <code class="s">"benign"</code><code class="p">)</code>
<code class="linenos">48 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="nv">negative-cases</code>
<code class="linenos">49 </code>                  <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">reverse</code> <code class="p">(</code><code class="nb">cdr</code> <code class="p">(</code><code class="nb">reverse</code> <code class="nv">d</code><code class="p">)))</code> <code class="nv">negative-cases</code><code class="p">))</code>
<code class="linenos">50 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="nv">positive-cases</code>
<code class="linenos">51 </code>                  <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">reverse</code> <code class="p">(</code><code class="nb">cdr</code> <code class="p">(</code><code class="nb">reverse</code> <code class="nv">d</code><code class="p">)))</code> <code class="nv">positive-cases</code><code class="p">))))</code>
<code class="linenos">52 </code>      <code class="p">(</code><code class="nb">list</code> <code class="nv">negative-cases</code> <code class="nv">positive-cases</code><code class="p">)))</code>
<code class="linenos">53 </code>
<code class="linenos">54 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">train1</code>
<code class="linenos">55 </code>          <code class="p">(</code><code class="nv">clml.hjs.read-data:read-data-from-file</code>
<code class="linenos">56 </code>           <code class="s">"./machine_learning_data/labeled_cancer_training_data.csv"</code>
<code class="linenos">57 </code>           <code class="ss">:type</code> <code class="ss">:csv</code>
<code class="linenos">58 </code>           <code class="ss">:csv-type-spec</code> <code class="p">(</code><code class="nb">append</code> <code class="p">(</code><code class="nb">make-list</code> <code class="mi">9</code> <code class="ss">:initial-element</code> <code class="ss">'double-float</code><code class="p">)</code>
<code class="linenos">59 </code>                                  <code class="o">'</code><code class="p">(</code><code class="nc">symbol</code><code class="p">))))</code>
<code class="linenos">60 </code>         <code class="p">(</code><code class="nv">train-as-list</code>
<code class="linenos">61 </code>          <code class="p">(</code><code class="nv">split-positive-negative-cases</code>
<code class="linenos">62 </code>           <code class="p">(</code><code class="nb">coerce</code>
<code class="linenos">63 </code>            <code class="p">(</code><code class="nb">map</code> <code class="ss">'list</code>
<code class="linenos">64 </code>                 <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">coerce</code> <code class="nv">x</code> <code class="ss">'list</code><code class="p">))</code>
<code class="linenos">65 </code>                 <code class="p">(</code><code class="nb">coerce</code> <code class="p">(</code><code class="nv">clml.hjs.read-data:dataset-points</code> <code class="nv">train1</code><code class="p">)</code> <code class="ss">'list</code><code class="p">))</code>
<code class="linenos">66 </code>            <code class="ss">'list</code><code class="p">)))</code>
<code class="linenos">67 </code>         <code class="p">(</code><code class="nv">test1</code>
<code class="linenos">68 </code>          <code class="p">(</code><code class="nv">clml.hjs.read-data:read-data-from-file</code>
<code class="linenos">69 </code>           <code class="s">"./machine_learning_data/labeled_cancer_test_data.csv"</code>
<code class="linenos">70 </code>           <code class="ss">:type</code> <code class="ss">:csv</code>
<code class="linenos">71 </code>           <code class="ss">:csv-type-spec</code> <code class="p">(</code><code class="nb">append</code> <code class="p">(</code><code class="nb">make-list</code> <code class="mi">9</code> <code class="ss">:initial-element</code> <code class="ss">'double-float</code><code class="p">)</code>
<code class="linenos">72 </code>                                  <code class="o">'</code><code class="p">(</code><code class="nc">symbol</code><code class="p">))))</code>
<code class="linenos">73 </code>         <code class="p">(</code><code class="nv">test-as-list</code>
<code class="linenos">74 </code>          <code class="p">(</code><code class="nv">split-positive-negative-cases</code>
<code class="linenos">75 </code>           <code class="p">(</code><code class="nb">coerce</code>
<code class="linenos">76 </code>            <code class="p">(</code><code class="nb">map</code> <code class="ss">'list</code>
<code class="linenos">77 </code>                 <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nb">coerce</code> <code class="nv">x</code> <code class="ss">'list</code><code class="p">))</code>
<code class="linenos">78 </code>                 <code class="p">(</code><code class="nb">coerce</code> <code class="p">(</code><code class="nv">clml.hjs.read-data:dataset-points</code> <code class="nv">test1</code><code class="p">)</code> <code class="ss">'list</code><code class="p">))</code>
<code class="linenos">79 </code>            <code class="ss">'list</code><code class="p">))))</code>
<code class="linenos">80 </code>
<code class="linenos">81 </code>    <code class="c1">;; we will use a gaussian kernel for numeric data.</code>
<code class="linenos">82 </code>    <code class="c1">;; note: for text classification, use a clml.svm.mu:+linear-kernel+</code>
<code class="linenos">83 </code>    <code class="p">(</code><code class="nv">svm-classifier-test</code>
<code class="linenos">84 </code>     <code class="p">(</code><code class="nv">clml.svm.mu:gaussian-kernel</code> <code class="mf">2.0d0</code><code class="p">)</code>
<code class="linenos">85 </code>     <code class="nv">train-as-list</code> <code class="nv">test-as-list</code><code class="p">)))</code>
<code class="linenos">86 </code>
<code class="linenos">87 </code><code class="p">(</code><code class="nv">cancer-data-svm-example-read-data</code><code class="p">)</code>
</pre></div>

</figure>

<p>The sample code prints the prediction values for the test data which I will not show here. Here are the last four lines of output showing the cumulative statistics for the test data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>Number of correct negatives 219
<code class="linenos">2 </code>Number of wrong negatives 4
<code class="linenos">3 </code>Number of correct positives 116
<code class="linenos">4 </code>Number of wrong positives 6
</pre></div>

</figure>

<h3 id="leanpub-auto-clml-wrap-up">CLML Wrap Up</h3>

<p>The CLML machine learning library is under fairly active development and I showed you enough to get started: understanding the data APIs and examples for KNN clustering and SVM classification.</p>

<p>A good alternative to CLML is <a href="https://github.com/melisgl/mgl">MGL</a> that supports backpropagation neural networks, boltzmann machines, and gaussian processes.</p>

<p>In the next two chapters we continue with the topic of machine learning with backpropagation andf Hopfield neural networks.</p>


<h2 id="backprop">Backpropagation Neural Networks</h2>

<p>Let’s start with an overview of how these networks work and then fill in more detail later. Backpropagation networks are trained by applying training inputs to the network input layer, propagate values through the network to the output neurons, compare the errors (or differences) between these propagated output values and the training data output values. These output errors are backpropagated though the network and the magnitude of backpropagated errors are used to adjust the weights in the network.</p>

<p>The example we look at here uses the <strong>plotlib</strong> package from an earlier chapter and the source code for the example is the file <strong>loving_snippet/backprop_neural_network.lisp</strong>.</p>

<p>We will use the following diagram to make this process more clear. There are four weights in this very simple network:</p>

<ul>
  <li>W<sup>1,1</sup> is the floating point number representing the connection strength between input_neuron<sup>1</sup> and output_neuron<sup>1</sup>
</li>
  <li>W<sup>2,1</sup> connects input_neuron<sup>2</sup> to output_neuron<sup>1</sup>
</li>
  <li>W<sup>1,2</sup> connects input_neuron<sup>1</sup> to output_neuron<sup>2</sup>
</li>
  <li>W<sup>2,2</sup> connects input_neuron<sup>2</sup> to output_neuron<sup>2</sup>
</li>
</ul>


<div class="figure-wrapper center">
  <figure class="image" style="width: 217px">
    <img src="images/nn_backprop2d.png" alt="Understanding how connection weights connect neurons in adjacent layers" style="width: 100%">
    <figcaption>Understanding how connection weights connect neurons in adjacent layers</figcaption>
  </figure>
</div>


<p>Before any training the weight values are all small random numbers.</p>

<p>Consider a training data element where the input neurons have values [0.1, 0.9] and the desired output neuron values are [0.9 and 0.1], that is flipping the input values. If the propagated output values for the current weights are [0.85, 0.5] then the value of the first output neuron has a small error abs(0.85 - 0.9) which is 0.05. However the propagated error of the second output neuron is high: abs(0.5 - 0.1) which is 0.4. Informally we see that the weights feeding input output neuron 1 (W<sup>1,1</sup> and W<sup>2,1</sup>) don’t need to be changed much but the neuron that feeding input neuron 2 (W<sup>1,2</sup> and W<sup>2,2</sup>) needs modification (the value of W<sup>2,2</sup> is too large).</p>

<p>Of course, we would never try to manually train a network like this but it is important to have at least an informal understanding of how weights connect the flow of value (we will call this activation value later) between neurons.</p>

<p>In this neural network see in the first figure we have four weights connecting the input and output neurons. Think of these four weights forming a four-dimensional space where the range in each dimension is constrained to small positive and negative floating point values. At any point in this “weight space”, the numeric values of the weights defines a model that maps the inputs to the outputs. The error seen at the output neurons is accumulated for each training example (applied to the input neurons). The training process is finding a point in this four-dimensional space that has low errors summed across the training data. We will use gradient descent to start with a random point in the four-dimensional space (i.e., an initial random set of weights) and move the point towards a local minimum that represents the weights in a model that is (hopefully) “good enough” at representing the training data.</p>

<p>This process is simple enough but there are a few practical considerations:</p>

<ul>
  <li>Sometimes the accumulated error at a local minimum is too large even after many training cycles and it is best to just restart the training process with new random weights.</li>
  <li>If we don’t have enough training data then the network may have enough memory capacity to memorize the training examples. This is not what we want: we want a model with just enough memory capacity (as represented by the number of weights) to form a generalized predictive model, but not so specific that it just memorizes the training examples. The solution is to start with small networks (few hidden neurons) and increase the number of neurons until the training data can be learned. In general, having a lot of training data is good and it is also good to use as small a network as possible.</li>
</ul>

<p>In practice using backpropagation networks is an iterative process of experimenting with the size of a network.</p>

<p>In the example program (in the file <em>backprop_neural_network.lisp</em>) we use the plotting library developed earlier to visualize neuron activation and connecting weight values while the network trains.</p>

<p>The following three screen shots from running the function <strong>test3</strong> defined at the bottom of the file <em>backprop_neural_network.lisp</em> illustrate the process of starting with random weights, getting random outputs during initial training, and as delta weights are used to adjust the weights in a network, then the training examples are learned:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 120px">
    <img src="images/output_plot_000000000000.png" alt="At the start of the training run with random weights and large delta weights" style="width: 100%">
    <figcaption>At the start of the training run with random weights and large delta weights</figcaption>
  </figure>
</div>


<p>In the last figure the initial weights are random so we get random mid-range values at the output neurons.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 120px">
    <img src="images/output_plot_000000000400.png" alt="The trained weights start to produce non-random output" style="width: 100%">
    <figcaption>The trained weights start to produce non-random output</figcaption>
  </figure>
</div>


<p>As we start to train the network, adjusting the weights, we start to see variation in the output neurons as a function of what the inputs are.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 123px">
    <img src="images/output_plot_000000002400.png" alt="After training many cycles the training examples are learned, with only small output errors" style="width: 100%">
    <figcaption>After training many cycles the training examples are learned, with only small output errors</figcaption>
  </figure>
</div>


<p>In the last figure the network is trained sufficiently well to map inputs [0, 0, 0, 1] to output values that are approximately [0.8, 0.2, 0.2, 0.3] which is close to the expected value [1, 0, 0, 0].</p>

<p>The example source file <em>backprop_neural_network.lisp</em> is long so we will only look at the more interesting parts here. Specifically we will not look at the code to plot neural networks using <strong>plotlib</strong>.</p>

<p>The activation values of individual neurons are limited to the range [0, 1] by first calculating their values based on the sum activation values of neurons in the previous layer times the values of the connecting weights and then using the <strong>Sigmoid</strong> function to map the sums to the desired range. The Sigmoid function and the derivative of the <strong>Sigmoid</strong> function (<strong>dSigmoid</strong>) look like:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 288px">
    <img src="images/nn_sigmoid.png" alt="Sigmoid and Derivative of the Sigmid Functions" style="width: 100%">
    <figcaption>Sigmoid and Derivative of the Sigmid Functions</figcaption>
  </figure>
</div>


<p>Here are the definitions of these functions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nb">defun</code> <code class="nv">Sigmoid</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">/</code> <code class="mf">1.0</code> <code class="p">(</code><code class="nb">+</code> <code class="mf">1.0</code> <code class="p">(</code><code class="nb">exp</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">x</code><code class="p">)))))</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">dSigmoid</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">temp</code> <code class="p">(</code><code class="nv">Sigmoid</code> <code class="nv">x</code><code class="p">)))</code>
    <code class="p">(</code><code class="nb">*</code> <code class="nv">temp</code> <code class="p">(</code><code class="nb">-</code> <code class="mf">1.0</code> <code class="nv">temp</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The function <strong>NewDeltaNetwork</strong> creates a new neual network object. This code allocates storage for input, hidden, output layers (I sometimes refer to neuron layers as “slabs”), and the connection weights. Connection weights are initialized to small random values.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">; (NewDeltaNetwork sizeList)</code>
<code class="linenos"> 2 </code><code class="c1">;       Args:   sizeList = list of sizes of slabs. This also defines</code>
<code class="linenos"> 3 </code><code class="c1">;                          the number of slabs in the network.</code>
<code class="linenos"> 4 </code><code class="c1">;                          (e.g.,  '(10 5 4) ==&gt; a 3-slab network with 10</code>
<code class="linenos"> 5 </code><code class="c1">;                           input neurons, 5 hidden neurons, and 4 output</code>
<code class="linenos"> 6 </code><code class="c1">;                           neurons).</code>
<code class="linenos"> 7 </code><code class="c1">;</code>
<code class="linenos"> 8 </code><code class="c1">;       Returned value = a list describing the network:</code>
<code class="linenos"> 9 </code><code class="c1">;          (nLayers sizeList</code>
<code class="linenos">10 </code><code class="c1">;           (activation-array[1] .. activation-array[nLayers])</code>
<code class="linenos">11 </code><code class="c1">;           (weight-array[2] .. weight-array[nLayers])</code>
<code class="linenos">12 </code><code class="c1">;           (sum-of-products[2] .. sum-of-products[nLayers[nLayers])</code>
<code class="linenos">13 </code><code class="c1">;           (back-prop-error[2] .. back-prop-error[nLayers]))</code>
<code class="linenos">14 </code><code class="c1">;           (old-delta-weights[2] .. for momentum term</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>                                       <code class="ss">:initial-element</code> <code class="mf">0.0</code><code class="p">))</code>
<code class="linenos">17 </code>           <code class="p">(</code><code class="nb">reverse</code> <code class="nv">old-dw-list</code><code class="p">)))</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>    <code class="c1">;;</code>
<code class="linenos">20 </code>     <code class="c1">;  Initialize values for all activations:</code>
<code class="linenos">21 </code>     <code class="c1">;;</code>
<code class="linenos">22 </code>    <code class="p">(</code><code class="nb">mapc</code>
<code class="linenos">23 </code>     <code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">24 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">num</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="nv">x</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">25 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n</code> <code class="nv">num</code><code class="p">)</code>
<code class="linenos">26 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">x</code> <code class="nv">n</code><code class="p">)</code> <code class="p">(</code><code class="nv">frandom</code> <code class="mf">0.01</code> <code class="mf">0.1</code><code class="p">)))))</code>
<code class="linenos">27 </code>     <code class="nv">a-list</code><code class="p">)</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code>    <code class="c1">;;</code>
<code class="linenos">30 </code>     <code class="c1">;  Initialize values for all weights:</code>
<code class="linenos">31 </code>     <code class="c1">;;</code>
<code class="linenos">32 </code>    <code class="p">(</code><code class="nb">mapc</code>
<code class="linenos">33 </code>     <code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">34 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">numI</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="nv">x</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">35 </code>              <code class="p">(</code><code class="nv">numJ</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="nv">x</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">36 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">numJ</code><code class="p">)</code>
<code class="linenos">37 </code>            <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">numI</code><code class="p">)</code>
<code class="linenos">38 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">x</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nv">frandom</code> <code class="mf">-0.5</code> <code class="mf">0.5</code><code class="p">))))))</code>
<code class="linenos">39 </code>     <code class="nv">w-list</code><code class="p">)</code>
<code class="linenos">40 </code>    <code class="p">(</code><code class="nb">list</code> <code class="nv">numLayers</code> <code class="nv">sizeList</code> <code class="nv">a-list</code> <code class="nv">s-list</code> <code class="nv">w-list</code> <code class="nv">dw-list</code>
<code class="linenos">41 </code>          <code class="nv">d-list</code> <code class="nv">old-dw-list</code> <code class="nv">alpha</code> <code class="nv">beta</code><code class="p">)))</code>
</pre></div>

</figure>

<p>In the following listing the function <strong>DeltaLearn</strong> processes one pass through all of the training data. Function <strong>DeltaLearn</strong> is called repeatedly until the return value is below a desired error threshold. The main loop over each training example is implemented in lines 69-187. Inside this outer loop there are two phases of training for each training example: a forward pass propagating activation from the input neurons to the output neurons via any hidden layers (lines 87-143) and then the weight correcting backpropagation of output errors while making small adjustments to weights (lines 148-187):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">;;</code>
<code class="linenos">  2 </code> <code class="c1">;  Utility function for training a delta rule neural network.</code>
<code class="linenos">  3 </code> <code class="c1">;  The first argument is the name of an output PNG plot file</code>
<code class="linenos">  4 </code> <code class="c1">;  and a nil value turns off plotting the network during training.</code>
<code class="linenos">  5 </code> <code class="c1">;  The second argument is a network definition (as returned from</code>
<code class="linenos">  6 </code> <code class="c1">;  NewDeltaNetwork), the third argument is a list of training</code>
<code class="linenos">  7 </code> <code class="c1">;  data cases (see the example test functions at the end of this</code>
<code class="linenos">  8 </code> <code class="c1">;  file for examples.</code>
<code class="linenos">  9 </code> <code class="c1">;;</code>
<code class="linenos"> 10 </code>
<code class="linenos"> 11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">DeltaLearn</code> <code class="p">(</code><code class="nv">plot-output-file-name</code>
<code class="linenos"> 12 </code>		   <code class="nv">netList</code> <code class="nv">trainList</code><code class="p">)</code>
<code class="linenos"> 13 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">nLayers</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">netList</code><code class="p">))</code>
<code class="linenos"> 14 </code>        <code class="p">(</code><code class="nv">sizeList</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">netList</code><code class="p">))</code>
<code class="linenos"> 15 </code>        <code class="p">(</code><code class="nv">activationList</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">netList</code><code class="p">))</code>
<code class="linenos"> 16 </code>        <code class="p">(</code><code class="nv">sumOfProductsList</code> <code class="p">(</code><code class="nb">car</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="nv">netList</code><code class="p">)))</code>
<code class="linenos"> 17 </code>        <code class="p">(</code><code class="nv">weightList</code> <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="nv">netList</code><code class="p">)))</code>
<code class="linenos"> 18 </code>        <code class="p">(</code><code class="nv">deltaWeightList</code> <code class="p">(</code><code class="nb">caddr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="nv">netList</code><code class="p">)))</code>
<code class="linenos"> 19 </code>        <code class="p">(</code><code class="nv">deltaList</code> <code class="p">(</code><code class="nb">cadddr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="nv">netList</code><code class="p">)))</code>
<code class="linenos"> 20 </code>        <code class="p">(</code><code class="nv">oldDeltaWeightList</code> <code class="p">(</code><code class="nb">cadddr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">netList</code><code class="p">))))</code>
<code class="linenos"> 21 </code>        <code class="p">(</code><code class="nv">alpha</code> <code class="p">(</code><code class="nb">cadddr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="p">(</code><code class="nb">cddr</code> <code class="nv">netList</code><code class="p">))))</code>
<code class="linenos"> 22 </code>        <code class="p">(</code><code class="nv">beta</code> <code class="p">(</code><code class="nb">cadddr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="nv">netList</code><code class="p">))))</code>
<code class="linenos"> 23 </code>        <code class="p">(</code><code class="nv">inputs</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 24 </code>        <code class="p">(</code><code class="nv">targetOutputs</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 25 </code>        <code class="p">(</code><code class="nv">iDimension</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 26 </code>        <code class="p">(</code><code class="nv">jDimension</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 27 </code>        <code class="p">(</code><code class="nv">iActivationVector</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 28 </code>        <code class="p">(</code><code class="nv">jActivationVector</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 29 </code>        <code class="p">(</code><code class="nv">n</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 30 </code>        <code class="p">(</code><code class="nv">weightArray</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 31 </code>        <code class="p">(</code><code class="nv">sumOfProductsArray</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 32 </code>        <code class="p">(</code><code class="nv">iDeltaVector</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 33 </code>        <code class="p">(</code><code class="nv">jDeltaVector</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 34 </code>        <code class="p">(</code><code class="nv">deltaWeightArray</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 35 </code>        <code class="p">(</code><code class="nv">oldDeltaWeightArray</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 36 </code>        <code class="p">(</code><code class="nv">sum</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 37 </code>        <code class="p">(</code><code class="nv">iSumOfProductsArray</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 38 </code>        <code class="p">(</code><code class="nb">error</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 39 </code>        <code class="p">(</code><code class="nv">outputError</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 40 </code>        <code class="p">(</code><code class="nv">delta</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 41 </code>        <code class="p">(</code><code class="nv">eida</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 42 </code>        <code class="p">(</code><code class="nv">inputNoise</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos"> 43 </code>
<code class="linenos"> 44 </code>    <code class="c1">;;</code>
<code class="linenos"> 45 </code>     <code class="c1">; Zero out deltas:</code>
<code class="linenos"> 46 </code>     <code class="c1">;;</code>
<code class="linenos"> 47 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos"> 48 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">dw</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaList</code><code class="p">))</code>
<code class="linenos"> 49 </code>             <code class="p">(</code><code class="nv">len1</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="nv">dw</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos"> 50 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">len1</code><code class="p">)</code>
<code class="linenos"> 51 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">dw</code> <code class="nv">i</code><code class="p">)</code> <code class="mf">0.0</code><code class="p">))))</code>
<code class="linenos"> 52 </code>
<code class="linenos"> 53 </code>    <code class="c1">;;</code>
<code class="linenos"> 54 </code>     <code class="c1">; Zero out delta weights:</code>
<code class="linenos"> 55 </code>     <code class="c1">;;</code>
<code class="linenos"> 56 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos"> 57 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">dw</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaWeightList</code><code class="p">))</code>
<code class="linenos"> 58 </code>             <code class="p">(</code><code class="nv">len1</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="nv">dw</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos"> 59 </code>             <code class="p">(</code><code class="nv">len2</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="nv">dw</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos"> 60 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">len1</code><code class="p">)</code>
<code class="linenos"> 61 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">len2</code><code class="p">)</code>
<code class="linenos"> 62 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">dw</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="mf">0.0</code><code class="p">)))))</code>
<code class="linenos"> 63 </code>
<code class="linenos"> 64 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">inputNoise</code> <code class="vg">*delta-default-input-noise-value*</code><code class="p">)</code>
<code class="linenos"> 65 </code>
<code class="linenos"> 66 </code>    <code class="c1">;;</code>
<code class="linenos"> 67 </code>     <code class="c1">;  Main loop on training examples:</code>
<code class="linenos"> 68 </code>     <code class="c1">;;</code>
<code class="linenos"> 69 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">tl</code> <code class="nv">trainList</code><code class="p">)</code>
<code class="linenos"> 70 </code>
<code class="linenos"> 71 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">inputs</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">tl</code><code class="p">))</code>
<code class="linenos"> 72 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">targetOutputs</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">tl</code><code class="p">))</code>
<code class="linenos"> 73 </code>
<code class="linenos"> 74 </code>      <code class="p">(</code><code class="k">if</code> <code class="vg">*delta-rule-debug-flag*</code>
<code class="linenos"> 75 </code>        <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"Current targets:"</code> <code class="nv">targetOutputs</code><code class="p">)))</code>
<code class="linenos"> 76 </code>
<code class="linenos"> 77 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">sizeList</code><code class="p">))</code> <code class="c1">; get the size of the input slab</code>
<code class="linenos"> 78 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iActivationVector</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">activationList</code><code class="p">))</code> <code class="c1">; input activations</code>
<code class="linenos"> 79 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code> <code class="c1">; copy training inputs to input slab</code>
<code class="linenos"> 80 </code>        <code class="p">(</code><code class="nb">setf</code>
<code class="linenos"> 81 </code>         <code class="p">(</code><code class="nb">aref</code> <code class="nv">iActivationVector</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos"> 82 </code>         <code class="p">(</code><code class="nb">+</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="nv">inputs</code><code class="p">)</code> <code class="p">(</code><code class="nv">frandom</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">inputNoise</code><code class="p">)</code> <code class="nv">inputNoise</code><code class="p">))))</code>
<code class="linenos"> 83 </code>      <code class="c1">;;</code>
<code class="linenos"> 84 </code>       <code class="c1">; Propagate activation through all of the slabs:</code>
<code class="linenos"> 85 </code>       <code class="c1">;;</code>
<code class="linenos"> 86 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n-1</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">))</code>  <code class="c1">; update layer i to layer flowing to layer j</code>
<code class="linenos"> 87 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">n</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">n-1</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos"> 88 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">jDimension</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">sizeList</code><code class="p">))</code> <code class="c1">; get the size of the j'th layer</code>
<code class="linenos"> 89 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">jActivationVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">activationList</code><code class="p">))</code> <code class="c1">; activation  for slab j</code>
<code class="linenos"> 90 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">weightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n-1</code> <code class="nv">weightList</code><code class="p">))</code>
<code class="linenos"> 91 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">sumOfProductsArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n-1</code> <code class="nv">sumOfProductsList</code><code class="p">))</code>
<code class="linenos"> 92 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code> <code class="c1">; process each neuron in slab j</code>
<code class="linenos"> 93 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nv">sum</code> <code class="mf">0.0</code><code class="p">)</code> <code class="c1">; init sum of products to zero</code>
<code class="linenos"> 94 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code> <code class="c1">; activation from neurons in previous slab</code>
<code class="linenos"> 95 </code>            <code class="p">(</code><code class="k">setq</code>
<code class="linenos"> 96 </code>             <code class="nv">sum</code>
<code class="linenos"> 97 </code>             <code class="p">(</code><code class="nb">+</code> <code class="nv">sum</code> <code class="p">(</code><code class="nb">*</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">weightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">iActivationVector</code> <code class="nv">i</code><code class="p">)))))</code>
<code class="linenos"> 98 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">sumOfProductsArray</code> <code class="nv">j</code><code class="p">)</code> <code class="nv">sum</code><code class="p">)</code> <code class="c1">; save sum of products</code>
<code class="linenos"> 99 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">jActivationVector</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nv">Sigmoid</code> <code class="nv">sum</code><code class="p">)))</code>
<code class="linenos">100 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="nv">jDimension</code><code class="p">)</code>     <code class="c1">; reset index for next slab pair</code>
<code class="linenos">101 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iActivationVector</code> <code class="nv">jActivationVector</code><code class="p">))</code>
<code class="linenos">102 </code>      <code class="c1">;;</code>
<code class="linenos">103 </code>       <code class="c1">; Activation is  spread through the network and sum of products</code>
<code class="linenos">104 </code>       <code class="c1">; calculated. Now modify the weights in the network using back</code>
<code class="linenos">105 </code>       <code class="c1">; error propagation. Start by calculating the error signal for</code>
<code class="linenos">106 </code>       <code class="c1">; each neuron in the output layer:</code>
<code class="linenos">107 </code>       <code class="c1">;;</code>
<code class="linenos">108 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jDimension</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">sizeList</code><code class="p">))</code> <code class="c1">; size of last layer</code>
<code class="linenos">109 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jActivationVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">activationList</code><code class="p">))</code>
<code class="linenos">110 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jDeltaVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">2</code><code class="p">)</code> <code class="nv">deltaList</code><code class="p">))</code>
<code class="linenos">111 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">sumOfProductsArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">2</code><code class="p">)</code> <code class="nv">sumOfProductsList</code><code class="p">))</code>
<code class="linenos">112 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">outputError</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">113 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code>
<code class="linenos">114 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">delta</code> <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">j</code> <code class="nv">targetOutputs</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">jActivationVector</code> <code class="nv">j</code><code class="p">)))</code>
<code class="linenos">115 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">outputError</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">outputError</code> <code class="p">(</code><code class="nb">abs</code> <code class="nv">delta</code><code class="p">)))</code>
<code class="linenos">116 </code>        <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">117 </code>         <code class="p">(</code><code class="nb">aref</code> <code class="nv">jDeltaVector</code> <code class="nv">j</code><code class="p">)</code>
<code class="linenos">118 </code>         <code class="p">(</code><code class="nb">+</code>
<code class="linenos">119 </code>          <code class="p">(</code><code class="nb">aref</code> <code class="nv">jDeltaVector</code> <code class="nv">j</code><code class="p">)</code>
<code class="linenos">120 </code>          <code class="p">(</code><code class="nb">*</code> <code class="nv">delta</code> <code class="p">(</code><code class="nv">dSigmoid</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">sumOfProductsArray</code> <code class="nv">j</code><code class="p">))))))</code>
<code class="linenos">121 </code>      <code class="c1">;;</code>
<code class="linenos">122 </code>       <code class="c1">; Now calculate the backpropagated error signal for all hidden slabs:</code>
<code class="linenos">123 </code>       <code class="c1">;;</code>
<code class="linenos">124 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">nn</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">125 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">n</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">3</code> <code class="nv">nn</code><code class="p">))</code>
<code class="linenos">126 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">n</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">sizeList</code><code class="p">))</code>
<code class="linenos">127 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iSumOfProductsArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">sumOfProductsList</code><code class="p">))</code>
<code class="linenos">128 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iDeltaVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaList</code><code class="p">))</code>
<code class="linenos">129 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code>
<code class="linenos">130 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">iDeltaVector</code> <code class="nv">i</code><code class="p">)</code> <code class="mf">0.0</code><code class="p">))</code>
<code class="linenos">131 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">weightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">n</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">weightList</code><code class="p">))</code>
<code class="linenos">132 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code>
<code class="linenos">133 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nb">error</code> <code class="mf">0.0</code><code class="p">)</code>
<code class="linenos">134 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code>
<code class="linenos">135 </code>            <code class="p">(</code><code class="k">setq</code> <code class="nb">error</code>
<code class="linenos">136 </code>                  <code class="p">(</code><code class="nb">+</code> <code class="nb">error</code> <code class="p">(</code><code class="nb">*</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">jDeltaVector</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">weightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)))))</code>
<code class="linenos">137 </code>          <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">138 </code>           <code class="p">(</code><code class="nb">aref</code> <code class="nv">iDeltaVector</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">139 </code>           <code class="p">(</code><code class="nb">+</code>
<code class="linenos">140 </code>            <code class="p">(</code><code class="nb">aref</code> <code class="nv">iDeltaVector</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">141 </code>            <code class="p">(</code><code class="nb">*</code> <code class="nb">error</code> <code class="p">(</code><code class="nv">dSigmoid</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">iSumOfProductsArray</code> <code class="nv">i</code><code class="p">))))))</code>
<code class="linenos">142 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">jDimension</code> <code class="nv">iDimension</code><code class="p">)</code>
<code class="linenos">143 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">jDeltaVector</code> <code class="nv">iDeltaVector</code><code class="p">))</code>
<code class="linenos">144 </code>
<code class="linenos">145 </code>      <code class="c1">;;</code>
<code class="linenos">146 </code>       <code class="c1">; Update all delta weights in the network:</code>
<code class="linenos">147 </code>       <code class="c1">;;</code>
<code class="linenos">148 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">sizeList</code><code class="p">))</code>
<code class="linenos">149 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">150 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iActivationVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">activationList</code><code class="p">))</code>
<code class="linenos">151 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">jDimension</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">n</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">sizeList</code><code class="p">))</code>
<code class="linenos">152 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">jDeltaVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaList</code><code class="p">))</code>
<code class="linenos">153 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">deltaWeightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaWeightList</code><code class="p">))</code>
<code class="linenos">154 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">weightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">weightList</code><code class="p">))</code>
<code class="linenos">155 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">eida</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">eidaList</code><code class="p">))</code>
<code class="linenos">156 </code>
<code class="linenos">157 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code>
<code class="linenos">158 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code>
<code class="linenos">159 </code>            <code class="p">(</code><code class="k">setq</code> <code class="nv">delta</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">eida</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">jDeltaVector</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">iActivationVector</code> <code class="nv">i</code><code class="p">)))</code>
<code class="linenos">160 </code>            <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">161 </code>             <code class="p">(</code><code class="nb">aref</code> <code class="nv">DeltaWeightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code>
<code class="linenos">162 </code>             <code class="p">(</code><code class="nb">+</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">DeltaWeightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="nv">delta</code><code class="p">))))</code> <code class="c1">; delta weight changes</code>
<code class="linenos">163 </code>
<code class="linenos">164 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="nv">jDimension</code><code class="p">))</code>
<code class="linenos">165 </code>
<code class="linenos">166 </code>    <code class="c1">;;</code>
<code class="linenos">167 </code>     <code class="c1">; Update all weights in the network:</code>
<code class="linenos">168 </code>     <code class="c1">;;</code>
<code class="linenos">169 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">sizeList</code><code class="p">))</code>
<code class="linenos">170 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">171 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iActivationVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">activationList</code><code class="p">))</code>
<code class="linenos">172 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jDimension</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">n</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">sizeList</code><code class="p">))</code>
<code class="linenos">173 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jDeltaVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaList</code><code class="p">))</code>
<code class="linenos">174 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">deltaWeightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">deltaWeightList</code><code class="p">))</code>
<code class="linenos">175 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">oldDeltaWeightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">oldDeltaWeightList</code><code class="p">))</code>
<code class="linenos">176 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">weightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">weightList</code><code class="p">))</code>
<code class="linenos">177 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code>
<code class="linenos">178 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code>
<code class="linenos">179 </code>          <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">180 </code>           <code class="p">(</code><code class="nb">aref</code> <code class="nv">weightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code>
<code class="linenos">181 </code>           <code class="p">(</code><code class="nb">+</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">weightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code>
<code class="linenos">182 </code>              <code class="p">(</code><code class="nb">*</code> <code class="nv">alpha</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">deltaWeightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">))</code>
<code class="linenos">183 </code>              <code class="p">(</code><code class="nb">*</code> <code class="nv">beta</code>  <code class="p">(</code><code class="nb">aref</code> <code class="nv">oldDeltaWeightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">))))</code>
<code class="linenos">184 </code>           <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">oldDeltaWeightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="c1">; save current delta weights</code>
<code class="linenos">185 </code>                 <code class="p">(</code><code class="nb">aref</code> <code class="nv">deltaWeightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">))))</code> <code class="c1">; ...for next momentum term.</code>
<code class="linenos">186 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="nv">jDimension</code><code class="p">))</code>
<code class="linenos">187 </code>
<code class="linenos">188 </code>    <code class="p">(</code><code class="k">if</code> <code class="nv">plot-output-file-name</code>
<code class="linenos">189 </code>        <code class="p">(</code><code class="nv">DeltaPlot</code> <code class="nv">netList</code> <code class="nv">plot-output-file-name</code><code class="p">)))</code>
<code class="linenos">190 </code>
<code class="linenos">191 </code>    <code class="p">(</code><code class="nb">/</code> <code class="nv">outputError</code> <code class="nv">jDimension</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The function <strong>DeltaRecall</strong> in the next listing can be used with a trained network to calculate outputs for new input values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;</code>
<code class="linenos"> 2 </code> <code class="c1">;  Utility for using a trained neural network in the recall mode.</code>
<code class="linenos"> 3 </code> <code class="c1">;  The first argument to this function is a network definition (as</code>
<code class="linenos"> 4 </code> <code class="c1">;  returned from NewDeltaNetwork) and the second argument is a list</code>
<code class="linenos"> 5 </code> <code class="c1">;  of input neuron activation values to drive through the network.</code>
<code class="linenos"> 6 </code> <code class="c1">;  The output is a list of the calculated activation energy for</code>
<code class="linenos"> 7 </code> <code class="c1">;  each output neuron.</code>
<code class="linenos"> 8 </code> <code class="c1">;;</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">DeltaRecall</code> <code class="p">(</code><code class="nv">netList</code> <code class="nv">inputs</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">nLayers</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">netList</code><code class="p">))</code>
<code class="linenos">11 </code>        <code class="p">(</code><code class="nv">sizeList</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">netList</code><code class="p">))</code>
<code class="linenos">12 </code>        <code class="p">(</code><code class="nv">activationList</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">netList</code><code class="p">))</code>
<code class="linenos">13 </code>        <code class="p">(</code><code class="nv">weightList</code> <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">cdddr</code> <code class="nv">netList</code><code class="p">)))</code>
<code class="linenos">14 </code>        <code class="p">(</code><code class="nv">iDimension</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="nv">jDimension</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="nv">iActivationVector</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="p">(</code><code class="nv">jActivationVector</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">18 </code>        <code class="p">(</code><code class="nv">n</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="p">(</code><code class="nv">weightArray</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">20 </code>        <code class="p">(</code><code class="nv">returnList</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos">21 </code>        <code class="p">(</code><code class="nv">sum</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos">22 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">sizeList</code><code class="p">))</code> <code class="c1">; get the size of the input slab</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">iActivationVector</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">activationList</code><code class="p">))</code> <code class="c1">; get input activations</code>
<code class="linenos">24 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code> <code class="c1">; copy training inputs to input slab</code>
<code class="linenos">25 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">iActivationVector</code> <code class="nv">i</code><code class="p">)</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="nv">inputs</code><code class="p">)))</code>
<code class="linenos">26 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n-1</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">nLayers</code> <code class="mi">1</code><code class="p">))</code>  <code class="c1">; update layer j to layer i</code>
<code class="linenos">27 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">n</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">n-1</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">28 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jDimension</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">sizeList</code><code class="p">))</code> <code class="c1">; get the size of the j'th layer</code>
<code class="linenos">29 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">jActivationVector</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n</code> <code class="nv">activationList</code><code class="p">))</code> <code class="c1">; activation for slab j</code>
<code class="linenos">30 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">weightArray</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">n-1</code> <code class="nv">weightList</code><code class="p">))</code>
<code class="linenos">31 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code> <code class="c1">; process each neuron in slab j</code>
<code class="linenos">32 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">sum</code> <code class="mf">0.0</code><code class="p">)</code> <code class="c1">; init sum of products to zero</code>
<code class="linenos">33 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">iDimension</code><code class="p">)</code> <code class="c1">; get activation from each neuron in last slab</code>
<code class="linenos">34 </code>          <code class="p">(</code><code class="k">setq</code>
<code class="linenos">35 </code>           <code class="nv">sum</code>
<code class="linenos">36 </code>           <code class="p">(</code><code class="nb">+</code> <code class="nv">sum</code> <code class="p">(</code><code class="nb">*</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">weightArray</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">iActivationVector</code> <code class="nv">i</code><code class="p">)))))</code>
<code class="linenos">37 </code>        <code class="p">(</code><code class="k">if</code> <code class="vg">*delta-rule-debug-flag*</code>
<code class="linenos">38 </code>          <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"sum="</code> <code class="nv">sum</code><code class="p">)))</code>
<code class="linenos">39 </code>        <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">jActivationVector</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nv">Sigmoid</code> <code class="nv">sum</code><code class="p">)))</code>
<code class="linenos">40 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iDimension</code> <code class="nv">jDimension</code><code class="p">)</code> <code class="c1">; get ready for next slab pair</code>
<code class="linenos">41 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">iActivationVector</code> <code class="nv">jActivationVector</code><code class="p">))</code>
<code class="linenos">42 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">jDimension</code><code class="p">)</code>
<code class="linenos">43 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">returnList</code> <code class="p">(</code><code class="nb">append</code> <code class="nv">returnList</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">jActivationVector</code> <code class="nv">j</code><code class="p">)))))</code>
<code class="linenos">44 </code>      <code class="nv">returnList</code><code class="p">))</code>
</pre></div>

</figure>

<p>We saw three output plots earlier that were produced during a training run using the following code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test3</code> <code class="p">(</code><code class="k">&amp;optional</code> <code class="p">(</code><code class="nc">restart</code> <code class="ss">'yes</code><code class="p">)</code> <code class="k">&amp;aux</code> <code class="nv">RMSerror</code><code class="p">)</code> <code class="c1">; three layer network</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">if</code>
<code class="linenos"> 3 </code>    <code class="p">(</code><code class="nb">equal</code> <code class="nc">restart</code> <code class="ss">'yes</code><code class="p">)</code>
<code class="linenos"> 4 </code>    <code class="p">(</code><code class="k">setq</code> <code class="nv">temp</code> <code class="p">(</code><code class="nv">newdeltanetwork</code> <code class="o">'</code><code class="p">(</code><code class="mi">5</code> <code class="mi">4</code> <code class="mi">5</code><code class="p">))))</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">ii</code> <code class="mi">3000</code><code class="p">)</code>
<code class="linenos"> 6 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">file-name</code>
<code class="linenos"> 7 </code>     <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">mod</code> <code class="nv">ii</code> <code class="mi">400</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 8 </code>         <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"output_plot_"</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~12,'0d"</code> <code class="nv">ii</code><code class="p">)</code> <code class="s">".png"</code><code class="p">)</code>
<code class="linenos"> 9 </code>         <code class="no">nil</code><code class="p">)))</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="k">setq</code>
<code class="linenos">11 </code>       <code class="nv">RMSerror</code>
<code class="linenos">12 </code>       <code class="p">(</code><code class="nv">deltalearn</code>
<code class="linenos">13 </code>          <code class="nv">file-name</code> <code class="nv">temp</code>
<code class="linenos">14 </code>          <code class="o">'</code><code class="p">(((</code><code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">15 </code>            <code class="p">((</code><code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">16 </code>            <code class="p">((</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">17 </code>            <code class="p">((</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code><code class="p">)</code> <code class="p">(</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">18 </code>            <code class="p">((</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code><code class="p">)</code> <code class="p">(</code><code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)))))</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">mod</code> <code class="nv">ii</code> <code class="mi">50</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code> <code class="c1">;; print error out every 50 cycles</code>
<code class="linenos">20 </code>        <code class="p">(</code><code class="k">progn</code>
<code class="linenos">21 </code>          <code class="p">(</code><code class="nb">princ</code> <code class="s">"....training cycle \#"</code><code class="p">)</code>
<code class="linenos">22 </code>          <code class="p">(</code><code class="nb">princ</code> <code class="nv">ii</code><code class="p">)</code>
<code class="linenos">23 </code>          <code class="p">(</code><code class="nb">princ</code> <code class="s">" RMS error = "</code><code class="p">)</code>
<code class="linenos">24 </code>          <code class="p">(</code><code class="nb">princ</code> <code class="nv">RMSerror</code><code class="p">)</code>
<code class="linenos">25 </code>          <code class="p">(</code><code class="nb">terpri</code><code class="p">))))))</code>
</pre></div>

</figure>

<p>Here the function <strong>test3</strong> defines training data for a very small test network for a moderately difficult function to learn: to rotate the values in the input neurons to the right, wrapping around to the first neuron. The start of the main loop in line calls the training function 3000 times, creating a plot of the network every 400 times through the main loop.</p>

<p>Backpropagation networks have been used sucessfully in production for about 25 years. In the next chapter we will look at a less practical type of network, Hopfield networks, that are still interesting because the in some sense Hopfield networks model how our brains work. In the final chapter we will look at deep learning neural networks.</p>


<h2 id="leanpub-auto-hopfield-neural-networks">Hopfield Neural Networks</h2>

<p>A <a href="https://en.wikipedia.org/wiki/Hopfield_network">Hopfield network</a> (named after John Hopfield) is a recurrent network since the flow of activation through the network has loops. These networks are trained by applying input patterns and letting the network settle in a state that stores the input patterns.</p>

<p>The example code is in the file <strong>src/loving_snippets/Hopfield_neural_network.lisp</strong>.</p>

<p>The example we look at recognizes patterns that are similar to the patterns seen in training examples and maps input patterns to a similar training input pattern. The following figure shows output from the example program showing an original training pattern, a similar pattern with one cell turned on and other off, and the reconstructed pattern:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 274px">
    <img src="images/output_plot_hopfield_nn_00002.png" alt="" style="width: 100%">
    <figcaption></figcaption>
  </figure>
</div>


<p>To be clear, we have taken one of the original input patterns the network has learned, slightly altered it, and applied it as input to the network. After cycling the network, the slightly scrambled input pattern we just applied will be used as an associative memory key, look up the original pattern, and rewrite to input values with the original learned pattern. These Hopfield networks are very different than backpropagation networks: neuron activation are forced to values of -1 or +1 and not be differentiable and there are no separate output neurons.</p>

<p>The next example has the values of three cells modified from the original and the original pattern is still reconstructed correctly:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 274px">
    <img src="images/output_plot_hopfield_nn_00005.png" alt="" style="width: 100%">
    <figcaption></figcaption>
  </figure>
</div>


<p>This last example has four of the original cells modified:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 270px">
    <img src="images/output_plot_hopfield_nn_00007.png" alt="" style="width: 100%">
    <figcaption></figcaption>
  </figure>
</div>


<p>The following example program shows a type of content-addressable memory. After a Hopfield network learns a set of input patterns then it can reconstruct the original paterns when shown similar patterns. This reconstruction is not always perfecrt.</p>

<p>The following function <strong>Hopfield-Init</strong> (in file <em>Hopfield_neural_network.lisp</em>) is passed a list of lists of training examples that will be remembered in the network.  This function returns a list containing the data defining a Hopfield neural network. All data for the network is encapsulated in the list returned by this function, so multiple Hopfield neural networks can be used in an application program.</p>

<p>In lines 9-12 we allocate global arrays for data storage and in lines 14-18 the training data is copied.</p>

<p>The inner function <strong>adjustInput</strong> on lines 20-29 adjusts data values to values of -1.0 or +1.0. In lines 31-33 we are initializing all of the weights in the Hopfield network to zero.</p>

<p>The last nested loop, on lines 35-52, calculates the autocorrelation weight matrix from the input test patterns.</p>

<p>On lines 54-56, the function returns a representation of the Hopfield network that will be used later in the function <strong>HopfieldNetRecall</strong> to find the most similar “remembered” pattern given a new (fresh) input pattern.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">Hopfield-Init</code> <code class="p">(</code><code class="nv">training-data</code>
<code class="linenos"> 2 </code>                      <code class="k">&amp;aux</code> <code class="nv">temp</code> <code class="vg">*num-inputs*</code> <code class="vg">*num-training-examples*</code>
<code class="linenos"> 3 </code>                           <code class="vg">*training-list*</code> <code class="vg">*inputCells*</code> <code class="vg">*tempStorage*</code>
<code class="linenos"> 4 </code>                           <code class="vg">*HopfieldWeights*</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="k">setq</code> <code class="vg">*num-inputs*</code> <code class="p">(</code><code class="nb">length</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">training-data</code><code class="p">)))</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">setq</code> <code class="vg">*num-training-examples*</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">training-data</code><code class="p">))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="k">setq</code> <code class="vg">*training-list*</code> <code class="p">(</code><code class="nb">make-array</code> <code class="p">(</code><code class="nb">list</code> <code class="vg">*num-training-examples*</code> <code class="vg">*num-inputs*</code><code class="p">)))</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="k">setq</code> <code class="vg">*inputCells*</code> <code class="p">(</code><code class="nb">make-array</code> <code class="p">(</code><code class="nb">list</code> <code class="vg">*num-inputs*</code><code class="p">)))</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="k">setq</code> <code class="vg">*tempStorage*</code> <code class="p">(</code><code class="nb">make-array</code> <code class="p">(</code><code class="nb">list</code> <code class="vg">*num-inputs*</code><code class="p">)))</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="k">setq</code> <code class="vg">*HopfieldWeights*</code> <code class="p">(</code><code class="nb">make-array</code> <code class="p">(</code><code class="nb">list</code> <code class="vg">*num-inputs*</code> <code class="vg">*num-inputs*</code><code class="p">)))</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="vg">*num-training-examples*</code><code class="p">)</code> <code class="c1">;; copy training data</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="vg">*num-inputs*</code><code class="p">)</code>
<code class="linenos">16 </code>      <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">17 </code>       <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">j</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">18 </code>       <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">j</code> <code class="nv">training-data</code><code class="p">)))))</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">adjustInput</code> <code class="p">(</code><code class="nv">value</code><code class="p">)</code>  <code class="c1">;; this function is lexically scoped</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&lt;</code> <code class="nv">value</code> <code class="mf">0.1</code><code class="p">)</code>
<code class="linenos">22 </code>      <code class="mf">-1.0</code>
<code class="linenos">23 </code>      <code class="mf">+1.0</code><code class="p">))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="vg">*num-inputs*</code><code class="p">)</code> <code class="c1">;; adjust training data</code>
<code class="linenos">26 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">n</code> <code class="vg">*num-training-examples*</code><code class="p">)</code>
<code class="linenos">27 </code>      <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">28 </code>       <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">n</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">29 </code>       <code class="p">(</code><code class="nv">adjustInput</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">n</code> <code class="nv">i</code><code class="p">)))))</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code>  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="vg">*num-inputs*</code><code class="p">)</code> <code class="c1">;; zero weights</code>
<code class="linenos">32 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="vg">*num-inputs*</code><code class="p">)</code>
<code class="linenos">33 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*HopfieldWeights*</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code>  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j-1</code> <code class="p">(</code><code class="nb">-</code> <code class="vg">*num-inputs*</code> <code class="mi">1</code><code class="p">))</code> <code class="c1">;; autocorrelation weight matrix</code>
<code class="linenos">36 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">j</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">j-1</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">37 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">j</code><code class="p">)</code>
<code class="linenos">38 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">s</code> <code class="vg">*num-training-examples*</code><code class="p">)</code>
<code class="linenos">39 </code>          <code class="p">(</code><code class="k">setq</code> <code class="nv">temp</code>
<code class="linenos">40 </code>                <code class="p">(</code><code class="nb">truncate</code>
<code class="linenos">41 </code>                 <code class="p">(</code><code class="nb">+</code>
<code class="linenos">42 </code>                  <code class="p">(</code><code class="nb">*</code>  <code class="c1">;; 2 if's truncate values to -1 or 1:</code>
<code class="linenos">43 </code>                   <code class="p">(</code><code class="nv">adjustInput</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">s</code> <code class="nv">i</code><code class="p">))</code>
<code class="linenos">44 </code>                   <code class="p">(</code><code class="nv">adjustInput</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">s</code> <code class="nv">j</code><code class="p">)))</code>
<code class="linenos">45 </code>                  <code class="p">(</code><code class="nb">aref</code> <code class="vg">*HopfieldWeights*</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">))))</code>
<code class="linenos">46 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*HopfieldWeights*</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)</code> <code class="nv">temp</code><code class="p">)</code>
<code class="linenos">47 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*HopfieldWeights*</code> <code class="nv">j</code> <code class="nv">i</code><code class="p">)</code> <code class="nv">temp</code><code class="p">)))))</code>
<code class="linenos">48 </code>  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="vg">*num-inputs*</code><code class="p">)</code>
<code class="linenos">49 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*tempStorage*</code> <code class="nv">i</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">50 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">51 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*tempStorage*</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">52 </code>            <code class="p">(</code><code class="nb">+</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*tempStorage*</code> <code class="nv">i</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*HopfieldWeights*</code> <code class="nv">i</code> <code class="nv">j</code><code class="p">)))))</code>
<code class="linenos">53 </code>
<code class="linenos">54 </code>  <code class="p">(</code><code class="nb">list</code> <code class="c1">;; return the value of the Hopfield network data object</code>
<code class="linenos">55 </code>   <code class="vg">*num-inputs*</code> <code class="vg">*num-training-examples*</code> <code class="vg">*training-list*</code>
<code class="linenos">56 </code>   <code class="vg">*inputCells*</code> <code class="vg">*tempStorage*</code> <code class="vg">*HopfieldWeights*</code><code class="p">))</code>
</pre></div>

</figure>

<p>The following function <strong>HopfieldNetRecall</strong> iterates the network to let it settle in a stable pattern
which we hope will be the original training pattern most closely resembling the noisy test pattern.</p>

<p>The inner (lexically scoped) function <strong>deltaEnergy</strong> defined on lines 9-12 calculates
a change in energy from old input values and the autocorrelation weight matrix.
The main code uses the inner functions 
to iterate over the input cells, possibly modifying the cell at index <strong>i</strong> delta energy is greater than zero. Remember that the lexically scoped inner functions have access to the variables for the number of inputs, the number of training examples, the list of training examples, 
the input cell values, tempoary storage, and the Hopfield network weights.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">HopfieldNetRecall</code> <code class="p">(</code><code class="nv">aHopfieldNetwork</code> <code class="nv">numberOfIterations</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="vg">*num-inputs*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">0</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos"> 3 </code>        <code class="p">(</code><code class="vg">*num-training-examples*</code>  <code class="p">(</code><code class="nb">nth</code> <code class="mi">1</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos"> 4 </code>        <code class="p">(</code><code class="vg">*training-list*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">2</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos"> 5 </code>        <code class="p">(</code><code class="vg">*inputCells*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">3</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos"> 6 </code>        <code class="p">(</code><code class="vg">*tempStorage*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">4</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos"> 7 </code>        <code class="p">(</code><code class="vg">*HopfieldWeights*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">5</code> <code class="nv">aHopfieldNetwork</code><code class="p">)))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="nb">defun</code> <code class="nv">deltaEnergy</code> <code class="p">(</code><code class="nv">row-index</code> <code class="nv">y</code> <code class="k">&amp;aux</code> <code class="p">(</code><code class="nv">temp</code> <code class="mf">0.0</code><code class="p">))</code>  <code class="c1">;; lexically scoped</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="vg">*num-inputs*</code><code class="p">)</code>
<code class="linenos">11 </code>        <code class="p">(</code><code class="k">setq</code> <code class="nv">temp</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">temp</code> <code class="p">(</code><code class="nb">*</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*HopfieldWeights*</code> <code class="nv">row-index</code> <code class="nv">j</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">y</code> <code class="nv">j</code><code class="p">)))))</code>
<code class="linenos">12 </code>      <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">*</code> <code class="mf">2.0</code> <code class="nv">temp</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*tempStorage*</code> <code class="nv">row-index</code><code class="p">)))</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>    <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">ii</code> <code class="nv">numberOfIterations</code><code class="p">)</code> <code class="c1">;; main code</code>
<code class="linenos">15 </code>      <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="vg">*num-inputs*</code><code class="p">)</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*inputCells*</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">17 </code>              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nv">deltaEnergy</code> <code class="nv">i</code> <code class="vg">*inputCells*</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">18 </code>                  <code class="mi">1</code>
<code class="linenos">19 </code>                  <code class="mi">0</code><code class="p">))))))</code>
</pre></div>

</figure>

<p>Function <strong>test</strong> in the next listing uses three different patterns for each test. Note that only the last pattern gets plotted to the output graphics PNG file for the purpose of producing figures for this chapter. If you want to produce plots of other patterns, edit just the third pattern defined on line AAAAA. The following plotting functions are inner lexically scoped so they have access to the data defined in the enclosing <strong>let</strong> expression in lines 16-21:</p>

<ul>
  <li>
<strong>plotExemplar</strong> - plots a vector of data</li>
  <li>
<strong>plot-original-inputCells</strong> - plots the original input cells from training data</li>
  <li>
<strong>plot-inputCells</strong> - plots the modified input cells (a few cells randomly flipped in value)</li>
  <li>
<strong>modifyInput</strong> - scrambles training inputs</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test</code> <code class="p">(</code><code class="k">&amp;aux</code> <code class="nv">aHopfieldNetwork</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">tdata</code> <code class="o">'</code><code class="p">(</code>  <code class="c1">;; sample sine wave data with different periods:</code>
<code class="linenos"> 3 </code>                 <code class="p">(</code><code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 4 </code>                 <code class="p">(</code><code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 5 </code>                 <code class="p">(</code><code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mi">0</code> <code class="mi">1</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos"> 6 </code>        <code class="p">(</code><code class="nv">width</code> <code class="mi">300</code><code class="p">)</code>
<code class="linenos"> 7 </code>        <code class="p">(</code><code class="nv">height</code> <code class="mi">180</code><code class="p">))</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nv">vecto::with-canvas</code> <code class="p">(</code><code class="ss">:width</code> <code class="nv">width</code> <code class="ss">:height</code> <code class="nv">height</code><code class="p">)</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="nv">plotlib:plot-string-bold</code> <code class="mi">10</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="mi">14</code><code class="p">)</code> <code class="s">"Hopfield pattern classifier"</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>      <code class="c1">;; Set up network:</code>
<code class="linenos">12 </code>      <code class="p">(</code><code class="nb">print</code> <code class="nv">tdata</code><code class="p">)</code>
<code class="linenos">13 </code>      <code class="p">(</code><code class="k">setq</code> <code class="nv">aHopfieldNetwork</code> <code class="p">(</code><code class="nv">Hopfield-Init</code> <code class="nv">tdata</code><code class="p">))</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>      <code class="c1">;; lexically scoped variables are accesible by inner functions:</code>
<code class="linenos">16 </code>      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="vg">*num-inputs*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">0</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos">17 </code>            <code class="p">(</code><code class="vg">*num-training-examples*</code>  <code class="p">(</code><code class="nb">nth</code> <code class="mi">1</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos">18 </code>            <code class="p">(</code><code class="vg">*training-list*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">2</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos">19 </code>            <code class="p">(</code><code class="vg">*inputCells*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">3</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos">20 </code>            <code class="p">(</code><code class="vg">*tempStorage*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">4</code> <code class="nv">aHopfieldNetwork</code><code class="p">))</code>
<code class="linenos">21 </code>            <code class="p">(</code><code class="vg">*HopfieldWeights*</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">5</code> <code class="nv">aHopfieldNetwork</code><code class="p">)))</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>        <code class="p">(</code><code class="nb">defun</code> <code class="nv">plotExemplar</code> <code class="p">(</code><code class="nv">row</code> <code class="k">&amp;aux</code> <code class="p">(</code><code class="nv">dmin</code> <code class="mf">0.0</code><code class="p">)</code> <code class="p">(</code><code class="nv">dmax</code> <code class="mf">1.0</code><code class="p">)</code> <code class="p">(</code><code class="nv">x</code> <code class="mi">20</code><code class="p">)</code> <code class="p">(</code><code class="nv">y</code> <code class="mi">40</code><code class="p">))</code>
<code class="linenos">24 </code>          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">YSize</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="vg">*training-list*</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">25 </code>            <code class="p">(</code><code class="nv">plotlib:plot-string</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="mi">20</code><code class="p">)</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">y</code> <code class="mi">10</code><code class="p">))</code>
<code class="linenos">26 </code>                                 <code class="s">"Original Training Exemplar"</code><code class="p">)</code>
<code class="linenos">27 </code>            <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">Ysize</code><code class="p">)</code>
<code class="linenos">28 </code>              <code class="p">(</code><code class="nv">plotlib:plot-fill-rect</code>
<code class="linenos">29 </code>               <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">j</code> <code class="nv">plot-size+1</code><code class="p">))</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="nv">y</code><code class="p">)</code> <code class="nv">plot-size</code> <code class="nv">plot-size</code>
<code class="linenos">30 </code>               <code class="p">(</code><code class="nb">truncate</code> <code class="p">(</code><code class="nb">*</code>
<code class="linenos">31 </code>                           <code class="p">(</code><code class="nb">/</code>  <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">row</code> <code class="nv">j</code><code class="p">)</code> <code class="nv">dmin</code><code class="p">)</code>
<code class="linenos">32 </code>                               <code class="p">(</code><code class="nb">-</code> <code class="nv">dmax</code> <code class="nv">dmin</code><code class="p">))</code>
<code class="linenos">33 </code>                           <code class="mi">5</code><code class="p">)))</code>
<code class="linenos">34 </code>              <code class="p">(</code><code class="nv">plotlib:plot-frame-rect</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">j</code> <code class="nv">plot-size+1</code><code class="p">))</code>
<code class="linenos">35 </code>                                       <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="nv">y</code><code class="p">)</code> <code class="nv">plot-size</code> <code class="nv">plot-size</code><code class="p">))))</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code>        <code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-original-inputCells</code> <code class="p">(</code><code class="k">&amp;aux</code> <code class="p">(</code><code class="nv">dmin</code> <code class="mf">0.0</code><code class="p">)</code> <code class="p">(</code><code class="nv">dmax</code> <code class="mf">1.0</code><code class="p">)</code> <code class="p">(</code><code class="nv">x</code> <code class="mi">20</code><code class="p">)</code> <code class="p">(</code><code class="nv">y</code> <code class="mi">80</code><code class="p">))</code>
<code class="linenos">38 </code>          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">Xsize</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="vg">*inputCells*</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">39 </code>            <code class="p">(</code><code class="nv">plotlib:plot-string</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="mi">20</code><code class="p">)</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">y</code> <code class="mi">10</code><code class="p">))</code> <code class="s">"Scrambled Inputs"</code><code class="p">)</code>
<code class="linenos">40 </code>            <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">Xsize</code><code class="p">)</code>
<code class="linenos">41 </code>              <code class="p">(</code><code class="nv">plotlib:plot-fill-rect</code>
<code class="linenos">42 </code>               <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">j</code> <code class="nv">plot-size+1</code><code class="p">))</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="nv">y</code><code class="p">)</code> <code class="nv">plot-size</code> <code class="nv">plot-size</code>
<code class="linenos">43 </code>               <code class="p">(</code><code class="nb">truncate</code> <code class="p">(</code><code class="nb">*</code>
<code class="linenos">44 </code>                           <code class="p">(</code><code class="nb">/</code>  <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*inputCells*</code> <code class="nv">j</code><code class="p">)</code> <code class="nv">dmin</code><code class="p">)</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">dmax</code> <code class="nv">dmin</code><code class="p">))</code>
<code class="linenos">45 </code>                           <code class="mi">5</code><code class="p">)))</code>
<code class="linenos">46 </code>              <code class="p">(</code><code class="nv">plotlib:plot-frame-rect</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">j</code> <code class="nv">plot-size+1</code><code class="p">))</code>
<code class="linenos">47 </code>                                       <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="nv">y</code><code class="p">)</code> <code class="nv">plot-size</code> <code class="nv">plot-size</code><code class="p">))))</code>
<code class="linenos">48 </code>
<code class="linenos">49 </code>        <code class="p">(</code><code class="nb">defun</code> <code class="nv">plot-inputCells</code> <code class="p">(</code><code class="k">&amp;aux</code> <code class="p">(</code><code class="nv">dmin</code> <code class="mf">0.0</code><code class="p">)</code> <code class="p">(</code><code class="nv">dmax</code> <code class="mf">1.0</code><code class="p">)</code> <code class="p">(</code><code class="nv">x</code> <code class="mi">20</code><code class="p">)</code> <code class="p">(</code><code class="nv">y</code> <code class="mi">120</code><code class="p">))</code>
<code class="linenos">50 </code>          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">Xsize</code> <code class="p">(</code><code class="nb">array-dimension</code> <code class="vg">*inputCells*</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">51 </code>            <code class="p">(</code><code class="nv">plotlib:plot-string</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="mi">20</code><code class="p">)</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">y</code> <code class="mi">10</code><code class="p">))</code>
<code class="linenos">52 </code>                                 <code class="s">"Reconstructed Inputs"</code><code class="p">)</code>
<code class="linenos">53 </code>            <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">j</code> <code class="nv">Xsize</code><code class="p">)</code>
<code class="linenos">54 </code>              <code class="p">(</code><code class="nv">plotlib:plot-fill-rect</code>
<code class="linenos">55 </code>               <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">j</code> <code class="nv">plot-size+1</code><code class="p">))</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="nv">y</code><code class="p">)</code> <code class="nv">plot-size</code> <code class="nv">plot-size</code>
<code class="linenos">56 </code>               <code class="p">(</code><code class="nb">truncate</code> <code class="p">(</code><code class="nb">*</code> <code class="p">(</code><code class="nb">/</code>
<code class="linenos">57 </code>                             <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*inputCells*</code> <code class="nv">j</code><code class="p">)</code> <code class="nv">dmin</code><code class="p">)</code>
<code class="linenos">58 </code>                             <code class="p">(</code><code class="nb">-</code> <code class="nv">dmax</code> <code class="nv">dmin</code><code class="p">))</code>
<code class="linenos">59 </code>                            <code class="mi">5</code><code class="p">)))</code>
<code class="linenos">60 </code>              <code class="p">(</code><code class="nv">plotlib:plot-frame-rect</code>
<code class="linenos">61 </code>                 <code class="p">(</code><code class="nb">+</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">*</code> <code class="nv">j</code> <code class="nv">plot-size+1</code><code class="p">))</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">height</code> <code class="nv">y</code><code class="p">)</code> <code class="nv">plot-size</code> <code class="nv">plot-size</code><code class="p">))))</code>
<code class="linenos">62 </code>
<code class="linenos">63 </code>        <code class="p">(</code><code class="nb">defun</code> <code class="nv">modifyInput</code> <code class="p">(</code><code class="nv">arrSize</code> <code class="nv">arr</code><code class="p">)</code>  <code class="c1">;; modify input array for testing</code>
<code class="linenos">64 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="nv">arrSize</code><code class="p">)</code>
<code class="linenos">65 </code>            <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&lt;</code> <code class="p">(</code><code class="nb">random</code> <code class="mi">50</code><code class="p">)</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">66 </code>                <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">arr</code> <code class="nv">i</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">67 </code>                    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">arr</code> <code class="nv">i</code><code class="p">)</code> <code class="mi">-1</code><code class="p">)</code>
<code class="linenos">68 </code>                    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="nv">arr</code> <code class="nv">i</code><code class="p">)</code> <code class="mi">1</code><code class="p">)))))</code>
<code class="linenos">69 </code>
<code class="linenos">70 </code>        <code class="c1">;; Test network on training data that is randomly modified:</code>
<code class="linenos">71 </code>
<code class="linenos">72 </code>        <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">iter</code> <code class="mi">10</code><code class="p">)</code> <code class="c1">;; cycle 10 times and make 10 plots</code>
<code class="linenos">73 </code>          <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">s</code> <code class="vg">*num-training-examples*</code><code class="p">)</code>
<code class="linenos">74 </code>            <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="vg">*num-inputs*</code><code class="p">)</code>
<code class="linenos">75 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*inputCells*</code> <code class="nv">i</code><code class="p">)</code> <code class="p">(</code><code class="nb">aref</code> <code class="vg">*training-list*</code> <code class="nv">s</code> <code class="nv">i</code><code class="p">)))</code>
<code class="linenos">76 </code>            <code class="p">(</code><code class="nv">plotExemplar</code> <code class="nv">s</code><code class="p">)</code>
<code class="linenos">77 </code>            <code class="p">(</code><code class="nv">modifyInput</code> <code class="vg">*num-inputs*</code> <code class="vg">*inputCells*</code><code class="p">)</code>
<code class="linenos">78 </code>            <code class="p">(</code><code class="nv">plot-original-inputCells</code><code class="p">)</code>
<code class="linenos">79 </code>            <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">call-net</code> <code class="mi">5</code><code class="p">)</code> <code class="c1">;; iterate Hopfield net 5 times</code>
<code class="linenos">80 </code>              <code class="p">(</code><code class="nv">HopfieldNetRecall</code> <code class="nv">aHopfieldNetwork</code> <code class="mi">1</code><code class="p">)</code>  <code class="c1">;; calling with 1 iteration</code>
<code class="linenos">81 </code>              <code class="p">(</code><code class="nv">plot-inputCells</code><code class="p">)))</code>
<code class="linenos">82 </code>
<code class="linenos">83 </code>          <code class="p">(</code><code class="nv">vecto::save-png</code>
<code class="linenos">84 </code>           <code class="p">(</code><code class="nb">concatenate</code>
<code class="linenos">85 </code>            <code class="ss">'string</code>
<code class="linenos">86 </code>            <code class="s">"output_plot_hopfield_nn_"</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~5,'0d"</code> <code class="nv">iter</code><code class="p">)</code> <code class="s">".png"</code><code class="p">)))))))</code>
</pre></div>

</figure>

<p>The plotting functions in lines 23-62 use the <em>plotlib</em> library to make the plots you saw earlier. The function <strong>modifyInput</strong> in lines 64-69 randomly flips the values of the input cells, taking an original pattern and slightly modifying it.</p>

<p>Hopfield neural networks, at least to some extent, seem to model some aspects of human brains in the sense that they can function as content-addressable (also called associative) memories. Ideally a partial input pattern from a remembered input can reconstruct the complete original pattern. Another interesting feature of Hopfield networks is that these memories really are stored in a distributed fashion: some of the weights can be randomly altered and patterns are still remembered, but with more recall errors.</p>


<h2 id="leanpub-auto-using-python-deep-learning-models-in-common-lisp-with-a-web-services-interface">Using Python Deep Learning Models In Common Lisp With a Web Services Interface</h2>

<p>In older editions of this book I had an example of using the Java DeepLearning4J deep learning library using Armed Bear Common Lisp, implemented in Java. I no longer use hybrid Java and Common Lisp applications in my own work and I decided to remove this example and replace it with two projects that use simple Python web services that act as wrappers for state of the art deep learning models with Common Lisp clients in the subdirectories:</p>

<ul>
  <li>
<strong>src/spacy_web_client</strong>: use the spaCy deep learning models for general NLP. I sometimes use my own pure Common Lisp NLP libraries we saw in earlier chapters and sometimes I use a Common Lisp client calling deep learning libraries like spaCy and TensorFlow.</li>
  <li>
<strong>src/coref_web_client</strong>: coreference or anaphora resolution is the act of replacing pronouns in text with the original nouns that they refer to. This has traditionally been a very difficult and only partially solved problem until recent advances in deep learning models like BERT.</li>
</ul>

<p>Note: in the next chapter we will cover similar functionality but we will use the <strong>py4cl</strong> library to more directly use Python and libraries like spaCy by starting another Python process and using streams for communication.</p>

<h3 id="leanpub-auto-setting-up-the-python-web-services-used-in-this-chapter">Setting up the Python Web Services Used in this Chapter</h3>

<p>You will need python and pip installed on your system. The source e code for the Python web services is found in the directory <strong>loving-common-lisp/python</strong>.</p>

<h3 id="leanpub-auto-installing-the-spacy-nlp-services">Installing the spaCY NLP Services</h3>

<p>I assume that you have some familiarity with using Python. If not, you will still be able to follow these directions assuming that you have the utilities <strong>pip</strong>, and <strong>python</strong> installed. I recommend installing Python and Pip using <a href="https://anaconda.org/anaconda/conda">Anaconda</a>.</p>

<p>The server code is in the subdirectory <strong>python/python_spacy_nlp_server</strong> where you will work when performing a one time initialization. After the server is installed you can then run it from the command line from any directory on your laptop.</p>

<p>I recommend that you use virtual Python environments when using Python applications to separate the dependencies required for each application or development project. Here I assume that you are running in a Python version 3.6 or higher environment. First you must install the dependencies:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">pip</code> <code class="n">install</code> <code class="o">-</code><code class="n">U</code> <code class="n">spacy</code>
<code class="linenos">2 </code><code class="n">python</code> <code class="o">-</code><code class="n">m</code> <code class="n">spacy</code> <code class="n">download</code> <code class="n">en</code>
<code class="linenos">3 </code><code class="n">pip</code> <code class="n">install</code> <code class="n">falcon</code>
</pre></div>

</figure>

<p>Then change directory to the subdirectory <strong>python/python_spacy_nlp_server</strong> in the git repo for this book and install the NLP server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>cd python/python_spacy_nlp_server
<code class="linenos">2 </code>python setup.py install
</pre></div>

</figure>

<p>Once you install the server, you can run it from any directory on your laptop or server using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>spacynlpserver
</pre></div>

</figure>

<p>I use deep learning models written in Python using TensorFlow or PyTorch and provide Python web services  that can be used in applications I write in Haskell or Common Lisp using web client interfaces for the services written in Python. While it is possible to directly embed models in Haskell and Common Lisp, I find it much easier and developer friendly to wrap deep learning models I use a REST services as I have done here. Often deep learning models only require about a gigabyte of memory and using pre-trained models has lightweight CPU resource needs so while I am developing on my laptop I might have two or three models running and available as wrapped REST services. For production, I configure both the Python services and my Haskell and Common Lisp applications to start automatically on system startup.</p>

<p>This is not a Python programming book and I will not discuss the simple Python wrapping code but if you are also a Python developer you can easily read and understand the code.</p>

<h3 id="leanpub-auto-installing-the-coreference-nlp-services">Installing the Coreference NLP Services</h3>

<p>I recommend that you use virtual Python environments when using Python applications to separate the dependencies required for each application or development project. Here I assume that you are running in a Python version 3.6 environment. First you should install the dependencies:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>pip install spacy==2.1.0
<code class="linenos">2 </code>pip install neuralcoref 
<code class="linenos">3 </code>pip install falcon
</pre></div>

</figure>

<p>As I write this chapter the <em>neuralcoref</em> model and library require a slightly older version of SpaCy (the current latest version is 2.1.4).</p>

<p>Then change directory to the subdirectory <strong>python/python_coreference_anaphora_resolution_server</strong> in the git repo for this book and install the coref server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>cd python_coreference_anaphora_resolution_server
<code class="linenos">2 </code>python setup.py install
</pre></div>

</figure>

<p>Once you install the server, you can run it from any directory on your laptop or server using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>corefserver
</pre></div>

</figure>

<p>While. as we saw in the last example, it is possible to directly embed models in Haskell and Common Lisp, I find it much easier and developer friendly to wrap deep learning models I use a REST services as I have done here. Often deep learning models only require about a gigabyte of memory and using pre-trained models has lightweight CPU resource needs so while I am developing on my laptop I might have two or three models running and available as wrapped REST services. For production, I configure both the Python services and my Haskell and Common Lisp applications to start automatically on system startup.</p>

<p>This is not a Python programming book and I will not discuss the simple Python wrapping code but if you are also a Python developer you can easily read and understand the code.</p>

<h3 id="leanpub-auto-common-lisp-client-for-the-spacy-nlp-web-services">Common Lisp Client for the spaCy NLP Web Services</h3>

<p>Before looking at the code, I will show you typical output from running this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">sbcl</code>          
<code class="linenos"> 2 </code><code class="nv">This</code> <code class="nv">is</code> <code class="nv">SBCL</code> <code class="nv">1.3.16,</code> <code class="nv">an</code> <code class="nv">implementation</code> <code class="nv">of</code> <code class="nv">ANSI</code> <code class="nv">Common</code> <code class="nv">Lisp.</code>
<code class="linenos"> 3 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"spacy-web-client"</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"spacy"</code><code class="err">:</code>
<code class="linenos"> 5 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos"> 6 </code>    <code class="nv">spacy-web-client</code>
<code class="linenos"> 7 </code><code class="c1">; Loading "spacy-web-client"</code>
<code class="linenos"> 8 </code><code class="o">.........</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="s">"spacy-web-client"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="nb">*</code> <code class="p">(</code><code class="nb">defvar</code> <code class="nv">x</code>
<code class="linenos">11 </code>   <code class="p">(</code><code class="nv">spacy-web-client:spacy-client</code>
<code class="linenos">12 </code>  <code class="s">"President Bill Clinton went to Congress. He gave a speech on taxes and Mexico."</code><code class="p">))</code>
<code class="linenos">13 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">spacy-web-client:spacy-data-entities</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">14 </code><code class="s">"Bill Clinton/PERSON"</code>
<code class="linenos">15 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">spacy-web-client:spacy-data-tokens</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">16 </code><code class="p">(</code><code class="s">"President"</code> <code class="s">"Bill"</code> <code class="s">"Clinton"</code> <code class="s">"went"</code> <code class="s">"to"</code> <code class="s">"Congress"</code> <code class="s">"."</code> <code class="s">"He"</code> <code class="s">"gave"</code> <code class="s">"a"</code>
<code class="linenos">17 </code> <code class="s">"speech"</code> <code class="s">"on"</code> <code class="s">"taxes"</code> <code class="s">"and"</code> <code class="s">"Mexico"</code> <code class="s">"."</code><code class="p">)</code>
</pre></div>

</figure>

<p>The client library is implemented in the file <strong>src/spacy_web_client/spacy-web-client.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="nv">spacy-web-client</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">base-url</code> <code class="s">"http://127.0.0.1:8008?text="</code><code class="p">)</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">defstruct</code> <code class="nv">spacy-data</code> <code class="nv">entities</code> <code class="nv">tokens</code><code class="p">)</code>
<code class="linenos"> 6 </code>  
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">spacy-client</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">the-bytes</code>
<code class="linenos"> 9 </code>	  <code class="p">(</code><code class="nv">drakma:http-request</code>
<code class="linenos">10 </code>	   <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code>
<code class="linenos">11 </code>			<code class="nv">base-url</code>
<code class="linenos">12 </code>			<code class="p">(</code><code class="nv">do-urlencode:urlencode</code>  <code class="nv">query</code><code class="p">))</code>
<code class="linenos">13 </code>	   <code class="ss">:content-type</code> <code class="s">"application/text"</code><code class="p">))</code>
<code class="linenos">14 </code>	 <code class="p">(</code><code class="nv">fetched-data</code>
<code class="linenos">15 </code>	  <code class="p">(</code><code class="nv">flexi-streams:octets-to-string</code> <code class="nv">the-bytes</code> <code class="ss">:external-format</code> <code class="ss">:utf-8</code><code class="p">))</code>
<code class="linenos">16 </code>	 <code class="p">(</code><code class="nv">lists</code> <code class="p">(</code><code class="nb">with-input-from-string</code> <code class="p">(</code><code class="nv">s</code> <code class="nv">fetched-data</code><code class="p">)</code>
<code class="linenos">17 </code>		  <code class="p">(</code><code class="nv">json:decode-json</code> <code class="nv">s</code><code class="p">))))</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">lists</code><code class="p">)</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nv">make-spacy-data</code> <code class="ss">:entities</code> <code class="p">(</code><code class="nb">cadar</code> <code class="nv">lists</code><code class="p">)</code> <code class="ss">:tokens</code> <code class="p">(</code><code class="nb">cdadr</code> <code class="nv">lists</code><code class="p">))))</code>
</pre></div>

</figure>

<p>On line 3 we define base URL for accessing the spaCy web service, assuming that it is running on your laptop and not a remote server. On line 5 we define a <strong>defstruct</strong> named <strong>spacy-data</strong>  that has two fields: a list of entities in the input text and a list of word tokens in the input text.</p>

<p>The function <strong>spacy-client</strong> builds a query string on lines 10-12 that consists of the <strong>base-url</strong> and the input query text URL encoded. The drakma library, that we used before, is used to make a HTTP request from the Python spaCy server. Lines 14-15 uses the flexi-streams package to convert raw byte data to UTF8 characters. Lines 16-17 use the json package to parse the UTF8 encoded string, getting two lists of strings. I left the debug printout expression in line 18 so that you can see the results of parsing the JSON data. The function <strong>make-spacy-data</strong> was generated for us by the <strong>defstruct</strong> statement on line 5.</p>

<h3 id="leanpub-auto-common-lisp-client-for-the-coreference-nlp-web-services">Common Lisp Client for the Coreference NLP Web Services</h3>

<p>Let’s look at some typical output from this example, then we will look at the code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">sbcl</code>
<code class="linenos"> 2 </code><code class="nv">This</code> <code class="nv">is</code> <code class="nv">SBCL</code> <code class="nv">1.3.16,</code> <code class="nv">an</code> <code class="nv">implementation</code> <code class="nv">of</code> <code class="nv">ANSI</code> <code class="nv">Common</code> <code class="nv">Lisp.</code>
<code class="linenos"> 3 </code><code class="nv">More</code> <code class="nv">information</code> <code class="nv">about</code> <code class="nv">SBCL</code> <code class="nv">is</code> <code class="nv">available</code> <code class="nv">at</code> <code class="nv">&lt;http://www.sbcl.org/&gt;.</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nv">SBCL</code> <code class="nv">is</code> <code class="nv">free</code> <code class="nv">software,</code> <code class="nv">provided</code> <code class="nv">as</code> <code class="nv">is,</code> <code class="nv">with</code> <code class="nv">absolutely</code> <code class="nv">no</code> <code class="nv">warranty.</code>
<code class="linenos"> 6 </code><code class="nv">It</code> <code class="nv">is</code> <code class="nv">mostly</code> <code class="nv">in</code> <code class="k">the</code> <code class="nv">public</code> <code class="nv">domain</code><code class="c1">; some portions are provided under</code>
<code class="linenos"> 7 </code><code class="nv">BSD-style</code> <code class="nv">licenses.</code>  <code class="nv">See</code> <code class="k">the</code> <code class="nv">CREDITS</code> <code class="nb">and</code> <code class="nv">COPYING</code> <code class="nv">files</code> <code class="nv">in</code> <code class="k">the</code>
<code class="linenos"> 8 </code><code class="nv">distribution</code> <code class="nv">for</code> <code class="nv">more</code> <code class="nv">information.</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="l l-Other">#P"/Users/markw/quicklisp/setup.lisp"</code> 
<code class="linenos">11 </code><code class="s">"starting up quicklisp"</code> 
<code class="linenos">12 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"coref"</code><code class="p">)</code>
<code class="linenos">13 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"coref"</code><code class="err">:</code>
<code class="linenos">14 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos">15 </code>    <code class="nv">coref</code>
<code class="linenos">16 </code><code class="c1">; Loading "coref"</code>
<code class="linenos">17 </code><code class="o">..................................................</code>
<code class="linenos">18 </code><code class="nv">[package</code> <code class="nv">coref]</code>
<code class="linenos">19 </code><code class="p">(</code><code class="s">"coref"</code><code class="p">)</code>
<code class="linenos">20 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">coref:coref-client</code> <code class="s">"My sister has a dog Henry. She loves him."</code><code class="p">)</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="s">"My sister has a dog Henry. My sister loves a dog Henry."</code>
<code class="linenos">23 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">coref:coref-client</code> <code class="s">"My sister has a dog Henry. He often runs to her."</code><code class="p">)</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="s">"My sister has a dog Henry. a dog Henry often runs to My sister."</code>
</pre></div>

</figure>

<p>Notice that pronouns in the input text are correctly replaced by the noun phrases that the pronoun refer to.</p>

<p>The implementation for the core client is in the file <strong>src/coref_web_client/coref.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:coref</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">;; (ql:quickload :do-urlencode)</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">base-url</code> <code class="s">"http://127.0.0.1:8000?text="</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">coref-client</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">the-bytes</code>
<code class="linenos"> 9 </code>	 <code class="p">(</code><code class="nv">drakma:http-request</code>
<code class="linenos">10 </code>	  <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code>
<code class="linenos">11 </code>		       <code class="nv">base-url</code>
<code class="linenos">12 </code>		       <code class="p">(</code><code class="nv">do-urlencode:urlencode</code>  <code class="nv">query</code><code class="p">)</code>
<code class="linenos">13 </code>		       <code class="s">"&amp;no_detail=1"</code><code class="p">)</code>
<code class="linenos">14 </code>	  <code class="ss">:content-type</code> <code class="s">"application/text"</code><code class="p">)))</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nv">flexi-streams:octets-to-string</code> <code class="nv">the-bytes</code> <code class="ss">:external-format</code> <code class="ss">:utf-8</code><code class="p">)))</code>
</pre></div>

</figure>

<p>This code is similar to the example in the last section for setting up a call to <strong>http-request</strong> but is simpler: here the Python coreference web service accepts a string as input and returns a string as output with pronouns replaced by the nouns or noun phrases that they refer to. The example in the last section had to parse returned JSON data, this example does not.</p>

<h3 id="leanpub-auto-trouble-shooting-possible-problems---skip-if-this-example-works-on-your-system">Trouble Shooting Possible Problems - Skip if this Example Works on Your System</h3>

<p>If you run Common Lisp in an IDE (for example in LispWorks’ IDE or VSCode with a Common Lisp plugin) make sure you start the IDE from the command line so your PATH environment variable will be set as it is in our bash or zsh shell.</p>

<p>Make sure you are starting your Common Lisp program or running a Common Lisp repl with the same Python installation (if you have Quicklisp installed, then you also have the package <strong>uiop</strong> installed):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ which python
<code class="linenos">2 </code>/Users/markw/bin/anaconda3/bin/python
<code class="linenos">3 </code>$ sbcl
<code class="linenos">4 </code>This is SBCL <code class="m">2</code>.0.2, an implementation of ANSI Common Lisp.
<code class="linenos">5 </code>* <code class="o">(</code>uiop:run-program <code class="s2">"which python"</code> :output :string<code class="o">)</code>
<code class="linenos">6 </code><code class="s2">"/Users/markw/bin/anaconda3/bin/python"</code>
<code class="linenos">7 </code>nil
<code class="linenos">8 </code><code class="m">0</code>
<code class="linenos">9 </code>* 
</pre></div>

</figure>

<h3 id="leanpub-auto-python-interop-wrap-up">Python Interop Wrap-up</h3>

<p>Much of my professional work in the last five years involved deep learning models and currently most available software is written in Python. While there are available libraries for calling Python code from Common Lisp, these libraries tend to not work well for Python code using libraries like TensorFlow, spaCy, PyTorch, etc., especially if the Python code is configured to use GPUs via CUDA of special hardware like TPUs. I find it simpler to simply wrap functionality implemented in Python as a simple web service.</p>


<h2 id="leanpub-auto-using-the-py4cl-library-to-embed-python-in-common-lisp">Using the PY4CL Library to Embed Python in Common Lisp</h2>

<p>We will tackle the same problem as the previous chapter but take a different approach. Now we will use Ben Dudson’s project <a href="https://github.com/bendudson/py4cl/">Py4CL</a> that automatically starts a Python process and communicates with the Python process via a stream interface. The approach we took before is appropriate for large scale systems where you might want scale horizontally by having Python processes running on different servers than the servers used for the Common Lisp parts of your application. The approach we now take is much more convenient for what I call “laptop development” where the management of a Python process and communication is handled for you by the Py4CL library. If you need to build multi-server distributed systems for scaling reasons then use the examples in the last chapter.</p>

<p>While Py4CL provides a lot of flexibility for passing primitive types between Common Lisp and Python (in both directions), I find it easiest to write small Python wrappers that only use lists, arrays, numbers, and strings as arguments and return types. You might want to experiment with the examples on the Py4CL GitHub page that let you directly call Python libraries without writing wrappers. When I write code for my own projects I try to make code as simple as possible so when I need to later revisit my own code it is immediately obvious what it is doing. Since I have been using Common Lisp for almost 40 years, I often find myself reusing bits of my own old code and I optimize for making this as easy as possible. In other words I favor readability over “clever” code.</p>

<h3 id="leanpub-auto-project-structure-building-the-python-wrapper-and-running-an-example">Project Structure, Building the Python Wrapper, and Running an Example</h3>

<p>The packaging of the Lisp code for my <strong>spacy-py4cl</strong> package is simple. Here is the listing of <strong>package.lisp</strong> for this project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">;;;; package.lisp</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:spacy-py4cl</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:py4cl</code><code class="p">)</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="ss">:export</code> <code class="ss">#:nlp</code><code class="p">))</code>
</pre></div>

</figure>

<p>Listing of <strong>spacy-py4cl.asd</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;;; spacy-py4cl.asd</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:spacy-py4cl</code>
<code class="linenos"> 4 </code>  <code class="ss">:description</code> <code class="s">"Use py4cl to use Python spaCy library embedded in Common Lisp"</code>
<code class="linenos"> 5 </code>  <code class="ss">:author</code> <code class="s">"Mark Watson &lt;markw@markwatson.com&gt;"</code>
<code class="linenos"> 6 </code>  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
<code class="linenos"> 7 </code>  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:py4cl</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="ss">:serial</code> <code class="no">t</code>
<code class="linenos"> 9 </code>  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
<code class="linenos">10 </code>               <code class="p">(</code><code class="ss">:file</code> <code class="s">"spacy-py4cl"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>You need to run a Python setup procedure to install the Python wrapper for space-py4cl on your system. Some output is removed for conciseness:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ <code class="nb">cd</code> loving-common-lisp/src/spacy-py4cl
<code class="linenos"> 2 </code>$ <code class="nb">cd</code> PYTHON_SPACY_SETUP_install/spacystub
<code class="linenos"> 3 </code>$ pip install -U spacy
<code class="linenos"> 4 </code>$ python -m spacy download en
<code class="linenos"> 5 </code>$ python setup.py install
<code class="linenos"> 6 </code>running install
<code class="linenos"> 7 </code>running build
<code class="linenos"> 8 </code>running build_py
<code class="linenos"> 9 </code>running install_lib
<code class="linenos">10 </code>running install_egg_info
<code class="linenos">11 </code>Writing /Users/markw/bin/anaconda3/lib/python3.7/site-packages/spacystub-0.21-py3.7.<code class="se">\</code>
<code class="linenos">12 </code>egg-info
</pre></div>

</figure>

<p>You only need to do this once unless you update to a later version of Python on your system.</p>

<p>If you are not familiar with Python, it is worth looking at the wrapper implementation, otherwise skip the next few paragraphs. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ ls -R PYTHON_SPACY_SETUP_install 
spacystub

PYTHON_SPACY_SETUP_install/spacystub:
README.md		setup.py	spacystub

PYTHON_SPACY_SETUP_install/spacystub/build/lib:
spacystub

PYTHON_SPACY_SETUP_install/spacystub/spacystub:
parse.py
</pre></div>

</figure>

<p>Here is the implementation of <strong>setup.py</strong> that specifies how to build and install the wrapper globally for use on your system:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kn">from</code> <code class="nn">distutils.core</code> <code class="kn">import</code> <code class="n">setup</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="n">setup</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'spacystub'</code><code class="p">,</code>
<code class="linenos">4 </code>      <code class="n">version</code><code class="o">=</code><code class="s1">'0.21'</code><code class="p">,</code>
<code class="linenos">5 </code>      <code class="n">packages</code><code class="o">=</code><code class="p">[</code><code class="s1">'spacystub'</code><code class="p">],</code>
<code class="linenos">6 </code>      <code class="n">license</code><code class="o">=</code><code class="s1">'Apache 2'</code><code class="p">,</code>
<code class="linenos">7 </code>      <code class="n">py_modules</code><code class="o">=</code><code class="p">[</code><code class="s1">'pystub'</code><code class="p">],</code>
<code class="linenos">8 </code>      <code class="n">long_description</code><code class="o">=</code><code class="nb">open</code><code class="p">(</code><code class="s1">'README.md'</code><code class="p">)</code><code class="o">.</code><code class="n">read</code><code class="p">())</code>
</pre></div>

</figure>

<p>The definition of the library in file <strong>PYTHON_SPACY_SETUP_install/spacystub/spacystub/parse.py</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">import</code> <code class="nn">spacy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="n">nlp</code> <code class="o">=</code> <code class="n">spacy</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="s2">"en"</code><code class="p">)</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="k">def</code> <code class="nf">parse</code><code class="p">(</code><code class="n">text</code><code class="p">):</code>
<code class="linenos"> 6 </code>  <code class="n">doc</code> <code class="o">=</code> <code class="n">nlp</code><code class="p">(</code><code class="n">text</code><code class="p">)</code>
<code class="linenos"> 7 </code>  <code class="n">response</code> <code class="o">=</code> <code class="p">{}</code>
<code class="linenos"> 8 </code>  <code class="n">response</code><code class="p">[</code><code class="s1">'entities'</code><code class="p">]</code> <code class="o">=</code> <code class="p">[(</code><code class="n">ent</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="n">ent</code><code class="o">.</code><code class="n">start_char</code><code class="p">,</code> <code class="n">ent</code><code class="o">.</code><code class="n">end_char</code><code class="p">,</code> <code class="n">ent</code><code class="o">.</code><code class="n">label_</code><code class="p">)</code> <code class="k">for</code> <code class="n">e</code>\
<code class="linenos"> 9 </code><code class="n">nt</code> <code class="ow">in</code> <code class="n">doc</code><code class="o">.</code><code class="n">ents</code><code class="p">]</code>
<code class="linenos">10 </code>  <code class="n">response</code><code class="p">[</code><code class="s1">'tokens'</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="n">token</code><code class="o">.</code><code class="n">text</code> <code class="k">for</code> <code class="n">token</code> <code class="ow">in</code> <code class="n">doc</code><code class="p">]</code>
<code class="linenos">11 </code>  <code class="k">return</code> <code class="p">[</code><code class="n">response</code><code class="p">[</code><code class="s1">'tokens'</code><code class="p">],</code> <code class="n">response</code><code class="p">[</code><code class="s1">'entities'</code><code class="p">]]</code>
</pre></div>

</figure>

<p>Here is a Common Lisp repl session showing you how to use the library implemented in the next section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">ccl</code> 
<code class="linenos"> 2 </code><code class="nv">Clozure</code> <code class="nv">Common</code> <code class="nv">Lisp</code> <code class="nv">Version</code> <code class="mf">1.12</code>  <code class="nv">DarwinX8664</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="nv">For</code> <code class="nv">more</code> <code class="nv">information</code> <code class="nv">about</code> <code class="nv">CCL,</code> <code class="nv">please</code> <code class="nv">see</code> <code class="nv">http://ccl.clozure.com.</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="nv">CCL</code> <code class="nv">is</code> <code class="nv">free</code> <code class="nv">software.</code>  <code class="nv">It</code> <code class="nv">is</code> <code class="nv">distributed</code> <code class="nv">under</code> <code class="k">the</code> <code class="nv">terms</code> <code class="nv">of</code> <code class="k">the</code> <code class="nv">Apache</code> <code class="nv">Licence,</code> <code class="nv">Vers</code><code class="err">\</code>
<code class="linenos"> 7 </code><code class="nv">ion</code> <code class="nv">2.0.</code>
<code class="linenos"> 8 </code><code class="nv">?</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"spacy-py4cl"</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"spacy-py4cl"</code><code class="err">:</code>
<code class="linenos">10 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos">11 </code>    <code class="nv">spacy-py4cl</code>
<code class="linenos">12 </code><code class="c1">; Loading "spacy-py4cl"</code>
<code class="linenos">13 </code><code class="nv">[package</code> <code class="nv">spacy-py4cl]</code>
<code class="linenos">14 </code><code class="p">(</code><code class="s">"spacy-py4cl"</code><code class="p">)</code>
<code class="linenos">15 </code><code class="nv">?</code> <code class="p">(</code><code class="nv">spacy-py4cl:nlp</code> <code class="s">"The President of Mexico went to Canada"</code><code class="p">)</code>
<code class="linenos">16 </code><code class="o">#(#(</code><code class="s">"The"</code> <code class="s">"President"</code> <code class="s">"of"</code> <code class="s">"Mexico"</code> <code class="s">"went"</code> <code class="s">"to"</code> <code class="s">"Canada"</code><code class="p">)</code> <code class="o">#(</code><code class="p">(</code><code class="s">"Mexico"</code> <code class="mi">17</code> <code class="mi">23</code> <code class="s">"GPE"</code><code class="p">)</code> <code class="p">(</code><code class="err">\</code>
<code class="linenos">17 </code><code class="s">"Canada"</code> <code class="mi">32</code> <code class="mi">38</code> <code class="s">"GPE"</code><code class="p">)))</code>
<code class="linenos">18 </code><code class="nv">?</code> <code class="p">(</code><code class="nv">spacy-py4cl:nlp</code> <code class="s">"Bill Clinton bought a red car. He drove it to the beach."</code><code class="p">)</code>
<code class="linenos">19 </code><code class="o">#(#(</code><code class="s">"Bill"</code> <code class="s">"Clinton"</code> <code class="s">"bought"</code> <code class="s">"a"</code> <code class="s">"red"</code> <code class="s">"car"</code> <code class="s">"."</code> <code class="s">"He"</code> <code class="s">"drove"</code> <code class="s">"it"</code> <code class="s">"to"</code> <code class="s">"the"</code> <code class="s">"beac\</code>
<code class="linenos">20 </code><code class="s">h"</code> <code class="s">"."</code><code class="p">)</code> <code class="o">#(</code><code class="p">(</code><code class="s">"Bill Clinton"</code> <code class="mi">0</code> <code class="mi">12</code> <code class="s">"PERSON"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Entities in text are identified with the starting and ending character indices that refer to the input string. For example, the entity “Mexico” starts at character position 17 and character index 23 is the character after the entity name in the input string. The entity type “GPE” refers to a country name and “PERSON” refers to a person’s name in the input text. </p>

<h3 id="leanpub-auto-implementation-of-spacy-py4cl">Implementation of spacy-py4cl</h3>

<p>The Common Lisp implementation for this package is simple. In line 5 the call to <strong>py4cl:python-exec</strong> starts a process to run Python and imports the function <strong>parse</strong> from my Python wrapper. The call to <strong>py4cl:import-function</strong> in line 6 finds a function named “parse” in the attached Python process and generates a Common Lisp function with the same name that handles calling into Python and converting handling the returned values to Common Lisp values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">;;;; spacy-py4cl.lisp</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:spacy-py4cl</code><code class="p">)</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="p">(</code><code class="nv">py4cl:python-exec</code> <code class="s">"from spacystub.parse import parse"</code><code class="p">)</code>
<code class="linenos">6 </code><code class="p">(</code><code class="nv">py4cl:import-function</code> <code class="s">"parse"</code><code class="p">)</code>
<code class="linenos">7 </code>
<code class="linenos">8 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">nlp</code> <code class="p">(</code><code class="nv">text</code><code class="p">)</code>
<code class="linenos">9 </code>  <code class="p">(</code><code class="nv">parse</code> <code class="nv">text</code><code class="p">))</code>
</pre></div>

</figure>

<p>While it is possible to call Python libraries directly using Py4CL, when I need to frequently use Python libraries like spaCY, TensorFlow, fast.ai, etc. in Common Lisp, I like to use wrappers that use simple as possible data types and APIs to communicate between a Common Lisp process and the spawned Python process.</p>

<h3 id="leanpub-auto-trouble-shooting-possible-problems---skip-if-this-example-works-on-your-system-1">Trouble Shooting Possible Problems - Skip if this Example Works on Your System</h3>

<p>When you install my wrapper library in Python on the command line whatever your shell if (bash, zsh, etc.) you should then try to import the library in a Python repl:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ python
<code class="linenos">2 </code>Python <code class="m">3</code>.7.4 <code class="o">(</code>default, Aug <code class="m">13</code> <code class="m">2019</code>, <code class="m">15</code>:17:50<code class="o">)</code> 
<code class="linenos">3 </code><code class="o">[</code>Clang <code class="m">4</code>.0.1 <code class="o">(</code>tags/RELEASE_401/final<code class="o">)]</code> :: Anaconda, Inc. on darwin
<code class="linenos">4 </code>Type <code class="s2">"help"</code>, <code class="s2">"copyright"</code>, <code class="s2">"credits"</code> or <code class="s2">"license"</code> <code class="k">for</code> more information.
<code class="linenos">5 </code>&gt;&gt;&gt; from spacystub.parse import parse
<code class="linenos">6 </code>&gt;&gt;&gt; parse<code class="o">(</code><code class="s2">"John Smith is a Democrat"</code><code class="o">)</code>
<code class="linenos">7 </code><code class="o">[[</code><code class="s1">'John'</code>, <code class="s1">'Smith'</code>, <code class="s1">'is'</code>, <code class="s1">'a'</code>, <code class="s1">'Democrat'</code><code class="o">]</code>, <code class="o">[(</code><code class="s1">'John Smith'</code>, <code class="m">0</code>, <code class="m">10</code>, <code class="s1">'PERSON'</code><code class="o">)</code>, <code class="o">(</code><code class="s1">'Democ\</code>
<code class="linenos">8 </code><code class="s1">rat'</code>, <code class="m">16</code>, <code class="m">24</code>, <code class="s1">'NORP'</code><code class="o">)]]</code>
<code class="linenos">9 </code>&gt;&gt;&gt;
</pre></div>

</figure>

<p>If this works and the Common Lisp library <strong>spacy-py4cl</strong> does not, then make sure you are starting your Common Lisp program or running a Common Lisp repl with the same Python installation (if you have Quicklisp installed, then you also have the package <strong>uiop</strong> installed):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ which python
<code class="linenos">2 </code>/Users/markw/bin/anaconda3/bin/python
<code class="linenos">3 </code>$ sbcl
<code class="linenos">4 </code>This is SBCL <code class="m">2</code>.0.2, an implementation of ANSI Common Lisp.
<code class="linenos">5 </code>* <code class="o">(</code>uiop:run-program <code class="s2">"which python"</code> :output :string<code class="o">)</code>
<code class="linenos">6 </code><code class="s2">"/Users/markw/bin/anaconda3/bin/python"</code>
<code class="linenos">7 </code>nil
<code class="linenos">8 </code><code class="m">0</code>
<code class="linenos">9 </code>* 
</pre></div>

</figure>

<p>If you run Common Lisp in an IDE (for example in LispWorks’ IDE or VSCode with a Common Lisp plugin) make sure you start the IDE from the command line so your PATH environment variable will be set as it is in our bash or zsh shell.</p>

<h3 id="leanpub-auto-wrap-up-for-using-py4cl">Wrap-up for Using Py4CL</h3>

<p>While I prefer Common Lisp for general development and also AI research, there are useful Python libraries that I want to integrate into my projects. I hope that the last chapter and this chapter provide you with two solid approaches for you to use in your own work to take advantage of Python libraries.</p>


<h2 id="leanpub-auto-semantic-web-and-linked-data">Semantic Web and Linked Data</h2>

<p>I have written two previous books on the semantic web and linked data and most of my programming books have semantic web examples. Please note that the background material here on the semantic web standards RDF, RDFS, and SPARQL is shared with my book <a href="https://leanpub.com/javaai">Practical Artificial Intelligence Programming With Java</a> so if you have read that book then the first several pages of this chapter will seem familiar.</p>

<p>Construction of Knowledge Graphs, as we will do in later chapters, is a core technology at many corporations and organizations to prevent data silos where different database systems are poorly connected and not as useful in combination than they could be. The use of RDF data stores is a powerful technique for data interoperability within organizations. Semantic Web standards like RDF, RDFS, and SPARQL support both building Knowledge Graphs and also key technologies for automating the collection and use of web data.</p>

<p>I worked as a contractor at Google on an internal Knowledge Graph project and I currently work at <a href="https://oliveai.com">Olive AI</a> on their Knowledge Graph team.</p>

<p>The semantic web is intended to provide a massive linked set of data for use by software systems just as the World Wide Web provides a massive collection of linked web pages for human reading and browsing. The semantic web is like the web in that anyone can generate any content that they want. This freedom to publish anything works for the web because we use our ability to understand natural language to interpret what we read – and often to dismiss material that based upon our own knowledge we consider to be incorrect.</p>

<p>Semantic web and linked data technologies are also useful for smaller amounts of data, an example being a Knowledge Graph containing information for a business. We will further explore Knowledge Graphs in the next two chapters.</p>

<p>The core concept for the semantic web is data integration and use from different sources. As we will soon see, the tools for implementing the semantic web are designed for encoding data and sharing data from many different sources.</p>

<p>I cover the semantic web in this book because I believe that semantic web technologies are complementary to AI systems for gathering and processing data on the web. As more web pages are generated by applications (as opposed to simply showing static HTML files) it becomes easier to produce both HTML for human readers and semantic data for software agents.</p>

<p>There are several very good semantic web toolkits for the Java language and platform. Here we use Apache Jena because it is what I often use in my own work and I believe that it is a good starting technology for your first experiments with semantic web technologies. This chapter provides an incomplete coverage of semantic web technologies and is intended as a gentle introduction to a few useful techniques and how to implement those techniques in Java. This chapter is the start of a journey in the technology that I think is as important as technologies like deep learning that get more public mindshare.</p>

<p>The following figure shows a layered hierarchy of data models that are used to implement semantic web applications. To design and implement these applications we need to think in terms of physical models (storage and access of RDF, RDFS, and perhaps OWL data), logical models (how we use RDF and RDFS to define relationships between data represented as unique URIs and string literals and how we logically combine data from different sources) and conceptual modeling (higher level knowledge representation and reasoning using OWL). Originally RDF data was serialized as XML data but other formats have become much more popular because they are easier to read and manually create. The top three layers in the figure might be represented as XML, or as LD-JSON (linked data JSON) or formats like N-Triples and N3 that we will use later.</p>


<div class="figure-wrapper center">
  <figure id="semantic-web-data-models" class="image" style="width: 249px">
    <img src="images/semantic_web_data.png" alt="Semantic Web Data Models" style="width: 100%">
    <figcaption>Semantic Web Data Models</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-resource-description-framework-rdf-data-model">Resource Description Framework (RDF) Data Model</h3>

<p>The Resource Description Framework (RDF) is used to encode information and the RDF Schema (RDFS) facilitates using data with different RDF encodings without the need to convert one set of schemas to another. Later, using OWL we can simply declare that one predicate is the same as another, that is, one predicate is a sub-predicate of another (e.g., a property <strong>containsCity</strong> can be declared to be a sub-property of <strong>containsPlace</strong> so if something contains a city then it also contains a place), etc. The predicate part of an RDF statement often refers to a property.</p>

<p>RDF data was originally encoded as XML and intended for automated processing. In this chapter we will use two simple to read formats called “N-Triples” and “N3.” Apache Jena can be used to convert between all RDF formats so we might as well use formats that are easier to read and understand. RDF data consists of a set of triple values:</p>

<ul>
  <li>subject</li>
  <li>predicate</li>
  <li>object</li>
</ul>

<p>Some of my work with semantic web technologies deals with processing news stories, extracting semantic information from the text, and storing it in RDF. I will use this application domain for the examples in this chapter and the next chapter when we implement code to automatically generate RDF for Knowledge Graphs. I deal with triples like:</p>

<ul>
  <li>subject: a URL (or URI) of a news article.</li>
  <li>predicate: a relation like “containsPerson”.</li>
  <li>object: a literal value like “Bill Clinton” or a URI representing Bill Clinton.</li>
</ul>

<p>In the next chapter we will use the entity recognition library we developed in an earlier chapter to create RDF from text input.</p>

<p>We will use either URIs or string literals as values for objects. We will always use URIs for representing subjects and predicates. In any case URIs are usually preferred to string literals. We will see an example of this preferred use but first we need to learn the N-Triple and N3 RDF formats.</p>

<p>I proposed the idea that RDF was more flexible than Object Modeling in programming languages, relational databases, and XML with schemas. If we can tag new attributes on the fly to existing data, how do we prevent what I might call “data chaos” as we modify existing data sources? It turns out that the solution to this problem is also the solution for encoding real semantics (or meaning) with data: we usually use unique URIs for RDF subjects, predicates, and objects, and usually with a preference for not using string literals. The definitions of predicates are tied to a namespace and later with OWL we will state the equivalence of predicates in different namespaces with the same semantic meaning. I will try to make this idea more clear with some examples and <a href="https://en.wikipedia.org/wiki/Resource_Description_Framework">Wikipedia has a good writeup on RDF</a>.</p>

<p>Any part of a triple (subject, predicate, or object) is either a URI or a string literal. URIs encode namespaces. For example, the containsPerson predicate in the last example could be written as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">knowledgebooks</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">ontology</code><code class="o">/</code><code class="c">#containsPerson</code>
</pre></div>

</figure>

<p>The first part of this URI is considered to be the namespace for this predicate “containsPerson.” When different RDF triples use this same predicate, this is some assurance to us that all users of this predicate understand to the same meaning. Furthermore, we will see later that we can use RDFS to state equivalency between this predicate (in the namespace http://knowledgebooks.com/ontology/) with predicates represented by different URIs used in other data sources. In an “artificial intelligence” sense, software that we write does not understand predicates like “containsCity”,  “containsPerson”, or “isLocation” in the way that a human reader can by combining understood common meanings for the words “contains”, “city”, “is”, “person”, and “location” but for many interesting and useful types of applications that is fine as long as the predicate is used consistently. We will see shortly that we can define abbreviation prefixes for namespaces which makes RDF and RDFS files shorter and easier to read.</p>

<p>The Jena library supports most serialization formats for RDF:</p>

<ul>
  <li>Turtle</li>
  <li>N3</li>
  <li>N-Triples</li>
  <li>NQuads</li>
  <li>TriG</li>
  <li>JSON-LD</li>
  <li>RDF/XML</li>
  <li>RDF/JSON</li>
  <li>TriX</li>
  <li>RDF Binary</li>
</ul>

<p>A statement in N-Triple format consists of three URIs (two URIs and a string literals for the object) followed by a period to end the statement. While statements are often written one per line in a source file they can be broken across lines; it is the ending period which marks the end of a statement. The standard file extension for N-Triple format files is *.nt and the standard format for N3 format files is *.n3.</p>

<p>My preference is to use N-Triple format files as output from programs that I write to save data as RDF. N-Triple files don’t use any abbreviations and each RDF statement is self-contained. I often use tools like the command line commands in Jena or RDF4J to convert N-Triple files to N3 or other formats if I will be reading them or even hand editing them. Here is an example using the N3 syntax:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"China"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>The N3 format adds prefixes (abbreviations) to the N-Triple format. In practice it would be better to use the URI <strong><a href="http://dbpedia.org/resource/China">http://dbpedia.org/resource/China</a></strong> instead of the literal value “China.”</p>

<p>Here we see the use of an abbreviation prefix “kb:” for the namespace for my company KnowledgeBooks.com ontologies. The first term in the RDF statement (the subject) is the URI of a news article. The second term (the predicate) is “containsCountry” in the “kb:” namespace. The last item in the statement (the object) is a string literal “China.” I would describe this RDF statement in English as, “The news article at URI http://news.com/201234 mentions the country China.”</p>

<p>This was a very simple N3 example which we will expand to show additional features of the N3 notation. As another example, let’s look at the case if this news article also mentions the USA. Instead of adding a whole new statement like this we can combine them using N3 notation. Here we have two separate RDF statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
</pre></div>

</figure>

<p>We can collapse multiple RDF statements that share the same subject and optionally the same predicate:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
    <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code> <code class="p">,</code>
    <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
</pre></div>

</figure>

<p>The indentation and placement on separate lines is arbitrary - use whatever style you like that is readable. We can also add in additional predicates that use the same subject (I am going to use string literals here instead of URIs for objects to make the following example more concise but in practice prefer using URIs):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"China"</code> <code class="p">,</code>
                           <code class="s">"USA"</code> <code class="p">.</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"United Nations"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Ban Ki-moon"</code> <code class="p">,</code> <code class="s">"Gordon Brown"</code> <code class="p">,</code>
                          <code class="s">"Hu Jintao"</code> <code class="p">,</code> <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Pervez Musharraf"</code> <code class="p">,</code>
                          <code class="s">"Vladimir Putin"</code> <code class="p">,</code> 
                          <code class="s">"Mahmoud Ahmadinejad"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>This single N3 statement represents ten individual RDF triples. Each section defining triples with the same subject and predicate have objects separated by commas and ending with a period. Please note that whatever RDF storage system you use (we will be using Jena) it makes no difference if we load RDF as XML, N-Triple, of N3 format files: internally subject, predicate, and object triples are stored in the same way and are used in the same way. RDF triples in a data store represent directed graphs that may not all be connected.</p>

<p>I promised you that the data in RDF data stores was easy to extend. As an example, let us assume that we have written software that is able to read online news articles and create RDF data that captures some of the semantics in the articles. If we extend our program to also recognize dates when the articles are published, we can simply reprocess articles and for each article add a triple to our RDF data store using a form like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">datePublished</code> <code class="s">"2008-05-11"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Here we just represent the date as a string. We can add a type to the object representing a specific date:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">xsd</code><code class="p">:</code> <code class="nl">&lt;http://www.w3.org/2001/XMLSchema#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
 
 <code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">datePublished</code> <code class="s">"2008-05-11"</code><code class="o">^^</code><code class="nn">xsd</code><code class="p">:</code><code class="nt">date</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Furthermore, if we do not have dates for all news articles that is often acceptable because when constructing SPARQL queries you can match optional patterns. If for example you are looking up articles on a specific subject then some results may have a publication date attached to the results for that article and some might not. In practice RDF supports types and we would use a date type as seen in the last example, not a string. However, in designing the example programs for this chapter I decided to simplify our representation of URIs and often use string literals as simple Java strings. For many applications this isn’t a real limitation.</p>

<h3 id="rdfs">Extending RDF with RDF Schema</h3>

<p>RDF Schema (RDFS) supports the definition of classes and properties based on set inclusion. In RDFS classes and properties are orthogonal. Let’s start with looking at an example using additional namespaces:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdf</code><code class="p">:</code> <code class="nl">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>   <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">dbo</code><code class="p">:</code> <code class="nl">&lt;http://dbpedia.org/ontology/&gt;</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>
  <code class="nn">rdfs</code><code class="p">:</code><code class="nt">label</code> <code class="s">"China"</code><code class="o">@</code><code class="nf">en</code><code class="p">,</code>
  <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">dbo</code><code class="p">:</code><code class="nt">Place</code> <code class="p">,</code>
  <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">dbo</code><code class="p">:</code><code class="nt">Country</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Because the semantic web is intended to be processed automatically by software systems it is encoded as RDF. There is a problem that must be solved in implementing and using the semantic web: everyone who publishes semantic web data is free to create their own RDF schemas for storing data; for example, there is usually no single standard RDF schema definition for topics like news stories and stock market data. The <a href="https://www.w3.org/2009/08/skos-reference/skos.html">SKOS</a> is a namespace containing standard schemas and the most widely used standard is <a href="https://schema.org/docs/schemas.html">schema.org</a>. Understanding the ways of integrating different data sources using different schemas helps to understand the design decisions behind the semantic web applications. In this chapter I often use my own schemas in the knowledgebooks.com namespace for the simple examples you see here. When you build your own production systems part of the work is searching through <strong>schema.org</strong> and <strong>SKOS</strong> to use standard name spaces and schemas when possible. The use of standard schemas helps when you link internal proprietary Knowledge Graphs used in organization with public open data from sources like <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">WikiData</a> and <a href="https://wiki.dbpedia.org/about">DBPedia</a>.</p>

<p>We will start with an example that is an extension of the example in the last section that also uses RDFS. We add a few additional RDF statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>  <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
</pre></div>

</figure>

<p>The last three lines declare that:</p>

<ul>
  <li>The property containsCity is a sub-property of containsPlace.</li>
  <li>The property containsCountry is a sub-property of containsPlace.</li>
  <li>The property containsState is a sub-property of containsPlace.</li>
</ul>

<p>Why is this useful? For at least two reasons:</p>

<ul>
  <li>You can query an RDF data store for all triples that use property containsPlace and also match triples with properties equal to containsCity, containsCountry, or containsState. There may not even be any triples that explicitly use the property containsPlace.</li>
  <li>Consider a hypothetical case where you are using two different RDF data stores that use different properties for naming cities: <strong>cityName</strong> and <strong>city</strong>. You can define <strong>cityName</strong> to be a sub-property of <strong>city</strong> and then write all queries against the single property name <strong>city</strong>. This removes the necessity to convert data from different sources to use the same Schema. You can also use OWL to state property and class equivalency.</li>
</ul>

<p>In addition to providing a vocabulary for describing properties and class membership by properties, RDFS is also used for logical inference to infer new triples, combine data from different RDF data sources, and to allow effective querying of RDF data stores. We will see examples of all of these features of RDFS when we later start using the Jena libraries to perform SPARQL queries.</p>

<h3 id="leanpub-auto-the-sparql-query-language">The SPARQL Query Language</h3>

<p>SPARQL is a query language used to query RDF data stores. While SPARQL may initially look like SQL, we will see that there are some important differences like support for RDFS and OWL inferencing and graph-based instead of relational matching operations. We will cover the basics of SPARQL in this section and then see more examples later when we learn how to embed Jena in Java applications, and see more examples in the last chapter <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<p>We will use the N3 format RDF file test_data/news.n3 for the examples. I created this file automatically by spidering Reuters news stories on the news.yahoo.com web site and automatically extracting named entities from the text of the articles. We saw techniques for extracting named entities from text in earlier chapters. In this chapter we use these sample RDF files.</p>

<p>You have already seen snippets of this file and I list the entire file here for reference, edited to fit line width: you may find the file news.n3 easier to read if you are at your computer and open the file in a text editor so you will not be limited to what fits on a book page:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>  <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/20080616/usa_flooding_dc_16/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Burlington"</code> <code class="p">,</code> <code class="s">"Denver"</code> <code class="p">,</code>
                        <code class="s">"St. Paul"</code> <code class="p">,</code><code class="s">" Chicago"</code> <code class="p">,</code>
                        <code class="s">"Quincy"</code> <code class="p">,</code> <code class="s">"CHICAGO"</code> <code class="p">,</code>
                        <code class="s">"Iowa City"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsRegion</code> <code class="s">"U.S. Midwest"</code> <code class="p">,</code> <code class="s">"Midwest"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Japan"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Minnesota"</code> <code class="p">,</code> <code class="s">"Illinois"</code> <code class="p">,</code> 
                         <code class="s">"Mississippi"</code> <code class="p">,</code> <code class="s">"Iowa"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"National Guard"</code> <code class="p">,</code>
                         <code class="s">"U.S. Department of Agriculture"</code> <code class="p">,</code>
                         <code class="s">"White House"</code> <code class="p">,</code>
                         <code class="s">"Chicago Board of Trade"</code> <code class="p">,</code>
                         <code class="s">"Department of Transportation"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Dena Gray-Fisher"</code> <code class="p">,</code>
                          <code class="s">"Donald Miller"</code> <code class="p">,</code>
                          <code class="s">"Glenn Hollander"</code> <code class="p">,</code>
                          <code class="s">"Rich Feltes"</code> <code class="p">,</code>
                          <code class="s">"George W. Bush"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"food inflation"</code> <code class="p">,</code> <code class="s">"food"</code> <code class="p">,</code>
                                <code class="s">"finance ministers"</code> <code class="p">,</code>
                                <code class="s">"oil"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/78325/ts_nm/usa_politics_dc_2/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Washington"</code> <code class="p">,</code> <code class="s">"Baghdad"</code> <code class="p">,</code>
                        <code class="s">"Arlington"</code> <code class="p">,</code> <code class="s">"Flint"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code>
                           <code class="s">"Afghanistan"</code> <code class="p">,</code>
                           <code class="s">"Iraq"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Illinois"</code> <code class="p">,</code> <code class="s">"Virginia"</code> <code class="p">,</code>
                         <code class="s">"Arizona"</code> <code class="p">,</code> <code class="s">"Michigan"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"White House"</code> <code class="p">,</code>
                                <code class="s">"Obama administration"</code> <code class="p">,</code>
                                <code class="s">"Iraqi government"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"David Petraeus"</code> <code class="p">,</code>
                          <code class="s">"John McCain"</code> <code class="p">,</code>
                          <code class="s">"Hoshiyar Zebari"</code> <code class="p">,</code>
                          <code class="s">"Barack Obama"</code> <code class="p">,</code>
                          <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Carly Fiorina"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"oil prices"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/10944/ts_nm/worldleaders_dc_1/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"WASHINGTON"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Pakistan"</code> <code class="p">,</code>
                           <code class="s">"Islamic Republic of Iran"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Maryland"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"University of Maryland"</code> <code class="p">,</code>
                                <code class="s">"United Nations"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Ban Ki-moon"</code> <code class="p">,</code> <code class="s">"Gordon Brown"</code> <code class="p">,</code>
                          <code class="s">"Hu Jintao"</code> <code class="p">,</code> <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Pervez Musharraf"</code> <code class="p">,</code>
                          <code class="s">"Vladimir Putin"</code> <code class="p">,</code>
                          <code class="s">"Steven Kull"</code> <code class="p">,</code>
                          <code class="s">"Mahmoud Ahmadinejad"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/10622/global_economy_dc_4/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Sao Paulo"</code> <code class="p">,</code> <code class="s">"Kuala Lumpur"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsRegion</code> <code class="s">"Midwest"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Britain"</code> <code class="p">,</code>
                           <code class="s">"Saudi Arabia"</code> <code class="p">,</code> <code class="s">"Spain"</code> <code class="p">,</code>
                           <code class="s">"Italy"</code> <code class="p">,</code> <code class="err">Indi</code><code class="k">a</code><code class="s">" , </code>
                           <code class="s">""</code><code class="err">France</code><code class="s">" , "</code><code class="err">Canad</code><code class="k">a</code><code class="s">" ,</code>
                           <code class="s">"Russia"</code> <code class="p">,</code> <code class="s">"Germany"</code> <code class="p">,</code> <code class="s">"China"</code> <code class="p">,</code>
                           <code class="s">"Japan"</code> <code class="p">,</code> <code class="s">"South Korea"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"Federal Reserve Bank"</code> <code class="p">,</code>
                                <code class="s">"European Union"</code> <code class="p">,</code>
                                <code class="s">"European Central Bank"</code> <code class="p">,</code>
                                <code class="s">"European Commission"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Lee Myung-bak"</code> <code class="p">,</code> <code class="s">"Rajat Nag"</code> <code class="p">,</code>
                          <code class="s">"Luiz Inacio Lula da Silva"</code> <code class="p">,</code>
                          <code class="s">"Jeffrey Lacker"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCompany</code> <code class="s">"Development Bank Managing"</code> <code class="p">,</code>
                           <code class="s">"Reuters"</code> <code class="p">,</code>
                           <code class="s">"Richmond Federal Reserve Bank"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"central bank"</code> <code class="p">,</code> <code class="s">"food"</code> <code class="p">,</code>
                                <code class="s">"energy costs"</code> <code class="p">,</code>
                                <code class="s">"finance ministers"</code> <code class="p">,</code>
                                <code class="s">"crude oil prices"</code> <code class="p">,</code>
                                <code class="s">"oil prices"</code> <code class="p">,</code>
                                <code class="s">"oil shock"</code> <code class="p">,</code>
                                <code class="s">"food prices"</code> <code class="p">,</code>
                                <code class="s">"Finance ministers"</code> <code class="p">,</code>
                                <code class="s">"Oil prices"</code> <code class="p">,</code> <code class="s">"oil"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>In the following examples, we will use the main method in the class <strong>JenaApi</strong> (developed in the next section) that allows us to load multiple RDF input files and then to interactively enter SPARQL queries.</p>

<p>We will start with a simple SPARQL query for subjects (news article URLs) and objects (matching countries) with the value for the predicate equal to <strong>containsCountry</strong>. Variables in queries start with a question mark character and can have any names:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
      <code class="k">WHERE</code> <code class="p">{</code>
        <code class="nv">?subject</code>
        <code class="nl">&lt;http://knowledgebooks.com/ontology#containsCountry&gt;</code>
        <code class="nv">?object</code> <code class="p">.</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>It is important for you to understand what is happening when we apply the last SPARQL query to our sample data. Conceptually, all the triples in the sample data are scanned, keeping the ones where the predicate part of a triple is equal to <strong><a href="http://knowledgebooks.com/ontology#containsCountry">http://knowledgebooks.com/ontology#containsCountry</a></strong>. In practice RDF data stores supporting SPARQL queries index RDF data so a complete scan of the sample data is not required. This is analogous to relational databases where indices are created to avoid needing to perform complete scans of database tables.</p>

<p>In practice, when you are exploring a Knowledge Graph like DBPedia or WikiData (that are just very large collections of RDF triples), you might run a query and discover a useful or interesting entity URI in the triple store, then drill down to find out more about the entity. In a later chapter <a href="#kgn">Knowledge Graph Navigator</a> we attempt to automate this exploration process using the DBPedia data as a Knowledge Graph.</p>

<p>We will be using the same code to access the small example of RDF statements in our sample data as we will for accessing DBPedia or WikiData.</p>

<p>We can make this last query easier to read and reduce the chance of misspelling errors by using a namespace prefix:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
  <code class="k">WHERE</code> <code class="p">{</code>
      <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nv">?object</code> <code class="p">.</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>Later in the chapter <a href="#kgn">Knowledge Graph Navigator</a> we will write an application that automatically generates SPARQL queries for the DBPedia public knowledge Graph. These queries will be be more complex than the simpler examples here. Reading this chapter before <a href="#kgn">Knowledge Graph Navigator</a> is recommended.</p>

<h3 id="leanpub-auto-case-study-using-sparql-to-find-information-about-board-of-directors-members-of-corporations-and-organizations">Case Study: Using SPARQL to Find Information about Board of Directors Members of Corporations and Organizations</h3>

<p>Before we write software to automate the process of using SPARQL queries to find information on DBPedia, let’s perform a few manual queries for finding information on board of directors of corportations. To start with, we would like to find an RDF property that indicates board membership. There is a common expression for finding information on the web using search engines and also for using SPARQL queries: “follow your nose,” that is, when you see something interesting, dig down with more queries on whatever interests you.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?s</code> 
<code class="k">WHERE</code> <code class="p">{</code> 
    <code class="nv">?s</code> <code class="nv">?p</code> <code class="s">"Board of Directors"</code><code class="o">@</code><code class="nf">en</code> <code class="p">.</code>
    <code class="k">FILTER</code> <code class="p">(</code><code class="nv">?p</code> <code class="k">IN</code> <code class="p">(</code><code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</code><code class="p">,</code> <code class="o">&lt;</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">xmlns</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">f\</code>
<code class="err">oaf</code><code class="o">/</code><code class="mf">0.1</code><code class="o">/</code><code class="err">name</code><code class="o">&gt;</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="o">!</code><code class="nf">regex</code><code class="p">(</code><code class="nf">str</code><code class="p">(</code><code class="nv">?s</code><code class="p">),</code> <code class="s">"category"</code><code class="p">,</code> <code class="s">"i"</code><code class="p">))</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>We will find the property:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Board_of_Directors</code>
</pre></div>

</figure>

<p>RDF </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="nv">?s</code> <code class="nv">?p</code> <code class="p">{</code> <code class="nv">?s</code> <code class="nv">?p</code> <code class="nl">&lt;http://dbpedia.org/resource/Board_of_Directors&gt;</code> <code class="p">}</code> <code class="k">limit</code> <code class="mi">6</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">s</code>	<code class="err">p</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">en</code><code class="p">.</code><code class="err">wikipedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">wiki</code><code class="o">/</code><code class="err">Board_of_Directors</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">xmlns</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">foaf</code><code class="o">/</code><code class="mf">0.1</code><code class="o">/</code><code class="err">primaryTop\</code>
<code class="err">ic</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Lynn_D</code><code class="p">.</code><code class="err">_Stewart_</code><code class="p">(</code><code class="err">businessman</code><code class="p">)</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">ontolog\</code>
<code class="err">y</code><code class="o">/</code><code class="err">board</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Advance_America_Cash_Advance</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">ontology\</code>
<code class="o">/</code><code class="err">keyPerson</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Railways_of_Slovak_Republic</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">ontology</code><code class="o">/</code><code class="err">\</code>
<code class="err">keyPerson</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Divine_Word_University_of_Tacloban__DWU_Jubilee_Foundati\</code>
<code class="err">on</code><code class="p">,</code><code class="err">_Inc</code><code class="p">.</code><code class="err">__</code><code class="mi">1</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">ontology</code><code class="o">/</code><code class="err">keyPerson</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Mathys_Medical</code>
</pre></div>

</figure>

<p>The property <strong><a href="http://dbpedia.org/ontology/board">http://dbpedia.org/ontology/board</a></strong> is what we are looking for. Let’s keep “following our nose” to find examples of board members and the companies they server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="nv">?person</code> <code class="nv">?company</code> <code class="p">{</code> <code class="nv">?person</code> <code class="nl">&lt;http://dbpedia.org/ontology/board&gt;</code> <code class="nv">?company</code><code class="p">}</code> <code class="err">limi\</code>
<code class="err">t</code> <code class="mi">6</code>
</pre></div>

</figure>

<p>The results are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">person</code>	<code class="err">company</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Matthew_Buckland</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Creative_Co\</code>
<code class="err">mmons</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Jimmy_Wales</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Creative_Commons</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Nabeel_Rajab</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Human_Rights_W</code><code class="k">a</code><code class="err">\</code>
<code class="err">tch</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Vincent_Tewson</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">International\</code>
<code class="err">_Confederation_of_Free_Trade_Unions</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">William_T</code><code class="p">.</code><code class="err">_Young</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">KFC</code>
<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">Colonel_Sanders</code>	<code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">dbpedi</code><code class="k">a</code><code class="p">.</code><code class="err">org</code><code class="o">/</code><code class="err">resource</code><code class="o">/</code><code class="err">KFC</code>
</pre></div>

</figure>

<p>Let’s see what information we can find on the founder of WikiPedi Jimmy Wales:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="nv">?p</code> <code class="nv">?o</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Jimmy_Wales&gt;</code> <code class="nv">?p</code> <code class="nv">?o</code> <code class="p">}</code> <code class="k">limit</code> <code class="mi">200</code>
</pre></div>

</figure>

<p>A few of the many results are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">p</code><code class="w">	</code><code class="n">o</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">2002</code><code class="o">/</code><code class="mi">07</code><code class="o">/</code><code class="n">owl#Thing</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">xmlns</code><code class="p">.</code><code class="n">com</code><code class="o">/</code><code class="n">foaf</code><code class="o">/</code><code class="mf">0.1</code><code class="o">/</code><code class="n">Person</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">dbpedia</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="n">ontology</code><code class="o">/</code><code class="n">Person</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">wikidata</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="n">entity</code><code class="o">/</code><code class="n">Q2156</code><code class="err">\</code><code class="w"></code>
<code class="mi">27</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">wikidata</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="n">entity</code><code class="o">/</code><code class="n">Q2422</code><code class="err">\</code><code class="w"></code>
<code class="mi">9398</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">wikidata</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="n">entity</code><code class="o">/</code><code class="n">Q5</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">dbpedia</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="n">ontology</code><code class="o">/</code><code class="n">Agent</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="k">schema</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="n">Person</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">dbpedia</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="k">class</code><code class="o">/</code><code class="n">yago</code><code class="o">/</code><code class="n">Wikica</code><code class="err">\</code><code class="w"></code>
<code class="n">tAmericanComputerScientists</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="n">rdf</code><code class="o">-</code><code class="n">syntax</code><code class="o">-</code><code class="n">ns#type</code><code class="w">	</code><code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">dbpedia</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="k">class</code><code class="o">/</code><code class="n">yago</code><code class="o">/</code><code class="n">Wikica</code><code class="err">\</code><code class="w"></code>
<code class="n">tAmericanExpatriatesInTheUnitedKingdom</code><code class="w"></code>
<code class="nl">http</code><code class="p">:</code><code class="o">//</code><code class="n">www</code><code class="p">.</code><code class="n">w3</code><code class="p">.</code><code class="n">org</code><code class="o">/</code><code class="mi">2000</code><code class="o">/</code><code class="mi">01</code><code class="o">/</code><code class="n">rdf</code><code class="o">-</code><code class="k">schema</code><code class="n">#label</code><code class="w">	</code>
<code class="ss">"Jimmy Wales"</code><code class="nv">@en</code><code class="w"></code>
</pre></div>

</figure>

<h3 id="leanpub-auto-installing-the-apache-jena-fuseki-rdf-server">Installing the Apache Jena Fuseki RDF Server</h3>

<p>TBD</p>

<p>I have a github repository <a href="https://github.com/mark-watson/fuseki-semantic-web-dev-setup">mark-watson/fuseki-semantic-web-dev-setup</a>mthat you shoud clone:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>git clone https://github.com/mark-watson/fuseki-semantic-web-dev-setup.git
<code class="linenos">2 </code>cd fuseki-semantic-web-dev-setup
<code class="linenos">3 </code>./fuseki-server --file RDF/sample_news.nt /news
</pre></div>

</figure>

<p>This will run the SPARQL server Fuseki locally on your laptop and the default graph is “news” and you will see output like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">$</code> <code class="o">./</code><code class="n">fuseki</code><code class="o">-</code><code class="n">server</code> <code class="o">--</code><code class="n">file</code> <code class="n">RDF</code><code class="o">/</code><code class="n">sample_news</code><code class="o">.</code><code class="n">nt</code> <code class="o">/</code><code class="n">news</code>
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">13</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">Dataset</code><code class="p">:</code> <code class="ow">in</code><code class="o">-</code><code class="n">memory</code><code class="p">:</code> <code class="nb">load</code> <code class="n">file</code><code class="p">:</code> <code class="n">RDF</code><code class="o">/</code><code class="n">sample_new</code>\
<code class="linenos"> 3 </code><code class="n">s</code><code class="o">.</code><code class="n">nt</code>
<code class="linenos"> 4 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">14</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">Running</code> <code class="ow">in</code> <code class="n">read</code><code class="o">-</code><code class="n">only</code> <code class="n">mode</code> <code class="k">for</code> <code class="o">/</code><code class="n">news</code>
<code class="linenos"> 5 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">14</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">Apache</code> <code class="n">Jena</code> <code class="n">Fuseki</code> <code class="mf">3.16</code><code class="o">.</code><code class="mi">0</code>
<code class="linenos"> 6 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">14</code><code class="p">]</code> <code class="n">Config</code>     <code class="n">INFO</code>  <code class="n">FUSEKI_HOME</code><code class="o">=/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="n">GITHUB</code><code class="o">/</code><code class="n">fuseki</code><code class="o">-</code><code class="n">semant</code>\
<code class="linenos"> 7 </code><code class="n">ic</code><code class="o">-</code><code class="n">web</code><code class="o">-</code><code class="n">dev</code><code class="o">-</code><code class="n">setup</code><code class="o">/.</code>
<code class="linenos"> 8 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">14</code><code class="p">]</code> <code class="n">Config</code>     <code class="n">INFO</code>  <code class="n">FUSEKI_BASE</code><code class="o">=/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="n">GITHUB</code><code class="o">/</code><code class="n">fuseki</code><code class="o">-</code><code class="n">semant</code>\
<code class="linenos"> 9 </code><code class="n">ic</code><code class="o">-</code><code class="n">web</code><code class="o">-</code><code class="n">dev</code><code class="o">-</code><code class="n">setup</code><code class="o">/</code><code class="n">run</code>
<code class="linenos">10 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">14</code><code class="p">]</code> <code class="n">Config</code>     <code class="n">INFO</code>  <code class="n">Shiro</code> <code class="n">file</code><code class="p">:</code> <code class="n">file</code><code class="p">:</code><code class="o">///</code><code class="n">Users</code><code class="o">/</code><code class="n">markw</code><code class="o">/</code><code class="n">GITHUB</code><code class="o">/</code><code class="n">fuseki</code>\
<code class="linenos">11 </code><code class="o">-</code><code class="n">semantic</code><code class="o">-</code><code class="n">web</code><code class="o">-</code><code class="n">dev</code><code class="o">-</code><code class="n">setup</code><code class="o">/</code><code class="n">run</code><code class="o">/</code><code class="n">shiro</code><code class="o">.</code><code class="n">ini</code>
<code class="linenos">12 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">Dataset</code> <code class="n">Type</code><code class="p">:</code> <code class="ow">in</code><code class="o">-</code><code class="n">memory</code><code class="p">,</code> <code class="n">with</code> <code class="n">files</code> <code class="n">loaded</code>
<code class="linenos">13 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">Path</code> <code class="o">=</code> <code class="o">/</code><code class="n">news</code>
<code class="linenos">14 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">System</code>
<code class="linenos">15 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>    <code class="n">Memory</code><code class="p">:</code> <code class="mf">4.0</code> <code class="n">GiB</code>
<code class="linenos">16 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>    <code class="n">Java</code><code class="p">:</code>   <code class="mf">14.0</code><code class="o">.</code><code class="mi">1</code>
<code class="linenos">17 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>    <code class="n">OS</code><code class="p">:</code>     <code class="n">Mac</code> <code class="n">OS</code> <code class="n">X</code> <code class="mf">10.15</code><code class="o">.</code><code class="mi">7</code> <code class="n">x86_64</code>
<code class="linenos">18 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>    <code class="n">PID</code><code class="p">:</code>    <code class="mi">3855</code>
<code class="linenos">19 </code><code class="p">[</code><code class="mi">2020</code><code class="o">-</code><code class="mi">11</code><code class="o">-</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code><code class="p">]</code> <code class="n">Server</code>     <code class="n">INFO</code>  <code class="n">Started</code> <code class="mi">2020</code><code class="o">/</code><code class="mi">11</code><code class="o">/</code><code class="mi">07</code> <code class="mi">09</code><code class="p">:</code><code class="mi">31</code><code class="p">:</code><code class="mi">15</code> <code class="n">MST</code> <code class="n">on</code> <code class="n">port</code> <code class="mi">3030</code>
</pre></div>

</figure>

<p>You can access a web interface for SPARQL queries by accessing localhost:3030 or http:127.0.0.1:3030.</p>

<h3 id="leanpub-auto-common-lisp-client-examples-for-the-apache-jena-fuseki-rdf-server">Common Lisp Client Examples for the Apache Jena Fuseki RDF Server</h3>

<p>Later in the chapter “Knowledge Graph Navigator” we will develop a simple Common Lisp SPARQL query library and use it for querying DBPedia. Here we will use it to query our local Fuseki server.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">sbcl</code>
<code class="linenos"> 2 </code><code class="nv">This</code> <code class="nv">is</code> <code class="nv">SBCL</code> <code class="nv">2.0.7,</code> <code class="nv">an</code> <code class="nv">implementation</code> <code class="nv">of</code> <code class="nv">ANSI</code> <code class="nv">Common</code> <code class="nv">Lisp.</code>
<code class="linenos"> 3 </code><code class="nv">More</code> <code class="nv">information</code> <code class="nv">about</code> <code class="nv">SBCL</code> <code class="nv">is</code> <code class="nv">available</code> <code class="nv">at</code> <code class="nv">&lt;http://www.sbcl.org/&gt;.</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nv">SBCL</code> <code class="nv">is</code> <code class="nv">free</code> <code class="nv">software,</code> <code class="nv">provided</code> <code class="nv">as</code> <code class="nv">is,</code> <code class="nv">with</code> <code class="nv">absolutely</code> <code class="nv">no</code> <code class="nv">warranty.</code>
<code class="linenos"> 6 </code><code class="nv">It</code> <code class="nv">is</code> <code class="nv">mostly</code> <code class="nv">in</code> <code class="k">the</code> <code class="nv">public</code> <code class="nv">domain</code><code class="c1">; some portions are provided under</code>
<code class="linenos"> 7 </code><code class="nv">BSD-style</code> <code class="nv">licenses.</code>  <code class="nv">See</code> <code class="k">the</code> <code class="nv">CREDITS</code> <code class="nb">and</code> <code class="nv">COPYING</code> <code class="nv">files</code> <code class="nv">in</code> <code class="k">the</code>
<code class="linenos"> 8 </code><code class="nv">distribution</code> <code class="nv">for</code> <code class="nv">more</code> <code class="nv">information.</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="l l-Other">#P"/Users/markw/quicklisp/setup.lisp"</code> 
<code class="linenos">11 </code><code class="s">"starting up quicklisp"</code> 
<code class="linenos">12 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">quicklisp:quickload</code> <code class="s">"sparql"</code><code class="p">)</code>
<code class="linenos">13 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"sparql"</code><code class="err">:</code>
<code class="linenos">14 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos">15 </code>    <code class="nv">sparql</code>
<code class="linenos">16 </code><code class="c1">; Loading "sparql"</code>
<code class="linenos">17 </code><code class="o">...............</code>
<code class="linenos">18 </code><code class="p">(</code><code class="s">"sparql"</code><code class="p">)</code>
<code class="linenos">19 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">sparql::fuseki</code> <code class="s">"select ?s ?p ?o { ?s ?p ?o } limit 20"</code><code class="p">)</code>
<code class="linenos">20 </code><code class="p">(((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/trout_season/"</code><code class="p">)</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#storyType"</code><code class="p">)</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"http://knowledgebooks.com/ontology/#recreation"</code><code class="p">))</code>
<code class="linenos">23 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/trout_season/"</code><code class="p">)</code>
<code class="linenos">24 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#storyType"</code><code class="p">)</code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"http://knowledgebooks.com/ontology/#sports"</code><code class="p">))</code>
<code class="linenos">26 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/bear_mountain_fire/"</code><code class="p">)</code>
<code class="linenos">27 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#storyType"</code><code class="p">)</code>
<code class="linenos">28 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"http://knowledgebooks.com/ontology/#disaster"</code><code class="p">))</code>
<code class="linenos">29 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/bear_mountain_fire/"</code><code class="p">)</code>
<code class="linenos">30 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#summary"</code><code class="p">)</code>
<code class="linenos">31 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"The fire on Bear Mountain was caused by lightening"</code><code class="p">))</code>
<code class="linenos">32 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/jc_basketball/"</code><code class="p">)</code>
<code class="linenos">33 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#storyType"</code><code class="p">)</code>
<code class="linenos">34 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"http://knowledgebooks.com/ontology/#sports"</code><code class="p">))</code>
<code class="linenos">35 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/oak_creek_flooding/"</code><code class="p">)</code>
<code class="linenos">36 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#storyType"</code><code class="p">)</code>
<code class="linenos">37 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"http://knowledgebooks.com/ontology/#disaster"</code><code class="p">))</code>
<code class="linenos">38 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://kbsportal.com/oak_creek_flooding/"</code><code class="p">)</code>
<code class="linenos">39 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://knowledgebooks.com/ontology/#summary"</code><code class="p">)</code>
<code class="linenos">40 </code>  <code class="p">(</code><code class="ss">:o</code> <code class="s">"Oak Creek flooded last week affecting 5 businesses"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Here is an example of using the same library to query the public DBPedia SPARQL endpoint (most output is not shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">sparql:dbpedia</code> <code class="s">"select ?s ?p { ?s ?p \"Bill Gates\"@en }"</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="s">"ndbpeia SPARQL:n"</code> <code class="s">"select ?s ?p { ?s ?p \"Bill Gates\"@en }"</code> <code class="s">"n"</code><code class="p">)</code> 
<code class="linenos"> 4 </code><code class="p">(((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Category:Bill_Gates"</code><code class="p">)</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://www.w3.org/2000/01/rdf-schema#label"</code><code class="p">))</code>
<code class="linenos"> 6 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://www.wikidata.org/entity/Q5284"</code><code class="p">)</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://www.w3.org/2000/01/rdf-schema#label"</code><code class="p">))</code>
<code class="linenos"> 8 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Bill_Gates"</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="ss">:p</code> <code class="s">"http://xmlns.com/foaf/0.1/name"</code><code class="p">))</code>
<code class="linenos">10 </code> <code class="p">)</code>
</pre></div>

</figure>

<p>The SPARQL library in the github repository for this book also supports the commercial products AllegroGraph and Stardog RDF servers.</p>


<h2 id="kgcreator">Automatically Generating Data for Knowledge Graphs</h2>

<p>We develop a complete application. The Knowledge Graph Creator (KGcreator) is a tool for automating the generation of data for Knowledge Graphs from raw text data. We will see how to create a single standalone executable file using SBCL Common Lisp. The application can also be run during development from a repl. This application also implements a web application interface. In addition to the KGcreator application we will close the chapter with a utiity library that processes a file of RDF in N-Triple format and generates an extention file with triples pulled from DBedia defining URIs found in the input data file.</p>

<p>Data created by KGcreator generates data in two formats:</p>

<ul>
  <li>Neo4j graph database format (text format)</li>
  <li>RDF triples suitable for loading into any linked data/semantic web data store.</li>
</ul>

<p>This example application works by identifying entities in text. Example entity types are people, companies, country names, city names, broadcast network names, political party names, and university names. We saw earlier code for detecting entities in the chapter on natural language processing (NLP) and we will reuse this code. We will discuss later three strategies for reusing code from different projects.</p>

<p>When I originally wrote KGCreator I intended to develop a commercial product. I wrote two research prototypes, one in Common Lisp (the example in this chapter) and one in Haskell (which I also use as an example in my book <a href="https://leanpub.com/haskell-cookbook/">Haskell Tutorial and Cookbook</a>. I decided to open source both versions of KGCreator and if you work with Knowledge Graphs I hope you find KGCreator useful in your work.</p>

<p>The following figure shows part of a Neo4j Knowledge Graph created with the example code. This graph has shortened labels in displayed nodes but Neo4j offers a web browser-based console that lets you interactively explore Knowledge Graphs. We don’t cover setting up Neo4j here so please use the <a href="https://neo4j.com/docs/operations-manual/current/introduction/">Neo4j documentation</a>. As an introduction to RDF data, the semantic web, and linked data you can get free copies of my two books <a href="http://markwatson.com/opencontentdata/book_lisp.pdf">Practical Semantic Web and Linked Data Applications, Common Lisp Edition</a> and <a href="http://markwatson.com/opencontentdata/book_java.pdf">Practical Semantic Web and Linked Data Applications, Java, Scala, Clojure, and JRuby Edition</a>.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 80%">
    <img src="images/neo4j.jpg" alt="Part of a Knowledge Graph shown in Neo4j web application console" style="width: 100%">
    <figcaption>Part of a Knowledge Graph shown in Neo4j web application console</figcaption>
  </figure>
</div>


<p>Here is a detail view:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 50%">
    <img src="images/neo4j_ex1.jpg" alt="Detail of Neo4j console" style="width: 100%">
    <figcaption>Detail of Neo4j console</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-implementation-notes">Implementation Notes</h3>

<p>As seen in the file <strong>src /kgcreator/package.lisp</strong> this application uses several other packages:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:kgcreator</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code>
<code class="linenos">3 </code>        <code class="ss">#:entities_dbpedia</code> <code class="ss">#:categorize_summarize</code> <code class="ss">#:myutils</code>
<code class="linenos">4 </code>        <code class="ss">#:cl-who</code> <code class="ss">#:hunchentoot</code> <code class="ss">#:parenscript</code><code class="p">)</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="ss">:export</code> <code class="nv">kgcreator</code><code class="p">))</code>
</pre></div>

</figure>

<p>The implementation of the packages shown on line 3 were in a previous chapter. The package <strong>myutils</strong> are mostly miscellaneous string utilities that we won’t look at here; I leave it to you to read the source code.</p>

<p>As seen in the configuration file <strong>src/kgcreator/kgcreator.asd</strong> we split the implementation of the application into four source files:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;;; kgcreator.asd</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:kgcreator</code>
<code class="linenos"> 4 </code>  <code class="ss">:description</code> <code class="s">"Describe plotlib here"</code>
<code class="linenos"> 5 </code>  <code class="ss">:author</code> <code class="s">"Mark Watson &lt;mark.watson@gmail.com&gt;"</code>
<code class="linenos"> 6 </code>  <code class="ss">:license</code> <code class="s">"AGPL version 3"</code>
<code class="linenos"> 7 </code>  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:entities_dbpedia</code> <code class="ss">#:categorize_summarize</code>
<code class="linenos"> 8 </code>               <code class="ss">#:myutils</code> <code class="ss">#:unix-opts</code> <code class="ss">#:cl-who</code>
<code class="linenos"> 9 </code>               <code class="ss">#:hunchentoot</code> <code class="ss">#:parenscript</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="ss">:components</code>
<code class="linenos">11 </code>    <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
<code class="linenos">12 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"kgcreator"</code><code class="p">)</code>
<code class="linenos">13 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"neo4j"</code><code class="p">)</code>
<code class="linenos">14 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"rdf"</code><code class="p">)</code>
<code class="linenos">15 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"web"</code><code class="p">))</code>
<code class="linenos">16 </code>                 <code class="p">)</code>
</pre></div>

</figure>

<p>The application is separated into four source files:</p>

<ul>
  <li>kgcreator.lisp: top level APIs and functionality. Uses the code in neo4j.lisp and rdf.lisp. Later we will generate a standalone application that uses these top level APIs</li>
  <li>neo4j.lisp: generates Cyper text files that can be imported into Neo4j</li>
  <li>
    <ul>
      <li>rdf.lisp: generates RDF text data that can be loaded or imported into RDF data stores</li>
    </ul>
  </li>
  <li>web.lisp: a simple web application for running KGCreator</li>
</ul>

<h3 id="leanpub-auto-generating-rdf-data">Generating RDF Data</h3>

<p>I leave it to you find a tutorial on RDF data on the web, or you can get a <a href="http://markwatson.com/opencontentdata/book_lisp.pdf">PDF for my book “Practical Semantic Web and Linked Data Applications, Common Lisp Edition”</a> and read the tutorial sections on RDF.</p>

<p>RDF data is comprised of triples, where the value for each triple are a subject, a predicate, and an object. Subjects are URIs, predicates are usually URIs, and objects are either literal values or URIs. Here are two triples written by this example application:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>&lt;http://dbpedia.org/resource/The_Wall_Street_Journal&gt; 
  &lt;http://knowledgebooks.com/schema/aboutCompanyName&gt; 
  "Wall Street Journal" .
&lt;https://newsshop.com/june/z902.html&gt;
  &lt;http://knowledgebooks.com/schema/containsCountryDbPediaLink&gt;
  &lt;http://dbpedia.org/resource/Canada&gt; .
</pre></div>

</figure>

<p>The following listing of the file <strong>src/kgcreator/rdf.lisp</strong> generates RDF data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="vg">*rdf-nodes-hash*</code><code class="p">))</code>
<code class="linenos"> 4 </code>  
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">rdf-from-files</code> <code class="p">(</code><code class="nv">output-file-path</code> <code class="nv">text-and-meta-pairs</code><code class="p">)</code>
<code class="linenos"> 6 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="vg">*rdf-nodes-hash*</code> <code class="p">(</code><code class="nb">make-hash-table</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code> <code class="ss">:size</code> <code class="mi">200</code><code class="p">))</code>
<code class="linenos"> 7 </code>    <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"==&gt; rdf-from-files"</code> <code class="nv">output-file-path</code> <code class="nv">text-and-meta-pairs</code> <code class="p">))</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nb">with-open-file</code>
<code class="linenos"> 9 </code>        <code class="p">(</code><code class="nv">str</code> <code class="nv">output-file-path</code>
<code class="linenos">10 </code>             <code class="ss">:direction</code> <code class="ss">:output</code>
<code class="linenos">11 </code>             <code class="ss">:if-exists</code> <code class="ss">:supersede</code>
<code class="linenos">12 </code>             <code class="ss">:if-does-not-exist</code> <code class="ss">:create</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>      <code class="p">(</code><code class="nb">defun</code> <code class="nv">rdf-from-files-handle-single-file</code> <code class="p">(</code><code class="nv">text-input-file</code> <code class="nv">meta-input-file</code><code class="p">)</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">text</code> <code class="p">(</code><code class="nv">file-to-string</code> <code class="nv">text-input-file</code><code class="p">))</code>
<code class="linenos">16 </code>               <code class="p">(</code><code class="nv">words</code> <code class="p">(</code><code class="nv">myutils:words-from-string</code> <code class="nv">text</code><code class="p">))</code>
<code class="linenos">17 </code>               <code class="p">(</code><code class="nv">meta</code> <code class="p">(</code><code class="nv">file-to-string</code> <code class="nv">meta-input-file</code><code class="p">)))</code>
<code class="linenos">18 </code>                         
<code class="linenos">19 </code>          <code class="p">(</code><code class="nb">defun</code> <code class="nv">generate-original-doc-node-rdf</code> <code class="p">()</code>
<code class="linenos">20 </code>            <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">node-name</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="nv">meta</code><code class="p">)))</code>
<code class="linenos">21 </code>              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">node-name</code> <code class="vg">*rdf-nodes-hash*</code><code class="p">))</code>
<code class="linenos">22 </code>                  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">cats</code> <code class="p">(</code><code class="nv">categorize</code> <code class="nv">words</code><code class="p">))</code>
<code class="linenos">23 </code>                         <code class="p">(</code><code class="nv">sum</code> <code class="p">(</code><code class="nv">summarize</code> <code class="nv">words</code> <code class="nv">cats</code><code class="p">)))</code>
<code class="linenos">24 </code>		    <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"$$$$$$  cats:"</code> <code class="nv">cats</code><code class="p">))</code>
<code class="linenos">25 </code>                    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">node-name</code> <code class="vg">*rdf-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">26 </code>		    <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"&lt;"</code> <code class="nv">meta</code>
<code class="linenos">27 </code>					     <code class="s">"&gt; &lt;http:knowledgebooks.com/schema/summary&gt; \""</code>
<code class="linenos">28 </code>					     <code class="nv">sum</code> <code class="s">"\" . ~%"</code><code class="p">))</code>
<code class="linenos">29 </code>                    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">cat</code> <code class="nv">cats</code><code class="p">)</code>
<code class="linenos">30 </code>                      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">hash-check</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">node-name</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">cat</code><code class="p">))))</code>
<code class="linenos">31 </code>                        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*rdf-nodes-hash*</code><code class="p">))</code>
<code class="linenos">32 </code>                            <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">33 </code>                              <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*rdf-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">34 </code>			      <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code>
<code class="linenos">35 </code>				      <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"&lt;"</code> <code class="nv">meta</code>
<code class="linenos">36 </code>						   <code class="s">"&gt; &lt;http://knowledgebooks.com/schema/"</code>
<code class="linenos">37 </code>						   <code class="s">"topicCategory&gt; "</code>
<code class="linenos">38 </code>						   <code class="s">"&lt;http://knowledgebooks.com/schema/"</code>
<code class="linenos">39 </code>						   <code class="p">(</code><code class="nb">car</code> <code class="nv">cat</code><code class="p">)</code> <code class="s">"&gt; . ~%"</code><code class="p">))))))))))</code>
<code class="linenos">40 </code>          
<code class="linenos">41 </code>          <code class="p">(</code><code class="nb">defun</code> <code class="nv">generate-dbpedia-contains-rdf</code> <code class="p">(</code><code class="nv">key</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">42 </code>            <code class="p">(</code><code class="nv">generate-original-doc-node-rdf</code><code class="p">)</code>
<code class="linenos">43 </code>            <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">relation-name</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">key</code> <code class="s">"DbPediaLink"</code><code class="p">)))</code>
<code class="linenos">44 </code>              <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">entity-pair</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">45 </code>                <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">node-name</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="nv">meta</code><code class="p">))</code>
<code class="linenos">46 </code>                       <code class="p">(</code><code class="nv">object-node-name</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">)))</code>
<code class="linenos">47 </code>                       <code class="p">(</code><code class="nv">hash-check</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">node-name</code> <code class="nv">object-node-name</code><code class="p">)))</code>
<code class="linenos">48 </code>                  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*rdf-nodes-hash*</code><code class="p">))</code>
<code class="linenos">49 </code>                      <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">50 </code>                        <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*rdf-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">51 </code>			<code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"&lt;"</code> <code class="nv">meta</code>
<code class="linenos">52 </code>					       <code class="s">"&gt; &lt;http://knowledgebooks.com/schema/contains/"</code>
<code class="linenos">53 </code>					       <code class="nv">key</code> <code class="s">"&gt; "</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">)</code> <code class="s">" .~%"</code><code class="p">))))))))))</code>
<code class="linenos">54 </code>
<code class="linenos">55 </code>      
<code class="linenos">56 </code>      <code class="c1">;; start code for rdf-from-files (output-file-path text-and-meta-pairs)</code>
<code class="linenos">57 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">pair</code> <code class="nv">text-and-meta-pairs</code><code class="p">)</code>
<code class="linenos">58 </code>        <code class="p">(</code><code class="nv">rdf-from-files-handle-single-file</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">pair</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">pair</code><code class="p">))</code>
<code class="linenos">59 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">h</code> <code class="p">(</code><code class="nv">entities_dbpedia:find-entities-in-text</code> <code class="p">(</code><code class="nv">file-to-string</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">pair</code><code class="p">))</code><code class="err">\</code>
<code class="linenos">60 </code><code class="p">)))</code>
<code class="linenos">61 </code>          <code class="p">(</code><code class="nv">entities_dbpedia:entity-iterator</code> <code class="nf">#'</code><code class="nv">generate-dbpedia-contains-rdf</code> <code class="nv">h</code><code class="p">))))))</code>
<code class="linenos">62 </code>
<code class="linenos">63 </code>
<code class="linenos">64 </code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">test_files</code> <code class="o">'</code><code class="p">((</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test3.txt"</code>
<code class="linenos">65 </code>                      <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test3.meta"</code><code class="p">)))</code>
<code class="linenos">66 </code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">test_filesZZZ</code> <code class="o">'</code><code class="p">((</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test3.txt"</code>
<code class="linenos">67 </code>                         <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test3.meta"</code><code class="p">)</code>
<code class="linenos">68 </code>                        <code class="p">(</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test2.txt"</code>
<code class="linenos">69 </code>                         <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test2.meta"</code><code class="p">)</code>
<code class="linenos">70 </code>                        <code class="p">(</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test1.txt"</code>
<code class="linenos">71 </code>                         <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test1.meta"</code><code class="p">)))</code>
<code class="linenos">72 </code>
<code class="linenos">73 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test3a</code> <code class="p">()</code>
<code class="linenos">74 </code>  <code class="p">(</code><code class="nv">rdf-from-files</code> <code class="s">"out.rdf"</code> <code class="nv">test_files</code><code class="p">))</code>
</pre></div>

</figure>

<p>You can load all of KGCreator but just execute the test function at the end of this file using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgcreator"</code><code class="p">)</code>
<code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kgcreator:test3a</code><code class="p">)</code>
</pre></div>

</figure>

<p>This code works on a list of paired files for text data and the meta data for each text file. As an example, if there is an input text file test123.txt then there would be a matching meta file test123.meta that contains the source of the data in the file test123.txt. This data source will be a URI on the web or a local file URI. The top level function <strong>rdf-from-files</strong> takes an output file path for writing the generated RDF data and a list of pairs of text and meta file paths.</p>

<p>A global variable <strong>*rdf-nodes-hash*</strong> will be used to remember the nodes in the RDF graph as it is generated. Please note that the function <strong>rdf-from-files</strong> is not re-entrant: it uses the global <strong>*rdf-nodes-hash*</strong> so if you are writing multi-threaded applications it will not work to execute the function <strong>rdf-from-files</strong> simultaneously in multiple threads of execution.</p>

<p>The function <strong>rdf-from-files</strong> (and the nested functions) are straightforward. I left a few debug printout statements in the code and when you run the test code that I left in the bottom of the file, hopefully it will be clear what rdf.lisp is doing. </p>

<h3 id="leanpub-auto-generating-data-for-the-neo4j-graph-database">Generating Data for the Neo4j Graph Database</h3>

<p>Now we will generate Neo4J Cypher data. In order to keep the implementation simple, both the RDF and Cypher generation code starts with raw text and performs the NLP analysis to find entities. This example could be refactored to perform the NLP analysis just one time but in practice you will likely be working with either RDF or NEO4J and so you will probably extract just the code you need from this example (i.e., either the RDF or Cypher generation code).</p>

<p>Before we look at the code, let’s start with a few lines of generated Neo4J Cypher import data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="n">newsshop_com_june_z902_html_news</code><code class="p">)</code><code class="o">-[</code><code class="n">:ContainsCompanyDbPediaLink</code><code class="o">]-&gt;</code><code class="p">(</code><code class="n">Wall_Stree</code><code class="err">\</code><code class="w"></code>
<code class="n">t_Journal</code><code class="p">)</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="nl">Canada</code><code class="p">:</code><code class="n">Entity</code><code class="w"> </code><code class="err">{</code><code class="nl">name</code><code class="p">:</code><code class="ss">"Canada"</code><code class="p">,</code><code class="w"> </code><code class="nl">uri</code><code class="p">:</code><code class="ss">"&lt;http://dbpedia.org/resource/Canada&gt;"</code><code class="err">}</code><code class="p">)</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="n">newsshop_com_june_z902_html_news</code><code class="p">)</code><code class="o">-[</code><code class="n">:ContainsCountryDbPediaLink</code><code class="o">]-&gt;</code><code class="p">(</code><code class="n">Canada</code><code class="p">)</code><code class="w"></code>
<code class="k">CREATE</code><code class="w"> </code><code class="p">(</code><code class="n">summary_of_abcnews_go_com_US_violent_long_lasting_tornadoes_threaten_oklahom</code><code class="err">\</code><code class="w"></code>
<code class="nl">a_texas_storyid63146361</code><code class="p">:</code><code class="n">Summary</code><code class="w"> </code><code class="err">{</code><code class="nl">name</code><code class="p">:</code><code class="ss">"summary_of_abcnews_go_com_US_violent_long_las\</code>
<code class="ss">ting_tornadoes_threaten_oklahoma_texas_storyid63146361"</code><code class="p">,</code><code class="w"> </code><code class="nl">uri</code><code class="p">:</code><code class="ss">"&lt;https://abcnews.go.co\</code>
<code class="ss">m/US/violent-long-lasting-tornadoes-threaten-oklahoma-texas/story?id=63146361&gt;"</code><code class="p">,</code><code class="w"> </code><code class="nf">sum</code><code class="err">\</code><code class="w"></code>
<code class="nl">mary</code><code class="p">:</code><code class="ss">"Part of the system that delivered severe weather to the central U.S. over the \</code>
<code class="ss">weekend is moving into the Northeast today, producing strong to severe storms -- dam\</code>
<code class="ss">aging winds, hail or isolated tornadoes can't be ruled out. Severe weather is foreca\</code>
<code class="ss">st to continue on Tuesday, with the western storm moving east into the Midwest and p\</code>
<code class="ss">arts of the mid-Mississippi Valley."</code><code class="err">}</code><code class="p">)</code><code class="w"></code>
</pre></div>

</figure>

<p>The following listing of file <strong>src/kgcreator/neo4j.lisp</strong> is similar to the code that generated RDF in the last section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="vg">*entity-nodes-hash*</code><code class="p">))</code>
<code class="linenos"> 4 </code>  
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nb">defun</code> <code class="nv">cypher-from-files</code> <code class="p">(</code><code class="nv">output-file-path</code> <code class="nv">text-and-meta-pairs</code><code class="p">)</code>
<code class="linenos"> 6 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="vg">*entity-nodes-hash*</code> <code class="p">(</code><code class="nb">make-hash-table</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code> <code class="ss">:size</code> <code class="mi">200</code><code class="p">))</code>
<code class="linenos"> 7 </code>    <code class="c1">;;(print (list "==&gt; cypher-from-files"output-file-path text-and-meta-pairs ))</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nb">with-open-file</code>
<code class="linenos"> 9 </code>	<code class="p">(</code><code class="nv">str</code> <code class="nv">output-file-path</code>
<code class="linenos">10 </code>	     <code class="ss">:direction</code> <code class="ss">:output</code>
<code class="linenos">11 </code>	     <code class="ss">:if-exists</code> <code class="ss">:supersede</code> 
<code class="linenos">12 </code>	     <code class="ss">:if-does-not-exist</code> <code class="ss">:create</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>      <code class="p">(</code><code class="nb">defun</code> <code class="nv">generateNeo4jCategoryNodes</code> <code class="p">()</code>
<code class="linenos">15 </code>	<code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">names</code> <code class="nv">categorize_summarize::categoryNames</code><code class="p">))</code>
<code class="linenos">16 </code>	  <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">name</code> <code class="nv">names</code><code class="p">)</code>
<code class="linenos">17 </code>	    <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code>
<code class="linenos">18 </code>		    <code class="p">(</code><code class="nv">myutils:replace-all</code>
<code class="linenos">19 </code>		     <code class="p">(</code><code class="nb">concatenate</code>
<code class="linenos">20 </code>		      <code class="ss">'string</code> <code class="s">"CREATE ("</code> <code class="nv">name</code> <code class="s">":CategoryType {name:\""</code> <code class="nv">name</code> <code class="s">"\"})~%"</code><code class="p">)</code>
<code class="linenos">21 </code>		     <code class="s">"/"</code> <code class="s">"_"</code><code class="p">))))</code>
<code class="linenos">22 </code>	<code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="s">"~%"</code><code class="p">))</code>
<code class="linenos">23 </code>      
<code class="linenos">24 </code>
<code class="linenos">25 </code>      <code class="p">(</code><code class="nb">defun</code> <code class="nv">cypher-from-files-handle-single-file</code> <code class="p">(</code><code class="nv">text-input-file</code> <code class="nv">meta-input-file</code><code class="p">)</code>
<code class="linenos">26 </code>	<code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">text</code> <code class="p">(</code><code class="nv">file-to-string</code> <code class="nv">text-input-file</code><code class="p">))</code>
<code class="linenos">27 </code>	       <code class="p">(</code><code class="nv">words</code> <code class="p">(</code><code class="nv">myutils:words-from-string</code> <code class="nv">text</code><code class="p">))</code>
<code class="linenos">28 </code>	       <code class="p">(</code><code class="nv">meta</code> <code class="p">(</code><code class="nv">file-to-string</code> <code class="nv">meta-input-file</code><code class="p">)))</code>
<code class="linenos">29 </code>	       	  
<code class="linenos">30 </code>	  <code class="p">(</code><code class="nb">defun</code> <code class="nv">generate-original-doc-node</code> <code class="p">()</code>
<code class="linenos">31 </code>	    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">node-name</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="nv">meta</code><code class="p">)))</code>
<code class="linenos">32 </code>	      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">node-name</code> <code class="vg">*entity-nodes-hash*</code><code class="p">))</code>
<code class="linenos">33 </code>		  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">cats</code> <code class="p">(</code><code class="nv">categorize</code> <code class="nv">words</code><code class="p">))</code>
<code class="linenos">34 </code>			 <code class="p">(</code><code class="nv">sum</code> <code class="p">(</code><code class="nv">summarize</code> <code class="nv">words</code> <code class="nv">cats</code><code class="p">)))</code>
<code class="linenos">35 </code>		    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">node-name</code> <code class="vg">*entity-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">36 </code>		    <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"CREATE ("</code> <code class="nv">node-name</code> <code class="s">":News {name:\""</code>
<code class="linenos">37 </code>					     <code class="nv">node-name</code> <code class="s">"\", uri: \""</code> <code class="nv">meta</code>
<code class="linenos">38 </code>               <code class="s">"\", summary: \""</code> <code class="nv">sum</code> <code class="s">"\"})~%"</code><code class="p">))</code>
<code class="linenos">39 </code>		    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">cat</code> <code class="nv">cats</code><code class="p">)</code>
<code class="linenos">40 </code>		      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">hash-check</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">node-name</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">cat</code><code class="p">))))</code>
<code class="linenos">41 </code>			<code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*entity-nodes-hash*</code><code class="p">))</code>
<code class="linenos">42 </code>			    <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">43 </code>			      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*entity-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">44 </code>			      <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"CREATE ("</code> <code class="nv">node-name</code>
<code class="linenos">45 </code>                                     <code class="s">")-[:Category]-&gt;("</code>
<code class="linenos">46 </code>						       <code class="p">(</code><code class="nb">car</code> <code class="nv">cat</code><code class="p">)</code> <code class="s">")~%"</code><code class="p">))))))))))</code>
<code class="linenos">47 </code>	  
<code class="linenos">48 </code>	  <code class="p">(</code><code class="nb">defun</code> <code class="nv">generate-dbpedia-nodes</code> <code class="p">(</code><code class="nv">key</code> <code class="nv">entity-pairs</code><code class="p">)</code>
<code class="linenos">49 </code>	    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">entity-pair</code> <code class="nv">entity-pairs</code><code class="p">)</code>
<code class="linenos">50 </code>	      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">))</code>
<code class="linenos">51 </code>                           <code class="vg">*entity-nodes-hash*</code><code class="p">))</code>
<code class="linenos">52 </code>		  <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">53 </code>		    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">))</code> <code class="vg">*entity-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">54 </code>		    <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code>
<code class="linenos">55 </code>			    <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"CREATE ("</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">))</code> <code class="s">":"</code>
<code class="linenos">56 </code>					 <code class="nv">key</code> <code class="s">" {name: \""</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">entity-pair</code><code class="p">)</code>
<code class="linenos">57 </code>					 <code class="s">"\", uri: \""</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">)</code> <code class="s">"\"})~%"</code><code class="p">))))))</code>
<code class="linenos">58 </code>	  
<code class="linenos">59 </code>	  <code class="p">(</code><code class="nb">defun</code> <code class="nv">generate-dbpedia-contains-cypher</code> <code class="p">(</code><code class="nv">key</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">60 </code>	    <code class="p">(</code><code class="nv">generate-original-doc-node</code><code class="p">)</code>
<code class="linenos">61 </code>	    <code class="p">(</code><code class="nv">generate-dbpedia-nodes</code> <code class="nv">key</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">62 </code>	    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">relation-name</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">key</code> <code class="s">"DbPediaLink"</code><code class="p">)))</code>
<code class="linenos">63 </code>	      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">entity-pair</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">64 </code>		<code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">node-name</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="nv">meta</code><code class="p">))</code>
<code class="linenos">65 </code>		       <code class="p">(</code><code class="nv">object-node-name</code> <code class="p">(</code><code class="nv">node-name-from-uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">entity-pair</code><code class="p">)))</code>
<code class="linenos">66 </code>		       <code class="p">(</code><code class="nv">hash-check</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">node-name</code> <code class="nv">object-node-name</code><code class="p">)))</code>
<code class="linenos">67 </code>		  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*entity-nodes-hash*</code><code class="p">))</code>
<code class="linenos">68 </code>		      <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">69 </code>			<code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nb">gethash</code> <code class="nv">hash-check</code> <code class="vg">*entity-nodes-hash*</code><code class="p">)</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">70 </code>			<code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code>
<code class="linenos">71 </code>						 <code class="s">"CREATE ("</code> <code class="nv">node-name</code> <code class="s">")-[:"</code>
<code class="linenos">72 </code>						 <code class="nv">relation-name</code> <code class="s">"]-&gt;("</code> <code class="nv">object-node-name</code> <code class="s">")~%"</code><code class="p">))))))))))</code>
<code class="linenos">73 </code>
<code class="linenos">74 </code>      
<code class="linenos">75 </code>      <code class="c1">;; start code for cypher-from-files (output-file-path text-and-meta-pairs)</code>
<code class="linenos">76 </code>      <code class="p">(</code><code class="nv">generateNeo4jCategoryNodes</code><code class="p">)</code> <code class="c1">;; just once, not for every input file</code>
<code class="linenos">77 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">pair</code> <code class="nv">text-and-meta-pairs</code><code class="p">)</code>
<code class="linenos">78 </code>	<code class="p">(</code><code class="nv">cypher-from-files-handle-single-file</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">pair</code><code class="p">)</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">pair</code><code class="p">))</code>
<code class="linenos">79 </code>	<code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">h</code> <code class="p">(</code><code class="nv">entities_dbpedia:find-entities-in-text</code> <code class="p">(</code><code class="nv">file-to-string</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">pair</code><code class="p">)))))</code>
<code class="linenos">80 </code>	  <code class="p">(</code><code class="nv">entities_dbpedia:entity-iterator</code> <code class="nf">#'</code><code class="nv">generate-dbpedia-contains-cypher</code> <code class="nv">h</code><code class="p">))))))</code>
<code class="linenos">81 </code>
<code class="linenos">82 </code>
<code class="linenos">83 </code><code class="p">(</code><code class="nb">defvar</code> <code class="nv">test_files</code> <code class="o">'</code><code class="p">((</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test3.txt"</code>
<code class="linenos">84 </code>		      <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test3.meta"</code><code class="p">)</code>
<code class="linenos">85 </code>		     <code class="p">(</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test2.txt"</code>
<code class="linenos">86 </code>		      <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test2.meta"</code><code class="p">)</code>
<code class="linenos">87 </code>		     <code class="p">(</code><code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test1.txt"</code>
<code class="linenos">88 </code>		      <code class="l l-Other">#P"~/GITHUB/common-lisp/kgcreator/test_data/test1.meta"</code><code class="p">)))</code>
<code class="linenos">89 </code>
<code class="linenos">90 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test2a</code> <code class="p">()</code>
<code class="linenos">91 </code>  <code class="p">(</code><code class="nv">cypher-from-files</code> <code class="s">"out.cypher"</code> <code class="nv">test_files</code><code class="p">))</code>
</pre></div>

</figure>

<p>You can load all of KGCreator but just execute the test function at the end of this file using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgcreator"</code><code class="p">)</code>
<code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kgcreator:test2a</code><code class="p">)</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-implementing-the-top-level-application-apis">Implementing the Top Level Application APIs</h3>

<p>The code in the file <strong>src/kgcreator/kgcreator.lisp</strong> uses both rdf.lisp and neo4j.lisp that we saw in the last two sections. The function <strong>get-files-and-meta</strong> looks at the contents of an input directory to generate a list of pairs, each pair containing the path to a text file and the meta file for the corresponding text file.</p>

<p>We are using the <strong>opts</strong> package to parse command line arguments. This will be used when we build a single file standalone executable file for the entire KGCreator application, including the web application that we will see in a later section.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;; KGCreator main program</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">ensure-directories-exist</code> <code class="s">"temp/"</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-files-and-meta</code> <code class="p">(</code><code class="nv">fpath</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">data</code> <code class="p">(</code><code class="nb">directory</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">fpath</code> <code class="s">"/"</code> <code class="s">"*.txt"</code><code class="p">)))</code>
<code class="linenos"> 9 </code>	      <code class="p">(</code><code class="nv">meta</code> <code class="p">(</code><code class="nb">directory</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="nv">fpath</code> <code class="s">"/"</code> <code class="s">"*.meta"</code><code class="p">))))</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">data</code><code class="p">)</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">meta</code><code class="p">)))</code>
<code class="linenos">11 </code>	<code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">12 </code>	  <code class="p">(</code><code class="nb">princ</code> <code class="s">"Error: must be matching *.meta files for each *.txt file"</code><code class="p">)</code>
<code class="linenos">13 </code>	  <code class="p">(</code><code class="nb">terpri</code><code class="p">)</code>
<code class="linenos">14 </code>	  <code class="o">'</code><code class="p">())</code>
<code class="linenos">15 </code>	<code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">ret</code> <code class="o">'</code><code class="p">()))</code>
<code class="linenos">16 </code>	  <code class="p">(</code><code class="nb">dotimes</code> <code class="p">(</code><code class="nv">i</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">data</code><code class="p">))</code>
<code class="linenos">17 </code>	    <code class="p">(</code><code class="k">setq</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="nv">data</code><code class="p">)</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">i</code> <code class="nv">meta</code><code class="p">))</code> <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos">18 </code>	  <code class="nv">ret</code><code class="p">))))</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="p">(</code><code class="nv">opts:define-opts</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="ss">:name</code> <code class="ss">:help</code>
<code class="linenos">22 </code>	   <code class="ss">:description</code>
<code class="linenos">23 </code>     <code class="s">"KGcreator command line example: ./KGcreator -i test_data -r out.rdf -c out.cyp\</code>
<code class="linenos">24 </code><code class="s">er"</code>
<code class="linenos">25 </code>	   <code class="ss">:short</code> <code class="sc">#\h</code>
<code class="linenos">26 </code>	   <code class="ss">:long</code> <code class="s">"help"</code><code class="p">)</code>
<code class="linenos">27 </code>    <code class="p">(</code><code class="ss">:name</code> <code class="ss">:rdf</code>
<code class="linenos">28 </code>	   <code class="ss">:description</code> <code class="s">"RDF output file name"</code>
<code class="linenos">29 </code>	   <code class="ss">:short</code> <code class="sc">#\r</code>
<code class="linenos">30 </code>	   <code class="ss">:long</code> <code class="s">"rdf"</code>
<code class="linenos">31 </code>	   <code class="ss">:arg-parser</code> <code class="nf">#'</code><code class="nb">identity</code> <code class="c1">;; &lt;- takes an argument</code>
<code class="linenos">32 </code>	   <code class="ss">:arg-parser</code> <code class="nf">#'</code><code class="nb">identity</code><code class="p">)</code> <code class="c1">;; &lt;- takes an argument</code>
<code class="linenos">33 </code>  <code class="p">(</code><code class="ss">:name</code> <code class="ss">:cypher</code>
<code class="linenos">34 </code>	 <code class="ss">:description</code> <code class="s">"Cypher output file name"</code>
<code class="linenos">35 </code>	 <code class="ss">:short</code> <code class="sc">#\c</code>
<code class="linenos">36 </code>	 <code class="ss">:long</code> <code class="s">"cypher"</code>
<code class="linenos">37 </code>	 <code class="ss">:arg-parser</code> <code class="nf">#'</code><code class="nb">identity</code><code class="p">)</code> <code class="c1">;; &lt;- takes an argument</code>
<code class="linenos">38 </code>  <code class="p">(</code><code class="ss">:name</code> <code class="ss">:inputdir</code>
<code class="linenos">39 </code>	 <code class="ss">:description</code> <code class="s">"Cypher output file name"</code>
<code class="linenos">40 </code>	 <code class="ss">:short</code> <code class="sc">#\i</code>
<code class="linenos">41 </code>	 <code class="ss">:long</code> <code class="s">"inputdir"</code>
<code class="linenos">42 </code>	 <code class="ss">:arg-parser</code> <code class="nf">#'</code><code class="nb">identity</code><code class="p">))</code> <code class="c1">;; &lt;- takes an argument</code>
<code class="linenos">43 </code>
<code class="linenos">44 </code>
<code class="linenos">45 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">kgcreator</code> <code class="p">()</code> <code class="c1">;; don't need: &amp;aux args sb-ext:*posix-argv*)</code>
<code class="linenos">46 </code>  <code class="p">(</code><code class="nb">handler-case</code>
<code class="linenos">47 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">opts</code> <code class="p">(</code><code class="nv">opts:get-opts</code><code class="p">))</code>
<code class="linenos">48 </code>	     <code class="p">(</code><code class="nv">input-path</code>
<code class="linenos">49 </code>	      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">find</code> <code class="ss">:inputdir</code> <code class="nv">opts</code><code class="p">)</code>
<code class="linenos">50 </code>		  <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">1+</code> <code class="p">(</code><code class="nb">position</code> <code class="ss">:inputdir</code> <code class="nv">opts</code><code class="p">))</code> <code class="nv">opts</code><code class="p">)))</code>
<code class="linenos">51 </code>	     <code class="p">(</code><code class="nv">rdf-output-path</code>
<code class="linenos">52 </code>	      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">find</code> <code class="ss">:rdf</code> <code class="nv">opts</code><code class="p">)</code>
<code class="linenos">53 </code>		  <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">1+</code> <code class="p">(</code><code class="nb">position</code> <code class="ss">:rdf</code> <code class="nv">opts</code><code class="p">))</code> <code class="nv">opts</code><code class="p">)))</code>
<code class="linenos">54 </code>	     <code class="p">(</code><code class="nv">cypher-output-path</code>
<code class="linenos">55 </code>	      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">find</code> <code class="ss">:cypher</code> <code class="nv">opts</code><code class="p">)</code>
<code class="linenos">56 </code>		  <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">1+</code> <code class="p">(</code><code class="nb">position</code> <code class="ss">:cypher</code> <code class="nv">opts</code><code class="p">))</code> <code class="nv">opts</code><code class="p">))))</code>
<code class="linenos">57 </code>	<code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"input-path: ~a  rdf-output-path: ~a cypher-output-path:~a~%"</code>
<code class="linenos">58 </code>		<code class="nv">input-path</code> <code class="nv">rdf-output-path</code> <code class="nv">cypher-output-path</code><code class="p">)</code>
<code class="linenos">59 </code>	<code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">not</code> <code class="nv">input-path</code><code class="p">)</code>
<code class="linenos">60 </code>	    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"You must specify an input path.~%"</code><code class="p">)</code>
<code class="linenos">61 </code>	    <code class="p">(</code><code class="k">locally</code>
<code class="linenos">62 </code>		<code class="p">(</code><code class="k">declare</code> <code class="o">#+</code><code class="nv">sbcl</code><code class="p">(</code><code class="nv">sb-ext:muffle-conditions</code> <code class="nv">sb-kernel:redefinition-warning</code><code class="p">))</code>
<code class="linenos">63 </code>	      <code class="p">(</code><code class="nb">handler-bind</code>
<code class="linenos">64 </code>		  <code class="p">(</code><code class="o">#+</code><code class="nv">sbcl</code><code class="p">(</code><code class="nv">sb-kernel:redefinition-warning</code> <code class="nf">#'</code><code class="nb">muffle-warning</code><code class="p">))</code>
<code class="linenos">65 </code>		<code class="c1">;; stuff that emits redefinition-warning's</code>
<code class="linenos">66 </code>		<code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">67 </code>		  <code class="p">(</code><code class="k">if</code> <code class="nv">rdf-output-path</code>
<code class="linenos">68 </code>		      <code class="p">(</code><code class="nv">rdf-from-files</code> <code class="nv">rdf-output-path</code> <code class="p">(</code><code class="nv">get-files-and-meta</code> <code class="nv">input-path</code><code class="p">)))</code>
<code class="linenos">69 </code>		  <code class="p">(</code><code class="k">if</code> <code class="nv">cypher-output-path</code>
<code class="linenos">70 </code>		      <code class="p">(</code><code class="nv">cypher-from-files</code> <code class="nv">cypher-output-path</code> <code class="p">(</code><code class="nv">get-files-and-meta</code> <code class="nv">input-path</code><code class="p">))))))))</code>
<code class="linenos">71 </code>    <code class="p">(</code><code class="no">t</code> <code class="p">(</code><code class="nv">c</code><code class="p">)</code>
<code class="linenos">72 </code>      <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"We caught a runtime error: ~a~%"</code> <code class="nv">c</code><code class="p">)</code>
<code class="linenos">73 </code>      <code class="p">(</code><code class="nb">values</code> <code class="mi">0</code> <code class="nv">c</code><code class="p">)))</code>
<code class="linenos">74 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~%Shutting down KGcreator - done processing~%~%"</code><code class="p">))</code>
<code class="linenos">75 </code>
<code class="linenos">76 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test1</code> <code class="p">()</code>
<code class="linenos">77 </code>    <code class="p">(</code><code class="nv">get-files-and-meta</code>
<code class="linenos">78 </code>     <code class="s">"~/GITHUB/common-lisp/kgcreator/test_data"</code><code class="p">))</code>
<code class="linenos">79 </code>
<code class="linenos">80 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">print-hash-entry</code> <code class="p">(</code><code class="nv">key</code> <code class="nv">value</code><code class="p">)</code>
<code class="linenos">81 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"The value associated with the key ~S is ~S~%"</code> <code class="nv">key</code> <code class="nv">value</code><code class="p">))</code>
<code class="linenos">82 </code>
<code class="linenos">83 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test2</code> <code class="p">()</code>
<code class="linenos">84 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">h</code> <code class="p">(</code><code class="nv">entities_dbpedia:find-entities-in-text</code> <code class="s">"Bill Clinton and George Bush wen\</code>
<code class="linenos">85 </code><code class="s">t to Mexico and England and watched Univision. They enjoyed Dakbayan sa Dabaw and sh\</code>
<code class="linenos">86 </code><code class="s">oped at Best Buy and listened to Al Stewart. They agree on RepÃºblica de Nicaragua a\</code>
<code class="linenos">87 </code><code class="s">nd support Sweden Democrats and Leicestershire Miners Association and both sent thei\</code>
<code class="linenos">88 </code><code class="s">r kids to Darul Uloom Deoband."</code><code class="p">)))</code>
<code class="linenos">89 </code>    <code class="p">(</code><code class="nv">entities_dbpedia:entity-iterator</code> <code class="nf">#'</code><code class="nv">print-hash-entry</code> <code class="nv">h</code><code class="p">)))</code>
<code class="linenos">90 </code>
<code class="linenos">91 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test7</code> <code class="p">()</code>
<code class="linenos">92 </code>  <code class="p">(</code><code class="nv">rdf-from-files</code> <code class="s">"out.rdf"</code> <code class="p">(</code><code class="nv">get-files-and-meta</code> <code class="s">"test_data"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>You can load all of KGCreator but just execute the three test functions at the end of this file using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgcreator"</code><code class="p">)</code>
<code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kgcreator:test1</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kgcreator:test2</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kgcreator:test7</code><code class="p">)</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-implementing-the-web-interface">Implementing The Web Interface</h3>

<p>When we build a standalone single file application for KGCreator, we include a simple web application interface that allows users to enter input text and see generated RDF and Neo4j Cypher data.</p>

<p>The file <strong>src/kgcreator/web.lisp</strong> uses the libraries <strong>cl-who</strong> <strong>hunchentoot</strong> <strong>parenscript</strong> that we used earlier. The function write-files-run-code** (lines 8-43) takes raw text, and  writes generated RDF and Neo4j Cypher data to local temporary files that are then read and formatted to HTML for display. The code in rdf.lisp and neo4j.lisp is file oriented, and I wrote web.lisp as an afterthought so it was easier writing temporary files than refactoring rdf.lisp and neo4j.lisp to write to strings.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="o">'</code><code class="p">(</code><code class="nv">cl-who</code> <code class="nv">hunchentoot</code> <code class="nv">parenscript</code><code class="p">))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">html-mode</code><code class="p">)</code> <code class="ss">:html5</code><code class="p">)</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">write-files-run-code</code> <code class="p">(</code><code class="nv">a-uri</code> <code class="nv">raw-text</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&lt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">raw-text</code><code class="p">)</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="nb">list</code> <code class="s">"not enough text"</code> <code class="s">"not enough text"</code><code class="p">)</code>
<code class="linenos">11 </code>    <code class="c1">;; generate random file number</code>
<code class="linenos">12 </code>    <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">filenum</code> <code class="p">(</code><code class="nb">+</code> <code class="mi">1000</code> <code class="p">(</code><code class="nb">random</code> <code class="mi">5000</code><code class="p">)))</code>
<code class="linenos">13 </code>	   <code class="p">(</code><code class="nv">meta-name</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"temp/"</code> <code class="p">(</code><code class="nb">write-to-string</code> <code class="nv">filenum</code><code class="p">)</code> <code class="s">".meta"</code><code class="p">))</code>
<code class="linenos">14 </code>	   <code class="p">(</code><code class="nv">text-name</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"temp/"</code> <code class="p">(</code><code class="nb">write-to-string</code> <code class="nv">filenum</code><code class="p">)</code> <code class="s">".txt"</code><code class="p">))</code>
<code class="linenos">15 </code>	   <code class="p">(</code><code class="nv">rdf-name</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"temp/"</code> <code class="p">(</code><code class="nb">write-to-string</code> <code class="nv">filenum</code><code class="p">)</code> <code class="s">".rdf"</code><code class="p">))</code>
<code class="linenos">16 </code>	   <code class="p">(</code><code class="nv">cypher-name</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"temp/"</code> <code class="p">(</code><code class="nb">write-to-string</code> <code class="nv">filenum</code><code class="p">)</code> <code class="s">".cypher"</code><code class="p">))</code>
<code class="linenos">17 </code>	   <code class="nv">ret</code><code class="p">)</code>
<code class="linenos">18 </code>      <code class="c1">;; write meta file</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="nb">with-open-file</code> <code class="p">(</code><code class="nv">str</code> <code class="nv">meta-name</code>
<code class="linenos">20 </code>			   <code class="ss">:direction</code> <code class="ss">:output</code>
<code class="linenos">21 </code>			   <code class="ss">:if-exists</code> <code class="ss">:supersede</code>
<code class="linenos">22 </code>			   <code class="ss">:if-does-not-exist</code> <code class="ss">:create</code><code class="p">)</code>
<code class="linenos">23 </code>		      <code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="nv">a-uri</code><code class="p">))</code>
<code class="linenos">24 </code>      <code class="c1">;; write text file</code>
<code class="linenos">25 </code>      <code class="p">(</code><code class="nb">with-open-file</code> <code class="p">(</code><code class="nv">str</code> <code class="nv">text-name</code>
<code class="linenos">26 </code>			   <code class="ss">:direction</code> <code class="ss">:output</code>
<code class="linenos">27 </code>			   <code class="ss">:if-exists</code> <code class="ss">:supersede</code>
<code class="linenos">28 </code>			   <code class="ss">:if-does-not-exist</code> <code class="ss">:create</code><code class="p">)</code>
<code class="linenos">29 </code>	<code class="p">(</code><code class="nb">format</code> <code class="nv">str</code> <code class="nv">raw-text</code><code class="p">))</code>
<code class="linenos">30 </code>      <code class="c1">;; generate rdf and cypher files</code>
<code class="linenos">31 </code>      <code class="p">(</code><code class="nv">rdf-from-files</code> <code class="nv">rdf-name</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">text-name</code> <code class="nv">meta-name</code><code class="p">)))</code>
<code class="linenos">32 </code>      <code class="p">(</code><code class="nv">cypher-from-files</code> <code class="nv">cypher-name</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">text-name</code> <code class="nv">meta-name</code><code class="p">)))</code>
<code class="linenos">33 </code>      <code class="c1">;; read files and return results</code>
<code class="linenos">34 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="nv">ret</code>
<code class="linenos">35 </code>	    <code class="p">(</code><code class="nb">list</code>
<code class="linenos">36 </code>	     <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">37 </code>	      <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">38 </code>	       <code class="p">(</code><code class="nv">uiop:read-file-string</code> <code class="nv">rdf-name</code><code class="p">)</code>
<code class="linenos">39 </code>	       <code class="s">"&gt;"</code> <code class="s">"&amp;gt;"</code><code class="p">)</code>
<code class="linenos">40 </code>	      <code class="s">"&lt;"</code> <code class="s">"&amp;lt;"</code><code class="p">)</code>
<code class="linenos">41 </code>	     <code class="p">(</code><code class="nv">uiop:read-file-string</code> <code class="nv">cypher-name</code><code class="p">)))</code>
<code class="linenos">42 </code>      <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"ret:"</code> <code class="nv">ret</code><code class="p">))</code>
<code class="linenos">43 </code>      <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos">44 </code>  
<code class="linenos">45 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*h*</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'easy-acceptor</code> <code class="ss">:port</code> <code class="mi">3000</code><code class="p">))</code>
<code class="linenos">46 </code>
<code class="linenos">47 </code><code class="c1">;; define a handler with the arbitrary name my-greetings:</code>
<code class="linenos">48 </code>
<code class="linenos">49 </code><code class="p">(</code><code class="nv">define-easy-handler</code> <code class="p">(</code><code class="nv">my-greetings</code> <code class="ss">:uri</code> <code class="s">"/"</code><code class="p">)</code> <code class="p">(</code><code class="nv">text</code><code class="p">)</code>
<code class="linenos">50 </code>  <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">hunchentoot:content-type*</code><code class="p">)</code> <code class="s">"text/html"</code><code class="p">)</code>
<code class="linenos">51 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">rdf-and-cypher</code> <code class="p">(</code><code class="nv">write-files-run-code</code> <code class="s">"http://test.com/1"</code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">52 </code>    <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nb">list</code> <code class="s">"*** rdf-and-cypher:"</code> <code class="nv">rdf-and-cypher</code><code class="p">))</code>
<code class="linenos">53 </code>    <code class="p">(</code><code class="nv">with-html-output-to-string</code>
<code class="linenos">54 </code>     <code class="p">(</code><code class="vg">*standard-output*</code> <code class="no">nil</code> <code class="ss">:prologue</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">55 </code>     <code class="p">(</code><code class="ss">:html</code>
<code class="linenos">56 </code>      <code class="p">(</code><code class="ss">:head</code> <code class="p">(</code><code class="ss">:title</code> <code class="s">"KGCreator Demo"</code><code class="p">)</code>
<code class="linenos">57 </code>	     <code class="p">(</code><code class="ss">:link</code> <code class="ss">:rel</code> <code class="s">"stylesheet"</code> <code class="ss">:href</code> <code class="s">"styles.css"</code> <code class="ss">:type</code> <code class="s">"text/css"</code><code class="p">))</code>
<code class="linenos">58 </code>      <code class="p">(</code><code class="ss">:body</code>
<code class="linenos">59 </code>       <code class="ss">:style</code> <code class="s">"margin: 90px"</code>
<code class="linenos">60 </code>       <code class="p">(</code><code class="ss">:h1</code> <code class="s">"Enter plain text for the demo to create RDF and Cypher"</code><code class="p">)</code>
<code class="linenos">61 </code>       <code class="p">(</code><code class="ss">:p</code> <code class="s">"For more information on the KGCreator product please visit the web site:"</code>
<code class="linenos">62 </code>	   <code class="p">(</code><code class="ss">:a</code> <code class="ss">:href</code> <code class="s">"https://markwatson.com/products/"</code> <code class="s">"Mark Watson's commercial products"</code><code class="err">\</code>
<code class="linenos">63 </code><code class="p">))</code>
<code class="linenos">64 </code>       <code class="p">(</code><code class="ss">:p</code> <code class="s">"The KGCreator product is a command line tool that processes all text "</code>
<code class="linenos">65 </code>	   <code class="s">"web applications and files in a source directory and produces both RDF data "</code>
<code class="linenos">66 </code>	   <code class="s">"triples for semantic Cypher input data files for the Neo4j graph database. "</code>
<code class="linenos">67 </code>	   <code class="s">"For the purposes of this demo the URI for your input text is hardwired to "</code>
<code class="linenos">68 </code>	   <code class="s">"&amp;lt;http://test.com/1&amp;gt; but the KGCreator product offers flexibility "</code>
<code class="linenos">69 </code>		 <code class="s">"for assigning URIs to data sources and further, "</code>
<code class="linenos">70 </code>	   <code class="s">"creates links for relationships between input sources."</code><code class="p">)</code>
<code class="linenos">71 </code>       <code class="p">(</code><code class="ss">:p</code> <code class="ss">:style</code> <code class="s">"text-align: left"</code>
<code class="linenos">72 </code>	   <code class="s">"To try the demo paste plain text into the following form that contains "</code>
<code class="linenos">73 </code>		 <code class="s">"information on companies, news, politics, famous people, broadcasting "</code>
<code class="linenos">74 </code>		 <code class="s">"networks, political parties, countries and other locations, etc. "</code><code class="p">)</code>
<code class="linenos">75 </code>       <code class="p">(</code><code class="ss">:p</code> <code class="s">"Do not include and special characters or character sets:"</code><code class="p">)</code>
<code class="linenos">76 </code>       <code class="p">(</code><code class="ss">:form</code>
<code class="linenos">77 </code>	<code class="ss">:method</code> <code class="ss">:post</code>
<code class="linenos">78 </code>	<code class="p">(</code><code class="ss">:textarea</code>
<code class="linenos">79 </code>	 <code class="ss">:rows</code> <code class="s">"20"</code>
<code class="linenos">80 </code>	 <code class="ss">:cols</code> <code class="s">"90"</code>
<code class="linenos">81 </code>	 <code class="ss">:name</code> <code class="s">"text"</code>
<code class="linenos">82 </code>	 <code class="ss">:value</code> <code class="nv">text</code><code class="p">)</code>
<code class="linenos">83 </code>	<code class="p">(</code><code class="ss">:br</code><code class="p">)</code>
<code class="linenos">84 </code>	<code class="p">(</code><code class="ss">:input</code> <code class="ss">:type</code> <code class="ss">:submit</code> <code class="ss">:value</code> <code class="s">"Submit text to process"</code><code class="p">))</code>
<code class="linenos">85 </code>       <code class="p">(</code><code class="ss">:h3</code> <code class="s">"RDF:"</code><code class="p">)</code>
<code class="linenos">86 </code>       <code class="p">(</code><code class="ss">:pre</code> <code class="p">(</code><code class="nv">str</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">rdf-and-cypher</code><code class="p">)))</code>
<code class="linenos">87 </code>       <code class="p">(</code><code class="ss">:h3</code> <code class="s">"Cypher:"</code><code class="p">)</code>
<code class="linenos">88 </code>       <code class="p">(</code><code class="ss">:pre</code> <code class="p">(</code><code class="nv">str</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">rdf-and-cypher</code><code class="p">))))))))</code>
<code class="linenos">89 </code>
<code class="linenos">90 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">kgcweb</code> <code class="p">()</code>
<code class="linenos">91 </code>  <code class="p">(</code><code class="nv">hunchentoot:start</code> <code class="vg">*h*</code><code class="p">))</code>
</pre></div>

</figure>

<p>You can load all of KGCreator and start the web application using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgcreator"</code><code class="p">)</code>
<code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="p">(</code><code class="nv">kgcweb</code><code class="p">)</code>
</pre></div>

</figure>

<p>You can access the web app at <a href="http://localhost:3000">http://localhost:3000</a>.</p>

<h3 id="leanpub-auto-creating-a-standalone-application-using-sbcl">Creating a Standalone Application Using SBCL</h3>

<p>When I originally wrote KGCreator I intended to develop a commercial product so it was important to be able to create standalone single file executables. This is simple to do using SBCL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">$</code> <code class="nv">sbcl</code>
<code class="linenos">2 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgcreator"</code><code class="p">)</code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgcreator</code><code class="p">)</code>
<code class="linenos">4 </code><code class="p">(</code><code class="nv">sb-ext:save-lisp-and-die</code> <code class="s">"KGcreator"</code>
<code class="linenos">5 </code>  <code class="ss">:toplevel</code> <code class="nf">#'</code><code class="nv">kgcreator</code> <code class="ss">:executable</code> <code class="no">t</code><code class="p">)</code>
</pre></div>

</figure>

<p>As an example, you could run the application on the command line using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>./KGcreator -i test_data -r out.rdf -c out.cyper
</pre></div>

</figure>

<h3 id="leanpub-auto-augmenting-rdf-triples-in-a-knowledge-graph-using-dbpedia">Augmenting RDF Triples in a Knowledge Graph Using DBPedia</h3>

<p>You can augment RDF-based Knowledge Graphs that you build with the KGcreator application by using the library in the directory <strong>kg-add-dbpedia-triples</strong>.</p>

<p>As seen in the <strong>kg-add-dbpedia-triples.asd</strong> and <strong>package.lisp</strong> configuration files, we use two other libraries developed in this book:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1">;;;; kg-add-dbpedia-triples.asd</code>

<code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:kg-add-dbpedia-triples</code>
  <code class="ss">:description</code> <code class="s">"Add DBPedia triples from an input N-Triples RDF file"</code>
  <code class="ss">:author</code> <code class="s">"markw@markwatson.com"</code>
  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:myutils</code> <code class="ss">#:sparql</code><code class="p">)</code>
  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
               <code class="p">(</code><code class="ss">:file</code> <code class="s">"add-dbpedia-triples"</code><code class="p">)))</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1">;;;; package.lisp</code>

<code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:kg-add-dbpedia-triples</code>
  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:myutils</code> <code class="ss">#:sparql</code><code class="p">)</code>
  <code class="p">(</code><code class="ss">:export</code> <code class="ss">#:add-triples</code><code class="p">))</code>
</pre></div>

</figure>

<p>The library is implemented in the file <strong>kg-add-dbpedia-triples.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kg-add-dbpedia-triples</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">augmented-triples</code> <code class="p">(</code><code class="nv">a-uri</code> <code class="nv">ostream</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">results</code>
<code class="linenos"> 5 </code>         <code class="p">(</code><code class="nv">sparql:dbpedia</code>
<code class="linenos"> 6 </code>          <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"construct { ~A ?p ?o } where { ~A ?p ?o } limit 5"</code> <code class="nv">a-uri</code> <code class="nv">a-ur</code><code class="err">\</code>
<code class="linenos"> 7 </code><code class="nv">i</code><code class="p">))))</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">results</code><code class="p">)</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">sop</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">10 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">val</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">sop</code><code class="p">)))</code>
<code class="linenos">11 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code>
<code class="linenos">12 </code>               <code class="p">(</code><code class="nb">stringp</code> <code class="nv">val</code><code class="p">)</code>
<code class="linenos">13 </code>               <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">val</code><code class="p">)</code> <code class="mi">9</code><code class="p">)</code>
<code class="linenos">14 </code>               <code class="p">(</code><code class="nb">or</code>
<code class="linenos">15 </code>                <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">val</code> <code class="mi">0</code> <code class="mi">7</code><code class="p">)</code> <code class="s">"http://"</code><code class="p">)</code>
<code class="linenos">16 </code>                <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">val</code> <code class="mi">0</code> <code class="mi">8</code><code class="p">)</code> <code class="s">"https://"</code><code class="p">)))</code>
<code class="linenos">17 </code>              <code class="p">(</code><code class="nb">format</code> <code class="nv">ostream</code> <code class="s">"&lt;~A&gt; "</code> <code class="nv">val</code><code class="p">)</code>
<code class="linenos">18 </code>            <code class="p">(</code><code class="nb">format</code> <code class="nv">ostream</code> <code class="s">"~A "</code> <code class="nv">val</code><code class="p">))))</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="nb">format</code> <code class="nv">ostream</code> <code class="s">" .~%"</code><code class="p">))))</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">add-triples</code> <code class="p">(</code><code class="nv">in-file-name</code> <code class="nv">out-file-name</code><code class="p">)</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">nt-data</code> <code class="p">(</code><code class="nv">myutils:file-to-string</code> <code class="nv">in-file-name</code><code class="p">))</code>
<code class="linenos">23 </code>         <code class="p">(</code><code class="nv">tokens</code> <code class="p">(</code><code class="nv">myutils:tokenize-string-keep-uri</code> <code class="nv">nt-data</code><code class="p">))</code>
<code class="linenos">24 </code>         <code class="p">(</code><code class="nv">uris</code>
<code class="linenos">25 </code>          <code class="p">(</code><code class="nb">remove-duplicates</code>
<code class="linenos">26 </code>           <code class="p">(</code><code class="nb">mapcan</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">s</code><code class="p">)</code> <code class="p">(</code><code class="k">if</code>
<code class="linenos">27 </code>                                     <code class="p">(</code><code class="nb">and</code>
<code class="linenos">28 </code>                                      <code class="p">(</code><code class="nb">stringp</code> <code class="nv">s</code><code class="p">)</code>
<code class="linenos">29 </code>                                      <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">s</code><code class="p">)</code> <code class="mi">19</code><code class="p">)</code>
<code class="linenos">30 </code>                                      <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">s</code> <code class="mi">0</code> <code class="mi">19</code><code class="p">)</code> <code class="s">"&lt;http://dbpedia.org"</code><code class="p">))</code>
<code class="linenos">31 </code>                                     <code class="p">(</code><code class="nb">list</code> <code class="nv">s</code><code class="p">)))</code>
<code class="linenos">32 </code>                   <code class="nv">tokens</code><code class="p">)</code>
<code class="linenos">33 </code>           <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">)))</code>
<code class="linenos">34 </code>    <code class="p">(</code><code class="nb">with-open-file</code> <code class="p">(</code><code class="nv">str</code> <code class="nv">out-file-name</code>
<code class="linenos">35 </code>                         <code class="ss">:direction</code> <code class="ss">:output</code>
<code class="linenos">36 </code>                         <code class="ss">:if-exists</code> <code class="ss">:supersede</code>
<code class="linenos">37 </code>                         <code class="ss">:if-does-not-exist</code> <code class="ss">:create</code><code class="p">)</code>
<code class="linenos">38 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">uri</code> <code class="nv">uris</code><code class="p">)</code>
<code class="linenos">39 </code>      <code class="p">(</code><code class="nv">augmented-triples</code> <code class="nv">uri</code> <code class="nv">str</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>TBD</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>
</pre></div>

</figure>

<h3 id="leanpub-auto-kgcreator-wrap-up">KGCreator Wrap Up</h3>

<p>When developing applications or systems using Knowledge Graphs it is useful to be able to quickly generate test data which is the primary purpose of KGCreator. A secondary use is to generate  Knowledge Graphs for production use using text data sources. In this second use case you will want to manually inspect the generated data to verify its correctness or usefulness for your application.</p>


<h2 id="kgsampler">Knowledge Graph Sampler for Creating Small Custom Knowledge Graphs</h2>

<p>I find it convenient to be able to “sample” small parts of larger knowledge graphs. The example program in this chapter accepts a list of DBPedia entity URIs, attempts top find links between these entities, and writes these nodes and discovered edges to a RDF triples file.</p>

<p>The code is in the directory <strong>src/kgsampler</strong>. As seen in the configuration files <strong>kg-add-dbpedia-triples.asd</strong> and <strong>package.lisp</strong>, we will use the <strong>sparql</strong> library we developed earlier as well as the libraries <strong>uiop</strong> and <strong>drakma</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1">;;;; kgsampler.asd</code>

<code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:kgsampler</code>
  <code class="ss">:description</code> <code class="s">"sample knowledge graphs"</code>
  <code class="ss">:author</code> <code class="s">"Mark Watson markw@markwatson.com"</code>
  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:uiop</code> <code class="ss">#:drakma</code> <code class="ss">#:sparql</code><code class="p">)</code>
  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
               <code class="p">(</code><code class="ss">:file</code> <code class="s">"kgsampler"</code><code class="p">)))</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1">;;;; package.lisp</code>

<code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:kgsampler</code>
  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:uiop</code> <code class="ss">#:sparql</code><code class="p">)</code>
  <code class="p">(</code><code class="ss">:export</code> <code class="ss">#:sample</code><code class="p">))</code>
</pre></div>

</figure>

<p>The program starts with a list of entities and tries to find links on DBPedia between the entities. A small sample graph of the input entities and any discovered links is written to a file. The function <strong>dbpedia-as-nt</strong> spawns a process to use the <em>curl</em> utility to make a HTTP request to DBPedia. The function <strong>construct-from-dbpedia</strong> takes a list of entities and writes SPARQL CONSTRUCT statements with the entity as the subject and the object filtered to a string value in the English language to an output stream. The function <strong>find-relations</strong> runs at <strong>O(N^2)</strong> where <strong>N</strong> is the number of input entities so you should avoid using this program with a large number of input entities.</p>

<p>I offer this code with little explanation since much of it is similar to the techniques you saw in the previous chapter Knowledge Graph Navigator.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1">;; kgsampler main program</code>

<code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgsampler</code><code class="p">)</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-as-nt</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">print</code> <code class="nv">query</code><code class="p">)</code>
  <code class="p">(</code><code class="nv">uiop:run-program</code> 
   <code class="p">(</code><code class="nb">list</code>
    <code class="s">"curl"</code> 
    <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code>
                 <code class="s">"https://dbpedia.org/sparql?format=text/ntriples&amp;query="</code>
                 <code class="c1">;; formats that work: csv, text/ntriples, text/ttl</code>
                 <code class="p">(</code><code class="nv">drakma:url-encode</code> <code class="nv">query</code> <code class="ss">:utf-8</code><code class="p">)))</code>
   <code class="ss">:output</code> <code class="ss">:string</code><code class="p">))</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">construct-from-dbpedia</code> <code class="p">(</code><code class="nv">entity-uri-list</code> <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">output-stream</code> <code class="no">t</code><code class="p">))</code>
  <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">entity-uri</code> <code class="nv">entity-uri-list</code><code class="p">)</code>
    <code class="p">(</code><code class="nb">format</code> <code class="nv">output-stream</code> <code class="s">"~%~%# ENTITY NAME: ~A~%~%"</code> <code class="nv">entity-uri</code><code class="p">)</code>
    <code class="p">(</code><code class="nb">format</code>
     <code class="nv">output-stream</code>
     <code class="p">(</code><code class="nv">dbpedia-as-nt</code>
      <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
              <code class="s">"CONSTRUCT { ~A ?p ?o } where { ~A ?p ?o  . FILTER(lang(?o) = 'en') }"</code><code class="err">\</code>
  
              <code class="nv">entity-uri</code> <code class="nv">entity-uri</code><code class="p">)))))</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">ensure-angle-brackets</code> <code class="p">(</code><code class="nv">s</code><code class="p">)</code>
  <code class="s">"make sure URIs have angle brackets"</code>
  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="sc">#\&lt;</code> <code class="p">(</code><code class="nb">char</code> <code class="nv">s</code> <code class="mi">0</code><code class="p">))</code>
      <code class="nv">s</code>
      <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"&lt;"</code> <code class="nv">s</code> <code class="s">"&gt;"</code><code class="p">)))</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">find-relations</code> <code class="p">(</code><code class="nv">entity-uri-list</code> <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">output-stream</code> <code class="no">t</code><code class="p">))</code>
  <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">entity-uri1</code> <code class="nv">entity-uri-list</code><code class="p">)</code>
    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">entity-uri2</code> <code class="nv">entity-uri-list</code><code class="p">)</code>
      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">entity-uri1</code> <code class="nv">entity-uri2</code><code class="p">))</code>
          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">possible-relations</code>
                 <code class="p">(</code><code class="nb">mapcar</code> <code class="nf">#'</code><code class="nb">cadar</code>
                         <code class="p">(</code><code class="nv">sparql::dbpedia</code>
                          <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> 
                                  <code class="s">"select ?p where { ~A ?p ~A . filter(!regex(str(?p\</code>
<code class="s">), \"page\", \"i\"))} limit 50"</code>
                                  <code class="nv">entity-uri1</code> <code class="nv">entity-uri2</code><code class="p">)))))</code>
            <code class="p">(</code><code class="nb">print</code> <code class="s">"** possible-relations:"</code><code class="p">)</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">possible-relations</code><code class="p">)</code>
            <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">pr</code> <code class="nv">possible-relations</code><code class="p">)</code>
              <code class="p">(</code><code class="nb">format</code> <code class="nv">output-stream</code> <code class="s">"~A ~A ~a .~%"</code>
		      <code class="nv">entity-uri1</code>
		      <code class="p">(</code><code class="nv">ensure-angle-brackets</code> <code class="nv">pr</code><code class="p">)</code>
		      <code class="nv">entity-uri2</code><code class="p">)))))))</code>

<code class="p">(</code><code class="nb">defun</code> <code class="nv">sample</code> <code class="p">(</code><code class="nv">entity-uri-list</code> <code class="nv">output-filepath</code><code class="p">)</code>
  <code class="p">(</code><code class="nb">with-open-file</code> <code class="p">(</code><code class="nv">ostream</code>  <code class="p">(</code><code class="nb">pathname</code> <code class="nv">output-filepath</code><code class="p">)</code> <code class="ss">:direction</code> <code class="ss">:output</code> <code class="ss">:if-exists</code><code class="err">\</code>
 <code class="ss">:supersede</code><code class="p">)</code>
    <code class="p">(</code><code class="nv">construct-from-dbpedia</code> <code class="nv">entity-uri-list</code> <code class="ss">:output-stream</code> <code class="nv">ostream</code><code class="p">)</code>
    <code class="p">(</code><code class="nv">find-relations</code> <code class="nv">entity-uri-list</code> <code class="ss">:output-stream</code> <code class="nv">ostream</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Let’s start by running the two helper functions interactively so you can see their output (output edited for brevity). The top level function <strong>kgsampler:sample</strong> for this example takes a list of entity URIs and an output file name, and uses the functions <strong>construct-from-dbpedia entity-uri-list</strong> and <strong>find-relations</strong> to write triples for the entities and then for the relationships discovered between entities. The following listing also calls the helper function <strong>kgsampler::find-relations</strong> to show you what its output looks like.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">sbcl</code>
<code class="nb">*</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgsampler"</code><code class="p">)</code>
<code class="nb">*</code>   <code class="p">(</code><code class="nv">kgsampler::construct-from-dbpedia</code> <code class="o">'</code><code class="p">(</code><code class="s">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code> <code class="err">\</code>
<code class="s">"&lt;http://dbpedia.org/resource/Steve_Jobs&gt;"</code><code class="p">)</code> <code class="ss">:output-stream</code> <code class="no">nil</code><code class="p">)</code>

<code class="s">"CONSTRUCT { &lt;http://dbpedia.org/resource/Bill_Gates&gt; ?p ?o } where { &lt;http://dbpedi\</code>
<code class="s">a.org/resource/Bill_Gates&gt; ?p ?o  . FILTER (lang(?o) = 'en') }"</code> 
<code class="s">"CONSTRUCT { &lt;http://dbpedia.org/resource/Bill_Gates&gt; &lt;http://purl.org/dc/terms/subj\</code>
<code class="s">ect&gt; ?o } where { &lt;http://dbpedia.org/resource/Bill_Gates&gt; &lt;http://purl.org/dc/terms\</code>
<code class="s">/subject&gt; ?o  }"</code> 

 <code class="o">...</code>

<code class="nb">*</code> <code class="p">(</code><code class="nv">kgsampler::find-relations</code> <code class="o">'</code><code class="p">(</code><code class="s">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code> <code class="s">"&lt;http://d\</code>
<code class="s">bpedia.org/resource/Microsoft&gt;"</code><code class="p">)</code> <code class="ss">:output-stream</code> <code class="no">nil</code><code class="p">)</code>

<code class="p">(</code><code class="s">"dbpedia SPARQL:"</code>
 <code class="s">"select ?p where { &lt;http://dbpedia.org/resource/Bill_Gates&gt; ?p &lt;http://dbpedia.org/\</code>
<code class="s">resource/Microsoft&gt; . filter(!regex(str(?p), \"page\", \"i\"))} limit 50"</code>
 <code class="s">"n"</code><code class="p">)</code> 
<code class="s">"** possible-relations:"</code> 
<code class="p">(</code><code class="s">"http://dbpedia.org/ontology/knownFor"</code><code class="p">)</code> 
<code class="s">"http://dbpedia.org/ontology/knownFor"</code> 
<code class="p">(</code><code class="s">"dbpedia SPARQL:"</code>
 <code class="s">"select ?p where { &lt;http://dbpedia.org/resource/Microsoft&gt; ?p &lt;http://dbpedia.org/r\</code>
<code class="s">esource/Bill_Gates&gt; . filter(!regex(str(?p), \"page\", \"i\"))} limit 50"</code>
 <code class="s">"n"</code><code class="p">)</code> 
<code class="s">"** possible-relations:"</code> 
<code class="p">(</code><code class="s">"http://dbpedia.org/property/founders"</code> <code class="s">"http://dbpedia.org/ontology/foundedBy"</code><code class="p">)</code> 
<code class="s">"http://dbpedia.org/property/founders"</code> 
<code class="s">"http://dbpedia.org/ontology/foundedBy"</code> 
<code class="no">nil</code>
</pre></div>

</figure>

<p>We now use the main function to generate an output RDF triple file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">sbcl</code>
<code class="linenos"> 2 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgsampler"</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">kgsampler:sample</code> <code class="o">'</code><code class="p">(</code><code class="s">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code> <code class="s">"&lt;http://dbpedia.or\</code>
<code class="linenos"> 4 </code><code class="s">g/resource/Steve_Jobs&gt;"</code> <code class="s">"&lt;http://dbpedia.org/resource/Microsoft&gt;"</code><code class="p">)</code>  <code class="s">"test.nt"</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="s">"CONSTRUCT { &lt;http://dbpedia.org/resource/Bill_Gates&gt; ?p ?o } where { &lt;http://dbpedi\</code>
<code class="linenos"> 6 </code><code class="s">a.org/resource/Bill_Gates&gt; ?p ?o  . FILTER (lang(?o) = 'en') }"</code> 
<code class="linenos"> 7 </code><code class="p">(</code><code class="s">"ndbpedia SPARQL:n"</code>
<code class="linenos"> 8 </code> <code class="s">"select ?p where { &lt;http://dbpedia.org/resource/Bill_Gates&gt; ?p &lt;http://dbpedia.org/\</code>
<code class="linenos"> 9 </code><code class="s">resource/Microsoft&gt; . filter(!regex(str(?p), \"page\", \"i\"))} limit 50"</code>
<code class="linenos">10 </code> <code class="s">"n"</code><code class="p">)</code> 
<code class="linenos">11 </code><code class="s">"** possible-relations:"</code> 
<code class="linenos">12 </code><code class="p">(</code><code class="s">"http://dbpedia.org/ontology/board"</code><code class="p">)</code> 
<code class="linenos">13 </code><code class="p">(</code><code class="s">"dbpedia SPARQL:"</code>
<code class="linenos">14 </code> <code class="s">"select ?p where { &lt;http://dbpedia.org/resource/Steve_Jobs&gt; ?p &lt;http://dbpedia.org/\</code>
<code class="linenos">15 </code><code class="s">resource/Bill_Gates&gt; . filter(!regex(str(?p), \"page\", \"i\"))} limit 50"</code>
<code class="linenos">16 </code> <code class="s">"n"</code><code class="p">)</code> 
</pre></div>

</figure>

<p>Output RDF N-Triple data is written to the file <strong>sample-KG.nt</strong>. A very small part of this file is listed here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="err">#</code> <code class="nv">ENTITY</code> <code class="nv">NAME:</code> <code class="nv">&lt;http://dbpedia.org/resource/Bill_Gates&gt;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="nv">&lt;http://dbpedia.org/resource/Bill_Gates&gt;</code>        <code class="nv">&lt;http://dbpedia.org/ontology/abstrac</code><code class="err">\</code>
<code class="linenos"> 4 </code><code class="nv">t&gt;</code>  <code class="s">"William Henry \"Bill\" Gates III (born October 28, 1955) is an American busines\</code>
<code class="linenos"> 5 </code><code class="s">s magnate,...."</code><code class="nv">@en</code> <code class="o">.</code>
<code class="linenos"> 6 </code><code class="nv">&lt;http://dbpedia.org/resource/Bill_Gates&gt;</code>
<code class="linenos"> 7 </code>        <code class="nv">&lt;http://xmlns.com/foaf/0.1/name&gt;</code>
<code class="linenos"> 8 </code>        <code class="s">"Bill Gates"</code><code class="nv">@en</code> <code class="o">.</code>
<code class="linenos"> 9 </code><code class="nv">&lt;http://dbpedia.org/resource/Bill_Gates&gt;</code>
<code class="linenos">10 </code>        <code class="nv">&lt;http://xmlns.com/foaf/0.1/surname&gt;</code>
<code class="linenos">11 </code>        <code class="s">"Gates"</code><code class="nv">@en</code> <code class="o">.</code>
<code class="linenos">12 </code><code class="nv">&lt;http://dbpedia.org/resource/Bill_Gates&gt;</code>
<code class="linenos">13 </code>        <code class="nv">&lt;http://dbpedia.org/ontology/title&gt;</code>
<code class="linenos">14 </code>        <code class="s">"Co-Chairmanof theBill &amp; Melinda Gates Foundation"</code><code class="nv">@en</code> <code class="o">.</code>
</pre></div>

</figure>

<p>The same data in Turtle RDF format can be seen in the file <strong>sample-KG.ttl</strong> that was produced by importing the triples file into the free edition of GraphDB exporting it to the Turtle file <strong>sample-KG.ttl</strong> that I find easier to read. GraphDB has visualization tools which I use here to generate an interactive graph display of this data:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/GraphDB.jpg" alt="GraphDB Visual graph of generated RDF triples" style="width: 100%">
    <figcaption>GraphDB Visual graph of generated RDF triples</figcaption>
  </figure>
</div>


<p>This example is also set up for people and companies. I may expand it in the future to other types of entities as I need them.</p>

<p>This example program takes several minutes to run since many SPARQL queries are made to DBPedia. I am a non-corporate member of the DBPedia organization. <a href="https://www.dbpedia.org/members/membership/">Here is a membership application</a> if you are interested in joining me there.</p>


<h2 id="kgncommon">Knowledge Graph Navigator Common Library Implementation</h2>

<p>The Knowledge Graph Navigator (which I will often refer to as KGN) is a tool for processing a set of entity names and automatically exploring the public Knowledge Graph <a href="http://dbpedia.org">DBPedia</a> using SPARQL queries. I started to write KGN for my own use, to automate some things I used to do manually when exploring Knowledge Graphs, and later thought that KGN might be also useful for educational purposes. KGN shows the user the auto-generated SPARQL queries so hopefully the user will learn by seeing examples. KGN uses NLP code developed in earlier chapters and we will reuse that code with a short review of using the APIs.</p>

<p>In previous versions of this book, this example was hard-wired to use LispWork CAPI for the user interface. This old version is in <strong>src/kgn</strong> in the main GitHub repository for this book: <a href="https://github.com/mark-watson/loving-common-lisp">https://github.com/mark-watson/loving-common-lisp</a> and has a few UI components like a progress bar that I removed since the previous edition. The new version has separate GitHub repositories for:</p>

<ul>
  <li>
<a href="https://github.com/mark-watson/kgn-common">https://github.com/mark-watson/kgn-common</a> for the Knowledge Graph Navigator common library. </li>
  <li>
<a href="https://github.com/mark-watson/kgn-text-ui">https://github.com/mark-watson/kgn-text-ui</a> for a text interface for the Knowledge Graph Navigator. </li>
  <li>
<a href="https://github.com/mark-watson/kgn-capi-ui">https://github.com/mark-watson/kgn-capi-ui</a> for a LispWorks CAPI GUI interface for the Knowledge Graph Navigator.</li>
</ul>

<p>If you followed the code example setup instructions in the book Preface or in the README file in the main repo <a href="https://github.com/mark-watson/loving-common-lisp">https://github.com/mark-watson/loving-common-lisp</a> then all three of these projects are available for loading via Quicklisp on your computer.</p>

<p>After looking at SPARQL generated by this example for an example query, we will start a process of bottom up development, first writing low level functions to automate SPARQL queries, writing utilities we will need for the UIs developed in later chapters.</p>

<p>Since the DBPedia SPARQL queries are time consuming, we will also implement a caching layer using SQLite that will make the app more responsive. The cache is especially helpful during development when the same queries are repeatedly used for testing.</p>

<p>The code for this reusable library is in the directory <strong>src/kgn-common</strong>. This is common library that will be used for user interfaces developed in later chapters. There is a lot of code in the following program listings and I hope to provide you with a roadmap overview of the code, diving in on code that you might want to reuse for your own projects and some representative code for generating SPARQL queries.</p>

<p>Let’s start by looking at the files for the common library:</p>

<ul>
  <li>Makefile - contains development shortcuts.</li>
  <li>data - data used to remove stop words from text.</li>
  <li>kgn-common.lisp - main code file for library.</li>
  <li>package.lisp - standard Common Lisp package definition.</li>
  <li>utils.lisp - miscelanious utility functions.</li>
  <li>README.txt</li>
  <li>kgn-common.asd - standard Common Lisp ASDF definition.</li>
</ul>

<h3 id="leanpub-auto-example-output">Example Output</h3>

<p>Before we get started studying the implementation, let’s look at sample output in order to help give meaning to the code we will look at later. Consider a query that a user might type into the top query field in the KGN app:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    Steve Jobs lived near San Francisco and was
<code class="linenos">2 </code>    a founder of &lt;http://dbpedia.org/resource/Apple_Inc.&gt;
</pre></div>

</figure>

<p>The system will try to recognize entities in a query. If you know the DBPedia URI of an entity, like the company Apple in this example, you can use that directly. Note that in the SPARQL  URIs are surrounded with angle bracket characters.</p>

<p>The application prints out automatically generated SPARQL queries. For the above listed example query the following output will be generated (some editing to fit page width):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Trying to get entity by name = Steve Jobs using SPARQL with type:
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="k">distinct</code> <code class="nv">?s</code> <code class="nv">?comment</code> <code class="p">{</code> <code class="nv">?s</code> <code class="nv">?p</code> <code class="s">"Steve Jobs"</code><code class="o">@</code><code class="nf">en</code> <code class="p">.</code> 
 <code class="nv">?s</code> <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code> <code class="nv">?comment</code> <code class="p">.</code>
   <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?comment</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">.</code> 
 <code class="nv">?s</code> <code class="nl">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt;</code>
    <code class="nl">&lt;http://dbpedia.org/ontology/Person&gt;</code> <code class="p">.</code> 
 <code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">15</code> 
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Trying to get entity by name = San Francisco using SPARQL with type:
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="k">distinct</code> <code class="nv">?s</code> <code class="nv">?comment</code> <code class="p">{</code> <code class="nv">?s</code> <code class="nv">?p</code> <code class="s">"San Francisco"</code><code class="o">@</code><code class="nf">en</code> <code class="p">.</code> 
 <code class="nv">?s</code> <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code> <code class="nv">?comment</code> <code class="p">.</code> 
   <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?comment</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">.</code> 
 <code class="nv">?s</code> <code class="nl">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt;</code>
    <code class="nl">&lt;http://dbpedia.org/ontology/City&gt;</code> <code class="p">.</code> 
 <code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">15</code> 
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">SPARQL</code> <code class="nv">to</code> <code class="nv">get</code> <code class="nv">PERSON</code> <code class="nv">data</code> <code class="k">for</code> <code class="o">&lt;</code><code class="nv">http</code>:<code class="o">//</code><code class="nv">dbpedia</code>.<code class="nv">org</code><code class="o">/</code><code class="nv">resource</code><code class="o">/</code><code class="nv">Steve_Jobs</code><code class="o">&gt;</code>:
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?label</code> <code class="nv">?comment</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?birthplace</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> <code class="k">AS</code> <code class="nv">?birthplace</code> <code class="p">)</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?almamater</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> <code class="k">AS</code> <code class="nv">?almamater</code> <code class="p">)</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?spouse</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> <code class="k">AS</code> <code class="nv">?spouse</code> <code class="p">)</code> <code class="p">{</code> 
 <code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code> 
   <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code>
   <code class="nv">?comment</code> <code class="p">.</code> 
 <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?comment</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code>
            <code class="nl">&lt;http://dbpedia.org/ontology/birthPlace&gt;</code>
            <code class="nv">?birthplace</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/almaMater&gt;</code> 
            <code class="nv">?almamater</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/spouse&gt;</code> 
            <code class="nv">?spouse</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code> 
            <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</code> 
            <code class="nv">?label</code> <code class="p">.</code> 
 <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?label</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">}</code> 
 <code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">10</code> 
</pre></div>

</figure>

<p>Remember, the SPARQL is generated by KGN from natural language queries. Some more examples:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">SPARQL</code> <code class="nv">to</code> <code class="nv">get</code> <code class="nv">CITY</code> <code class="nv">data</code> <code class="k">for</code> <code class="o">&lt;</code><code class="nv">http</code>:<code class="o">//</code><code class="nv">dbpedia</code>.<code class="nv">org</code><code class="o">/</code><code class="nv">resource</code><code class="o">/</code><code class="nv">San_Francisco</code><code class="o">&gt;</code>:
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?label</code> <code class="nv">?comment</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?latitude_longitude</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> 
     <code class="k">AS</code> <code class="nv">?latitude_longitude</code> <code class="p">)</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?populationDensity</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> 
     <code class="k">AS</code> <code class="nv">?populationDensity</code> <code class="p">)</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?country</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> 
     <code class="k">AS</code> <code class="nv">?country</code> <code class="p">)</code> <code class="p">{</code> 
 <code class="nl">&lt;http://dbpedia.org/resource/San_Francisco&gt;</code> 
   <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code>
   <code class="nv">?comment</code> <code class="p">.</code> 
      <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?comment</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/San_Francisco&gt;</code> 
            <code class="nl">&lt;http://www.w3.org/2003/01/geo/wgs84_pos#geometry&gt;</code> 
            <code class="nv">?latitude_longitude</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/San_Francisco&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/PopulatedPlace/populationDensity&gt;</code> 
            <code class="nv">?populationDensity</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/San_Francisco&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/country&gt;</code> 
            <code class="nv">?country</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/San_Francisco&gt;</code> 
            <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</code> 
            <code class="nv">?label</code> <code class="p">.</code> <code class="p">}</code> 
 <code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">30</code> 
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">SPARQL</code> <code class="nv">to</code> <code class="nv">get</code> <code class="nv">COMPANY</code> <code class="nv">data</code> <code class="k">for</code> <code class="o">&lt;</code><code class="nv">http</code>:<code class="o">//</code><code class="nv">dbpedia</code>.<code class="nv">org</code><code class="o">/</code><code class="nv">resource</code><code class="o">/</code><code class="nv">Apple_Inc</code>.<code class="o">&gt;</code>:
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?label</code> <code class="nv">?comment</code> <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?industry</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | \</code>
<code class="s">' ) </code>
      <code class="k">AS</code> <code class="nv">?industry</code> <code class="p">)</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?netIncome</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> 
      <code class="k">AS</code> <code class="nv">?netIncome</code> <code class="p">)</code> 
 <code class="p">(</code> <code class="nf">GROUP_CONCAT</code> <code class="p">(</code> <code class="k">DISTINCT</code> <code class="nv">?numberOfEmployees</code> <code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code> <code class="p">)</code> 
      <code class="k">AS</code> <code class="nv">?numberOfEmployees</code> <code class="p">)</code> <code class="p">{</code> 
 <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code> 
    <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code> <code class="nv">?comment</code> <code class="p">.</code> 
 <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?comment</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/industry&gt;</code> 
            <code class="nv">?industry</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/netIncome&gt;</code> <code class="nv">?netIncome</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code> 
            <code class="nl">&lt;http://dbpedia.org/ontology/numberOfEmployees&gt;</code> <code class="nv">?numberOfEmployees</code> <code class="p">}</code> <code class="p">.</code> 
 <code class="k">OPTIONAL</code> <code class="p">{</code> <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code> 
            <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</code> <code class="nv">?label</code> <code class="p">.</code> 
              <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?label</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> <code class="p">}</code> 
 <code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">30</code> 
</pre></div>

</figure>

<p>Once KGN has identified DBPedia entire URIs, it also searches for relationships between these entities:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>DISCOVERED RELATIONSHIP LINKS:
</pre></div>

</figure>
<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code>    <code class="o">-&gt;</code>
    <code class="nl">&lt;http://dbpedia.org/ontology/birthPlace&gt;</code>    <code class="o">-&gt;</code>
    <code class="nl">&lt;http://dbpedia.org/resource/San_Francisco&gt;</code>
<code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code>    <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/ontology/occupation&gt;</code>    <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code>
<code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code>    <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/ontology/board&gt;</code>         <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code>
<code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code>    <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#seeAlso&gt;</code> <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code>
<code class="nl">&lt;http://dbpedia.org/resource/Apple_Inc.&gt;</code>    <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/property/founders&gt;</code>      <code class="o">-&gt;</code> 
    <code class="nl">&lt;http://dbpedia.org/resource/Steve_Jobs&gt;</code>
</pre></div>

</figure>

<p>After listing the generated SPARQL for finding information for the entities in the query, KGN searches for relationships between these entities. These discovered relationships can be seen at the end of the last listing. Please note that this step makes SPARQL queries on <strong>O(n^2)</strong> where <strong>n</strong> is the number of entities. Local caching of SPARQL queries to DBPedia helps make processing many entities possible.</p>

<p>In addition to showing generated SPARQL and discovered relationships in the middle text pane of the application, KGN also generates formatted results that are also displayed in the bottom text pane:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nt">-</code> <code class="nt">-</code> <code class="nt">-</code> <code class="nt">ENTITY</code> <code class="nt">TYPE</code><code class="o">:</code> <code class="nt">PEOPLE</code> <code class="nt">-</code> <code class="nt">-</code> <code class="nt">-</code>

<code class="nt">LABEL</code><code class="o">:</code> <code class="nt">Steve</code> <code class="nt">Jobs</code>

<code class="nt">COMMENT</code><code class="o">:</code> <code class="nt">Steven</code> <code class="nt">Paul</code> <code class="s2">"Steve"</code> <code class="nt">Jobs</code> <code class="nt">was</code> <code class="nt">an</code> <code class="nt">American</code> <code class="nt">information</code> <code class="nt">technology</code> 
<code class="nt">entrepreneur</code> <code class="nt">and</code> <code class="nt">inventor</code><code class="o">.</code> <code class="nt">He</code> <code class="nt">was</code> <code class="nt">the</code> <code class="nt">co-founder</code><code class="o">,</code> <code class="nt">chairman</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">chief</code> 
<code class="nt">executive</code> <code class="nt">officer</code> <code class="o">(</code><code class="nt">CEO</code><code class="o">)</code> <code class="nt">of</code> <code class="nt">Apple</code> <code class="nt">Inc</code><code class="o">.;</code> <code class="nt">CEO</code> <code class="nt">and</code> <code class="nt">majority</code> <code class="nt">shareholder</code>
<code class="nt">of</code> <code class="nt">Pixar</code> <code class="nt">Animation</code> <code class="nt">Studios</code><code class="o">;</code> <code class="nt">a</code> <code class="nt">member</code> <code class="nt">of</code> <code class="nt">The</code> <code class="nt">Walt</code> <code class="nt">Disney</code> <code class="nt">Company</code><code class="s1">'s </code>
<code class="s1">board of directors following its acquisition of Pixar; and founder, </code>
<code class="s1">chairman, and CEO of NeXT Inc. Jobs is widely recognized as a pioneer of </code>
<code class="s1">the microcomputer revolution of the 1970s and 1980s, along with Apple </code>
<code class="s1">co-founder Steve Wozniak. Shortly after his death, Jobs'</code><code class="nt">s</code> <code class="nt">official</code> 
<code class="nt">biographer</code><code class="o">,</code> <code class="nt">Walter</code> <code class="nt">Isaacson</code><code class="o">,</code> <code class="nt">described</code> <code class="nt">him</code> <code class="nt">as</code> <code class="nt">a</code> <code class="err">"</code><code class="nt">creative</code> <code class="nt">entrepreneur</code> 
<code class="nt">whose</code> <code class="nt">passion</code> <code class="nt">for</code> <code class="nt">perfection</code> <code class="nt">and</code> <code class="nt">ferocious</code> <code class="nt">drive</code> <code class="nt">revolutionized</code> <code class="nt">six</code> <code class="nt">industries</code><code class="o">:</code>
<code class="nt">personal</code> <code class="nt">computers</code><code class="o">,</code> <code class="nt">animated</code> <code class="nt">movies</code><code class="o">,</code> <code class="nt">music</code><code class="o">,</code> <code class="nt">phones</code>

<code class="nt">BIRTHPLACE</code><code class="o">:</code> <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">San_Francisco</code>

<code class="nt">ALMAMATER</code><code class="o">:</code> <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Reed_College</code>

<code class="nt">SPOUSE</code><code class="o">:</code> <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Laurene_Powell_Jobs</code>

<code class="nt">-</code> <code class="nt">-</code> <code class="nt">-</code> <code class="nt">ENTITY</code> <code class="nt">TYPE</code><code class="o">:</code> <code class="nt">CITIES</code> <code class="nt">-</code> <code class="nt">-</code> <code class="nt">-</code>

<code class="nt">LABEL</code><code class="o">:</code>  <code class="nt">San</code> <code class="nt">Francisco</code>

<code class="nt">COMMENT</code><code class="o">:</code> <code class="nt">San</code> <code class="nt">Francisco</code><code class="o">,</code> <code class="nt">officially</code> <code class="nt">the</code> <code class="nt">City</code> <code class="nt">and</code> <code class="nt">County</code> <code class="nt">of</code> <code class="nt">San</code> <code class="nt">Francisco</code><code class="o">,</code> <code class="nt">is</code> <code class="nt">the</code>
<code class="nt">cultural</code><code class="o">,</code> <code class="nt">commercial</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">financial</code> <code class="nt">center</code> <code class="nt">of</code> <code class="nt">Northern</code> <code class="nt">California</code> <code class="nt">and</code>
<code class="nt">the</code> <code class="nt">only</code> <code class="nt">consolidated</code> <code class="nt">city-county</code> <code class="nt">in</code> <code class="nt">California</code><code class="o">.</code> <code class="nt">San</code> <code class="nt">Francisco</code> <code class="nt">encompasses</code> <code class="nt">a</code>
<code class="nt">land</code> <code class="nt">area</code> <code class="nt">of</code> <code class="nt">about</code> <code class="nt">46</code><code class="p">.</code><code class="nc">9</code> <code class="nt">square</code> <code class="nt">miles</code> <code class="o">(</code><code class="nt">121</code> <code class="nt">km2</code><code class="o">)</code> <code class="nt">on</code> <code class="nt">the</code> <code class="nt">northern</code> <code class="nt">end</code> <code class="nt">of</code> <code class="nt">the</code> 
<code class="nt">San</code> <code class="nt">Francisco</code> <code class="nt">Peninsula</code><code class="o">,</code> <code class="nt">which</code> <code class="nt">makes</code> <code class="nt">it</code> <code class="nt">the</code> <code class="nt">smallest</code> <code class="nt">county</code> <code class="nt">in</code> <code class="nt">the</code> <code class="nt">state</code><code class="o">.</code> 
<code class="nt">It</code> <code class="nt">has</code> <code class="nt">a</code> <code class="nt">density</code> <code class="nt">of</code> <code class="nt">about</code> <code class="nt">18</code><code class="o">,</code><code class="nt">451</code> <code class="nt">people</code> <code class="nt">per</code> <code class="nt">square</code> <code class="nt">mile</code> <code class="o">(</code><code class="nt">7</code><code class="o">,</code><code class="nt">124</code> <code class="nt">people</code> <code class="nt">per</code> <code class="nt">km2</code><code class="o">),</code>
<code class="nt">making</code> <code class="nt">it</code> <code class="nt">the</code> <code class="nt">most</code> <code class="nt">densely</code> <code class="nt">settled</code> <code class="nt">large</code> <code class="nt">city</code> <code class="o">(</code><code class="nt">population</code> <code class="nt">greater</code> <code class="nt">than</code> 
<code class="nt">200</code><code class="o">,</code><code class="nt">000</code><code class="o">)</code> <code class="nt">in</code> <code class="nt">the</code> <code class="nt">state</code> <code class="nt">of</code> <code class="nt">California</code> <code class="nt">and</code> <code class="nt">the</code> <code class="nt">second-most</code> <code class="nt">densely</code> <code class="nt">populated</code> 
<code class="nt">major</code> <code class="nt">city</code> <code class="nt">in</code> <code class="nt">the</code> <code class="nt">United</code> <code class="nt">States</code> <code class="nt">after</code> <code class="nt">New</code> <code class="nt">York</code> <code class="nt">City</code><code class="o">.</code> <code class="nt">San</code> <code class="nt">Francisco</code> <code class="nt">is</code> 
<code class="nt">the</code> <code class="nt">fourth-most</code> <code class="nt">populous</code> <code class="nt">city</code> <code class="nt">in</code> <code class="nt">California</code><code class="o">,</code> <code class="nt">after</code> <code class="nt">Los</code> <code class="nt">Angeles</code><code class="o">,</code> <code class="nt">San</code> <code class="nt">Diego</code><code class="o">,</code> <code class="nt">and</code> 
<code class="nt">San</code> <code class="nt">Jose</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">the</code> <code class="nt">13th-most</code> <code class="nt">populous</code> <code class="nt">cit</code>

<code class="nt">LATITUDE--LONGITUDE</code><code class="o">:</code> <code class="nt">POINT</code><code class="o">(</code><code class="nt">-122</code><code class="p">.</code><code class="nc">41666412354</code> <code class="nt">37</code><code class="p">.</code><code class="nc">783332824707</code><code class="o">)</code>

<code class="nt">POPULATION-DENSITY</code><code class="o">:</code> <code class="nt">7123</code><code class="p">.</code><code class="nc">97092726667</code>

<code class="nt">COUNTRY</code><code class="o">:</code> <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">United_States</code>

<code class="nt">-</code> <code class="nt">-</code> <code class="nt">-</code> <code class="nt">ENTITY</code> <code class="nt">TYPE</code><code class="o">:</code> <code class="nt">COMPANIES</code> <code class="nt">-</code> <code class="nt">-</code> <code class="nt">-</code>

<code class="nt">LABEL</code><code class="o">:</code> <code class="nt">Apple</code> <code class="nt">Inc</code><code class="o">.</code>

<code class="nt">COMMENT</code><code class="o">:</code> <code class="nt">Apple</code> <code class="nt">Inc</code><code class="o">.</code> <code class="nt">is</code> <code class="nt">an</code> <code class="nt">American</code> <code class="nt">multinational</code> <code class="nt">technology</code> <code class="nt">company</code> <code class="nt">headquartered</code>
<code class="nt">in</code> <code class="nt">Cupertino</code><code class="o">,</code> 
<code class="nt">California</code><code class="o">,</code> <code class="nt">that</code> <code class="nt">designs</code><code class="o">,</code> <code class="nt">develops</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">sells</code> <code class="nt">consumer</code> <code class="nt">electronics</code><code class="o">,</code> 
<code class="nt">computer</code> <code class="nt">software</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">online</code> <code class="nt">services</code><code class="o">.</code> <code class="nt">Its</code> <code class="nt">hardware</code> <code class="nt">products</code> <code class="nt">include</code> <code class="nt">the</code> 
<code class="nt">iPhone</code> <code class="nt">smartphone</code><code class="o">,</code> <code class="nt">the</code> <code class="nt">iPad</code> <code class="nt">tablet</code> <code class="nt">computer</code><code class="o">,</code> <code class="nt">the</code> <code class="nt">Mac</code> <code class="nt">personal</code> <code class="nt">computer</code><code class="o">,</code> <code class="nt">the</code> 
<code class="nt">iPod</code> <code class="nt">portable</code> <code class="nt">media</code> <code class="nt">player</code><code class="o">,</code> <code class="nt">the</code> <code class="nt">Apple</code> <code class="nt">Watch</code> <code class="nt">smartwatch</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">the</code> <code class="nt">Apple</code> <code class="nt">TV</code> <code class="nt">digital</code> 
<code class="nt">media</code> <code class="nt">player</code><code class="o">.</code> <code class="nt">Apple</code><code class="err">'</code><code class="nt">s</code> <code class="nt">consumer</code> <code class="nt">software</code> <code class="nt">includes</code> <code class="nt">the</code> <code class="nt">macOS</code> <code class="nt">and</code> <code class="nt">iOS</code> <code class="nt">operating</code> 
<code class="nt">systems</code><code class="o">,</code> <code class="nt">the</code> <code class="nt">iTunes</code> <code class="nt">media</code> <code class="nt">player</code><code class="o">,</code> <code class="nt">the</code> <code class="nt">Safari</code> <code class="nt">web</code> <code class="nt">browser</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">the</code> <code class="nt">iLife</code> <code class="nt">and</code> 
<code class="nt">iWork</code> <code class="nt">creativity</code> <code class="nt">and</code> <code class="nt">productivity</code> <code class="nt">suites</code><code class="o">.</code> <code class="nt">Its</code> <code class="nt">online</code> <code class="nt">services</code> <code class="nt">include</code> <code class="nt">the</code> 
<code class="nt">iTunes</code> <code class="nt">Store</code><code class="o">,</code> <code class="nt">the</code> <code class="nt">iOS</code> <code class="nt">App</code> <code class="nt">Store</code> <code class="nt">and</code> <code class="nt">Mac</code> <code class="nt">App</code> <code class="nt">Store</code><code class="o">,</code> <code class="nt">Apple</code> <code class="nt">Music</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">iCloud</code><code class="o">.</code>

<code class="nt">INDUSTRY</code><code class="o">:</code> <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Computer_hardware</code> <code class="o">|</code> 
          <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Computer_software</code> <code class="o">|</code> 
          <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Consumer_electronics</code> <code class="o">|</code> 
          <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Corporate_Venture_Capital</code> <code class="o">|</code> 
          <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Digital_distribution</code> <code class="o">|</code>
          <code class="nt">http</code><code class="o">://</code><code class="nt">dbpedia</code><code class="p">.</code><code class="nc">org</code><code class="o">/</code><code class="nt">resource</code><code class="o">/</code><code class="nt">Fabless_manufacturing</code>

<code class="nt">NET-INCOME</code><code class="o">:</code> <code class="nt">5</code><code class="p">.</code><code class="nc">3394E10</code>

<code class="nt">NUMBER-OF-EMPLOYEES</code><code class="o">:</code> <code class="nt">115000</code>
</pre></div>

</figure>

<p>Hopefully after reading through sample output and seeing the screen shot of the application, you now have a better idea what this example application does. Now we will look at project configuration and then implementation.</p>

<h3 id="leanpub-auto-project-configuration-and-running-the-application">Project Configuration and Running the Application</h3>

<p>The following listing of <strong>kgn.asd</strong> shows the ten packages this example depends on (five of these are also examples in this book, and five are in the public Quicklisp repository):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;;; knowledgegraphnavigator.asd</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">((</code><code class="nv">asdf:defsystem</code> <code class="ss">#:kgn-common</code>
<code class="linenos"> 4 </code>  <code class="ss">:description</code> <code class="s">"common utilities for Knowledge Graph Navigator"</code>
<code class="linenos"> 5 </code>  <code class="ss">:author</code> <code class="s">"Mark Watson &lt;markw@markwatson.com&gt;"</code>
<code class="linenos"> 6 </code>  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
<code class="linenos"> 7 </code>  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:sqlite</code> <code class="ss">#:cl-json</code> <code class="ss">#:alexandria</code> <code class="ss">#:drakma</code> <code class="ss">#:myutils</code> <code class="ss">#:entities</code> <code class="ss">#:entit</code><code class="err">\</code>
<code class="linenos"> 8 </code><code class="nv">y-uris</code> <code class="ss">#:kbnlp</code> <code class="ss">#:sparql-cache</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
<code class="linenos">10 </code>               <code class="p">(</code><code class="ss">:file</code> <code class="s">"utils"</code><code class="p">)</code>
<code class="linenos">11 </code>               <code class="p">(</code><code class="ss">:file</code> <code class="s">"kgn-common"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Listing of <strong>package.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;;; package.lisp</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:kgn-common</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:alexandria</code> <code class="ss">#:myutils</code>  <code class="ss">#:myutils</code> <code class="ss">#:sparql-cache</code>
<code class="linenos"> 5 </code>   <code class="ss">#:entities</code> <code class="ss">#:entity-uris</code> <code class="ss">#:kbnlp</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="ss">:export</code> <code class="ss">#:kgn-common</code> <code class="ss">#:remove-stop-words</code>        
<code class="linenos"> 7 </code>         <code class="ss">#:entity-results-&gt;relationship-links</code>
<code class="linenos"> 8 </code>         <code class="ss">#:get-entity-data-helper</code> <code class="ss">#:handle-URIs-in-query</code>
<code class="linenos"> 9 </code>         <code class="ss">#:remove-uris-from-query</code> <code class="ss">#:get-URIs-in-query</code> <code class="ss">#:display-entity-results</code>
<code class="linenos">10 </code>         <code class="ss">#:string-shorten</code> <code class="ss">#:prompt-string</code> <code class="ss">#:dbpedia-get-product-detail</code>
<code class="linenos">11 </code>         <code class="ss">#:dbpedia-get-person-detail</code> <code class="ss">#:dbpedia-get-country-detail</code>
<code class="linenos">12 </code>         <code class="ss">#:dbpedia-get-city-detail</code> <code class="ss">#:dbpedia-get-company-detail</code> <code class="ss">#:clean-results</code>
<code class="linenos">13 </code>         <code class="ss">#:dbpedia-get-entities-by-name</code> <code class="ss">#:clean-comment</code><code class="p">))</code>
</pre></div>

</figure>

<p>We use <strong>ql:quickload</strong> to load the KGN common library and call a few APIs (some output removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="nv">$</code> <code class="nv">sbcl</code>
<code class="linenos">  2 </code><code class="nv">This</code> <code class="nv">is</code> <code class="nv">SBCL</code> <code class="nv">2.1.10,</code> <code class="nv">an</code> <code class="nv">implementation</code> <code class="nv">of</code> <code class="nv">ANSI</code> <code class="nv">Common</code> <code class="nv">Lisp.</code>
<code class="linenos">  3 </code><code class="nb">*</code> <code class="p">(</code><code class="nv">ql</code> <code class="ss">:kgn-common</code><code class="p">)</code>
<code class="linenos">  4 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"kgn-common"</code><code class="err">:</code>
<code class="linenos">  5 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos">  6 </code>    <code class="nv">kgn-common</code>
<code class="linenos">  7 </code><code class="c1">; Loading "kgn-common"</code>
<code class="linenos">  8 </code><code class="o">..................</code>
<code class="linenos">  9 </code><code class="s">"Starting to load data...."</code> 
<code class="linenos"> 10 </code><code class="s">"....done loading data."</code> 
<code class="linenos"> 11 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"sqlite"</code><code class="err">:</code>
<code class="linenos"> 12 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos"> 13 </code>    <code class="nv">sqlite</code>
<code class="linenos"> 14 </code><code class="c1">; Loading "sqlite"</code>
<code class="linenos"> 15 </code>
<code class="linenos"> 16 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"cl-json"</code><code class="err">:</code>
<code class="linenos"> 17 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos"> 18 </code>    <code class="nv">cl-json</code>
<code class="linenos"> 19 </code><code class="c1">; Loading "cl-json"</code>
<code class="linenos"> 20 </code>
<code class="linenos"> 21 </code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"drakma"</code><code class="err">:</code>
<code class="linenos"> 22 </code>  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
<code class="linenos"> 23 </code>    <code class="nv">drakma</code>
<code class="linenos"> 24 </code><code class="c1">; Loading "drakma"</code>
<code class="linenos"> 25 </code><code class="nv">[package</code> <code class="nv">kgn-common]..</code>
<code class="linenos"> 26 </code><code class="p">(</code><code class="ss">:kgn-common</code><code class="p">)</code>
<code class="linenos"> 27 </code><code class="nb">*</code>
<code class="linenos"> 28 </code><code class="nb">*</code>  <code class="p">(</code><code class="nv">kgn-common::dbpedia-get-relationships</code> <code class="s">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code><code class="err">\</code>
<code class="linenos"> 29 </code> <code class="s">"&lt;http://dbpedia.org/resource/Microsoft&gt;"</code><code class="p">)</code>
<code class="linenos"> 30 </code><code class="p">(</code><code class="s">"&lt;http://dbpedia.org/ontology/knownFor&gt;"</code><code class="p">)</code>
<code class="linenos"> 31 </code><code class="nb">*</code>
<code class="linenos"> 32 </code><code class="nb">*</code>  <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-entities-by-name</code> <code class="s">"Bill Gates"</code> <code class="s">"&lt;http://dbpedia.org/ontolo\</code>
<code class="linenos"> 33 </code><code class="s">gy/Person&gt;"</code> <code class="s">"&lt;http://schema.org/Person&gt;"</code> <code class="ss">:message-stream</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 34 </code>
<code class="linenos"> 35 </code><code class="p">(((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Bill_Gates"</code><code class="p">)</code>
<code class="linenos"> 36 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 37 </code>   <code class="s">"William Henry Gates III (born October 28, 1955) is an American business magnate,\</code>
<code class="linenos"> 38 </code><code class="s"> software developer, investor, author, and philanthropist. He is a co-founder of Mic\</code>
<code class="linenos"> 39 </code><code class="s">rosoft, along with his late childhood friend Paul Allen. During his career at Micros\</code>
<code class="linenos"> 40 </code><code class="s">oft, Gates held the positions of chairman, chief executive officer (CEO), president \</code>
<code class="linenos"> 41 </code><code class="s">and chief software architect, while also being the largest individual shareholder un\</code>
<code class="linenos"> 42 </code><code class="s">til May 2014. He is considered one of the best known entrepreneurs of the microcompu\</code>
<code class="linenos"> 43 </code><code class="s">ter revolution of the 1970s and 1980s."</code><code class="p">))</code>
<code class="linenos"> 44 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Harry_R._Lewis"</code><code class="p">)</code>
<code class="linenos"> 45 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 46 </code>   <code class="s">"Harry Roy Lewis (born 1947) is an American computer scientist, mathe 00ADma 00AD\</code>
<code class="linenos"> 47 </code><code class="s">ti 00ADcian, and uni 00ADver 00ADsity admin 00ADi 00ADstra 00ADtor known for his res\</code>
<code class="linenos"> 48 </code><code class="s">earch in com 00ADpu 00ADta 00ADtional logic, textbooks in theoretical computer scien\</code>
<code class="linenos"> 49 </code><code class="s">ce, and writings on computing, higher education, and technology. He is Gordon McKay \</code>
<code class="linenos"> 50 </code><code class="s">Professor of Computer Science at Harvard University, and was Dean of Harvard College\</code>
<code class="linenos"> 51 </code><code class="s"> from 1995 to 2003. A new professorship in Engineering and Applied Sciences, endowed\</code>
<code class="linenos"> 52 </code><code class="s"> by a former student, will be named for Lewis and his wife upon their retirements."</code><code class="p">)</code><code class="err">\</code>
<code class="linenos"> 53 </code><code class="p">)</code>
<code class="linenos"> 54 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Cascade_Investment"</code><code class="p">)</code>
<code class="linenos"> 55 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 56 </code>   <code class="s">"Cascade Investment, L.L.C. is an American holding company and private investment\</code>
<code class="linenos"> 57 </code><code class="s"> firm headquartered in Kirkland, Washington, United States. It is controlled by Bill\</code>
<code class="linenos"> 58 </code><code class="s"> Gates, and managed by Michael Larson. More than half of Gates' fortune is held in a\</code>
<code class="linenos"> 59 </code><code class="s">ssets outside his holding of Microsoft shares. Cascade is the successor company to D\</code>
<code class="linenos"> 60 </code><code class="s">ominion Income Management, the former investment vehicle for Gates' holdings, which \</code>
<code class="linenos"> 61 </code><code class="s">was managed by convicted felon Andrew Evans."</code><code class="p">))</code>
<code class="linenos"> 62 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Jerry_Dyer"</code><code class="p">)</code>
<code class="linenos"> 63 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 64 </code>   <code class="s">"Jerry P. Dyer (born May 3, 1959) is an American politician and former law enforc\</code>
<code class="linenos"> 65 </code><code class="s">ement officer. He is the 26th and current mayor of Fresno, California. Previously, h\</code>
<code class="linenos"> 66 </code><code class="s">e served as the chief of the Fresno Police Department."</code><code class="p">)))</code> 
<code class="linenos"> 67 </code>
<code class="linenos"> 68 </code><code class="nv">select</code> <code class="nv">distinct</code> <code class="nv">?s</code> <code class="nv">?comment</code> <code class="nv">{</code> <code class="nv">?s</code> <code class="nv">?p</code> <code class="s">"Bill Gates"</code><code class="nv">@en</code> <code class="o">.</code> <code class="nv">@@</code> <code class="nv">?s</code> <code class="nv">&lt;http://www.w3.org/2000/</code><code class="err">\</code>
<code class="linenos"> 69 </code><code class="nv">01/rdf-schema#comment&gt;</code>  <code class="nv">?comment</code>  <code class="o">.</code> <code class="nv">FILTER</code>  <code class="p">(</code><code class="nv">lang</code><code class="p">(</code><code class="nv">?comment</code><code class="p">)</code> <code class="nb">=</code> <code class="ss">'en</code><code class="o">'</code><code class="p">)</code> <code class="o">.</code> <code class="nv">@@</code> <code class="nv">?s</code> <code class="nv">&lt;http://</code><code class="err">\</code>
<code class="linenos"> 70 </code><code class="nv">www.w3.org/1999/02/22-rdf-syntax-ns#type&gt;</code> <code class="nv">&lt;http://dbpedia.org/ontology/Person&gt;</code> <code class="o">.</code> <code class="nv">@@</code> <code class="err">\</code>
<code class="linenos"> 71 </code><code class="nv">}</code> <code class="nv">LIMIT</code> <code class="mi">15</code>
<code class="linenos"> 72 </code><code class="p">(((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Bill_Gates"</code><code class="p">)</code>
<code class="linenos"> 73 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 74 </code>   <code class="s">"William Henry Gates III (born October 28, 1955) is an American business magnate,\</code>
<code class="linenos"> 75 </code><code class="s"> software developer, investor, author, and philanthropist. He is a co-founder of Mic\</code>
<code class="linenos"> 76 </code><code class="s">rosoft, along with his late childhood friend Paul Allen. During his career at Micros\</code>
<code class="linenos"> 77 </code><code class="s">oft, Gates held the positions of chairman, chief executive officer (CEO), president \</code>
<code class="linenos"> 78 </code><code class="s">and chief software architect, while also being the largest individual shareholder un\</code>
<code class="linenos"> 79 </code><code class="s">til May 2014. He is considered one of the best known entrepreneurs of the microcompu\</code>
<code class="linenos"> 80 </code><code class="s">ter revolution of the 1970s and 1980s."</code><code class="p">))</code>
<code class="linenos"> 81 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Harry_R._Lewis"</code><code class="p">)</code>
<code class="linenos"> 82 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 83 </code>   <code class="s">"Harry Roy Lewis (born 1947) is an American computer scientist, mathe 00ADma 00AD\</code>
<code class="linenos"> 84 </code><code class="s">ti 00ADcian, and uni 00ADver 00ADsity admin 00ADi 00ADstra 00ADtor known for his res\</code>
<code class="linenos"> 85 </code><code class="s">earch in com 00ADpu 00ADta 00ADtional logic, textbooks in theoretical computer scien\</code>
<code class="linenos"> 86 </code><code class="s">ce, and writings on computing, higher education, and technology. He is Gordon McKay \</code>
<code class="linenos"> 87 </code><code class="s">Professor of Computer Science at Harvard University, and was Dean of Harvard College\</code>
<code class="linenos"> 88 </code><code class="s"> from 1995 to 2003. A new professorship in Engineering and Applied Sciences, endowed\</code>
<code class="linenos"> 89 </code><code class="s"> by a former student, will be named for Lewis and his wife upon their retirements."</code><code class="p">)</code><code class="err">\</code>
<code class="linenos"> 90 </code><code class="p">)</code>
<code class="linenos"> 91 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Cascade_Investment"</code><code class="p">)</code>
<code class="linenos"> 92 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos"> 93 </code>   <code class="s">"Cascade Investment, L.L.C. is an American holding company and private investment\</code>
<code class="linenos"> 94 </code><code class="s"> firm headquartered in Kirkland, Washington, United States. It is controlled by Bill\</code>
<code class="linenos"> 95 </code><code class="s"> Gates, and managed by Michael Larson. More than half of Gates' fortune is held in a\</code>
<code class="linenos"> 96 </code><code class="s">ssets outside his holding of Microsoft shares. Cascade is the successor company to D\</code>
<code class="linenos"> 97 </code><code class="s">ominion Income Management, the former investment vehicle for Gates' holdings, which \</code>
<code class="linenos"> 98 </code><code class="s">was managed by convicted felon Andrew Evans."</code><code class="p">))</code>
<code class="linenos"> 99 </code> <code class="p">((</code><code class="ss">:s</code> <code class="s">"http://dbpedia.org/resource/Jerry_Dyer"</code><code class="p">)</code>
<code class="linenos">100 </code>  <code class="p">(</code><code class="ss">:comment</code>
<code class="linenos">101 </code>   <code class="s">"Jerry P. Dyer (born May 3, 1959) is an American politician and former law enforc\</code>
<code class="linenos">102 </code><code class="s">ement officer. He is the 26th and current mayor of Fresno, California. Previously, h\</code>
<code class="linenos">103 </code><code class="s">e served as the chief of the Fresno Police Department."</code><code class="p">)))</code>
<code class="linenos">104 </code><code class="nb">*</code> 
</pre></div>

</figure>

<p>In this last example, using <strong>:message-stream nil</strong> effectively turns off printing generated SPARQL queries used by these APIs. You can use <strong>:message-stream t</strong> to see generated SPARQL.</p>

<p>Every time the KGN common library makes a web service call to DBPedia the query and response are cached in a SQLite database in <strong>~/.kgn_cache.db</strong> which can greatly speed up the program, especially in development mode when testing a set of queries. This caching also takes some load off of the public DBPedia endpoint, which is a polite thing to do.</p>

<h3 id="leanpub-auto-review-of-nlp-utilities-used-in-application">Review of NLP Utilities Used in Application</h3>

<p>Here is a quick review of NLP utilities we saw in an earlier chapter:</p>

<ul>
  <li>kbnlp:make-text-object</li>
  <li>kbnlp::text-human-names</li>
  <li>kbnlp::text-place-name</li>
  <li>entity-uris:find-entities-in-text</li>
  <li>entity-uris:pp-entities</li>
</ul>

<p>The following code snippets show example calls to the relevant NLP functions and the generated output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">KGN</code> <code class="mi">39</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nb">setf</code> <code class="nv">text</code> <code class="s">"Bill Clinton went to Canada"</code><code class="p">)</code>
<code class="s">"Bill Clinton went to Canada"</code>

<code class="nv">KGN</code> <code class="mi">40</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nb">setf</code> <code class="nv">txtobj</code> <code class="p">(</code><code class="nv">kbnlp:make-text-object</code> <code class="nv">text</code><code class="p">))</code>
<code class="l l-Other">#S</code><code class="p">(</code><code class="nv">TEXT</code> <code class="ss">:URL</code> <code class="s">""</code> <code class="ss">:TITLE</code> <code class="s">""</code> <code class="ss">:SUMMARY</code> <code class="s">"&lt;no summary&gt;"</code> <code class="ss">:CATEGORY-TAGS</code> <code class="p">((</code><code class="s">"computers_micros\</code>
<code class="s">oft.txt"</code> <code class="mf">0.00641</code><code class="p">)</code> <code class="p">(</code><code class="s">"religion_islam.txt"</code> <code class="mf">0.00357</code><code class="p">))</code> <code class="ss">:KEY-WORDS</code> <code class="no">NIL</code> <code class="ss">:KEY-PHRASES</code> <code class="no">NIL</code> <code class="ss">:H</code><code class="err">\</code>
<code class="nv">UMAN-NAMES</code> <code class="p">(</code><code class="s">"Bill Clinton"</code><code class="p">)</code> <code class="ss">:PLACE-NAMES</code> <code class="p">(</code><code class="s">"Canada"</code><code class="p">)</code> <code class="ss">:COMPANY-NAMES</code> <code class="no">NIL</code> <code class="ss">:TEXT</code> <code class="o">#(</code><code class="s">"Bill\</code>
<code class="s">"</code> <code class="s">"Clinton"</code> <code class="s">"went"</code> <code class="s">"to"</code> <code class="s">"Canada"</code><code class="p">)</code> <code class="ss">:TAGS</code> <code class="o">#(</code><code class="s">"NNP"</code> <code class="s">"NNP"</code> <code class="s">"VBD"</code> <code class="s">"TO"</code> <code class="s">"NNP"</code><code class="p">))</code>

<code class="nv">KGN</code> <code class="mi">41</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nv">kbnlp::text-human-names</code> <code class="nv">txtobj</code><code class="p">)</code>
<code class="p">(</code><code class="s">"Bill Clinton"</code><code class="p">)</code>

<code class="nv">KGN</code> <code class="mi">42</code> <code class="nb">&gt;</code> 
<code class="p">(</code><code class="nb">loop</code> <code class="nv">for</code> <code class="nv">key</code> <code class="nv">being</code> <code class="k">the</code> <code class="nv">hash-keys</code> <code class="nv">of</code>  <code class="p">(</code><code class="nv">entity-uris:find-entities-in-text</code> <code class="nv">text</code><code class="p">)</code>
  <code class="nv">using</code> <code class="p">(</code><code class="nv">hash-value</code> <code class="nv">value</code><code class="p">)</code>
  <code class="nb">do</code> <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"key: ~S value: ~S~%"</code> <code class="nv">key</code> <code class="nv">value</code><code class="p">))</code>
<code class="nv">key:</code> <code class="s">"people"</code> <code class="nv">value:</code> <code class="p">((</code><code class="s">"Bill Clinton"</code> <code class="s">"&lt;http://dbpedia.org/resource/Bill_Clinton&gt;"</code><code class="p">))</code>
<code class="nv">key:</code> <code class="s">"countries"</code> <code class="nv">value:</code> <code class="p">((</code><code class="s">"Canada"</code> <code class="s">"&lt;http://dbpedia.org/resource/Canada&gt;"</code><code class="p">))</code>
<code class="no">NIL</code>
</pre></div>

</figure>

<p>The code using <strong>loop</strong> at the end of the last repl listing that prints keys and values of a hash table is from the <a href="http://cl-cookbook.sourceforge.net/hashes.html">Common Lisp Cookbook web site</a> in the section “Traversing a Hash Table.”</p>

<h3 id="leanpub-auto-developing-low-level-sparql-utilities">Developing Low-Level SPARQL Utilities</h3>

<p>I use the standard command line <strong>curl</strong> utility program with the Common Lisp package <strong>uiop</strong> to make HTML GET requests to the DBPedia public Knowledge Graph and the package <strong>drakma</strong> to url-encode parts of a query. The source code is in a separate Quicklisp library located in <strong>src/sparql-cache/sparql.lisp</strong>. A non-caching library is also available in <strong>src/sparql/sparql.lisp</strong>.</p>

<p>In the following listing of <strong>src/sparql-cache/sparql.lisp</strong>, lines 8, 24, 39, and 55 I use some caching code that we will look at later. The nested <strong>replace-all</strong> statements in lines 12-13 are a kluge to remove Unicode characters that occasionally caused runtime errors in the KGN application.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"cl-json"</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"drakma"</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">sparql-dbpedia</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">(</code><code class="nv">ret</code>
<code class="linenos"> 8 </code>         <code class="p">(</code><code class="nv">cr</code> <code class="p">(</code><code class="nv">fetch-result-dbpedia</code> <code class="nv">query</code><code class="p">))</code>
<code class="linenos"> 9 </code>         <code class="p">(</code><code class="nv">response</code>
<code class="linenos">10 </code>          <code class="p">(</code><code class="nb">or</code>
<code class="linenos">11 </code>           <code class="nv">cr</code>
<code class="linenos">12 </code>           <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">13 </code>            <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">14 </code>             <code class="p">(</code><code class="nv">uiop:run-program</code> 
<code class="linenos">15 </code>              <code class="p">(</code><code class="nb">list</code>
<code class="linenos">16 </code>               <code class="s">"curl"</code> 
<code class="linenos">17 </code>               <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code>
<code class="linenos">18 </code>                            <code class="s">"https://dbpedia.org/sparql?query="</code>
<code class="linenos">19 </code>                            <code class="p">(</code><code class="nv">drakma:url-encode</code> <code class="nv">query</code> <code class="ss">:utf-8</code><code class="p">)</code>
<code class="linenos">20 </code>                            <code class="s">"&amp;format=json"</code><code class="p">))</code>
<code class="linenos">21 </code>              <code class="ss">:output</code> <code class="ss">:string</code><code class="p">)</code>
<code class="linenos">22 </code>             <code class="s">"\\u2013"</code> <code class="s">" "</code><code class="p">)</code>
<code class="linenos">23 </code>            <code class="s">"\\u"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">24 </code>    <code class="p">(</code><code class="nv">save-query-result-dbpedia</code> <code class="nv">query</code> <code class="nv">response</code><code class="p">)</code>
<code class="linenos">25 </code>    <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos">26 </code>      <code class="p">(</code><code class="nb">with-input-from-string</code>
<code class="linenos">27 </code>          <code class="p">(</code><code class="nv">s</code> <code class="nv">response</code><code class="p">)</code>
<code class="linenos">28 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">json-as-list</code> <code class="p">(</code><code class="nv">json:decode-json</code> <code class="nv">s</code><code class="p">)))</code>
<code class="linenos">29 </code>          <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">30 </code>           <code class="nv">ret</code>
<code class="linenos">31 </code>           <code class="p">(</code><code class="nb">mapcar</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">32 </code>                       <code class="c1">;;(pprint x)</code>
<code class="linenos">33 </code>                       <code class="p">(</code><code class="nb">mapcar</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">y</code><code class="p">)</code>
<code class="linenos">34 </code>                                   <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">y</code><code class="p">)</code> <code class="p">(</code><code class="nb">cdr</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:value</code> <code class="p">(</code><code class="nb">cdr</code> <code class="nv">y</code><code class="p">)))))</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">35 </code>                   <code class="p">(</code><code class="nb">cdr</code> <code class="p">(</code><code class="nb">cadddr</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">json-as-list</code><code class="p">))))))))</code>
<code class="linenos">36 </code>    <code class="nv">ret</code><code class="p">))</code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">sparql-ask-dbpedia</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos">39 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">cr</code> <code class="p">(</code><code class="nv">fetch-result-dbpedia</code> <code class="nv">query</code><code class="p">))</code>
<code class="linenos">40 </code>         <code class="p">(</code><code class="nv">response</code>
<code class="linenos">41 </code>          <code class="p">(</code><code class="nb">or</code>
<code class="linenos">42 </code>           <code class="nv">cr</code>
<code class="linenos">43 </code>           <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">44 </code>            <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos">45 </code>             <code class="p">(</code><code class="nv">uiop:run-program</code> 
<code class="linenos">46 </code>              <code class="p">(</code><code class="nb">list</code>
<code class="linenos">47 </code>               <code class="s">"curl"</code> 
<code class="linenos">48 </code>               <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code>
<code class="linenos">49 </code>                            <code class="s">"https://dbpedia.org/sparql?query="</code>
<code class="linenos">50 </code>                            <code class="p">(</code><code class="nv">drakma:url-encode</code> <code class="nv">query</code> <code class="ss">:utf-8</code><code class="p">)</code>
<code class="linenos">51 </code>                            <code class="s">"&amp;format=json"</code><code class="p">))</code>
<code class="linenos">52 </code>              <code class="ss">:output</code> <code class="ss">:string</code><code class="p">)</code>
<code class="linenos">53 </code>             <code class="s">"\\u2013"</code> <code class="s">" "</code><code class="p">)</code>
<code class="linenos">54 </code>            <code class="s">"\\u"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">55 </code>    <code class="p">(</code><code class="nv">save-query-result-dbpedia</code> <code class="nv">query</code> <code class="nv">response</code><code class="p">)</code>
<code class="linenos">56 </code>    <code class="p">(</code><code class="k">if</code>  <code class="p">(</code><code class="nb">search</code> <code class="s">"true"</code> <code class="nv">response</code><code class="p">)</code>
<code class="linenos">57 </code>        <code class="no">t</code>
<code class="linenos">58 </code>      <code class="no">nil</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The code for replacing Unicode characters is messy but prevents problems later when we are using the query results in the example application.</p>

<p>The code <strong>(json-as-list (json:decode-json s))</strong> on line 28 converts a deeply nested JSON response to nested Common Lisp lists. You may want to print out the list to  better understand the <strong>mapcar</strong> expression on lines 31-35. There is no magic to writing expressions like this, in a repl I set <strong>json-as-list</strong> to the results of one query, and I spent a minute or two experimenting with the nested <strong>mapcar</strong> expression to get it to work with my test case.</p>

<p>The implementation for <strong>sparql-ask-dbpedia</strong> in lines 38-58 is simpler because we don’t have to fully parse the returned SPARQL query results. A SPARQL <strong>ask</strong> type query returns a true/false answer to a query. We will use this to determine the types of entities in query text. While our NLP library identifies entity types, making additional <strong>ask</strong> queries to DBPedia to verify entity types will provide better automated results.</p>

<h3 id="leanpub-auto-implementing-the-caching-layer">Implementing the Caching Layer</h3>

<p>While developing KGN and also using it as an end user, many SPARQL queries to DBPedia contain repeated entity names so it makes sense to write a caching layer.  We use a SQLite database “~/.kgn_cache.db” to store queries and responses.</p>

<p>The caching layer is implemented in the file <strong>src/sparql-cache/sparql.lisp</strong> and some of the relevant code is listed here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;; SqList caching for SPARQL queries:</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*db-path*</code> <code class="p">(</code><code class="nb">pathname</code> <code class="s">"~/.kgn_cache.db"</code><code class="p">))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">create-dbpedia</code> <code class="p">()</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="nv">sqlite:with-open-database</code> <code class="p">(</code><code class="nv">d</code> <code class="vg">*db-path*</code><code class="p">)</code>
<code class="linenos"> 7 </code>    <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 8 </code>      <code class="p">(</code><code class="nv">sqlite:execute-single</code> <code class="nv">d</code>
<code class="linenos"> 9 </code>        <code class="s">"CREATE TABLE dbpedia (query string  PRIMARY KEY ASC, result string)"</code><code class="p">))))</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">save-query-result-dbpedia</code> <code class="p">(</code><code class="nv">query</code> <code class="nv">result</code><code class="p">)</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nv">sqlite:with-open-database</code> <code class="p">(</code><code class="nv">d</code> <code class="vg">*db-path*</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos">14 </code>      <code class="p">(</code><code class="nv">sqlite:execute-to-list</code> <code class="nv">d</code>
<code class="linenos">15 </code>                       <code class="s">"insert into dbpedia (query, result) values (?, ?)"</code>
<code class="linenos">16 </code>                       <code class="nv">query</code> <code class="nv">result</code><code class="p">))))</code>
<code class="linenos">17 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">fetch-result-dbpedia</code> <code class="p">(</code><code class="nv">query</code><code class="p">)</code>
<code class="linenos">18 </code>  <code class="p">(</code><code class="nv">sqlite:with-open-database</code> <code class="p">(</code><code class="nv">d</code> <code class="vg">*db-path*</code><code class="p">)</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nb">cadar</code>
<code class="linenos">20 </code>     <code class="p">(</code><code class="nv">sqlite:execute-to-list</code> <code class="nv">d</code>
<code class="linenos">21 </code>                      <code class="s">"select * from dbpedia where query = ?"</code> <code class="nv">query</code><code class="p">))))</code>
</pre></div>

</figure>

<p>This caching layer greatly speeds up my own personal use of KGN. Without caching, queries that contain many entity references simply take too long to run. The UI for the KGN applications in later chapters have a menu option for clearing the local cache but I almost never use this option because growing a large cache that is tailored for the types of information I search for makes the entire system much more responsive.</p>

<h3 id="leanpub-auto-utilities-in-the-main-library-file-kgn-commonlisp">Utilities in the Main Library File kgn-common.lisp</h3>

<p>The utilities in the file <strong>src/kgn-common/kgn-common.lisp</strong> can be seen in this complete code listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn-common</code><code class="p">)</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">pprint-results</code> <code class="p">(</code><code class="nv">results</code> <code class="k">&amp;key</code> <code class="p">(</code><code class="nc">stream</code> <code class="no">t</code><code class="p">))</code>
<code class="linenos">  4 </code>  <code class="p">(</code><code class="nb">pprint</code> <code class="nv">results</code> <code class="nc">stream</code><code class="p">))</code>
<code class="linenos">  5 </code>
<code class="linenos">  6 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">colorize-sparql-local</code> <code class="p">(</code><code class="nv">s</code>  <code class="k">&amp;key</code> <code class="p">(</code><code class="nc">stream</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos">  7 </code>  <code class="s">"placeholder - some applications, like the kgn-capi-ui example need to</code>
<code class="linenos">  8 </code><code class="s">   colorize the sparql output"</code>
<code class="linenos">  9 </code>  <code class="p">(</code><code class="nb">princ</code> <code class="nv">s</code> <code class="nc">stream</code><code class="p">))</code>
<code class="linenos"> 10 </code>
<code class="linenos"> 11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">check-uri</code> <code class="p">(</code><code class="nv">uri</code><code class="p">)</code>
<code class="linenos"> 12 </code>  <code class="s">"sloppy code fix: URIs have different forms - normalize these"</code>
<code class="linenos"> 13 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">type-of</code> <code class="nv">uri</code><code class="p">)</code> <code class="ss">'cons</code><code class="p">)</code> <code class="p">(</code><code class="nb">setf</code> <code class="nv">uri</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">uri</code><code class="p">)))</code>
<code class="linenos"> 14 </code>  <code class="p">(</code><code class="nv">entity-uris:ensure-uri-brackets</code> <code class="nv">uri</code><code class="p">))</code>
<code class="linenos"> 15 </code>
<code class="linenos"> 16 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">clean-comment</code> <code class="p">(</code><code class="nv">comment-string</code><code class="p">)</code>
<code class="linenos"> 17 </code>  <code class="s">"When getting comment strings from DBPedia, there are parts</code>
<code class="linenos"> 18 </code><code class="s">   that I remove for display"</code>
<code class="linenos"> 19 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">i1</code> <code class="p">(</code><code class="nb">search</code> <code class="s">"("</code> <code class="nv">comment-string</code><code class="p">))</code>
<code class="linenos"> 20 </code>        <code class="p">(</code><code class="nv">i2</code> <code class="p">(</code><code class="nb">search</code> <code class="s">")"</code> <code class="nv">comment-string</code><code class="p">)))</code>
<code class="linenos"> 21 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code> <code class="nv">i1</code> <code class="nv">i2</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="nv">i2</code> <code class="nv">i1</code><code class="p">)</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="nv">i1</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos"> 22 </code>        <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">comment-string</code> <code class="mi">0</code> <code class="p">(</code><code class="nb">-</code> <code class="nv">i1</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos"> 23 </code>                             <code class="p">(</code><code class="nb">subseq</code> <code class="nv">comment-string</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">i2</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos"> 24 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">j1</code> <code class="p">(</code><code class="nb">search</code> <code class="s">" / "</code> <code class="nv">comment-string</code><code class="p">)))</code>
<code class="linenos"> 25 </code>          <code class="p">(</code><code class="k">if</code> <code class="nv">j1</code>
<code class="linenos"> 26 </code>              <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">j2</code> <code class="p">(</code><code class="nb">search</code> <code class="s">"/"</code> <code class="nv">comment-string</code> <code class="ss">:start2</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">j1</code> <code class="mi">2</code><code class="p">))))</code>
<code class="linenos"> 27 </code>                <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code> <code class="nv">j1</code> <code class="nv">j2</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="nv">j2</code> <code class="nv">j1</code><code class="p">)</code> <code class="p">(</code><code class="nb">&lt;</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">j2</code> <code class="mi">1</code><code class="p">)</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">comment-string</code><code class="p">)))</code>
<code class="linenos"> 28 </code>                    <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">comment-string</code> <code class="mi">0</code> <code class="nv">j1</code><code class="p">)</code>
<code class="linenos"> 29 </code>                                         <code class="p">(</code><code class="nb">subseq</code> <code class="nv">comment-string</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">j2</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos"> 30 </code>                    <code class="nv">comment-string</code><code class="p">))</code>
<code class="linenos"> 31 </code>              <code class="nv">comment-string</code><code class="p">)</code>
<code class="linenos"> 32 </code>          <code class="nv">comment-string</code><code class="p">))))</code>
<code class="linenos"> 33 </code>
<code class="linenos"> 34 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">clean-results</code> <code class="p">(</code><code class="nv">results</code><code class="p">)</code>
<code class="linenos"> 35 </code>  <code class="s">"This function is replaced when we later build GUI apps"</code>
<code class="linenos"> 36 </code>  <code class="nv">results</code><code class="p">)</code>
<code class="linenos"> 37 </code>
<code class="linenos"> 38 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-name-and-description-for-uri</code> <code class="p">(</code><code class="nv">uri</code><code class="p">)</code>
<code class="linenos"> 39 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">sparql</code>
<code class="linenos"> 40 </code>           <code class="p">(</code><code class="nv">replace-all</code>
<code class="linenos"> 41 </code>            <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos"> 42 </code>  <code class="s">"select distinct ?name ?comment { @@ ~</code>
<code class="linenos"> 43 </code><code class="s">    values ?nameProperty {&lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</code>
<code class="linenos"> 44 </code><code class="s">                          &lt;http://xmlns.com/foaf/0.1/name&gt; } . @@ ~</code>
<code class="linenos"> 45 </code><code class="s">    ~A ?nameProperty ?name . @@ ~</code>
<code class="linenos"> 46 </code><code class="s">    ~A &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment  .</code>
<code class="linenos"> 47 </code><code class="s">         FILTER  (lang(?comment) = 'en') . @@ ~</code>
<code class="linenos"> 48 </code><code class="s">   } LIMIT 1"</code> <code class="nv">uri</code> <code class="nv">uri</code><code class="p">)</code>
<code class="linenos"> 49 </code>             <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))</code>
<code class="linenos"> 50 </code>          <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code> <code class="nv">sparql</code><code class="p">)))</code>
<code class="linenos"> 51 </code>    <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">second</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:name</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">results</code><code class="p">)))</code>
<code class="linenos"> 52 </code>          <code class="p">(</code><code class="nb">second</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:comment</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">results</code><code class="p">))))))</code>
<code class="linenos"> 53 </code>
<code class="linenos"> 54 </code><code class="c1">;; (kgn-common::get-name-and-description-for-uri</code>
<code class="linenos"> 55 </code><code class="c1">;;   "&lt;http://dbpedia.org/resource/Apple_Inc.&gt;")</code>
<code class="linenos"> 56 </code>
<code class="linenos"> 57 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">ask-is-type-of</code> <code class="p">(</code><code class="nv">entity-uri</code> <code class="nv">type-value-uri</code><code class="p">)</code> <code class="c1">;; both URIs expected to use surro\</code>
<code class="linenos"> 58 </code><code class="nv">unding</code> <code class="nb">&lt;</code> <code class="nb">&gt;</code> <code class="nv">brackets</code> <code class="nv">for</code> <code class="nv">SPARQL</code>
<code class="linenos"> 59 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">sparql</code>
<code class="linenos"> 60 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos"> 61 </code>              <code class="s">"ASK { ~A &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; ~A }"</code>
<code class="linenos"> 62 </code>              <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">entity-uri</code><code class="p">)</code> <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">type-value-uri</code><code class="p">)))</code>
<code class="linenos"> 63 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:ask-dbpedia</code> <code class="nv">sparql</code><code class="p">)))</code>
<code class="linenos"> 64 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">sparql</code><code class="p">)</code>
<code class="linenos"> 65 </code>    <code class="nv">results</code><code class="p">))</code>
<code class="linenos"> 66 </code>
<code class="linenos"> 67 </code><code class="c1">;; (kgn-common::ask-is-type-of</code>
<code class="linenos"> 68 </code><code class="c1">;;   "&lt;http://dbpedia.org/resource/Apple_Inc.&gt;"</code>
<code class="linenos"> 69 </code><code class="c1">;;   "&lt;http://dbpedia.org/ontology/Company&gt;")</code>
<code class="linenos"> 70 </code>
<code class="linenos"> 71 </code>
<code class="linenos"> 72 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-entities-by-name</code> <code class="p">(</code><code class="nv">name</code> <code class="nv">dbpedia-type</code> <code class="nv">schema-org-type</code>
<code class="linenos"> 73 </code>          <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos"> 74 </code>               <code class="p">(</code><code class="nv">colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql-local</code><code class="p">))</code>
<code class="linenos"> 75 </code>  <code class="c1">;; http://www.w3.org/1999/02/22-rdf-syntax-ns#type &lt;http://schema.org/Person&gt;</code>
<code class="linenos"> 76 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">sparql</code>
<code class="linenos"> 77 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos"> 78 </code><code class="s">"select distinct ?s ?comment { </code>
<code class="linenos"> 79 </code><code class="s">   ?s ?p \"~A\"@en . @@ ~</code>
<code class="linenos"> 80 </code><code class="s">   ?s &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment  . FILTER  (lang(?com\</code>
<code class="linenos"> 81 </code><code class="s">ment) = 'en') . @@ ~</code>
<code class="linenos"> 82 </code><code class="s">   ?s &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; ~A . @@ ~</code>
<code class="linenos"> 83 </code><code class="s">} LIMIT 15"</code> <code class="nv">name</code> <code class="nv">dbpedia-type</code><code class="p">))</code>
<code class="linenos"> 84 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code> <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">sparql</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos"> 85 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">results</code><code class="p">)</code>
<code class="linenos"> 86 </code>    <code class="p">(</code><code class="nb">terpri</code> <code class="nv">message-stream</code><code class="p">)</code>
<code class="linenos"> 87 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code>
<code class="linenos"> 88 </code>      <code class="s">"Trying to get entity by name = ~A using SPARQL with type:"</code>
<code class="linenos"> 89 </code>      <code class="nv">name</code> <code class="nv">dbpedia-type</code><code class="p">)</code>
<code class="linenos"> 90 </code>    <code class="p">(</code><code class="nb">terpri</code> <code class="nv">message-stream</code><code class="p">)</code>
<code class="linenos"> 91 </code>    <code class="p">(</code><code class="nb">apply</code> <code class="nv">colorize-sparql-function</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">sparql</code> <code class="ss">:stream</code> <code class="nv">message-stream</code><code class="p">))</code>
<code class="linenos"> 92 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">results</code><code class="p">)</code>
<code class="linenos"> 93 </code>        <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">sparql2</code>
<code class="linenos"> 94 </code>                 <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos"> 95 </code><code class="s">"select distinct ?s ?comment {</code>
<code class="linenos"> 96 </code><code class="s">    ?s ?p \"~A\"@en . @@ ~</code>
<code class="linenos"> 97 </code><code class="s">    ?s &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment  . FILTER  (lang(?co\</code>
<code class="linenos"> 98 </code><code class="s">mment) = 'en') . @@ ~</code>
<code class="linenos"> 99 </code><code class="s">    ?s &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; ~A . @@ ~</code>
<code class="linenos">100 </code><code class="s">} LIMIT 15"</code> <code class="nv">name</code> <code class="nv">schema-org-type</code><code class="p">)))</code>
<code class="linenos">101 </code>          <code class="p">(</code><code class="nb">format</code>
<code class="linenos">102 </code>           <code class="no">t</code>
<code class="linenos">103 </code>           <code class="s">"No results for ~A for last SPARQL query using type ~A so trying type ~A"</code><code class="err">\</code>
<code class="linenos">104 </code> <code class="nv">name</code> <code class="nv">dbpedia-type</code> <code class="nv">schema-org-type</code><code class="p">)</code>
<code class="linenos">105 </code>          <code class="p">(</code><code class="nb">terpri</code> <code class="nv">message-stream</code><code class="p">)</code>
<code class="linenos">106 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code> <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">sparql2</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">)))</code>
<code class="linenos">107 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">results</code><code class="p">)</code>
<code class="linenos">108 </code>              <code class="p">(</code><code class="nb">format</code>
<code class="linenos">109 </code>               <code class="no">t</code>
<code class="linenos">110 </code>               <code class="s">"No results for ~A for last SPARQL query using type ~A"</code>
<code class="linenos">111 </code>               <code class="nv">name</code> <code class="nv">schema-org-type</code><code class="p">)</code>
<code class="linenos">112 </code>              <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">filtered</code> <code class="p">(</code><code class="nb">remove-if</code>
<code class="linenos">113 </code>                                <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">114 </code>                                    <code class="p">(</code><code class="nb">or</code>
<code class="linenos">115 </code>                                     <code class="p">(</code><code class="nb">search</code> <code class="s">","</code> <code class="p">(</code><code class="nb">cadar</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">116 </code>                                     <code class="p">(</code><code class="nb">and</code>
<code class="linenos">117 </code>                                      <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">first</code> <code class="nv">x</code><code class="p">)</code> <code class="ss">:comment</code><code class="p">))</code>
<code class="linenos">118 </code>                                      <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">search</code> <code class="s">"/resource/"</code> <code class="p">(</code><code class="nb">cadar</code> <code class="nv">x</code><code class="p">))))))</code>
<code class="linenos">119 </code>                                <code class="nv">results</code><code class="p">))</code>
<code class="linenos">120 </code>                     <code class="p">(</code><code class="nv">uris</code> <code class="p">(</code><code class="nb">remove-duplicates</code>
<code class="linenos">121 </code>                            <code class="p">(</code><code class="nb">map</code>
<code class="linenos">122 </code>                              <code class="ss">'list</code>
<code class="linenos">123 </code>                              <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">124 </code>                                <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"&lt;"</code> <code class="p">(</code><code class="nb">cadar</code> <code class="nv">x</code><code class="p">)</code> <code class="s">"&gt;"</code><code class="p">)</code> <code class="p">(</code><code class="nv">cadad</code><code class="err">\</code>
<code class="linenos">125 </code><code class="nv">r</code> <code class="nv">x</code><code class="p">)))</code>
<code class="linenos">126 </code>                                 <code class="nv">filtered</code><code class="p">)</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">)))</code>
<code class="linenos">127 </code>                <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~%~%********** dbpedia-get-entities-by-name: uris:~%"</code><code class="p">)</code>
<code class="linenos">128 </code>                <code class="p">(</code><code class="nb">pprint</code> <code class="nv">uris</code><code class="p">)</code> <code class="p">(</code><code class="nb">terpri</code><code class="p">)</code>
<code class="linenos">129 </code>                <code class="nv">uris</code><code class="p">))))</code>
<code class="linenos">130 </code>    <code class="nv">results</code><code class="p">))</code>
<code class="linenos">131 </code>
<code class="linenos">132 </code><code class="c1">;; (kgn-common:dbpedia-get-entities-by-name</code>
<code class="linenos">133 </code><code class="c1">;;    "Bill Gates" "&lt;http://dbpedia.org/ontology/Person&gt;"</code>
<code class="linenos">134 </code><code class="c1">;;    "&lt;http://schema.org/Person&gt;" :message-stream nil)</code>
<code class="linenos">135 </code><code class="c1">;; in above, pass t for message-stream to see generated SPARQL queries</code>
<code class="linenos">136 </code>
<code class="linenos">137 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-person-detail</code> <code class="p">(</code><code class="nv">person-uri-raw</code>
<code class="linenos">138 </code>    <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">139 </code>         <code class="p">(</code><code class="nv">colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql-local</code><code class="p">))</code>
<code class="linenos">140 </code>  <code class="c1">;; http://dbpedia.org/ontology/birthPlace </code>
<code class="linenos">141 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">person-uri</code> <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">person-uri-raw</code><code class="p">))</code>
<code class="linenos">142 </code>         <code class="p">(</code><code class="nv">query</code>
<code class="linenos">143 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos">144 </code>      <code class="s">"SELECT DISTINCT ?label ?comment@@ ~</code>
<code class="linenos">145 </code><code class="s">        (GROUP_CONCAT (DISTINCT ?birthplace; SEPARATOR=' | ') AS ?birthplace) @@ ~</code>
<code class="linenos">146 </code><code class="s">        (GROUP_CONCAT (DISTINCT ?almamater; SEPARATOR=' | ') AS ?almamater) @@ ~</code>
<code class="linenos">147 </code><code class="s">        (GROUP_CONCAT (DISTINCT ?spouse; SEPARATOR=' | ') AS ?spouse) { @@ ~</code>
<code class="linenos">148 </code><code class="s">         ~A &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .@@</code>
<code class="linenos">149 </code><code class="s">              FILTER  (lang(?comment) = 'en') . @@ ~</code>
<code class="linenos">150 </code><code class="s">        OPTIONAL { ~A &lt;http://dbpedia.org/ontology/birthPlace&gt; ?birthplace } . @@ ~</code>
<code class="linenos">151 </code><code class="s">        OPTIONAL { ~A &lt;http://dbpedia.org/ontology/almaMater&gt; ?almamater } . @@ ~</code>
<code class="linenos">152 </code><code class="s">        OPTIONAL { ~A &lt;http://dbpedia.org/ontology/spouse&gt; ?spouse } . @@ ~</code>
<code class="linenos">153 </code><code class="s">        OPTIONAL { ~A  &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label .@@ ~</code>
<code class="linenos">154 </code><code class="s">                FILTER  (lang(?label) = 'en') } @@ ~</code>
<code class="linenos">155 </code><code class="s">      } LIMIT 10@@"</code> <code class="nv">person-uri</code> <code class="nv">person-uri</code> <code class="nv">person-uri</code> <code class="nv">person-uri</code> <code class="nv">person-uri</code><code class="p">))</code>
<code class="linenos">156 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code>  <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">query</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">157 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%SPARQL to get PERSON data for ~A:~%~%"</code> <code class="nv">person-uri</code><code class="p">)</code>
<code class="linenos">158 </code>    <code class="p">(</code><code class="nb">apply</code> <code class="nv">colorize-sparql-function</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">query</code> <code class="ss">:stream</code> <code class="nv">message-stream</code><code class="p">))</code>
<code class="linenos">159 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%"</code><code class="p">)</code>
<code class="linenos">160 </code>    <code class="c1">;;results))</code>
<code class="linenos">161 </code>    <code class="p">(</code><code class="nv">clean-results</code> <code class="nv">results</code><code class="p">)))</code>
<code class="linenos">162 </code>
<code class="linenos">163 </code><code class="c1">;; (kgn-common:dbpedia-get-person-detail "&lt;http://dbpedia.org/resource/Bill_Gates&gt;")</code>
<code class="linenos">164 </code>
<code class="linenos">165 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-company-detail</code> <code class="p">(</code><code class="nv">company-uri-raw</code>
<code class="linenos">166 </code>     <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">167 </code>          <code class="p">(</code><code class="nv">colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql-local</code><code class="p">))</code>
<code class="linenos">168 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">company-uri</code> <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">company-uri-raw</code><code class="p">))</code>
<code class="linenos">169 </code>         <code class="p">(</code><code class="nv">query</code>
<code class="linenos">170 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos">171 </code><code class="s">"SELECT DISTINCT ?label ?comment (GROUP_CONCAT (DISTINCT ?industry; SEPARATOR=' | ')\</code>
<code class="linenos">172 </code><code class="s"> AS ?industry)@@ ~</code>
<code class="linenos">173 </code><code class="s">  (GROUP_CONCAT (DISTINCT ?netIncome; SEPARATOR=' | ') AS ?netIncome)@@ ~</code>
<code class="linenos">174 </code><code class="s">  (GROUP_CONCAT (DISTINCT ?numberOfEmployees; SEPARATOR=' | ') AS ?numberOfEmployees\</code>
<code class="linenos">175 </code><code class="s">) {@@ ~</code>
<code class="linenos">176 </code><code class="s">  ~A &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .@@</code>
<code class="linenos">177 </code><code class="s">          FILTER  (lang(?comment) = 'en') .@@ ~</code>
<code class="linenos">178 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/industry&gt; ?industry } .@@  ~</code>
<code class="linenos">179 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/netIncome&gt; ?netIncome } .@@  ~</code>
<code class="linenos">180 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/numberOfEmployees&gt; ?numberOfEmployees }\</code>
<code class="linenos">181 </code><code class="s"> .@@  ~</code>
<code class="linenos">182 </code><code class="s">  OPTIONAL { ~A &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label . FILTER (lang(?\</code>
<code class="linenos">183 </code><code class="s">label) = 'en') } @@ ~</code>
<code class="linenos">184 </code><code class="s">} LIMIT 30@@"</code>
<code class="linenos">185 </code>           <code class="nv">company-uri</code> <code class="nv">company-uri</code> <code class="nv">company-uri</code> <code class="nv">company-uri</code> <code class="nv">company-uri</code><code class="p">))</code>
<code class="linenos">186 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code>  <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">query</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">187 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%SPARQL to get COMPANY data for ~A:~%~%"</code> <code class="nv">company-uri</code><code class="p">)</code>
<code class="linenos">188 </code>    <code class="p">(</code><code class="nb">apply</code> <code class="nv">colorize-sparql-function</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">query</code> <code class="ss">:stream</code> <code class="nv">message-stream</code><code class="p">))</code>
<code class="linenos">189 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%"</code><code class="p">)</code>
<code class="linenos">190 </code>    <code class="p">(</code><code class="nv">clean-results</code> <code class="nv">results</code><code class="p">)))</code>
<code class="linenos">191 </code>
<code class="linenos">192 </code><code class="c1">;; (kgn-common:dbpedia-get-company-detail "&lt;http://dbpedia.org/resource/Microsoft&gt;")</code>
<code class="linenos">193 </code>
<code class="linenos">194 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-country-detail</code> <code class="p">(</code><code class="nv">country-uri-raw</code>
<code class="linenos">195 </code>    <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">196 </code>         <code class="p">(</code><code class="nv">colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql-local</code><code class="p">))</code>
<code class="linenos">197 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">country-uri</code> <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">country-uri-raw</code><code class="p">))</code>
<code class="linenos">198 </code>         <code class="p">(</code><code class="nv">query</code>
<code class="linenos">199 </code>           <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code>
<code class="linenos">200 </code><code class="s">"SELECT DISTINCT ?label ?comment (GROUP_CONCAT (DISTINCT ?areaTotal; SEPARATOR=' | '\</code>
<code class="linenos">201 </code><code class="s">) AS ?areaTotal)@@ ~</code>
<code class="linenos">202 </code><code class="s">  (GROUP_CONCAT (DISTINCT ?populationDensity; SEPARATOR=' | ') AS ?populationDensity\</code>
<code class="linenos">203 </code><code class="s">) {@@ ~</code>
<code class="linenos">204 </code><code class="s">  ~A &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .@@</code>
<code class="linenos">205 </code><code class="s">      FILTER  (lang(?comment) = 'en') .@@ ~</code>
<code class="linenos">206 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/areaTotal&gt; ?areaTotal } .@@  ~</code>
<code class="linenos">207 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/populationDensity&gt; ?populationDensity }\</code>
<code class="linenos">208 </code><code class="s"> .@@  ~</code>
<code class="linenos">209 </code><code class="s">  OPTIONAL { ~A &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label . }@@ ~</code>
<code class="linenos">210 </code><code class="s">} LIMIT 30@@"</code>
<code class="linenos">211 </code>                   <code class="nv">country-uri</code> <code class="nv">country-uri</code> <code class="nv">country-uri</code> <code class="nv">country-uri</code> <code class="nv">country-uri</code><code class="p">))</code>
<code class="linenos">212 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code>  <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">query</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">213 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%SPARQL to get COUNTRY data for ~A:~%~%"</code> <code class="nv">country-uri</code><code class="p">)</code>
<code class="linenos">214 </code>    <code class="p">(</code><code class="nb">apply</code> <code class="nv">colorize-sparql-function</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">query</code> <code class="ss">:stream</code> <code class="nv">message-stream</code><code class="p">))</code>
<code class="linenos">215 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%"</code><code class="p">)</code>
<code class="linenos">216 </code>    <code class="p">(</code><code class="nv">clean-results</code> <code class="nv">results</code><code class="p">)))</code>
<code class="linenos">217 </code>
<code class="linenos">218 </code><code class="c1">;; (kgn-common:dbpedia-get-country-detail "&lt;http://dbpedia.org/resource/Canada&gt;")</code>
<code class="linenos">219 </code>
<code class="linenos">220 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-city-detail</code> <code class="p">(</code><code class="nv">city-uri-raw</code>
<code class="linenos">221 </code>    <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">222 </code>         <code class="p">(</code><code class="nv">colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql-local</code><code class="p">))</code>
<code class="linenos">223 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">city-uri</code> <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">city-uri-raw</code><code class="p">))</code>
<code class="linenos">224 </code>         <code class="p">(</code><code class="nv">query</code>
<code class="linenos">225 </code>           <code class="p">(</code><code class="nb">format</code>
<code class="linenos">226 </code>            <code class="no">nil</code>
<code class="linenos">227 </code><code class="s">"SELECT DISTINCT ?label ?comment @@ ~</code>
<code class="linenos">228 </code><code class="s">  (GROUP_CONCAT (DISTINCT ?latitude_longitude; SEPARATOR=' | ')  AS ?latitude_longit\</code>
<code class="linenos">229 </code><code class="s">ude) @@ ~</code>
<code class="linenos">230 </code><code class="s">  (GROUP_CONCAT (DISTINCT ?populationDensity; SEPARATOR=' | ') AS ?populationDensity\</code>
<code class="linenos">231 </code><code class="s">) @@ ~</code>
<code class="linenos">232 </code><code class="s">  (GROUP_CONCAT (DISTINCT ?country; SEPARATOR=' | ') AS ?country) { @@ ~</code>
<code class="linenos">233 </code><code class="s">  ~A &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment . FILTER  (lang(?comme\</code>
<code class="linenos">234 </code><code class="s">nt) = 'en') . @@ ~</code>
<code class="linenos">235 </code><code class="s">  OPTIONAL { ~A &lt;http://www.w3.org/2003/01/geo/wgs84_pos#geometry&gt; ?latitude_longitu\</code>
<code class="linenos">236 </code><code class="s">de } . @@ ~</code>
<code class="linenos">237 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/PopulatedPlace/populationDensity&gt; ?popu\</code>
<code class="linenos">238 </code><code class="s">lationDensity } . @@ ~</code>
<code class="linenos">239 </code><code class="s">  OPTIONAL { ~A &lt;http://dbpedia.org/ontology/country&gt; ?country } .@@ ~</code>
<code class="linenos">240 </code><code class="s">  OPTIONAL { ~A &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label . } @@ ~</code>
<code class="linenos">241 </code><code class="s">} LIMIT 30@@"</code>
<code class="linenos">242 </code>            <code class="nv">city-uri</code> <code class="nv">city-uri</code> <code class="nv">city-uri</code> <code class="nv">city-uri</code> <code class="nv">city-uri</code><code class="p">))</code>
<code class="linenos">243 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code> <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">query</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">244 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%SPARQL to get CITY data for ~A:~%~%"</code> <code class="nv">city-uri</code><code class="p">)</code>
<code class="linenos">245 </code>    <code class="p">(</code><code class="nb">apply</code> <code class="nv">colorize-sparql-function</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">query</code> <code class="ss">:stream</code> <code class="nv">message-stream</code><code class="p">))</code>
<code class="linenos">246 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%"</code><code class="p">)</code>
<code class="linenos">247 </code>    <code class="p">(</code><code class="nv">clean-results</code> <code class="nv">results</code><code class="p">)))</code>
<code class="linenos">248 </code>
<code class="linenos">249 </code><code class="c1">;; (kgn-common:dbpedia-get-city-detail "&lt;http://dbpedia.org/resource/London&gt;")</code>
<code class="linenos">250 </code>
<code class="linenos">251 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-product-detail</code> <code class="p">(</code><code class="nv">product-uri-raw</code>
<code class="linenos">252 </code>     <code class="k">&amp;key</code> <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">253 </code>          <code class="p">(</code><code class="nv">colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql-local</code><code class="p">))</code>
<code class="linenos">254 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">product-uri</code> <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">product-uri-raw</code><code class="p">))</code>
<code class="linenos">255 </code>         <code class="p">(</code><code class="nv">query</code>
<code class="linenos">256 </code>           <code class="p">(</code><code class="nb">format</code>
<code class="linenos">257 </code>            <code class="no">nil</code>
<code class="linenos">258 </code><code class="s">"SELECT DISTINCT ?label ?comment {  @@ ~</code>
<code class="linenos">259 </code><code class="s">  ~A &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment . FILTER  (lang(?comme\</code>
<code class="linenos">260 </code><code class="s">nt) = 'en') . @@ ~</code>
<code class="linenos">261 </code><code class="s">  OPTIONAL { ~A &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label . } ~</code>
<code class="linenos">262 </code><code class="s">} LIMIT 30@@"</code>
<code class="linenos">263 </code>            <code class="nv">product-uri</code> <code class="nv">product-uri</code><code class="p">))</code>
<code class="linenos">264 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code> <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">query</code> <code class="s">"@@"</code> <code class="s">" "</code><code class="p">))))</code>
<code class="linenos">265 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%SPARQL to get PRODUCT data for ~A:~%~%"</code> <code class="nv">product-uri</code><code class="p">)</code>
<code class="linenos">266 </code>    <code class="p">(</code><code class="nb">apply</code> <code class="nv">colorize-sparql-function</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">query</code> <code class="ss">:stream</code> <code class="nv">message-stream</code><code class="p">))</code>
<code class="linenos">267 </code>    <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"~%"</code><code class="p">)</code>
<code class="linenos">268 </code>    <code class="p">(</code><code class="nv">clean-results</code> <code class="nv">results</code><code class="p">)))</code>
<code class="linenos">269 </code>
<code class="linenos">270 </code><code class="c1">;; (kgn-common:dbpedia-get-product-detail "&lt;http://dbpedia.org/resource/Pepsi&gt;")</code>
<code class="linenos">271 </code>
<code class="linenos">272 </code>
<code class="linenos">273 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">dbpedia-get-relationships</code> <code class="p">(</code><code class="nv">s-uri</code> <code class="nv">o-uri</code><code class="p">)</code> <code class="c1">;;  &amp;key (message-stream t))</code>
<code class="linenos">274 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">query</code>
<code class="linenos">275 </code>           <code class="p">(</code><code class="nb">format</code>
<code class="linenos">276 </code>            <code class="no">nil</code>
<code class="linenos">277 </code><code class="s">"SELECT DISTINCT ?p { ~A ?p ~A . FILTER (!regex(str(?p), 'wikiPage', 'i'))} LIMIT 5"</code>
<code class="linenos">278 </code>            <code class="p">(</code><code class="nv">check-uri</code> <code class="nv">s-uri</code><code class="p">)</code> <code class="p">(</code><code class="nv">check-uri</code>  <code class="nv">o-uri</code><code class="p">)))</code>
<code class="linenos">279 </code>         <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">sparql-cache:dbpedia</code> <code class="nv">query</code><code class="p">)))</code>
<code class="linenos">280 </code>    <code class="p">(</code><code class="nv">alexandria:flatten</code> <code class="p">(</code><code class="nb">map</code> <code class="ss">'list</code>
<code class="linenos">281 </code>                             <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">282 </code>                                 <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~{&lt;~A&gt;~}"</code> <code class="p">(</code><code class="nb">cdar</code> <code class="nv">x</code><code class="p">)))</code>
<code class="linenos">283 </code>                             <code class="nv">results</code><code class="p">))))</code>
<code class="linenos">284 </code>
<code class="linenos">285 </code><code class="c1">;; (kgn-common::dbpedia-get-relationships</code>
<code class="linenos">286 </code><code class="c1">;;   "&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code>
<code class="linenos">287 </code><code class="c1">;;   "&lt;http://dbpedia.org/resource/Microsoft&gt;")</code>
<code class="linenos">288 </code>
<code class="linenos">289 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">entities</code> <code class="p">(</code><code class="nv">text</code><code class="p">)</code>
<code class="linenos">290 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">txt-obj</code> <code class="p">(</code><code class="nv">kbnlp:make-text-object</code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">291 </code>    <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nv">kbnlp::text-human-names</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nv">kbnlp::text-place-names</code> <code class="nv">txt-obj</code><code class="p">)</code> <code class="p">(</code><code class="nv">kbnlp</code><code class="err">\</code>
<code class="linenos">292 </code><code class="ss">::text-company-names</code> <code class="nv">txt-obj</code><code class="p">))))</code>
<code class="linenos">293 </code>
<code class="linenos">294 </code><code class="c1">;; (kgn-common::entities "Bill Clinton went to Canada")</code>
<code class="linenos">295 </code>
<code class="linenos">296 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">entities-dbpedia</code> <code class="p">(</code><code class="nv">text</code><code class="p">)</code>
<code class="linenos">297 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">e-hash</code> <code class="p">(</code><code class="nv">entity-uris:find-entities-in-text</code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">298 </code>    <code class="p">(</code><code class="nb">list</code>
<code class="linenos">299 </code>      <code class="p">(</code><code class="nb">gethash</code> <code class="s">"people"</code> <code class="nv">e-hash</code><code class="p">)</code>
<code class="linenos">300 </code>      <code class="p">(</code><code class="nb">gethash</code> <code class="s">"companies"</code> <code class="nv">e-hash</code><code class="p">)</code>
<code class="linenos">301 </code>      <code class="p">(</code><code class="nb">gethash</code> <code class="s">"countries"</code> <code class="nv">e-hash</code><code class="p">)</code>
<code class="linenos">302 </code>      <code class="p">(</code><code class="nb">gethash</code> <code class="s">"cities"</code> <code class="nv">e-hash</code><code class="p">))))</code>
<code class="linenos">303 </code>
<code class="linenos">304 </code><code class="c1">;; (kgn-common::entities-dbpedia "Bill Clinton went to Canada")</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrap-up-2">Wrap-up</h3>

<p>This is a long example application for a book, split between this chapter and the next two chapters offering different user interface implementations.</p>

<p>I got the idea for the KGN application because I was spending quite a bit of time manually setting up SPARQL queries for DBPedia (and other public sources like WikiData) and I wanted to experiment with partially automating this process. Now in the next two chapters we will write user interfaces for this KGN common library.</p>


<h2 id="kgntext">Knowledge Graph Navigator Text-Based User Interface</h2>

<p>We developed the The Knowledge Graph Navigator (which I will often refer to as KGN) common library in the last chapter. Here we write a simple console or text-based user interface for the library. In later chapters we implement UIs using LispWorks CAPI, McCLIM, and Franz Common Graphics.</p>

<p>This Quicklisp library can be found in a separate GitHub repository <a href="https://github.com/mark-watson/kgn-text-ui">https://github.com/mark-watson/kgn-text-ui</a> and contains the files:</p>

<ul>
  <li>kgn-text-ui.asd - specifies dependencies, including the KGN common library</li>
  <li>kgn-text-ui.lisp - Contains the complete user interface</li>
  <li>package.lisp - specifies dependencies, including the KGN common library</li>
</ul>

<p>We start by looking at sample output using the text user interface and then look at the implementation.</p>

<h3 id="leanpub-auto-example-output-1">Example Output</h3>

<p>We will look at a very simple example query <strong>Bill Gates worked at Microsoft and his competitor was IBM</strong> that only contains a few entities. In practice, I usually use queries with five to ten entities to get more discovered relationships. I remove a lot of the generated output in the following listing for brevity, especially the many generated SPARQL queries that the code generates and uses (comments on the output appear after this listing):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="n">$</code> <code class="n">sbcl</code>
<code class="linenos">  2 </code><code class="o">*</code><code class="p">(</code><code class="nl">ql</code><code class="p">:</code><code class="nl">quickload</code> <code class="p">:</code><code class="n">kgn</code><code class="o">-</code><code class="n">text</code><code class="o">-</code><code class="n">ui</code><code class="p">)</code>
<code class="linenos">  3 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s">"kgn-common"</code>
<code class="linenos">  4 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s">"sqlite"</code>
<code class="linenos">  5 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s">"cl-json"</code>
<code class="linenos">  6 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s">"drakma"</code>
<code class="linenos">  7 </code>
<code class="linenos">  8 </code><code class="o">*</code> <code class="p">(</code><code class="n">kgn</code><code class="o">-</code><code class="n">text</code><code class="o">-</code><code class="nl">ui</code><code class="p">:</code><code class="n">kgn</code><code class="o">-</code><code class="n">text</code><code class="o">-</code><code class="n">ui</code><code class="p">)</code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code><code class="s">"Enter entity names (people, places, companies, etc."</code><code class="o">:</code>
<code class="linenos"> 11 </code><code class="n">Bill</code> <code class="n">Gates</code> <code class="n">worked</code> <code class="n">at</code> <code class="n">Microsoft</code> <code class="n">and</code> <code class="n">his</code> <code class="n">competitor</code> <code class="n">was</code> <code class="n">IBM</code>
<code class="linenos"> 12 </code>
<code class="linenos"> 13 </code><code class="o">-</code> <code class="o">-</code> <code class="o">-</code> <code class="o">-</code> <code class="n">Enter</code> <code class="n">zero</code> <code class="n">or</code> <code class="n">more</code> <code class="n">indices</code> <code class="k">for</code> <code class="n">your</code> <code class="n">desired</code> <code class="nl">selections</code><code class="p">:</code>
<code class="linenos"> 14 </code>
<code class="linenos"> 15 </code><code class="mi">0</code>  <code class="o">-</code>   <code class="s">"William Henry Gates III (born October 28, 1955) is an American business magn\</code>
<code class="linenos"> 16 </code><code class="s">ate, software developer, investor, author, and philanthropist. He is a co-founder of\</code>
<code class="linenos"> 17 </code><code class="s"> Microsoft, along with his late childhood friend Paul Allen. During his career at Mi\</code>
<code class="linenos"> 18 </code><code class="s">crosoft, Gates held the positions of chairman, chief executive officer (CEO), presid\</code>
<code class="linenos"> 19 </code><code class="s">ent and chief software architect, while also being the largest individual shareholde\</code>
<code class="linenos"> 20 </code><code class="s">r until May 2014. He is considered one of the best known entrepreneurs of the microc\</code>
<code class="linenos"> 21 </code><code class="s">omputer revolution of the 1970s and 1980s."</code> 
<code class="linenos"> 22 </code>
<code class="linenos"> 23 </code><code class="mi">1</code>  <code class="o">-</code>   <code class="s">"Harry Roy Lewis (born 1947) is an American computer scientist, mathe 00ADma \</code>
<code class="linenos"> 24 </code><code class="s">00ADti 00ADcian, and uni 00ADver 00ADsity admin 00ADi 00ADstra 00ADtor known for his\</code>
<code class="linenos"> 25 </code><code class="s"> research in com 00ADpu 00ADta 00ADtional logic, textbooks in theoretical computer s\</code>
<code class="linenos"> 26 </code><code class="s">cience, and writings on computing, higher education, and technology. He is Gordon Mc\</code>
<code class="linenos"> 27 </code><code class="s">Kay Professor of Computer Science at Harvard University, and was Dean of Harvard Col\</code>
<code class="linenos"> 28 </code><code class="s">lege from 1995 to 2003. A new professorship in Engineering and Applied Sciences, end\</code>
<code class="linenos"> 29 </code><code class="s">owed by a former student, will be named for Lewis and his wife upon their retirement\</code>
<code class="linenos"> 30 </code><code class="s">s."</code> 
<code class="linenos"> 31 </code>
<code class="linenos"> 32 </code><code class="mi">2</code>  <code class="o">-</code>   <code class="s">"Cascade Investment, L.L.C. is an American holding company and private invest\</code>
<code class="linenos"> 33 </code><code class="s">ment firm headquartered in Kirkland, Washington, United States. It is controlled by \</code>
<code class="linenos"> 34 </code><code class="s">Bill Gates, and managed by Michael Larson. More than half of Gates' fortune is held \</code>
<code class="linenos"> 35 </code><code class="s">in assets outside his holding of Microsoft shares. Cascade is the successor company \</code>
<code class="linenos"> 36 </code><code class="s">to Dominion Income Management, the former investment vehicle for Gates' holdings, wh\</code>
<code class="linenos"> 37 </code><code class="s">ich was managed by convicted felon Andrew Evans."</code> 
<code class="linenos"> 38 </code>
<code class="linenos"> 39 </code><code class="mi">3</code>  <code class="o">-</code>   <code class="s">"Jerry P. Dyer (born May 3, 1959) is an American politician and former law en\</code>
<code class="linenos"> 40 </code><code class="s">forcement officer. He is the 26th and current mayor of Fresno, California. Previousl\</code>
<code class="linenos"> 41 </code><code class="s">y, he served as the chief of the Fresno Police Department."</code> 
<code class="linenos"> 42 </code>
<code class="linenos"> 43 </code><code class="mi">0</code>
<code class="linenos"> 44 </code>
<code class="linenos"> 45 </code><code class="o">-</code> <code class="o">-</code> <code class="o">-</code> <code class="o">-</code> <code class="n">Enter</code> <code class="n">zero</code> <code class="n">or</code> <code class="n">more</code> <code class="n">indices</code> <code class="k">for</code> <code class="n">your</code> <code class="n">desired</code> <code class="nl">selections</code><code class="p">:</code>
<code class="linenos"> 46 </code>
<code class="linenos"> 47 </code><code class="mi">0</code>  <code class="o">-</code>   <code class="s">"Kenexa, an IBM Company, provides employment and retention services. This inc\</code>
<code class="linenos"> 48 </code><code class="s">ludes recruitment process outsourcing onboarding tools, employee assessment, abiliti\</code>
<code class="linenos"> 49 </code><code class="s">es assessment for employment candidates (Kenexa Prove It); and Kenexa Interview Buil\</code>
<code class="linenos"> 50 </code><code class="s">der, a structured interview archive with example questions."</code> 
<code class="linenos"> 51 </code>
<code class="linenos"> 52 </code><code class="mi">1</code>  <code class="o">-</code>   <code class="s">"Sequent Computer Systems was a computer company that designed and manufactur\</code>
<code class="linenos"> 53 </code><code class="s">ed multiprocessing computer systems. They were among the pioneers in high-performanc\</code>
<code class="linenos"> 54 </code><code class="s">e symmetric multiprocessing (SMP) open systems, innovating in both hardware (e.g., c\</code>
<code class="linenos"> 55 </code><code class="s">ache management and interrupt handling) and software (e.g., read-copy-update). Vesti\</code>
<code class="linenos"> 56 </code><code class="s">ges of Sequent's innovations live on in the form of data clustering software from Po\</code>
<code class="linenos"> 57 </code><code class="s">lyServe (subsequently acquired by HP), various projects within OSDL, IBM contributio\</code>
<code class="linenos"> 58 </code><code class="s">ns to the Linux kernel, and claims in the SCO v. IBM lawsuit."</code> 
<code class="linenos"> 59 </code>
<code class="linenos"> 60 </code><code class="mi">2</code>  <code class="o">-</code>   <code class="s">"i2 Limited was the UK-based arm of software company i2 Group which produced \</code>
<code class="linenos"> 61 </code><code class="s">visual intelligence and investigative analysis software for military intelligence, l\</code>
<code class="linenos"> 62 </code><code class="s">aw enforcement and commercial agencies. After a number of acquisitions, in 2011 it b\</code>
<code class="linenos"> 63 </code><code class="s">ecame part of IBM."</code> 
<code class="linenos"> 64 </code>
<code class="linenos"> 65 </code><code class="mi">3</code>  <code class="o">-</code>   <code class="s">"The International Technology Alliance in Distributed Analytics and Informati\</code>
<code class="linenos"> 66 </code><code class="s">on Sciences (DAIS-ITA) is a research program initiated by the UK Ministry of Defence\</code>
<code class="linenos"> 67 </code><code class="s"> (United Kingdom) (MOD) and the US Army Research Laboratory (ARL), in September 2016\</code>
<code class="linenos"> 68 </code><code class="s">. It is led by IBM Research in the U.S. and IBM Hursley in the UK. DAIS ITA is the s\</code>
<code class="linenos"> 69 </code><code class="s">econd International Technology Alliance started by the two countries, succeeding the\</code>
<code class="linenos"> 70 </code><code class="s"> previous ten year alliance NIS-ITA, which was of similar nature."</code> 
<code class="linenos"> 71 </code>
<code class="linenos"> 72 </code><code class="mi">4</code>  <code class="o">-</code>   <code class="s">"The International Technology Alliance in Network and Information Sciences (N\</code>
<code class="linenos"> 73 </code><code class="s">IS-ITA) was a research program initiated by the UK Ministry of Defence (United Kingd\</code>
<code class="linenos"> 74 </code><code class="s">om) (MoD) and the US Army Research Laboratory (ARL), which was active for 10 years f\</code>
<code class="linenos"> 75 </code><code class="s">rom May 2006 to May 2016. It was led by IBM Research in the U.S. and IBM Hursley in \</code>
<code class="linenos"> 76 </code><code class="s">the UK. NIS ITA was the first International Technology Alliance started by the two c\</code>
<code class="linenos"> 77 </code><code class="s">ountries."</code> 
<code class="linenos"> 78 </code>
<code class="linenos"> 79 </code><code class="mi">5</code>  <code class="o">-</code>   <code class="s">"Applix Inc. was a computer software company founded in 1983 based in Westbor\</code>
<code class="linenos"> 80 </code><code class="s">ough, Massachusetts that published Applix TM1, a multi-dimensional online analytical\</code>
<code class="linenos"> 81 </code><code class="s"> processing (MOLAP) database server, and related presentation tools, including Appli\</code>
<code class="linenos"> 82 </code><code class="s">x Web and Applix Executive Viewer. Together, Applix TM1, Applix Web and Applix Execu\</code>
<code class="linenos"> 83 </code><code class="s">tive Viewer were the three core components of the Applix Business Analytics Platform\</code>
<code class="linenos"> 84 </code><code class="s">. (Executive Viewer was subsequently discontinued by IBM.)"</code> 
<code class="linenos"> 85 </code>
<code class="linenos"> 86 </code><code class="mi">6</code>  <code class="o">-</code>   <code class="s">"Ounce Labs (an IBM company) is a Waltham, Massachusetts-based security softw\</code>
<code class="linenos"> 87 </code><code class="s">are vendor. The company was founded in 2002 and created a software analysis product \</code>
<code class="linenos"> 88 </code><code class="s">that analyzes source code to identify and remove security vulnerabilities. The secur\</code>
<code class="linenos"> 89 </code><code class="s">ity software looks for a range of vulnerabilities that leave an application open to \</code>
<code class="linenos"> 90 </code><code class="s">attack. Customers have included GMAC, Lockheed Martin, and the U.S. Navy. On July 28\</code>
<code class="linenos"> 91 </code><code class="s">, 2009, Ounce was acquired by IBM, for an undisclosed sum, with the intention of int\</code>
<code class="linenos"> 92 </code><code class="s">egrating it into IBM's Rational Software business."</code> 
<code class="linenos"> 93 </code>
<code class="linenos"> 94 </code><code class="mi">7</code>  <code class="o">-</code>   <code class="s">"IBM Watson Health is a digital tool that helps clients facilitate medical re\</code>
<code class="linenos"> 95 </code><code class="s">search, clinical research, and healthcare solutions, through the use of artificial i\</code>
<code class="linenos"> 96 </code><code class="s">ntelligence, data, analytics, cloud computing, and other advanced information techno\</code>
<code class="linenos"> 97 </code><code class="s">logy. It is a division of the International Business Machines Corporation, (IBM), an\</code>
<code class="linenos"> 98 </code><code class="s"> American multinational information technology company headquartered in Armonk, New \</code>
<code class="linenos"> 99 </code><code class="s">York."</code> 
<code class="linenos">100 </code>
<code class="linenos">101 </code><code class="mi">8</code>  <code class="o">-</code>   <code class="s">"International Business Machines Corporation (IBM) is an American multination\</code>
<code class="linenos">102 </code><code class="s">al technology corporation headquartered in Armonk, New York, with operations in over\</code>
<code class="linenos">103 </code><code class="s"> 171 countries. The company began in 1911, founded in Endicott, New York by trust bu\</code>
<code class="linenos">104 </code><code class="s">sinessman Charles Ranlett Flint, as the Computing-Tabulating-Recording Company (CTR)\</code>
<code class="linenos">105 </code><code class="s"> and was renamed </code><code class="se">\"</code><code class="s">International Business Machines</code><code class="se">\"</code><code class="s"> in 1924. IBM is incorporated in\</code>
<code class="linenos">106 </code><code class="s"> New York."</code> 
<code class="linenos">107 </code>
<code class="linenos">108 </code><code class="mi">9</code>  <code class="o">-</code>   <code class="s">"Microsoft Corporation is an American multinational technology corporation wh\</code>
<code class="linenos">109 </code><code class="s">ich produces computer software, consumer electronics, personal computers, and relate\</code>
<code class="linenos">110 </code><code class="s">d services. Its best known software products are the Microsoft Windows line of opera\</code>
<code class="linenos">111 </code><code class="s">ting systems, the Microsoft Office suite, and the Internet Explorer and Edge web bro\</code>
<code class="linenos">112 </code><code class="s">wsers. Its flagship hardware products are the Xbox video game consoles and the Micro\</code>
<code class="linenos">113 </code><code class="s">soft Surface lineup of touchscreen personal computers. Microsoft ranked No. 21 in th\</code>
<code class="linenos">114 </code><code class="s">e 2020 Fortune 500 rankings of the largest United States corporations by total reven\</code>
<code class="linenos">115 </code><code class="s">ue; it was the world's largest software maker by revenue as of 2016. It is considere\</code>
<code class="linenos">116 </code><code class="s">d one of the Big Five companies in the U.S. information technology industry, along w\</code>
<code class="linenos">117 </code><code class="s">ith Amazon, Google (Alphabet), Apple, and Facebook ("</code> 
<code class="linenos">118 </code>
<code class="linenos">119 </code><code class="mi">10</code>  <code class="o">-</code>   <code class="s">"The CSS Working Group (Cascading Style Sheets Working Group) is a working g\</code>
<code class="linenos">120 </code><code class="s">roup created by the World Wide Web Consortium (W3C) in 1997, to tackle issues that h\</code>
<code class="linenos">121 </code><code class="s">ad not been addressed with CSS level 1. As of December 2019, the CSSWG had 142 membe\</code>
<code class="linenos">122 </code><code class="s">rs. The working group is co-chaired by and ."</code> 
<code class="linenos">123 </code>
<code class="linenos">124 </code><code class="mi">11</code>  <code class="o">-</code>   <code class="s">"The AMD Professional Gamers League (PGL), founded around 1997, was one of t\</code>
<code class="linenos">125 </code><code class="s">he first professional computer gaming eSports leagues. The PGL was run by Total Ente\</code>
<code class="linenos">126 </code><code class="s">rtainment Network and was sponsored by AMD. The first professional tournament they h\</code>
<code class="linenos">127 </code><code class="s">eld was for StarCraft in September 1997. The league was official unveiled at a press\</code>
<code class="linenos">128 </code><code class="s"> conference at Candlestick Park in San Francisco on November 3, 1997. It was sponsor\</code>
<code class="linenos">129 </code><code class="s">ed by Microsoft, Nvidia, and Levi Strauss &amp; Co. The organization raised over $1.2mil\</code>
<code class="linenos">130 </code><code class="s"> USD in sponsorship money."</code> 
<code class="linenos">131 </code>
<code class="linenos">132 </code><code class="mi">12</code>  <code class="o">-</code>   <code class="s">"Secure Islands Technologies Ltd. was an Israeli privately held technology c\</code>
<code class="linenos">133 </code><code class="s">ompany headquartered in Beit Dagan which was subsequently acquired by Microsoft. The\</code>
<code class="linenos">134 </code><code class="s"> company develops and markets Information Protection and Control (IPC) solutions."</code> 
<code class="linenos">135 </code>
<code class="linenos">136 </code><code class="mi">13</code>  <code class="o">-</code>   <code class="s">"Microsoft Innovation Centers (MICs) are local government organizations, uni\</code>
<code class="linenos">137 </code><code class="s">versities, industry organizations, or software or hardware vendors who partner with \</code>
<code class="linenos">138 </code><code class="s">Microsoft with a common goal to foster the growth of local software economies. These\</code>
<code class="linenos">139 </code><code class="s"> are state of the art technology facilities which are open to students, developers, \</code>
<code class="linenos">140 </code><code class="s">IT professionals, entrepreneurs, startups and academic researchers. While each Cente\</code>
<code class="linenos">141 </code><code class="s">r tunes its programs to local needs, they all provide similar content and services d\</code>
<code class="linenos">142 </code><code class="s">esigned to accelerate technology advances and stimulate local software economies thr\</code>
<code class="linenos">143 </code><code class="s">ough skills and professional training, industry partnerships and innovation. As of 1\</code>
<code class="linenos">144 </code><code class="s">0 September 2010, there are 115 Microsoft Innovation Centers worldwide, most of whic\</code>
<code class="linenos">145 </code><code class="s">h are open to the public. Recently it was reported th"</code> 
<code class="linenos">146 </code>
<code class="linenos">147 </code><code class="mi">14</code>  <code class="o">-</code>   <code class="s">"Press Play ApS was a Danish video game development studio based in central \</code>
<code class="linenos">148 </code><code class="s">Copenhagen in Denmark. Since 2006, Press Play have released five titles, including t\</code>
<code class="linenos">149 </code><code class="s">he Max &amp; the Magic Marker, Max: The Curse of Brotherhood and Kalimba. On November 10\</code>
<code class="linenos">150 </code><code class="s">, 2016, Flashbulb acquired Press Play and its library of games to republish under th\</code>
<code class="linenos">151 </code><code class="s">e Flashbulb name including Kalimba, Tentacles: Enter the Mind, and Max: The Curse of\</code>
<code class="linenos">152 </code><code class="s"> Brotherhood."</code> 
<code class="linenos">153 </code>
<code class="linenos">154 </code><code class="mi">8</code> <code class="mi">9</code>
<code class="linenos">155 </code>
<code class="linenos">156 </code><code class="o">-</code> <code class="o">-</code> <code class="o">-</code> <code class="n">ENTITY</code> <code class="nl">TYPE</code><code class="p">:</code> <code class="n">people</code> <code class="o">-</code> <code class="o">-</code> <code class="o">-</code>
<code class="linenos">157 </code>
<code class="linenos">158 </code><code class="n">SPARQL</code> <code class="n">to</code> <code class="n">get</code> <code class="n">PERSON</code> <code class="n">data</code> <code class="k">for</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Bill_Gates&gt;:</code>
<code class="linenos">159 </code>
<code class="linenos">160 </code><code class="s">"SELECT DISTINCT ?label ?comment@@ (GROUP_CONCAT (DISTINCT ?birthplace; SEPARATOR=' \</code>
<code class="linenos">161 </code><code class="s">| ') AS ?birthplace) @@ (GROUP_CONCAT (DISTINCT ?almamater; SEPARATOR=' | ') AS ?alm\</code>
<code class="linenos">162 </code><code class="s">amater) @@ (GROUP_CONCAT (DISTINCT ?spouse; SEPARATOR=' | ') AS ?spouse) { @@ &lt;http:\</code>
<code class="linenos">163 </code><code class="s">//dbpedia.org/resource/Bill_Gates&gt; &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?\</code>
<code class="linenos">164 </code><code class="s">comment .@@</code>
<code class="linenos">165 </code>                           <code class="n">FILTER</code>  <code class="p">(</code><code class="n">lang</code><code class="p">(</code><code class="o">?</code><code class="n">comment</code><code class="p">)</code> <code class="o">=</code> <code class="err">'</code><code class="n">en</code><code class="err">'</code><code class="p">)</code> <code class="p">.</code> <code class="p">@@</code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//d\</code>
<code class="linenos">166 </code><code class="c1">bpedia.org/resource/Bill_Gates&gt; &lt;http://dbpedia.org/ontology/birthPlace&gt; ?birthplace\</code>
<code class="linenos">167 </code><code class="c1"> } . @@ OPTIONAL { &lt;http://dbpedia.org/resource/Bill_Gates&gt; &lt;http://dbpedia.org/onto\</code>
<code class="linenos">168 </code><code class="c1">logy/almaMater&gt; ?almamater } . @@ OPTIONAL { &lt;http://dbpedia.org/resource/Bill_Gates\</code>
<code class="linenos">169 </code><code class="c1">&gt; &lt;http://dbpedia.org/ontology/spouse&gt; ?spouse } . @@ OPTIONAL { &lt;http://dbpedia.org\</code>
<code class="linenos">170 </code><code class="c1">/resource/Bill_Gates&gt;  &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label .@@ FILTE\</code>
<code class="linenos">171 </code><code class="c1">R  (lang(?label) = 'en') } @@ } LIMIT 10@@"</code>
<code class="linenos">172 </code>
<code class="linenos">173 </code>
<code class="linenos">174 </code><code class="nl">label</code><code class="p">:</code> <code class="n">Bill</code> <code class="n">Gates</code>
<code class="linenos">175 </code>
<code class="linenos">176 </code><code class="nl">comment</code><code class="p">:</code> <code class="n">William</code> <code class="n">Henry</code> <code class="n">Gates</code> <code class="n">III</code> <code class="p">(</code><code class="n">born</code> <code class="n">October</code> <code class="mi">28</code><code class="p">,</code> <code class="mi">1955</code><code class="p">)</code> <code class="n">is</code> <code class="n">an</code> <code class="n">American</code> <code class="n">business</code> <code class="n">mag</code>\
<code class="linenos">177 </code><code class="n">nate</code><code class="p">,</code> <code class="n">software</code> <code class="n">developer</code><code class="p">,</code> <code class="n">investor</code><code class="p">,</code> <code class="n">author</code><code class="p">,</code> <code class="n">and</code> <code class="n">philanthropist</code><code class="p">.</code> <code class="n">He</code> <code class="n">is</code> <code class="n">a</code> <code class="n">co</code><code class="o">-</code><code class="n">founder</code> <code class="n">o</code>\
<code class="linenos">178 </code><code class="n">f</code> <code class="n">Microsoft</code><code class="p">,</code> <code class="n">along</code> <code class="n">with</code> <code class="n">his</code> <code class="n">late</code> <code class="n">childhood</code> <code class="n">friend</code> <code class="n">Paul</code> <code class="n">Allen</code><code class="p">.</code> <code class="n">During</code> <code class="n">his</code> <code class="n">career</code> <code class="n">at</code> <code class="n">M</code>\
<code class="linenos">179 </code><code class="n">icrosoft</code><code class="p">,</code> <code class="n">Gates</code> <code class="n">held</code> <code class="n">the</code> <code class="n">positions</code> <code class="n">of</code> <code class="n">chairman</code><code class="p">,</code> <code class="n">chief</code> <code class="n">executive</code> <code class="n">officer</code> <code class="p">(</code><code class="n">CEO</code><code class="p">),</code> <code class="n">presi</code>\
<code class="linenos">180 </code><code class="n">dent</code> <code class="n">and</code> <code class="n">chief</code> <code class="n">software</code> <code class="n">architect</code><code class="p">,</code> <code class="k">while</code> <code class="n">also</code> <code class="n">being</code> <code class="n">the</code> <code class="n">largest</code> <code class="n">individual</code> <code class="n">sharehold</code>\
<code class="linenos">181 </code><code class="n">er</code> <code class="n">until</code> <code class="n">May</code> <code class="mf">2014.</code> <code class="n">He</code> <code class="n">is</code> <code class="n">considered</code> <code class="n">one</code> <code class="n">of</code> <code class="n">the</code> <code class="n">best</code> <code class="n">known</code> <code class="n">entrepreneurs</code> <code class="n">of</code> <code class="n">the</code> <code class="n">micro</code>\
<code class="linenos">182 </code><code class="n">computer</code> <code class="n">revolution</code> <code class="n">of</code> <code class="n">the</code> <code class="mi">1970</code><code class="n">s</code> <code class="n">and</code> <code class="mi">1980</code><code class="n">s</code><code class="p">.</code>
<code class="linenos">183 </code>
<code class="linenos">184 </code><code class="nl">birthplace</code><code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle | http://dbpedia.org/resource/Washin\</code>
<code class="linenos">185 </code><code class="c1">gton_(state)</code>
<code class="linenos">186 </code>
<code class="linenos">187 </code><code class="nl">almamater</code><code class="p">:</code> 
<code class="linenos">188 </code>
<code class="linenos">189 </code><code class="nl">spouse</code><code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Melinda_French_Gates</code>
<code class="linenos">190 </code>
<code class="linenos">191 </code><code class="o">-</code> <code class="o">-</code> <code class="o">-</code> <code class="n">ENTITY</code> <code class="nl">TYPE</code><code class="p">:</code> <code class="n">companies</code> <code class="o">-</code> <code class="o">-</code> <code class="o">-</code>
<code class="linenos">192 </code>
<code class="linenos">193 </code><code class="n">SPARQL</code> <code class="n">to</code> <code class="n">get</code> <code class="n">COMPANY</code> <code class="n">data</code> <code class="k">for</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/IBM&gt;:</code>
<code class="linenos">194 </code>
<code class="linenos">195 </code>
<code class="linenos">196 </code><code class="s">"SELECT DISTINCT ?label ?comment (GROUP_CONCAT (DISTINCT ?industry; SEPARATOR=' | ')\</code>
<code class="linenos">197 </code><code class="s"> AS ?industry)@@ (GROUP_CONCAT (DISTINCT ?netIncome; SEPARATOR=' | ') AS ?netIncome)\</code>
<code class="linenos">198 </code><code class="s">@@ (GROUP_CONCAT (DISTINCT ?numberOfEmployees; SEPARATOR=' | ') AS ?numberOfEmployee\</code>
<code class="linenos">199 </code><code class="s">s) {@@ &lt;http://dbpedia.org/resource/IBM&gt; &lt;http://www.w3.org/2000/01/rdf-schema#comme\</code>
<code class="linenos">200 </code><code class="s">nt&gt;  ?comment .@@</code>
<code class="linenos">201 </code>                           <code class="n">FILTER</code>  <code class="p">(</code><code class="n">lang</code><code class="p">(</code><code class="o">?</code><code class="n">comment</code><code class="p">)</code> <code class="o">=</code> <code class="err">'</code><code class="n">en</code><code class="err">'</code><code class="p">)</code> <code class="p">.@@</code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//db\</code>
<code class="linenos">202 </code><code class="c1">pedia.org/resource/IBM&gt; &lt;http://dbpedia.org/ontology/industry&gt; ?industry } .@@  OPTI\</code>
<code class="linenos">203 </code><code class="c1">ONAL { &lt;http://dbpedia.org/resource/IBM&gt; &lt;http://dbpedia.org/ontology/netIncome&gt; ?ne\</code>
<code class="linenos">204 </code><code class="c1">tIncome } .@@  OPTIONAL { &lt;http://dbpedia.org/resource/IBM&gt; &lt;http://dbpedia.org/onto\</code>
<code class="linenos">205 </code><code class="c1">logy/numberOfEmployees&gt; ?numberOfEmployees } .@@  OPTIONAL { &lt;http://dbpedia.org/res\</code>
<code class="linenos">206 </code><code class="c1">ource/IBM&gt; &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label . FILTER (lang(?label\</code>
<code class="linenos">207 </code><code class="c1">) = 'en') } @@ } LIMIT 30@@"</code>
<code class="linenos">208 </code>
<code class="linenos">209 </code>
<code class="linenos">210 </code><code class="nl">label</code><code class="p">:</code> <code class="n">IBM</code>
<code class="linenos">211 </code>
<code class="linenos">212 </code><code class="nl">comment</code><code class="p">:</code> <code class="n">International</code> <code class="n">Business</code> <code class="n">Machines</code> <code class="n">Corporation</code> <code class="p">(</code><code class="n">IBM</code><code class="p">)</code> <code class="n">is</code> <code class="n">an</code> <code class="n">American</code> <code class="n">multinatio</code>\
<code class="linenos">213 </code><code class="n">nal</code> <code class="n">technology</code> <code class="n">corporation</code> <code class="n">headquartered</code> <code class="k">in</code> <code class="n">Armonk</code><code class="p">,</code> <code class="n">New</code> <code class="n">York</code><code class="p">,</code> <code class="n">with</code> <code class="n">operations</code> <code class="k">in</code> <code class="n">ove</code>\
<code class="linenos">214 </code><code class="n">r</code> <code class="mi">171</code> <code class="n">countries</code><code class="p">.</code> <code class="n">The</code> <code class="n">company</code> <code class="n">began</code> <code class="k">in</code> <code class="mi">1911</code><code class="p">,</code> <code class="n">founded</code> <code class="k">in</code> <code class="n">Endicott</code><code class="p">,</code> <code class="n">New</code> <code class="n">York</code> <code class="n">by</code> <code class="n">trust</code> <code class="n">b</code>\
<code class="linenos">215 </code><code class="n">usinessman</code> <code class="n">Charles</code> <code class="n">Ranlett</code> <code class="n">Flint</code><code class="p">,</code> <code class="n">as</code> <code class="n">the</code> <code class="n">Computing</code><code class="o">-</code><code class="n">Tabulating</code><code class="o">-</code><code class="n">Recording</code> <code class="n">Company</code> <code class="p">(</code><code class="n">CTR</code>\
<code class="linenos">216 </code><code class="p">)</code> <code class="n">and</code> <code class="n">was</code> <code class="n">renamed</code> <code class="s">"International Business Machines"</code> <code class="k">in</code> <code class="mf">1924.</code> <code class="n">IBM</code> <code class="n">is</code> <code class="n">incorporated</code> <code class="k">in</code> \
<code class="linenos">217 </code><code class="n">New</code> <code class="n">York</code><code class="p">.</code>
<code class="linenos">218 </code>
<code class="linenos">219 </code><code class="nl">industry</code><code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Artificial_intelligence | http://dbpedia.org/r\</code>
<code class="linenos">220 </code><code class="c1">esource/Automation | http://dbpedia.org/resource/Blockchain | http://dbpedia.org/res\</code>
<code class="linenos">221 </code><code class="c1">ource/Cloud_computing | http://dbpedia.org/resource/Computer_hardware | http://dbped\</code>
<code class="linenos">222 </code><code class="c1">ia.org/resource/Quantum_computing | http://dbpedia.org/resource/Robotics | http://db\</code>
<code class="linenos">223 </code><code class="c1">pedia.org/resource/Software</code>
<code class="linenos">224 </code>
<code class="linenos">225 </code><code class="n">net</code><code class="o">-</code><code class="nl">income</code><code class="p">:</code> <code class="mf">5.59E9</code>
<code class="linenos">226 </code>
<code class="linenos">227 </code><code class="n">number</code><code class="o">-</code><code class="n">of</code><code class="o">-</code><code class="nl">employees</code><code class="p">:</code> <code class="mi">345900</code>
<code class="linenos">228 </code>
<code class="linenos">229 </code><code class="n">SPARQL</code> <code class="n">to</code> <code class="n">get</code> <code class="n">COMPANY</code> <code class="n">data</code> <code class="k">for</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Microsoft&gt;:</code>
<code class="linenos">230 </code>
<code class="linenos">231 </code>
<code class="linenos">232 </code><code class="s">"SELECT DISTINCT ?label ?comment (GROUP_CONCAT (DISTINCT ?industry; SEPARATOR=' | ')\</code>
<code class="linenos">233 </code><code class="s"> AS ?industry)@@ (GROUP_CONCAT (DISTINCT ?netIncome; SEPARATOR=' | ') AS ?netIncome)\</code>
<code class="linenos">234 </code><code class="s">@@ (GROUP_CONCAT (DISTINCT ?numberOfEmployees; SEPARATOR=' | ') AS ?numberOfEmployee\</code>
<code class="linenos">235 </code><code class="s">s) {@@ &lt;http://dbpedia.org/resource/Microsoft&gt; &lt;http://www.w3.org/2000/01/rdf-schema\</code>
<code class="linenos">236 </code><code class="s">#comment&gt;  ?comment .@@</code>
<code class="linenos">237 </code>                           <code class="n">FILTER</code>  <code class="p">(</code><code class="n">lang</code><code class="p">(</code><code class="o">?</code><code class="n">comment</code><code class="p">)</code> <code class="o">=</code> <code class="err">'</code><code class="n">en</code><code class="err">'</code><code class="p">)</code> <code class="p">.@@</code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//db\</code>
<code class="linenos">238 </code><code class="c1">pedia.org/resource/Microsoft&gt; &lt;http://dbpedia.org/ontology/industry&gt; ?industry } .@@\</code>
<code class="linenos">239 </code><code class="c1">  OPTIONAL { &lt;http://dbpedia.org/resource/Microsoft&gt; &lt;http://dbpedia.org/ontology/ne\</code>
<code class="linenos">240 </code><code class="c1">tIncome&gt; ?netIncome } .@@  OPTIONAL { &lt;http://dbpedia.org/resource/Microsoft&gt; &lt;http:\</code>
<code class="linenos">241 </code><code class="c1">//dbpedia.org/ontology/numberOfEmployees&gt; ?numberOfEmployees } .@@  OPTIONAL { &lt;http\</code>
<code class="linenos">242 </code><code class="c1">://dbpedia.org/resource/Microsoft&gt; &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?lab\</code>
<code class="linenos">243 </code><code class="c1">el . FILTER (lang(?label) = 'en') } @@ } LIMIT 30@@"</code>
<code class="linenos">244 </code>
<code class="linenos">245 </code>
<code class="linenos">246 </code><code class="nl">label</code><code class="p">:</code> <code class="n">Microsoft</code>
<code class="linenos">247 </code>
<code class="linenos">248 </code><code class="nl">comment</code><code class="p">:</code> <code class="n">Microsoft</code> <code class="n">Corporation</code> <code class="n">is</code> <code class="n">an</code> <code class="n">American</code> <code class="n">multinational</code> <code class="n">technology</code> <code class="n">corporation</code> <code class="n">w</code>\
<code class="linenos">249 </code><code class="n">hich</code> <code class="n">produces</code> <code class="n">computer</code> <code class="n">software</code><code class="p">,</code> <code class="n">consumer</code> <code class="n">electronics</code><code class="p">,</code> <code class="n">personal</code> <code class="n">computers</code><code class="p">,</code> <code class="n">and</code> <code class="n">relat</code>\
<code class="linenos">250 </code><code class="n">ed</code> <code class="n">services</code><code class="p">.</code> <code class="n">Its</code> <code class="n">best</code> <code class="n">known</code> <code class="n">software</code> <code class="n">products</code> <code class="n">are</code> <code class="n">the</code> <code class="n">Microsoft</code> <code class="n">Windows</code> <code class="n">line</code> <code class="n">of</code> <code class="n">oper</code>\
<code class="linenos">251 </code><code class="n">ating</code> <code class="n">systems</code><code class="p">,</code> <code class="n">the</code> <code class="n">Microsoft</code> <code class="n">Office</code> <code class="n">suite</code><code class="p">,</code> <code class="n">and</code> <code class="n">the</code> <code class="n">Internet</code> <code class="n">Explorer</code> <code class="n">and</code> <code class="n">Edge</code> <code class="n">web</code> <code class="n">br</code>\
<code class="linenos">252 </code><code class="n">owsers</code><code class="p">.</code> <code class="n">Its</code> <code class="n">flagship</code> <code class="n">hardware</code> <code class="n">products</code> <code class="n">are</code> <code class="n">the</code> <code class="n">Xbox</code> <code class="n">video</code> <code class="n">game</code> <code class="n">consoles</code> <code class="n">and</code> <code class="n">the</code> <code class="n">Micr</code>\
<code class="linenos">253 </code><code class="n">osoft</code> <code class="n">Surface</code> <code class="n">lineup</code> <code class="n">of</code> <code class="n">touchscreen</code> <code class="n">personal</code> <code class="n">computers</code><code class="p">.</code> <code class="n">Microsoft</code> <code class="n">ranked</code> <code class="n">No</code><code class="p">.</code> <code class="mi">21</code> <code class="k">in</code> <code class="n">t</code>\
<code class="linenos">254 </code><code class="n">he</code> <code class="mi">2020</code> <code class="n">Fortune</code> <code class="mi">500</code> <code class="n">rankings</code> <code class="n">of</code> <code class="n">the</code> <code class="n">largest</code> <code class="n">United</code> <code class="n">States</code> <code class="n">corporations</code> <code class="n">by</code> <code class="n">total</code> <code class="n">reve</code>\
<code class="linenos">255 </code><code class="n">nue</code><code class="p">;</code> <code class="n">it</code> <code class="n">was</code> <code class="n">the</code> <code class="n">world</code><code class="err">'</code><code class="n">s</code> <code class="n">largest</code> <code class="n">software</code> <code class="n">maker</code> <code class="n">by</code> <code class="n">revenue</code> <code class="n">as</code> <code class="n">of</code> <code class="mf">2016.</code> <code class="n">It</code> <code class="n">is</code> <code class="n">consider</code>\
<code class="linenos">256 </code><code class="n">ed</code> <code class="n">one</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Big</code> <code class="n">Five</code> <code class="n">companies</code> <code class="k">in</code> <code class="n">the</code> <code class="n">U</code><code class="p">.</code><code class="n">S</code><code class="p">.</code> <code class="n">information</code> <code class="n">technology</code> <code class="n">industry</code><code class="p">,</code> <code class="n">along</code> \
<code class="linenos">257 </code><code class="n">with</code> <code class="n">Amazon</code><code class="p">,</code> <code class="n">Google</code> <code class="p">(</code><code class="n">Alphabet</code><code class="p">),</code> <code class="n">Apple</code><code class="p">,</code> <code class="n">and</code> <code class="n">Facebook</code> <code class="p">(</code>
<code class="linenos">258 </code>
<code class="linenos">259 </code><code class="nl">industry</code><code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Cloud_computing | http://dbpedia.org/resource/\</code>
<code class="linenos">260 </code><code class="c1">Computer_hardware | http://dbpedia.org/resource/Consumer_electronics | http://dbpedi\</code>
<code class="linenos">261 </code><code class="c1">a.org/resource/Corporate_venture_capital | http://dbpedia.org/resource/Internet | ht\</code>
<code class="linenos">262 </code><code class="c1">tp://dbpedia.org/resource/Social_networking_service | http://dbpedia.org/resource/So\</code>
<code class="linenos">263 </code><code class="c1">ftware_development | http://dbpedia.org/resource/Video_game_industry</code>
<code class="linenos">264 </code>
<code class="linenos">265 </code><code class="n">net</code><code class="o">-</code><code class="nl">income</code><code class="p">:</code> <code class="mf">6.06E10</code>
<code class="linenos">266 </code>
<code class="linenos">267 </code><code class="n">number</code><code class="o">-</code><code class="n">of</code><code class="o">-</code><code class="nl">employees</code><code class="p">:</code> <code class="mi">182268</code>
<code class="linenos">268 </code>
<code class="linenos">269 </code><code class="n">DISCOVERED</code> <code class="n">RELATIONSHIP</code> <code class="nl">LINKS</code><code class="p">:</code>
<code class="linenos">270 </code>
<code class="linenos">271 </code>  <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Bill_Gates&gt;   </code>
<code class="linenos">272 </code>    <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/knownFor&gt;     </code>
<code class="linenos">273 </code>    <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Microsoft&gt; .</code>
<code class="linenos">274 </code>
<code class="linenos">275 </code>
<code class="linenos">276 </code>  <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Microsoft&gt;    </code>
<code class="linenos">277 </code>    <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/foundedBy&gt;    </code>
<code class="linenos">278 </code>    <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Bill_Gates&gt; .</code>
<code class="linenos">279 </code>
<code class="linenos">280 </code>
<code class="linenos">281 </code>  <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Microsoft&gt;    </code>
<code class="linenos">282 </code>    <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/property/founders&gt;     </code>
<code class="linenos">283 </code>    <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Bill_Gates&gt; .</code>
<code class="linenos">284 </code>
<code class="linenos">285 </code><code class="s">"Enter entity names (people, places, companies, etc."</code><code class="o">:</code>
</pre></div>

</figure>

<p>On line 10 I input a test phrase “Bill Gates worked at Microsoft and his competitor was IBM.” In lines 13-41 the test program prints out matching human entities from DBPedia that are indexed starting at 0. On line 43 I entered 0 to choose just the first entity “William Henry Gates III”.</p>

<p>The prompt on line 45 asks the user to enter the indices for the company DBPedia entities they want to use. These companies are listed in lines 47-152. On line 154 I entered “8 9” to select two entities to use.</p>

<p>Lines 156-171 show the automatically generated SPARQL query to get information about Bill Gates. This information is printed on lines 174-189. I list more generated SPARQL queries and results (which we will not discuss further).</p>

<p>Lines 269-283 show discovered links found between the entities in the input text.</p>

<p>In the LispWorks CAPI user interface developed in the next chapter I use two text output stream window panes, one for the generated SPARQL and one for the results.</p>

<h3 id="leanpub-auto-text-user-interface-implementation">Text User Interface Implementation</h3>

<p>We will skip looking at the <strong>kgn-text-ui.asd</strong> and <strong>package.lisp</strong> files for this library but look at <strong>src/kgn-text-ui/kgn-text-ui.lisp</strong> in its entirety. When entities are identified in input text we find candidate DBPedia entity URIs that we present to the user. We precede each entire DBPedia description with an index starting at 0. The user enters the indices for entities to further process. For example, in the example listing in the previous section I entered “8 9” to indicate two company URIs.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn-text-ui</code><code class="p">)</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">pprint-results</code> <code class="p">(</code><code class="nv">results</code><code class="p">)</code>
<code class="linenos">  4 </code>  <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">result</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">results</code><code class="p">))</code>
<code class="linenos">  5 </code>    <code class="p">(</code><code class="nb">terpri</code><code class="p">)</code>
<code class="linenos">  6 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code>  <code class="s">"~A:"</code> <code class="p">(</code><code class="nb">first</code> <code class="nv">result</code><code class="p">))</code>
<code class="linenos">  7 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">" ~A~%"</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">result</code><code class="p">))))</code>
<code class="linenos">  8 </code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">multiple-selections</code> <code class="p">(</code><code class="nv">sel-list</code><code class="p">)</code>
<code class="linenos"> 11 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">null</code> <code class="nv">sel-list</code><code class="p">))</code>
<code class="linenos"> 12 </code>      <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos"> 13 </code>        <code class="p">(</code><code class="nb">pprint</code> <code class="nv">sel-list</code><code class="p">)</code>
<code class="linenos"> 14 </code>        <code class="p">(</code><code class="nb">format</code> <code class="no">t</code>
<code class="linenos"> 15 </code>         <code class="s">"~%- - - - Enter zero or more indices for your desired selections:~%~%"</code><code class="p">)</code>
<code class="linenos"> 16 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nb">count</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos"> 17 </code>          <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">sel</code> <code class="nv">sel-list</code><code class="p">)</code>
<code class="linenos"> 18 </code>            <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~A  -   ~S ~%~%"</code> <code class="nb">count</code> <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:comment</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">sel</code><code class="p">))))</code>
<code class="linenos"> 19 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="nb">count</code> <code class="p">(</code><code class="nb">1+</code> <code class="nb">count</code><code class="p">))))</code>
<code class="linenos"> 20 </code>        <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">line</code> <code class="p">(</code><code class="nb">read-line</code><code class="p">))</code>
<code class="linenos"> 21 </code>               <code class="p">(</code><code class="nv">indices</code>
<code class="linenos"> 22 </code>                <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">line</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 23 </code>                    <code class="p">(</code><code class="nb">mapcar</code>
<code class="linenos"> 24 </code>                     <code class="nf">#'</code><code class="nb">parse-integer</code>
<code class="linenos"> 25 </code>                     <code class="p">(</code><code class="nv">myutils:tokenize-string</code> <code class="nv">line</code><code class="p">)))))</code>
<code class="linenos"> 26 </code>          <code class="p">(</code><code class="nb">print</code> <code class="nv">indices</code><code class="p">)</code>
<code class="linenos"> 27 </code>    <code class="c1">;(dolist (index indices)</code>
<code class="linenos"> 28 </code>    <code class="c1">;  (setf ret (cons (nth index str-list)</code>
<code class="linenos"> 29 </code>          <code class="nv">indices</code><code class="p">))))</code>
<code class="linenos"> 30 </code>
<code class="linenos"> 31 </code><code class="c1">;; (kgn-text-ui::multiple-selections</code>
<code class="linenos"> 32 </code><code class="c1">;;   '("Option 1" "Option 2" "And yet another option 3"))</code>
<code class="linenos"> 33 </code>
<code class="linenos"> 34 </code>
<code class="linenos"> 35 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">prompt-selection-list</code> <code class="p">(</code><code class="nv">a-list-of-choices</code><code class="p">)</code> 
<code class="linenos"> 36 </code>  <code class="c1">;; e.g., '((:people (("11" "data1")  ("22" "data2"))) (:places (("p1" "data3"))))</code>
<code class="linenos"> 37 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">ret</code><code class="p">)</code>
<code class="linenos"> 38 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">choice</code> <code class="nv">a-list-of-choices</code><code class="p">)</code>
<code class="linenos"> 39 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="nv">choice</code> <code class="p">(</code><code class="nb">remove-if</code> <code class="nf">#'</code><code class="nb">null</code> <code class="nv">choice</code><code class="p">))</code>
<code class="linenos"> 40 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">topic-type</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">choice</code><code class="p">))</code>
<code class="linenos"> 41 </code>             <code class="p">(</code><code class="nv">choice-list-full</code> <code class="p">(</code><code class="nb">rest</code> <code class="nv">choice</code><code class="p">))</code>
<code class="linenos"> 42 </code>             <code class="p">(</code><code class="nv">choice-list</code> <code class="p">(</code><code class="nb">remove-duplicates</code>
<code class="linenos"> 43 </code>                           <code class="p">(</code><code class="nb">map</code> <code class="ss">'list</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">z</code><code class="p">)</code>
<code class="linenos"> 44 </code>                                          <code class="p">(</code><code class="nb">list</code>
<code class="linenos"> 45 </code>                                           <code class="nv">z</code>
<code class="linenos"> 46 </code>                                           <code class="p">(</code><code class="nv">string-shorten</code>
<code class="linenos"> 47 </code>                                            <code class="p">(</code><code class="nv">kgn-common:clean-comment</code>
<code class="linenos"> 48 </code>                                             <code class="p">(</code><code class="nv">kgn-common:clean-comment</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">z</code><code class="p">)))</code>
<code class="linenos"> 49 </code>                                            <code class="mi">140</code> <code class="ss">:first-remove-stop-words</code> <code class="no">t</code><code class="p">)))</code>
<code class="linenos"> 50 </code>                                <code class="c1">;; top level list flatten:</code>
<code class="linenos"> 51 </code>                                <code class="p">(</code><code class="nb">apply</code> <code class="nf">#'</code><code class="nb">append</code> <code class="nv">choice-list-full</code><code class="p">))</code>
<code class="linenos"> 52 </code>                           <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">)))</code>
<code class="linenos"> 53 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">ret2</code>
<code class="linenos"> 54 </code>              <code class="p">(</code><code class="nv">dialog-results</code> <code class="p">(</code><code class="nv">multiple-selections</code> <code class="nv">choice-list</code><code class="p">)))</code>
<code class="linenos"> 55 </code>          <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">index</code> <code class="nv">dialog-results</code><code class="p">)</code>
<code class="linenos"> 56 </code>            <code class="p">(</code><code class="nb">setf</code> <code class="nv">ret2</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">nth</code> <code class="nv">index</code> <code class="nv">choice-list</code><code class="p">)</code> <code class="nv">ret2</code><code class="p">)))</code>
<code class="linenos"> 57 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">ret2</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 58 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">topic-type</code> <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret2</code><code class="p">))</code> <code class="nv">ret</code><code class="p">))))))</code>
<code class="linenos"> 59 </code>    <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos"> 60 </code>
<code class="linenos"> 61 </code><code class="c1">;; (kgn-text-ui::prompt-selection-list </code>
<code class="linenos"> 62 </code><code class="c1">;;   '((:people (("11" "data1")  ("22" "data2")))</code>
<code class="linenos"> 63 </code><code class="c1">;;     (:places (("p1" "data3") ("p2" "data4") ("p3" "data5")))))</code>
<code class="linenos"> 64 </code><code class="c1">;; (kgn-text-ui::prompt-selection-list</code>
<code class="linenos"> 65 </code><code class="c1">;;   (get-entity-data-helper "Bill Gates went to Seattle to Microsoft"))</code>
<code class="linenos"> 66 </code>
<code class="linenos"> 67 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">colorize-sparql</code> <code class="p">(</code><code class="nv">str</code> <code class="k">&amp;key</code> <code class="p">(</code><code class="nc">stream</code> <code class="no">t</code><code class="p">))</code>
<code class="linenos"> 68 </code>  <code class="s">" this could be used to colorize text (as it is in kgn-capi-ui example)"</code>
<code class="linenos"> 69 </code>  <code class="c1">;;(declare (ignore message-stream))</code>
<code class="linenos"> 70 </code>  <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nc">stream</code><code class="p">))</code>
<code class="linenos"> 71 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~%~S~%"</code> <code class="nv">str</code><code class="p">))</code>
<code class="linenos"> 72 </code>
<code class="linenos"> 73 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-string-from-user</code> <code class="p">(</code><code class="nv">text-prompt</code><code class="p">)</code>
<code class="linenos"> 74 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~%~S:~%"</code> <code class="nv">text-prompt</code><code class="p">)</code>
<code class="linenos"> 75 </code>  <code class="p">(</code><code class="nb">read-line</code><code class="p">))</code>
<code class="linenos"> 76 </code>
<code class="linenos"> 77 </code>
<code class="linenos"> 78 </code><code class="c1">;; Main funtion</code>
<code class="linenos"> 79 </code>
<code class="linenos"> 80 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">kgn-text-ui</code> <code class="p">()</code>
<code class="linenos"> 81 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">prompt</code>
<code class="linenos"> 82 </code>        <code class="p">(</code><code class="nv">message-stream</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos"> 83 </code>        <code class="p">(</code><code class="nv">results-stream</code> <code class="no">t</code><code class="p">))</code>
<code class="linenos"> 84 </code>    <code class="p">(</code><code class="nb">loop</code>
<code class="linenos"> 85 </code>       <code class="nv">while</code>
<code class="linenos"> 86 </code>        <code class="p">(</code><code class="nb">&gt;</code>
<code class="linenos"> 87 </code>         <code class="p">(</code><code class="nb">length</code>
<code class="linenos"> 88 </code>           <code class="p">(</code><code class="nb">setf</code> <code class="nv">prompt</code>
<code class="linenos"> 89 </code>             <code class="p">(</code><code class="nv">get-string-from-user</code>
<code class="linenos"> 90 </code>               <code class="s">"Enter entity names (people, places, companies, etc."</code><code class="p">)))</code>
<code class="linenos"> 91 </code>           <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 92 </code>         <code class="nb">do</code>
<code class="linenos"> 93 </code>         <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">entity-data</code> <code class="p">(</code><code class="nv">get-entity-data-helper</code> <code class="nv">prompt</code> <code class="ss">:message-stream</code> <code class="no">t</code><code class="p">)))</code>
<code class="linenos"> 94 </code>           <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">user-selections</code> <code class="p">(</code><code class="nv">prompt-selection-list</code> <code class="nv">entity-data</code><code class="p">)))</code>
<code class="linenos"> 95 </code>             <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">ev</code> <code class="nv">user-selections</code><code class="p">)</code>
<code class="linenos"> 96 </code>               <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">ev</code><code class="p">))</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 97 </code>                   <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos"> 98 </code>                     <code class="p">(</code><code class="nb">terpri</code> <code class="nv">results-stream</code><code class="p">)</code>
<code class="linenos"> 99 </code>                     <code class="p">(</code><code class="nb">format</code> <code class="nv">results-stream</code> <code class="s">"- - - ENTITY TYPE: ~A - - -"</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">ev</code><code class="p">))</code>
<code class="linenos">100 </code>                     <code class="c1">;;(terpri results-stream)</code>
<code class="linenos">101 </code>                     <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">ev</code><code class="p">))</code>
<code class="linenos">102 </code>                       <code class="p">(</code><code class="nb">setf</code> <code class="nv">uri</code> <code class="p">(</code><code class="nb">assoc</code> <code class="ss">:s</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">uri</code><code class="p">)))</code>
<code class="linenos">103 </code>                       <code class="p">(</code><code class="nb">case</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">ev</code><code class="p">)</code>
<code class="linenos">104 </code>                         <code class="p">(</code><code class="ss">:people</code>
<code class="linenos">105 </code>                          <code class="p">(</code><code class="nv">pprint-results</code> 
<code class="linenos">106 </code>                           <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-person-detail</code>  
<code class="linenos">107 </code>                             <code class="nv">uri</code>
<code class="linenos">108 </code>                             <code class="ss">:message-stream</code> <code class="nv">message-stream</code>
<code class="linenos">109 </code>                             <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)))</code>
<code class="linenos">110 </code>                         <code class="p">(</code><code class="ss">:companies</code>
<code class="linenos">111 </code>                          <code class="p">(</code><code class="nv">pprint-results</code> 
<code class="linenos">112 </code>                           <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-company-detail</code> <code class="nv">uri</code>
<code class="linenos">113 </code>                             <code class="ss">:message-stream</code> <code class="nv">message-stream</code>
<code class="linenos">114 </code>                             <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)))</code>
<code class="linenos">115 </code>                         <code class="p">(</code><code class="ss">:countries</code>
<code class="linenos">116 </code>                          <code class="p">(</code><code class="nv">pprint-results</code>
<code class="linenos">117 </code>                           <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-country-detail</code> <code class="nv">uri</code>
<code class="linenos">118 </code>                             <code class="ss">:message-stream</code> <code class="nv">message-stream</code>
<code class="linenos">119 </code>                             <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)))</code>
<code class="linenos">120 </code>                         <code class="p">(</code><code class="ss">:cities</code>
<code class="linenos">121 </code>                          <code class="p">(</code><code class="nv">pprint-results</code>
<code class="linenos">122 </code>                           <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-city-detail</code>    <code class="nv">uri</code>
<code class="linenos">123 </code>                             <code class="ss">:message-stream</code> <code class="nv">message-stream</code>
<code class="linenos">124 </code>                             <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)))</code>
<code class="linenos">125 </code>                         <code class="p">(</code><code class="ss">:products</code>
<code class="linenos">126 </code>                          <code class="p">(</code><code class="nv">pprint-results</code>
<code class="linenos">127 </code>                           <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-product-detail</code> <code class="nv">uri</code>
<code class="linenos">128 </code>                           <code class="ss">:message-stream</code> <code class="nv">message-stream</code>
<code class="linenos">129 </code>                           <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)))))))))))))</code>
<code class="linenos">130 </code>
<code class="linenos">131 </code><code class="c1">;; (kgn-text-ui:kgn-text-ui)</code>
</pre></div>

</figure>

<p>The utility function <strong>multiple-selections</strong> listed in lines 10-29 displays a list of user choices, adding a zero-based index for each list item. The user can enter zero or more indices to indicate their choices using the function <strong>prompt-selection-list</strong> listed in lines 35-59.</p>

<p>The commented out code in lines 61-65 can be used to test these two functions.</p>

<p>The main function <strong>kgn-text-ui</strong> is listed in lines 80-129.</p>

<h3 id="leanpub-auto-wrap-up-3">Wrap-up</h3>

<p>In the previous chapter we implemented the Knowledge Graph Navigator library. Here we developed a text-based user interface. In the next chapter we use the library to develop a LispWorks specific CAPI user interface.</p>


<h2 id="kgncapi">Knowledge Graph Navigator User Interface Using LispWorks CAPI</h2>

<p>As we have seen in the last two chapters the Knowledge Graph Navigator (which I will often refer to as KGN) is a tool for processing a set of entity names and automatically exploring the public Knowledge Graph <a href="http://dbpedia.org">DBPedia</a> using SPARQL queries. I started to write KGN for my own use, to automate some things I used to do manually when exploring Knowledge Graphs, and later thought that KGN might also be useful for educational purposes. KGN shows the user the auto-generated SPARQL queries so hopefully the user will learn by seeing examples. KGN uses NLP code developed in earlier chapters and we will reuse that code with a short review of using the APIs. Here is a screenshot showing the application we develop here:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 90%">
    <img src="images/kgn1.png" alt="UI for the Knowledge Graph Navigator" style="width: 100%">
    <figcaption>UI for the Knowledge Graph Navigator</figcaption>
  </figure>
</div>


<p>We will use the <a href="#kgncommon">KGN common library</a> developed earlier. This example replaces the text bases UI from the last chapter and requires either the free or professional version of LispWorks to run.</p>

<p>The code for the CAPI user interface is found in the GitHub repository <a href="https://github.com/mark-watson/kgn-capi-ui">https://github.com/mark-watson/kgn-capi-ui</a>.</p>

<h3 id="leanpub-auto-project-configuration-and-running-the-application-1">Project Configuration and Running the Application</h3>

<p>The following listing of <strong>kgn.asd</strong> shows the five packages this example depends on in addition to <strong>#:kgn-common</strong> that was developed in an earlier chapter that is referenced in the file <strong>package.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;;; knowledgegraphnavigator.asd</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:kgn-capi-ui</code>
<code class="linenos"> 4 </code>  <code class="ss">:description</code> <code class="s">"top level Knowledge Graph Navigator package"</code>
<code class="linenos"> 5 </code>  <code class="ss">:author</code> <code class="s">"Mark Watson &lt;markw@markwatson.com&gt;"</code>
<code class="linenos"> 6 </code>  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
<code class="linenos"> 7 </code>  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:kgn-common</code> <code class="ss">#:sparql</code> <code class="ss">#:kbnlp</code> <code class="ss">#:lw-grapher</code> <code class="ss">#:trivial-open-browser</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
<code class="linenos"> 9 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"kgn-capi-ui"</code><code class="p">)</code>
<code class="linenos">10 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"option-pane"</code><code class="p">)</code>
<code class="linenos">11 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"colorize"</code><code class="p">)</code>
<code class="linenos">12 </code>                <code class="p">(</code><code class="ss">:file</code> <code class="s">"user-interface"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Other dependency libraries specified in <strong>project.lisp</strong> are <strong>trivial-open-browser</strong> which we will use to open a web browser to URIs for human readable information on DBPedia and <strong>sparql</strong> that was developed in an earlier chapter.</p>

<p>Listing of <strong>package.lisp</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">;;;; package.lisp</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:kgn-capi-ui</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code><code class="p">)</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:kgn-common</code> <code class="ss">#:sparql</code> <code class="ss">#:lw-grapher</code> <code class="ss">#:trivial-open-browser</code><code class="p">)</code>
<code class="linenos">6 </code>  <code class="p">(</code><code class="ss">:export</code> <code class="ss">#:kgn-capi-ui</code><code class="p">))</code>
</pre></div>

</figure>

<p>The free personal edition of LispWorks does not support initialization files so you must manually load Quicklisp from the Listener Window when you first start LispWorks Personal as seen in the following repl listing (edited to remove some output for brevity). Once Quicklisp is loaded we then use <strong>ql:quickload</strong> to load the example in this chapter (some output removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">CL-USER</code> <code class="mi">1</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nb">load</code> <code class="s">"~/quicklisp/setup.lisp"</code><code class="p">)</code>
<code class="c1">; Loading text file /Users/markw/quicklisp/setup.lisp</code>
<code class="c1">; Loading /Applications/LispWorks Personal 7.1/...</code>
<code class="c1">;; Creating system "COMM"</code>
<code class="l l-Other">#P"/Users/markw/quicklisp/setup.lisp"</code>

<code class="nv">CL-USER</code> <code class="mi">2</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="s">"kgn"</code><code class="p">)</code>
<code class="nv">To</code> <code class="nb">load</code> <code class="s">"kgn"</code><code class="err">:</code>
  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
    <code class="nv">kgn</code>
<code class="c1">; Loading "kgn"</code>
<code class="o">.</code>
<code class="s">"Starting to load data...."</code> 
<code class="s">"....done loading data."</code> 
<code class="s">"#P\"/Users/markw/GITHUB/common-lisp/entity-uris/entity-uris.lisp\""</code> 
<code class="s">"current directory:"</code> 
<code class="s">"/Users/markw/GITHUB/common-lisp/entity-uris"</code> 
<code class="s">"Starting to load data...."</code> 
<code class="s">"....done loading data."</code>
<code class="nv">[package</code> <code class="nv">kgn]</code>
<code class="nv">To</code> <code class="nb">load</code> <code class="s">"sqlite"</code><code class="err">:</code>
  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
    <code class="nv">sqlite</code>
<code class="c1">; Loading "sqlite"</code>
<code class="nv">To</code> <code class="nb">load</code> <code class="s">"cl-json"</code><code class="err">:</code>
  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
    <code class="nv">cl-json</code>
<code class="c1">; Loading "cl-json"</code>
<code class="nv">To</code> <code class="nb">load</code> <code class="s">"drakma"</code><code class="err">:</code>
  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
    <code class="nv">drakma</code>
<code class="c1">; Loading "drakma"</code>
<code class="o">.</code><code class="nv">To</code> <code class="nb">load</code> <code class="s">"entity-uris"</code><code class="err">:</code>
  <code class="nv">Load</code> <code class="mi">1</code> <code class="nv">ASDF</code> <code class="nv">system:</code>
    <code class="nv">entity-uris</code>
<code class="c1">; Loading "entity-uris"</code>
<code class="p">(</code><code class="s">"kgn"</code><code class="p">)</code>
<code class="nv">CL-USER</code> <code class="mi">3</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nv">kgn:kgn</code><code class="p">)</code>
<code class="err">#</code><code class="nv">&lt;KGN::KGN-INTERFACE</code> <code class="s">"Knowledge Graph Navigator"</code> <code class="nv">40201E91DB&gt;</code>
</pre></div>

</figure>

<p>Please note that I assume you have configured all of the examples for this book for discoverability by Quicklisp as per the section <a href="#qlconfig">Setup for Local Quicklisp Projects</a> in Appendix A.</p>

<p>When the KGN application starts a sample query is randomly chosen. Queries with many entities can take a while to process, especially when you first start using this application. Every time KGN makes a web service call to DBPedia the query and response are cached in a SQLite database in <strong>~/.kgn_cache.db</strong> which can greatly speed up the program, especially in development mode when testing a set of queries. This caching also takes some load off of the public DBPedia endpoint, which is a polite thing to do.</p>

<p>I use LispWorks Professional and add two utility functions to the bottom on my <strong>~/.lispworks</strong> configuration file (you can’t do this with LispWorks Personal):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">;;; The following lines added by ql:add-to-init-file:</code>
<code class="linenos"> 2 </code><code class="o">#-</code><code class="nv">quicklisp</code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">quicklisp-init</code>
<code class="linenos"> 4 </code>         <code class="p">(</code><code class="nb">merge-pathnames</code>
<code class="linenos"> 5 </code>           <code class="s">"quicklisp/setup.lisp"</code>
<code class="linenos"> 6 </code>           <code class="p">(</code><code class="nb">user-homedir-pathname</code><code class="p">))))</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="nb">when</code> <code class="p">(</code><code class="nb">probe-file</code> <code class="nv">quicklisp-init</code><code class="p">)</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nb">load</code> <code class="nv">quicklisp-init</code><code class="p">)))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">ql</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="nv">ql:quickload</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">qlp</code> <code class="p">(</code><code class="nv">x</code><code class="p">)</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nv">ql:quickload</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="nv">SYSTEM::%IN-PACKAGE</code> <code class="p">(</code><code class="nb">string-upcase</code> <code class="nv">x</code><code class="p">)</code> <code class="ss">:NEW</code> <code class="no">T</code><code class="p">))</code>
</pre></div>

</figure>

<p>Function <strong>ql</strong> is just a short alias to avoid frequently typing <strong>ql:quickload</strong> and <strong>qlp</strong> loads a Quicklisp project and then performs an <strong>in-package</strong> of the Common Lisp package with the same name as the Quicklisp project.</p>

<h3 id="leanpub-auto-utilities-to-colorize-sparql-and-generated-output">Utilities to Colorize SPARQL and Generated Output</h3>

<p>When I first had the basic functionality of KGN with a CAPI UI working, I was disappointed by how the application looked as all black text on a white background. Every editor and IDE I use colorizes text in an appropriate way so I took advantage of the function <strong>capi::write-string-with-properties</strong> to easily implement color hilting SPARQL queries.</p>

<p>The code in the following listing is in the file <strong>kgn/colorize.lisp</strong>. When I generate SPARQL queries to show the user I use the characters “@@” as placeholders for end of lines in the generated output. In line 5 I am ensuring that there are spaces around these characters so they get tokenized properly. In the loop starting at line 7 I process the tokens checking each one to see if it should have a color associated with it when it is written to the output stream.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">colorize-sparql</code> <code class="p">(</code><code class="nv">s</code>  <code class="k">&amp;key</code> <code class="p">(</code><code class="nc">stream</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">tokens</code> <code class="p">(</code><code class="nv">tokenize-string-keep-uri</code>
<code class="linenos"> 5 </code>                    <code class="p">(</code><code class="nv">replace-all</code> <code class="nv">s</code> <code class="s">"@@"</code> <code class="s">" @@ "</code><code class="p">)))</code>
<code class="linenos"> 6 </code>        <code class="nv">in-var</code><code class="p">)</code>
<code class="linenos"> 7 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">token</code> <code class="nv">tokens</code><code class="p">)</code>
<code class="linenos"> 8 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">token</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 9 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">or</code> <code class="nv">in-var</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">token</code> <code class="s">"?"</code><code class="p">))</code>
<code class="linenos">10 </code>              <code class="p">(</code><code class="nv">capi::write-string-with-properties</code>
<code class="linenos">11 </code>                <code class="nv">token</code>
<code class="linenos">12 </code>                <code class="o">'</code><code class="p">(</code><code class="ss">:highlight</code> <code class="ss">:compiler-warning-highlight</code><code class="p">)</code>
<code class="linenos">13 </code>                <code class="nc">stream</code><code class="p">)</code>
<code class="linenos">14 </code>            <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">find</code> <code class="nv">token</code> <code class="o">'</code><code class="p">(</code><code class="s">"where"</code> <code class="s">"select"</code> <code class="s">"distinct"</code> <code class="s">"option"</code> <code class="s">"filter"</code>
<code class="linenos">15 </code>                              <code class="s">"FILTER"</code> <code class="s">"OPTION"</code> <code class="s">"DISTINCT"</code>
<code class="linenos">16 </code>                              <code class="s">"SELECT"</code> <code class="s">"WHERE"</code><code class="p">)</code>
<code class="linenos">17 </code>                      <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">)</code>
<code class="linenos">18 </code>                <code class="p">(</code><code class="nv">capi::write-string-with-properties</code> 
<code class="linenos">19 </code>                  <code class="nv">token</code>
<code class="linenos">20 </code>                  <code class="o">'</code><code class="p">(</code><code class="ss">:highlight</code> <code class="ss">:compiler-note-highlight</code><code class="p">)</code>
<code class="linenos">21 </code>                  <code class="nc">stream</code><code class="p">)</code>
<code class="linenos">22 </code>              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">token</code> <code class="mi">0</code> <code class="mi">1</code><code class="p">)</code> <code class="s">"&lt;"</code><code class="p">)</code>
<code class="linenos">23 </code>                  <code class="p">(</code><code class="nv">capi::write-string-with-properties</code>
<code class="linenos">24 </code>                    <code class="nv">token</code>
<code class="linenos">25 </code>                    <code class="o">'</code><code class="p">(</code><code class="ss">:highlight</code> <code class="ss">:bold</code><code class="p">)</code>
<code class="linenos">26 </code>                    <code class="nc">stream</code><code class="p">)</code>
<code class="linenos">27 </code>                <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">token</code> <code class="s">"@@"</code><code class="p">)</code>
<code class="linenos">28 </code>                    <code class="p">(</code><code class="nb">terpri</code> <code class="nc">stream</code><code class="p">)</code>
<code class="linenos">29 </code>                  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">token</code> <code class="s">"~"</code><code class="p">))</code> <code class="p">(</code><code class="nb">write-string</code> <code class="nv">token</code> <code class="nc">stream</code><code class="p">)))))))</code>
<code class="linenos">30 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">token</code> <code class="s">"?"</code><code class="p">)</code>
<code class="linenos">31 </code>          <code class="p">(</code><code class="nb">setf</code> <code class="nv">in-var</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">32 </code>        <code class="p">(</code><code class="nb">setf</code> <code class="nv">in-var</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos">33 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code>
<code class="linenos">34 </code>           <code class="p">(</code><code class="nb">not</code> <code class="nv">in-var</code><code class="p">)</code>
<code class="linenos">35 </code>           <code class="p">(</code><code class="nb">not</code> <code class="p">(</code><code class="nb">equal</code> <code class="nv">token</code> <code class="s">"?"</code><code class="p">)))</code>
<code class="linenos">36 </code>          <code class="p">(</code><code class="nb">write-string</code> <code class="s">" "</code> <code class="nc">stream</code><code class="p">)))</code>
<code class="linenos">37 </code>    <code class="p">(</code><code class="nb">terpri</code> <code class="nc">stream</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Here is an example call to function <strong>colorize-sparql</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">KGN</code> <code class="mi">25</code> <code class="o">&gt;</code> <code class="p">(</code><code class="err">colorize</code><code class="o">-</code><code class="err">sparql</code> <code class="s">"select ?s ?p  where {@@  ?s ?p \</code><code class="se">"</code><code class="s">Microsoft\</code><code class="se">"</code><code class="s"> } @@  FILTER\</code>
 <code class="p">(</code><code class="nf">lang</code><code class="p">(</code><code class="nv">?comment</code><code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code><code class="p">)</code><code class="s">")</code>
<code class="k">select</code> <code class="nv">?s</code> <code class="nv">?p</code> <code class="k">where</code> <code class="p">{</code> 
 <code class="nv">?s</code> <code class="nv">?p</code> <code class="s">"Microsoft"</code> <code class="p">}</code> 
 <code class="k">FILTER</code> <code class="p">(</code> <code class="nf">lang</code> <code class="p">(</code> <code class="nv">?comment</code> <code class="p">)</code> <code class="o">=</code> <code class="s">'en'</code> <code class="p">)</code> 
</pre></div>

</figure>

<h3 id="leanpub-auto-main-implementation-file-kgn-capi-uilisp">Main Implementation File kgn-capi-ui.lisp</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">;;----------------------------------------------------------------------------</code>
<code class="linenos">  2 </code><code class="c1">;; To try it, compile and load this file and then execute:</code>
<code class="linenos">  3 </code><code class="c1">;;</code>
<code class="linenos">  4 </code><code class="c1">;;      (kgn::kgn)</code>
<code class="linenos">  5 </code><code class="c1">;;</code>
<code class="linenos">  6 </code><code class="c1">;;----------------------------------------------------------------------------</code>
<code class="linenos">  7 </code><code class="c1">;; Copyright (c) 2020-2022 Mark Watson. All rights reserved.</code>
<code class="linenos">  8 </code><code class="c1">;;----------------------------------------------------------------------------</code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn-capi-ui</code><code class="p">)</code>
<code class="linenos"> 11 </code>
<code class="linenos"> 12 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*width*</code> <code class="mi">1370</code><code class="p">)</code>
<code class="linenos"> 13 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*best-width*</code> <code class="mi">1020</code><code class="p">)</code>
<code class="linenos"> 14 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*show-info-pane*</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos"> 15 </code>
<code class="linenos"> 16 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*pane2-message*</code>
<code class="linenos"> 17 </code>  <code class="s">"In order to process your query a series of SPARQL queries will be formed based on\</code>
<code class="linenos"> 18 </code><code class="s"> the query. These generated SPARQL queries will be shown here and the reuslts of the\</code>
<code class="linenos"> 19 </code><code class="s"> queries will be formatted and displayed in the results display pane below."</code><code class="p">)</code>
<code class="linenos"> 20 </code>
<code class="linenos"> 21 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*pane3-message*</code>
<code class="linenos"> 22 </code>  <code class="s">"Enter a query containing entities like people's names, companys, places, etc. fol\</code>
<code class="linenos"> 23 </code><code class="s">lowing by the RETURN key to start processing your query. You can also directly use a\</code>
<code class="linenos"> 24 </code><code class="s"> DBPedia URI for an entity, for example: &lt;http://dbpedia.org/resource/Apple_Inc.&gt; Wh\</code>
<code class="linenos"> 25 </code><code class="s">en you start this application, a sample query is randomly chosen to get you started.\</code>
<code class="linenos"> 26 </code><code class="s">"</code><code class="p">)</code>
<code class="linenos"> 27 </code>
<code class="linenos"> 28 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test-callback-click</code> <code class="p">(</code><code class="nv">selected-node-name</code><code class="p">)</code>
<code class="linenos"> 29 </code>  <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 30 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"* user clicked on node: ~A~%"</code> <code class="nv">selected-node-name</code><code class="p">)))</code>
<code class="linenos"> 31 </code>
<code class="linenos"> 32 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">test-callback-click-shift</code> <code class="p">(</code><code class="nv">selected-node-name</code><code class="p">)</code>
<code class="linenos"> 33 </code>  <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 34 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">selected-node-name</code> <code class="mi">0</code> <code class="mi">5</code><code class="p">)</code> <code class="s">"&lt;http"</code><code class="p">)</code>
<code class="linenos"> 35 </code>        <code class="p">(</code><code class="nv">trivial-open-browser:open-browser</code> 
<code class="linenos"> 36 </code>         <code class="p">(</code><code class="nb">subseq</code> <code class="nv">selected-node-name</code> <code class="mi">1</code> <code class="p">(</code><code class="nb">-</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">selected-node-name</code><code class="p">)</code> <code class="mi">1</code><code class="p">))))</code>
<code class="linenos"> 37 </code>    <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"* user shift-clicked on node: ~A - OPEN WEB BROWSER~%"</code> <code class="nv">selected-nod</code><code class="err">\</code>
<code class="linenos"> 38 </code><code class="nv">e-name</code><code class="p">)))</code>
<code class="linenos"> 39 </code>
<code class="linenos"> 40 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">cache-callback</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 41 </code>  <code class="p">(</code><code class="k">if</code> <code class="vg">*USE-CACHING*</code>
<code class="linenos"> 42 </code>      <code class="p">(</code><code class="nv">capi:display</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'options-panel-interface</code><code class="p">))))</code>
<code class="linenos"> 43 </code>
<code class="linenos"> 44 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">website-callback</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code> <code class="p">(</code><code class="nv">trivial-open-browser:open-br</code><code class="err">\</code>
<code class="linenos"> 45 </code><code class="nv">owser</code> <code class="s">"http://www.knowledgegraphnavigator.com/"</code><code class="p">))</code>
<code class="linenos"> 46 </code>
<code class="linenos"> 47 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">toggle-grapher-visibility</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 48 </code>  <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 49 </code>  <code class="p">(</code><code class="nb">setf</code> <code class="vg">*show-info-pane*</code> <code class="p">(</code><code class="nb">not</code> <code class="vg">*show-info-pane*</code><code class="p">)))</code>
<code class="linenos"> 50 </code>
<code class="linenos"> 51 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*examples*</code><code class="p">)</code>
<code class="linenos"> 52 </code><code class="p">(</code><code class="nb">setf</code> <code class="vg">*examples*</code> <code class="o">'</code><code class="p">(</code><code class="s">"Bill Gates and Melinda Gates at Microsoft in Seattle"</code>
<code class="linenos"> 53 </code>                   <code class="s">"Bill Clinton &lt;http://dbpedia.org/resource/Georgia_(U.S._state)&gt;"</code>
<code class="linenos"> 54 </code>                   <code class="s">"Bill Gates and Steve Jobs visited IBM and Microsoft in Berlin, S\</code>
<code class="linenos"> 55 </code><code class="s">an Francisco, Toronto, Canada"</code>
<code class="linenos"> 56 </code>                   <code class="s">"Steve Jobs lived near San Francisco and was a founder of &lt;http:/\</code>
<code class="linenos"> 57 </code><code class="s">/dbpedia.org/resource/Apple_Inc.&gt;"</code>
<code class="linenos"> 58 </code>                   <code class="s">"&lt;http://dbpedia.org/resource/Bill_Gates&gt; visited IBM"</code>
<code class="linenos"> 59 </code>                   <code class="s">"&lt;http://dbpedia.org/resource/Bill_Gates&gt; visited &lt;http://dbpedia\</code>
<code class="linenos"> 60 </code><code class="s">.org/resource/Apple_Inc.&gt;"</code>
<code class="linenos"> 61 </code>                   <code class="s">"Bill Gates visited &lt;http://dbpedia.org/resource/Apple_Inc.&gt;"</code><code class="p">))</code>
<code class="linenos"> 62 </code>
<code class="linenos"> 63 </code><code class="p">(</code><code class="nv">capi:define-interface</code> <code class="nv">kgn-interface</code> <code class="p">()</code>
<code class="linenos"> 64 </code>  <code class="p">()</code>
<code class="linenos"> 65 </code>  <code class="p">(</code><code class="ss">:menus</code>
<code class="linenos"> 66 </code>   <code class="p">(</code><code class="nv">action-menu</code> 
<code class="linenos"> 67 </code>    <code class="s">"Actions"</code>
<code class="linenos"> 68 </code>    <code class="p">(</code>
<code class="linenos"> 69 </code>     <code class="p">(</code><code class="s">"Copy generated SPARQL to clipboard"</code>
<code class="linenos"> 70 </code>      <code class="ss">:callback</code>
<code class="linenos"> 71 </code>      <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 72 </code>          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">messages</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane2</code><code class="p">)))</code>
<code class="linenos"> 73 </code>            <code class="p">(</code><code class="nv">capi::set-clipboard</code> <code class="nv">text-pane2</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"---- Generated SPARQL and c\</code>
<code class="linenos"> 74 </code><code class="s">omments:~%~%~A~%~%"</code> <code class="nv">messages</code><code class="p">)</code> <code class="no">nil</code><code class="p">))))</code>
<code class="linenos"> 75 </code>     <code class="p">(</code><code class="s">"Copy results to clipboard"</code>
<code class="linenos"> 76 </code>      <code class="ss">:callback</code>
<code class="linenos"> 77 </code>      <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 78 </code>          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">results</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane3</code><code class="p">)))</code>
<code class="linenos"> 79 </code>            <code class="p">(</code><code class="nv">capi::set-clipboard</code> <code class="nv">text-pane2</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"---- Results:~%~%~A~%"</code> <code class="nv">resu</code><code class="err">\</code>
<code class="linenos"> 80 </code><code class="nv">lts</code><code class="p">)</code> <code class="no">nil</code><code class="p">))))</code>
<code class="linenos"> 81 </code>     <code class="p">(</code><code class="s">"Copy generated SPARQL and results to clipboard"</code>
<code class="linenos"> 82 </code>      <code class="ss">:callback</code>
<code class="linenos"> 83 </code>      <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code> <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 84 </code>          <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">messages</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane2</code><code class="p">))</code>
<code class="linenos"> 85 </code>                <code class="p">(</code><code class="nv">results</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane3</code><code class="p">)))</code>
<code class="linenos"> 86 </code>            <code class="p">(</code><code class="nv">capi::set-clipboard</code>
<code class="linenos"> 87 </code>             <code class="nv">text-pane2</code>
<code class="linenos"> 88 </code>             <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"---- Generated SPARQL and comments:~%~%~A~%~%---- Results:\</code>
<code class="linenos"> 89 </code><code class="s">~%~%~A~%"</code> <code class="nv">messages</code> <code class="nv">results</code><code class="p">)</code> <code class="no">nil</code><code class="p">))))</code>
<code class="linenos"> 90 </code>     <code class="p">(</code><code class="s">"Visit Knowledge Graph Navigator Web Site"</code> <code class="ss">:callback</code> <code class="ss">'website-callback</code><code class="p">)</code>
<code class="linenos"> 91 </code>     <code class="p">(</code><code class="s">"Clear query cache"</code> <code class="ss">:callback</code> <code class="ss">'cache-callback</code><code class="p">)</code>
<code class="linenos"> 92 </code>     <code class="p">((</code><code class="k">if</code> <code class="vg">*show-info-pane*</code>
<code class="linenos"> 93 </code>          <code class="s">"Stop showing Grapher window for new results"</code>
<code class="linenos"> 94 </code>        <code class="s">"Start showing Grapher window for new results"</code><code class="p">)</code>
<code class="linenos"> 95 </code>      <code class="ss">:callback</code> <code class="ss">'toggle-grapher-visibility</code><code class="p">)</code>
<code class="linenos"> 96 </code>     <code class="p">)))</code>
<code class="linenos"> 97 </code>  <code class="p">(</code><code class="ss">:menu-bar</code> <code class="nv">action-menu</code><code class="p">)</code>
<code class="linenos"> 98 </code>  <code class="p">(</code><code class="ss">:panes</code>
<code class="linenos"> 99 </code>   <code class="p">(</code><code class="nv">text-pane1</code>
<code class="linenos">100 </code>    <code class="nv">capi:text-input-pane</code>
<code class="linenos">101 </code>    <code class="ss">:text</code> <code class="p">(</code><code class="nb">nth</code> <code class="p">(</code><code class="nb">random</code> <code class="p">(</code><code class="nb">length</code> <code class="vg">*examples*</code><code class="p">))</code> <code class="vg">*examples*</code><code class="p">)</code>
<code class="linenos">102 </code>    <code class="ss">:title</code> <code class="s">"Query"</code>
<code class="linenos">103 </code>    <code class="ss">:min-height</code> <code class="mi">80</code>
<code class="linenos">104 </code>    <code class="ss">:max-height</code> <code class="mi">100</code>
<code class="linenos">105 </code>    <code class="ss">:max-width</code> <code class="vg">*width*</code>
<code class="linenos">106 </code>    <code class="c1">;;:min-width (- *width* 480)</code>
<code class="linenos">107 </code>    <code class="ss">:width</code> <code class="vg">*best-width*</code>
<code class="linenos">108 </code>    <code class="ss">:callback</code> <code class="ss">'start-background-thread</code><code class="p">)</code>
<code class="linenos">109 </code>
<code class="linenos">110 </code>   <code class="p">(</code><code class="nv">text-pane2</code>
<code class="linenos">111 </code>    <code class="nv">capi:collector-pane</code>
<code class="linenos">112 </code>    <code class="ss">:font</code> <code class="s">"Courier"</code>
<code class="linenos">113 </code>    <code class="ss">:min-height</code> <code class="mi">210</code>
<code class="linenos">114 </code>    <code class="ss">:max-height</code> <code class="mi">250</code>
<code class="linenos">115 </code>    <code class="ss">:title</code> <code class="s">"Generated SPARQL queries to get results"</code>
<code class="linenos">116 </code>    <code class="ss">:text</code> <code class="s">"Note: to answer queries, this app makes multipe SPARQL queries to DBPedia\</code>
<code class="linenos">117 </code><code class="s">. These SPARQL queries will be shown here."</code>
<code class="linenos">118 </code>    <code class="ss">:vertical-scroll</code> <code class="no">t</code>
<code class="linenos">119 </code>    <code class="ss">:create-callback</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">120 </code>                         <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">121 </code>                         <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane2</code><code class="p">)</code> <code class="vg">*pane2-message*</code><code class="p">))</code>
<code class="linenos">122 </code>    <code class="ss">:max-width</code> <code class="vg">*width*</code>
<code class="linenos">123 </code>    <code class="ss">:width</code> <code class="vg">*best-width*</code>
<code class="linenos">124 </code>    <code class="ss">:horizontal-scroll</code> <code class="no">t</code><code class="p">)</code>
<code class="linenos">125 </code>
<code class="linenos">126 </code>   <code class="p">(</code><code class="nv">text-pane3</code>
<code class="linenos">127 </code>    <code class="nv">capi:collector-pane</code> <code class="c1">;; capi:display-pane ;; capi:text-input-pane</code>
<code class="linenos">128 </code>    <code class="ss">:text</code> <code class="vg">*pane3-message*</code>
<code class="linenos">129 </code>    <code class="ss">:font</code> <code class="s">"Courier"</code>
<code class="linenos">130 </code>    <code class="ss">:line-wrap-marker</code> <code class="no">nil</code>
<code class="linenos">131 </code>    <code class="ss">:wrap-style</code> <code class="ss">:split-on-space</code>
<code class="linenos">132 </code>    <code class="ss">:vertical-scroll</code> <code class="ss">:with-bar</code>
<code class="linenos">133 </code>    <code class="ss">:title</code> <code class="s">"Results"</code>
<code class="linenos">134 </code>    <code class="ss">:horizontal-scroll</code> <code class="no">t</code>
<code class="linenos">135 </code>    <code class="ss">:min-height</code> <code class="mi">220</code>
<code class="linenos">136 </code>    <code class="ss">:width</code> <code class="vg">*best-width*</code>
<code class="linenos">137 </code>    <code class="ss">:create-callback</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">138 </code>                         <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">139 </code>                         <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane3</code><code class="p">)</code> <code class="vg">*pane3-message*</code><code class="p">))</code>
<code class="linenos">140 </code>    <code class="ss">:max-height</code> <code class="mi">240</code>
<code class="linenos">141 </code>    <code class="ss">:max-width</code> <code class="vg">*width*</code><code class="p">)</code>
<code class="linenos">142 </code>   <code class="p">(</code><code class="nv">info</code>
<code class="linenos">143 </code>    <code class="nv">capi:title-pane</code>
<code class="linenos">144 </code>    <code class="ss">:text</code> <code class="s">"Use natural language queries to generate SPARQL"</code><code class="p">))</code>
<code class="linenos">145 </code>  <code class="p">(</code><code class="ss">:layouts</code>
<code class="linenos">146 </code>   <code class="p">(</code><code class="nv">main-layout</code>
<code class="linenos">147 </code>    <code class="nv">capi:grid-layout</code>
<code class="linenos">148 </code>    <code class="o">'</code><code class="p">(</code><code class="no">nil</code> <code class="nv">info</code>
<code class="linenos">149 </code>      <code class="no">nil</code> <code class="nv">text-pane1</code>
<code class="linenos">150 </code>      <code class="no">nil</code> <code class="nv">text-pane2</code>
<code class="linenos">151 </code>      <code class="no">nil</code> <code class="nv">text-pane3</code><code class="p">)</code>
<code class="linenos">152 </code>     <code class="ss">:x-ratios</code> <code class="o">'</code><code class="p">(</code><code class="mi">1</code> <code class="mi">99</code><code class="p">)</code>
<code class="linenos">153 </code>    <code class="ss">:has-title-column-p</code> <code class="no">t</code><code class="p">))</code>
<code class="linenos">154 </code>  <code class="p">(</code><code class="ss">:default-initargs</code>
<code class="linenos">155 </code>   <code class="ss">:layout</code> <code class="ss">'main-layout</code>
<code class="linenos">156 </code>   <code class="ss">:title</code> <code class="s">"Knowledge Graph Navigator"</code>
<code class="linenos">157 </code>   <code class="ss">:best-width</code> <code class="vg">*best-width*</code>
<code class="linenos">158 </code>   <code class="ss">:max-width</code> <code class="vg">*width*</code><code class="p">))</code>
<code class="linenos">159 </code>
<code class="linenos">160 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">start-background-thread</code> <code class="p">(</code><code class="nv">query-text</code> <code class="nv">self</code><code class="p">)</code>
<code class="linenos">161 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"~%** ** entering start-progress-bar-test-from-background-thread:~%~%sel\</code>
<code class="linenos">162 </code><code class="s">f=~S~%~%"</code> <code class="nv">self</code><code class="p">)</code>
<code class="linenos">163 </code>  <code class="p">(</code><code class="nb">with-slots</code> <code class="p">(</code><code class="nv">text-pane2</code> <code class="nv">text-pane3</code><code class="p">)</code> <code class="nv">self</code>
<code class="linenos">164 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">text-pane2</code><code class="p">)</code>
<code class="linenos">165 </code>    <code class="p">(</code><code class="nv">mp:process-run-function</code> <code class="s">"progress-bar-test-from-background-thread"</code>
<code class="linenos">166 </code>                              <code class="o">'</code><code class="p">()</code>
<code class="linenos">167 </code>                              <code class="ss">'run-and-monitor-progress-background-thread</code>
<code class="linenos">168 </code>                              <code class="nv">query-text</code> <code class="nv">text-pane2</code> <code class="nv">text-pane3</code><code class="p">)))</code>
<code class="linenos">169 </code>
<code class="linenos">170 </code><code class="c1">;; This function runs in a separate thread.</code>
<code class="linenos">171 </code>
<code class="linenos">172 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">run-and-monitor-progress-background-thread</code> <code class="p">(</code><code class="nv">text</code> <code class="nv">text-pane2</code> <code class="nv">text-pane3</code><code class="p">)</code>
<code class="linenos">173 </code>  <code class="p">(</code><code class="k">unwind-protect</code>
<code class="linenos">174 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane2</code><code class="p">)</code> <code class="s">""</code><code class="p">)</code>
<code class="linenos">175 </code>    <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane3</code><code class="p">)</code> <code class="s">""</code><code class="p">)</code>
<code class="linenos">176 </code>    <code class="c1">;;(capi:display-message "done")</code>
<code class="linenos">177 </code>    <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">message-stream</code> <code class="p">(</code><code class="nv">capi:collector-pane-stream</code> <code class="nv">text-pane2</code><code class="p">))</code>
<code class="linenos">178 </code>          <code class="p">(</code><code class="nv">results-stream</code> <code class="p">(</code><code class="nv">capi:collector-pane-stream</code> <code class="nv">text-pane3</code><code class="p">)))</code>
<code class="linenos">179 </code>      <code class="p">(</code><code class="nb">format</code> <code class="nv">message-stream</code> <code class="s">"# Starting to process query....~%"</code><code class="p">)</code>
<code class="linenos">180 </code>      <code class="p">(</code><code class="nb">format</code> <code class="nv">results-stream</code> <code class="vg">*pane3-message*</code><code class="p">)</code>
<code class="linenos">181 </code>      <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">user-selections</code> <code class="p">(</code><code class="nv">prompt-selection-list</code> <code class="p">(</code><code class="nv">get-entity-data-helper</code> <code class="nv">text</code> <code class="ss">:me</code><code class="err">\</code>
<code class="linenos">182 </code><code class="nv">ssage-stream</code> <code class="nv">message-stream</code><code class="p">))))</code>
<code class="linenos">183 </code>        <code class="p">(</code><code class="nb">print</code> <code class="s">"***** from prompt selection list:"</code><code class="p">)</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">user-selections</code><code class="p">)</code>
<code class="linenos">184 </code>        <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">capi:editor-pane-text</code> <code class="nv">text-pane3</code><code class="p">)</code> <code class="s">""</code><code class="p">)</code>
<code class="linenos">185 </code>        <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">ev</code> <code class="nv">user-selections</code><code class="p">)</code>
<code class="linenos">186 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">ev</code><code class="p">))</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">187 </code>              <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos">188 </code>                <code class="p">(</code><code class="nb">terpri</code> <code class="nv">results-stream</code><code class="p">)</code>
<code class="linenos">189 </code>                <code class="p">(</code><code class="nv">capi::write-string-with-properties</code>
<code class="linenos">190 </code>                 <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"- - - ENTITY TYPE: ~A - - -"</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">ev</code><code class="p">))</code>
<code class="linenos">191 </code>                 <code class="o">'</code><code class="p">(</code><code class="ss">:highlight</code> <code class="ss">:compiler-error-highlight</code><code class="p">)</code> <code class="nv">results-stream</code><code class="p">)</code>
<code class="linenos">192 </code>                <code class="c1">;;(terpri results-stream)</code>
<code class="linenos">193 </code>                <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">uri</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">ev</code><code class="p">))</code>
<code class="linenos">194 </code>                  <code class="p">(</code><code class="nb">setf</code> <code class="nv">uri</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">uri</code><code class="p">))</code>
<code class="linenos">195 </code>                  <code class="p">(</code><code class="nb">case</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">ev</code><code class="p">)</code>
<code class="linenos">196 </code>                    <code class="p">(</code><code class="ss">:people</code>
<code class="linenos">197 </code>                     <code class="p">(</code><code class="nv">pprint-results</code> 
<code class="linenos">198 </code>                      <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-person-detail</code>  <code class="nv">uri</code> <code class="ss">:message-stream</code> <code class="nv">mes</code><code class="err">\</code>
<code class="linenos">199 </code><code class="nv">sage-stream</code> <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)</code>
<code class="linenos">200 </code>                      <code class="ss">:stream</code> <code class="nv">results-stream</code><code class="p">))</code>
<code class="linenos">201 </code>                    <code class="p">(</code><code class="ss">:companies</code>
<code class="linenos">202 </code>                     <code class="p">(</code><code class="nv">pprint-results</code> 
<code class="linenos">203 </code>                      <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-company-detail</code> <code class="nv">uri</code> <code class="ss">:message-stream</code> <code class="nv">mes</code><code class="err">\</code>
<code class="linenos">204 </code><code class="nv">sage-stream</code> <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)</code>
<code class="linenos">205 </code>                      <code class="ss">:stream</code> <code class="nv">results-stream</code><code class="p">))</code>
<code class="linenos">206 </code>                    <code class="p">(</code><code class="ss">:countries</code>
<code class="linenos">207 </code>                     <code class="p">(</code><code class="nv">pprint-results</code>
<code class="linenos">208 </code>                      <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-country-detail</code> <code class="nv">uri</code> <code class="ss">:message-stream</code> <code class="nv">mes</code><code class="err">\</code>
<code class="linenos">209 </code><code class="nv">sage-stream</code> <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)</code>
<code class="linenos">210 </code>                      <code class="ss">:stream</code> <code class="nv">results-stream</code><code class="p">))</code>
<code class="linenos">211 </code>                    <code class="p">(</code><code class="ss">:cities</code>
<code class="linenos">212 </code>                     <code class="p">(</code><code class="nv">pprint-results</code>
<code class="linenos">213 </code>                      <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-city-detail</code>    <code class="nv">uri</code> <code class="ss">:message-stream</code> <code class="nv">mes</code><code class="err">\</code>
<code class="linenos">214 </code><code class="nv">sage-stream</code> <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)</code>
<code class="linenos">215 </code>                      <code class="ss">:stream</code> <code class="nv">results-stream</code><code class="p">))</code>
<code class="linenos">216 </code>                    <code class="p">(</code><code class="ss">:products</code>
<code class="linenos">217 </code>                     <code class="p">(</code><code class="nv">pprint-results</code>
<code class="linenos">218 </code>                      <code class="p">(</code><code class="nv">kgn-common:dbpedia-get-product-detail</code> <code class="nv">uri</code> <code class="ss">:message-stream</code> <code class="nv">mes</code><code class="err">\</code>
<code class="linenos">219 </code><code class="nv">sage-stream</code> <code class="ss">:colorize-sparql-function</code> <code class="nf">#'</code><code class="nv">colorize-sparql</code><code class="p">)</code>
<code class="linenos">220 </code>                      <code class="ss">:stream</code> <code class="nv">results-stream</code><code class="p">)))))))</code>
<code class="linenos">221 </code>
<code class="linenos">222 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">links</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos">223 </code>          <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">ev</code> <code class="nv">user-selections</code><code class="p">)</code>
<code class="linenos">224 </code>            <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">uri</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">ev</code><code class="p">))</code>
<code class="linenos">225 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="nv">uri</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">uri</code><code class="p">))</code>
<code class="linenos">226 </code>              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">ev</code><code class="p">)</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">227 </code>                  <code class="p">(</code><code class="nb">setf</code> <code class="nv">x</code> <code class="p">(</code><code class="nb">caddr</code> <code class="nv">ev</code><code class="p">)))</code>
<code class="linenos">228 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="nv">links</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">symbol-name</code> <code class="p">(</code><code class="nb">first</code> <code class="nv">ev</code><code class="p">))</code> <code class="nv">uri</code> <code class="nv">x</code><code class="p">)</code> <code class="nv">links</code><code class="p">)))</code>
<code class="linenos">229 </code>
<code class="linenos">230 </code>          <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">231 </code>           <code class="nv">links</code>
<code class="linenos">232 </code>           <code class="p">(</code><code class="nb">append</code>
<code class="linenos">233 </code>            <code class="nv">links</code>
<code class="linenos">234 </code>            <code class="p">(</code><code class="nv">entity-results-&gt;relationship-links</code>
<code class="linenos">235 </code>             <code class="nv">user-selections</code>
<code class="linenos">236 </code>             <code class="ss">:message-stream</code> <code class="nv">message-stream</code><code class="p">))))</code>
<code class="linenos">237 </code>
<code class="linenos">238 </code>          <code class="p">(</code><code class="k">if</code>
<code class="linenos">239 </code>              <code class="vg">*show-info-pane*</code>
<code class="linenos">240 </code>              <code class="p">(</code><code class="nv">lw-grapher:make-info-panel-grapher</code> <code class="o">'</code><code class="p">(</code><code class="s">"PEOPLE"</code> <code class="s">"COMPANIES"</code> <code class="s">"COUNTRIES"</code><code class="err">\</code>
<code class="linenos">241 </code> <code class="s">"CITIES"</code> <code class="s">"PRODUCTS"</code> <code class="s">"PLACES"</code><code class="p">)</code>
<code class="linenos">242 </code>                                                  <code class="nv">links</code> <code class="ss">'test-callback-click</code> <code class="ss">'test-c</code><code class="err">\</code>
<code class="linenos">243 </code><code class="nv">allback-click-shift</code><code class="p">)))</code> <code class="c1">;; do  not use #' !!</code>
<code class="linenos">244 </code>        <code class="p">(</code><code class="nb">terpri</code> <code class="nv">results-stream</code><code class="p">)</code>
<code class="linenos">245 </code>        <code class="p">(</code><code class="nb">princ</code> <code class="s">"** Done wih query **"</code> <code class="nv">results-stream</code><code class="p">)))))</code>
<code class="linenos">246 </code>
<code class="linenos">247 </code>   
<code class="linenos">248 </code>
<code class="linenos">249 </code><code class="c1">;; MAIN entry point for application:</code>
<code class="linenos">250 </code>
<code class="linenos">251 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">kgn-capi-ui</code> <code class="p">()</code>
<code class="linenos">252 </code>  <code class="c1">;;(ignore-errors (create-dbpedia))</code>
<code class="linenos">253 </code>  <code class="p">(</code><code class="nv">capi:display</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'kgn-interface</code><code class="p">)))</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-user-interface-utilites-file-user-interfacelisp">User Interface Utilites File user-interface.lisp</h3>

<p>In the previous chapter, the function <strong>prompt-selection-list</strong> was defined in the file <strong>kgn-text-ui/kgn-text-ui.lisp</strong> for text based (console) UIs. Here it is implemented in a separate file <strong>user-interface.lisp</strong> in the project directory <strong>kgn-capi-ui</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn-capi-ui</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">;; (use-package "CAPI")</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">prompt-selection-list</code> <code class="p">(</code><code class="nv">a-list-of-choices</code><code class="p">)</code> 
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">ret</code><code class="p">)</code>
<code class="linenos"> 7 </code>    <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">choice</code> <code class="nv">a-list-of-choices</code><code class="p">)</code>
<code class="linenos"> 8 </code>      <code class="p">(</code><code class="nb">setf</code> <code class="nv">choice</code> <code class="p">(</code><code class="nb">remove-if</code> <code class="nf">#'</code><code class="nb">null</code> <code class="nv">choice</code><code class="p">))</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">topic-type</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">choice</code><code class="p">))</code>
<code class="linenos">10 </code>             <code class="p">(</code><code class="nv">choice-list-full</code> <code class="p">(</code><code class="nb">rest</code> <code class="nv">choice</code><code class="p">))</code>
<code class="linenos">11 </code>             <code class="p">(</code><code class="nv">choice-list</code> <code class="p">(</code><code class="nb">remove-duplicates</code>
<code class="linenos">12 </code>                           <code class="p">(</code><code class="nb">map</code> <code class="ss">'list</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">z</code><code class="p">)</code>
<code class="linenos">13 </code>                                          <code class="p">(</code><code class="nb">list</code>
<code class="linenos">14 </code>                                           <code class="nv">z</code> <code class="c1">;; (first z)</code>
<code class="linenos">15 </code>                                           <code class="p">(</code><code class="nv">string-shorten</code>
<code class="linenos">16 </code>                                            <code class="p">(</code><code class="nv">kgn-common:clean-comment</code>
<code class="linenos">17 </code>                                             <code class="p">(</code><code class="nv">kgn-common:clean-comment</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">z</code><code class="p">)))</code>
<code class="linenos">18 </code>                                            <code class="mi">140</code> <code class="ss">:first-remove-stop-words</code> <code class="no">t</code><code class="p">)))</code>
<code class="linenos">19 </code>                                <code class="p">(</code><code class="nb">apply</code> <code class="nf">#'</code><code class="nb">append</code> <code class="nv">choice-list-full</code><code class="p">))</code>
<code class="linenos">20 </code>                           <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">)))</code>
<code class="linenos">21 </code>        <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">dialog-results</code> <code class="p">(</code><code class="nv">alexandria:flatten</code>
<code class="linenos">22 </code>                               <code class="p">(</code><code class="nv">capi:prompt-with-list</code> <code class="c1">;; SHOW SELECTION LIST</code>
<code class="linenos">23 </code>                                   <code class="p">(</code><code class="nb">map</code> <code class="ss">'list</code> <code class="nf">#'</code><code class="nb">second</code> <code class="nv">choice-list</code><code class="p">)</code>
<code class="linenos">24 </code>                                   <code class="p">(</code><code class="nb">symbol-name</code> <code class="nv">topic-type</code><code class="p">)</code>
<code class="linenos">25 </code>                                   <code class="ss">:interaction</code> <code class="ss">:multiple-selection</code>
<code class="linenos">26 </code>                                   <code class="ss">:choice-class</code> <code class="ss">'capi:button-panel</code>
<code class="linenos">27 </code>                                   <code class="ss">:pane-args</code> <code class="o">'</code><code class="p">(</code><code class="ss">:visible-min-width</code> <code class="mi">910</code>
<code class="linenos">28 </code>                                   <code class="ss">:layout-class</code> <code class="nv">capi:column-layout</code><code class="p">))))</code>
<code class="linenos">29 </code>              <code class="p">(</code><code class="nv">ret2</code><code class="p">))</code>
<code class="linenos">30 </code>          <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">x</code> <code class="nv">choice-list</code><code class="p">)</code>
<code class="linenos">31 </code>            <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">find</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">x</code><code class="p">)</code> <code class="nv">dialog-results</code><code class="p">)</code>
<code class="linenos">32 </code>                <code class="p">(</code><code class="nb">setf</code> <code class="nv">ret2</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">car</code> <code class="nv">x</code><code class="p">)</code> <code class="nv">ret2</code><code class="p">))))</code>
<code class="linenos">33 </code>          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">ret2</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">34 </code>              <code class="p">(</code><code class="nb">setf</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">list</code> <code class="nv">topic-type</code> <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret2</code><code class="p">))</code> <code class="nv">ret</code><code class="p">))))))</code>
<code class="linenos">35 </code>    <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code><code class="c1">;; (get-entity-data-helper "Bill Gates went to Seattle to Microsoft")</code>
<code class="linenos">38 </code><code class="c1">;; (prompt-selection-list</code>
<code class="linenos">39 </code><code class="c1">;;   (get-entity-data-helper</code>
<code class="linenos">40 </code><code class="c1">;;     "Bill Gates went to Seattle to Microsoft"))</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-user-interface-capi-options-panes-definition-file-option-panelisp">User Interface CAPI Options Panes Definition File option-pane.lisp</h3>

<p>In the following listing we define functions to implement CAPI menus:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:kgn-capi-ui</code><code class="p">)</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="c1">;; options for:</code>
<code class="linenos">  4 </code><code class="c1">;;  1. programming language to generate code snippets for</code>
<code class="linenos">  5 </code><code class="c1">;;  2. colorization options (do we really need this??)</code>
<code class="linenos">  6 </code><code class="c1">;;  3. show disk space used by caching</code>
<code class="linenos">  7 </code><code class="c1">;;  4. option to remove local disk cache</code>
<code class="linenos">  8 </code>
<code class="linenos">  9 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*width-options-panel*</code> <code class="mi">800</code><code class="p">)</code>
<code class="linenos"> 10 </code>
<code class="linenos"> 11 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">get-cache-disk-space</code> <code class="p">()</code>
<code class="linenos"> 12 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code> <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 13 </code>             <code class="p">(</code><code class="nb">floor</code>
<code class="linenos"> 14 </code>               <code class="p">(</code><code class="nb">/</code>
<code class="linenos"> 15 </code>                <code class="p">(</code><code class="nb">with-open-file</code>
<code class="linenos"> 16 </code>                  <code class="p">(</code><code class="nv">file</code> <code class="s">"~/Downloads/knowledge_graph_navigator_cache.db"</code><code class="p">)</code>
<code class="linenos"> 17 </code>                 <code class="p">(</code><code class="nb">file-length</code> <code class="nv">file</code><code class="p">))</code> <code class="mi">1000</code><code class="p">)))))</code>
<code class="linenos"> 18 </code>    <code class="p">(</code><code class="nb">or</code> <code class="nv">x</code>  <code class="mi">0</code><code class="p">)))</code> <code class="c1">;; units in megabytes</code>
<code class="linenos"> 19 </code>
<code class="linenos"> 20 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">clear-cache-callback</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">val</code><code class="p">)</code>
<code class="linenos"> 21 </code>  <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">val</code><code class="p">))</code>
<code class="linenos"> 22 </code>  <code class="p">(</code><code class="nb">ignore-errors</code> <code class="p">(</code><code class="nb">delete-file</code> <code class="s">"~/Downloads/knowledge_graph_navigator_cache.db"</code><code class="p">)))</code>
<code class="linenos"> 23 </code>
<code class="linenos"> 24 </code><code class="p">(</code><code class="nb">defvar</code> <code class="vg">*code-snippet-language*</code> <code class="no">nil</code><code class="p">)</code>
<code class="linenos"> 25 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">set-prog-lang</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">val</code><code class="p">)</code>
<code class="linenos"> 26 </code>  <code class="p">(</code><code class="nb">format</code> <code class="no">t</code> <code class="s">"* set-prog-lang: val=~S~%"</code> <code class="nv">val</code><code class="p">)</code>
<code class="linenos"> 27 </code>  <code class="p">(</code><code class="nb">setf</code> <code class="vg">*code-snippet-language*</code> <code class="p">(</code><code class="nb">first</code> <code class="nv">val</code><code class="p">)))</code>
<code class="linenos"> 28 </code>
<code class="linenos"> 29 </code><code class="p">(</code><code class="nv">capi:define-interface</code> <code class="nv">options-panel-interface</code> <code class="p">()</code>
<code class="linenos"> 30 </code>  <code class="p">()</code>
<code class="linenos"> 31 </code>  <code class="p">(</code><code class="ss">:panes</code>
<code class="linenos"> 32 </code>   <code class="cm">#|</code>
<code class="linenos"> 33 </code><code class="cm">   (prog-lang-pane</code>
<code class="linenos"> 34 </code><code class="cm">    capi:option-pane</code>
<code class="linenos"> 35 </code><code class="cm">    :items '("No language set" "Python" "Common Lisp")</code>
<code class="linenos"> 36 </code><code class="cm">    :visible-items-count 6</code>
<code class="linenos"> 37 </code><code class="cm">    :selection (if (equal *code-snippet-language* nil)</code>
<code class="linenos"> 38 </code><code class="cm">                   0</code>
<code class="linenos"> 39 </code><code class="cm">                 (if (equal *code-snippet-language* "No language set")</code>
<code class="linenos"> 40 </code><code class="cm">                     0</code>
<code class="linenos"> 41 </code><code class="cm">                   (if (equal *code-snippet-language* "Python")</code>
<code class="linenos"> 42 </code><code class="cm">                       1</code>
<code class="linenos"> 43 </code><code class="cm">                     (if (equal *code-snippet-language* "Common Lisp")</code>
<code class="linenos"> 44 </code><code class="cm">                         2</code>
<code class="linenos"> 45 </code><code class="cm">                       0))))</code>
<code class="linenos"> 46 </code><code class="cm">    :interaction :single-selection</code>
<code class="linenos"> 47 </code><code class="cm">    :selection-callback</code>
<code class="linenos"> 48 </code><code class="cm">    'set-prog-lang)|#</code>
<code class="linenos"> 49 </code>   <code class="p">(</code><code class="nv">disk-space-pane</code>
<code class="linenos"> 50 </code>     <code class="nv">capi:text-input-pane</code>
<code class="linenos"> 51 </code>    <code class="ss">:text</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~A (megabytes)"</code>
<code class="linenos"> 52 </code>                  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">x</code>
<code class="linenos"> 53 </code>                         <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 54 </code>                           <code class="p">(</code><code class="nb">floor</code>
<code class="linenos"> 55 </code>                             <code class="p">(</code><code class="nb">/</code>
<code class="linenos"> 56 </code>                               <code class="p">(</code><code class="nb">with-open-file</code> <code class="p">(</code><code class="nv">file</code> <code class="s">"~/.kgn_cache.db"</code><code class="p">)</code>
<code class="linenos"> 57 </code>                                 <code class="p">(</code><code class="nb">file-length</code> <code class="nv">file</code><code class="p">))</code>
<code class="linenos"> 58 </code>                                <code class="mi">1000</code><code class="p">)))))</code>
<code class="linenos"> 59 </code>                    <code class="p">(</code><code class="k">if</code> <code class="nv">x</code>
<code class="linenos"> 60 </code>                        <code class="nv">x</code>
<code class="linenos"> 61 </code>                      <code class="mi">0</code><code class="p">)))</code>
<code class="linenos"> 62 </code>    <code class="ss">:title</code> <code class="s">"Current size of cache:"</code>
<code class="linenos"> 63 </code>    <code class="ss">:min-width</code> <code class="mi">170</code>
<code class="linenos"> 64 </code>    <code class="ss">:max-width</code> <code class="vg">*width-options-panel*</code><code class="p">)</code>
<code class="linenos"> 65 </code>   <code class="p">(</code><code class="nv">clear-disk-cache-pane</code>
<code class="linenos"> 66 </code>    <code class="nv">capi:push-button-panel</code>
<code class="linenos"> 67 </code>    <code class="c1">;;:title "Clear local query cache:"</code>
<code class="linenos"> 68 </code>    <code class="ss">:items</code> 
<code class="linenos"> 69 </code>    <code class="o">'</code><code class="p">(</code><code class="s">"Clear local query cache"</code><code class="p">)</code>
<code class="linenos"> 70 </code>    <code class="ss">:selection-callback</code> 
<code class="linenos"> 71 </code>    <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="k">&amp;rest</code> <code class="nv">val</code><code class="p">)</code>
<code class="linenos"> 72 </code>        <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">val</code><code class="p">))</code>
<code class="linenos"> 73 </code>        <code class="p">(</code><code class="nb">ignore-errors</code> <code class="p">(</code><code class="nb">delete-file</code> <code class="s">"~/.kgn_cache.db"</code><code class="p">))</code>
<code class="linenos"> 74 </code>        <code class="p">(</code><code class="nb">ignore-errors</code> <code class="p">(</code><code class="nb">setf</code> <code class="p">(</code><code class="nv">capi:text-input-pane-text</code> <code class="nv">disk-space-pane</code><code class="p">)</code>
<code class="linenos"> 75 </code>                             <code class="s">"0 (megabytes)"</code><code class="p">))))</code>
<code class="linenos"> 76 </code>   <code class="p">(</code><code class="nv">toggle-graph-display</code>
<code class="linenos"> 77 </code>    <code class="nv">capi:option-pane</code>
<code class="linenos"> 78 </code>    <code class="ss">:items</code> <code class="o">'</code><code class="p">(</code><code class="s">"Show Graph Info Pane Browser"</code> <code class="s">"Hide Graph Info Pane Browser"</code><code class="p">)</code>
<code class="linenos"> 79 </code>    <code class="ss">:selected-item</code> <code class="p">(</code><code class="k">if</code> <code class="vg">*show-info-pane*</code> <code class="mi">0</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 80 </code>    <code class="c1">;;:title ""</code>
<code class="linenos"> 81 </code>    <code class="ss">:selection-callback</code> <code class="ss">'toggle-grapher-visibility</code><code class="p">))</code>
<code class="linenos"> 82 </code>
<code class="linenos"> 83 </code>  <code class="p">(</code><code class="ss">:layouts</code>
<code class="linenos"> 84 </code>   <code class="p">(</code><code class="nv">main-layout</code>
<code class="linenos"> 85 </code>    <code class="nv">capi:grid-layout</code>
<code class="linenos"> 86 </code>    <code class="o">'</code><code class="p">(</code><code class="no">nil</code> <code class="nv">disk-space-pane</code>
<code class="linenos"> 87 </code>    <code class="no">nil</code> <code class="nv">clear-disk-cache-pane</code><code class="p">)</code>
<code class="linenos"> 88 </code>    <code class="ss">:x-ratios</code> <code class="o">'</code><code class="p">(</code><code class="mi">1</code> <code class="mi">99</code><code class="p">)</code>
<code class="linenos"> 89 </code>    <code class="ss">:has-title-column-p</code> <code class="no">nil</code><code class="p">))</code>
<code class="linenos"> 90 </code>  <code class="p">(</code><code class="ss">:default-initargs</code>
<code class="linenos"> 91 </code>   <code class="ss">:layout</code> <code class="ss">'main-layout</code>
<code class="linenos"> 92 </code>   <code class="ss">:title</code> <code class="s">"Knowledge Graph Navigator Options"</code>
<code class="linenos"> 93 </code>   <code class="ss">:max-width</code> <code class="vg">*width-options-panel*</code><code class="p">))</code>
<code class="linenos"> 94 </code>
<code class="linenos"> 95 </code><code class="c1">;; MAIN entry point for application:</code>
<code class="linenos"> 96 </code>
<code class="linenos"> 97 </code>
<code class="linenos"> 98 </code><code class="c1">;;         (capi:display (make-instance 'options-panel-interface))</code>
<code class="linenos"> 99 </code>
<code class="linenos">100 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">ui2</code> <code class="p">()</code> <code class="p">(</code><code class="nv">capi:display</code> <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'options-panel-interface</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The popup list in the last example looks like:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 90%">
    <img src="images/kgnpopup.png" alt="Popup list shows the user possible entity resolutions for each entity found in the input query. The user selects the resolved entities to use." style="width: 100%">
    <figcaption>Popup list shows the user possible entity resolutions for each entity found in the input query. The user selects the resolved entities to use.</figcaption>
  </figure>
</div>


<p>In this example there were two “Bill Gates” entities, one an early American frontiersman, the other the founder of Microsoft and I chose the latter person to continue finding information about.</p>

<h3 id="leanpub-auto-using-lispworks-capi-ui-toolkit">Using LispWorks CAPI UI Toolkit</h3>

<p>You can use the free LispWorks Personal Edition for running KGN. Using other Common Lisp implementations like Clozure-CL and SBCL will not work because the CAPI user interface library is proprietary to LispWorks. I would like to direct you to three online resources for learning CAPI:</p>

<ul>
  <li>[LispWorks’ main web <a href="http://www.lispworks.com/products/capi.html">age introducing CAPI</a>
</li>
  <li>
<a href="http://www.lispworks.com/products/capi.html">LispWorks’ comprehensive CAPI documentation</a> for LispWorks version 7.1</li>
  <li>An older web site (last updated in 2011 but I find it useful for ideas): <a href="http://capi.plasticki.com/show?O4">CAPI Cookbook</a>
</li>
</ul>

<p>I am not going to spend too much time in this chapter explaining my CAPI-based code. If you use LispWorks (either the free Personal or the Professional editions) you are likely to use CAPI and spending time on the official documentation and especially the included example programs is strongly recommended.</p>

<p>In the next section I will review the KGN specific application parts of the CAPI-based UI.</p>

<p>The following figure shows a popup window displaying a graph of discovered entities and relationships:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 70%">
    <img src="images/info-pane-browser.png" alt="UI for info-pane-grapher" style="width: 100%">
    <figcaption>UI for info-pane-grapher</figcaption>
  </figure>
</div>


<p>Since I just showed the <strong>info-pane-grapher</strong> this is a good time to digress to its implementation. This is in a different package and you will find the source code in <strong>src/lw-grapher/info-pane-grapher.lisp</strong>. I used the graph layout algorithm from <a href="http://www.cs.virginia.edu/~robins/papers/The_ISI_Grapher_Manual.pdf">ISI-Grapher Manual (by Gabriel Robbins)</a>. There is another utility in <strong>src/lw-grapher/lw-grapher.lisp</strong> that also displays a graph without mouse support and an attached information pane that is not used here but you might prefer it for reuse in your projects if you don’t need mouse interactions.</p>

<p>The graph nodes are derived from the class <strong>capi:pinboard-object</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defclass</code> <code class="nv">text-node</code> <code class="p">(</code><code class="nv">capi:pinboard-object</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">((</code><code class="nv">text</code> <code class="ss">:initarg</code> <code class="ss">:text</code> <code class="ss">:reader</code> <code class="nv">text-node-text</code><code class="p">)</code>
<code class="linenos">3 </code>   <code class="p">(</code><code class="nv">string-x-offset</code> <code class="ss">:accessor</code> <code class="nv">text-node-string-x-offset</code><code class="p">)</code>
<code class="linenos">4 </code>   <code class="p">(</code><code class="nv">string-y-offset</code> <code class="ss">:accessor</code> <code class="nv">text-node-string-y-offset</code><code class="p">)))</code>
</pre></div>

</figure>

<p>I customized how my graph nodes are drawn in a graph pane (this is derived from LispWorks example code):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defmethod</code> <code class="nv">capi:draw-pinboard-object</code> <code class="p">(</code><code class="nv">pinboard</code> <code class="p">(</code><code class="nv">self</code> <code class="nv">text-node</code><code class="p">)</code>
<code class="linenos"> 2 </code>                                               <code class="k">&amp;key</code> <code class="k">&amp;allow-other-keys</code><code class="p">)</code>
<code class="linenos"> 3 </code>  <code class="p">(</code><code class="nb">multiple-value-bind</code> <code class="p">(</code><code class="nv">X</code> <code class="nv">Y</code>  <code class="nv">width</code> <code class="nv">height</code><code class="p">)</code>
<code class="linenos"> 4 </code>      <code class="p">(</code><code class="nv">capi:static-layout-child-geometry</code> <code class="nv">self</code><code class="p">)</code>
<code class="linenos"> 5 </code>    <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">half-width</code>  <code class="p">(</code><code class="nb">floor</code> <code class="p">(</code><code class="nb">1-</code> <code class="nv">width</code><code class="p">)</code>  <code class="mi">2</code><code class="p">))</code>
<code class="linenos"> 6 </code>           <code class="p">(</code><code class="nv">half-height</code> <code class="p">(</code><code class="nb">floor</code> <code class="p">(</code><code class="nb">1-</code> <code class="nv">height</code><code class="p">)</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos"> 7 </code>           <code class="p">(</code><code class="nv">circle-x</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">X</code> <code class="nv">half-width</code><code class="p">))</code>
<code class="linenos"> 8 </code>           <code class="p">(</code><code class="nv">circle-y</code> <code class="p">(</code><code class="nb">+</code> <code class="nv">Y</code> <code class="nv">half-height</code><code class="p">))</code>
<code class="linenos"> 9 </code>           <code class="p">(</code><code class="nv">background</code> <code class="ss">:white</code><code class="p">)</code>
<code class="linenos">10 </code>           <code class="p">(</code><code class="nv">foreground</code> <code class="p">(</code><code class="k">if</code> <code class="nv">background</code>
<code class="linenos">11 </code>                           <code class="ss">:black</code>
<code class="linenos">12 </code>                         <code class="p">(</code><code class="nv">capi:simple-pane-foreground</code> <code class="nv">pinboard</code><code class="p">)))</code>
<code class="linenos">13 </code>           <code class="p">(</code><code class="nv">text</code> <code class="p">(</code><code class="nv">text-node-text</code> <code class="nv">self</code><code class="p">)))</code>
<code class="linenos">14 </code>        <code class="p">(</code><code class="nv">gp:draw-ellipse</code> <code class="nv">pinboard</code>
<code class="linenos">15 </code>                           <code class="nv">circle-x</code> <code class="nv">circle-y</code>
<code class="linenos">16 </code>                           <code class="nv">half-width</code> <code class="nv">half-height</code>
<code class="linenos">17 </code>                           <code class="ss">:filled</code> <code class="no">t</code>
<code class="linenos">18 </code>                           <code class="ss">:foreground</code> <code class="nv">background</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="p">(</code><code class="nv">gp:draw-ellipse</code> <code class="nv">pinboard</code>
<code class="linenos">20 </code>                         <code class="nv">circle-x</code> <code class="nv">circle-y</code>
<code class="linenos">21 </code>                         <code class="nv">half-width</code> <code class="nv">half-height</code>
<code class="linenos">22 </code>                         <code class="ss">:foreground</code> <code class="nv">foreground</code><code class="p">)</code>
<code class="linenos">23 </code>        <code class="p">(</code><code class="nv">gp:draw-string</code> <code class="nv">pinboard</code>
<code class="linenos">24 </code>                        <code class="nv">text</code>
<code class="linenos">25 </code>                        <code class="p">(</code><code class="nb">+</code> <code class="nv">X</code> <code class="p">(</code><code class="nv">text-node-string-x-offset</code> <code class="nv">self</code><code class="p">))</code>
<code class="linenos">26 </code>                        <code class="p">(</code><code class="nb">+</code> <code class="nv">Y</code> <code class="p">(</code><code class="nv">text-node-string-y-offset</code> <code class="nv">self</code><code class="p">))</code>
<code class="linenos">27 </code>                        <code class="ss">:foreground</code> <code class="nv">foreground</code><code class="p">))))</code>
</pre></div>

</figure>

<p>Most of the work is done in the graph layout method that uses Gabriel Robbins’ algorithm. Here I just show the signature and we won’t go into implementation. If you are interested in modifying the layout code, I include a screen shot from ISI-Grapher manual showing the algorithm in a single page; see the file <strong>src/lw-grapher/Algorithm from ISI-Grapher Manual.png</strong>.</p>

<p>The following code snippets show the method signature for the layout algorithm function in the file <strong>src/lw-grapher/grapher.lisp</strong>. I also include the call to <strong>capi:graph-pane-nodes</strong> that is the CLOS reader method for getting the list of node objects in a graph pane:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">graph-layout</code> <code class="p">(</code><code class="nv">self</code> <code class="k">&amp;key</code> <code class="nv">force</code><code class="p">)</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">force</code><code class="p">))</code>
<code class="linenos">3 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">nodes</code> <code class="p">(</code><code class="nv">capi:graph-pane-nodes</code> <code class="nv">self</code><code class="p">))</code>
<code class="linenos">4 </code>    <code class="o">...</code>
</pre></div>

</figure>

<p>The CAPI graph node model uses a function that is passed a node object and returns a list of this node’s child node objects. There are several examples of this in the CAPI graph examples that are included with LispWorks (see the CAPI documentation).</p>

<p>In <strong>src/lw-grapher/lw-grapher.lisp</strong> I wrote a function that builds a graph layout and instead of passing in a “return children” function I found it more convenient to wrap this process, accepting a list of graph nodes and graph edges as function arguments:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">:lw-grapher</code><code class="p">)</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="c1">;; A Grapher (using the layout algorithm from the ISI-Grapher</code>
<code class="linenos">  4 </code><code class="c1">;; user guide) with an info panel</code>
<code class="linenos">  5 </code>
<code class="linenos">  6 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">make-info-panel-grapher</code> <code class="p">(</code><code class="nv">h-root-name-list</code> <code class="nv">h-edge-list</code>
<code class="linenos">  7 </code>                                <code class="nv">h-callback-function-click</code>
<code class="linenos">  8 </code>                                <code class="nv">h-callback-function-shift-click</code><code class="p">)</code>
<code class="linenos">  9 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">edges</code> <code class="nv">roots</code> <code class="nv">last-selected-node</code> <code class="nv">node-callback-click</code>
<code class="linenos"> 10 </code>	  <code class="nv">node-callback-click-shift</code> <code class="nv">output-pane</code><code class="p">)</code>
<code class="linenos"> 11 </code>    <code class="p">(</code><code class="k">labels</code>
<code class="linenos"> 12 </code>        <code class="p">((</code><code class="nv">handle-mouse-click-on-pane</code> <code class="p">(</code><code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)</code>
<code class="linenos"> 13 </code>           <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 14 </code>             <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">object</code> <code class="p">(</code><code class="nv">capi:pinboard-object-at-position</code> <code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)))</code>
<code class="linenos"> 15 </code>               <code class="p">(</code><code class="k">if</code> <code class="nv">object</code>
<code class="linenos"> 16 </code>                   <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos"> 17 </code>                     <code class="p">(</code><code class="k">if</code> <code class="nv">last-selected-node</code>
<code class="linenos"> 18 </code>                         <code class="p">(</code><code class="nv">capi:unhighlight-pinboard-object</code> <code class="nv">pane</code>
<code class="linenos"> 19 </code>                             <code class="nv">last-selected-node</code><code class="p">))</code>
<code class="linenos"> 20 </code>                     <code class="p">(</code><code class="nb">setf</code> <code class="nv">last-selected-node</code> <code class="nv">object</code><code class="p">)</code>
<code class="linenos"> 21 </code>                     <code class="p">(</code><code class="nv">capi:highlight-pinboard-object</code> <code class="nv">pane</code> <code class="nv">object</code><code class="p">)</code>
<code class="linenos"> 22 </code>                     <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">c-stream</code> <code class="p">(</code><code class="nv">collector-pane-stream</code> <code class="nv">output-pane</code><code class="p">)))</code> 
<code class="linenos"> 23 </code>                       <code class="p">(</code><code class="nb">format</code> <code class="nv">c-stream</code>
<code class="linenos"> 24 </code>                         <code class="p">(</code><code class="nb">funcall</code> <code class="nv">node-callback-click</code>
<code class="linenos"> 25 </code>                           <code class="p">(</code><code class="nv">text-node-full-text</code> <code class="nv">object</code><code class="p">)))</code>
<code class="linenos"> 26 </code>                       <code class="p">(</code><code class="nb">terpri</code> <code class="nv">c-stream</code><code class="p">)))))))</code>
<code class="linenos"> 27 </code>         <code class="p">(</code><code class="nv">handle-mouse-click-shift-on-pane</code> <code class="p">(</code><code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)</code>
<code class="linenos"> 28 </code>           <code class="p">(</code><code class="nb">ignore-errors</code>
<code class="linenos"> 29 </code>             <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">object</code>
<code class="linenos"> 30 </code>                    <code class="p">(</code><code class="nv">capi:pinboard-object-at-position</code> <code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)))</code>
<code class="linenos"> 31 </code>               <code class="p">(</code><code class="k">if</code> <code class="nv">object</code>
<code class="linenos"> 32 </code>                   <code class="p">(</code><code class="k">let</code> <code class="p">()</code>
<code class="linenos"> 33 </code>                     <code class="p">(</code><code class="k">if</code> <code class="nv">last-selected-node</code>
<code class="linenos"> 34 </code>                         <code class="p">(</code><code class="nv">capi:unhighlight-pinboard-object</code>
<code class="linenos"> 35 </code>                           <code class="nv">pane</code> <code class="nv">last-selected-node</code><code class="p">))</code>
<code class="linenos"> 36 </code>                     <code class="p">(</code><code class="nb">setf</code> <code class="nv">last-selected-node</code> <code class="nv">object</code><code class="p">)</code>
<code class="linenos"> 37 </code>                     <code class="p">(</code><code class="nv">capi:highlight-pinboard-object</code> <code class="nv">pane</code> <code class="nv">object</code><code class="p">)</code>
<code class="linenos"> 38 </code>                     <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">c-stream</code>
<code class="linenos"> 39 </code>                             <code class="p">(</code><code class="nv">collector-pane-stream</code> <code class="nv">output-pane</code><code class="p">)))</code>
<code class="linenos"> 40 </code>                       <code class="p">(</code><code class="nb">format</code> <code class="nv">c-stream</code>
<code class="linenos"> 41 </code>                         <code class="p">(</code><code class="nb">funcall</code> <code class="nv">node-callback-click-shift</code>
<code class="linenos"> 42 </code>                           <code class="p">(</code><code class="nv">text-node-full-text</code> <code class="nv">object</code><code class="p">)))</code>
<code class="linenos"> 43 </code>                       <code class="p">(</code><code class="nb">terpri</code> <code class="nv">c-stream</code><code class="p">)))))))</code>
<code class="linenos"> 44 </code>         
<code class="linenos"> 45 </code>         <code class="p">(</code><code class="nv">info-panel-node-children-helper</code> <code class="p">(</code><code class="nv">node-text</code><code class="p">)</code>
<code class="linenos"> 46 </code>           <code class="p">(</code><code class="k">let</code> <code class="p">(</code><code class="nv">ret</code><code class="p">)</code>
<code class="linenos"> 47 </code>             <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">e</code> <code class="nv">edges</code><code class="p">)</code>
<code class="linenos"> 48 </code>               <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">equal</code> <code class="p">(</code><code class="nb">first</code> <code class="nv">e</code><code class="p">)</code> <code class="nv">node-text</code><code class="p">)</code>
<code class="linenos"> 49 </code>                   <code class="p">(</code><code class="nb">setf</code> <code class="nv">ret</code> <code class="p">(</code><code class="nb">cons</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">e</code><code class="p">)</code> <code class="nv">ret</code><code class="p">))))</code>
<code class="linenos"> 50 </code>             <code class="p">(</code><code class="nb">reverse</code> <code class="nv">ret</code><code class="p">)))</code>
<code class="linenos"> 51 </code>         
<code class="linenos"> 52 </code>         <code class="p">(</code><code class="nv">make-info-panel-grapher-helper</code>
<code class="linenos"> 53 </code>           <code class="p">(</code><code class="nv">root-name-list</code> <code class="nv">edge-list</code> <code class="nv">callback-function-click</code>
<code class="linenos"> 54 </code>            <code class="nv">callback-function-click-shift</code><code class="p">)</code>
<code class="linenos"> 55 </code>           <code class="c1">;; example: root-name-list: '("n1") edge-list:</code>
<code class="linenos"> 56 </code>           <code class="c1">;;   '(("n1" "n2") ("n1" "n3"))</code>
<code class="linenos"> 57 </code>           <code class="p">(</code><code class="nb">setf</code> <code class="nv">edges</code> <code class="nv">edge-list</code>
<code class="linenos"> 58 </code>                 <code class="nv">roots</code> <code class="nv">root-name-list</code>
<code class="linenos"> 59 </code>                 <code class="nv">node-callback-click</code> <code class="nv">callback-function-click</code>
<code class="linenos"> 60 </code>                 <code class="nv">node-callback-click-shift</code> <code class="nv">callback-function-click-shift</code><code class="p">)</code>
<code class="linenos"> 61 </code>           <code class="p">(</code><code class="nv">capi:contain</code> 
<code class="linenos"> 62 </code>
<code class="linenos"> 63 </code>            <code class="p">(</code><code class="nb">make-instance</code>
<code class="linenos"> 64 </code>             <code class="ss">'column-layout</code>
<code class="linenos"> 65 </code>             <code class="ss">:title</code> <code class="s">"Entity Browser"</code>
<code class="linenos"> 66 </code>             <code class="ss">:description</code>
<code class="linenos"> 67 </code>             <code class="p">(</code><code class="nb">list</code>
<code class="linenos"> 68 </code>              <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'capi:graph-pane</code>
<code class="linenos"> 69 </code>                             <code class="ss">:min-height</code> <code class="mi">330</code>
<code class="linenos"> 70 </code>                             <code class="ss">:max-height</code> <code class="mi">420</code>
<code class="linenos"> 71 </code>                             <code class="ss">:roots</code> <code class="nv">roots</code>
<code class="linenos"> 72 </code>                             <code class="ss">:layout-function</code> <code class="ss">'graph-layout</code>
<code class="linenos"> 73 </code>                             <code class="ss">:children-function</code> <code class="nf">#'</code><code class="nv">info-panel-node-children-helper</code>
<code class="linenos"> 74 </code>                             <code class="ss">:edge-pane-function</code> 
<code class="linenos"> 75 </code>                             <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code><code class="p">(</code><code class="nv">self</code> <code class="nv">from</code> <code class="nv">to</code><code class="p">)</code>
<code class="linenos"> 76 </code>                                 <code class="p">(</code><code class="k">declare</code> <code class="p">(</code><code class="k">ignore</code> <code class="nv">self</code><code class="p">))</code>
<code class="linenos"> 77 </code>                                 <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">prop-name</code> <code class="s">""</code><code class="p">))</code>
<code class="linenos"> 78 </code>                                   <code class="p">(</code><code class="nb">dolist</code> <code class="p">(</code><code class="nv">edge</code> <code class="nv">edge-list</code><code class="p">)</code>
<code class="linenos"> 79 </code>                                     <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code>
<code class="linenos"> 80 </code>                                          <code class="p">(</code><code class="nb">equal</code> <code class="nv">from</code> <code class="p">(</code><code class="nb">first</code> <code class="nv">edge</code><code class="p">))</code>
<code class="linenos"> 81 </code>                                          <code class="p">(</code><code class="nb">equal</code> <code class="nv">to</code> <code class="p">(</code><code class="nb">second</code> <code class="nv">edge</code><code class="p">)))</code>
<code class="linenos"> 82 </code>                                         <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">and</code> <code class="p">(</code><code class="nb">&gt;</code> <code class="p">(</code><code class="nb">length</code> <code class="nv">edge</code><code class="p">)</code> <code class="mi">2</code><code class="p">)</code> <code class="p">(</code><code class="nb">third</code> <code class="nv">edge</code><code class="p">))</code>
<code class="linenos"> 83 </code>                                             <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">last-index</code>
<code class="linenos"> 84 </code>                                                     <code class="p">(</code><code class="nb">search</code>
<code class="linenos"> 85 </code>                                                      <code class="s">"/"</code> <code class="p">(</code><code class="nb">third</code> <code class="nv">edge</code><code class="p">)</code> 
<code class="linenos"> 86 </code>                                                      <code class="ss">:from-end</code> <code class="no">t</code><code class="p">)))</code>
<code class="linenos"> 87 </code>                                               <code class="p">(</code><code class="k">if</code> <code class="nv">last-index</code>
<code class="linenos"> 88 </code>                                                   <code class="p">(</code><code class="nb">setf</code> <code class="nv">prop-name</code> 
<code class="linenos"> 89 </code>                                                    <code class="p">(</code><code class="nb">subseq</code> <code class="p">(</code><code class="nb">third</code> <code class="nv">edge</code><code class="p">)</code> 
<code class="linenos"> 90 </code>                                                    <code class="p">(</code><code class="nb">1+</code> <code class="nv">last-index</code><code class="p">)))</code>
<code class="linenos"> 91 </code>                                                 <code class="p">(</code><code class="nb">setf</code> <code class="nv">prop-name</code> <code class="p">(</code><code class="nb">third</code> <code class="nv">edge</code><code class="p">)))))))</code>
<code class="linenos"> 92 </code>                                   <code class="p">(</code><code class="nb">make-instance</code> 
<code class="linenos"> 93 </code>                                    <code class="ss">'capi:labelled-arrow-pinboard-object</code>
<code class="linenos"> 94 </code>                                    <code class="ss">:data</code> <code class="p">(</code><code class="nb">format</code> <code class="no">nil</code> <code class="s">"~A"</code> <code class="nv">prop-name</code><code class="p">))))</code>
<code class="linenos"> 95 </code>                             <code class="ss">:node-pinboard-class</code> <code class="ss">'text-node</code>
<code class="linenos"> 96 </code>                             <code class="ss">:input-model</code> <code class="o">`</code><code class="p">(((</code><code class="ss">:button-1</code> <code class="ss">:release</code><code class="p">)</code>
<code class="linenos"> 97 </code>                                             <code class="o">,</code><code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)</code>
<code class="linenos"> 98 </code>                                                  <code class="p">(</code><code class="nv">handle-mouse-click-on-pane</code> 
<code class="linenos"> 99 </code>                                                    <code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)))</code>
<code class="linenos">100 </code>                                            <code class="p">((</code><code class="ss">:button-1</code> <code class="ss">:release</code> <code class="ss">:shift</code><code class="p">)</code> <code class="c1">;; :press)</code>
<code class="linenos">101 </code>                                             <code class="o">,</code><code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">)</code>
<code class="linenos">102 </code>                                                  <code class="p">(</code><code class="nv">handle-mouse-click-shift-on-pane</code> 
<code class="linenos">103 </code>                                                    <code class="nv">pane</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">))))</code>
<code class="linenos">104 </code>                             <code class="ss">:node-pane-function</code> <code class="ss">'make-text-node</code><code class="p">)</code>
<code class="linenos">105 </code>              <code class="p">(</code><code class="nb">setf</code>
<code class="linenos">106 </code>               <code class="nv">output-pane</code>
<code class="linenos">107 </code>               <code class="p">(</code><code class="nb">make-instance</code> <code class="ss">'capi:collector-pane</code>
<code class="linenos">108 </code>                              <code class="ss">:min-height</code> <code class="mi">130</code>
<code class="linenos">109 </code>                              <code class="ss">:max-height</code> <code class="mi">220</code>
<code class="linenos">110 </code>                              <code class="ss">:title</code> <code class="s">"Message collection pane"</code>
<code class="linenos">111 </code>                              <code class="ss">:text</code> <code class="s">"..."</code>
<code class="linenos">112 </code>                              <code class="ss">:vertical-scroll</code> <code class="no">t</code>
<code class="linenos">113 </code>                              <code class="ss">:horizontal-scroll</code> <code class="no">t</code><code class="p">))))</code>
<code class="linenos">114 </code>            <code class="ss">:title</code> 
<code class="linenos">115 </code>    <code class="s">"Info Pane Browser: mouse click for info, mouse click + shift for web browser"</code>
<code class="linenos">116 </code>            
<code class="linenos">117 </code>            <code class="ss">:best-width</code> <code class="mi">550</code> <code class="ss">:best-height</code> <code class="mi">450</code><code class="p">)))</code>
<code class="linenos">118 </code>      <code class="p">(</code><code class="nv">make-info-panel-grapher-helper</code> <code class="nv">h-root-name-list</code>
<code class="linenos">119 </code>        <code class="nv">h-edge-list</code> <code class="nv">h-callback-function-click</code>
<code class="linenos">120 </code>        <code class="nv">h-callback-function-shift-click</code><code class="p">))))</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrap-up-4">Wrap-up</h3>

<p>This is a long example application for a book so I did not discuss all of the code in the project. If you enjoy running and experimenting with this example and want to modify it for your own projects then I hope that I provided a sufficient road map for you to do so.</p>

<p>I got the idea for the KGN application because I was spending quite a bit of time manually setting up SPARQL queries for DBPedia (and other public sources like WikiData) and I wanted to experiment with partially automating this process. I wrote the CAPI user interface for fun since this example application could have had similar functionality as a command line tool.</p>


<h2 id="leanpub-auto-using-the-openai-apis">Using the OpenAI APIs</h2>

<p>I have been working as an artificial intelligence practitioner since 1982 and the capability of the beta OpenAI APIs is the most impressive thing that I have seen in my career so far. These APIs use the GPT-3 model.</p>

<p>I recommend reading the online documentation for the <a href="https://beta.openai.com/docs/introduction/key-concepts">online documentation for the APIs</a> to see all the capabilities of the beta OpenAI APIs.  Let’s start by jumping into the example code. As seen in the <strong>package.lisp</strong> file we use the <strong>UIOP</strong> and <strong>cl-json</strong> libraries and we export three top level functions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">;;;; package.lisp</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:openai</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:uiop</code> <code class="ss">#:cl-json</code><code class="p">)</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="ss">:export</code> <code class="ss">#:completions</code> <code class="ss">#:summarize</code> <code class="ss">#:answer-question</code><code class="p">))</code>
</pre></div>

</figure>

<p>The library that I wrote for this chapter supports three functions that are exported from the package <strong>openai</strong>: for completing text, summarizing text, and answering general questions. The single OpenAI model that the beta OpenAI APIs use is fairly general purpose and can generate cooking directions when given an ingredient list, grammar correction, write an advertisement from a product description, generate spreadsheet data from data descriptions in English text, etc. </p>

<p>Given the examples from <a href="https://beta.openai.com">https://beta.openai.com</a> and the Common Lisp examples here, you should be able to modify my example code to use any of the functionality that OpenAI documents.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="c1">;;;; openai.asd</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:openai</code>
<code class="linenos">4 </code>  <code class="ss">:description</code> <code class="s">"Library for using the beta OpenAI APIs"</code>
<code class="linenos">5 </code>  <code class="ss">:author</code> <code class="s">"Mark Watson"</code>
<code class="linenos">6 </code>  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
<code class="linenos">7 </code>  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:uiop</code> <code class="ss">#:cl-json</code><code class="p">)</code>
<code class="linenos">8 </code>  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
<code class="linenos">9 </code>               <code class="p">(</code><code class="ss">:file</code> <code class="s">"openai"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>We will look closely at the function <strong>completions</strong> and then just look at the small differences to the other two example functions. The definitions for all three exported functions are kept in the file <strong>openai.lisp</strong>. You need to request an API key (I had to wait a few weeks to recieve my key) and set the value of the environment variable <strong>OPENAI_KEY</strong> to your key. You can add a statement like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">export</code> <code class="n">OPENAI_KEY</code><code class="o">=</code><code class="n">sa</code><code class="o">-</code><code class="n">hdffds7</code><code class="o">&amp;</code><code class="n">dhdhsdgffd</code>
</pre></div>

</figure>

<p>to your <strong>.profile</strong> or other shell resource file.</p>

<p>While I sometimes use pure Common Lisp libraries to make HTTP requests, I prefer running the <strong>curl</strong> utility as a separate process for these reasons:</p>

<ul>
  <li>No problems with system specific dependencies.</li>
  <li>Use the standard library UIOP to run a shell command and capture the output as a string.</li>
  <li>I use <strong>curl</strong> from the command line when experimenting with web services. After I get working <strong>curl</strong> options, it is very easy to translate this into Common Lisp code.</li>
</ul>

<p>An example <strong>curl</strong> command line call to the beta OpenAI APIs is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>curl <code class="se">\</code>
<code class="linenos">2 </code>  https://api.openai.com/v1/engines/davinci/completions <code class="se">\</code>
<code class="linenos">3 </code>   -H <code class="s2">"Content-Type: application/json"</code>
<code class="linenos">4 </code>   -H <code class="s2">"Authorization: Bearer sa-hdffds7&amp;dhdhsdgffd"</code> <code class="se">\</code>
<code class="linenos">5 </code>   -d <code class="s1">'{"prompt": "The President went to Congress", \</code>
<code class="linenos">6 </code><code class="s1">        "max_tokens": 22}'</code>
</pre></div>

</figure>

<p>Here the API token “sa-hdffds7&amp;dhdhsdgffd” on line 4 is made up - that is not my API token. All of the OpenAI APIs expect JSON data with query parameters. To use the completion API, we set values for <strong>prompt</strong> and <strong>max_tokens</strong>. The value of <strong>max_tokens</strong> is the requested number of returns words or tokens. We will look at several examples later.</p>

<p>In the file <strong>openai.lisp</strong> we start with a helper function <strong>openai-helper</strong> that takes a string with the OpenAI API call arguments encoded as a <strong>curl</strong> command, calls the service, and then extracts the results from the returned JSON data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">openai-helper</code> <code class="p">(</code><code class="nv">curl-command</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">response</code>
<code class="linenos"> 3 </code>          <code class="p">(</code><code class="nv">uiop:run-program</code>
<code class="linenos"> 4 </code>           <code class="nv">curl-command</code>
<code class="linenos"> 5 </code>           <code class="ss">:output</code> <code class="ss">:string</code><code class="p">)))</code>
<code class="linenos"> 6 </code>    <code class="p">(</code><code class="nb">with-input-from-string</code>
<code class="linenos"> 7 </code>        <code class="p">(</code><code class="nv">s</code> <code class="nv">response</code><code class="p">)</code>
<code class="linenos"> 8 </code>      <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">json-as-list</code> <code class="p">(</code><code class="nv">json:decode-json</code> <code class="nv">s</code><code class="p">)))</code>
<code class="linenos"> 9 </code>        <code class="c1">;; extract text (this might change if OpenAI changes JSON return format):</code>
<code class="linenos">10 </code>        <code class="p">(</code><code class="nb">cdar</code> <code class="p">(</code><code class="nb">cadr</code> <code class="p">(</code><code class="nb">nth</code> <code class="mi">4</code> <code class="nv">json-as-list</code><code class="p">)))))))</code>
</pre></div>

</figure>

<p>I convert JSON data to a Lisp list in line 8 and in line 10 I reach into the nested results list for the generated text string. You might want to add a debug printout statement to see the value of <strong>json-as-list</strong>.</p>

<p>The three example functions all use this <strong>openai-helper</strong> function. The first example function <strong>completions</strong> sets the parameters to complete a text fragment. You have probably seen examples of the OpenAI GPT-3 model writing stories, given a starting sentence. We are using the same model and functionality here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">completions</code> <code class="p">(</code><code class="nv">starter-text</code> <code class="nv">max-tokens</code><code class="p">)</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">curl-command</code>
<code class="linenos"> 3 </code>          <code class="p">(</code><code class="nb">concatenate</code>
<code class="linenos"> 4 </code>           <code class="ss">'string</code>
<code class="linenos"> 5 </code>           <code class="s">"curl "</code> <code class="nv">open-api-davinci-model-host</code>
<code class="linenos"> 6 </code>           <code class="s">" -H \"Content-Type: application/json\""</code>
<code class="linenos"> 7 </code>           <code class="s">" -H \"Authorization: Bearer "</code> <code class="p">(</code><code class="nv">uiop:getenv</code> <code class="s">"OPENAI_KEY"</code><code class="p">)</code> <code class="s">"\" "</code> 
<code class="linenos"> 8 </code>           <code class="s">" -d '{\"prompt\": \""</code> <code class="nv">starter-text</code> <code class="s">"\", \"max_tokens\": "</code>
<code class="linenos"> 9 </code>           <code class="p">(</code><code class="nb">write-to-string</code> <code class="nv">max-tokens</code><code class="p">)</code>  <code class="s">"}'"</code><code class="p">)))</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="nv">openai-helper</code> <code class="nv">curl-command</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Note that the OpenAI API models are stochastic. When generating output words (or tokens), the model assigns probabilities to possible words to generate and samples a word using these probabilities. As a simple example, suppose given prompt text “it fell and”, then the model could only generate three words, with probabilities for each word based on this prompt text:</p>

<ul>
  <li>the 0.9</li>
  <li>that 0.1</li>
  <li>a 0.1</li>
</ul>

<p>The model would <em>emit</em> the word <strong>the</strong> 90% of the time, the word <strong>that</strong> 10% of the time, or the word <strong>a</strong> 10% of the time. As a result, the model can generate different completion text for the same text prompt. Let’s look at some examples. We request 22 output tokens (words or punctuation) in the first two examples and 100 tokens in the third example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:completions</code> <code class="s">"The President went to Congress"</code> <code class="mi">22</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="s">" yesterday and proposed a single tax rate for all corporate taxpayers, which he env\</code>
<code class="linenos"> 3 </code><code class="s">isions will be lower than what our"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:completions</code> <code class="s">"The President went to Congress"</code> <code class="mi">22</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="s">" last month, asking for authorization of a program, which had previously been appro\</code>
<code class="linenos"> 7 </code><code class="s">ved by the Foreign Intelligence Surveillance court as"</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:completions</code> <code class="s">"The President went to Congress"</code> <code class="mi">100</code><code class="p">)</code>
<code class="linenos">10 </code><code class="s">" worried about what the massive unpopular bill would do to his low approvals. Democ\</code>
<code class="linenos">11 </code><code class="s">rats lost almost every situation to discuss any legislation about this controversial\</code>
<code class="linenos">12 </code><code class="s"> subject. Even more so, President Obama failed and had to watch himself be attacked \</code>
<code class="linenos">13 </code><code class="s">by his own party for not leading.</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="s">There were also two celebrated (in DC) pieces of student loan legislation, which aim\</code>
<code class="linenos">16 </code><code class="s">ed to make college cheaper. Harkin teamed up with Congressman Roddenbery on one, Stu\</code>
<code class="linenos">17 </code><code class="s">dent Loan Affordability Act, and Senator Jack Reed (D"</code>
<code class="linenos">18 </code><code class="nv">cl-user&gt;</code> 
</pre></div>

</figure>

<p>The function <strong>summarize</strong> is very similar to the function <strong>completions</strong> except the JSON data passed to the API has a few additional parameters that let the API know that we want a text summary:</p>

<ul>
  <li>presence_penalty - penalize words found in the original text (we set this to zero)</li>
  <li>temperature - higher values the randomness used to select output tokens. If you set this to zero, then the same prompt text will always yield the same results (I never use a zero value).</li>
  <li>top_p - also affects randomness. All examples I have seen use a value of 1.</li>
  <li>frequency_penalty - penalize using the same words repeatedly (I usually set this to zero, but you should experiment with different values)</li>
</ul>

<p>When summarizing text, try varying the number of generated tokens to get shorter or longer summaries; in the following two examples we ask for 15 output tokens and 50 output tokens:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code> <code class="p">(</code><code class="nb">defvar</code> <code class="nv">s</code> <code class="s">"Jupiter is the fifth planet from the Sun and the largest in the Solar Sy\</code>
<code class="linenos"> 2 </code><code class="s">stem. It is a gas giant with a mass one-thousandth that of the Sun, but two-and-a-ha\</code>
<code class="linenos"> 3 </code><code class="s">lf times that of all the other planets in the Solar System combined. Jupiter is one \</code>
<code class="linenos"> 4 </code><code class="s">of the brightest objects visible to the naked eye in the night sky, and has been kno\</code>
<code class="linenos"> 5 </code><code class="s">wn to ancient civilizations since before recorded history. It is named after the Rom\</code>
<code class="linenos"> 6 </code><code class="s">an god Jupiter.[19] When viewed from Earth, Jupiter can be bright enough for its ref\</code>
<code class="linenos"> 7 </code><code class="s">lected light to cast visible shadows,[20] and is on average the third-brightest natu\</code>
<code class="linenos"> 8 </code><code class="s">ral object in the night sky after the Moon and Venus."</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:summarize</code> <code class="nv">s</code> <code class="mi">15</code><code class="p">)</code>
<code class="linenos">11 </code><code class="s">"Jupiter is a gas giant because it is primarily composed of hydrogen"</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:summarize</code> <code class="nv">s</code> <code class="mi">50</code><code class="p">)</code>
<code class="linenos">14 </code><code class="s">"Jupiter is a gas giant because it is predominantly composed of hydrogen and helium;\</code>
<code class="linenos">15 </code><code class="s"> it has a solid core that is composed of heavier elements. It is the largest of the \</code>
<code class="linenos">16 </code><code class="s">four giant planets in the Solar System and the largest in the Solar System"</code>
</pre></div>

</figure>

<p>The function <strong>answer-question</strong> is very similar to the function <strong>summarize</strong> except the JSON data passed to the API has one additional parameter that let the API know that we want a question answered:</p>

<ul>
  <li>stop - The OpenAI API examples use the value: <strong>[\n]</strong>, which is what I use here.</li>
</ul>

<p>Additionally, the model returns a series of answers with the string “nQ:” acting as a delimiter between the answers. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>     <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">index</code> <code class="p">(</code><code class="nb">search</code> <code class="s">"nQ:"</code> <code class="nv">answer</code><code class="p">)))</code>
<code class="linenos">2 </code>       <code class="p">(</code><code class="k">if</code> <code class="nv">index</code>
<code class="linenos">3 </code>         <code class="p">(</code><code class="nb">string-trim</code> <code class="s">" "</code> <code class="p">(</code><code class="nb">subseq</code> <code class="nv">answer</code> <code class="mi">0</code> <code class="nv">index</code><code class="p">))</code>
<code class="linenos">4 </code>         <code class="p">(</code><code class="nb">string-trim</code> <code class="s">" "</code> <code class="nv">answer</code><code class="p">)))</code>
</pre></div>

</figure>

<p>I strongly urge you to add a debug printout to the question answering code to print the full answer before we check for the delimiter string. For some questions, the OpenAI APIs generate a series of answers that increase in generality. In the example code we just take the most specific answer.</p>

<p>Let’s look at a few question answering examples and we will discuss possible problems and workarounds:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:answer-question</code> <code class="s">"Where is the Valley of Kings?"</code> <code class="mi">60</code><code class="p">)</code>
<code class="linenos">2 </code><code class="s">"It's in Egypt."</code>
</pre></div>

</figure>

<p>Let’s explore some issues with the question answering model. In the last example there is one good answer and the model works well. The next example <strong>“What rivers are in Arizona?”</strong> shows some problems because there are many rivers in Arizona. Sometimes the model misses a few rivers and often river names are repeated in the output. You also don’t necessarily get the same answer for the same input arguments. Here are three examples requesting 70, 90, and 160 output tokens:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:answer-question</code> <code class="s">"What rivers are in Arizona?"</code> <code class="mi">70</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="s">"The Colorado River, the Gila River, the Little Colorado River, the Salt River, the \</code>
<code class="linenos"> 3 </code><code class="s">Verde River, the San Pedro River, the Santa Cruz River, the San Juan River, the Agua\</code>
<code class="linenos"> 4 </code><code class="s"> Fria River, the Hassayampa River, the Bill Williams River, the Little Colorado Rive\</code>
<code class="linenos"> 5 </code><code class="s">r, the San Francisco River, the San Pedro River"</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:answer-question</code> <code class="s">"What rivers are in Arizona?"</code> <code class="mi">90</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="s">"The Colorado River, the Gila River, the Little Colorado River, the Salt River, the \</code>
<code class="linenos"> 9 </code><code class="s">Verde River, the San Pedro River, the Santa Cruz River, the San Juan River, the Agua\</code>
<code class="linenos">10 </code><code class="s"> Fria River, the Hassayampa River, the Bill Williams River, the Little Colorado Rive\</code>
<code class="linenos">11 </code><code class="s">r, the San Francisco River, the San Pedro River, the Santa Cruz River, the San Juan \</code>
<code class="linenos">12 </code><code class="s">River, the Agua Fria River, the Hass"</code>
<code class="linenos">13 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:answer-question</code> <code class="s">"What rivers are in Arizona?"</code> <code class="mi">160</code><code class="p">)</code>
<code class="linenos">14 </code><code class="s">"Colorado, Gila, Salt, Verde, and the Little Colorado."</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:answer-question</code> <code class="s">"What rivers are in Arizona?"</code> <code class="mi">160</code><code class="p">)</code>
<code class="linenos">17 </code><code class="s">"The Colorado River, the Gila River, the Little Colorado River, the Salt River, the \</code>
<code class="linenos">18 </code><code class="s">Verde River, the San Pedro River, the Santa Cruz River, the San Juan River, the Agua\</code>
<code class="linenos">19 </code><code class="s"> Fria River, the Hassayampa River, the Bill Williams River, the Little Colorado Rive\</code>
<code class="linenos">20 </code><code class="s">r, the San Francisco River, the San Pedro River, the Santa Cruz River, the San Juan \</code>
<code class="linenos">21 </code><code class="s">River, the Agua Fria River, the Hassayampa River, the Bill Williams River, the Littl\</code>
<code class="linenos">22 </code><code class="s">e Colorado River, the San Francisco River, the San Pedro River, the Santa Cruz River\</code>
<code class="linenos">23 </code><code class="s">, the San Juan River, the Agua Fria River, the Hassayampa River, the Bill Williams R\</code>
<code class="linenos">24 </code><code class="s">iver, the Little Colorado River, the San Francisco River, the San Pedro River, the S\</code>
<code class="linenos">25 </code><code class="s">anta Cruz"</code>
</pre></div>

</figure>

<p>My library does not handle embedded single quote characters in questions so the question “Who is Bill Clinton’s wife?” will throw an error. Leaving out the single quote character works fine:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">cl-user&gt;</code> <code class="p">(</code><code class="nv">openai:answer-question</code> <code class="s">"Who is Bill Clintons wife?"</code> <code class="mi">120</code><code class="p">)</code>
<code class="linenos">2 </code><code class="s">"Hillary Clinton."</code>
<code class="linenos">3 </code><code class="nv">cl-user&gt;</code> 
</pre></div>

</figure>

<p>In addition to reading the beta OpenAI API documentation you might want to read general material on the use of OpenAI’s GPT-3 model. Since the APIs we are using are beta they may change. I will update this chapter and the source code on GitHub if the APIs change.</p>


<h2 id="leanpub-auto-using-the-hugging-face-deep-learning-natural-language-processing-apis">Using the Hugging Face Deep Learning Natural Language Processing APIs</h2>

<p>TBD</p>


<h2 id="leanpub-auto-using-custom-deep-learning-models-hosted-on-google-colab">Using Custom Deep Learning Models Hosted on Google Colab</h2>

<p>In the last two chapters we have written and used Common Lisp client code for the Open AI NLP APIs and the Hugging Face NLP APIs. While this is a relatively easy way to integrate public pretrained deep learning models into your own Common Lisp projects, if you are skilled at writing your own deep learning models you might want to use the material in the earlier chapter <strong>Using Python Deep Learning Models In Common Lisp With a Web Services Interface</strong> to run your models on your own laptop or server and access them through a web service interface.</p>

<p>In this chapter we take a similar approach using the Google Colab service for running Jupyter style notebooks. As an example we will use a <a href="https://colab.research.google.com/drive/1bM2HWu0sYYsbUpu8X-Hmf4CTuMaSN2wA">Colab notebook that I wrote that uses both SPARQL queries to DBPedia and a pretrained deep learning question/answering model to answer questions from a user</a>.</p>

<p>TBD: remove my ngrok token and make it public</p>


<h2 id="leanpub-auto-using-common-lisp-with-wolframone">Using Common Lisp with Wolfram/One</h2>

<p>If you use <a href="https://www.wolfram.com/wolfram-one/">Wolfram/One</a> then the material in this short chapter may interest you. The interface that I wrote is simple: I use <strong>uiop:run-program</strong> to spawn a new process to run the Wolfram Language command line tool that writes results to a temporary file. I then use <strong>uiop:read-file-string</strong> to read the results and parse them into a convenient form for use.</p>

<p>Before we build and use an interface to Wolfram/One, let’s look at two screen shots of the Wolfram/One interface with examples that we will run later in Common Lisp. The first example finds entities in text:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 90%">
    <img src="images/wolfram1.jpg" alt="Using Wolfram/One to find entities in text" style="width: 100%">
    <figcaption>Using Wolfram/One to find entities in text</figcaption>
  </figure>
</div>


<p>The second example uses a deep learning model to answer a question given text containing the answer to the question:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 90%">
    <img src="images/wolfram2.jpg" alt="Using Wolfram/One to answer natural language questions" style="width: 100%">
    <figcaption>Using Wolfram/One to answer natural language questions</figcaption>
  </figure>
</div>


<p>Here is the <strong>package.lisp</strong> file for this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nb">defpackage</code> <code class="ss">#:wolfram</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="ss">:use</code> <code class="ss">#:cl</code> <code class="ss">#:uiop</code><code class="p">)</code>
<code class="linenos">3 </code>  <code class="p">(</code><code class="ss">:export</code> <code class="ss">#:wolfram</code> <code class="ss">#:cleanup-lists</code>
<code class="linenos">4 </code>           <code class="ss">#:find-answer-in-text</code> <code class="ss">#:entities</code><code class="p">))</code>
</pre></div>

</figure>

<p>And the <strong>wolfram.asd</strong> file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nv">asdf:defsystem</code> <code class="ss">#:wolfram</code>
<code class="linenos">2 </code>  <code class="ss">:description</code> <code class="s">"Wolfram Language interface experiments"</code>
<code class="linenos">3 </code>  <code class="ss">:author</code> <code class="s">"Mark Watson &lt;markw@markwatson.com&gt;"</code>
<code class="linenos">4 </code>  <code class="ss">:license</code> <code class="s">"Apache 2"</code>
<code class="linenos">5 </code>  <code class="ss">:depends-on</code> <code class="p">(</code><code class="ss">#:uiop</code> <code class="ss">#:cl-json</code> <code class="ss">#:myutils</code><code class="p">)</code>
<code class="linenos">6 </code>  <code class="ss">:components</code> <code class="p">((</code><code class="ss">:file</code> <code class="s">"package"</code><code class="p">)</code>
<code class="linenos">7 </code>               <code class="p">(</code><code class="ss">:file</code> <code class="s">"wolfram"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The implementation in <strong>Wolfram.lisp</strong> is simple enough. In lines 6-8 I create a Common Lisp <em>path</em> object in <strong>/tmp</strong> (and absolute pathname is required) and then use <strong>file-namestring</strong> to get just the file name as a string. In lines 8-10 we are creating an operating system shell and running the Wolfram Language command line tool with arguments to execute the query and write the results to the temporary file. In lines 11-15 we read the contents of the temporary file, delete the file, and decode the returned string as JSON data.</p>

<p>The Data returned form calling the Wolfram Language command line tool contains excess structure that we don’t need (a sample of the raw returned data is shown later) so the function <strong>cleanup-lists</strong> shown in lines 17-19 discards heads of lists when the first value in a list or sublist is <em>Rule</em> or <em>List</em>. The function <strong>recursive-remove</strong> seen in lines 20-24 will remove all occurrences of an item from a nested list.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nb">in-package</code> <code class="ss">#:wolfram</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">;; General query utilities</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">wolfram</code> <code class="p">(</code><code class="nv">statement</code><code class="p">)</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="k">let</code> <code class="p">((</code><code class="nv">temp-file-path</code>
<code class="linenos"> 7 </code>         <code class="p">(</code><code class="nb">file-namestring</code> <code class="p">(</code><code class="nv">uiop:tmpize-pathname</code> <code class="s">"/tmp/wolfram"</code><code class="p">))))</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nv">uiop:run-program</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"wolframscript -code 'Export[\""</code>
<code class="linenos"> 9 </code>                                   <code class="nv">temp-file-path</code> <code class="s">"\","</code> <code class="nv">statement</code>
<code class="linenos">10 </code>                                   <code class="s">",\"ExpressionJSON\"]'"</code><code class="p">))</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">ret</code> <code class="p">(</code><code class="nv">uiop:read-file-string</code> <code class="nv">temp-file-path</code><code class="p">)))</code>
<code class="linenos">12 </code>      <code class="p">(</code><code class="nb">delete-file</code> <code class="nv">temp-file-path</code><code class="p">)</code>
<code class="linenos">13 </code>      <code class="p">(</code><code class="nb">with-input-from-string</code> <code class="p">(</code><code class="nv">s</code> <code class="p">(</code><code class="nv">myutils:replace-all</code>
<code class="linenos">14 </code>                                  <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="nv">ret</code> <code class="s">"\"'"</code> <code class="s">"\""</code><code class="p">)</code> <code class="s">"'\""</code> <code class="s">"\""</code><code class="p">))</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="nv">json:decode-json</code> <code class="nv">s</code><code class="p">)))))</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">cleanup-lists</code> <code class="p">(</code><code class="nv">r</code><code class="p">)</code>
<code class="linenos">18 </code>  <code class="p">(</code><code class="nb">cdr</code> <code class="p">(</code><code class="nv">recursive-remove</code> <code class="s">"Rule"</code> <code class="p">(</code><code class="nv">recursive-remove</code> <code class="s">"List"</code> <code class="nv">r</code><code class="p">))))</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">recursive-remove</code> <code class="p">(</code><code class="nv">item</code> <code class="nv">tree</code><code class="p">)</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nb">atom</code> <code class="nv">tree</code><code class="p">)</code>
<code class="linenos">22 </code>      <code class="nv">tree</code>
<code class="linenos">23 </code>      <code class="p">(</code><code class="nb">mapcar</code> <code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">nested-list</code><code class="p">)</code> <code class="p">(</code><code class="nv">recursive-remove</code> <code class="nv">item</code> <code class="nv">nested-list</code><code class="p">))</code>
<code class="linenos">24 </code>              <code class="p">(</code><code class="nb">remove</code> <code class="nv">item</code> <code class="nv">tree</code> <code class="ss">:test</code> <code class="nf">#'</code><code class="nb">equal</code><code class="p">))))</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="c1">;; Higher level utilities for specific types of queries</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">entities</code> <code class="p">(</code><code class="nv">text</code><code class="p">)</code>
<code class="linenos">29 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">noquotes</code> <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="nv">text</code> <code class="s">"\""</code> <code class="s">" "</code><code class="p">)</code> <code class="s">"'"</code> <code class="s">" "</code><code class="p">))</code>
<code class="linenos">30 </code>         <code class="p">(</code><code class="nv">query2</code>
<code class="linenos">31 </code>          <code class="p">(</code><code class="nb">concatenate</code>
<code class="linenos">32 </code>           <code class="ss">'string</code> <code class="s">"TextCases['"</code> <code class="nv">noquotes</code>
<code class="linenos">33 </code>           <code class="s">"',  {'City', 'Country', 'Date', 'Person'} -&gt;"</code>
<code class="linenos">34 </code>           <code class="s">" {'String', 'Interpretation', 'Probability'}]"</code><code class="p">))</code>
<code class="linenos">35 </code>         <code class="p">(</code><code class="nv">query</code> <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="nv">query2</code> <code class="s">"'"</code> <code class="s">"\""</code><code class="p">)))</code>
<code class="linenos">36 </code>    <code class="p">(</code><code class="nb">remove-if</code> <code class="nf">#'</code><code class="p">(</code><code class="k">lambda</code> <code class="p">(</code><code class="nv">a</code><code class="p">)</code> <code class="p">(</code><code class="nb">null</code> <code class="p">(</code><code class="nb">cadr</code> <code class="nv">a</code><code class="p">)))</code>
<code class="linenos">37 </code>               <code class="p">(</code><code class="nv">cleanup-lists</code> <code class="p">(</code><code class="nv">wolfram</code> <code class="nv">query</code><code class="p">)))))</code>
<code class="linenos">38 </code>
<code class="linenos">39 </code><code class="p">(</code><code class="nb">defun</code> <code class="nv">find-answer-in-text</code> <code class="p">(</code><code class="nv">text</code> <code class="nv">question</code><code class="p">)</code>
<code class="linenos">40 </code>  <code class="p">(</code><code class="k">let*</code> <code class="p">((</code><code class="nv">nqtext</code> <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="nv">text</code> <code class="s">"\""</code> <code class="s">" "</code><code class="p">)</code> <code class="s">"'"</code> <code class="s">" "</code><code class="p">))</code>
<code class="linenos">41 </code>         <code class="p">(</code><code class="nv">nqquestion</code> <code class="p">(</code><code class="nv">myutils:replace-all</code>
<code class="linenos">42 </code>                      <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="nv">question</code> <code class="s">"\""</code> <code class="s">" "</code><code class="p">)</code> <code class="s">"'"</code> <code class="s">" "</code><code class="p">))</code>
<code class="linenos">43 </code>         <code class="p">(</code><code class="nv">query2</code> <code class="p">(</code><code class="nb">concatenate</code> <code class="ss">'string</code> <code class="s">"FindTextualAnswer['"</code> <code class="nv">nqtext</code>
<code class="linenos">44 </code>                              <code class="s">"', '"</code> <code class="nv">nqquestion</code> <code class="s">"']"</code><code class="p">))</code>
<code class="linenos">45 </code>         <code class="p">(</code><code class="nv">query</code> <code class="p">(</code><code class="nv">myutils:replace-all</code> <code class="nv">query2</code> <code class="s">"'"</code> <code class="s">"\""</code><code class="p">)))</code>
<code class="linenos">46 </code>    <code class="p">(</code><code class="nv">wolfram</code> <code class="nv">query</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The last two functions in the last code listing, <strong>entities</strong> and <strong>find-answer-in-text</strong> are higher level functions intended to work with the Wolfram Language procedures <strong>TextCases</strong> (see <a href="https://reference.wolfram.com/language/ref/TextCases.html">Wolfram documentation for TextCases</a>) and <strong>FindTextualAnswer</strong> (see <a href="https://reference.wolfram.com/language/ref/FindTextualAnswer.html">Wolfram documentation for FindTextualAnswer</a>).</p>

<p>The functions <strong>cleanup-lists</strong> and <strong>recursive-remove</strong> can be used to clean up results. First, we will just call function <strong>wolfram</strong> and show the raw results:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">$</code> <code class="n">sbcl</code>
<code class="linenos"> 2 </code><code class="o">*</code> <code class="p">(</code><code class="nl">ql</code><code class="p">:</code><code class="n">quickload</code> <code class="s">"wolfram"</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="n">To</code> <code class="n">load</code> <code class="s">"wolfram"</code><code class="o">:</code>
<code class="linenos"> 4 </code>  <code class="n">Load</code> <code class="mi">1</code> <code class="n">ASDF</code> <code class="nl">system</code><code class="p">:</code>
<code class="linenos"> 5 </code>    <code class="n">wolfram</code>
<code class="linenos"> 6 </code><code class="p">;</code> <code class="n">Loading</code> <code class="s">"wolfram"</code>
<code class="linenos"> 7 </code><code class="p">[</code><code class="n">package</code> <code class="n">myutils</code><code class="p">].................................</code>
<code class="linenos"> 8 </code><code class="p">[</code><code class="n">package</code> <code class="n">wolfram</code><code class="p">]</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="s">"wolfram"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="n">example</code> <code class="s">"TextCases['NYC, Los Angeles, and Chicago are the largest cities in \</code>
<code class="linenos">11 </code><code class="s">the USA in 2018 according to Pete Wilson.', {'City', 'Country', 'Date', 'Person'} -&gt;\</code>
<code class="linenos">12 </code><code class="s"> {'String', 'Interpretation', 'Probability'}]"</code><code class="p">)</code>
<code class="linenos">13 </code><code class="s">"TextCases['NYC, Los Angeles, and Chicago are the largest cities in the USA in 2018 \</code>
<code class="linenos">14 </code><code class="s">according to Pete Wilson.', {'City', 'Country', 'Date', 'Person'} -&gt; {'String', 'Int\</code>
<code class="linenos">15 </code><code class="s">erpretation', 'Probability'}]"</code>
<code class="linenos">16 </code><code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="n">example</code><code class="o">-</code><code class="n">str</code> <code class="p">(</code><code class="nl">myutils</code><code class="p">:</code><code class="n">replace</code><code class="o">-</code><code class="n">all</code>  <code class="n">example</code> <code class="s">"'"</code> <code class="s">"</code><code class="se">\"</code><code class="s">"</code><code class="p">))</code>
<code class="linenos">17 </code><code class="s">"TextCases[</code><code class="se">\"</code><code class="s">NYC, Los Angeles, and Chicago are the largest cities in the USA in 2018\</code>
<code class="linenos">18 </code><code class="s"> according to Pete Wilson.</code><code class="se">\"</code><code class="s">, {</code><code class="se">\"</code><code class="s">City</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">Country</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">Date</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">Person</code><code class="se">\"</code><code class="s">} -&gt; {</code><code class="se">\"</code><code class="s">St\</code>
<code class="linenos">19 </code><code class="s">ring</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">Interpretation</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">Probability</code><code class="se">\"</code><code class="s">}]"</code>
<code class="linenos">20 </code><code class="o">*</code> <code class="p">(</code><code class="n">setf</code> <code class="n">results</code> <code class="p">(</code><code class="nl">wolfram</code><code class="p">:</code><code class="n">wolfram</code> <code class="n">example</code><code class="o">-</code><code class="n">str</code><code class="p">))</code>
<code class="linenos">21 </code><code class="o">*</code> <code class="p">(</code><code class="n">pprint</code> <code class="n">results</code><code class="p">)</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="p">(</code><code class="s">"Association"</code>
<code class="linenos">24 </code> <code class="p">(</code><code class="s">"Rule"</code> <code class="s">"City"</code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="s">"List"</code>
<code class="linenos">26 </code>   <code class="p">(</code><code class="s">"List"</code> <code class="s">"NYC"</code> <code class="p">(</code><code class="s">"Entity"</code> <code class="s">"City"</code> <code class="p">(</code><code class="s">"List"</code> <code class="s">"NewYork"</code> <code class="s">"NewYork"</code> <code class="s">"UnitedStates"</code><code class="p">))</code>
<code class="linenos">27 </code>    <code class="mf">0.75583166</code><code class="p">)</code>
<code class="linenos">28 </code>   <code class="p">(</code><code class="s">"List"</code> <code class="s">"Los Angeles"</code>
<code class="linenos">29 </code>    <code class="p">(</code><code class="s">"Entity"</code> <code class="s">"City"</code> <code class="p">(</code><code class="s">"List"</code> <code class="s">"LosAngeles"</code> <code class="s">"California"</code> <code class="s">"UnitedStates"</code><code class="p">))</code>
<code class="linenos">30 </code>    <code class="mf">0.84206486</code><code class="p">)</code>
<code class="linenos">31 </code>   <code class="p">(</code><code class="s">"List"</code> <code class="s">"Chicago"</code>
<code class="linenos">32 </code>    <code class="p">(</code><code class="s">"Entity"</code> <code class="s">"City"</code> <code class="p">(</code><code class="s">"List"</code> <code class="s">"Chicago"</code> <code class="s">"Illinois"</code> <code class="s">"UnitedStates"</code><code class="p">))</code>
<code class="linenos">33 </code>    <code class="mf">0.91092855</code><code class="p">)))</code>
<code class="linenos">34 </code> <code class="p">(</code><code class="s">"Rule"</code> <code class="s">"Country"</code>
<code class="linenos">35 </code>  <code class="p">(</code><code class="s">"List"</code> <code class="p">(</code><code class="s">"List"</code> <code class="s">"USA"</code> <code class="p">(</code><code class="s">"Entity"</code> <code class="s">"Country"</code> <code class="s">"UnitedStates"</code><code class="p">)</code> <code class="mf">0.9285077</code><code class="p">)))</code>
<code class="linenos">36 </code> <code class="p">(</code><code class="s">"Rule"</code> <code class="s">"Date"</code>
<code class="linenos">37 </code>  <code class="p">(</code><code class="s">"List"</code>
<code class="linenos">38 </code>   <code class="p">(</code><code class="s">"List"</code> <code class="s">"2018"</code> <code class="p">(</code><code class="s">"DateObject"</code> <code class="p">(</code><code class="s">"List"</code> <code class="mi">2018</code><code class="p">)</code> <code class="s">"Year"</code> <code class="s">"Gregorian"</code> <code class="mf">-7.0</code><code class="p">)</code>
<code class="linenos">39 </code>    <code class="mf">0.8364356</code><code class="p">)))</code>
<code class="linenos">40 </code> <code class="p">(</code><code class="s">"Rule"</code> <code class="s">"Person"</code>
<code class="linenos">41 </code>  <code class="p">(</code><code class="s">"List"</code>
<code class="linenos">42 </code>   <code class="p">(</code><code class="s">"List"</code> <code class="s">"Pete Wilson"</code> <code class="p">(</code><code class="s">"Entity"</code> <code class="s">"Person"</code> <code class="s">"PeteWilson::s7259"</code><code class="p">)</code> <code class="mf">0.9274548</code><code class="p">))))</code>
<code class="linenos">43 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>Now we clean up the output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">*</code> <code class="p">(</code><code class="n">defvar</code> <code class="n">results</code><code class="o">-</code><code class="n">cleaned</code> <code class="p">(</code><code class="n">wolfram</code><code class="p">:</code><code class="n">cleanup</code><code class="o">-</code><code class="n">lists</code> <code class="n">results</code><code class="p">))</code>
<code class="linenos"> 2 </code><code class="o">*</code> <code class="p">(</code><code class="n">pprint</code> <code class="n">results</code><code class="o">-</code><code class="n">cleaned</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">((</code><code class="s2">"City"</code>
<code class="linenos"> 5 </code>  <code class="p">((</code><code class="s2">"NYC"</code> <code class="p">(</code><code class="s2">"Entity"</code> <code class="s2">"City"</code> <code class="p">(</code><code class="s2">"NewYork"</code> <code class="s2">"NewYork"</code> <code class="s2">"UnitedStates"</code><code class="p">))</code> <code class="mf">0.75583166</code><code class="p">)</code>
<code class="linenos"> 6 </code>   <code class="p">(</code><code class="s2">"Los Angeles"</code> <code class="p">(</code><code class="s2">"Entity"</code> <code class="s2">"City"</code> <code class="p">(</code><code class="s2">"LosAngeles"</code> <code class="s2">"California"</code> <code class="s2">"UnitedStates"</code><code class="p">))</code>
<code class="linenos"> 7 </code>    <code class="mf">0.84206486</code><code class="p">)</code>
<code class="linenos"> 8 </code>   <code class="p">(</code><code class="s2">"Chicago"</code> <code class="p">(</code><code class="s2">"Entity"</code> <code class="s2">"City"</code> <code class="p">(</code><code class="s2">"Chicago"</code> <code class="s2">"Illinois"</code> <code class="s2">"UnitedStates"</code><code class="p">))</code>
<code class="linenos"> 9 </code>    <code class="mf">0.91092855</code><code class="p">)))</code>
<code class="linenos">10 </code> <code class="p">(</code><code class="s2">"Country"</code> <code class="p">((</code><code class="s2">"USA"</code> <code class="p">(</code><code class="s2">"Entity"</code> <code class="s2">"Country"</code> <code class="s2">"UnitedStates"</code><code class="p">)</code> <code class="mf">0.9285077</code><code class="p">)))</code>
<code class="linenos">11 </code> <code class="p">(</code><code class="s2">"Date"</code> <code class="p">((</code><code class="s2">"2018"</code> <code class="p">(</code><code class="s2">"DateObject"</code> <code class="p">(</code><code class="mi">2018</code><code class="p">)</code> <code class="s2">"Year"</code> <code class="s2">"Gregorian"</code> <code class="o">-</code><code class="mf">7.0</code><code class="p">)</code> <code class="mf">0.8364356</code><code class="p">)))</code>
<code class="linenos">12 </code> <code class="p">(</code><code class="s2">"Person"</code> <code class="p">((</code><code class="s2">"Pete Wilson"</code> <code class="p">(</code><code class="s2">"Entity"</code> <code class="s2">"Person"</code> <code class="s2">"PeteWilson::s7259"</code><code class="p">)</code> <code class="mf">0.9274548</code><code class="p">))))</code>
<code class="linenos">13 </code><code class="o">*</code> 
</pre></div>

</figure>

<p>Next we will try the two higher-level utility functions. The first example shows finding entities in text:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">CL-USER</code> <code class="mi">21</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nb">pprint</code>
<code class="linenos">2 </code>               <code class="p">(</code><code class="nv">wolfram:entities</code> <code class="s">"Sedona Arizona is home to Mark Louis Watson"</code><code class="p">))</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="p">((</code><code class="s">"City"</code>
<code class="linenos">5 </code>  <code class="p">((</code><code class="s">"Sedona"</code> <code class="p">(</code><code class="s">"Entity"</code> <code class="s">"City"</code> <code class="p">(</code><code class="s">"Sedona"</code> <code class="s">"Arizona"</code> <code class="s">"UnitedStates"</code><code class="p">))</code> <code class="mf">0.8392784</code><code class="p">)))</code>
<code class="linenos">6 </code> <code class="p">(</code><code class="s">"Person"</code> <code class="p">((</code><code class="s">"Mark Louis Watson"</code> <code class="s">"Mark Louis Watson"</code> <code class="mf">0.9023427</code><code class="p">))))</code>
</pre></div>

</figure>

<p>The second example uses a Wolfram pre-trained deep learning model for question answering:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">CL-USER</code> <code class="mi">22</code> <code class="nb">&gt;</code> <code class="p">(</code><code class="nb">pprint</code>
<code class="linenos"> 2 </code>               <code class="p">(</code><code class="nv">wolfram::find-answer-in-text</code> <code class="s">"International Business Machines Corpor\</code>
<code class="linenos"> 3 </code><code class="s">ation (IBM) is an American multinational technology company headquartered in Armonk,\</code>
<code class="linenos"> 4 </code><code class="s"> New York, with operations in over 170 countries. The company began in 1911, founded\</code>
<code class="linenos"> 5 </code><code class="s"> in Endicott, New York, as the Computing-Tabulating-Recording Company (CTR) and was \</code>
<code class="linenos"> 6 </code><code class="s">renamed \"International Business Machines\" in 1924. IBM is incorporated in New York\</code>
<code class="linenos"> 7 </code><code class="s">."</code>
<code class="linenos"> 8 </code>                            <code class="s">"where is IBM is headquartered?"</code><code class="p">))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="s">"Armonk, New York"</code>
</pre></div>

</figure>

<p>If you use Wolfram/One then these examples should get you started wrapping other Wolfram Language functionality for use in your Common Lisp applications.</p>


<h2 id="leanpub-auto-software-architecture-for-common-lisp-projects">Software Architecture for Common Lisp Projects</h2>

<p>TBD</p>

<h3 id="leanpub-auto-general-principles-of-light-weight-software-architecture">General Principles of Light Weight Software Architecture</h3>

<p>TBD</p>

<h3 id="leanpub-auto-specific-requirements-and-techniques-for-architecting-systems-developed-in-common-lisp">Specific Requirements and Techniques for Architecting Systems Developed in Common Lisp</h3>

<p>TBD</p>


<h2 id="leanpub-auto-book-wrapup">Book Wrapup</h2>

<p>Congratulations for finishing this book!</p>

<p>I love programming in Lisp languages with concise code and a bottom-up approach to development. I hope you now also share this enthusiasm with me.</p>

<p>Common Lisp is sometimes criticised as not having as many useful libraries as some newer languages like Python and Java, and this is a valid criticism. That said, I hope the wide variety of examples in this book will convince you that Common Lisp is a good choice for many types of programming projects.</p>

<p>I would like to thank you for reading my book and I hope that you enjoyed it. As I mentioned in the <a href="#introduction">Introduction</a> I have been using Common Lisp since the mid-1980s, and other Lisp dialects for longer than that. I have always found something almost magical developing in Lisp. Being able to extend the language with macros and using the development technique of building a mini-language in Lisp customized for an application enables programmers to be very efficient in their work. I have usually found that this bottom-up development style helps me deal with software complexity because the lower level functions tend to get well tested while the overall system being developed is not yet too complex to fully understand. Later in the development process these lower level functions and utilities almost become part of the programming language and the higher level application logic is easier to understand because you have fewer lines of code to fit inside your head during development.</p>

<p>I think that unless a programmer works in very constrained application domains, it often makes sense to be a polyglot programmer. I have tried, especially in the new material for this fourth edition, to give you confidence that Common Lisp is good for both general software development language and also as “glue” to tie different systems together.</p>

<p>Thank you for buying and reading my book!</p>

<p>Mark Watson</p>

</div>
</body>
</html>
