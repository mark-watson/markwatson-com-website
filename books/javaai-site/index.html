<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Practical Artificial Intelligence Programming With Java</title>
  <link href="stylesheet.css" rel="stylesheet" />
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJNL6DY9ZQ"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MJNL6DY9ZQ');
      </script>
 
</head>
<body dir="" class="lfm">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-personal-artificial-intelligence-journey'>Personal Artificial Intelligence Journey</a>
      </li>
      <li>
        <a href='#leanpub-auto-maven-setup-for-combining-examples-in-this-book'>Maven Setup for Combining Examples in this Book</a>
      </li>
      <li>
        <a href='#leanpub-auto-software-licenses-for-example-programs-in-this-book'>Software Licenses for Example Programs in this Book</a>
      </li>
      <li>
        <a href='#leanpub-auto-acknowledgements'>Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#search'>Search</a>
    <ul>
      <li>
        <a href='#leanpub-auto-representation-of-search-state-space-and-search-operators'>Representation of Search State Space and Search Operators</a>
      </li>
      <li>
        <a href='#leanpub-auto-finding-paths-in-mazes'>Finding Paths in Mazes</a>
      </li>
      <li>
        <a href='#leanpub-auto-finding-paths-in-graphs'>Finding Paths in Graphs</a>
      </li>
      <li>
        <a href='#leanpub-auto-adding-heuristics-to-breadth-first-search'>Adding Heuristics to Breadth-first Search</a>
      </li>
      <li>
        <a href='#leanpub-auto-heuristic-search-and-game-playing-tic-tac-toe-and-chess'>Heuristic Search and Game Playing: Tic-Tac-Toe and Chess</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#reasoning'>Reasoning</a>
    <ul>
      <li>
        <a href='#leanpub-auto-logic'>Logic</a>
      </li>
      <li>
        <a href='#powerloom-overview'>PowerLoom Overview</a>
      </li>
      <li>
        <a href='#running-powerloom'>Running PowerLoom Interactively</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-powerloom-apis-in-java-programs'>Using the PowerLoom APIs in Java Programs</a>
      </li>
      <li>
        <a href='#leanpub-auto-suggestions-for-further-study'>Suggestions for Further Study</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-anomaly-detection-machine-learning-example'>Anomaly Detection Machine Learning Example</a>
    <ul>
      <li>
        <a href='#leanpub-auto-motivation-for-anomaly-detection'>Motivation for Anomaly Detection</a>
      </li>
      <li>
        <a href='#leanpub-auto-math-primer-for-anomaly-detection'>Math Primer for Anomaly Detection</a>
      </li>
      <li>
        <a href='#leanpub-auto-anomalydetection-utility-class'>AnomalyDetection Utility Class</a>
      </li>
      <li>
        <a href='#leanpub-auto-example-using-the-university-of-wisconsin-cancer-data'>Example Using the University of Wisconsin Cancer Data</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#ga'>Genetic Algorithms</a>
    <ul>
      <li>
        <a href='#leanpub-auto-theory'>Theory</a>
      </li>
      <li>
        <a href='#java-ga-lib'>Java Library for Genetic Algorithms</a>
      </li>
      <li>
        <a href='#java-ga-example'>Finding the Maximum Value of a Function</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#neural-networks'>Neural Networks</a>
    <ul>
      <li>
        <a href='#leanpub-auto-road-map-for-the-neural-network-example-code'>Road Map for the Neural Network Example Code</a>
      </li>
      <li>
        <a href='#backprop'>Backpropagation Neural Networks</a>
      </li>
      <li>
        <a href='#nn-bp-lib'>A Java Class Library for Back Propagation</a>
      </li>
      <li>
        <a href='#nn-bprop-momentum'>Adding Momentum to Speed Up Back-Prop Training</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-for-neural-networks'>Wrap-up for Neural Networks</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#dl4j'>Deep Learning Using Deeplearning4j</a>
    <ul>
      <li>
        <a href='#leanpub-auto-feed-forward-classification-networks'>Feed Forward Classification Networks</a>
      </li>
      <li>
        <a href='#leanpub-auto-feed-forward-example'>Feed Forward Example</a>
      </li>
      <li>
        <a href='#leanpub-auto-configuring-the-example-using-maven'>Configuring the Example Using Maven</a>
      </li>
      <li>
        <a href='#leanpub-auto-documentation-for-other-types-of-deep-learning-layers'>Documentation for Other Types of Deep Learning Layers</a>
      </li>
      <li>
        <a href='#leanpub-auto-running-the-dl4j-example-programs-and-modifying-them-for-your-use'>Running the DL4J Example Programs and Modifying Them For Your Use</a>
      </li>
      <li>
        <a href='#leanpub-auto-modifying-the-character-generating-lstm-example-to-model-and-generate-csv-spreadsheet-data'>Modifying the Character Generating LSTM Example to Model and Generate CSV Spreadsheet Data</a>
      </li>
      <li>
        <a href='#zoo'>Roadmap for the DL4J Model Zoo</a>
      </li>
      <li>
        <a href='#leanpub-auto-deep-learning-wrapup'>Deep Learning Wrapup</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-natural-language-processing'>Natural Language Processing</a>
    <ul>
      <li>
        <a href='#leanpub-auto-overview-of-the-nlp--library-and-running-the-examples'>Overview of the NLP  Library and Running the Examples</a>
      </li>
      <li>
        <a href='#tokenizing-and-tagging'>Tokenizing, Stemming, and Part of Speech Tagging Text</a>
      </li>
      <li>
        <a href='#named-entity-extraction'>Named Entity Extraction From Text</a>
      </li>
      <li>
        <a href='#leanpub-auto-automatically-assigning-categories-to-text'>Automatically Assigning Categories to Text</a>
      </li>
      <li>
        <a href='#text-clustering'>Text Clustering</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrapup'>Wrapup</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#opennlp'>Natural Language Processing Using OpenNLP</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-opennlp-pre-trained-models'>Using OpenNLP Pre-Trained Models</a>
      </li>
      <li>
        <a href='#leanpub-auto-training-a-new-categorization-model-for-opennlp'>Training a New Categorization Model for OpenNLP</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-our-new-trained-classification-model'>Using Our New Trained Classification Model</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-opennlp-parsing-model'>Using the OpenNLP Parsing Model</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-combining-the-wordnet-linguistic-database-with-opennlp'>Combining the WordNet Linguistic Database With OpenNLP</a>
    <ul>
      <li>
        <a href='#stat-nlp-wordnet'>Using the WordNet Linguistic Database</a>
      </li>
      <li>
        <a href='#leanpub-auto-installing-the-libraries-and-linguistic-data-for-this-example'>Installing the Libraries and Linguistic Data for this Example</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementation'>Implementation</a>
      </li>
      <li>
        <a href='#leanpub-auto-other-type-relationships-supported-by-wordnet'>Other Type Relationships Supported by WordNet</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-and-ideas-for-using-wordnet'>Wrap-up and Ideas for Using WordNet</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-information-gathering'>Information Gathering</a>
    <ul>
      <li>
        <a href='#leanpub-auto-web-scraping-examples'>Web Scraping Examples</a>
      </li>
      <li>
        <a href='#'> </a>
      </li>
      <li>
        <a href='#leanpub-auto-dbpedia-entity-lookup'>DBPedia Entity Lookup</a>
      </li>
      <li>
        <a href='#leanpub-auto-client-for-geonames-service'>Client for GeoNames Service</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-for-information-gathering'>Wrap-up for Information Gathering</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#ner'>Resolve Entity Names to DBPedia References</a>
    <ul>
      <li>
        <a href='#leanpub-auto-dbpedia-entities'>DBPedia Entities</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-for-resolving-entity-names-to-dbpedia-references'>Wrap-up for Resolving Entity Names to DBPedia References</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#semantic-web'>Semantic Web</a>
    <ul>
      <li>
        <a href='#leanpub-auto-available-tools'>Available Tools</a>
      </li>
      <li>
        <a href='#rdms-problems'>Relational Database Model Has Problems Dealing with Rapidly Changing Data Requirements</a>
      </li>
      <li>
        <a href='#leanpub-auto-rdf-the-universal-data-format'>RDF: The Universal Data Format</a>
      </li>
      <li>
        <a href='#rdfs'>Extending RDF with RDF Schema</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-sparql-query-language'>The SPARQL Query Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-jena'>Using Jena</a>
      </li>
      <li>
        <a href='#owl'>OWL: The Web Ontology Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-semantic-web-wrap-up'>Semantic Web Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgcreator'>Automatically Generating Data for Knowledge Graphs</a>
    <ul>
      <li>
        <a href='#leanpub-auto-implementation-notes'>Implementation Notes</a>
      </li>
      <li>
        <a href='#leanpub-auto-generating-rdf-data'>Generating RDF Data</a>
      </li>
      <li>
        <a href='#leanpub-auto-kgcreator-wrap-up'>KGCreator Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgn'>Knowledge Graph Navigator</a>
    <ul>
      <li>
        <a href='#leanpub-auto-entity-types-handled-by-kgn'>Entity Types Handled by KGN</a>
      </li>
      <li>
        <a href='#leanpub-auto-general-design-of-kgn-with-example-output'>General Design of KGN with Example Output</a>
      </li>
      <li>
        <a href='#leanpub-auto-uml-class-diagram-for-example-application'>UML Class Diagram for Example Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementation-1'>Implementation</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-conclusions'>Conclusions</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="lfm">
<h2 id="leanpub-auto-preface">Preface</h2>

<p>The latest edition of this book is always available at <a href="https://leanpub.com/javaai">https://leanpub.com/javaai</a>.  You can also download a free copy from <a href="https://markwatson.com/books">my website</a>. Currently the latest edition was released in the summer of 2020. It had been seven years since the previous edition and this is largely a rewrite, dropping some material like Drools based expert systems, Weka for machine learning, and the implementation of an RDF server with geolocation support. I am now placing a heavier emphasis on neural networks and deep learning, a greatly expanded discussion of the semantic web and linked data including examples to generate knowledge graphs automatically from text documents and also a system to help navigate public Knowledge Graphs like DBPedia and WikiData.</p>

<p>The code and PDF for the 4th edition from 2013 can be <a href="https://github.com/mark-watson/Java-AI-Book-Code_4th_edition">found here</a>.</p>

<p>I decided which material to keep from old editions and which new material to add based on what my estimation is of which AI technologies are most useful and interesting to Java developers.</p>

<p>I have been developing commercial Artificial Intelligence (AI) tools and applications since the 1980s.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 153px">
    <img src="images/Mark.png" alt="Mark Watson" title="Mark Watson" style="width: 100%">
    <figcaption>Mark Watson</figcaption>
  </figure>
</div>


<p>I wrote this book for both professional programmers and home hobbyists who already know how to program in Java and who want to learn practical AI programming and information processing techniques. I have tried to make this an enjoyable book to work through. In the style of a “cook book,” the chapters can be studied in any order. When an example depends on a library developed in a previous chapter this is stated clearly. Most chapters follow the same pattern: a motivation for learning a technique, some theory for the technique, and a Java example program that you can experiment with.</p>

<p>The code for the example programs is available on <strong>github</strong>:</p>

<p><a href="https://github.com/mark-watson/Java-AI-Book-Code">https://github.com/mark-watson/Java-AI-Book-Code</a></p>

<p>My Java code in this book can be used under either or both the LGPL3 and Apache 2 licenses - choose whichever of these two licenses that works best for you. Git pull requests with code improvements will be appreciated by me and the readers of this book.</p>

<p>My goal is to introduce you to common AI techniques and to provide you with Java source code to save you some time and effort. Even though I have worked almost exclusively in the field of deep learning in the last six years, I urge you, dear reader, to look at the field of AI as being far broader than machine learning and deep learning in particular. Just as it is wrong to consider the higher level fields of Category Theory or Group Theory to “be” mathematics, there is far more to AI than machine learning. Here we will take a more balanced view of AI, and indeed, my own current research is in hybrid AI, that is, the fusion of deep learning with good old fashioned symbolic AI, probabilistic reasoning, and explainability. </p>

<p>This book is released with a <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)</a> license. Feel free to share copies of this book with friends and colleagues at work. This book is also available to <a href="https://leanpub.com/javaai">read free online or to purchase</a> if you want to support my writing activities.</p>

<h3 id="leanpub-auto-personal-artificial-intelligence-journey">Personal Artificial Intelligence Journey</h3>

<p>I have been interested in AI since reading Bertram Raphael’s excellent book <em>Thinking Computer: Mind Inside Matter</em> in the early 1980s. I have also had the good fortune to work on many interesting AI projects including the development of commercial expert system tools for the Xerox LISP machines and the Apple Macintosh, development of commercial neural network tools, application of natural language and expert systems technology, medical information systems, application of AI technologies to Nintendo and PC video games, and the application of AI technologies to the financial markets. I have also applied statistical natural language processing techniques to analyzing social media data from Twitter and Facebook. I worked at Google on their Knowledge Graph and I managed a deep learning team at Capital One.</p>

<p>I enjoy AI programming, and hopefully this enthusiasm will also infect you, the reader.</p>

<h3 id="leanpub-auto-maven-setup-for-combining-examples-in-this-book">Maven Setup for Combining Examples in this Book</h3>

<p>The chapter on WordNet uses the examples from the previous chapter on OpenNLP. Both chapters discuss the use of maven to support this code and data sharing.</p>

<p>Additionally, the chapter Statistical Natural Language Processing is configured so the code and linguistic data can be combined with other examples.</p>

<p>Code sharing is achieved by installing the code in your local maven repository, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    cd Java-AI-Book-Code/opennlp
<code class="linenos">2 </code>    mvn install
</pre></div>

</figure>

<p>Now, the code in the OpenNLP example is installed on your system.</p>

<h3 id="leanpub-auto-software-licenses-for-example-programs-in-this-book">Software Licenses for Example Programs in this Book</h3>

<p>My example programs (i.e., the code I wrote) are licensed under the LGPL version 3 and the Apache 2. Use whichever of these two licenses that works better for you. I also use several open source libraries in the book examples and their licenses are:</p>

<ul>
  <li>PowerLoom Reasoning: LGPL</li>
  <li>Jena Semantic Web: Apache 2</li>
  <li>OpenNlp: Apache 2</li>
  <li>WordNet: MIT style license (<a href="https://wordnet.princeton.edu/license-and-commercial-use">link to license</a>)</li>
  <li>Deep Learning for Java (DL4J): Apache 2</li>
</ul>

<p>My desire is for you to be able to use my code examples and data in your projects with no hassles.</p>

<h3 id="leanpub-auto-acknowledgements">Acknowledgements</h3>

<p>I process the manuscript for this book using the <a href="http://leanpub.com">leanpub.com</a> publishing system and I recommend leanpub.com to other authors. Write one manuscript and use leanpub.com to generate assets for PDF, iPad/iPhone, and Kindle versions. It is also simple to push new book updates to readers.</p>

<p>I would like to thank Kevin Knight for writing a flexible framework for game search algorithms in <em>Common LISP</em> (Rich, Knight 1991) and for giving me permission to reuse his framework, rewritten in Java for some of the examples in the <a href="#search">Chapter on Search</a>. I would like to thank my friend Tom Munnecke for my photo in this Preface. I have a library full of books on AI and I would like to thank the authors of all of these books for their influence on my professional life. I frequently reference books in the text that have been especially useful to me and that I recommend to my readers.</p>

<p>In particular, I would like to thank the authors of the following two books that have probably had the most influence on me:</p>

<ul>
  <li>Stuart Russell and Peter Norvig’s <strong>Artificial Intelligence: A Modern Approach</strong> which I consider to be the best single reference book for AI theory</li>
  <li>John Sowa’s book <strong>Knowledge Representation</strong> is a resource that I turn to for a holistic treatment of logic, philosophy, and knowledge representation in general</li>
</ul>

<p><strong>Book Editor: Carol Watson</strong></p>

<p>Thanks to the following people who found typos in this and earlier book editions: Carol Watson, James Fysh, Joshua Cranmer, Jack Marsh, Jeremy Burt, Jean-Marc Vanel</p>


<h2 id="search">Search</h2>

<p>Unless you write the AI for game programs and entertainment systems (which I have done for Angel Studios, Nintendo, and Disney), the material in the chapter may not be relevant to your work. That said I recommend that you develop some knowledge of defining search spaces for problems and techniques to search these spaces. I hope that you have fun with the material in this chapter.</p>

<p>Early AI research emphasized the optimization of search algorithms. At this time in the 1950s and 1960s this approach made sense because many AI tasks can be solved effectively by defining state spaces and using search algorithms to define and explore search trees in this state space. This approach for AI research encountered some early success in game playing systems like checkers and chess which reinforced confidence in viewing many AI problems as search problems.</p>

<p>I now consider this form of classic search to be a well understood problem but that does not mean that we will not see exciting improvements in search algorithms in the future. This book does not cover Monte Carlo Search or game search using Reinforcement Learning with Monte Carlo Search that Alpha Go uses.</p>

<p>We will cover depth-first and breadth-first search. The basic implementation for depth-first and breadth-first search is the same with one key difference. When searching from any location in state space we start by calculating nearby locations that can be moved to in one search cycle. For depth-first search we store new locations to be searched in a stack data structure and for breadth-first search we store new locations to search in a queue data structure. As we will shortly see this simple change has a large impact on search quality (usually breadth-first search will produce better results) and computational resources (depth-first search requires less storage).</p>

<p>It is customary to cover search in AI books but to be honest I have only used search techniques in one interactive planning system in the 1980s and much later while doing the “game AI” in two Nintendo games, a PC hovercraft racing game and a VR system for Disney. Still, you should understand how to optimize search.</p>

<p>What are the limitations of search? Early on, success in applying search to problems like checkers and chess misled early researchers into underestimating the extreme difficulty of writing software that performs tasks in domains that require general world knowledge or deal with complex and changing environments. These types of problems usually require the understanding and the implementation of domain specific knowledge.</p>

<p>In this chapter, we will use three search problem domains for studying search algorithms: path finding in a maze, path finding in a graph, and alpha-beta search in the games tic-tac-toe and chess.</p>

<p>If you want to try the examples before we proceed to the implementation then you can do that right now using the <strong>Makefile</strong> in the <strong>search</strong> directory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nf">chess</code><code class="o">:</code>
	mvn install
	mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"search.game.Chess"</code>

<code class="nf">graph</code><code class="o">:</code>
	mvn install
	mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"search.graph.GraphDepthFirstSearch"</code>

<code class="nf">maze</code><code class="o">:</code>
	mvn install
	mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"search.maze.MazeBreadthFirstSearch"</code>
</pre></div>

</figure>

<p>You can run the examples using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>make maze
make graph
make chess
</pre></div>

</figure>

<h3 id="leanpub-auto-representation-of-search-state-space-and-search-operators">Representation of Search State Space and Search Operators</h3>

<p>We will use a single search tree representation in graph search and maze search examples in this chapter. Search trees consist of nodes that define locations in state space and links to other nodes. For some small problems, the search tree can be pre-computed and cover all of the search space. For most problems however it is impossible to completely enumerate a search tree for a state space so we must define successor node search operators that for a given node produce all nodes that can be reached from the current node in one step. For example, in the game of chess we can not possibly enumerate the search tree for all possible games of chess, so we define a successor node search operator that given a board position (represented by a node in the search tree) calculates all possible moves for either the white or black pieces. The possible
Chess moves are calculated by a successor node search operator and are represented by newly calculated nodes that are linked to the previous node. Note that even when it is simple to fully enumerate a search tree, as in the small maze example, we still want to use the general implementation strategy of generating the search tree dynamically as we will do in this chapter.</p>

<p>For calculating a search tree we use a graph. We will represent graphs as nodes with links between some of the nodes. For solving puzzles and for game related search, we will represent positions in the search space with Java objects called nodes. Nodes contain arrays of references to child nodes and for some applications we also might store links back to parent nodes. A search space using this node representation can be viewed as a <strong>directed graph</strong> or a <strong>tree</strong>. The node that has no parent nodes is the root node and all nodes that have no child nodes a called leaf nodes.</p>

<p>Search operators are used to move from one point in the search space to another. We deal with quantized search spaces in this chapter, but search spaces can also be continuous in some applications (e.g., a robot’s position while moving in the real world). In general search spaces are either very large or are infinite. We implicitly define a search space using some algorithm for extending the space from our reference position in the space. The figure <a href="#searchspace">Search Space Representations</a>
shows representations of search space as both connected nodes in a graph
and as a two-dimensional grid with arrows indicating possible movement
from a reference point denoted by <strong>R</strong>.</p>


<div class="figure-wrapper center">
  <figure id="searchspace" class="image" style="width: 362px">
    <img src="images/search_space.png" alt="Search Space Representations" style="width: 100%">
    <figcaption>Search Space Representations</figcaption>
  </figure>
</div>


<p>When we specify a search space as a two-dimensional array, search
operators will move the point of reference in the search space from a
specific grid location to an adjoining grid location. For some
applications, search operators are limited to moving up/down/left/right
and in other applications operators can additionally move the reference
location diagonally.</p>

<p>When we specify a search space using node representation, search operators can move the reference point down to any child node or up to the parent node. For search spaces that are represented implicitly, search operators are also responsible for determining legal child nodes, if any, from the reference point.</p>

<p>Note that I created different libraries for the maze and graph search examples.</p>

<h3 id="leanpub-auto-finding-paths-in-mazes">Finding Paths in Mazes</h3>

<p>The example program used in this section is <strong>MazeSearch.java</strong> in the
directory <strong>search/src/main/java/search/maze</strong> and I assume that you have cloned the <a href="https://github.com/mark-watson/Java-AI-Book-Code">GitHub repository for this book</a>. The figure <a href="#search-uml">UML Diagram for Search Classes</a> shows an overview of
the maze search strategies: depth-first and breadth-first search. The abstract base class <strong>AbstractSearchEngine</strong>
contains common code and data that is required by both the classes <strong>DepthFirstSearch</strong> and <strong>BreadthFirstSearch</strong>. The class <strong>Maze</strong> is used to
record the data for a two-dimensional maze, including which grid locations contain walls or obstacles. The class <strong>Maze</strong> defines three
static short integer values used to indicate obstacles, the starting location, and the ending location.</p>


<div class="figure-wrapper center">
  <figure id="search-uml" class="image" style="width: 440px">
    <img src="images/search_uml.png" alt="UML Diagram for Search Classes" style="width: 100%">
    <figcaption>UML Diagram for Search Classes</figcaption>
  </figure>
</div>


<p>The Java class <strong>Maze</strong> defines the search space. This class allocates a two-dimensional array of short integers to represent the state of any grid location in the maze. Whenever we need to store a pair of integers,
we will use an instance of the standard Java class <strong>java.awt.Dimension</strong>, which has two integer data components: width and height. Whenever we
need to store an x-y grid location, we create a new Dimension object (if required), and store the x coordinate in <strong>Dimension.width</strong> and the y coordinate in <strong>Dimension.height</strong>. As in the right-hand side of figure <a href="#searchspace">Search Space</a>, the operator for moving through the search space from given x-y coordinates allows a transition to any adjacent grid location that is empty. The Maze class also contains the x-y location for the starting location (<strong>startLoc</strong>) and goal location (<strong>goalLoc</strong>). Note that for these examples, the class Maze sets the starting location to grid coordinates 0-0 (upper left corner of the maze in the figures to follow) and the goal node in (width - 1) - (height - 1) (lower right corner in the following figures).</p>

<p>The abstract class <strong>AbstractSearchEngine</strong> is the base class for both the
depth-first (uses a stack to store moves) search class
<strong>DepthFirstSearchEngine</strong> and the breadth-first (uses a queue to store moves) search class <strong>BreadthFirstSearchEngine</strong>. We will start by looking
at the common data and behavior defined in <strong>AbstractSearchEngine</strong>. The
class constructor has two required arguments: the width and height of the maze, measured in grid cells. The constructor defines an instance of
the <strong>Maze</strong> class of the desired size and then calls the utility method initSearch to allocate an array <strong>searchPath</strong> of <strong>Dimension</strong> objects, which will be used to record the path traversed through the maze. The abstract base class also defines other utility methods:</p>

<ul>
  <li>
<strong>equals(Dimension d1, Dimension d2)</strong> – checks to see if two
arguments of type <strong>Dimension</strong> are the same.</li>
  <li>
<strong>getPossibleMoves(Dimension location)</strong> – returns an array of
<strong>Dimension</strong> objects that can be moved to from the specified
location. This implements the movement operator.</li>
</ul>

<p>Now, we will look at the depth-first search procedure. The constructor
for the derived class <strong>DepthFirstSearchEngine</strong> calls the base class
constructor and then solves the search problem by calling the method
<strong>iterateSearch</strong>. We will look at this method in some detail. The
arguments to <strong>iterateSearch</strong> specify the current location and the
current search depth:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">iterateSearch</code><code class="p">(</code><code class="n">Dimension</code> <code class="n">loc</code><code class="p">,</code> <code class="kt">int</code> <code class="n">depth</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>The class variable <strong>isSearching</strong> is used to halt search, avoiding more
solutions, once one path to the goal is found.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="k">if</code> <code class="p">(</code><code class="n">isSearching</code> <code class="o">==</code> <code class="kc">false</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
</pre></div>

</figure>

<p>We set the maze value to the depth for display purposes only:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">maze</code><code class="p">.</code><code class="na">setValue</code><code class="p">(</code><code class="n">loc</code><code class="p">.</code><code class="na">width</code><code class="p">,</code> <code class="n">loc</code><code class="p">.</code><code class="na">height</code><code class="p">,</code> <code class="p">(</code><code class="kt">short</code><code class="p">)</code><code class="n">depth</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here, we use the super class <strong>getPossibleMoves</strong> method to get an array
of possible neighboring squares that we could move to; we then loop over
the four possible moves (a null value in the array indicates an illegal
move):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">Dimension</code> <code class="o">[]</code> <code class="n">moves</code> <code class="o">=</code> <code class="n">getPossibleMoves</code><code class="p">(</code><code class="n">loc</code><code class="p">);</code>
      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">4</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="k">break</code><code class="p">;</code> <code class="c1">// out of possible moves</code>
                                     <code class="c1">// from this location</code>
</pre></div>

</figure>

<p>Record the next move in the search path array and check to see if we are
done:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">searchPath</code><code class="o">[</code><code class="n">depth</code><code class="o">]</code> <code class="o">=</code> <code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
      <code class="k">if</code> <code class="p">(</code><code class="n">equals</code><code class="p">(</code><code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">,</code> <code class="n">goalLoc</code><code class="p">))</code> <code class="p">{</code>
         <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Found the goal at "</code> <code class="o">+</code>
                            <code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">.</code><code class="na">width</code> <code class="o">+</code>
                            <code class="err">``</code><code class="p">,</code> <code class="s">" + moves[i].height);</code>
<code class="s">         isSearching = false;</code>
<code class="s">         maxDepth = depth;</code>
<code class="s">         return;</code>
<code class="s">      } else {</code>
</pre></div>

</figure>

<p>If the next possible move is not the goal move, we recursively call the iterateSearch method again, but starting from this new location and increasing the depth counter by one:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">iterateSearch</code><code class="p">(</code><code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">,</code> <code class="n">depth</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">isSearching</code> <code class="o">==</code> <code class="kc">false</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The <a href="#search-depth-maze">figure showing the depth-first search in a maze</a> shows how poor a path a depth-first search can find between the start and goal locations in the maze. The maze is a 10-by-10 grid. The letter S marks the starting location in the upper left corner and the goal position is marked with a G in the lower right corner of the grid. Blocked grid cells are painted light gray. The basic problem with the depth-first search is that the search engine will often start searching in a bad direction, but still find a path eventually, even given a poor start. The advantage of a depth-first search over a
breadth-first search is that the depth-first search requires much less memory. We will see that possible moves for depth-first search are stored on a stack (last in, first out data structure) and possible moves for a breadth-first search are stored in a queue (first in, first out data structure).</p>


<div class="figure-wrapper center">
  <figure id="search-depth-maze" class="image" style="width: 181px">
    <img src="images/search_depth.png" alt="Depth-first search of a maze" style="width: 100%">
    <figcaption>Depth-first search of a maze</figcaption>
  </figure>
</div>


<p>The derived class <strong>BreadthFirstSearch</strong> is similar to the
<strong>DepthFirstSearch</strong> procedure with one major difference: from a specified
search location we calculate all possible moves, and make one possible
trial move at a time. We use a queue data structure for storing possible
moves, placing possible moves on the back of the queue as they are
calculated, and pulling test moves from the front of the queue. The
effect of a breadth-first search is that it “fans out” uniformly from
the starting node until the goal node is found.</p>

<p>The class constructor for <strong>BreadthFirstSearch</strong> calls the super class
constructor to initialize the maze, and then uses the auxiliary method
<strong>doSearchOn2Dgrid</strong> for performing a breadth-first search for the goal.
We will look at the class <strong>BreadthFirstSearch</strong> in some detail. Breadth
first search uses a queue instead of a stack (depth-first search) to
store possible moves. The utility class <strong>DimensionQueue</strong> implements a
standard queue data structure that handles instances of the class
<strong>Dimension</strong>.</p>

<p>The method <strong>doSearchOn2Dgrid</strong> is not recursive, it uses a loop to add
new search positions to the end of an instance of class <strong>DimensionQueue</strong>
and to remove and test new locations from the front of the queue. The
two-dimensional array <strong>allReadyVisited</strong> keeps us from searching the same
location twice. To calculate the shortest path after the goal is found,
we use the predecessor array:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="kd">private</code> <code class="kt">void</code> <code class="nf">doSearchOn2DGrid</code><code class="p">()</code> <code class="p">{</code>
          <code class="kt">int</code> <code class="n">width</code> <code class="o">=</code> <code class="n">maze</code><code class="p">.</code><code class="na">getWidth</code><code class="p">();</code>
          <code class="kt">int</code> <code class="n">height</code> <code class="o">=</code> <code class="n">maze</code><code class="p">.</code><code class="na">getHeight</code><code class="p">();</code>
          <code class="kt">boolean</code> <code class="n">alReadyVisitedFlag</code><code class="o">[][]</code> <code class="o">=</code>
                  <code class="k">new</code> <code class="kt">boolean</code><code class="o">[</code><code class="n">width</code><code class="o">][</code><code class="n">height</code><code class="o">]</code><code class="p">;</code>
          <code class="n">Dimension</code> <code class="n">predecessor</code><code class="o">[][]</code> <code class="o">=</code>
                <code class="k">new</code> <code class="n">Dimension</code><code class="o">[</code><code class="n">width</code><code class="o">][</code><code class="n">height</code><code class="o">]</code><code class="p">;</code>
          <code class="n">DimensionQueue</code> <code class="n">queue</code> <code class="o">=</code>
                        <code class="k">new</code> <code class="n">DimensionQueue</code><code class="p">();</code>
          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">width</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="n">height</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
              <code class="n">alReadyVisitedFlag</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">j</code><code class="o">]</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
              <code class="n">predecessor</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">j</code><code class="o">]</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
            <code class="p">}</code>
          <code class="p">}</code>
</pre></div>

</figure>

<p>We start the search by setting the already visited flag for the starting location to true value and adding the starting location to the back of the queue:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>          <code class="n">alReadyVisitedFlag</code><code class="o">[</code><code class="n">startLoc</code><code class="p">.</code><code class="na">width</code><code class="o">][</code><code class="n">startLoc</code><code class="p">.</code><code class="na">height</code><code class="o">]</code>
             <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
          <code class="n">queue</code><code class="p">.</code><code class="na">addToBackOfQueue</code><code class="p">(</code><code class="n">startLoc</code><code class="p">);</code>
          <code class="kt">boolean</code> <code class="n">success</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
</pre></div>

</figure>

<p>This outer loop runs until either the queue is empty or the goal is
found:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">outer</code><code class="p">:</code>      
          <code class="k">while</code> <code class="p">(</code><code class="n">queue</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">()</code> <code class="o">==</code> <code class="kc">false</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>We peek at the <strong>Dimension</strong> object at the front of the queue (but do not
remove it) and get the adjacent locations to the current position in the
maze:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>            <code class="n">Dimension</code> <code class="n">head</code> <code class="o">=</code> <code class="n">queue</code><code class="p">.</code><code class="na">peekAtFrontOfQueue</code><code class="p">();</code>
            <code class="n">Dimension</code> <code class="o">[]</code> <code class="n">connected</code> <code class="o">=</code>
                             <code class="n">getPossibleMoves</code><code class="p">(</code><code class="n">head</code><code class="p">);</code>
</pre></div>

</figure>

<p>We loop over each possible move; if the possible move is valid (i.e., not null) and if we have not already visited the possible move location, then we add the possible move to the back of the queue and set the predecessor array for the new location to the last square visited (head is the value from the front of the queue). If we find the goal, break out of the loop:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">4</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="k">break</code><code class="p">;</code>
              <code class="kt">int</code> <code class="n">w</code> <code class="o">=</code> <code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">.</code><code class="na">width</code><code class="p">;</code>
              <code class="kt">int</code> <code class="n">h</code> <code class="o">=</code> <code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">.</code><code class="na">height</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">alReadyVisitedFlag</code><code class="o">[</code><code class="n">w</code><code class="o">][</code><code class="n">h</code><code class="o">]</code> <code class="o">==</code> <code class="kc">false</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">alReadyVisitedFlag</code><code class="o">[</code><code class="n">w</code><code class="o">][</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
                <code class="n">predecessor</code><code class="o">[</code><code class="n">w</code><code class="o">][</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="n">head</code><code class="p">;</code>
                <code class="n">queue</code><code class="p">.</code><code class="na">addToBackOfQueue</code><code class="p">(</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">equals</code><code class="p">(</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">,</code> <code class="n">goalLoc</code><code class="p">))</code> <code class="p">{</code>
                  <code class="n">success</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
                  <code class="k">break</code> <code class="n">outer</code><code class="p">;</code> <code class="c1">// we are done</code>
                <code class="p">}</code>
              <code class="p">}</code>
            <code class="p">}</code>
</pre></div>

</figure>

<p>We have processed the location at the front of the queue (in the
variable head), so remove it:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>            <code class="n">queue</code><code class="p">.</code><code class="na">removeFromFrontOfQueue</code><code class="p">();</code>
          <code class="p">}</code>
</pre></div>

</figure>

<p>Now that we are out of the main loop, we need to use the predecessor
array to get the shortest path. Note that we fill in the <strong>searchPath</strong>
array in reverse order, starting with the goal location:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>          <code class="n">maxDepth</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">success</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">searchPath</code><code class="o">[</code><code class="n">maxDepth</code><code class="o">++]</code> <code class="o">=</code> <code class="n">goalLoc</code><code class="p">;</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
              <code class="n">searchPath</code><code class="o">[</code><code class="n">maxDepth</code><code class="o">]</code> <code class="o">=</code>
                 <code class="n">predecessor</code><code class="o">[</code><code class="n">searchPath</code><code class="o">[</code><code class="n">maxDepth</code> <code class="o">-</code> <code class="mi">1</code><code class="o">]</code><code class="p">.</code>
                   <code class="n">width</code><code class="o">][</code><code class="n">searchPath</code><code class="o">[</code><code class="n">maxDepth</code> <code class="o">-</code> <code class="mi">1</code><code class="o">]</code><code class="p">.</code>
                   <code class="n">height</code><code class="o">]</code><code class="p">;</code>
              <code class="n">maxDepth</code><code class="o">++</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">equals</code><code class="p">(</code><code class="n">searchPath</code><code class="o">[</code><code class="n">maxDepth</code> <code class="o">-</code> <code class="mi">1</code><code class="o">]</code><code class="p">,</code>
                         <code class="n">startLoc</code><code class="p">))</code>
                <code class="k">break</code><code class="p">;</code>  <code class="c1">// back to starting node</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>The <a href="#search-breadth-maze">figure of breadth search of a maze</a> shows a good path solution between starting and goal nodes. Starting from the initial position, the breadth-first search engine adds all possible moves to the back of a queue data structure. For each possible move added to this queue in one search cycle, all possible moves are added to the queue for each new move recorded. Visually, think of possible moves added to the queue as “fanning out” like a wave from the starting location. The breadth-first search engine stops when this “wave” reaches the goal location. In general, I prefer breadth-first search techniques to depth-first search techniques when memory storage for the queue used in the search process is not an issue. In general, the memory requirements for performing depth-first search is much less than breadth-first search.</p>


<div class="figure-wrapper center">
  <figure id="search-breadth-maze" class="image" style="width: 178px">
    <img src="images/search_breadth.png" alt="Beadth-first Search of a Maze" style="width: 100%">
    <figcaption>Beadth-first Search of a Maze</figcaption>
  </figure>
</div>


<p>Note that the classes <strong>MazeDepthFirstSearch</strong> and
<strong>MazeBreadthFirstSearch</strong> are simple Java JFC applications that produced the <a href="#search-depth-maze">figure showing the depth-first search in a maze</a> and  the <a href="#search-breadth-maze">figure of breadth search of a maze</a>. The interested reader can read through the source code for the GUI test programs, but we will only cover the core AI code in this book. If you are interested in the GUI test programs and you are not familiar with the Java JFC (or Swing) classes, there are several good tutorials on JFC programming on the web.</p>

<h3 id="leanpub-auto-finding-paths-in-graphs">Finding Paths in Graphs</h3>

<p>In the last section, we used both depth-first and breadth-first search techniques to find a path between a starting location and a goal location in a maze. Another common type of search space is represented by a graph. A graph is a set of nodes and links. We characterize nodes as containing the following data:</p>

<ul>
  <li>A name and/or other data</li>
  <li>Zero or more links to other nodes</li>
  <li>A position in space (this is optional, usually for display or visualization purposes)</li>
</ul>

<p>Links between nodes are often called edges. The algorithms used for finding paths in graphs are very similar to finding paths in a two-dimensional maze. The primary difference is the operators that allow us to move from one node to another. In the last section we saw that in a maze, an agent can move from one grid space to another if the target space is empty. For graph search, a movement operator allows movement to another node if there is a link to the target node.</p>

<p>The <a href="#search-uml">figure showing UML Diagram for Search Classes</a> shows the UML class diagram for the graph search Java classes that we will use in this section. The abstract class <strong>AbstractGraphSearch</strong> class is the base class for both <strong>DepthFirstSearch</strong> and <strong>BreadthFirstSearch</strong>. The classes <strong>GraphDepthFirstSearch</strong> and <strong>GraphBreadthFirstSearch</strong> and test programs also provide a Java Foundation Class (JFC) or Swing based user interface. These two test programs produced figures <a href="#gsearch-depth-maze">Search Depth-First</a> and <a href="#gsearch-breadth-maze">Search Breadth-First</a>.</p>


<div class="figure-wrapper center">
  <figure id="gsearch-uml" class="image" style="width: 468px">
    <img src="images/gsearch_uml.png" alt="UML Diagram for Graphics Search Demo" style="width: 100%">
    <figcaption>UML Diagram for Graphics Search Demo</figcaption>
  </figure>
</div>


<p>As seen in the previous figure, most of the data for the search
operations (i.e., nodes, links, etc.) is defined in the abstract class
<strong>AbstractGraphSearch</strong>. This abstract class is customized through
inheritance to use a stack for storing possible moves (i.e., the array
path) for depth-first search and a queue for breadth-first search.</p>

<p>The abstract class <strong>AbstractGraphSearch</strong> allocates data required by both
derived classes:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="kd">final</code> <code class="kd">public</code> <code class="kd">static</code> <code class="kt">int</code> <code class="n">MAX</code> <code class="o">=</code> <code class="mi">50</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">path</code> <code class="o">=</code> 
              <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">AbstractGraphSearch</code><code class="p">.</code><code class="na">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="n">num_path</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="c1">// for nodes:</code>
        <code class="kd">protected</code> <code class="n">String</code> <code class="o">[]</code> <code class="n">nodeNames</code> <code class="o">=</code> 
                               <code class="k">new</code> <code class="n">String</code><code class="o">[</code><code class="n">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">node_x</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">node_y</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="c1">// for links between nodes:</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">link_1</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">link_2</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">lengths</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">MAX</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="n">numNodes</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="n">numLinks</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="kd">protected</code> <code class="kt">int</code> <code class="n">goalNodeIndex</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code>
                      <code class="n">startNodeIndex</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
</pre></div>

</figure>

<p>The abstract base class also provides several common utility methods:</p>

<ul>
  <li>addNode(String name, int x, int y) – adds a new node</li>
  <li>addLink(int n1, int n2) – adds a bidirectional link between nodes
indexed by n1 and n2. Node indexes start at zero and are in the
order of calling addNode.</li>
  <li>addLink(String n1, String n2) – adds a bidirectional link between
nodes specified by their names</li>
  <li>getNumNodes() – returns the number of nodes</li>
  <li>getNumLinks() – returns the number of links</li>
  <li>getNodeName(int index) – returns a node’s name</li>
  <li>getNodeX(), getNodeY() – return the coordinates of a node</li>
  <li>getNodeIndex(String name) – gets the index of a node, given its name</li>
</ul>

<p>The abstract base class defines an abstract method <strong>findPath</strong> that must be overridden. We will start with the derived class <strong>DepthFirstSearch</strong>, looking at its implementation of findPath. The <strong>findPath</strong> method returns an array of node indices indicating the calculated path:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">findPath</code><code class="p">(</code><code class="kt">int</code> <code class="n">start_node</code><code class="p">,</code>
                             <code class="kt">int</code> <code class="n">goal_node</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>The class variable path is an array that is used for temporary storage; we set the first element to the starting node index, and call the utility method <strong>findPathHelper</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">path</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code> <code class="o">=</code> <code class="n">start_node</code><code class="p">;</code> <code class="c1">// the starting node</code>
        <code class="k">return</code> <code class="n">findPathHelper</code><code class="p">(</code><code class="n">path</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="n">goal_node</code><code class="p">);</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The method <strong>findPathHelper</strong> is the interesting method in this class that actually performs the depth-first search; we will look at it in some detail:</p>

<p>The path array is used as a stack to keep track of which nodes are being visited during the search. The argument <strong>num_path</strong> is the number of locations in the path, which is also the search depth:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">findPathHelper</code><code class="p">(</code><code class="kt">int</code> <code class="o">[]</code> <code class="n">path</code><code class="p">,</code>
                                   <code class="kt">int</code> <code class="n">num_path</code><code class="p">,</code>
                                   <code class="kt">int</code> <code class="n">goal_node</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>First, re-check to see if we have reached the goal node; if we have, make a new array of the current size and copy the path into it. This new array is returned as the value of the method:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="k">if</code> <code class="p">(</code><code class="n">goal_node</code> <code class="o">==</code> <code class="n">path</code><code class="o">[</code><code class="n">num_path</code> <code class="o">-</code> <code class="mi">1</code><code class="o">]</code><code class="p">)</code> <code class="p">{</code>
          <code class="kt">int</code> <code class="o">[]</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">num_path</code><code class="o">]</code><code class="p">;</code>
          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">num_path</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
             <code class="n">ret</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">path</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
          <code class="p">}</code>
          <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>  <code class="c1">// we are done!</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>We have not found the goal node, so call the method <strong>connected_nodes</strong> to find all nodes connected to the current node that are not already on the search path (see the source code for the implementation of <strong>connected_nodes</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="kt">int</code> <code class="o">[]</code> <code class="n">new_nodes</code> <code class="o">=</code> <code class="n">connected_nodes</code><code class="p">(</code><code class="n">path</code><code class="p">,</code>
                                           <code class="n">num_path</code><code class="p">);</code>
</pre></div>

</figure>

<p>If there are still connected nodes to search, add the next possible “node to visit” to the top of the stack (variable <strong>path</strong> in the program) and recursively call the method <strong>findPathHelper</strong> again:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="k">if</code> <code class="p">(</code><code class="n">new_nodes</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="n">new_nodes</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">path</code><code class="o">[</code><code class="n">num_path</code><code class="o">]</code> <code class="o">=</code> <code class="n">new_nodes</code><code class="o">[</code><code class="n">j</code><code class="o">]</code><code class="p">;</code>
            <code class="kt">int</code> <code class="o">[]</code> <code class="n">test</code> <code class="o">=</code> <code class="n">findPathHelper</code><code class="p">(</code><code class="n">new_path</code><code class="p">,</code>
                                         <code class="n">num_path</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code>
                                         <code class="n">goal_node</code><code class="p">);</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">test</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">test</code><code class="o">[</code><code class="n">test</code><code class="p">.</code><code class="na">length</code><code class="o">-</code><code class="mi">1</code><code class="o">]</code> <code class="o">==</code> <code class="n">goal_node</code><code class="p">)</code> <code class="p">{</code>
                  <code class="k">return</code> <code class="n">test</code><code class="p">;</code>
              <code class="p">}</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>If we have not found the goal node, return null, instead of an array of node indices:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>Derived class <strong>BreadthFirstSearch</strong> also must define abstract method <strong>findPath</strong>. This method is very similar to the breadth-first search method used for finding a path in a maze: a queue is used to store possible moves. For a maze, we used a queue class that stored instances of the class Dimension, so for this problem, the queue only needs to store integer node indices. The return value of <strong>findPath</strong> is an array of node indices that make up the path from the starting node to the goal.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">findPath</code><code class="p">(</code><code class="kt">int</code> <code class="n">start_node</code><code class="p">,</code>
                             <code class="kt">int</code> <code class="n">goal_node</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>We start by setting up a flag array <strong>alreadyVisited</strong> to prevent visiting the same node twice, and allocating a predecessors array that we will use to find the shortest path once the goal is reached:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="c1">// data structures for depth-first search:</code>
        <code class="kt">boolean</code> <code class="o">[]</code> <code class="n">alreadyVisitedFlag</code> <code class="o">=</code>
                               <code class="k">new</code> <code class="kt">boolean</code><code class="o">[</code><code class="n">numNodes</code><code class="o">]</code><code class="p">;</code>
        <code class="kt">int</code> <code class="o">[]</code> <code class="n">predecessor</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">numNodes</code><code class="o">]</code><code class="p">;</code>
</pre></div>

</figure>

<p>The class <strong>IntQueue</strong> is a private class defined in the file BreadthFirstSearch.java; it implements a standard queue:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">IntQueue</code> <code class="n">queue</code> <code class="o">=</code> <code class="k">new</code> <code class="n">IntQueue</code><code class="p">(</code><code class="n">numNodes</code> <code class="o">+</code> <code class="mi">2</code><code class="p">);</code>
</pre></div>

</figure>

<p>Before the main loop, we need to initialize the already visited predecessor arrays, set the visited flag for the starting node to true, and add the starting node index to the back of the queue:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">numNodes</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">alreadyVisitedFlag</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
          <code class="n">predecessor</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="n">alreadyVisitedFlag</code><code class="o">[</code><code class="n">start_node</code><code class="o">]</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
        <code class="n">queue</code><code class="p">.</code><code class="na">addToBackOfQueue</code><code class="p">(</code><code class="n">start_node</code><code class="p">);</code>
</pre></div>

</figure>

<p>The main loop runs until we find the goal node or the search queue is empty:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">outer</code><code class="p">:</code>  <code class="k">while</code> <code class="p">(</code><code class="n">queue</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">()</code> <code class="o">==</code> <code class="kc">false</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>We will read (without removing) the node index at the front of the queue and calculate the nodes that are connected to the current node (but not already on the visited list) using the <strong>connected_nodes</strong> method (the
interested reader can see the implementation in the source code for this class):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>          <code class="kt">int</code> <code class="n">head</code> <code class="o">=</code> <code class="n">queue</code><code class="p">.</code><code class="na">peekAtFrontOfQueue</code><code class="p">();</code>
          <code class="kt">int</code> <code class="o">[]</code> <code class="n">connected</code> <code class="o">=</code> <code class="n">connected_nodes</code><code class="p">(</code><code class="n">head</code><code class="p">);</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">connected</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>If each node connected by a link to the current node has not already been visited, set the predecessor array and add the new node index to the back of the search queue; we stop if the goal is found:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">connected</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
             <code class="k">if</code> <code class="p">(</code><code class="n">alreadyVisitedFlag</code><code class="o">[</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]]</code> <code class="o">==</code> <code class="kc">false</code><code class="p">)</code> <code class="p">{</code>
               <code class="n">predecessor</code><code class="o">[</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]]</code> <code class="o">=</code> <code class="n">head</code><code class="p">;</code>
               <code class="n">queue</code><code class="p">.</code><code class="na">addToBackOfQueue</code><code class="p">(</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
               <code class="k">if</code> <code class="p">(</code><code class="n">connected</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="n">goal_node</code><code class="p">)</code> <code class="k">break</code> <code class="n">outer</code><code class="p">;</code>
              <code class="p">}</code>
            <code class="p">}</code>
            <code class="n">alreadyVisitedFlag</code><code class="o">[</code><code class="n">head</code><code class="o">]</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
            <code class="n">queue</code><code class="p">.</code><code class="na">removeFromQueue</code><code class="p">();</code> <code class="c1">// ignore return value</code>
          <code class="p">}</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>Now that the goal node has been found, we can build a new array of returned node indices for the calculated path using the predecessor array:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="kt">int</code> <code class="o">[]</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">numNodes</code> <code class="o">+</code> <code class="mi">1</code><code class="o">]</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="n">ret</code><code class="o">[</code><code class="n">count</code><code class="o">++]</code> <code class="o">=</code> <code class="n">goal_node</code><code class="p">;</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">numNodes</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">ret</code><code class="o">[</code><code class="n">count</code><code class="o">]</code> <code class="o">=</code> <code class="n">predecessor</code><code class="o">[</code><code class="n">ret</code><code class="o">[</code><code class="n">count</code> <code class="o">-</code> <code class="mi">1</code><code class="o">]]</code><code class="p">;</code>
          <code class="n">count</code><code class="o">++</code><code class="p">;</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">ret</code><code class="o">[</code><code class="n">count</code> <code class="o">-</code> <code class="mi">1</code><code class="o">]</code> <code class="o">==</code> <code class="n">start_node</code><code class="p">)</code>  <code class="k">break</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="kt">int</code> <code class="o">[]</code> <code class="n">ret2</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="n">count</code><code class="o">]</code><code class="p">;</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">count</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">ret2</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">ret</code><code class="o">[</code><code class="n">count</code> <code class="o">-</code> <code class="mi">1</code> <code class="o">-</code> <code class="n">i</code><code class="o">]</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="n">ret2</code><code class="p">;</code>
       <code class="p">}</code>
</pre></div>

</figure>

<p>In order to run both the depth-first and breadth-first graph search examples, change directory to src-search-maze and type the following commands:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">javac</code> <code class="o">*</code><code class="p">.</code><code class="na">java</code>
    <code class="n">java</code> <code class="n">GraphDepthFirstSearch</code>
    <code class="n">java</code> <code class="n">GraphBeadthFirstSearch</code>
</pre></div>

</figure>

<p>The following figure shows the results of finding a route from node 1 to node 9 in the small test graph. Like the depth-first results seen in the maze search, this path is not optimal.</p>


<div class="figure-wrapper center">
  <figure id="gsearch-depth-graph" class="image" style="width: 162px">
    <img src="images/gsearch_depth.png" alt="Depth-first Search in a Graph" style="width: 100%">
    <figcaption>Depth-first Search in a Graph</figcaption>
  </figure>
</div>


<p>The next figure shows an optimal path found using a breadth-first search. As we saw in the maze search example, we find optimal solutions using breadth-first search at the cost of extra memory required for the breadth-first search.</p>


<div class="figure-wrapper center">
  <figure id="gsearch-breadth-graph" class="image" style="width: 166px">
    <img src="images/gsearch_breadth.png" alt="Breadth-first Search in a Graph" style="width: 100%">
    <figcaption>Breadth-first Search in a Graph</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-adding-heuristics-to-breadth-first-search">Adding Heuristics to Breadth-first Search</h3>

<p>We can usually make breadth-first search more efficient by ordering the search order for all branches from a given position in the search space. For example, when adding new nodes from a specified reference point in the search space, we might want to add nodes to the search queue first that are “in the direction” of the goal location: in a two-dimensional search like our maze search, we might want to search connected grid cells first that were closest to the goal grid space. In this case, pre-sorting nodes (in order of closest distance to the goal) added to the breadth-first search queue could have a dramatic effect on search efficiency. The alpha-beta additions to breadth-first search are seen in in the next section.</p>

<h3 id="leanpub-auto-heuristic-search-and-game-playing-tic-tac-toe-and-chess">Heuristic Search and Game Playing: Tic-Tac-Toe and Chess</h3>

<p>Now that a computer program has won a match against the human world champion, perhaps people’s expectations of AI systems will be prematurely optimistic. Game search techniques are not real AI, but rather, standard programming techniques. A better platform for doing AI research is the game of Go. There are so many possible moves in the game of Go that brute force look ahead (as is used in Chess playing programs) simply does not work. In 2016 the Alpha Go program became stronger than human players by using Reinforcement Learning and Monte Carlo search.</p>

<p>Min-max type search algorithms with alpha-beta cutoff
optimizations are an important programming technique and will be covered in some detail in the remainder of this chapter. We will design an abstract Java class library for implementing alpha-beta enhanced min-max search, and then use this framework to write programs to play
tic-tac-toe and chess.</p>

<h4 id="leanpub-auto-alpha-beta-search">Alpha-Beta Search</h4>

<p>The first game that we will implement will be tic-tac-toe, so we will
use this simple game to explain how the min-max search (with alpha-beta
cutoffs) works.</p>

<p>The <a href="#alphabeta-tictactoe">figure showing possible moves for tic-tac-toe</a> shows some of the possible moves generated
from a tic-tac-toe position where X has made three moves and O has made
two moves; it is O’s turn to move. This is “level 0” in this figure. At level 0, O has four possible moves. How
do we assign a fitness value to each of O’s possible moves at level 0?
The basic min-max search algorithm provides a simple solution to this
problem: for each possible move by O in level 1, make the move and store
the resulting 4 board positions. Now, at level 1, it is X’s turn to
move. How do we assign values to each of X’s possible three moves in
the <a href="#alphabeta-tictactoe">figure showing possible moves for tic-tac-toe</a>? Simple, we continue to search by
making each of X’s possible moves and storing each possible board
position for level 2. We keep recursively applying this algorithm until
we either reach a maximum search depth, or there is a win, loss, or draw
detected in a generated move. We assume that there is a fitness function
available that rates a given board position relative to either side.
Note that the value of any board position for X is the negative of the
value for O.</p>


<div class="figure-wrapper center">
  <figure id="alphabeta-tictactoe" class="image" style="width: 468px">
    <img src="images/alphabeta_tictactoe.png" alt="Alpha Beta Search for Tic-Tac-Toe" style="width: 100%">
    <figcaption>Alpha Beta Search for Tic-Tac-Toe</figcaption>
  </figure>
</div>


<p>To make the search more efficient, we maintain values for alpha and beta
for each search level. Alpha and beta determine the best possible/worst
possible move available at a given level. If we reach a situation like
the second position in level 2 where X has won, then we can immediately
determine that O’s last move in level 1 that produced this position (of
allowing X an instant win) is a low valued move for O (but a high valued
move for X). This allows us to immediately “prune” the search tree by
ignoring all other possible positions arising from the first O move in
level 1. This alpha-beta cutoff (or tree pruning) procedure can save a
large percentage of search time, especially if we can set the search
order at each level with “probably best” moves considered first.</p>

<p>While tree diagrams as seen in the <a href="#alphabeta-tictactoe">figure showing possible moves for tic-tac-toe</a> quickly
get complicated, it is easy for a computer program to generate possible
moves, calculate new possible board positions and temporarily store
them, and recursively apply the same procedure to the next search level
(but switching min-max “sides” in the board evaluation). We will see in
the next section that it only requires about 100 lines of Java code to
implement an abstract class framework for handling the details of
performing an alpha-beta enhanced search. The additional game specific
classes for tic-tac-toe require about an additional 150 lines of code to
implement; chess requires an additional 450 lines of code.</p>

<h4 id="leanpub-auto-a-java-framework-for-search-and-game-playing">A Java Framework for Search and Game Playing</h4>

<p>The general interface for the Java classes that we will develop in this
section was inspired by the Common LISP game-playing framework written
by Kevin Knight and described in (Rich, Knight 1991). The abstract class
GameSearch contains the code for running a two-player game and
performing an alpha-beta search. This class needs to be sub-classed to
provide the eight methods:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">drawnPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">wonPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                          <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
                      <code class="n">positionEvaluation</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                         <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">void</code> <code class="nf">printPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">Position</code> <code class="o">[]</code>
                      <code class="n">possibleMoves</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                    <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">Position</code> <code class="nf">makeMove</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                        <code class="kt">boolean</code> <code class="n">player</code><code class="p">,</code>
                                        <code class="n">Move</code> <code class="n">move</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">reachedMaxDepth</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                              <code class="kt">int</code> <code class="n">depth</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">Move</code> <code class="nf">getMove</code><code class="p">()</code>
</pre></div>

</figure>

<p>The method <strong>drawnPosition</strong> should return a Boolean true value if the
given position evaluates to a draw situation. The method <strong>wonPosition</strong>
should return a true value if the input position is won for the
indicated player. By convention, I use a Boolean true value to represent
the computer and a Boolean false value to represent the human opponent.
The method <strong>positionEvaluation</strong> returns a position evaluation for a
specified board position and player. Note that if we call
positionEvaluation switching the player for the same board position,
then the value returned is the negative of the value calculated for the
opposing player. The method <strong>possibleMoves</strong> returns an array of objects
belonging to the class Position. In an actual game like chess, the
position objects will actually belong to a chess-specific refinement of
the Position class (e.g., for the chess program developed later in this
chapter, the method <strong>possibleMoves</strong> will return an array of
<strong>ChessPosition</strong> objects). The method <strong>makeMove</strong> will return a new
position object for a specified board position, side to move, and move.
The method <strong>reachedMaxDepth</strong> returns a Boolean true value if the search
process has reached a satisfactory depth. For the tic-tac-toe program,
the method <strong>reachedMaxDepth</strong> does not return true unless either side has
won the game or the board is full; for the chess program, the method
<strong>reachedMaxDepth</strong> returns true if the search has reached a depth of 4
half moves deep (this is not the best strategy, but it has the advantage
of making the example program short and easy to understand). The method
<strong>getMove</strong> returns an object of a class derived from the class <strong>Move</strong>
(e.g., <strong>TicTacToeMove</strong> or <strong>ChessMove</strong>).</p>

<p>The <strong>GameSearch</strong> class implements the following methods to perform game
search:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">protected</code> <code class="n">Vector</code> <code class="nf">alphaBeta</code><code class="p">(</code><code class="kt">int</code> <code class="n">depth</code><code class="p">,</code> <code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                 <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
      <code class="kd">protected</code> <code class="n">Vector</code> <code class="nf">alphaBetaHelper</code><code class="p">(</code><code class="kt">int</code> <code class="n">depth</code><code class="p">,</code>
                                       <code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                       <code class="kt">boolean</code> <code class="n">player</code><code class="p">,</code>
                                       <code class="kt">float</code> <code class="n">alpha</code><code class="p">,</code>
                                       <code class="kt">float</code> <code class="n">beta</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kt">void</code> <code class="nf">playGame</code><code class="p">(</code><code class="n">Position</code> <code class="n">startingPosition</code><code class="p">,</code>
                           <code class="kt">boolean</code> <code class="n">humanPlayFirst</code><code class="p">)</code>
</pre></div>

</figure>

<p>The method <strong>alphaBeta</strong> is simple; it calls the helper method
<strong>alphaBetaHelper</strong> with initial search conditions; the method
<strong>alphaBetaHelper</strong> then calls itself recursively. The code for
<strong>alphaBeta</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">protected</code> <code class="n">Vector</code> <code class="nf">alphaBeta</code><code class="p">(</code><code class="kt">int</code> <code class="n">depth</code><code class="p">,</code>
                                 <code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                 <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>  <code class="p">{</code>
        <code class="n">Vector</code> <code class="n">v</code> <code class="o">=</code> <code class="n">alphaBetaHelper</code><code class="p">(</code><code class="n">depth</code><code class="p">,</code> <code class="n">p</code><code class="p">,</code> <code class="n">player</code><code class="p">,</code>
                                   <code class="mf">1000000.0f</code><code class="p">,</code>
                                  <code class="o">-</code><code class="mf">1000000.0f</code><code class="p">);</code>
        <code class="k">return</code> <code class="n">v</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>It is important to understand what is in the vector returned by the methods <strong>alphaBeta</strong> and <strong>alphaBetaHelper</strong>. The first element is a floating point position evaluation for the point of view of the player whose turn it is to move; the remaining values are the “best move” for each side to the last search depth. As an example, if I let the tic-tac-toe program play first, it places a marker at square index 0, then I place my marker in the center of the board an index 4. At this point, to calculate the next computer move, <strong>alphaBeta</strong> is called and returns the following elements in a vector:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="mf">0.0</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="o">[-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="o">]</code>
</pre></div>

</figure>

<p>Here, the alpha-beta enhanced min-max search looked all the way to the end of the game and these board positions represent what the search procedure calculated as the best moves for each side. Note that the class <strong>TicTacToePosition</strong> (derived from the abstract class <strong>Position</strong>) has a toString method to print the board values to a string.</p>

<p>The same printout of the returned vector from <strong>alphaBeta</strong> for the chess program is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">next</code> <code class="n">element</code><code class="p">:</code> <code class="mf">5.4</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code>
         <code class="o">[</code><code class="mi">4</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code class="o">-</code><code class="mi">9</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code>
         <code class="o">[</code><code class="mi">4</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code class="o">-</code><code class="mi">9</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code>
         <code class="o">[</code><code class="mi">4</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">9</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code>
         <code class="o">[</code><code class="mi">4</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">9</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">]</code>
     <code class="n">next</code> <code class="n">element</code><code class="p">:</code>
         <code class="o">[</code><code class="mi">4</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">9</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">5</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code>
          <code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="mi">7</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="o">-</code><code class="mi">9</code><code class="p">,</code>
          <code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">]</code>
</pre></div>

</figure>

<p>Here, the search procedure assigned the side to move (the computer) a position evaluation score of 5.4; this is an artifact of searching to a fixed depth. Notice that the board representation is different for chess, but because the <strong>GameSearch</strong> class manipulates objects derived from the classes <strong>Position</strong> and <strong>Move</strong>, the GameSearch class does not need to have any knowledge of the rules for a specific game. We will discuss the format of the chess position class <strong>ChessPosition</strong> in more detail when we develop the chess program.</p>

<p>The classes Move and Position contain no data and methods at all. The classes Move and Position are used as placeholders for derived classes for specific games. The search methods in the abstract GameSearch class manipulate objects derived from the classes Move and Position.</p>

<p>Now that we have seen the debug printout of the contents of the vector returned from the methods <strong>alphaBeta</strong> and <strong>alphaBetaHelper</strong>, it will be easier to understand how the method <strong>alphaBetaHelper</strong> works. The following text shows code fragments from the <strong>alphaBetaHelper</strong> method interspersed with book text:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">protected</code> <code class="n">Vector</code> <code class="nf">alphaBetaHelper</code><code class="p">(</code><code class="kt">int</code> <code class="n">depth</code><code class="p">,</code>
                                       <code class="n">Position</code> <code class="n">p</code><code class="p">,</code>                
                                       <code class="kt">boolean</code> <code class="n">player</code><code class="p">,</code>
                                       <code class="kt">float</code> <code class="n">alpha</code><code class="p">,</code>
                                       <code class="kt">float</code> <code class="n">beta</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>Here, we notice that the method signature is the same as for <strong>alphaBeta</strong>, except that we pass floating point alpha and beta values. The important point in understanding min-max search is that most of the
evaluation work is done while “backing up” the search tree; that is, the search proceeds to a leaf node (a node is a leaf if the method <strong>reachedMaxDepth</strong> return a Boolean true value), and then a return vector for the leaf node is created by making a new vector and setting its
first element to the position evaluation of the position at the leaf node and setting the second element of the return vector to the board position at the leaf node:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="k">if</code> <code class="p">(</code><code class="n">reachedMaxDepth</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">depth</code><code class="p">))</code> <code class="p">{</code>
          <code class="n">Vector</code> <code class="n">v</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>
          <code class="kt">float</code> <code class="n">value</code> <code class="o">=</code> <code class="n">positionEvaluation</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">player</code><code class="p">);</code>
          <code class="n">v</code><code class="p">.</code><code class="na">addElement</code><code class="p">(</code><code class="k">new</code> <code class="n">Float</code><code class="p">(</code><code class="n">value</code><code class="p">));</code>
          <code class="n">v</code><code class="p">.</code><code class="na">addElement</code><code class="p">(</code><code class="n">p</code><code class="p">);</code>
          <code class="k">return</code> <code class="n">v</code><code class="p">;</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>If we have not reached the maximum search depth (i.e., we are not yet at a leaf node in the search tree), then we enumerate all possible moves from the current position using the method <strong>possibleMoves</strong> and recursively call <strong>alphaBetaHelper</strong> for each new generated board position. In terms of the <a href="#alphabeta-tictactoe">figure showing possible moves for tic-tac-toe</a>, at this point we are moving down to another search level (e.g., from level 1 to level 2; the level in the <a href="#alphabeta-tictactoe">figure showing possible moves for tic-tac-toe</a> corresponds to depth argument in <strong>alphaBetaHelper</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">Vector</code> <code class="n">best</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="p">();</code>
      <code class="n">Position</code> <code class="o">[]</code> <code class="n">moves</code> <code class="o">=</code> <code class="n">possibleMoves</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">player</code><code class="p">);</code>
      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">moves</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">Vector</code> <code class="n">v2</code> <code class="o">=</code> <code class="n">alphaBetaHelper</code><code class="p">(</code><code class="n">depth</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">,</code>
                                    <code class="o">!</code><code class="n">player</code><code class="p">,</code>
                                    <code class="o">-</code><code class="n">beta</code><code class="p">,</code> <code class="o">-</code><code class="n">alpha</code><code class="p">);</code>
        <code class="kt">float</code> <code class="n">value</code> <code class="o">=</code> <code class="o">-</code><code class="p">((</code><code class="n">Float</code><code class="p">)</code><code class="n">v2</code><code class="p">.</code><code class="na">elementAt</code><code class="p">(</code><code class="mi">0</code><code class="p">)).</code><code class="na">floatValue</code><code class="p">();</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">value</code> <code class="o">&gt;</code> <code class="n">beta</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">if</code><code class="p">(</code><code class="n">GameSearch</code><code class="p">.</code><code class="na">DEBUG</code><code class="p">)</code>
            <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" ! ! ! value="</code><code class="o">+</code>
                               <code class="n">value</code><code class="o">+</code> 
                               <code class="s">",beta="</code><code class="o">+</code><code class="n">beta</code><code class="p">);</code>
          <code class="n">beta</code> <code class="o">=</code> <code class="n">value</code><code class="p">;</code>
          <code class="n">best</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="p">();</code>
          <code class="n">best</code><code class="p">.</code><code class="na">addElement</code><code class="p">(</code><code class="n">moves</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
          <code class="n">Enumeration</code> <code class="kd">enum</code> <code class="o">=</code> <code class="n">v2</code><code class="p">.</code><code class="na">elements</code><code class="p">();</code>
          <code class="kd">enum</code><code class="p">.</code><code class="na">nextElement</code><code class="p">();</code> <code class="c1">// skip previous value</code>
          <code class="k">while</code> <code class="p">(</code><code class="kd">enum</code><code class="p">.</code><code class="na">hasMoreElements</code><code class="p">())</code> <code class="p">{</code>
            <code class="n">Object</code> <code class="n">o</code> <code class="o">=</code> <code class="kd">enum</code><code class="p">.</code><code class="na">nextElement</code><code class="p">();</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">o</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="n">best</code><code class="p">.</code><code class="na">addElement</code><code class="p">(</code><code class="n">o</code><code class="p">);</code>
          <code class="p">}</code>
        <code class="p">}</code>
        <code class="cm">/**</code>
<code class="cm">         * Use the alpha-beta cutoff test to abort</code>
<code class="cm">         * search if we found a move that proves that</code>
<code class="cm">         * the previous move in the move chain was dubious</code>
<code class="cm">         */</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">beta</code> <code class="o">&gt;=</code> <code class="n">alpha</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">break</code><code class="p">;</code>
        <code class="p">}</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>Notice that when we recursively call <strong>alphaBetaHelper</strong>, we are “flipping” the player argument to the opposite Boolean value. After calculating the best move at this depth (or level), we add it to the end of the return vector:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">Vector</code> <code class="n">v3</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="p">();</code>
        <code class="n">v3</code><code class="p">.</code><code class="na">addElement</code><code class="p">(</code><code class="k">new</code> <code class="n">Float</code><code class="p">(</code><code class="n">beta</code><code class="p">));</code>
        <code class="n">Enumeration</code> <code class="kd">enum</code> <code class="o">=</code> <code class="n">best</code><code class="p">.</code><code class="na">elements</code><code class="p">();</code>
        <code class="k">while</code> <code class="p">(</code><code class="kd">enum</code><code class="p">.</code><code class="na">hasMoreElements</code><code class="p">())</code> <code class="p">{</code>
          <code class="n">v3</code><code class="p">.</code><code class="na">addElement</code><code class="p">(</code><code class="kd">enum</code><code class="p">.</code><code class="na">nextElement</code><code class="p">());</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="n">v3</code><code class="p">;</code>
</pre></div>

</figure>

<p>When the recursive calls back up and the first call to <strong>alphaBetaHelper</strong> returns a vector to the method <strong>alphaBeta</strong>, all of the “best” moves for each side are stored in the return vector, along with the evaluation of the board position for the side to move.</p>

<p>The class <strong>GameSearch</strong> method <strong>playGame</strong> is fairly simple; the following code fragment is a partial listing of playGame showing how to call <strong>alphaBeta</strong>, <strong>getMove</strong>, and <strong>makeMove</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">void</code> <code class="nf">playGame</code><code class="p">(</code><code class="n">Position</code> <code class="n">startingPosition</code><code class="p">,</code>
                           <code class="kt">boolean</code> <code class="n">humanPlayFirst</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Your move:"</code><code class="p">);</code>
        <code class="n">Move</code> <code class="n">move</code> <code class="o">=</code> <code class="n">getMove</code><code class="p">();</code>
        <code class="n">startingPosition</code> <code class="o">=</code> <code class="n">makeMove</code><code class="p">(</code><code class="n">startingPosition</code><code class="p">,</code>
                                    <code class="n">HUMAN</code><code class="p">,</code> <code class="n">move</code><code class="p">);</code>
        <code class="n">printPosition</code><code class="p">(</code><code class="n">startingPosition</code><code class="p">);</code>
        <code class="n">Vector</code> <code class="n">v</code> <code class="o">=</code> <code class="n">alphaBeta</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">startingPosition</code><code class="p">,</code> <code class="n">PROGRAM</code><code class="p">);</code>
        <code class="n">startingPosition</code> <code class="o">=</code> <code class="p">(</code><code class="n">Position</code><code class="p">)</code><code class="n">v</code><code class="p">.</code><code class="na">elementAt</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>        
        <code class="p">}</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The debug printout of the vector returned from the method <strong>alphaBeta</strong> seen earlier in this section was printed using the following code immediately after the call to the method <strong>alphaBeta</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>          <code class="n">Enumeration</code> <code class="kd">enum</code> <code class="o">=</code> <code class="n">v</code><code class="p">.</code><code class="na">elements</code><code class="p">();</code>
          <code class="k">while</code> <code class="p">(</code><code class="kd">enum</code><code class="p">.</code><code class="na">hasMoreElements</code><code class="p">())</code> <code class="p">{</code>
            <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" next element: "</code> <code class="o">+</code> 
                               <code class="kd">enum</code><code class="p">.</code><code class="na">nextElement</code><code class="p">());</code>
          <code class="p">}</code>
</pre></div>

</figure>

<p>In the next few sections, we will implement a tic-tac-toe program and a chess-playing program using this Java class framework.</p>

<h4 id="leanpub-auto-tic-tac-toe-using-the-alpha-beta-search-algorithm">Tic-Tac-Toe Using the Alpha-Beta Search Algorithm</h4>

<p>Using the Java class framework of <strong>GameSearch</strong>, <strong>Position</strong>, and <strong>Move</strong>, it is simple to write a basic tic-tac-toe program by writing three new derived classes (as seen in the next figure showing a UML Class Diagram)
<strong>TicTacToe</strong> (derived from <strong>GameSearch</strong>), <strong>TicTacToeMove</strong> (derived from <strong>Move</strong>), and <strong>TicTacToePosition</strong> (derived from <strong>Position</strong>).</p>


<div class="figure-wrapper center">
  <figure id="alphabaeta-tictactoe-classes" class="image" style="width: 468px">
    <img src="images/alphabaeta_tictactoe_classes.png" alt="UML Diagram for Tic-Tac-Toe Classes" style="width: 100%">
    <figcaption>UML Diagram for Tic-Tac-Toe Classes</figcaption>
  </figure>
</div>


<p>I assume that the reader has the book example code installed and available for viewing. In this section, I will only discuss the most interesting details of the tic-tac-toe class refinements; I assume that the reader can look at the source code. We will start by looking at the
refinements for the position and move classes. The <strong>TicTacToeMove</strong> class
is trivial, adding a single integer value to record the square index for the new move:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">public</code> <code class="kd">class</code> <code class="nc">TicTacToeMove</code> <code class="kd">extends</code> <code class="n">Move</code> <code class="p">{</code>
      <code class="kd">public</code> <code class="kt">int</code> <code class="n">moveIndex</code><code class="p">;</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>The board position indices are in the range of [0..8] and can be considered to be in the following order:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>       <code class="mi">0</code> <code class="mi">1</code> <code class="mi">2</code>
       <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code>
       <code class="mi">6</code> <code class="mi">7</code> <code class="mi">8</code>
</pre></div>

</figure>

<p>The class <strong>TicTacToePosition</strong> is also simple:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">public</code> <code class="kd">class</code> <code class="nc">TicTacToePosition</code> <code class="kd">extends</code> <code class="n">Position</code> <code class="p">{</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">BLANK</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">HUMAN</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">PROGRAM</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
        <code class="kt">int</code> <code class="o">[]</code> <code class="n">board</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="mi">9</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="p">()</code> <code class="p">{</code>
            <code class="n">StringBuffer</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuffer</code><code class="p">(</code><code class="s">"["</code><code class="p">);</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code>
              <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">""</code><code class="o">+</code><code class="n">board</code><code class="o">[</code><code class="n">i</code><code class="o">]+</code><code class="s">","</code><code class="p">);</code>
            <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">"]"</code><code class="p">);</code>
            <code class="k">return</code> <code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
        <code class="p">}</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>This class allocates an array of nine integers to represent the board, defines constant values for blank, human, and computer squares, and defines a toString method to print out the board representation to a string.</p>

<p>The <strong>TicTacToe</strong> class must define the following abstract methods from the base class <strong>GameSearch</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">drawnPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">wonPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                         <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">float</code> <code class="nf">positionEvaluation</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                              <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">void</code> <code class="nf">printPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">Position</code> <code class="o">[]</code> <code class="n">possibleMoves</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                               <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">Position</code> <code class="nf">makeMove</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                       <code class="kt">boolean</code> <code class="n">player</code><code class="p">,</code>
                                       <code class="n">Move</code> <code class="n">move</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="kt">boolean</code> <code class="nf">reachedMaxDepth</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                            <code class="kt">int</code> <code class="n">depth</code><code class="p">)</code>
     <code class="kd">public</code> <code class="kd">abstract</code> <code class="n">Move</code> <code class="nf">getMove</code><code class="p">()</code>
</pre></div>

</figure>

<p>The implementation of these methods uses the refined classes <strong>TicTacToeMove</strong> and <strong>TicTacToePosition</strong>. For example, consider the method <strong>drawnPosition</strong> that is responsible for selecting a drawn (or tied) position:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">drawnPosition</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">)</code> <code class="p">{</code>
        <code class="kt">boolean</code> <code class="n">ret</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
        <code class="n">TicTacToePosition</code> <code class="n">pos</code> <code class="o">=</code> <code class="p">(</code><code class="n">TicTacToePosition</code><code class="p">)</code><code class="n">p</code><code class="p">;</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="n">TicTacToePosition</code><code class="p">.</code><code class="na">BLANK</code><code class="p">){</code>
            <code class="n">ret</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
            <code class="k">break</code><code class="p">;</code>
          <code class="p">}</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The overridden methods from the <strong>GameSearch</strong> base class must always cast arguments of type <strong>Position</strong> and <strong>Move</strong> to <strong>TicTacToePosition</strong> and <strong>TicTacToeMove</strong>. Note that in the method <strong>drawnPosition</strong>, the argument
of class <strong>Position</strong> is cast to the class <strong>TicTacToePosition</strong>. A position is considered to be a draw if all of the squares are full. We will see that checks for a won position are always made before checks for a drawn position, so that the method <strong>drawnPosition</strong> does not need to make a redundant check for a won position. The method <strong>wonPosition</strong> is also simple; it uses a private helper method <strong>winCheck</strong> to test for all
possible winning patterns in tic-tac-toe. The method
<strong>positionEvaluation</strong> uses the following board features to assign a fitness value from the point of view of either player:</p>

<ul>
  <li>The number of blank squares on the board</li>
  <li>If the position is won by either side</li>
  <li>If the center square is taken</li>
</ul>

<p>The method <strong>positionEvaluation</strong> is simple, and is a good place for the interested reader to start modifying both the tic-tac-toe and chess programs:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="kd">public</code> <code class="kt">float</code> <code class="nf">positionEvaluation</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                        <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code> <code class="p">{</code>
            <code class="kt">int</code> <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
            <code class="n">TicTacToePosition</code> <code class="n">pos</code> <code class="o">=</code> <code class="p">(</code><code class="n">TicTacToePosition</code><code class="p">)</code><code class="n">p</code><code class="p">;</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="n">count</code><code class="o">++</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="n">count</code> <code class="o">=</code> <code class="mi">10</code> <code class="o">-</code> <code class="n">count</code><code class="p">;</code>
            <code class="c1">// prefer the center square:</code>
            <code class="kt">float</code> <code class="n">base</code> <code class="o">=</code> <code class="mf">1.0f</code><code class="p">;</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="mi">4</code><code class="o">]</code> <code class="o">==</code> <code class="n">TicTacToePosition</code><code class="p">.</code><code class="na">HUMAN</code> <code class="o">&amp;&amp;</code>
                <code class="n">player</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">base</code> <code class="o">+=</code> <code class="mf">0.4f</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="mi">4</code><code class="o">]</code> <code class="o">==</code> <code class="n">TicTacToePosition</code><code class="p">.</code><code class="na">PROGRAM</code> <code class="o">&amp;&amp;</code>
                <code class="o">!</code><code class="n">player</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">base</code> <code class="o">-=</code> <code class="mf">0.4f</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="kt">float</code> <code class="n">ret</code> <code class="o">=</code> <code class="p">(</code><code class="n">base</code> <code class="o">-</code> <code class="mf">1.0f</code><code class="p">);</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">wonPosition</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">player</code><code class="p">))</code>  <code class="p">{</code>
                <code class="k">return</code> <code class="n">base</code> <code class="o">+</code> <code class="p">(</code><code class="mf">1.0f</code> <code class="o">/</code> <code class="n">count</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">wonPosition</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="o">!</code><code class="n">player</code><code class="p">))</code>  <code class="p">{</code>
                <code class="k">return</code> <code class="o">-</code><code class="p">(</code><code class="n">base</code> <code class="o">+</code> <code class="p">(</code><code class="mf">1.0f</code> <code class="o">/</code> <code class="n">count</code><code class="p">));</code>
            <code class="p">}</code>
            <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>The only other method that we will look at here is <strong>possibleMoves</strong>; the interested reader can look at the implementation of the other (very simple) methods in the source code. The method <strong>possibleMoves</strong> is called with a current position, and the side to move (i.e., program or human):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="kd">public</code> <code class="n">Position</code> <code class="o">[]</code> <code class="n">possibleMoves</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                         <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">TicTacToePosition</code> <code class="n">pos</code> <code class="o">=</code> <code class="p">(</code><code class="n">TicTacToePosition</code><code class="p">)</code><code class="n">p</code><code class="p">;</code>
            <code class="kt">int</code> <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="n">count</code><code class="o">++</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">count</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>
            <code class="n">Position</code> <code class="o">[]</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Position</code><code class="o">[</code><code class="n">count</code><code class="o">]</code><code class="p">;</code>
            <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
                    <code class="n">TicTacToePosition</code> <code class="n">pos2</code> <code class="o">=</code>
                               <code class="k">new</code>  <code class="n">TicTacToePosition</code><code class="p">();</code>
                    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code>
                         <code class="n">pos2</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">j</code><code class="o">]</code> <code class="o">=</code> <code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">j</code><code class="o">]</code><code class="p">;</code>
                    <code class="k">if</code> <code class="p">(</code><code class="n">player</code><code class="p">)</code> <code class="n">pos2</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
                    <code class="k">else</code> <code class="n">pos2</code><code class="p">.</code><code class="na">board</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
                    <code class="n">ret</code><code class="o">[</code><code class="n">count</code><code class="o">++]</code> <code class="o">=</code> <code class="n">pos2</code><code class="p">;</code>
                <code class="p">}</code>
            <code class="p">}</code>
            <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>It is very simple to generate possible moves: every blank square is a legal move. (This method will not be as straightforward in the example chess program!)</p>

<p>It is simple to compile and run the example tic-tac-toe program: change directory to src-search-game and type:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">mvn</code> <code class="n">install</code>
    <code class="n">mvn</code> <code class="n">exec</code><code class="p">:</code><code class="n">java</code> <code class="o">-</code><code class="n">Dexec</code><code class="p">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s">"search.game.TicTacToe"</code>
</pre></div>

</figure>

<p>When asked to enter moves, enter an integer between 0 and 8 for a square that is currently blank (i.e., has a zero value). The following shows this labeling of squares on the tic-tac-toe board:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    0 1 2
    3 4 5
    6 7 8
</pre></div>

</figure>

<p>You might need to enter two return (enter) keys after entering your move square when using a macOS terminal.</p>

<h4 id="leanpub-auto-chess-using-the-alpha-beta-search-algorithm">Chess Using the Alpha-Beta Search Algorithm</h4>

<p>Using the Java class framework of <strong>GameSearch</strong>, <strong>Position</strong>, and <strong>Move</strong>,
it is reasonably easy to write a simple chess program by writing three
new derived classes (see the <a href="#alphabeta-chess-classes">figure showing a UML diagram for the chess game casses</a>) <strong>Chess</strong>
(derived from <strong>GameSearch</strong>), <strong>ChessMove</strong> (derived from <strong>Move</strong>), and
<strong>ChessPosition</strong> (derived from <strong>Position</strong>). The chess program developed
in this section is intended to be an easy to understand example of using
alpha-beta min-max search; as such, it ignores several details that a
fully implemented chess program would implement:</p>

<ul>
  <li>Allow the computer to play either side (computer always plays black
in this example).</li>
  <li>Allow en-passant pawn captures.</li>
  <li>Allow the player to take back a move after making a mistake.</li>
</ul>

<p>The reader is assumed to have read the last section on implementing the
tic-tac-toe game; details of refining the GameSearch, Move, and Position
classes are not repeated in this section.</p>

<p>The following <a href="#alphabeta-chess-classes">figure showing a UML diagram for the chess game casses</a> shows the UML class diagram for
both the general purpose GameSearch framework and the classes derived to
implement chess specific data and behavior.</p>


<div class="figure-wrapper center">
  <figure id="alphabeta-chess-classes" class="image" style="width: 468px">
    <img src="images/alphabeta_chess_classes.png" alt="UML Diagram for Chess Game Classes" style="width: 100%">
    <figcaption>UML Diagram for Chess Game Classes</figcaption>
  </figure>
</div>


<p>The class ChessMove contains data for recording from and to square
indices:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">public</code> <code class="kd">class</code> <code class="nc">ChessMove</code> <code class="kd">extends</code> <code class="n">Move</code> <code class="p">{</code>
        <code class="kd">public</code> <code class="kt">int</code> <code class="n">from</code><code class="p">;</code>
        <code class="kd">public</code> <code class="kt">int</code> <code class="n">to</code><code class="p">;</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>The board is represented as an integer array with 120 elements. A
chessboard only has 64 squares; the remaining board values are set to a
special value of 7, which indicates an “off board” square. The initial
board setup is defined statically in the Chess class and the off-board
squares have a value of “7”:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">private</code> <code class="kd">static</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">initialBoard</code> <code class="o">=</code> <code class="p">{</code>
     <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>
     <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>
     <code class="mi">4</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>   <code class="c1">// white pieces</code>
     <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>   <code class="c1">// white pawns</code>
     <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>   <code class="c1">// 8 blank squares</code>
     <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>   <code class="c1">// 8 blank squares</code>
     <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>   <code class="c1">// 8 blank squares</code>
     <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>   <code class="c1">// 8 blank squares</code>
     <code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>  <code class="c1">// black pawns</code>
     <code class="o">-</code><code class="mi">4</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">5</code><code class="p">,</code><code class="o">-</code><code class="mi">9</code><code class="p">,</code><code class="o">-</code><code class="mi">3</code><code class="p">,</code><code class="o">-</code><code class="mi">2</code><code class="p">,</code><code class="o">-</code><code class="mi">4</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>  <code class="c1">// black pieces</code>
     <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code>
     <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code>
    <code class="p">};</code>
</pre></div>

</figure>


<div class="figure-wrapper center">
  <figure id="chessgame1a" class="image" style="width: 282px">
    <img src="images/chess_game_1a.png" alt="First example chess board" style="width: 100%">
    <figcaption>First example chess board</figcaption>
  </figure>
</div>


<p>It is difficult to see from this listing of the board square values but
in effect a regular chess board if padded on all sides with two rows and
columns of ``7” values.</p>

<p>We see the start of a sample chess game in the previous figure and
the continuation of this same game in the next figure.The
lookahead is limited to 2 moves (4 ply).</p>


<div class="figure-wrapper center">
  <figure id="chessgame1b" class="image" style="width: 231px">
    <img src="images/chess_game_1b.png" alt="Second example chess board" style="width: 100%">
    <figcaption>Second example chess board</figcaption>
  </figure>
</div>


<p>The class <strong>ChessPosition</strong> contains data for this representation and
defines constant values for playing sides and piece types:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kd">class</code> <code class="nc">ChessPosition</code> <code class="kd">extends</code> <code class="n">Position</code> <code class="p">{</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">BLANK</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">HUMAN</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">PROGRAM</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">PAWN</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">KNIGHT</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">BISHOP</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">ROOK</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">QUEEN</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
        <code class="kd">final</code> <code class="kd">static</code> <code class="kd">public</code> <code class="kt">int</code> <code class="n">KING</code> <code class="o">=</code> <code class="mi">6</code><code class="p">;</code>
        <code class="kt">int</code> <code class="o">[]</code> <code class="n">board</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">int</code><code class="o">[</code><code class="mi">120</code><code class="o">]</code><code class="p">;</code>
        <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="p">()</code> <code class="p">{</code>
            <code class="n">StringBuffer</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuffer</code><code class="p">(</code><code class="s">"["</code><code class="p">);</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">22</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">""</code><code class="o">+</code><code class="n">board</code><code class="o">[</code><code class="n">i</code><code class="o">]+</code><code class="s">","</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">"]"</code><code class="p">);</code>
            <code class="k">return</code> <code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
        <code class="p">}</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>Chess</strong> also defines other static data. The following array is
used to encode the values assigned to each piece type (e.g., pawns are
worth one point, knights and bishops are worth 3 points, etc.):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">private</code> <code class="kd">static</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">value</code> <code class="o">=</code> <code class="p">{</code>
        <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">12</code>
      <code class="p">};</code>
</pre></div>

</figure>

<p>The following array is used to codify the possible incremental moves for
pieces:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">private</code> <code class="kd">static</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">pieceMovementTable</code> <code class="o">=</code> <code class="p">{</code>
        <code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="o">-</code><code class="mi">10</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="o">-</code><code class="mi">10</code><code class="p">,</code> <code class="o">-</code><code class="mi">9</code><code class="p">,</code> <code class="o">-</code><code class="mi">11</code><code class="p">,</code> <code class="mi">9</code><code class="p">,</code>
        <code class="mi">11</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="o">-</code><code class="mi">8</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="o">-</code><code class="mi">12</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="o">-</code><code class="mi">19</code><code class="p">,</code> <code class="mi">21</code><code class="p">,</code> <code class="o">-</code><code class="mi">21</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code>
        <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code>
      <code class="p">};</code>
</pre></div>

</figure>

<p>The starting index into the pieceMovementTable array is calculated by
indexing the following array with the piece type index (e.g., pawns are
piece type 1, knights are piece type 2, bishops are piece type 3, rooks
are piece type 4, etc.:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">private</code> <code class="kd">static</code> <code class="kt">int</code> <code class="o">[]</code> <code class="n">index</code> <code class="o">=</code> <code class="p">{</code>
        <code class="mi">0</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">15</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">6</code>
      <code class="p">};</code>
</pre></div>

</figure>

<p>When we implement the method <strong>possibleMoves</strong> for the class <strong>Chess</strong>, we
will see that except for pawn moves, all other possible piece type moves
are very easy to calculate using this static data. The method
<strong>possibleMoves</strong> is simple because it uses a private helper method
<strong>calcPieceMoves</strong> to do the real work. The method <strong>possibleMoves</strong>
calculates all possible moves for a given board position and side to
move by calling <strong>calcPieceMove</strong> for each square index that references a
piece for the side to move.</p>

<p>We need to perform similar actions for calculating possible moves and
squares that are controlled by each side. In the first version of the
class Chess that I wrote, I used a single method for calculating both
possible move squares and controlled squares. However, the code was
difficult to read, so I split this initial move generating method out
into three methods:</p>

<ul>
  <li>possibleMoves – required because this was an abstract method in GameSearch. This method calls calcPieceMoves for all squares containing pieces for the side to move, and collects all possible
moves.</li>
  <li>calcPieceMoves – responsible to calculating pawn moves and other piece type moves for a specified square index.</li>
  <li>setControlData – sets the global array computerControl and humanControl. This method is similar to a combination of possibleMoves and calcPieceMoves, but takes into effect “moves” onto squares that belong to the same side for calculating the effect of one piece guarding another. This control data is used in the board position evaluation method <strong>positionEvaluation</strong>.</li>
</ul>

<p>We will discuss <strong>calcPieceMoves</strong> here, and leave it as an exercise to
carefully read the similar method <strong>setControlData</strong> in the source code.
This method places the calculated piece movement data in static storage
(the array piece_moves) to avoid creating a new Java object whenever
this method is called; method <strong>calcPieceMoves</strong> returns an integer count
of the number of items placed in the static array piece_moves. The
method <strong>calcPieceMoves</strong> is called with a position and a square index;
first, the piece type and side are determined for the square index:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">private</code> <code class="kt">int</code> <code class="nf">calcPieceMoves</code><code class="p">(</code><code class="n">ChessPosition</code> <code class="n">pos</code><code class="p">,</code>
                                 <code class="kt">int</code> <code class="n">square_index</code><code class="p">)</code> <code class="p">{</code>
        <code class="kt">int</code> <code class="o">[]</code> <code class="n">b</code> <code class="o">=</code> <code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">piece</code> <code class="o">=</code> <code class="n">b</code><code class="o">[</code><code class="n">square_index</code><code class="o">]</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">piece_type</code> <code class="o">=</code> <code class="n">piece</code><code class="p">;</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">piece_type</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code> <code class="n">piece_type</code> <code class="o">=</code> <code class="o">-</code><code class="n">piece_type</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">piece_index</code> <code class="o">=</code> <code class="n">index</code><code class="o">[</code><code class="n">piece_type</code><code class="o">]</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">move_index</code> <code class="o">=</code> <code class="n">pieceMovementTable</code><code class="o">[</code><code class="n">piece_index</code><code class="o">]</code><code class="p">;</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">piece</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code> <code class="n">side_index</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
        <code class="k">else</code>              <code class="n">side_index</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then, a switch statement controls move generation for each type of chess
piece (movement generation code is not shown – see the file Chess.java):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="k">switch</code> <code class="p">(</code><code class="n">piece_type</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">case</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">PAWN</code><code class="p">:</code>
          <code class="k">break</code><code class="p">;</code>
        <code class="k">case</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">KNIGHT</code><code class="p">:</code>
        <code class="k">case</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">BISHOP</code><code class="p">:</code>
        <code class="k">case</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">ROOK</code><code class="p">:</code>
        <code class="k">case</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">KING</code><code class="p">:</code>
        <code class="k">case</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">QUEEN</code><code class="p">:</code>
          <code class="k">break</code><code class="p">;</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>The logic for pawn moves is a little complex but the implementation is
simple. We start by checking for pawn captures of pieces of the opposite
color. Then check for initial pawn moves of two squares forward, and
finally, normal pawn moves of one square forward. Generated possible
moves are placed in the static array piece_moves and a possible move
count is incremented. The move logic for knights, bishops, rooks,
queens, and kings is very simple since it is all table driven. First, we
use the piece type as an index into the static array index; this value
is then used as an index into the static array <strong>pieceMovementTable</strong>.
There are two loops: an outer loop fetches the next piece movement delta
from the <strong>pieceMovementTable</strong> array and the inner loop applies the piece
movement delta set in the outer loop until the new square index is off
the board or “runs into” a piece on the same side. Note that for kings
and knights, the inner loop is only executed one time per iteration
through the outer loop:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="n">move_index</code> <code class="o">=</code> <code class="n">piece</code><code class="p">;</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">move_index</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code> <code class="n">move_index</code> <code class="o">=</code> <code class="o">-</code><code class="n">move_index</code><code class="p">;</code>
        <code class="n">move_index</code> <code class="o">=</code> <code class="n">index</code><code class="o">[</code><code class="n">move_index</code><code class="o">]</code><code class="p">;</code>
        <code class="c1">//System.out.println("move_index="+move_index);</code>
        <code class="n">next_square</code> <code class="o">=</code>
            <code class="n">square_index</code> <code class="o">+</code> <code class="n">pieceMovementTable</code><code class="o">[</code><code class="n">move_index</code><code class="o">]</code><code class="p">;</code>
      <code class="n">outer</code><code class="p">:</code>
        <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">inner</code><code class="p">:</code>
            <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">next_square</code> <code class="o">&gt;</code> <code class="mi">99</code><code class="p">)</code> <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">next_square</code> <code class="o">&lt;</code> <code class="mi">22</code><code class="p">)</code> <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">b</code><code class="o">[</code><code class="n">next_square</code><code class="o">]</code> <code class="o">==</code> <code class="mi">7</code><code class="p">)</code> <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
                
              <code class="c1">// check for piece on the same side:</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">side_index</code> <code class="o">&lt;</code> <code class="mi">0</code> <code class="o">&amp;&amp;</code> <code class="n">b</code><code class="o">[</code><code class="n">next_square</code><code class="o">]</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code>                 
                 <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">side_index</code> <code class="o">&gt;</code><code class="mi">0</code> <code class="o">&amp;&amp;</code> <code class="n">b</code><code class="o">[</code><code class="n">next_square</code><code class="o">]</code>  <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> 
                 <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
                
              <code class="n">piece_moves</code><code class="o">[</code><code class="n">count</code><code class="o">++]</code> <code class="o">=</code> <code class="n">next_square</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">b</code><code class="o">[</code><code class="n">next_square</code><code class="o">]</code> <code class="o">!=</code> <code class="mi">0</code><code class="p">)</code> <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">piece_type</code> <code class="o">==</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">KNIGHT</code><code class="p">)</code>
                 <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">piece_type</code> <code class="o">==</code> <code class="n">ChessPosition</code><code class="p">.</code><code class="na">KING</code><code class="p">)</code>
                 <code class="k">break</code> <code class="n">inner</code><code class="p">;</code>
              <code class="n">next_square</code> <code class="o">+=</code> <code class="n">pieceMovementTable</code><code class="o">[</code><code class="n">move_index</code><code class="o">]</code><code class="p">;</code>
           <code class="p">}</code>
           <code class="n">move_index</code> <code class="o">+=</code> <code class="mi">1</code><code class="p">;</code>
           <code class="k">if</code> <code class="p">(</code><code class="n">pieceMovementTable</code><code class="o">[</code><code class="n">move_index</code><code class="o">]</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code>
              <code class="k">break</code> <code class="n">outer</code><code class="p">;</code>
           <code class="n">next_square</code> <code class="o">=</code> <code class="n">square_index</code> <code class="o">+</code> 
                            <code class="n">pieceMovementTable</code><code class="o">[</code><code class="n">move_index</code><code class="o">]</code><code class="p">;</code>
       <code class="p">}</code>
</pre></div>

</figure>

<p>The figures show the start of a second example game. The
computer was making too many trivial mistakes in the first game so here
I increased the lookahead to 2 1/2 moves. Now the computer takes one to
two seconds per move and plays a better game. Increasing the lookahead
to 3 full moves yields a better game but then the program can take up to
about ten seconds per move.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 223px">
    <img src="images/chess_game_2a.png" alt="After 1 d4 e6 2 e4 Qh4 Black (the computer) increases the mobility of its pieces by bringing out the queen early but we will see that this soon gets black in trouble." style="width: 100%">
    <figcaption>After 1 d4 e6 2 e4 Qh4 Black (the computer) increases the mobility of its pieces by bringing out the queen early but we will see that this soon gets black in trouble.</figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 204px">
    <img src="images/chess_game_2b.png" alt="After 3 Nc3 Nf6 4 Bd3 Bb4 5 Nf3 Qh5 Black continues to develop pieces and puts pressure on the pawn on E4 but the vulnerable queen makes this a weak position for black." style="width: 100%">
    <figcaption>After 3 Nc3 Nf6 4 Bd3 Bb4 5 Nf3 Qh5 Black continues to develop pieces and puts pressure on the pawn on E4 but the vulnerable queen makes this a weak position for black.</figcaption>
  </figure>
</div>


<p>The method <strong>setControlData</strong> is very similar to this method; I leave it
as an exercise to the reader to read through the source code. Method
<strong>setControlData</strong> differs in also considering moves that protect pieces
of the same color; calculated square control data is stored in the
static arrays <strong>computerControl</strong> and <strong>humanControl</strong>. This square control
data is used in the method <strong>positionEvaluation</strong> that assigns a numerical
rating to a specified chessboard position on either the computer or
human side. The following aspects of a chessboard position are used for
the evaluation:</p>

<ul>
  <li>material count (pawns count 1 point, knights and bishops 3 points, etc.)</li>
  <li>count of which squares are controlled by each side</li>
  <li>extra credit for control of the center of the board</li>
  <li>credit for attacked enemy pieces</li>
</ul>

<p>Notice that the evaluation is calculated initially assuming the
computer’s side to move. If the position if evaluated from the human
player’s perspective, the evaluation value is multiplied by minus one.
The implementation of <strong>positionEvaluation</strong> is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">float</code> <code class="nf">positionEvaluation</code><code class="p">(</code><code class="n">Position</code> <code class="n">p</code><code class="p">,</code>
                                      <code class="kt">boolean</code> <code class="n">player</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">ChessPosition</code> <code class="n">pos</code> <code class="o">=</code> <code class="p">(</code><code class="n">ChessPosition</code><code class="p">)</code><code class="n">p</code><code class="p">;</code>
        <code class="kt">int</code> <code class="o">[]</code> <code class="n">b</code> <code class="o">=</code> <code class="n">pos</code><code class="p">.</code><code class="na">board</code><code class="p">;</code>
        <code class="kt">float</code> <code class="n">ret</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
        <code class="c1">// adjust for material:</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">22</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">!=</code> <code class="mi">0</code> <code class="o">&amp;&amp;</code> <code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">!=</code> <code class="mi">7</code><code class="p">)</code>  <code class="n">ret</code> <code class="o">+=</code> <code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
        <code class="p">}</code>
        
        <code class="c1">// adjust for positional advantages:</code>
        <code class="n">setControlData</code><code class="p">(</code><code class="n">pos</code><code class="p">);</code>
        <code class="kt">int</code> <code class="n">control</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">22</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">control</code> <code class="o">+=</code> <code class="n">humanControl</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
          <code class="n">control</code> <code class="o">-=</code> <code class="n">computerControl</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="c1">// Count center squares extra:</code>
        <code class="n">control</code> <code class="o">+=</code> <code class="n">humanControl</code><code class="o">[</code><code class="mi">55</code><code class="o">]</code> <code class="o">-</code> <code class="n">computerControl</code><code class="o">[</code><code class="mi">55</code><code class="o">]</code><code class="p">;</code>
        <code class="n">control</code> <code class="o">+=</code> <code class="n">humanControl</code><code class="o">[</code><code class="mi">56</code><code class="o">]</code> <code class="o">-</code> <code class="n">computerControl</code><code class="o">[</code><code class="mi">56</code><code class="o">]</code><code class="p">;</code>
        <code class="n">control</code> <code class="o">+=</code> <code class="n">humanControl</code><code class="o">[</code><code class="mi">65</code><code class="o">]</code> <code class="o">-</code> <code class="n">computerControl</code><code class="o">[</code><code class="mi">65</code><code class="o">]</code><code class="p">;</code>
        <code class="n">control</code> <code class="o">+=</code> <code class="n">humanControl</code><code class="o">[</code><code class="mi">66</code><code class="o">]</code> <code class="o">-</code> <code class="n">computerControl</code><code class="o">[</code><code class="mi">66</code><code class="o">]</code><code class="p">;</code>

        <code class="n">control</code> <code class="o">/=</code> <code class="mf">10.0f</code><code class="p">;</code>
        <code class="n">ret</code> <code class="o">+=</code> <code class="n">control</code><code class="p">;</code>

        <code class="c1">// credit for attacked pieces:</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">22</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">100</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="mi">0</code> <code class="o">||</code> <code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">==</code> <code class="mi">7</code><code class="p">)</code> <code class="k">continue</code><code class="p">;</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">humanControl</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">&gt;</code> <code class="n">computerControl</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">ret</code> <code class="o">+=</code> <code class="mf">0.9f</code> <code class="o">*</code> <code class="n">value</code><code class="o">[-</code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]]</code><code class="p">;</code>
            <code class="p">}</code>
          <code class="p">}</code> 
          <code class="k">if</code> <code class="p">(</code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">humanControl</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">&lt;</code> <code class="n">computerControl</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">)</code> <code class="p">{</code>
              <code class="n">ret</code> <code class="o">-=</code> <code class="mf">0.9f</code> <code class="o">*</code> <code class="n">value</code><code class="o">[</code><code class="n">b</code><code class="o">[</code><code class="n">i</code><code class="o">]]</code><code class="p">;</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">}</code>
        <code class="c1">// adjust if computer side to move:</code>
        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">player</code><code class="p">)</code> <code class="n">ret</code> <code class="o">=</code> <code class="o">-</code><code class="n">ret</code><code class="p">;</code>
        <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>It is simple to compile and run the example chess program by typing in the <strong>search</strong> directory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    make chess
</pre></div>

</figure>

<p>When asked to enter moves, enter string like “d2d4” to enter a move in chess algebraic notation. Here is sample output from the program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    Board position:

     BR BN BB .  BK BB BN BR
     BP BP BP BP .  BP BP BP
        .     .  BP BQ    . 
     .     .     .     .    
        .     WP    .     . 
     .     .     .  WN .    
     WP WP WP .  WP WP WP WP
     WR WN WB WQ WK WB .  WR
    Your move:
    c2c4
</pre></div>

</figure>

<p>Note that the newest code in the GitHub repository uses Unicode characters to display graphics for Chess pieces.</p>

<p>The example chess program plays in general good moves, but its play
could be greatly enhanced with an “opening book” of common chess opening
move sequences. If you run the example chess program, depending on the
speed of your computer and your Java runtime system, the program takes a
while to move (about 5 seconds per move on my PC). Where is the time
spent in the chess program? The following table shows the
total runtime (i.e., time for a method and recursively all called
methods) and method-only time for the most time consuming methods.
Methods that show zero percent method only time used less than 0.1
percent of the time so they print as zero values.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  Class.method name            % of total runtime       % in this method
  ---------------------------- ------------------------ ----------------
  Chess.main                   97.7                     0.0
  GameSearch.playGame          96.5                     0.0
  GameSearch.alphaBeta         82.6                     0.0
  GameSearch.alphaBetaHelper   82.6                     0.0
  Chess.positionEvaluate       42.9                     13.9
  Chess.setControlData         29.1                     29.1
  Chess.possibleMoves          23.2                     11.3
  Chess.calcPossibleMoves      1.7                      0.8
  Chess.calcPieceMoves         1.7                      0.8
</pre></div>

</figure>

<p>The interested reader is encouraged to choose a simple two-player game, and using the game search class framework, implement your own game-playing program.</p>


<h2 id="reasoning">Reasoning</h2>

<p>While the topic of reasoning may not be as immediately useful for your work as for example deep learning, reasoning is a broad and sometimes useful topic. You might want to just quickly review this chapter and revisit it when and if you need to use any reasoning system. That said, the introductory discussion of logic and reasoning is good background information to know.</p>

<p>In this chapter we will concentrate on the use of the PowerLoom descriptive logic reasoning system. PowerLoom is available with a Java runtime and Java API - this is what I will use for the examples in this chapter. PowerLoom can also be used with other JVM languages like JRuby and Clojure. PowerLoom is also available in Common Lisp and C++ versions.</p>

<p>The PowerLoom system has not been an active project since 2010. As I update this chapter in July 2020, I still consider PowerLoom to be a useful tool for learning about logic based systems and I have attempted to package PowerLoom in a way that will be easy for you to run interactively and I provide a few simple Java examples in the package <strong>com.markwatson.powerloom</strong> that demonstrate how to embed PowerLoom in your own Java programs. The complete Java source for PowerLoom is in the directory <strong>powerloom/src/main/java/edi/isi/powerloom</strong>.</p>

<p>Additionally, we will look at different kinds of reasoning systems (the OWL language) in the chapter on the <a href="#semantic-web">Semantic Web</a> and use this reasoning in the later chapters <a href="#kgcreator">Automatically Generating Data for Knowledge Graphs</a> and <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<p>While the material in this chapter will get you started with development using a powerful reasoning system and embedding this reasoning system in Java applications, you may want to dig deeper and I suggest sources for further study at the end of this chapter.</p>

<p>PowerLoom is a newer version of the classic Loom Descriptive Logic reasoning system written at ISI although as I mentioned earlier it has not been developed past 2010. At some point you may want to download the entire PowerLoom distribution to get more examples and access to documentation; the <a href="http://www.isi.edu/isd/LOOM/PowerLoom/">PowerLoom web site</a>.</p>

<p>While we will look at an example of embedding the PowerLoom runtime and a PowerLoom model in a Java example program, I want to make a general comment on PowerLoom development: you will spend most of your time interactively running PowerLoom in an interactive shell that lets you type in concepts, relations, rules, and queries and immediately see the results. If you have ever programmed in Lisp, then this mode of interactive programming will be familiar to you. As seen in the next figure, after interactive development you can deploy in a Java application. This style of development supports entering facts and trying rules and relations interactively and as you get things working you can paste what works into a PowerLoom source file. If you have only worked with compiled languages like Java and C++ this development style may take a while to get used to and appreciate. As seen in the next figure the PowerLoom runtime system, with relations and rules, can be embedded in Java applications that typically clear PowerLoom data memory, assert facts from other live data sources, and then use PowerLoom for inferencing.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 443px">
    <img src="images/reasoning_overview.png" alt="Developing Reasoning Systems" style="width: 100%">
    <figcaption>Developing Reasoning Systems</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-logic">Logic</h3>

<p>We will look at different types of logic and reasoning systems in this section and then later we will get into PowerLoom specific examples. Logic is the basis for both Knowledge Representation and for reasoning about knowledge. We will encode knowledge using logic and see that we can then infer new facts that are not explicitly asserted. In AI literature you often see discussions of implicit vs. explicit knowledge. Implicit knowledge is inferred from explicitly stated information by using a reasoning system.</p>

<p>First Order Logic was invented by the philosophers Frege and Peirce and is the most widely studied logic system. Unfortunately, full First Order Logic is not computationally tractable for most non-trivial problems so we use more restricted logics. We will use two reasoning systems in this book that support more limited logics:</p>

<ul>
  <li>We use PowerLoom in this chapter. PowerLoom supports a combination of limited first order predicate logic and features of description logic. PowerLoom is able to classify objects, use rules to infer facts from existing facts and to perform subsumption (determining class membership of instances).</li>
  <li>We will use RDF Schema (RDFS) reasoning in the
<a href="#semantic-web">Chapter on Semantic Web</a>. RDFS supports more limited reasoning than descriptive logic reasoners like PowerLoom and OWL Description Logic
reasoners.</li>
</ul>

<h4 id="leanpub-auto-history-of-logic">History of Logic</h4>

<p>The Greek philosopher Aristotle studied forms of logic as part of his desire to improve the representation of knowledge. He started a study of logic and the definition of both terms (e.g., subjects, predicates, nouns, verbs) and types of logical deduction. Much later the philosopher
Frege defined predicate logic (for example: All birds have feathers. Brady is a bird, therefore Brady has feathers) that forms the basis for the modern Prolog programming language.</p>

<h4 id="leanpub-auto-examples-of-different-logic-types">Examples of Different Logic Types</h4>

<p>Propositional logic is limited to atomic statements that can be either
true or false:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    Brady-is-a-bird
    Brady-has-feathers
</pre></div>

</figure>

<p>First Order Predicate Logic allows access to the structure of logic statements dealing with predicates that operate on atoms. To use a Prolog notation:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="nf">feathers</code><code class="p">(</code><code class="nv">X</code><code class="p">)</code> <code class="p">:-</code> <code class="nf">bird</code><code class="p">(</code><code class="nv">X</code><code class="p">).</code>
    <code class="nf">bird</code><code class="p">(</code><code class="s s-Atom">brady</code><code class="p">).</code>
</pre></div>

</figure>

<p>In this example, “feathers” and “bird” are predicates and “brady” is an atom. The first example states that for all X, if X is a bird, then X has
feathers. In the second example we state that Brady is a bird. Notice that in the Prolog notation that we are using, variables are capitalized and predicate names and literal atoms are lower case.</p>

<p>Here is a query that asks who has feathers:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="s s-Atom">?-</code> <code class="nf">feathers</code><code class="p">(</code><code class="nv">X</code><code class="p">).</code>
    <code class="nv">X</code> <code class="o">=</code> <code class="s s-Atom">brady</code>
</pre></div>

</figure>

<p>In this example through inference we have determined a new fact, that Brady has feathers because we know that Brady is a bird and we have the rule (or predicate) stating that all birds have feathers. Prolog is not strictly a pure logic programming language since the order in which rules (predicates) are defined changes the inference results. Prolog is a great language for some types of projects (I have used Prolog in both natural language processing and in planning systems). We will see that PowerLoom is considerably more flexible than Prolog but does have a steep learning curve.</p>

<p>Description Logic deals with descriptions of concepts and how these descriptions define the domain of concepts. In terms used in object oriented programming languages: membership in a class is determined implicitly by the description of the object and not by explicitly stating something like “Brady is a member of the bird class.”
Description logics divide statements into relations (historically referred to as TBox) and concepts (historically called ABox). We would say that a statement like “All birds have feathers” is stored in the TBox while a specific assertion like “Brady is a bird” is stored in the ABox.</p>

<h3 id="powerloom-overview">PowerLoom Overview</h3>

<p>PowerLoom is designed to be an expressive language for knowledge representation and reasoning. As a result, PowerLoom is not a complete reasoning system but makes tradeoffs for completeness of inferences and expressivity vs. computational efficiency. It is interesting to note that Loom and PowerLoom were designed and implemented to solve real world problems and the tradeoffs to make these problems computationally tractable have informed the design and implementation of these systems. PowerLoom does not make all possible inferences from concepts that it operates on.</p>

<p>The PowerLoom distribution contains two very detailed examples for representing relationships between companies and for information dealing with airplanes. These examples are more detailed than the simpler examples in this chapter. We will look at just one of these examples (business rules and relations) and after working through this chapter, I encourage you to interactively experiment with the two examples that ship with PowerLoom.</p>

<p>We will start by defining some terms used in PowerLoom:</p>

<ul>
  <li>concept - the Java equivalent would be an instance of a class.</li>
  <li>relation - specifies a link between two concepts.</li>
  <li>function - functional mapping of one concept to another.</li>
  <li>rule - allows new concepts to be deduced without explicitly asserting them.</li>
</ul>

<p>A relation can specify the types of concepts that a relation connects. An example will make this clear and introduce the Lisp-like syntax of PowerLoom statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="o">;;;</code> <code class="nt">Concepts</code><code class="o">:</code> 
<code class="linenos">2 </code>    <code class="o">(</code><code class="nt">defconcept</code> <code class="nt">person</code><code class="o">)</code> 
<code class="linenos">3 </code>    <code class="o">(</code><code class="nt">defconcept</code> <code class="nt">parent</code> <code class="o">(?</code><code class="nt">p</code> <code class="nt">person</code><code class="o">))</code> 
<code class="linenos">4 </code>     
<code class="linenos">5 </code>    <code class="o">;;;</code> <code class="nt">Relation</code><code class="o">:</code> 
<code class="linenos">6 </code>    <code class="o">(</code><code class="nt">defrelation</code> <code class="nt">parent-of</code> <code class="o">((?</code><code class="nt">p1</code> <code class="nt">parent</code><code class="o">)</code> <code class="o">(?</code><code class="nt">p2</code> <code class="nt">person</code><code class="o">)))</code>
</pre></div>

</figure>

<p>Here I have defined two concepts: person and parent. Note that we have a hierarchy of concept types: the parent is a more specific concept type than the person concept. I loose metaphor is that in object oriented programming a parent is a subclass of a person and this hierarchy is stated in line 3 of the last listing. All instances that are parents are also of type person. The relation parent-of links a parent concept to a person
concept.</p>

<p>We will learn more about basic PowerLoom functionality in the next two sections as we use PowerLoom in an interactive session and when we embed PowerLoom in a Java example program.</p>

<h3 id="running-powerloom">Running PowerLoom Interactively</h3>

<p>We will experiment with PowerLoom concepts, relations, and rules in this section in an interactive command shell. I will introduce more examples of PowerLoom functionality for asserting instances of concepts, performing queries, loading PowerLoom source files, defining relations, using separate modules, and asking PowerLoom to explain the inference process that it used for query processing.</p>

<p>You can run PowerLoom using the command line interface using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">cd</code> <code class="nv">powerloom</code>
<code class="nv">mvn</code> <code class="nv">install</code>
<code class="nv">mvn</code> <code class="k">exec</code>:<code class="nv">java</code> <code class="o">-</code><code class="nv">Dexec</code>.<code class="nv">mainClass</code><code class="o">=</code><code class="s2">"</code><code class="s">edu.isi.powerloom.PowerLoom</code><code class="s2">"</code>
</pre></div>

</figure>

<p>This starts the PowerLoom standalone system and prints a prompt that includes the name of the current module. The default module name is “PL-USER”. In the first example, when I enter the person concept at the interactive prompt then PowerLoom prints the result of the expression that just entered. You can enter <strong>(demo)</strong> to have access to all of the demo scripts from the PowerLoom distribution. These demo files are in the subdirectory <strong>powerloom/sources/logic/demos</strong> in the GitHub repository for this book.</p>

<p>Please note that depending on which terminal you are running in, the prompt “PL-USER” does not occur until after entering an “extra” return or enter key.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    PL-USER |= (defconcept person)
    |c|PERSON
    PL-USER |= (defconcept parent (?p person))
    |c|PARENT
    PL-USER |= (defrelation parent-of
                  ((?p1 parent) (?p2 person)))
    |r|PARENT-OF
    PL-USER |= (assert (person Ken))
    |P|(PERSON KEN)
    PL-USER |= (assert (person Mark))
    |P|(PERSON MARK)
    PL-USER |= (assert (parent-of Ken Mark))
    |P|(PARENT-OF KEN MARK)
</pre></div>

</figure>

<p>Now that we have entered two concepts, a test relation, and asserted a few facts, we can look at an example of PowerLoom’s query language:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    PL-USER |= (retrieve all ?p (person ?p))
    There are 2 solutions:
      #1: ?P=MARK
      #2: ?P=KEN
    PL-USER |= (retrieve all ?p (parent ?p))
    There is 1 solution:
      #1: ?P=KEN
    PL-USER |= 
</pre></div>

</figure>

<p>The obvious point to note from this example is that we never specified that Ken was a parent; rather, PowerLoom deduced this from the parent-of relation. The asserted data is explicit data while the inferred data is implicit and only exists when required to reason over a query.</p>

<p>PowerLoom’s command line system prompts you with the string ``PL-USER
|=`` and you can type any definition or query. Like Lisp, PowerLoom
uses a prefix notation and expressions are contained in parenthesis.
PowerLoom supports a module system for partitioning concepts, relations,
functions, and rules into different sets and as previously mentioned
“PL-USER” is the default module. PowerLoom modules can form a hierarchy,
inheriting concepts, relations, and rules from parent modules.</p>

<p>The subdirectory <strong>test_data</strong> contains the demo file <strong>business.plm</strong> written by Robert MacGregor that is supplied with the full PowerLoom distribution. You can load his complete example using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">PL</code><code class="o">-</code><code class="n">USER</code> <code class="o">|=</code> <code class="p">(</code><code class="nb">load</code> <code class="s2">"test_data/business.plm"</code><code class="p">)</code>
</pre></div>

</figure>

<p>This is a good example because it demonstrates most of the available functionality of PowerLoom in a short 200 lines. When you are finished reading this chapter, please take a few minutes to read through this example file since I do not list all of it it here. There are a few things to notice in this example. Here we see a rule used to make the relation “contains” transitive:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    (defrelation contains (
           (?l1 geographic-location)
           (?l2 geographic-location)))

    (defrule transitive-contains
      (=&gt; (and (contains ?l1 ?l2)
               (contains ?l2 ?l3))
          (contains ?l1 ?l3)))
</pre></div>

</figure>

<p>The operator =&gt; means that if the first clause is true then so is the second. In English, this rule could be stated “if an instance <strong>i1</strong> contains <strong>i2</strong> and if instance <strong>i2</strong> contains <strong>i3</strong> then we can infer that <strong>i1</strong> also contains <strong>i3</strong>.” To see how this rule works in practice, we can switch to the example module “BUSINESS” and find all locations contained inside another location:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    PL-USER |= (in-module "BUSINESS")
    BUSINESS |= (retrieve all
                  (?location1 ?location2)
                  (contains ?location1 ?location2))
    There are 15 solutions:
      #1: ?LOCATION1=SOUTHERN-US, ?LOCATION2=TEXAS
      #2: ?LOCATION1=TEXAS, ?LOCATION2=AUSTIN
      #3: ?LOCATION1=TEXAS, ?LOCATION2=DALLAS
      #4: ?LOCATION1=UNITED-STATES, ?LOCATION2=SOUTHERN-US
      #5: ?LOCATION1=GEORGIA, ?LOCATION2=ATLANTA
      #6: ?LOCATION1=EASTERN-US, ?LOCATION2=GEORGIA
      #7: ?LOCATION1=UNITED-STATES, ?LOCATION2=EASTERN-US
      #8: ?LOCATION1=SOUTHERN-US, ?LOCATION2=DALLAS
      #9: ?LOCATION1=SOUTHERN-US, ?LOCATION2=AUSTIN
      #10: ?LOCATION1=UNITED-STATES, ?LOCATION2=DALLAS
      #11: ?LOCATION1=UNITED-STATES, ?LOCATION2=TEXAS
      #12: ?LOCATION1=UNITED-STATES, ?LOCATION2=AUSTIN
      #13: ?LOCATION1=EASTERN-US, ?LOCATION2=ATLANTA
      #14: ?LOCATION1=UNITED-STATES, ?LOCATION2=GEORGIA
      #15: ?LOCATION1=UNITED-STATES, ?LOCATION2=ATLANTA
    BUSINESS |= 
</pre></div>

</figure>

<p>Here we have fifteen solutions even though there are only seven <strong>contains</strong> relations asserted in the business.plm file, the other eight solutions were inferred. In addition to the <strong>retrieve</strong> function that finds solutions matching a query you can also use the <strong>ask</strong> function to determine if a specified relation is true; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    BUSINESS |= (ask (contains UNITED-STATES DALLAS))
    TRUE
    BUSINESS |= 
</pre></div>

</figure>

<p>For complex queries you can use the “why” function to see how PowerLoom solved the last query:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    BUSINESS |= (ask (contains southern-us dallas))
    TRUE
    BUSINESS |= (why)
    1 (CONTAINS ?location1 ?location2)
        follows by Modus Ponens
        with substitution {?l1/SOUTHERN-US, ?l3/DALLAS,
                           ?l2/TEXAS}
        since 1.1 ! (FORALL (?l1 ?l3)
                       (&lt;= (CONTAINS ?l1 ?l3)
                           (EXISTS (?l2)
                              (AND (CONTAINS ?l1 ?l2)
                                   (CONTAINS ?l2 ?l3)))))
        and   1.2 ! (CONTAINS SOUTHERN-US TEXAS)
        and   1.3 ! (CONTAINS TEXAS DALLAS)
    BUSINESS |= 
</pre></div>

</figure>

<p>By default the explanation facility is turned off because it causes PowerLoom to run more slowly; it was turned on in the file business.plm using the statement:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    (set-feature justifications)
</pre></div>

</figure>

<h3 id="leanpub-auto-using-the-powerloom-apis-in-java-programs">Using the PowerLoom APIs in Java Programs</h3>

<p>Once you interactively develop concepts, rules and relations then it is likely that you may want to use them with PowerLoom in an embedded mode, making PowerLoom a part of your application. I will get you started with a few Java example programs. The source code for this chapter divide into two packages:</p>

<ul>
  <li>edu.isi.powerloom - source code from the PowerLoom web site.</li>
  <li>com.markwatson.powerloom - book example code for utilities and two embedded examples.</li>
</ul>

<p>These packages can be seen in this screen shot:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/powerloom-ide1.png" alt="Powerloom example in IntelliJ IDE" style="width: 100%">
    <figcaption>Powerloom example in IntelliJ IDE</figcaption>
  </figure>
</div>


<p>If you download the PowerLoom manual (a PDF file) from the PowerLoom web site, you will have the complete Java API documentation for the Java version of PowerLoom (there are also C++ and Common Lisp versions with separate documentation). I have found that I generally use just a small subset of the Java PowerLoom APIs and I have “wrapped” this subset in a wrapper class in the file PowerLoomUtils.java. We will use my wrapper class for the examples in the rest of this chapter.</p>

<p>The following UML class diagram will give you an overview before we dive into the code:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/powerloom.png" alt="UML class diagram for the Powerloom example" style="width: 100%">
    <figcaption>UML class diagram for the Powerloom example</figcaption>
  </figure>
</div>


<p>My wrapper class has the follow public methods:</p>

<ul>
  <li>PowerLoomUtils() - constructor initializes the Java PowerLoom runtime system.</li>
  <li>load(String fpath) - load a source *.plm file.</li>
  <li>changeModule(String workingModule) - set the current PowerLoom working module (“PL-USER” is the default module).</li>
  <li>assertProposition(String proposition) - asserts a new proposition; for example: “(and (company c3) (company-name c3 \“Moms Grocery\”))”. Note that quotation marks are escaped with a backslash character. You can also use single quote characters like:
“(and (company c3) (company-name c3 ’Moms Grocery’))” because I convert single quotes in my wrapper code.</li>
  <li>createRelation(String relation, int arity) - create a new relation with a specified arity (number of “arguments”). For example you could create a relation “owns” with arity 2 and then assert “(owns Elaine ’Moms Grocery’)” - I usually do not use this API since I prefer to place relations (with rules) in a source code file ending in the extension *.plm.</li>
  <li>doQuery(String query) - returns a list of results from a query. Each result in the list is itself a list.</li>
</ul>

<p>You will always want to work in an interactive PowerLoom console for writing and debugging PowerLoom models. I copied the model in business.plm from the PowerLoom distribution to the subdirectory test_data. Here we use it in an embedded Java example in the file <strong>PowerLoomExample_1.java</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">PowerLoomUtils</code> <code class="n">plu</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PowerLoomUtils</code><code class="p">();</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">load</code><code class="p">(</code><code class="s">"test_data/business.plm"</code><code class="p">);</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">changeModule</code><code class="p">(</code><code class="s">"BUSINESS"</code><code class="p">);</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">assertProposition</code><code class="p">(</code>
         <code class="s">"(and (company c1)"</code> <code class="o">+</code>
         <code class="s">"     (company-name c1 \"Moms Grocery\"))"</code><code class="p">);</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">assertProposition</code><code class="p">(</code>
         <code class="s">"(and (company c2)"</code> <code class="o">+</code>
          <code class="s">"     (company-name c2 \"IBM\"))"</code><code class="p">);</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">assertProposition</code><code class="p">(</code>
         <code class="s">"(and (company c3)"</code> <code class="o">+</code>
         <code class="s">"     (company-name c3 \"Apple\"))"</code><code class="p">);</code>
    <code class="n">List</code> <code class="n">answers</code> <code class="o">=</code> <code class="n">plu</code><code class="p">.</code><code class="na">doQuery</code><code class="p">(</code><code class="s">"all ?x (company ?x)"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">answers</code><code class="p">);</code>
    <code class="c1">// answers: [[C3], [C2], [C1]]</code>
    <code class="n">answers</code> <code class="o">=</code> <code class="n">plu</code><code class="p">.</code><code class="na">doQuery</code><code class="p">(</code>
         <code class="s">"all (?x ?name)"</code> <code class="o">+</code>
         <code class="s">"    (and"</code> <code class="o">+</code>
         <code class="s">"      (company ?x)"</code> <code class="o">+</code>
         <code class="s">"      (company-name ?x ?name))"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">answers</code><code class="p">);</code>
    <code class="c1">// answers:</code>
    <code class="c1">//   [[C3, "Apple"],</code>
    <code class="c1">//    [C2, "IBM"],</code>
    <code class="c1">//    [C1, "Moms Grocery"]]</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">createRelation</code><code class="p">(</code><code class="s">"CEO"</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
    <code class="n">plu</code><code class="p">.</code><code class="na">assertProposition</code><code class="p">(</code>
         <code class="s">"(CEO \"Apple\" \"SteveJobs\")"</code><code class="p">);</code>
    <code class="n">answers</code> <code class="o">=</code> <code class="n">plu</code><code class="p">.</code><code class="na">doQuery</code><code class="p">(</code>
         <code class="s">"all (?x ?name ?ceo)"</code> <code class="o">+</code>
         <code class="s">"    (and"</code> <code class="o">+</code>
         <code class="s">"      (company-name ?x ?name)"</code> <code class="o">+</code>
         <code class="s">"      (CEO ?name ?ceo))"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">answers</code><code class="p">);</code>
    <code class="c1">// answers: [[C3, "Apple", "SteveJobs"]]</code>
</pre></div>

</figure>

<p>I have added the program output produced by printing the value of the list variable “answers” as comments after each <strong>System.out.println</strong> call. In the wrapper API calls that take a string argument, I broke long strings over several lines for formatting to the width of a page; you would not do this in your own programs because of the cost of the extra string concatenation.</p>

<p>We will not look at the implementation of the <strong>PowerLoomUtils</strong> class, you can read the code if you are interested. That said, I will make a few comments on the Java PowerLoom APIs. The class <strong>PLI</strong> contains
static methods for initializing the system, loading PowerLoom source files. Here are a few examples:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">PLI</code><code class="p">.</code><code class="na">initialize</code><code class="p">();</code>
      <code class="n">PLI</code><code class="p">.</code><code class="na">load</code><code class="p">(</code><code class="s">"business.plm"</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code>
      <code class="n">PLI</code><code class="p">.</code><code class="na">changeModule</code><code class="p">(</code><code class="s">"BUSINESS"</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-suggestions-for-further-study">Suggestions for Further Study</h3>

<p>This chapter has provided a brief introduction to PowerLoom. I also showed you how to go about embedding
PowerLoom in your Java programs to add capabilities for knowledge representation and reasoning. Assuming that you see benefit to further study I recommend reading through the PowerLoom manual and the presentations (PDF files) on the PowerLoom web site. As you read through this material it is best to have an interactive PowerLoom session open to try the examples as you read them.</p>

<p>Knowledge Representation and Logic are huge subjects and I will close out this chapter by recommending a few books that have been the most helpful to me:</p>

<ul>
  <li>
<em>Knowledge Representation</em> by John Sowa. This has always been my favorite reference for knowledge representation, logic, and
ontologies.</li>
  <li>
<em>Artificial Intelligence, A Modern Approach</em> by Stuart Russell and Peter Norvig. A very good theoretical treatment of logic and knowledge representation.</li>
  <li>
<em>The Art of Prolog</em> by Leon Sterling and Ehud Shapiro. Prolog implements a form of predicate logic that is less expressive than the descriptive logics supported by PowerLoom and OWL (Chapter on <a href="#semantic-web">Semantic Web</a>). That said, Prolog is very efficient and fairly easy to learn and so is sometimes a better choice. This book is one of my favorite general Prolog references.</li>
</ul>

<p>The Prolog language is a powerful AI development tool. Both open source, the SWI-Prolog and Amzi Prolog systems have good Java interfaces. I don’t cover Prolog in this book but there are several very good tutorials on the web if you decide to experiment with Prolog.</p>

<p>We will continue in the chapter on the <a href="#semantic-web">Semantic Web</a> with our study of logic-based reasoning systems in the context of the Semantic Web.</p>


<h2 id="leanpub-auto-anomaly-detection-machine-learning-example">Anomaly Detection Machine Learning Example</h2>

<p>Anomaly detection models are used in one very specific class of use cases: when you have many negative (non-anomaly) examples and relatively few positive (anomaly) examples. We can refer to this as an unbalanced training set. For training we will ignore positive examples, create a model of “how things should be,” and hopefully be able to detect anomalies different from the original negative examples.</p>

<p>If you have a large training set of both negative and positive examples then do not use anomaly detection models. If your training examples are balanced then use a classification model as we will see later in the chapter <a href="#dl4j">Deep Learning Using Deeplearning4j</a>.</p>

<h3 id="leanpub-auto-motivation-for-anomaly-detection">Motivation for Anomaly Detection</h3>

<p>There are two other examples in this book using the University of Wisconsin cancer data. These other examples are supervised learning. Anomaly detection as we do it in this chapter is, more or less, unsupervised learning.</p>

<p>When should we use anomaly detection? You should use supervised learning algorithms like neural networks and logistic classification when there are roughly equal number of available negative and positive examples in the training data. The University of Wisconsin cancer data set is fairly evenly split between negative and positive examples.</p>

<p>Anomaly detection should be used when you have many negative (“normal”) examples and relatively few positive (“anomaly”) examples. For the example in this chapter we will simulate scarcity of positive (“anomaly”) results by preparing the data using the Wisconsin cancer data as follows:</p>

<ul>
  <li>We will split the data into training (60%), cross validation (20%) and testing (20%).</li>
  <li>For the training data, we will discard all but two positive (“anomaly”) examples. We do this to simulate the real world test case where some positive examples are likely to end up in the training data in spite of the fact that we would prefer the training data to only contain negative (“normal”) examples.</li>
  <li>We will use the cross validation data to find a good value for the epsilon meta parameter.</li>
  <li>After we find a good epsilon value, we will calculate the F1 measurement for the model.</li>
</ul>

<h3 id="leanpub-auto-math-primer-for-anomaly-detection">Math Primer for Anomaly Detection</h3>

<p>We are trying to model “normal” behavior and we do this by taking each feature and fitting a Gaussian (bell curve) distribution to each feature. The learned parameters for a Gaussian distribution are the mean of the data (where the bell shaped curve is centered) and the variance. You might be more familiar with the term standard deviation, \(\sigma\). Variance is defined as \( \sigma ^2\).</p>

<p>We will need to calculate the probability of a value <strong>x</strong> given the mean and variance of a probability distribution: \(P(x : \mu, \sigma ^2)\) where \(\mu\) is the mean and \( \sigma ^2\)
 is the squared variance:</p>


$$
P(x : \mu, \sigma ^2) = \frac{1}{{\sigma \sqrt {2\pi } }}e^{{{ - \left( {x - \mu } \right)^2 } \mathord{\left/ {\vphantom {{ - \left( {x - \mu } \right)^2 } {2\sigma ^2 }}} \right. \kern-\nulldelimiterspace} {2\sigma ^2 }}}
$$

<p>where \(x_i\) are the samples and we can calculate the squared variance as:</p>


$$
\sigma^2 = \frac{\displaystyle\sum_{i=1}^{m}(x_i - \mu)^2} {m}
$$

<p>We calculate the parameters of \(\mu\) and \( \sigma ^2\) for each feature. A bell shaped distribution in two dimensions is easy to visualize as is an inverted bowl shape in three dimentions. What if we have many features? Well, the math works and don’t worry about not being able to picture it in your mind.</p>

<h3 id="leanpub-auto-anomalydetection-utility-class">AnomalyDetection Utility Class</h3>

<p>The class <strong>AnomalyDetection</strong> developed in this section is fairly general purpose. It processes a set of training examples and for each feature calculates \(\mu\) and \( \sigma ^2\). We are also training for a third parameter: an epsilon “cutoff” value: if for a given input vector if \(P(x : \mu, \sigma ^2)\) evaluates to a value greater than epsilon then the input vector is “normal”, less than epsilon implies that the input vector is an “anomaly.” The math for calulating these three features from training data is fairly easy but the code is not: we need to organize the training data and search for a value of epsilon that minimizes the error for a cross validaton data set.</p>

<p>To be clear: we separate the input examples into three separate sets of training, cross validation, and testing data. We use the training data to set the model parameters, use the cross validation data to learn an epsilon value, and finally use the testing data to get precision, recall, and F1 scores that indicate how well the model detects anomalies in data not used for training and cross validation.</p>

<p>I present the example program as one long listing, with more code explanation after the listing. Please note the long loop over each input training example starting at line 28 and ending on line 74. The code in lines 25 through 44 processes the input training data sample into three disjoint sets of training, cross validation, and testing data. Then the code in lines 45 through 63 copies these three sets of data to Java arrays.</p>

<p>The code in lines 65 through 73 calculates, for a training example, the value of \(\mu\) (the varible <strong>mu</strong> in the code).</p>

<p>Please note in the code example that I prepend class variables used in methods with “this.” even when it is not required. I do this for legibility and is a personal style.</p>

<p>The following UML class diagram will give you an overview before we dive into the code:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/anomaly-uml.png" alt="UML class diagram for the anomaly detection example" style="width: 100%">
    <figcaption>UML class diagram for the anomaly detection example</figcaption>
  </figure>
</div>


<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="kn">package</code> <code class="nn">com.markwatson.anomaly_detection</code><code class="p">;</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="linenos">  4 </code><code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>
<code class="linenos">  5 </code>
<code class="linenos">  6 </code><code class="cm">/**</code>
<code class="linenos">  7 </code><code class="cm"> * Created by markw on 10/7/15.</code>
<code class="linenos">  8 </code><code class="cm"> */</code>
<code class="linenos">  9 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">AnomalyDetection</code> <code class="p">{</code>
<code class="linenos"> 10 </code>
<code class="linenos"> 11 </code>  <code class="kd">public</code> <code class="nf">AnomalyDetection</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
<code class="linenos"> 12 </code>
<code class="linenos"> 13 </code>  <code class="cm">/**</code>
<code class="linenos"> 14 </code><code class="cm">   * AnomalyDetection is a general purpose class for building anomaly detection</code>
<code class="linenos"> 15 </code><code class="cm">   * models. You should use this type of mdel when you have mostly negative</code>
<code class="linenos"> 16 </code><code class="cm">   * training examples with relatively few positive examples and you need a model</code>
<code class="linenos"> 17 </code><code class="cm">   * that detects postive (anomaly) inputs.</code>
<code class="linenos"> 18 </code><code class="cm">   *</code>
<code class="linenos"> 19 </code><code class="cm">   * @param num_features</code>
<code class="linenos"> 20 </code><code class="cm">   * @param num_training_examples</code>
<code class="linenos"> 21 </code><code class="cm">   * @param training_examples [num_training_examples][num_features]</code>
<code class="linenos"> 22 </code><code class="cm">   */</code>
<code class="linenos"> 23 </code>  <code class="kd">public</code> <code class="nf">AnomalyDetection</code><code class="p">(</code><code class="kt">int</code> <code class="n">num_features</code><code class="p">,</code> <code class="kt">int</code> <code class="n">num_training_examples</code><code class="p">,</code>
<code class="linenos"> 24 </code>                          <code class="kt">double</code> <code class="o">[][]</code> <code class="n">training_examples</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 25 </code>    <code class="n">List</code><code class="o">&lt;</code><code class="kt">double</code><code class="o">[]&gt;</code> <code class="n">training</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;</code><code class="p">();</code>
<code class="linenos"> 26 </code>    <code class="n">List</code><code class="o">&lt;</code><code class="kt">double</code> <code class="o">[]&gt;</code> <code class="n">cross_validation</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;</code><code class="p">();</code>
<code class="linenos"> 27 </code>    <code class="n">List</code><code class="o">&lt;</code><code class="kt">double</code> <code class="o">[]&gt;</code> <code class="n">testing</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;</code><code class="p">();</code>
<code class="linenos"> 28 </code>    <code class="kt">int</code> <code class="n">outcome_index</code> <code class="o">=</code> <code class="n">num_features</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code> <code class="c1">// index of target outcome</code>
<code class="linenos"> 29 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">num_training_examples</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 30 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">&lt;</code> <code class="mf">0.6</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// 60% training</code>
<code class="linenos"> 31 </code>        <code class="c1">// Only keep normal (negative) examples in training, except</code>
<code class="linenos"> 32 </code>        <code class="c1">// remember the reason for using this algorithm is that it</code>
<code class="linenos"> 33 </code>        <code class="c1">// works with many more negative examples than positive</code>
<code class="linenos"> 34 </code>        <code class="c1">// examples, and that the algorithm works even with some positive</code>
<code class="linenos"> 35 </code>        <code class="c1">// examples mixed into the training set. The random test is to</code>
<code class="linenos"> 36 </code>        <code class="c1">// allow about 10% positive examples to get into the training set:</code>
<code class="linenos"> 37 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">training_examples</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">outcome_index</code><code class="o">]</code> <code class="o">&lt;</code> <code class="mf">0.5</code> <code class="o">||</code> <code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">&lt;</code> <code class="mf">0.1</code><code class="p">)</code>
<code class="linenos"> 38 </code>          <code class="n">training</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">training_examples</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos"> 39 </code>      <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">&lt;</code> <code class="mf">0.7</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 40 </code>          <code class="n">cross_validation</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">training_examples</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos"> 41 </code>      <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos"> 42 </code>        <code class="n">testing</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">training_examples</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos"> 43 </code>      <code class="p">}</code>
<code class="linenos"> 44 </code>    <code class="p">}</code>
<code class="linenos"> 45 </code>    <code class="k">this</code><code class="p">.</code><code class="na">num_training_examples</code> <code class="o">=</code> <code class="n">training</code><code class="p">.</code><code class="na">size</code><code class="p">();</code>
<code class="linenos"> 46 </code>    <code class="k">this</code><code class="p">.</code><code class="na">num_cross_validation_examples</code> <code class="o">=</code> <code class="n">cross_validation</code><code class="p">.</code><code class="na">size</code><code class="p">();</code>
<code class="linenos"> 47 </code>    <code class="k">this</code><code class="p">.</code><code class="na">num_testing_examples</code> <code class="o">=</code> <code class="n">testing</code><code class="p">.</code><code class="na">size</code><code class="p">();</code>
<code class="linenos"> 48 </code>
<code class="linenos"> 49 </code>    <code class="k">this</code><code class="p">.</code><code class="na">training_examples</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="k">this</code><code class="p">.</code><code class="na">num_training_examples</code><code class="o">][]</code><code class="p">;</code>
<code class="linenos"> 50 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">k</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">k</code><code class="o">&lt;</code><code class="k">this</code><code class="p">.</code><code class="na">num_training_examples</code><code class="p">;</code> <code class="n">k</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 51 </code>      <code class="k">this</code><code class="p">.</code><code class="na">training_examples</code><code class="o">[</code><code class="n">k</code><code class="o">]</code> <code class="o">=</code> <code class="n">training</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">k</code><code class="p">);</code>
<code class="linenos"> 52 </code>    <code class="p">}</code>
<code class="linenos"> 53 </code>
<code class="linenos"> 54 </code>    <code class="k">this</code><code class="p">.</code><code class="na">cross_validation_examples</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="n">num_cross_validation_examples</code><code class="o">][]</code><code class="p">;</code>
<code class="linenos"> 55 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">k</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">k</code><code class="o">&lt;</code><code class="n">num_cross_validation_examples</code><code class="p">;</code> <code class="n">k</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 56 </code>      <code class="k">this</code><code class="p">.</code><code class="na">cross_validation_examples</code><code class="o">[</code><code class="n">k</code><code class="o">]</code> <code class="o">=</code> <code class="n">cross_validation</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">k</code><code class="p">);</code>
<code class="linenos"> 57 </code>    <code class="p">}</code>
<code class="linenos"> 58 </code>
<code class="linenos"> 59 </code>    <code class="k">this</code><code class="p">.</code><code class="na">testing_examples</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="n">num_testing_examples</code><code class="o">][]</code><code class="p">;</code>
<code class="linenos"> 60 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">k</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">k</code><code class="o">&lt;</code><code class="n">num_testing_examples</code><code class="p">;</code> <code class="n">k</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 61 </code>      <code class="c1">// dimensions of [num_training_examples][num_features]:</code>
<code class="linenos"> 62 </code>      <code class="k">this</code><code class="p">.</code><code class="na">testing_examples</code><code class="o">[</code><code class="n">k</code><code class="o">]</code> <code class="o">=</code> <code class="n">testing</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">k</code><code class="p">);</code>
<code class="linenos"> 63 </code>    <code class="p">}</code>
<code class="linenos"> 64 </code>
<code class="linenos"> 65 </code>    <code class="k">this</code><code class="p">.</code><code class="na">mu</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="n">num_features</code><code class="o">]</code><code class="p">;</code>
<code class="linenos"> 66 </code>    <code class="k">this</code><code class="p">.</code><code class="na">sigma_squared</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="n">num_features</code><code class="o">]</code><code class="p">;</code>
<code class="linenos"> 67 </code>    <code class="k">this</code><code class="p">.</code><code class="na">num_features</code> <code class="o">=</code> <code class="n">num_features</code><code class="p">;</code>
<code class="linenos"> 68 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nf</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">nf</code> <code class="o">&lt;</code> <code class="k">this</code><code class="p">.</code><code class="na">num_features</code><code class="p">;</code> <code class="n">nf</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code> <code class="c1">//</code>
<code class="linenos"> 69 </code>      <code class="kt">double</code> <code class="n">sum</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos"> 70 </code>      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nt</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">nt</code> <code class="o">&lt;</code> <code class="k">this</code><code class="p">.</code><code class="na">num_training_examples</code><code class="p">;</code> <code class="n">nt</code><code class="o">++</code><code class="p">)</code>
<code class="linenos"> 71 </code>        <code class="n">sum</code> <code class="o">+=</code> <code class="n">training_examples</code><code class="o">[</code><code class="n">nt</code><code class="o">][</code><code class="n">nf</code><code class="o">]</code><code class="p">;</code>
<code class="linenos"> 72 </code>      <code class="k">this</code><code class="p">.</code><code class="na">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code> <code class="o">=</code> <code class="n">sum</code> <code class="o">/</code> <code class="k">this</code><code class="p">.</code><code class="na">num_training_examples</code><code class="p">;</code>
<code class="linenos"> 73 </code>    <code class="p">}</code>
<code class="linenos"> 74 </code>  <code class="p">}</code>
<code class="linenos"> 75 </code>
<code class="linenos"> 76 </code>  <code class="kd">public</code> <code class="kt">double</code> <code class="o">[]</code> <code class="n">muValues</code><code class="p">()</code>     <code class="p">{</code> <code class="k">return</code> <code class="n">mu</code><code class="p">;</code> <code class="p">}</code>
<code class="linenos"> 77 </code>  <code class="kd">public</code> <code class="kt">double</code> <code class="o">[]</code> <code class="n">sigmaSquared</code><code class="p">()</code> <code class="p">{</code> <code class="k">return</code> <code class="n">sigma_squared</code><code class="p">;</code> <code class="p">}</code>
<code class="linenos"> 78 </code>  <code class="kd">public</code> <code class="kt">double</code> <code class="nf">bestEpsilon</code><code class="p">()</code>     <code class="p">{</code> <code class="k">return</code> <code class="n">best_epsilon</code><code class="p">;</code> <code class="p">}</code>
<code class="linenos"> 79 </code>
<code class="linenos"> 80 </code>  <code class="cm">/**</code>
<code class="linenos"> 81 </code><code class="cm">   *</code>
<code class="linenos"> 82 </code><code class="cm">   * Train the model using a range of epsilon values. Epsilon is a</code>
<code class="linenos"> 83 </code><code class="cm">   * hyper parameter that we want to find a value that</code>
<code class="linenos"> 84 </code><code class="cm">   * minimizes the error count.</code>
<code class="linenos"> 85 </code><code class="cm">   */</code>
<code class="linenos"> 86 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">train</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 87 </code>    <code class="kt">double</code> <code class="n">best_error_count</code> <code class="o">=</code> <code class="mf">1e10</code><code class="p">;</code>
<code class="linenos"> 88 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">epsilon_loop</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">epsilon_loop</code><code class="o">&lt;</code><code class="mi">40</code><code class="p">;</code> <code class="n">epsilon_loop</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 89 </code>      <code class="kt">double</code> <code class="n">epsilon</code> <code class="o">=</code> <code class="mf">0.05</code> <code class="o">+</code> <code class="mf">0.01</code> <code class="o">*</code> <code class="n">epsilon_loop</code><code class="p">;</code>
<code class="linenos"> 90 </code>      <code class="kt">double</code> <code class="n">error_count</code> <code class="o">=</code> <code class="n">train</code><code class="p">(</code><code class="n">epsilon</code><code class="p">);</code>
<code class="linenos"> 91 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">error_count</code> <code class="o">&lt;</code> <code class="n">best_error_count</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 92 </code>        <code class="n">best_error_count</code> <code class="o">=</code> <code class="n">error_count</code><code class="p">;</code>
<code class="linenos"> 93 </code>        <code class="n">best_epsilon</code> <code class="o">=</code> <code class="n">epsilon</code><code class="p">;</code>
<code class="linenos"> 94 </code>      <code class="p">}</code>
<code class="linenos"> 95 </code>    <code class="p">}</code>
<code class="linenos"> 96 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n**** Best epsilon value = "</code> <code class="o">+</code> <code class="n">best_epsilon</code> <code class="p">);</code>
<code class="linenos"> 97 </code>
<code class="linenos"> 98 </code>    <code class="c1">// retrain for the best epsilon setting the maximum likelyhood parameters</code>
<code class="linenos"> 99 </code>    <code class="c1">// which are now in epsilon, mu[] and sigma_squared[]:</code>
<code class="linenos">100 </code>    <code class="n">train_helper</code><code class="p">(</code><code class="n">best_epsilon</code><code class="p">);</code>
<code class="linenos">101 </code>
<code class="linenos">102 </code>    <code class="c1">// finally, we are ready to see how the model performs with test data:</code>
<code class="linenos">103 </code>    <code class="n">test</code><code class="p">(</code><code class="n">best_epsilon</code><code class="p">);</code>
<code class="linenos">104 </code>  <code class="p">}</code>
<code class="linenos">105 </code>
<code class="linenos">106 </code>  <code class="cm">/**</code>
<code class="linenos">107 </code><code class="cm">   * calculate probability p(x; mu, sigma_squared)</code>
<code class="linenos">108 </code><code class="cm">   *</code>
<code class="linenos">109 </code><code class="cm">   * @param x - example vector</code>
<code class="linenos">110 </code><code class="cm">   * @return</code>
<code class="linenos">111 </code><code class="cm">   */</code>
<code class="linenos">112 </code>  <code class="kd">private</code> <code class="kt">double</code> <code class="nf">p</code><code class="p">(</code><code class="kt">double</code> <code class="o">[]</code> <code class="n">x</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">113 </code>    <code class="kt">double</code> <code class="n">sum</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">114 </code>    <code class="c1">// use (num_features - 1) to skip target output:</code>
<code class="linenos">115 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nf</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">nf</code><code class="o">&lt;</code><code class="n">num_features</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code> <code class="n">nf</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">116 </code>      <code class="n">sum</code> <code class="o">+=</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">/</code> <code class="p">(</code><code class="n">SQRT_2_PI</code> <code class="o">*</code> <code class="n">sigma_squared</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">))</code> <code class="o">*</code>
<code class="linenos">117 </code>             <code class="n">Math</code><code class="p">.</code><code class="na">exp</code><code class="p">(</code><code class="o">-</code> <code class="p">(</code><code class="n">x</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code> <code class="o">-</code> <code class="n">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="n">x</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code> <code class="o">-</code> <code class="n">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">));</code>
<code class="linenos">118 </code>    <code class="p">}</code>
<code class="linenos">119 </code>    <code class="k">return</code> <code class="n">sum</code> <code class="o">/</code> <code class="n">num_features</code><code class="p">;</code>
<code class="linenos">120 </code>  <code class="p">}</code>
<code class="linenos">121 </code>
<code class="linenos">122 </code>  <code class="cm">/**</code>
<code class="linenos">123 </code><code class="cm">   * returns 1 if input vector is an anoomaly</code>
<code class="linenos">124 </code><code class="cm">   *</code>
<code class="linenos">125 </code><code class="cm">   * @param x - example vector</code>
<code class="linenos">126 </code><code class="cm">   * @return</code>
<code class="linenos">127 </code><code class="cm">   */</code>
<code class="linenos">128 </code>  <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">isAnamoly</code><code class="p">(</code><code class="kt">double</code> <code class="o">[]</code> <code class="n">x</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">129 </code>    <code class="kt">double</code> <code class="n">sum</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">130 </code>    <code class="c1">// use (num_features - 1) to skip target output:</code>
<code class="linenos">131 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nf</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">nf</code><code class="o">&lt;</code><code class="n">num_features</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code> <code class="n">nf</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">132 </code>      <code class="n">sum</code> <code class="o">+=</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">/</code> <code class="p">(</code><code class="n">SQRT_2_PI</code> <code class="o">*</code> <code class="n">sigma_squared</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">))</code> <code class="o">*</code>
<code class="linenos">133 </code>             <code class="n">Math</code><code class="p">.</code><code class="na">exp</code><code class="p">(</code><code class="o">-</code> <code class="p">(</code><code class="n">x</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code> <code class="o">-</code> <code class="n">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">)</code> <code class="o">*</code> <code class="p">(</code><code class="n">x</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code> <code class="o">-</code> <code class="n">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">));</code>
<code class="linenos">134 </code>    <code class="p">}</code>
<code class="linenos">135 </code>    <code class="k">return</code> <code class="p">(</code><code class="n">sum</code> <code class="o">/</code> <code class="n">num_features</code><code class="p">)</code> <code class="o">&lt;</code> <code class="n">best_epsilon</code><code class="p">;</code>
<code class="linenos">136 </code>  <code class="p">}</code>
<code class="linenos">137 </code>
<code class="linenos">138 </code>  <code class="kd">private</code> <code class="kt">double</code> <code class="nf">train_helper_</code><code class="p">(</code><code class="kt">double</code> <code class="n">epsilon</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">139 </code>    <code class="c1">// use (num_features - 1) to skip target output:</code>
<code class="linenos">140 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nf</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">nf</code> <code class="o">&lt;</code> <code class="k">this</code><code class="p">.</code><code class="na">num_features</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code> <code class="n">nf</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">141 </code>      <code class="kt">double</code> <code class="n">sum</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">142 </code>      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nt</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">nt</code><code class="o">&lt;</code><code class="k">this</code><code class="p">.</code><code class="na">num_training_examples</code><code class="p">;</code> <code class="n">nt</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">143 </code>        <code class="n">sum</code> <code class="o">+=</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="na">training_examples</code><code class="o">[</code><code class="n">nt</code><code class="o">][</code><code class="n">nf</code><code class="o">]</code> <code class="o">-</code> <code class="n">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">)</code> <code class="o">*</code>
<code class="linenos">144 </code>               <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="na">training_examples</code><code class="o">[</code><code class="n">nt</code><code class="o">][</code><code class="n">nf</code><code class="o">]</code> <code class="o">-</code> <code class="n">mu</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code><code class="p">);</code>
<code class="linenos">145 </code>      <code class="p">}</code>
<code class="linenos">146 </code>      <code class="n">sigma_squared</code><code class="o">[</code><code class="n">nf</code><code class="o">]</code> <code class="o">=</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">/</code> <code class="n">num_features</code><code class="p">)</code> <code class="o">*</code> <code class="n">sum</code><code class="p">;</code>
<code class="linenos">147 </code>    <code class="p">}</code>
<code class="linenos">148 </code>    <code class="kt">double</code> <code class="n">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">149 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nt</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">nt</code><code class="o">&lt;</code><code class="k">this</code><code class="p">.</code><code class="na">num_cross_validation_examples</code><code class="p">;</code> <code class="n">nt</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">150 </code>      <code class="kt">double</code><code class="o">[]</code> <code class="n">x</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="na">cross_validation_examples</code><code class="o">[</code><code class="n">nt</code><code class="o">]</code><code class="p">;</code>
<code class="linenos">151 </code>      <code class="kt">double</code> <code class="n">calculated_value</code> <code class="o">=</code> <code class="n">p</code><code class="p">(</code><code class="n">x</code><code class="p">);</code>
<code class="linenos">152 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">x</code><code class="o">[</code><code class="mi">9</code><code class="o">]</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// target training output is ANOMALY</code>
<code class="linenos">153 </code>        <code class="c1">// if the calculated value is greater than epsilon</code>
<code class="linenos">154 </code>        <code class="c1">// then this x vector is not an anomaly (e.g., it</code>
<code class="linenos">155 </code>        <code class="c1">// is a normal sample):</code>
<code class="linenos">156 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">calculated_value</code> <code class="o">&gt;</code> <code class="n">epsilon</code><code class="p">)</code> <code class="n">cross_validation_error_count</code> <code class="o">+=</code> <code class="mi">1</code><code class="p">;</code>
<code class="linenos">157 </code>      <code class="p">}</code> <code class="k">else</code> <code class="p">{</code> <code class="c1">// target training output is NORMAL</code>
<code class="linenos">158 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">calculated_value</code> <code class="o">&lt;</code> <code class="n">epsilon</code><code class="p">)</code> <code class="n">cross_validation_error_count</code> <code class="o">+=</code> <code class="mi">1</code><code class="p">;</code>
<code class="linenos">159 </code>      <code class="p">}</code>
<code class="linenos">160 </code>    <code class="p">}</code>
<code class="linenos">161 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"   cross_validation_error_count = "</code> <code class="o">+</code>
<code class="linenos">162 </code>                       <code class="n">cross_validation_error_count</code> <code class="o">+</code>
<code class="linenos">163 </code>                       <code class="s">" for epsilon = "</code> <code class="o">+</code> <code class="n">epsilon</code><code class="p">);</code>
<code class="linenos">164 </code>    <code class="k">return</code> <code class="n">cross_validation_error_count</code><code class="p">;</code>
<code class="linenos">165 </code>  <code class="p">}</code>
<code class="linenos">166 </code>
<code class="linenos">167 </code>  <code class="kd">private</code> <code class="kt">double</code> <code class="nf">test</code><code class="p">(</code><code class="kt">double</code> <code class="n">epsilon</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">168 </code>    <code class="kt">double</code> <code class="n">num_false_positives</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">num_false_negatives</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">169 </code>    <code class="kt">double</code> <code class="n">num_true_positives</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">num_true_negatives</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">170 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">nt</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">nt</code><code class="o">&lt;</code><code class="k">this</code><code class="p">.</code><code class="na">num_testing_examples</code><code class="p">;</code> <code class="n">nt</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">171 </code>      <code class="kt">double</code><code class="o">[]</code> <code class="n">x</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="na">testing_examples</code><code class="o">[</code><code class="n">nt</code><code class="o">]</code><code class="p">;</code>
<code class="linenos">172 </code>      <code class="kt">double</code> <code class="n">calculated_value</code> <code class="o">=</code> <code class="n">p</code><code class="p">(</code><code class="n">x</code><code class="p">);</code>
<code class="linenos">173 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">x</code><code class="o">[</code><code class="mi">9</code><code class="o">]</code> <code class="o">&gt;</code> <code class="mf">0.5</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// target training output is ANOMALY</code>
<code class="linenos">174 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">calculated_value</code> <code class="o">&gt;</code> <code class="n">epsilon</code><code class="p">)</code> <code class="n">num_false_negatives</code><code class="o">++</code><code class="p">;</code>
<code class="linenos">175 </code>        <code class="k">else</code>                            <code class="n">num_true_positives</code><code class="o">++</code><code class="p">;</code>
<code class="linenos">176 </code>      <code class="p">}</code> <code class="k">else</code> <code class="p">{</code> <code class="c1">// target training output is NORMAL</code>
<code class="linenos">177 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">calculated_value</code> <code class="o">&lt;</code> <code class="n">epsilon</code><code class="p">)</code> <code class="n">num_false_positives</code><code class="o">++</code><code class="p">;</code>
<code class="linenos">178 </code>        <code class="k">else</code>                            <code class="n">num_true_negatives</code><code class="o">++</code><code class="p">;</code>
<code class="linenos">179 </code>      <code class="p">}</code>
<code class="linenos">180 </code>    <code class="p">}</code>
<code class="linenos">181 </code>    <code class="kt">double</code> <code class="n">precision</code> <code class="o">=</code> <code class="n">num_true_positives</code> <code class="o">/</code>
<code class="linenos">182 </code>                       <code class="p">(</code><code class="n">num_true_positives</code> <code class="o">+</code> <code class="n">num_false_positives</code><code class="p">);</code>
<code class="linenos">183 </code>    <code class="kt">double</code> <code class="n">recall</code> <code class="o">=</code> <code class="n">num_true_positives</code> <code class="o">/</code>
<code class="linenos">184 </code>                    <code class="p">(</code><code class="n">num_true_positives</code> <code class="o">+</code> <code class="n">num_false_negatives</code><code class="p">);</code>
<code class="linenos">185 </code>    <code class="kt">double</code> <code class="n">F1</code> <code class="o">=</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">precision</code> <code class="o">*</code> <code class="n">recall</code> <code class="o">/</code> <code class="p">(</code><code class="n">precision</code> <code class="o">+</code> <code class="n">recall</code><code class="p">);</code>
<code class="linenos">186 </code>
<code class="linenos">187 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n\n -- best epsilon = "</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="na">best_epsilon</code><code class="p">);</code>
<code class="linenos">188 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- number of test examples = "</code> <code class="o">+</code>
<code class="linenos">189 </code>                       <code class="k">this</code><code class="p">.</code><code class="na">num_testing_examples</code><code class="p">);</code>
<code class="linenos">190 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- number of false positives = "</code> <code class="o">+</code> <code class="n">num_false_positives</code><code class="p">);</code>
<code class="linenos">191 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- number of true positives = "</code> <code class="o">+</code> <code class="n">num_true_positives</code><code class="p">);</code>
<code class="linenos">192 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- number of false negatives = "</code> <code class="o">+</code> <code class="n">num_false_negatives</code><code class="p">);</code>
<code class="linenos">193 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- number of true negatives = "</code> <code class="o">+</code> <code class="n">num_true_negatives</code><code class="p">);</code>
<code class="linenos">194 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- precision = "</code> <code class="o">+</code> <code class="n">precision</code><code class="p">);</code>
<code class="linenos">195 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- recall = "</code> <code class="o">+</code> <code class="n">recall</code><code class="p">);</code>
<code class="linenos">196 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" -- F1 = "</code> <code class="o">+</code> <code class="n">F1</code><code class="p">);</code>
<code class="linenos">197 </code>    <code class="k">return</code> <code class="n">F1</code><code class="p">;</code>
<code class="linenos">198 </code>  <code class="p">}</code>
<code class="linenos">199 </code>
<code class="linenos">200 </code>  <code class="kt">double</code> <code class="n">best_epsilon</code> <code class="o">=</code> <code class="mf">0.02</code><code class="p">;</code>
<code class="linenos">201 </code>  <code class="kd">private</code> <code class="kt">double</code> <code class="o">[]</code> <code class="n">mu</code><code class="p">;</code>  <code class="c1">// [num_features]</code>
<code class="linenos">202 </code>  <code class="kd">private</code> <code class="kt">double</code> <code class="o">[]</code> <code class="n">sigma_squared</code><code class="p">;</code> <code class="c1">// [num_features]</code>
<code class="linenos">203 </code>  <code class="kd">private</code> <code class="kt">int</code> <code class="n">num_features</code><code class="p">;</code>
<code class="linenos">204 </code>  <code class="kd">private</code> <code class="kd">static</code> <code class="kt">double</code> <code class="n">SQRT_2_PI</code> <code class="o">=</code> <code class="mf">2.50662827463</code><code class="p">;</code>
<code class="linenos">205 </code>
<code class="linenos">206 </code>
<code class="linenos">207 </code>  <code class="kd">private</code> <code class="kt">double</code><code class="o">[][]</code> <code class="n">training_examples</code><code class="p">;</code> <code class="c1">// [num_features][num_training_examples]</code>
<code class="linenos">208 </code>  <code class="c1">// [num_features][num_training_examples]:</code>
<code class="linenos">209 </code>  <code class="kd">private</code> <code class="kt">double</code><code class="o">[][]</code> <code class="n">cross_validation_examples</code><code class="p">;</code> 
<code class="linenos">210 </code>  <code class="kd">private</code> <code class="kt">double</code><code class="o">[][]</code> <code class="n">testing_examples</code><code class="p">;</code> <code class="c1">// [num_features][num_training_examples]</code>
<code class="linenos">211 </code>  <code class="kd">private</code> <code class="kt">int</code> <code class="n">num_training_examples</code><code class="p">;</code>
<code class="linenos">212 </code>  <code class="kd">private</code> <code class="kt">int</code> <code class="n">num_cross_validation_examples</code><code class="p">;</code>
<code class="linenos">213 </code>  <code class="kd">private</code> <code class="kt">int</code> <code class="n">num_testing_examples</code><code class="p">;</code>
<code class="linenos">214 </code>
<code class="linenos">215 </code><code class="p">}</code>
</pre></div>

</figure>

<p>Once the training data and the values of \(\mu\) (the varible <strong>mu</strong> in the code) are defined for each feature we can define the method <strong>train</strong> in lines 86 through 104 that calculated the best <strong>epsilon</strong> “cutoff” value for the training data set using the method <strong>train_helper</strong> defined in lines 138 through 165. We use the “best” <strong>epsilon</strong> value by testing with the separate cross validation data set; we do this by calling the method <strong>test</strong> that is defined in lines 167 through 198.</p>

<h3 id="leanpub-auto-example-using-the-university-of-wisconsin-cancer-data">Example Using the University of Wisconsin Cancer Data</h3>

<p>The example in this section loads the University of Wisconsin data and uses the class <strong>AnomalyDetection</strong> developed in the last section to find anomalies, which for this example will be input vectors that represented malignancy in the original data.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.anomaly_detection</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">java.io.*</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">org.apache.commons.io.FileUtils</code><code class="p">;</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="cm">/**</code>
<code class="linenos"> 7 </code><code class="cm"> * Train a deep belief network on the University of Wisconsin Cancer Data Set.</code>
<code class="linenos"> 8 </code><code class="cm"> */</code>
<code class="linenos"> 9 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">WisconsinAnomalyDetection</code> <code class="p">{</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>  <code class="kd">private</code> <code class="kd">static</code> <code class="kt">boolean</code> <code class="n">PRINT_HISTOGRAMS</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code>    <code class="n">String</code> <code class="o">[]</code> <code class="n">lines</code> <code class="o">=</code>
<code class="linenos">16 </code>      <code class="n">FileUtils</code><code class="p">.</code><code class="na">readFileToString</code><code class="p">(</code>
<code class="linenos">17 </code>         <code class="k">new</code> <code class="n">File</code><code class="p">(</code><code class="s">"data/cleaned_wisconsin_cancer_data.csv"</code><code class="p">)).</code><code class="na">split</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
<code class="linenos">18 </code>    <code class="kt">double</code> <code class="o">[][]</code> <code class="n">training_data</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="n">lines</code><code class="p">.</code><code class="na">length</code><code class="o">][]</code><code class="p">;</code>
<code class="linenos">19 </code>    <code class="kt">int</code> <code class="n">line_count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">20 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="n">line</code> <code class="p">:</code> <code class="n">lines</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">21 </code>      <code class="n">String</code> <code class="o">[]</code> <code class="n">sarr</code> <code class="o">=</code> <code class="n">line</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">","</code><code class="p">);</code>
<code class="linenos">22 </code>      <code class="kt">double</code> <code class="o">[]</code> <code class="n">xs</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[</code><code class="mi">10</code><code class="o">]</code><code class="p">;</code>
<code class="linenos">23 </code>      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">10</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">Double</code><code class="p">.</code><code class="na">parseDouble</code><code class="p">(</code><code class="n">sarr</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos">24 </code>      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">*=</code> <code class="mf">0.1</code><code class="p">;</code>
<code class="linenos">25 </code>      <code class="n">xs</code><code class="o">[</code><code class="mi">9</code><code class="o">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">xs</code><code class="o">[</code><code class="mi">9</code><code class="o">]</code> <code class="o">-</code> <code class="mi">2</code><code class="p">)</code> <code class="o">*</code> <code class="mf">0.5</code><code class="p">;</code> <code class="c1">// make target output be [0,1] instead of [2,4]</code>
<code class="linenos">26 </code>      <code class="n">training_data</code><code class="o">[</code><code class="n">line_count</code><code class="o">++]</code> <code class="o">=</code> <code class="n">xs</code><code class="p">;</code>
<code class="linenos">27 </code>    <code class="p">}</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">PRINT_HISTOGRAMS</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">30 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Clump Thickness"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">31 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Uniformity of Cell Size"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code>
<code class="linenos">32 </code>                              <code class="mi">1</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">33 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Uniformity of Cell Shape"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code>
<code class="linenos">34 </code>                              <code class="mi">2</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">35 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Marginal Adhesion"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code>
<code class="linenos">36 </code>                              <code class="mi">3</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">37 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Single Epithelial Cell Size"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code>
<code class="linenos">38 </code>                              <code class="mi">4</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">39 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Bare Nuclei"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">40 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Bland Chromatin"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">41 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Normal Nucleoli"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">42 </code>      <code class="n">PrintHistogram</code><code class="p">.</code><code class="na">historam</code><code class="p">(</code><code class="s">"Mitoses"</code><code class="p">,</code> <code class="n">training_data</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">,</code> <code class="mf">1.0</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="linenos">43 </code>    <code class="p">}</code>
<code class="linenos">44 </code>    
<code class="linenos">45 </code>    <code class="n">AnomalyDetection</code> <code class="n">detector</code> <code class="o">=</code> <code class="k">new</code> <code class="n">AnomalyDetection</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="n">line_count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">,</code>
<code class="linenos">46 </code>                                                     <code class="n">training_data</code><code class="p">);</code>
<code class="linenos">47 </code>
<code class="linenos">48 </code>    <code class="c1">// the train method will print training results like</code>
<code class="linenos">49 </code>    <code class="c1">// precision, recall, and F1:</code>
<code class="linenos">50 </code>    <code class="n">detector</code><code class="p">.</code><code class="na">train</code><code class="p">();</code>
<code class="linenos">51 </code>
<code class="linenos">52 </code>    <code class="c1">// get best model parameters:</code>
<code class="linenos">53 </code>    <code class="kt">double</code> <code class="n">best_epsilon</code> <code class="o">=</code> <code class="n">detector</code><code class="p">.</code><code class="na">bestEpsilon</code><code class="p">();</code>
<code class="linenos">54 </code>    <code class="kt">double</code> <code class="o">[]</code> <code class="n">mean_values</code> <code class="o">=</code> <code class="n">detector</code><code class="p">.</code><code class="na">muValues</code><code class="p">();</code>
<code class="linenos">55 </code>    <code class="kt">double</code> <code class="o">[]</code> <code class="n">sigma_squared</code> <code class="o">=</code> <code class="n">detector</code><code class="p">.</code><code class="na">sigmaSquared</code><code class="p">();</code>
<code class="linenos">56 </code>
<code class="linenos">57 </code>    <code class="c1">// to use this model, us the method AnomalyDetection.isAnamoly(double []):</code>
<code class="linenos">58 </code>
<code class="linenos">59 </code>    <code class="kt">double</code> <code class="o">[]</code> <code class="n">test_malignant</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[]</code> <code class="p">{</code><code class="mf">0.5</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mf">0.8</code><code class="p">,</code><code class="mf">0.5</code><code class="p">,</code><code class="mf">0.5</code><code class="p">,</code><code class="mf">0.7</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="mf">0.1</code><code class="p">};</code>
<code class="linenos">60 </code>    <code class="kt">double</code> <code class="o">[]</code> <code class="n">test_benign</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">double</code><code class="o">[]</code> <code class="p">{</code><code class="mf">0.5</code><code class="p">,</code><code class="mf">0.4</code><code class="p">,</code><code class="mf">0.5</code><code class="p">,</code><code class="mf">0.1</code><code class="p">,</code><code class="mf">0.8</code><code class="p">,</code><code class="mf">0.1</code><code class="p">,</code><code class="mf">0.3</code><code class="p">,</code><code class="mf">0.6</code><code class="p">,</code><code class="mf">0.1</code><code class="p">};</code>
<code class="linenos">61 </code>    <code class="kt">boolean</code> <code class="n">malignant_result</code> <code class="o">=</code> <code class="n">detector</code><code class="p">.</code><code class="na">isAnamoly</code><code class="p">(</code><code class="n">test_malignant</code><code class="p">);</code>
<code class="linenos">62 </code>    <code class="kt">boolean</code> <code class="n">benign_result</code> <code class="o">=</code> <code class="n">detector</code><code class="p">.</code><code class="na">isAnamoly</code><code class="p">(</code><code class="n">test_benign</code><code class="p">);</code>
<code class="linenos">63 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n\nUsing the trained model:"</code><code class="p">);</code>
<code class="linenos">64 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"malignant result = "</code> <code class="o">+</code> <code class="n">malignant_result</code> <code class="o">+</code>
<code class="linenos">65 </code>                       <code class="s">", benign result = "</code> <code class="o">+</code> <code class="n">benign_result</code><code class="p">);</code>
<code class="linenos">66 </code>  <code class="p">}</code>
<code class="linenos">67 </code><code class="p">}</code>
</pre></div>

</figure>

<p>Data used by an anomaly detecton model should have (roughly) a Gaussian (bell curve shape) distribution. What form does the cancer data have? Unfortunately, each of the data features seems to either have a greater density at the lower range of feature values or large density at the extremes of the data feature ranges. This will cause our model to not perform as well as we would like. Here are the inputs displayed as five-bin histograms:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Clump Thickness
0	177
1	174
2	154
3	63
4	80

Uniformity of Cell Size
0	393
1	86
2	54
3	43
4	72

Uniformity of Cell Shape
0	380
1	92
2	58
3	54
4	64

Marginal Adhesion
0	427
1	85
2	42
3	37
4	57

Single Epithelial Cell Size
0	394
1	117
2	76
3	28
4	33

Bare Nuclei
0	409
1	44
2	33
3	27
4	135

Bland Chromatin
0	298
1	182
2	41
3	97
4	30

Normal Nucleoli
0	442
1	56
2	39
3	37
4	74

Mitoses
0	567
1	42
2	8
3	17
4	14
</pre></div>

</figure>

<p>I won’t do it in this example, but the feature “Bare Nuclei” should be removed because it is not even close to being a bell-shaped distribution. Another thing that you can do (recommended by Andrew Ng in his Coursera Machine Learning class) is to take the log of data and otherwise transform it to something that looks more like a Gaussian distribution. In the class WisconsinAnomalyDetection, you could for example, transform the data using something like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="c1">// make the data look more like a Gaussian (bell curve shaped) distribution:</code>
<code class="linenos">2 </code>  <code class="kt">double</code> <code class="n">min</code> <code class="o">=</code> <code class="mf">1.e6</code><code class="p">,</code> <code class="n">max</code> <code class="o">=</code> <code class="o">-</code><code class="mf">1.e6</code><code class="p">;</code>
<code class="linenos">3 </code>  <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">4 </code>    <code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">Math</code><code class="p">.</code><code class="na">log</code><code class="p">(</code><code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">+</code> <code class="mf">1.2</code><code class="p">);</code>
<code class="linenos">5 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">&lt;</code> <code class="n">min</code><code class="p">)</code> <code class="n">min</code> <code class="o">=</code> <code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
<code class="linenos">6 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">&gt;</code> <code class="n">max</code><code class="p">)</code> <code class="n">max</code> <code class="o">=</code> <code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
<code class="linenos">7 </code>  <code class="p">}</code>
<code class="linenos">8 </code>  <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="mi">9</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">xs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">-</code> <code class="n">min</code><code class="p">)</code> <code class="o">/</code> <code class="p">(</code><code class="n">max</code> <code class="o">-</code> <code class="n">min</code><code class="p">);</code>
</pre></div>

</figure>

<p>The constant 1.2 in line 4 is a tuning parameter that I got by trial and error by iterating on adjusting the factor and looking at the data histograms.</p>

<p>In a real application you would drop features that you can not transform to something like a Gaussian distribution.</p>

<p>Here are the results of running the code as it is in the github repository for this book:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code> -- best epsilon = 0.28
 -- number of test examples = 63
 -- number of false positives = 0.0
 -- number of true positives = 11.0
 -- number of false negatives = 8.0
 -- number of true negatives = 44.0
 -- precision = 1.0
 -- recall = 0.5789473684210527
 -- F1 = 0.7333333333333334


Using the trained model:
malignant result = true, benign result = false
</pre></div>

</figure>

<p>How do we evaluate these results? The precision value of 1.0 means that there were no false positives. False positives are predictions of a true result when it should have been false. The value 0.578 for recall means that of all the samples that should have been classified as positive, we only predicted about 57.8% of them. The F1 score is calculated as two times the product of precision and recall, divided by the sum of precision plus recall.</p>


<h2 id="ga">Genetic Algorithms</h2>

<p>When searching a large space with many dimensions, greedy search algorithms find locally good results that are often much worse than the best possible solutions. Genetic Algorithms (GAs) are an efficient means of finding near optimum solutions by more uniformly exploring a large many-dimensional search space.  Genetic algorithms are a type of heuristic search where the heuristic takes the form of combining a fitness function with efficient search techniques inspired by biology.</p>

<p>Genetic algorithms can be said to be inspired by biology because they deal with mutation, crossover, and selection. Each possible solution to a problem is encoded in a chromosome that represents a point in a many-dimensional search space.</p>

<p>GA computer simulations evolve a population of chromosomes that may contain at least some fit individuals. Fitness is specified by a fitness function that is used to rate each individual in the population (of chromosomes) and makes it possible to use selection to choose the best candidate chromosomes to mutate and/or do crossover operations, or save as-is for the next generation. We make copies of the selected chromosomes and slightly perturb the copies with random mutations. Furthermore, pairs of selected chromosomes are cut in the same random gene index and cut pieces of the pair of chromosomes are swapped (a process called crossover).</p>

<p>Setting up a GA simulation is fairly easy: we need to represent (or encode) the state of a system in a chromosome that is usually implemented as a set of bits. GA is basically a search operation: searching for a good solution to a problem where the solution is a very fit chromosome. The programming technique of using GA is useful for AI systems that must adapt to changing conditions because “re-programming” can be as simple as defining a new fitness function and re-running the simulation. An advantage of GA is that the search process will not often “get stuck” in local minimum because the genetic crossover process produces radically different chromosomes in new generations while occasional mutations (flipping a random bit in a chromosome) cause small changes.</p>

<p>As you can imagine, performing a crossover operation moves to a very distant point in the search space. Alternatively mutating a single bit only moves a point (i.e., a chromosome) in one dimension in the search space.</p>

<p>Another aspect of GA is supporting the evolutionary concept of “survival of the fittest”: by using the fitness function we will preferentially “breed” chromosomes with higher fitness values.</p>

<p>It is interesting to compare how GAs are trained with how we train neural networks (see the next chapter on <a href="#neural-networks">Neural Networks</a>). We need to manually “supervise” the training process: for GAs we need to supply a fitness function. For of the neural network models used in the chapter <a href="#neural-networks">Neural Networks</a> we supply training data with desired sample outputs for sample inputs.</p>

<h3 id="leanpub-auto-theory">Theory</h3>

<p>GAs are typically used to search very large and usually very high dimensional search spaces. If we want to find a solution as a single point in an <strong>N</strong> dimensional space where a fitness function has a near maximum value, then we have <strong>N</strong> parameters to encode in each chromosome. In this chapter we will be solving a simple problem in which we only need to encode a single number (a floating point number for this example) in each chromosome. We are effectively downsampling a floating point number to an integer and the bit representation of the integer is a chromosome. Using a GA toolkit like the one developed in a later section, requires two problem-specific customizations:</p>

<ul>
  <li>Characterize the search space by a set of parameters that can be encoded in a chromosome (more on this later). GAs work with the coding of a parameter set, not the parameters themselves (<em>Genetic
Algorithms in Search, Optimization, and Machine Learning</em>, David Goldberg, 1989).</li>
  <li>Provide a numeric fitness function that allows us to rate the fitness of each chromosome in a population. We will use these fitness values in the selection process to determine which chromosomes in the population are most likely to survive and reproduce using genetic crossover and mutation operations.</li>
</ul>

<p>The GA toolkit developed in this chapter treats genes as a single bit; while you can consider a gene to be an arbitrary data structure, the approach of using single bit genes and specifying the number of genes (or bits) in a chromosome is very flexible. A population is a set of chromosomes. A generation is defined as one reproductive cycle of replacing some elements of the chromosome population with new chromosomes produced by using a genetic crossover operation followed by optionally mutating a few chromosomes in the population.</p>

<p>We will describe a simple example problem (that can be better solved using Newton’s method) in this section, write a general purpose library in the section <a href="#java-ga-lib">Java Library for Genetic Algorithms</a>, and finish the chapter in the section <a href="#java-ga-example">Java Genetic Algorithm Example</a> by solving this problem.</p>


<div class="figure-wrapper center">
  <figure id="ga-sample-function" class="image" style="width: 171px">
    <img src="images/ga_sample_function.png" alt="Example Function" style="width: 100%">
    <figcaption>Example Function</figcaption>
  </figure>
</div>


<p>For a sample problem, let’s suppose that we want to find the maximum value of the function <strong>F</strong> with one independent variable <strong>x</strong> in the following equation and as seen in last figure:</p>

<p><strong>F(x) = sin(x) * sin(0.4 * x) * sin(3 * x)</strong></p>

<p>The problem that we want to solve is finding a good value of <strong>x</strong> to find a near to possible maximum value of <strong>F(x)</strong>. To be clear: we encode a floating point number as a chromosome made up of a specific number of bits so any chromosome with randomly set bits will represent some random number in the interval [0, 10]. The fitness function is simply the function in the last equation.</p>


<div class="figure-wrapper center">
  <figure id="ga-crossover" class="image" style="width: 271px">
    <img src="images/ga_crossover.png" alt="Crosssover Operation" style="width: 100%">
    <figcaption>Crosssover Operation</figcaption>
  </figure>
</div>


<p>This figure shows an example of a crossover operation that we will implement later in the program example. A random chromosome bit index is chosen, and two chromosomes are “cut” at this index and swap cut parts. The two original chromosomes in <strong>generation_n</strong> are shown on the left of the figure and after the crossover operation they produce two new chromosomes in <strong>generation n + 1</strong> where <strong>n</strong> is the current generation number. The two new chromosomes are shown on the right of the figure.</p>

<p>In addition to using crossover operations to create new chromosomes from existing chromosomes, we will also perform genetic mutation by randomly flipping bits in chromosomes. A fitness function that rates the fitness value of each chromosome allows us to decide which chromosomes to discard and which to use for the next generation. We will use the most fit chromosomes in the population for producing the next generation using crossover and mutation.</p>

<p>We will implement a general purpose Java GA library in the next section and then solve the example problem posed at the end of this chapter in the <a href="#java-ga-example">GA Example Section</a>.</p>

<h3 id="java-ga-lib">Java Library for Genetic Algorithms</h3>

<p>The full implementation of the GA library is in the Java source file <strong>Genetic.java</strong>. The following code snippets show the method signatures defining the public API for the library. Note that there are two constructors, the first using default values for the fraction of chromosomes on which to perform crossover and mutation operations and the second constructor allows setting explicit values for these parameters:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">abstract</code> <code class="kd">public</code> <code class="kd">class</code> <code class="nc">Genetic</code> <code class="p">{</code>
      <code class="kd">public</code> <code class="nf">Genetic</code><code class="p">(</code><code class="kt">int</code> <code class="n">num_genes_per_chromosome</code><code class="p">,</code>
                     <code class="kt">int</code> <code class="n">num_chromosomes</code><code class="p">)</code>
      <code class="kd">public</code> <code class="nf">Genetic</code><code class="p">(</code><code class="kt">int</code> <code class="n">num_genes_per_chromosome</code><code class="p">,</code>
                     <code class="kt">int</code> <code class="n">num_chromosomes</code><code class="p">,</code>
                     <code class="kt">float</code> <code class="n">crossover_fraction</code><code class="p">,</code>
                     <code class="kt">float</code> <code class="n">mutation_fraction</code><code class="p">)</code>
</pre></div>

</figure>

<p>The method <strong>sort</strong> is used to sort the population of chromosomes in most fit first order. The methods <strong>getGene</strong> and <strong>setGene</strong> are used to fetch and change the value of any gene (bit) in any chromosome. These methods are protected because you may need to override them in derived classes.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">sort</code><code class="p">()</code>
      <code class="kd">protected</code> <code class="kt">boolean</code> <code class="nf">getGene</code><code class="p">(</code><code class="kt">int</code> <code class="n">chromosome</code><code class="p">,</code>
                                <code class="kt">int</code> <code class="n">gene</code><code class="p">)</code>
      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">setGene</code><code class="p">(</code><code class="kt">int</code> <code class="n">chromosome</code><code class="p">,</code>
                             <code class="kt">int</code> <code class="n">gene</code><code class="p">,</code> <code class="kt">int</code> <code class="n">value</code><code class="p">)</code>
      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">setGene</code><code class="p">(</code><code class="kt">int</code> <code class="n">chromosome</code><code class="p">,</code> 
                             <code class="kt">int</code> <code class="n">gene</code><code class="p">,</code>
                             <code class="kt">boolean</code> <code class="n">value</code><code class="p">)</code>
</pre></div>

</figure>

<p>The methods <strong>evolve</strong>, <strong>doCrossovers</strong>, <strong>doMutations</strong>, and <strong>doRemoveDuplicates</strong> are utilities for running GA simulations. These methods are protected but you will probably not need to override them in derived classes.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">evolve</code><code class="p">()</code>
      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">doCrossovers</code><code class="p">()</code>
      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">doMutations</code><code class="p">()</code>
      <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">doRemoveDuplicates</code><code class="p">()</code>
</pre></div>

</figure>

<p>When you subclass class <strong>Genetic</strong> you must implement the following abstract method <strong>calcFitness</strong> that will determine the evolution of chromosomes during the GA simulation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="c1">// Implement the following method in sub-classes:</code>
      <code class="kd">abstract</code> <code class="kd">public</code> <code class="kt">void</code> <code class="nf">calcFitness</code><code class="p">();</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>Chromosome</strong> represents an ordered bit sequence with a specified number of bits and a floating point fitness value.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">class</code> <code class="nc">Chromosome</code> <code class="p">{</code>
      <code class="kd">private</code> <code class="nf">Chromosome</code><code class="p">()</code>
      <code class="kd">public</code> <code class="nf">Chromosome</code><code class="p">(</code><code class="kt">int</code> <code class="n">num_genes</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">getBit</code><code class="p">(</code><code class="kt">int</code> <code class="n">index</code><code class="p">)</code> 
      <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setBit</code><code class="p">(</code><code class="kt">int</code> <code class="n">index</code><code class="p">,</code> <code class="kt">boolean</code> <code class="n">value</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kt">float</code> <code class="nf">getFitness</code><code class="p">()</code>
      <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setFitness</code><code class="p">(</code><code class="kt">float</code> <code class="n">value</code><code class="p">)</code>
      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">equals</code><code class="p">(</code><code class="n">Chromosome</code> <code class="n">c</code><code class="p">)</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>ChromosomeComparator</strong> implements a <strong>Comparator</strong> interface and is application specific. It is used to sort a population in “best first” order:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">class</code> <code class="nc">ChromosomeComparator</code>
          <code class="kd">implements</code> <code class="n">Comparator</code><code class="o">&lt;</code><code class="n">Chromosome</code><code class="o">&gt;</code> <code class="p">{</code>
      <code class="kd">public</code> <code class="kt">int</code> <code class="nf">compare</code><code class="p">(</code><code class="n">Chromosome</code> <code class="n">o1</code><code class="p">,</code>
                         <code class="n">Chromosome</code> <code class="n">o2</code><code class="p">)</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>The last class <strong>ChromosomeComparator</strong> is used when using the Java <strong>Collection</strong> class static <strong>sort</strong> method.</p>

<p>The class <strong>Genetic</strong> is an abstract class: you must subclass it and implement the method <strong>calcFitness</strong> that uses an application specific fitness function (that you must supply) to set a fitness value for each chromosome.</p>

<p>The following UML class diagram provides an overview of the Java classes and their public APIs as well as the class <strong>MyGenetic</strong> that will implement a fitness function for our example of finding a maximum value in an equation and the test class <strong>TestGenetic</strong>:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/genetic-uml.png" alt="UML Class Diagram for library and test program" style="width: 100%">
    <figcaption>UML Class Diagram for library and test program</figcaption>
  </figure>
</div>


<p>This GA library provides the following behavior:</p>

<ul>
  <li>Generates an initial random population with a specified number of bits (or genes) per chromosome and a specified number of chromosomes in the population</li>
  <li>Ability to evaluate each chromosome based on a numeric fitness function</li>
  <li>Ability to create new chromosomes from the most fit chromosomes in the population using the genetic crossover and mutation operations</li>
</ul>

<p>There are two class constructors for <strong>Genetic</strong> set up a new GA experiment. Both constructors require the number of genes (or bits) per chromosome, and the number of chromosomes in the population. The second constructor allows you to optionally set the fractions for mutation and crossover operations.</p>

<p>The <strong>Genetic</strong> class constructors build an array of integers <strong>rouletteWheel</strong> which is used to weight the most fit chromosomes in the population for choosing the parents of crossover and mutation operations. When a chromosome is being chosen, a random integer is selected to be used as an index into the <strong>rouletteWheel</strong> array; the values in the array are all integer indices into the chromosome array. More fit chromosomes are heavily weighted in favor of being chosen as parents for the crossover operations. The algorithm for the crossover operation is fairly simple; here is the implementation:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">public</code> <code class="kt">void</code> <code class="nf">doCrossovers</code><code class="p">()</code> <code class="p">{</code>
       <code class="kt">int</code> <code class="n">num</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)(</code><code class="n">numChromosomes</code> <code class="o">*</code> <code class="n">crossoverFraction</code><code class="p">);</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="n">num</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code> <code class="n">i</code> <code class="o">&gt;=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">--</code><code class="p">)</code> <code class="p">{</code>
         <code class="c1">// Don't overwrite the "best" chromosome</code>
         <code class="c1">// from current generation:</code>
         <code class="kt">int</code> <code class="n">c1</code> <code class="o">=</code> <code class="mi">1</code> <code class="o">+</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="p">((</code><code class="n">rouletteWheelSize</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code>
                             <code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">*</code> <code class="mf">0.9999f</code><code class="p">);</code>
         <code class="kt">int</code> <code class="n">c2</code> <code class="o">=</code> <code class="mi">1</code> <code class="o">+</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="p">((</code><code class="n">rouletteWheelSize</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code>
                             <code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">*</code> <code class="mf">0.9999f</code><code class="p">);</code>
         <code class="n">c1</code> <code class="o">=</code> <code class="n">rouletteWheel</code><code class="o">[</code><code class="n">c1</code><code class="o">]</code><code class="p">;</code>
         <code class="n">c2</code> <code class="o">=</code> <code class="n">rouletteWheel</code><code class="o">[</code><code class="n">c2</code><code class="o">]</code><code class="p">;</code>
         <code class="k">if</code> <code class="p">(</code><code class="n">c1</code> <code class="o">!=</code> <code class="n">c2</code><code class="p">)</code> <code class="p">{</code>
           <code class="kt">int</code> <code class="n">locus</code> <code class="o">=</code> <code class="mi">1</code><code class="o">+</code><code class="p">(</code><code class="kt">int</code><code class="p">)((</code><code class="n">numGenesPerChromosome</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code> <code class="o">*</code>
                               <code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">());</code>
           <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">g</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">g</code><code class="o">&lt;</code><code class="n">numGenesPerChromosome</code><code class="p">;</code> <code class="n">g</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
             <code class="k">if</code> <code class="p">(</code><code class="n">g</code> <code class="o">&lt;</code> <code class="n">locus</code><code class="p">)</code> <code class="p">{</code>
               <code class="n">setGene</code><code class="p">(</code><code class="n">i</code><code class="p">,</code> <code class="n">g</code><code class="p">,</code> <code class="n">getGene</code><code class="p">(</code><code class="n">c1</code><code class="p">,</code> <code class="n">g</code><code class="p">));</code>
             <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
               <code class="n">setGene</code><code class="p">(</code><code class="n">i</code><code class="p">,</code> <code class="n">g</code><code class="p">,</code> <code class="n">getGene</code><code class="p">(</code><code class="n">c2</code><code class="p">,</code> <code class="n">g</code><code class="p">));</code>
             <code class="p">}</code>
           <code class="p">}</code>
         <code class="p">}</code>
       <code class="p">}</code>
     <code class="p">}</code>
</pre></div>

</figure>

<p>The method <strong>doMutations</strong> is similar to <strong>doCrossovers</strong>: we randomly choose chromosomes from the population and for these selected chromosomes we randomly “flip” the value of one gene (a gene is a bit in our implementation):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">void</code> <code class="nf">doMutations</code><code class="p">()</code> <code class="p">{</code>
        <code class="kt">int</code> <code class="n">num</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)(</code><code class="n">numChromosomes</code> <code class="o">*</code> <code class="n">mutationFraction</code><code class="p">);</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">num</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="c1">// Don't overwrite the "best" chromosome</code>
          <code class="c1">// from current generation:</code>
          <code class="kt">int</code> <code class="n">c</code> <code class="o">=</code> <code class="mi">1</code> <code class="o">+</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="p">((</code><code class="n">numChromosomes</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="o">*</code>
                             <code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">*</code> <code class="mf">0.99</code><code class="p">);</code>
          <code class="kt">int</code> <code class="n">g</code> <code class="o">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="p">(</code><code class="n">numGenesPerChromosome</code> <code class="o">*</code>
                         <code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">*</code> <code class="mf">0.99</code><code class="p">);</code>
          <code class="n">setGene</code><code class="p">(</code><code class="n">c</code><code class="p">,</code> <code class="n">g</code><code class="p">,</code> <code class="o">!</code><code class="n">getGene</code><code class="p">(</code><code class="n">c</code><code class="p">,</code> <code class="n">g</code><code class="p">));</code>
        <code class="p">}</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>We developed a general purpose library in this section for simulating populations of chromosomes that can evolve to a more “fit” population given a fitness function that ranks individual chromosomes in order of fitness. In the next section we will develop an example GA application by defining the size of a population and the fitness function that we saw earlier.</p>

<h3 id="java-ga-example">Finding the Maximum Value of a Function</h3>

<p>We will use the Java library in the last section to develop an example application to find the maximum of the function seen in the figure showing the <a href="#ga-sample-function">sample function</a> which shows a plot of our test function we are using a GA to fit, plotted in the interval [0, 10].</p>

<p>While we could find the maximum value of this function by using Newton’s method (or even a simple brute force search over the range of the independent variable <strong>x</strong>), the GA method scales very well to similar problems of higher dimensionality. The GA also helps us to find better than locally optimum solutions. In this example we are working in one dimension so we only need to encode a single variable in a chromosome. As an example of a 20-dimensional space, we might have a financial model with 20 independent variables <strong>x1, x2, ..x20</strong> and a single chromosome would still represent a point in this 20-dimensional space. To continue this example, if we used 10 bits to represent the value range in each of the 20 dimensions, then the chromosome would be represented as 200 bits.</p>

<p>To generalize, our first task is to characterize the search space as one or more parameters. In general when we write GA applications we might need to encode several parameters in a single chromosome. As another example, if a fitness function has three arguments we would encode three numbers in a single chromosome.</p>

<p>Let’s get back to our 1-dimensional example seen in the figure showing the <a href="#ga-sample-function">sample function</a>. This is a simple example showing you how to set up a GA simulation. In this example problem we have only one parameter, the independent variable x. We will encode the parameter x using ten bits (so we have ten 1-bit genes per chromosome). A good starting place is writing a utility method for converting the 10-bit representation to a floating-point number in the range [0.0, 10.0]:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kt">float</code> <code class="nf">geneToFloat</code><code class="p">(</code><code class="kt">int</code> <code class="n">chromosomeIndex</code><code class="p">)</code> <code class="p">{</code>
      <code class="kt">int</code> <code class="n">base</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
      <code class="kt">float</code> <code class="n">x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="n">numGenesPerChromosome</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code>  <code class="p">{</code>
         <code class="k">if</code> <code class="p">(</code><code class="n">getGene</code><code class="p">(</code><code class="n">chromosomeIndex</code><code class="p">,</code> <code class="n">j</code><code class="p">))</code> <code class="p">{</code>
            <code class="n">x</code> <code class="o">+=</code> <code class="n">base</code><code class="p">;</code>
         <code class="p">}</code>
         <code class="n">base</code> <code class="o">*=</code> <code class="mi">2</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>For each bit at index <strong>j</strong> with a value of 1, add
\(2 ^j\) to the sum <strong>x</strong>.
We need to normalize this sum <strong>x</strong> that is an integer in the range of [0,1023] to a floating point number in the approximate range of [0, 10]:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">x</code> <code class="o">/=</code> <code class="mf">102.4f</code><code class="p">;</code>
      <code class="k">return</code> <code class="n">x</code><code class="p">;</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>Note that we do not need the reverse method! We use our GA library from the last section to create a population of 10-bit chromosomes. In order to evaluate the fitness of each chromosome in a population, we only have to convert the 10-bit representation to a floating-point number for evaluation using the fitness function we showed earlier (figure showing the <a href="#ga-sample-function">sample function</a>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">private</code> <code class="kt">float</code> <code class="nf">fitness</code><code class="p">(</code><code class="kt">float</code> <code class="n">x</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="p">(</code><code class="kt">float</code><code class="p">)(</code><code class="n">Math</code><code class="p">.</code><code class="na">sin</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">*</code>
                     <code class="n">Math</code><code class="p">.</code><code class="na">sin</code><code class="p">(</code><code class="mf">0.4f</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code> <code class="o">*</code>
                     <code class="n">Math</code><code class="p">.</code><code class="na">sin</code><code class="p">(</code><code class="mf">3.0f</code> <code class="o">*</code> <code class="n">x</code><code class="p">));</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>The following table shows some sample random chromosomes and the floating point numbers that they encode. The first column shows the gene indices where the bit is “on,” the second column shows the chromosomes as an integer number represented in binary notation, and the third column shows the floating point number that the chromosome encodes. Note that the center column in the following table shows the bits in order where index 0 is the left-most bit, and index 9 is the right-most bit; this is the reverse of the normal order for encoding integers but the GA does not care, it works with any encoding we use as long as it is consistent.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  “On bits” in chromosome   As binary   Number encoded
  -----------------------   ---------   --------------
  2,  5,  7,  8,  9         0010010111  9.1015625
  0,  1,  3,  5,  6         1101011000  1.0449219
  0,  3,  5,  6,  7, 8      1001011110  4.7753906
</pre></div>

</figure>

<p>Using methods <strong>geneToFloat</strong> and <strong>fitness</strong> we now implement the abstract method <strong>calcFitness</strong> from our GA library class <strong>Genetic</strong> so the derived class <strong>TestGenetic</strong> is not abstract. This method has the responsibility for calculating and setting the fitness value for every chromosome stored in an instance of class <strong>Genetic</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">calcFitness</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">numChromosomes</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="kt">float</code> <code class="n">x</code> <code class="o">=</code> <code class="n">geneToFloat</code><code class="p">(</code><code class="n">i</code><code class="p">);</code>
        <code class="n">chromosomes</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">).</code><code class="na">setFitness</code><code class="p">(</code><code class="n">fitness</code><code class="p">(</code><code class="n">x</code><code class="p">));</code>
      <code class="p">}</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>While it was useful to make this example more clear with a separate <strong>geneToFloat</strong> method, it would have also been reasonable to simply place the formula in the method <strong>fitness</strong> in the implementation of the abstract (in the base class) method <strong>calcFitness</strong>.</p>

<p>In any case we are done with coding this example. You can compile the two example Java files <strong>Genetic.java</strong> and <strong>TestGenetic.java</strong>, and run the <strong>TestGenetic</strong> class to verify that the example program quickly finds a near maximum value for this function. The project <em>Makefile</em> has a single target that builds the library and runs the example test program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">test</code><code class="o">:</code>
 <code class="n">mvn</code> <code class="n">install</code>
 <code class="n">mvn</code> <code class="n">exec</code><code class="o">:</code><code class="n">java</code> <code class="o">-</code><code class="n">Dexec</code><code class="o">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s2">"com.markwatson.geneticalgorithm.TestGenetic"</code>
</pre></div>

</figure>

<p>You can try setting different numbers of chromosomes in the population and try setting non-default crossover rates of 0.85 and a mutation rates of 0.3. We will look at a run with a small number of chromosomes in the population created with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">genetic_experiment</code> <code class="o">=</code>
                     <code class="k">new</code> <code class="n">MyGenetic</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mf">0.85f</code><code class="p">,</code> <code class="mf">0.3f</code><code class="p">);</code>
      <code class="kt">int</code> <code class="n">NUM_CYCLES</code> <code class="o">=</code> <code class="mi">500</code><code class="p">;</code>
      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">NUM_CYCLES</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">genetic_experiment</code><code class="p">.</code><code class="na">evolve</code><code class="p">();</code>
        <code class="k">if</code> <code class="p">((</code><code class="n">i</code><code class="o">%</code><code class="p">(</code><code class="n">NUM_CYCLES</code><code class="o">/</code><code class="mi">5</code><code class="p">))</code><code class="o">==</code><code class="mi">0</code> <code class="o">||</code> <code class="n">i</code><code class="o">==</code><code class="p">(</code><code class="n">NUM_CYCLES</code><code class="o">-</code><code class="mi">1</code><code class="p">))</code> <code class="p">{</code>
          <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Generation "</code> <code class="o">+</code> <code class="n">i</code><code class="p">);</code>
          <code class="n">genetic_experiment</code><code class="p">.</code><code class="na">print</code><code class="p">();</code>
        <code class="p">}</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>In this experiment 85% of chromosomes will be “sliced and diced” with a crossover operation and 30% will have one of their genes changed. We specified 10 bits per chromosome and a population size of 20 chromosomes. In this example, I have run 500 evolutionary cycles. After you determine a fitness function to use, you will probably need to experiment with the size of the population and the crossover and mutation rates. Since the simulation uses random numbers (and is thus non-deterministic), you can get different results by simply rerunning the simulation. Here is example program output (with much of the output removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="nv">count</code> <code class="nv">of</code> <code class="nv">slots</code> <code class="nv">in</code> <code class="nv">roulette</code> <code class="nv">wheel</code><code class="o">=</code><code class="mi">55</code>
    <code class="nv">Generation</code> <code class="mi">0</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">0</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">505</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">7</code>.<code class="mi">960</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">1</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">461</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">3</code>.<code class="mi">945</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">2</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">374</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">7</code>.<code class="mi">211</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">3</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">304</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">3</code>.<code class="mi">929</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">4</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">231</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">5</code>.<code class="mi">375</code>
    ...
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">18</code> <code class="nv">is</code> <code class="o">-</code><code class="mi">0</code>.<code class="mi">282</code> <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">1</code>.<code class="mi">265</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">19</code> <code class="nv">is</code> <code class="o">-</code><code class="mi">0</code>.<code class="mi">495</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">5</code>.<code class="mi">281</code>
    <code class="nv">Average</code> <code class="nv">fitness</code><code class="o">=</code><code class="mi">0</code>.<code class="mi">090</code> <code class="nv">and</code> <code class="nv">best</code> <code class="nv">fitness</code> <code class="k">for</code> <code class="nv">this</code>
    <code class="nv">generation</code>:<code class="mi">0</code>.<code class="mi">505</code>
    ...
    <code class="nv">Generation</code> <code class="mi">499</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">0</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">561</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">3</code>.<code class="mi">812</code>
    <code class="nv">Fitness</code> <code class="k">for</code> <code class="nv">chromosome</code> <code class="mi">1</code> <code class="nv">is</code> <code class="mi">0</code>.<code class="mi">559</code>, <code class="nv">occurs</code> <code class="nv">at</code> <code class="nv">x</code><code class="o">=</code><code class="mi">3</code>.<code class="mi">703</code>
    ...
</pre></div>

</figure>

<p>This example is simple but is intended to show you how to encode parameters for a problem where you want to search for values to maximize a fitness function that you specify. Using the library developed in this chapter you should be able to set up and run a GA simulation for your own applications.</p>

<p>The important takeaway is that if you can encode a problem space as a chromosome and you have a fitness function to rate the numerical effectiveness of a chromosome, then Genetic Algorithms are an effective alternative to greedy search algorithms.</p>


<h2 id="neural-networks">Neural Networks</h2>

<p>In a sense training neural networks is a search problem. Given training data and using gradient descent we search for a set of parameters (the weights in a neural network) that model the training data. A dataset is defined by the features in the dataset and the data samples. If we consider our search space to have a number of dimensions equal to the number of features then we can at least imagine that the training samples are an extremely sparse scattering of points in this high-dimensional space. These training data are a distribution of the possible points in this space. Since input features are often correlated we would not expect an even distribution of samples over this space. We refer to the training samples as being “in distribution” and new data that we later process with our trained model to be “out of distribution.” New “out of distribution” data may sometimes represent areas of the space with no training examples nearby and we would expect our model to sometimes perform poorly on this data.</p>

<p>Neural networks can be used to efficiently solve many problems that are intractable or difficult using other AI programming techniques. In the late 1980s I spent almost two years on a DARPA neural network tools advisory panel, wrote the ANSim neural network product, and have used neural networks for a wide range of application problems (radar interpretation, bomb detection, and as controllers in computer games). Mastering the use of neural networks will allow you to solve many types of problems that are very difficult to solve using other methods.</p>

<p>Gradient descent is a general term for moving in a direction in a space that is “down hill” towards a local minimum. Here I write an implementation for a backpropagation neural network from scratch (pure Java code, no libraries). The material in this chapter is meant to provide you with an intuition of how backpropagation works while the next chapter covers a robust deep learning library that you should use in for modeling large datasets. Backpropagation is a type of gradient descent that works by changing weight values (the parameters in a neural network model) in the direction of reducing the error between what our model predicts for a set of input values and what the target output is in training data.</p>

<p>In the next chapter <a href="#dl4j">Deep Learning Using Deeplearning4j</a> we will use a popular Java deep learning library that can efficiently process neural networks with more complex architectures and larger numbers of simulated neurons. These  “Deep Learning” neural networks use computational tricks to efficiently train more complex Backpropagation networks.</p>

<p>Although most of this book is intended to provide practical advice (with some theoretical background) on using AI programming techniques, I cannot imagine being interested in practical AI programming without also thinking about the philosophy and mechanics of how the human mind works. I hope that my readers share this interest.</p>

<p>The physical structure and dynamics of the human brain are inherently parallel and distributed [<em>Parallel Distributed Processing: Explorations in the
Microstructure of Cognition</em>, Rumelhart, McClelland, etc. 1986]. We are experts at doing many things at once. For example, I simultaneously can walk, talk with my wife, keep our puppy out of cactus, and enjoy the scenery behind our house in Sedona, Arizona. AI software systems struggle to perform even narrowly defined tasks well, so how is it that we are able to simultaneously perform several complex tasks? There is no clear or certain answer to this question at this time, but certainly the distributed neural architecture of our brains is a requirement for our abilities. Classical artificial neural network simulations (like the ones we study in this chapter) do not address “multi-tasking” (other techniques that do address this issue are multi-agent systems with some form or mediation between agents). Deep learning models can have multiple types of inputs, different types of outputs, and complex internal structure - basically connected models that are trained jointly. While deep learning models trained jointly on different types of input data break through the limitations of simple backpropagation models, the simple backpropagation models we look at now are still very practical today for a range of problems.</p>

<p>Also interesting is the distinction between instinctual behavior and learned behavior. Our knowledge of GAs from the chapter on <a href="#ga">Genetic Algorithms</a> provides a clue to how the brains of lower order animals can be hardwired to provide efficient instinctual behavior under the pressures of evolutionary forces (i.e., likely survival of more fit individuals). This works by using genetic algorithms to design specific neural wiring. I have used genetic algorithms to evolve recurrent neural networks for control applications (I wrote about this in <em>C++ Power Paradigms</em>, 1995, McGraw-Hill). This work had only partial success but did convince me that biological genetic pressure is probably adequate to “pre-wire” some forms of behavior in natural (biological) neural networks.</p>

<p>While we will study supervised learning techniques in this chapter, it is possible to evolve both structure and attributes of neural networks using other types of neural network models like Adaptive Resonance Theory (ART) to autonomously learn to classify learning examples without
intervention.</p>

<p>We will start this chapter by discussing human neuron cells and which features of real neurons that we will model. Unfortunately, we do not yet understand all of the biochemical processes that occur in neurons, but there are fairly accurate models available (web search “neuron biochemical”). Neurons are surrounded by thin hair-like structures called dendrites which serve to accept activation from other neurons. Neurons sum up activation from their dendrites and each neuron has a threshold value; if the activation summed over all incoming dendrites exceeds this threshold, then the neuron fires, spreading its activation to other neurons. Dendrites are very localized around a neuron. Output from a neuron is carried by an axon, which is thicker than dendrites and potentially much longer than dendrites in order to affect remote neurons. The following figure shows the physical structure of a neuron; in general, the neuron’s axon would be much longer than is seen in this figure. The axon terminal buttons transfer activation to the dendrites of neurons that are close to the individual button. An individual neuron is connected to up to ten thousand other neurons in this way.</p>


<div class="figure-wrapper center">
  <figure id="nn-neuron" class="image" style="width: 189px">
    <img src="images/nn_neuron.png" alt="Neuron" style="width: 100%">
    <figcaption>Neuron</figcaption>
  </figure>
</div>


<p>The activation absorbed through dendrites is summed together, but the firing of a neuron only occurs when a threshold is passed. In neural network simulations there are several common ways to model neurons and connections between neurons that we will see in both this and the next chapter.</p>

<h3 id="leanpub-auto-road-map-for-the-neural-network-example-code">Road Map for the Neural Network Example Code</h3>

<p>The following UML class diagram will give you an overview all of the neural network library classes in this chapter before we dive into the code:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/neuralnetwork-uml.png" alt="UML class diagram for neural network code" style="width: 100%">
    <figcaption>UML class diagram for neural network code</figcaption>
  </figure>
</div>


<p>There are three parts to the code base: main backpropagation library, GUI examples, and text-only tests. The following screen show of the project open in an IDE is useful to see the file layout for the project:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/neural-ide.png" alt="IDE view of code showing main library, GUI examples, and text-only tests" style="width: 100%">
    <figcaption>IDE view of code showing main library, GUI examples, and text-only tests</figcaption>
  </figure>
</div>


<h3 id="backprop">Backpropagation Neural Networks</h3>

<p>The neural network model that we use is called backpropagation, also known as back-prop or delta rule learning. In this model, neurons are organized into data structures that we call layers. The figure <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a> shows a simple neural network with two layers; this network is shown in two different views: just the neurons organized as two one-dimensional arrays, and as two one-dimensional arrays with the connections between the neurons. In our model, there is a connection between two neurons that is characterized by a single floating-point number that we will call the connection’s weight. A
weight <strong>W_{i,j}</strong> connects input neuron <strong>i</strong> to output neuron <strong>j</strong>. In the back propagation model, we always assume that a neuron is connected to every neuron in the previous layer.</p>

<p>A key feature of back-prop neural networks is that they can be efficiently trained. Training is performed by calculating sets of weights for connecting each layer. As we will see, we will train networks by applying input values to the input layer, allowing these values to propagate through the network using the current weight values, and calculating the errors between desired output values and the output values from propagation of input values through the network.</p>

<p>The errors at the output layer are used to calculate gradients (or corrections) to the weights feeding into the output layer. Gradients are back propagated through the network allowing all weights in the network to be updated to reduce errors visible at the output layer.</p>

<p>One limitation of early back propagation neural networks is that they are limited to the number of neuron layers that can be efficiently trained. More recent advances in deep learning have mostly solved this problem: as error gradients are back propagated through the network toward the input layer, the gradients get smaller and smaller. If these gradients <em>vanish</em> because they can’t be represented as a floating point number then weight updates will be zero and the model is not trained. Another effect of many hidden layers is that it can take a lot of time to train back propagation networks. This problem has also mostly been solved with modern deep learning libraries as seen in the next chapter <strong>Deep Learning</strong>.</p>

<p>Initially, weights are set to small random values. You will get a general idea for how this is done in this section and then we will look at Java implementation code in the section for a <a href="#nn-bp-lib">Java Class Library for Backpropagation</a>.</p>

<p>In the figure showing a <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a>, we have only two neuron layers, one for the input neurons and one for the output neurons. Networks with no hidden layers are not generally useful - I am using the network in  the figure showing a <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a> just to demonstrate layer to layer connections through a weights array.</p>


<div class="figure-wrapper center">
  <figure id="nn-backprop-no-hidden" class="image" style="width: 356px">
    <img src="images/nn_backprop2d.png" alt="Example Backpropagation network with No Hidden Layer" style="width: 100%">
    <figcaption>Example Backpropagation network with No Hidden Layer</figcaption>
  </figure>
</div>


<p>To calculate the activation of the first output neuron <strong>O1</strong>, we evaluate the sum of the products of the input neurons times the appropriate weight values; this sum is input to a <strong>Sigmoid</strong> activation function (see the figure showing the <a href="#nn-sigmoid">Sigmoid Function</a>) and the result is the new activation value for <strong>O1</strong>. Here is the formula for the simple network in the figure showing a <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">O1</code> <code class="o">=</code> <code class="n">Sigmoid</code> <code class="p">(</code><code class="n">I1</code> <code class="o">*</code> <code class="n">W</code><code class="o">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">1</code><code class="o">]</code> <code class="o">+</code> <code class="n">I2</code> <code class="o">*</code> <code class="n">W</code><code class="o">[</code><code class="mi">2</code><code class="p">,</code><code class="mi">1</code><code class="o">]</code><code class="p">)</code>
<code class="n">O2</code> <code class="o">=</code> <code class="n">Sigmoid</code> <code class="p">(</code><code class="n">I2</code> <code class="o">*</code> <code class="n">W</code><code class="o">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="o">]</code> <code class="o">+</code> <code class="n">I2</code> <code class="o">*</code> <code class="n">W</code><code class="o">[</code><code class="mi">2</code><code class="p">,</code><code class="mi">2</code><code class="o">]</code><code class="p">)</code>
</pre></div>

</figure>

<p>The figure showing the <a href="#nn-sigmoid">Sigmoid Function</a> shows a plot of the <strong>Sigmoid</strong> function and the derivative of the sigmoid function (<strong>SigmoidP</strong>). We will use the derivative of the <strong>Sigmoid</strong> function when training a neural network (with at least one hidden neuron layer) with classified data examples.</p>


<div class="figure-wrapper center">
  <figure id="nn-sigmoid" class="image" style="width: 319px">
    <img src="images/nn_sigmoid.png" alt="Sigmoid Function and Derivative of Sigmoid Function (SigmoidP)" style="width: 100%">
    <figcaption>Sigmoid Function and Derivative of Sigmoid Function (SigmoidP)</figcaption>
  </figure>
</div>


<p>A neural network like the one seen in the figure showing a <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a> is trained by using a set of training data. For back propagation networks, training data consists of matched sets of input with matching desired output values. We want to train a network to not only produce similar outputs for training data inputs as appear in the training data, but also to generalize its pattern matching ability based on the training data to be able to match test patterns that are similar to training input patterns. A key here is to balance the size of the network against how much information it must hold. A common mistake when using back-prop networks is to use too large a network: a network that contains too many neurons and connections will simply memorize the training examples, including any noise in the training data. However, if we use a smaller number of neurons with a very large number of training data examples, then we force the network to generalize, ignoring noise in the training
data and learning to recognize important traits in input data while ignoring statistical noise.</p>

<p>How do we train a back propagation neural network given that we have a good training data set? The algorithm is quite easy; we will now walk through the simple case of a two-layer network like the one in the figure showing a <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a>. Later in the section for a <a href="#nn-bp-lib">Java Class Library for Back Propagation</a> we will review the algorithm in more detail when we have either one or two hidden neuron layers between the input and output layers.</p>

<p>In order to train the network in the figure for a <a href="#nn-backprop-no-hidden">Backpropagation network with No Hidden Layer</a>, we repeat the following learning cycle several times:</p>

<ol class="numeric">
  <li>Zero out temporary arrays for holding the error at each neuron. The
error, starting at the output layer, is the difference between the
output value for a specific output layer neuron and the calculated
value from setting the input layer neuron’s activation values to the
input values in the current training example, and letting activation
spread through the network.</li>
  <li>Update the weight <strong>W_{i,j}</strong> (where <strong>i</strong> is the index of an input
neuron, and <strong>j</strong> is the index of an output neuron) using the formula
<strong>W_{i,j} += learning_rate * output_error_j*I_i</strong> (<strong>learning_rate</strong>
is a tunable parameter) and <strong>output_error_j</strong> was calculated in step
1, and <strong>I_i</strong> is the activation of input neuron at index <strong>i</strong>.</li>
</ol>

<p>This process is continued to either a maximum number of learning cycles or until the calculated output errors get very small. We will see later that the algorithm is similar but slightly more complicated when we have hidden neuron layers; the difference is that we will “back propagate” output errors to the hidden layers in order to estimate errors for hidden neurons. We will cover more on this later. This type of neural network is too simple to solve very many interesting problems, and in practical applications we almost always use either one additional hidden neuron layer or two additional hidden neuron layers. The figure showing <a href="#nn-mapping">mappings supported by zero hidden layer, one hidden layer, and two hidden hidden layer networks</a> shows the types of problems that can be solved by networks with different numbers of hidden layers.</p>


<div class="figure-wrapper center">
  <figure id="nn-mapping" class="image" style="width: 399px">
    <img src="images/nn_maping.png" alt="Mappings supported by 0, 1, and 2 hidden layer neural networks" style="width: 100%">
    <figcaption>Mappings supported by 0, 1, and 2 hidden layer neural networks</figcaption>
  </figure>
</div>


<h3 id="nn-bp-lib">A Java Class Library for Back Propagation</h3>

<p>The back propagation neural network library used in this chapter was written to be easily understood and is useful for many problems. However, one thing that is not in the implementation in this section (it is added in the section <a href="#nn-bprop-momentum">Using Momentum to speed up training</a>) is something usually called “momentum” to speed up the training process at a cost of doubling the storage requirements for weights. Adding a “momentum” term not only makes learning faster but also increases the chances of successfully learning more difficult problems.</p>

<p>We will concentrate in this section on implementing a back-prop learning algorithm that works for both one and two hidden layer networks. As we saw in the <a href="#nn-mapping">Figure
showing mappings supported by zero hidden layer, one hidden layer, and two hidden layer networks</a>, a network with two hidden layers is capable of arbitrary mappings of input to output values. It used to be a common (and incorrect) opinion that there was no theoretical reason for using networks with three hidden layers. With recent projects using Deep Learning as I mentioned at the beginning of this chapter, neural networks with many hidden layers are now common practice. Here is one of the example programs that helps visualize a 1\one hidden layer network:</p>


<div class="figure-wrapper center">
  <figure id="example-1-hidden-layer-1" class="image" style="width: 259px">
    <img src="images/nn_1d_example_1.png" alt="Example showing 1 hidden layer" style="width: 100%">
    <figcaption>Example showing 1 hidden layer</figcaption>
  </figure>
</div>


<p>With each layer having three neurons, the weight matrices are <strong>3 x 3</strong> arrays and are easy to display. When you run the examples you can see the weight matches changing in time. Here is another example program that adds an additional hidden layer:</p>


<div class="figure-wrapper center">
  <figure id="example-2-hidden-layer1-1" class="image" style="width: 254px">
    <img src="images/nn_2d_example_1.png" alt="Example showing 2 hidden layers" style="width: 100%">
    <figcaption>Example showing 2 hidden layers</figcaption>
  </figure>
</div>


<p>Please note, dear reader, that simple networks like these examples are <em>explainable</em> in the sense that you can understand how they work after they are trained because they have so few parameters. We can characterize the complexity of models as the number of layers and the total number of connection weights. We might say that the one hidden layer model has 9 parameters and the two hidden layer model has 18 parameters (i.e., the total number of weights that we must learn effective values for). In general large neural models, especially deep learning models, are <em>not explainable</em>. There are some applications that are required by law to be explainable for which neural networks are not appropriate to use. Another issue is fairness of models if they are trained on biased data.</p>

<p>The relevant files for the back propagation examples are:</p>

<ul>
  <li>Neural_1H.java - contains a class for simulating a neural network with one hidden neuron layer</li>
  <li>Test_1H.java - a text-based test program for the class Neural_1H</li>
  <li>GUITest_1H.java - a GUI-based test program for the class Neural_1H</li>
  <li>Neural_2H.java - contains a class for simulating a neural network with two hidden neuron layers</li>
  <li>Neural_2H_momentum.java - contains a class for simulating a neural network with two hidden neuron layers and implements momentum learning (implemented in the section <a href="#nn-bprop-momentum">Using Momentum to speed up training</a>
</li>
  <li>Test_2H.java - a text-based test program for the class Neural_2H</li>
  <li>GUITest_2H.java - a GUI-based test program for the class Neural_2H</li>
  <li>GUITest_2H_momentum.java - a GUI-based test program for the class Neural_2H_momentum that uses momentum learning (implemented in the section <a href="#nn-bprop-momentum">Using Momentum to speed up training</a>
</li>
  <li>Plot1DPanel - a Java JFC graphics panel for the values of a one-dimensional array of floating point values</li>
  <li>Plot2DPanel - a Java JFC graphics panel for the values of a two-dimensional array of floating point values</li>
</ul>

<p>The GUI files are for demonstration purposes only, and we will not discuss the code for these classes; if you are interested in the demo graphics code and do not know JFC Java programming, there are a few good JFC tutorials at the web.</p>

<p>It is common to implement back-prop libraries to handle either zero, one, or two hidden layers in the same code base. At the risk of having to repeat similar code in two different classes, I decided to make the <strong>Neural_1H</strong> and <strong>Neural_2H</strong> classes distinct. I think that this makes the code a little easier to understand. As a practical point, you will almost always start solving a neural network problem using only one hidden layer and only progress to trying two hidden layers if you can’t train a one hidden layer network to solve the problem at-hand with sufficiently small error when tested with data that is different from the original training data. Networks with only one hidden layer require less storage space and run faster in simulation than two hidden layer networks.</p>

<p>In this section we will look only at the implementation of the class <strong>Neural_2H</strong> (class <strong>Neural_1H</strong> is simpler and when you understand how <strong>Neural_2H</strong> works, the simpler class is also easy to understand). This class implements the <strong>Serializable</strong> interface and contains a utility method <strong>save</strong> to write a trained network to a disk file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">class</code> <code class="nc">Neural_2H</code> <code class="kd">implements</code> <code class="n">Serializable</code> <code class="p">{</code> 
</pre></div>

</figure>

<p>There is a static factory method that reads a saved network file from disk and builds an instance of <strong>Neural_2H</strong> and there is a class constructor that builds a new untrained network in memory, given the number of neurons in each layer:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">public</code> <code class="kd">static</code> <code class="n">Neural_2H</code> <code class="nf">Factory</code><code class="p">(</code><code class="n">String</code> <code class="n">serialized_file_name</code><code class="p">)</code>
     <code class="kd">public</code> <code class="nf">Neural_2H</code><code class="p">(</code><code class="kt">int</code> <code class="n">num_in</code><code class="p">,</code>
                      <code class="kt">int</code> <code class="n">num_hidden1</code><code class="p">,</code>
                      <code class="kt">int</code> <code class="n">num_hidden2</code><code class="p">,</code> <code class="kt">int</code> <code class="n">num_output</code><code class="p">)</code> 
</pre></div>

</figure>

<p>An instance of <strong>Neural_2H</strong> contains training data as transient data that is not saved by method <strong>save</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">transient</code> <code class="kd">protected</code> <code class="n">ArrayList</code> <code class="n">inputTraining</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="p">();</code>
     <code class="kd">transient</code> <code class="kd">protected</code> <code class="n">ArrayList</code> <code class="n">outputTraining</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Vector</code><code class="p">();</code> 
</pre></div>

</figure>

<p>I want the training examples to be native float arrays so I used generic <strong>ArrayList</strong> containers. You will usually need to experiment with training parameters in order to solve difficult problems. The learning rate not only controls how large the weight corrections we make each
learning cycle but this parameter also affects whether we can break out of local minimum. Other parameters that affect learning are the ranges of initial random weight values that are hardwired in the method <strong>randomizeWeights()</strong> and the small random values that we add to weights during the training cycles; these values are set in in <strong>slightlyRandomizeWeights()</strong>. I usually only need to adjust the learning rate when training back-prop networks:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">public</code> <code class="kt">float</code> <code class="n">TRAINING_RATE</code> <code class="o">=</code> <code class="mf">0.5f</code><code class="p">;</code> 
</pre></div>

</figure>

<p>I often decrease the learning rate during training - that is, I start with a large learning rate and gradually reduce it during training. The calculation for output neuron values given a set of inputs and the current weight values is simple. I placed the code for calculating a
forward pass through the network in a separate method <strong>forwardPass()</strong> because it is also used later in the method <strong>training</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">public</code> <code class="kt">float</code><code class="o">[]</code> <code class="nf">recall</code><code class="p">(</code><code class="kt">float</code><code class="o">[]</code> <code class="n">in</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numInputs</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="n">inputs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">in</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
       <code class="n">forwardPass</code><code class="p">();</code>
       <code class="kt">float</code><code class="o">[]</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">float</code><code class="o">[</code><code class="n">numOutputs</code><code class="o">]</code><code class="p">;</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="n">ret</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="n">outputs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
       <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
     <code class="p">}</code>

     <code class="kd">public</code> <code class="kt">void</code> <code class="nf">forwardPass</code><code class="p">()</code> <code class="p">{</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">hidden1</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
       <code class="p">}</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
       <code class="p">}</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numInputs</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
           <code class="n">hidden1</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">+=</code> <code class="n">inputs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">*</code> <code class="n">W1</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">h</code><code class="o">]</code><code class="p">;</code>
         <code class="p">}</code>
       <code class="p">}</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
           <code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">+=</code> <code class="n">hidden1</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">*</code> <code class="n">W2</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">h</code><code class="o">]</code><code class="p">;</code>
         <code class="p">}</code>
       <code class="p">}</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="n">outputs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
       <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
           <code class="n">outputs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">+=</code> <code class="n">sigmoid</code><code class="p">(</code><code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">)</code> <code class="o">*</code> <code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code><code class="p">;</code>
         <code class="p">}</code>
       <code class="p">}</code>
     <code class="p">}</code> 
</pre></div>

</figure>

<p>While the code for <strong>recall</strong> and <strong>forwardPass</strong> is almost trivial, the training code in method <strong>train</strong> is more complex and we will go through it in some detail. Before we get to the code, I want to mention that there are two primary techniques for training back-prop networks. The technique that I use is to update the weight arrays after each individual training example. The other technique is to sum all output errors over the entire training set (or part of the training set) and then calculate weight updates. In the following discussion, I am going to weave my comments on the code into the listing. The private member variable <strong>current_example</strong> is used to cycle through the training examples: one training example is processed each time that the <strong>train</strong>
method is called:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kd">private</code> <code class="kt">int</code> <code class="n">current_example</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

     <code class="kd">public</code> <code class="kt">float</code> <code class="nf">train</code><code class="p">(</code><code class="n">ArrayList</code> <code class="n">ins</code><code class="p">,</code> <code class="n">ArrayList</code> <code class="n">v_outs</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>Before starting a training cycle for one example, we zero out the arrays used to hold the output layer errors and the errors that are back propagated to the hidden layers. We also need to copy the training example input values and output values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="kt">int</code> <code class="n">i</code><code class="p">,</code> <code class="n">h</code><code class="p">,</code> <code class="n">o</code><code class="p">;</code> <code class="kt">float</code> <code class="n">error</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
     <code class="kt">int</code> <code class="n">num_cases</code> <code class="o">=</code> <code class="n">ins</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> 
     <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">example</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">example</code><code class="o">&lt;</code><code class="n">num_cases</code><code class="p">;</code> <code class="n">example</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="c1">// zero out error arrays:</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="n">hidden1_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code>
       <code class="c1">// copy the input values:</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numInputs</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">inputs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">=</code> <code class="p">((</code><code class="kt">float</code><code class="o">[]</code><code class="p">)</code> <code class="n">ins</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">current_example</code><code class="p">))</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
       <code class="p">}</code>
       <code class="c1">// copy the output values:</code>
       <code class="kt">float</code><code class="o">[]</code> <code class="n">outs</code> <code class="o">=</code> <code class="p">(</code><code class="kt">float</code><code class="o">[]</code><code class="p">)</code> <code class="n">v_outs</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">current_example</code><code class="p">);</code>
</pre></div>

</figure>

<p>We need to propagate the training example input values through the hidden layers to the output layers. We use the current values of the weights:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="n">forwardPass</code><code class="p">();</code> 
</pre></div>

</figure>

<p>After propagating the input values to the output layer, we need to calculate the output error for each output neuron. This error is the difference between the desired output and the calculated output; this difference is multiplied by the value of the calculated output neuron value that is first modified by the <strong>Sigmoid</strong> function that we saw in the figure showing the <a href="#nn-sigmoid">Sigmoid Function</a>. The <strong>Sigmoid</strong> function is to clamp the calculated output value to a reasonable range.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">=</code> <code class="p">(</code><code class="n">outs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">-</code> <code class="n">outputs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code><code class="p">)</code> <code class="o">*</code> <code class="n">sigmoidP</code><code class="p">(</code><code class="n">outputs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code><code class="p">);</code>
     <code class="p">}</code> 
</pre></div>

</figure>

<p>The errors for the neuron activation values in the second hidden layer (the hidden layer connected to the output layer) are estimated by summing for each hidden neuron its contribution to the errors of the output layer neurons. The thing to notice is that if the connection weight value between hidden neuron <strong>h</strong> and output neuron <strong>o</strong> is large, then hidden neuron <strong>h</strong> is contributing more to the error of output neuron <strong>o</strong> than other neurons with smaller connecting weight values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">+=</code> <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code><code class="p">;</code>
       <code class="p">}</code>
     <code class="p">}</code> 
</pre></div>

</figure>

<p>We estimate the errors in activation energy for the first hidden layer neurons by using the estimated errors for the second hidden layers that we calculated in the last code snippet:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="n">hidden1_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="mf">0.0f</code><code class="p">;</code> <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">hidden1_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">+=</code> <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">W2</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code><code class="p">;</code>
       <code class="p">}</code>
     <code class="p">}</code>
</pre></div>

</figure>

<p>After we have scaled estimates for the activation energy errors for both hidden layers we then want to scale the error estimates using the derivative of the sigmoid function’s value of each hidden neuron’s activation energy:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">*</code> <code class="n">sigmoidP</code><code class="p">(</code><code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">);</code>
     <code class="p">}</code>
     <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="n">hidden1_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="n">hidden1_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">*</code> <code class="n">sigmoidP</code><code class="p">(</code><code class="n">hidden1</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">);</code>
     <code class="p">}</code> 
</pre></div>

</figure>

<p>Now that we have estimates for the hidden layer neuron errors, we update the weights connecting to the output layer and each hidden layer by adding the product of the current learning rate, the estimated error of each weight’s target neuron, and the value of the weight’s source neuron:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="c1">// update the hidden2 to output weights:</code>
     <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">+=</code> <code class="n">TRAINING_RATE</code> <code class="o">*</code> <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">;</code>
         <code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">=</code> <code class="n">clampWeight</code><code class="p">(</code><code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code><code class="p">);</code>
       <code class="p">}</code>
     <code class="p">}</code>
     <code class="c1">// update the hidden1 to hidden2 weights:</code>
     <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numHidden2</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">W2</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">+=</code> <code class="n">TRAINING_RATE</code> <code class="o">*</code> <code class="n">hidden2_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">hidden1</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">;</code>
         <code class="n">W2</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">=</code> <code class="n">clampWeight</code><code class="p">(</code><code class="n">W2</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code><code class="p">);</code>
       <code class="p">}</code>
     <code class="p">}</code>
     <code class="c1">// update the input to hidden1 weights:</code>
     <code class="k">for</code> <code class="p">(</code><code class="n">h</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">h</code> <code class="o">&lt;</code> <code class="n">numHidden1</code><code class="p">;</code> <code class="n">h</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">numInputs</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
         <code class="n">W1</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">h</code><code class="o">]</code> <code class="o">+=</code> <code class="n">TRAINING_RATE</code> <code class="o">*</code> <code class="n">hidden1_errors</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">*</code> <code class="n">inputs</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
         <code class="n">W1</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">h</code><code class="o">]</code> <code class="o">=</code> <code class="n">clampWeight</code><code class="p">(</code><code class="n">W1</code><code class="o">[</code><code class="n">i</code><code class="o">][</code><code class="n">h</code><code class="o">]</code><code class="p">);</code>
       <code class="p">}</code>
     <code class="p">}</code>
     <code class="k">for</code> <code class="p">(</code><code class="n">o</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">o</code> <code class="o">&lt;</code> <code class="n">numOutputs</code><code class="p">;</code> <code class="n">o</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
       <code class="n">error</code> <code class="o">+=</code> <code class="n">Math</code><code class="p">.</code><code class="na">abs</code><code class="p">(</code><code class="n">outs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">-</code> <code class="n">outputs</code><code class="o">[</code><code class="n">o</code><code class="o">]</code><code class="p">);</code>
     <code class="p">}</code> 
</pre></div>

</figure>

<p>The last step in this code snippet was to calculate an average error over all output neurons for this training example. This is important so that we can track the training status in real time. For very long running back-prop training experiments I like to be able to see this error graphed in real time to help decide when to stop a training run. This allows me to experiment with the learning rate initial value and see how fast it decays. The last thing that method <strong>train</strong> needs to do
is to update the training example counter so that the next example is used the next time that <strong>train</strong> is called:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="n">current_example</code><code class="o">++</code><code class="p">;</code>
     <code class="k">if</code> <code class="p">(</code><code class="n">current_example</code> <code class="o">&gt;=</code> <code class="n">num_cases</code><code class="p">)</code>
       <code class="n">current_example</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
     <code class="k">return</code> <code class="n">error</code><code class="p">;</code>
   <code class="p">}</code> 
</pre></div>

</figure>

<p>You can look at the implementation of the Swing GUI test class <strong>GUTest_2H</strong> to see how I decrease the training rate during training. I also monitor the summed error rate over all output neurons and occasionally randomize the weights if the network is not converging to a solution to the current problem.</p>

<h3 id="nn-bprop-momentum">Adding Momentum to Speed Up Back-Prop Training</h3>

<p>We did not use a momentum term in the Java code in the section for a <a href="#nn-bp-lib">Java Class Library for Back Propagation</a>. For difficult to train problems, adding a momentum term can drastically reduce the training time at a cost of doubling the weight storage requirements. To implement momentum, we remember how much each weight was changed in the previous learning cycle and make the weight change larger if the current change in “direction” is the same as the last learning cycle. For example, if the change to weight <strong>W_{i,j}</strong> had a large positive value in the last learning cycle and the calculated weight change for <strong>W_{i,j}</strong> is also a large positive value in the current learning cycle, then make the current weight change even larger. Adding a “momentum” term not only makes learning faster but also increases the chances of successfully learning more difficult problems.</p>

<p>I modified two of the classes from the section for a <a href="#nn-bp-lib">Java Class Library for Back Propagation</a> to use
momentum:</p>

<ul>
  <li>Neural_2H_momentum.java - training and recall for two hidden layer
back-prop networks. The constructor has an extra argument “alpha”
that is a scaling factor for how much of the previous cycle’s weight
change to add to the new calculated delta weight values.</li>
  <li>GUITest_2H_momentum.java - a GUI test application that tests the
new class <strong>Neural_2H_momentum</strong>.</li>
</ul>

<p>The code for class <strong>Neural_2H_momentum</strong> is similar to the code for <strong>Neural_2H</strong> that we saw in the last section so here we will just look at the differences. The class constructor now takes another parameter
<strong>alpha</strong> that determines how strong the momentum correction is when we modify weight values:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="c1">// momentum scaling term that is applied</code>
     <code class="c1">// to last delta weight:</code>
     <code class="kd">private</code> <code class="kt">float</code> <code class="n">alpha</code> <code class="o">=</code> <code class="mf">0.2f</code><code class="p">;</code> 
</pre></div>

</figure>

<p>While this <strong>alpha</strong> term is used three times in the training code, it suffices to just look at one of these uses in detail. When we allocated the three weight arrays <strong>W1</strong>, <strong>W2</strong>, and <strong>W3</strong> we also now allocate three
additional arrays of corresponding same size: <strong>W1_last_delta</strong>,
<strong>W2_last_delta</strong>, and <strong>W3_last_delta</strong>. These three new arrays are used to store the weight changes for use in the next training cycle. Here is the original code to update <strong>W3</strong> from the last section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">+=</code> <code class="n">TRAINING_RATE</code> <code class="o">*</code> <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">;</code> 
</pre></div>

</figure>

<p>The following code snippet shows the additions required to use momentum:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>     <code class="n">W3</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">+=</code> <code class="n">TRAINING_RATE</code> <code class="o">*</code> <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code> <code class="o">+</code>
       <code class="c1">// apply the momentum term:</code>
       <code class="n">alpha</code> <code class="o">*</code> <code class="n">W3_last_delta</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code><code class="p">;</code> 
     <code class="n">W3_last_delta</code><code class="o">[</code><code class="n">h</code><code class="o">][</code><code class="n">o</code><code class="o">]</code> <code class="o">=</code> <code class="n">TRAINING_RATE</code> <code class="o">*</code> <code class="n">output_errors</code><code class="o">[</code><code class="n">o</code><code class="o">]</code> <code class="o">*</code> <code class="n">hidden2</code><code class="o">[</code><code class="n">h</code><code class="o">]</code><code class="p">;</code> 
</pre></div>

</figure>

<p>I mentioned in the last section that there are at least two techniques for training back-prop networks: updating the weights after processing each training example or waiting to update weights until all training examples are processed. I always use the first method when I don’t use momentum. In many cases it is best to use the second method when using momentum. In the next chapter on Deep Learning we use a third method for using training data: we choose randomly selected small batches of training examples for each weight update cycle.</p>

<h3 id="leanpub-auto-wrap-up-for-neural-networks">Wrap-up for Neural Networks</h3>

<p>I hope that the material in this chapter has given you some low-level understanding of the implementation of backpropagation neural networks. We will use a popular deep learning library in the next chapter that in practice you should prefer to the pedantic code here. That said, I used very similar C++ code to that developed here for several practical engineering problems in the 1980s and early 1990s including the prediction code for a bomb detector my company made for the FAA.</p>


<h2 id="dl4j">Deep Learning Using Deeplearning4j</h2>

<p>One limitation of back propagation neural networks seen in the last chapter is that they are limited to the number of neuron layers that can be efficiently trained. If you experimented with the sample back propagation code then you may have noticed that it took longer to train a network with two hidden layers compared to the training time for a network with only one hidden layer. There are also problems like vanishing gradients (the backpropagated errors that are used to update connection weights) that occur in architectures with many layers. Deep learning uses computational improvements to mitigate the vanishing gradient problem like using ReLu activation functions rather than the more traditional Sigmoid function, and networks called “skip connections” networks where some layers are initially turned off with connections skipping to the next active layer. After some initial training the skipped layers are activated and become part of the model (as in ResNet50, mentioned in the section <a href="#zoo">Roadmap for the DL4J Model Zoo</a> at the end of this chapter).</p>

<p>Digging deeper into the problem of vanishing gradients, the problem with back propagation networks is that as error gradients are back propagated through the network toward the input layer, the gradients get smaller and smaller. The effect is that it can take a lot of time to train back propagation networks with many hidden layers. Even worse, the small backpropagated errors get so small that they cause numerical underflows.</p>

<p>I became interested in deep learning neural networks when I took Geoffrey Hinton’s Neural Network class (a Coursera class, taken summer of 2012) and then for the next seven years most of my professional work involved deep learning. I have used GAN (generative adversarial networks) models for synthesizing numeric spreadsheet data, LSTM (long short term memory) models to synthesize highly structured text data like nested JSON, and for NLP (natural language processing). Several of my 55 US patents use neural network and Deep Learning technology.</p>

<p>The <a href="http://deeplearning4j.org/">Deeplearning4j.org</a> Java library supports many neural network algorithms including support for Deep Learning (DL).  Note that I will often refer to Deeplearning4j as DL4J. </p>

<p>We will first look at a simple example of a feed forward network using the same University of Wisconsin cancer database that we used earlier. Deep learning refers to neural networks with many layers, possibly with weights connecting neurons in non-adjacent layers which makes it possible to model temporal and spacial patterns in data.</p>

<p>There is a separate <a href="https://github.com/eclipse/deeplearning4j-examples">repository of DL4J examples</a> that you should clone because the last half of this chapter is a general discussion of running the DL4J examples and modifying them for your needs with one additional example using LSTM models.</p>

<p>After the first simple example we then look at how to set up DL4J projects using Maven, and then discuss other types of layer classes that you will likely use in your projects. After learning how to set up and use DL4J and having a roadmap of commonly used layer classes, then you will then be set to work on your own projects.</p>

<h3 id="leanpub-auto-feed-forward-classification-networks">Feed Forward Classification Networks</h3>

<p>Feed forward classification networks are a type of deep neural network that can contain multiple hidden neuron layers. In the example here the adjacent layers are fully connected (all neurons in adjacent layers are connected), as in the examples from the last chapter. The difference here is the use of the DL4J library that is written to scale to large problems and to use GPUs if you have them available.</p>

<p>In general, simpler network architectures are better than unnecessarily complicated architectures. You can start with simple architectures and add layers, different layer types, and parallel models as-needed. For feed forward networks model complexity has two dimensions: the numbers of neurons in hidden layers, and also the number of hidden layers. If you put too many neurons in hidden layers then the training data is effectively memorized and this will hurt performance on data samples not used in training. In practice, I “starve the network” by reducing the number of hidden neurons until the model has reduced accuracy on independent test data. Then I slightly increase the number of neurons in hidden layers. This technique helps avoid models simply memorizing training data.</p>

<h3 id="leanpub-auto-feed-forward-example">Feed Forward Example</h3>

<p>The following screen shot shows an IntelliJ project (you can use the free community or professional version for the examples in this book) for the example in this chapter:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/intellij_dl.png" alt="IntelliJ project view for the examples in this chapter" style="width: 100%">
    <figcaption>IntelliJ project view for the examples in this chapter</figcaption>
  </figure>
</div>


<p>The Deeplearning4j library can use user-written Java classes to import training and testing data into a form that the Deeplearning4j library can use. Some of the examples at <a href="https://github.com/eclipse/deeplearning4j-examples">https://github.com/eclipse/deeplearning4j-examples</a> use custom data loaders but in this simple example we use built-in utilities for reading spreadsheet data (see lines 46-56 in the following listing).</p>

<p>The class <strong>ClassifierWisconsinData</strong> reads the University of Wisconsin cancer training and testing data sets, creates a model (lines 59-81), trains it (line 82) and tests it (lines 84-97). The value of the variable <strong>numHidden</strong> set in line 3 refers to the number of neurons in each hidden layer.</p>

<p>You can increase the number of hidden units in line 36 (something that you might do for more complex problems). To add a hidden layer you can repeat lines 66-71, and you would change the layer indices (first argument) as appropriate in calls to the chained method <strong>.layer()</strong> so the layer indices are all different and increasing in value.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.deeplearning</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">org.datavec.api.records.reader.RecordReader</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">org.datavec.api.records.reader.impl.csv.CSVRecordReader</code><code class="p">;</code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">org.datavec.api.split.FileSplit</code><code class="p">;</code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.datasets.datavec.RecordReaderDataSetIterator</code><code class="p">;</code>
<code class="linenos"> 7 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.eval.Evaluation</code><code class="p">;</code>
<code class="linenos"> 8 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.nn.conf.MultiLayerConfiguration</code><code class="p">;</code>
<code class="linenos"> 9 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.nn.conf.NeuralNetConfiguration</code><code class="p">;</code>
<code class="linenos">10 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.nn.conf.layers.DenseLayer</code><code class="p">;</code>
<code class="linenos">11 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.nn.conf.layers.OutputLayer</code><code class="p">;</code>
<code class="linenos">12 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.nn.multilayer.MultiLayerNetwork</code><code class="p">;</code>
<code class="linenos">13 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.nn.weights.WeightInit</code><code class="p">;</code>
<code class="linenos">14 </code><code class="kn">import</code> <code class="nn">org.deeplearning4j.optimize.listeners.ScoreIterationListener</code><code class="p">;</code>
<code class="linenos">15 </code><code class="kn">import</code> <code class="nn">org.nd4j.linalg.activations.Activation</code><code class="p">;</code>
<code class="linenos">16 </code><code class="kn">import</code> <code class="nn">org.nd4j.linalg.api.ndarray.INDArray</code><code class="p">;</code>
<code class="linenos">17 </code><code class="kn">import</code> <code class="nn">org.nd4j.linalg.dataset.DataSet</code><code class="p">;</code>
<code class="linenos">18 </code><code class="kn">import</code> <code class="nn">org.nd4j.linalg.dataset.api.iterator.DataSetIterator</code><code class="p">;</code>
<code class="linenos">19 </code><code class="kn">import</code> <code class="nn">org.nd4j.linalg.learning.config.Sgd</code><code class="p">;</code>
<code class="linenos">20 </code><code class="kn">import</code> <code class="nn">org.nd4j.linalg.lossfunctions.LossFunctions</code><code class="p">;</code>
<code class="linenos">21 </code><code class="kn">import</code> <code class="nn">org.slf4j.Logger</code><code class="p">;</code>
<code class="linenos">22 </code><code class="kn">import</code> <code class="nn">org.slf4j.LoggerFactory</code><code class="p">;</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="kn">import</code> <code class="nn">java.io.*</code><code class="p">;</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="cm">/**</code>
<code class="linenos">27 </code><code class="cm"> * Train a feed forward classifier network on the University of Wisconsin Cancer Dat\</code>
<code class="linenos">28 </code><code class="cm">a Set.</code>
<code class="linenos">29 </code><code class="cm"> */</code>
<code class="linenos">30 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ClassifierWisconsinData</code> <code class="p">{</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code>  <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">Logger</code> <code class="n">log</code> <code class="o">=</code> 
<code class="linenos">33 </code>     <code class="n">LoggerFactory</code><code class="p">.</code><code class="na">getLogger</code><code class="p">(</code><code class="n">ClassifierWisconsinData</code><code class="p">.</code><code class="na">class</code><code class="p">);</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos">36 </code>    <code class="kt">int</code> <code class="n">numHidden</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code>
<code class="linenos">37 </code>    <code class="kt">int</code> <code class="n">numOutputs</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="linenos">38 </code>    <code class="kt">int</code> <code class="n">batchSize</code> <code class="o">=</code> <code class="mi">64</code><code class="p">;</code>
<code class="linenos">39 </code>
<code class="linenos">40 </code>    <code class="kt">int</code> <code class="n">seed</code> <code class="o">=</code> <code class="mi">33117</code><code class="p">;</code>
<code class="linenos">41 </code>
<code class="linenos">42 </code>    <code class="kt">int</code> <code class="n">numInputs</code> <code class="o">=</code> <code class="mi">9</code><code class="p">;</code>
<code class="linenos">43 </code>    <code class="kt">int</code> <code class="n">labelIndex</code> <code class="o">=</code> <code class="mi">9</code><code class="p">;</code>
<code class="linenos">44 </code>    <code class="kt">int</code> <code class="n">numClasses</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>
<code class="linenos">45 </code>
<code class="linenos">46 </code>    <code class="n">RecordReader</code> <code class="n">recordReader</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CSVRecordReader</code><code class="p">();</code>
<code class="linenos">47 </code>    <code class="n">recordReader</code><code class="p">.</code><code class="na">initialize</code><code class="p">(</code><code class="k">new</code> <code class="n">FileSplit</code><code class="p">(</code><code class="k">new</code> <code class="n">File</code><code class="p">(</code><code class="s">"data/"</code><code class="p">,</code><code class="s">"training.csv"</code><code class="p">)));</code>
<code class="linenos">48 </code>    
<code class="linenos">49 </code>    <code class="n">DataSetIterator</code> <code class="n">trainIter</code> <code class="o">=</code>
<code class="linenos">50 </code>      <code class="k">new</code> <code class="n">RecordReaderDataSetIterator</code><code class="p">(</code><code class="n">recordReader</code><code class="p">,</code><code class="n">batchSize</code><code class="p">,</code><code class="n">labelIndex</code><code class="p">,</code><code class="n">numClasses</code><code class="p">);</code>
<code class="linenos">51 </code>
<code class="linenos">52 </code>    <code class="n">RecordReader</code> <code class="n">recordReaderTest</code> <code class="o">=</code> <code class="k">new</code> <code class="n">CSVRecordReader</code><code class="p">();</code>
<code class="linenos">53 </code>    <code class="n">recordReaderTest</code><code class="p">.</code><code class="na">initialize</code><code class="p">(</code>
<code class="linenos">54 </code>        <code class="k">new</code> <code class="n">FileSplit</code><code class="p">(</code><code class="k">new</code> <code class="n">File</code><code class="p">(</code><code class="s">"data/"</code><code class="p">,</code><code class="s">"testing.csv"</code><code class="p">)));</code>
<code class="linenos">55 </code>    <code class="n">DataSetIterator</code> <code class="n">testIter</code> <code class="o">=</code>
<code class="linenos">56 </code>        <code class="k">new</code> <code class="n">RecordReaderDataSetIterator</code><code class="p">(</code><code class="n">recordReaderTest</code><code class="p">,</code><code class="n">batchSize</code><code class="p">,</code>
<code class="linenos">57 </code>                                    <code class="n">labelIndex</code><code class="p">,</code><code class="n">numClasses</code><code class="p">);</code>
<code class="linenos">58 </code>
<code class="linenos">59 </code>    <code class="n">MultiLayerConfiguration</code> <code class="n">conf</code> <code class="o">=</code> <code class="k">new</code> <code class="n">NeuralNetConfiguration</code><code class="p">.</code><code class="na">Builder</code><code class="p">()</code>
<code class="linenos">60 </code>        <code class="p">.</code><code class="na">seed</code><code class="p">(</code><code class="n">seed</code><code class="p">)</code> <code class="c1">//use the same random seed</code>
<code class="linenos">61 </code>        <code class="p">.</code><code class="na">activation</code><code class="p">(</code><code class="n">Activation</code><code class="p">.</code><code class="na">TANH</code><code class="p">)</code>
<code class="linenos">62 </code>        <code class="p">.</code><code class="na">weightInit</code><code class="p">(</code><code class="n">WeightInit</code><code class="p">.</code><code class="na">XAVIER</code><code class="p">)</code>
<code class="linenos">63 </code>        <code class="p">.</code><code class="na">updater</code><code class="p">(</code><code class="k">new</code> <code class="n">Sgd</code><code class="p">(</code><code class="mf">0.1</code><code class="p">))</code>
<code class="linenos">64 </code>        <code class="p">.</code><code class="na">l2</code><code class="p">(</code><code class="mf">1e-4</code><code class="p">)</code>
<code class="linenos">65 </code>        <code class="p">.</code><code class="na">list</code><code class="p">()</code>
<code class="linenos">66 </code>        <code class="p">.</code><code class="na">layer</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code>
<code class="linenos">67 </code>            <code class="k">new</code> <code class="n">DenseLayer</code><code class="p">.</code><code class="na">Builder</code><code class="p">()</code>
<code class="linenos">68 </code>                <code class="p">.</code><code class="na">nIn</code><code class="p">(</code><code class="n">numInputs</code><code class="p">)</code>
<code class="linenos">69 </code>                <code class="p">.</code><code class="na">nOut</code><code class="p">(</code><code class="n">numHidden</code><code class="p">)</code>
<code class="linenos">70 </code>                <code class="p">.</code><code class="na">build</code><code class="p">()</code>
<code class="linenos">71 </code>        <code class="p">)</code>
<code class="linenos">72 </code>        <code class="p">.</code><code class="na">layer</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="k">new</code> <code class="n">OutputLayer</code><code class="p">.</code><code class="na">Builder</code><code class="p">(</code><code class="n">LossFunctions</code><code class="p">.</code><code class="na">LossFunction</code><code class="p">.</code><code class="na">MCXENT</code><code class="p">)</code>
<code class="linenos">73 </code>            <code class="p">.</code><code class="na">nIn</code><code class="p">(</code><code class="n">numHidden</code><code class="p">)</code>
<code class="linenos">74 </code>            <code class="p">.</code><code class="na">nOut</code><code class="p">(</code><code class="n">numClasses</code><code class="p">)</code>
<code class="linenos">75 </code>            <code class="p">.</code><code class="na">activation</code><code class="p">(</code><code class="n">Activation</code><code class="p">.</code><code class="na">SOFTMAX</code><code class="p">)</code>
<code class="linenos">76 </code>            <code class="p">.</code><code class="na">build</code><code class="p">()</code>
<code class="linenos">77 </code>        <code class="p">)</code>
<code class="linenos">78 </code>        <code class="p">.</code><code class="na">build</code><code class="p">();</code>
<code class="linenos">79 </code>    <code class="n">MultiLayerNetwork</code> <code class="n">model</code> <code class="o">=</code> <code class="k">new</code> <code class="n">MultiLayerNetwork</code><code class="p">(</code><code class="n">conf</code><code class="p">);</code>
<code class="linenos">80 </code>    <code class="n">model</code><code class="p">.</code><code class="na">init</code><code class="p">();</code>
<code class="linenos">81 </code>    <code class="n">model</code><code class="p">.</code><code class="na">setListeners</code><code class="p">(</code><code class="k">new</code> <code class="n">ScoreIterationListener</code><code class="p">(</code><code class="mi">100</code><code class="p">));</code>
<code class="linenos">82 </code>    <code class="n">model</code><code class="p">.</code><code class="na">fit</code><code class="p">(</code> <code class="n">trainIter</code><code class="p">,</code> <code class="mi">10</code> <code class="p">);</code>
<code class="linenos">83 </code>
<code class="linenos">84 </code>    <code class="n">Evaluation</code> <code class="n">eval</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Evaluation</code><code class="p">(</code><code class="n">numOutputs</code><code class="p">);</code>
<code class="linenos">85 </code>    <code class="k">while</code> <code class="p">(</code><code class="n">testIter</code><code class="p">.</code><code class="na">hasNext</code><code class="p">())</code> <code class="p">{</code>
<code class="linenos">86 </code>      <code class="n">DataSet</code> <code class="n">ds</code> <code class="o">=</code> <code class="n">testIter</code><code class="p">.</code><code class="na">next</code><code class="p">();</code>
<code class="linenos">87 </code>      <code class="n">INDArray</code> <code class="n">features</code> <code class="o">=</code> <code class="n">ds</code><code class="p">.</code><code class="na">getFeatures</code><code class="p">();</code>
<code class="linenos">88 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Input features: "</code> <code class="o">+</code> <code class="n">features</code><code class="p">);</code>
<code class="linenos">89 </code>      <code class="n">INDArray</code> <code class="n">labels</code> <code class="o">=</code> <code class="n">ds</code><code class="p">.</code><code class="na">getLabels</code><code class="p">();</code>
<code class="linenos">90 </code>      <code class="n">INDArray</code> <code class="n">predicted</code> <code class="o">=</code> <code class="n">model</code><code class="p">.</code><code class="na">output</code><code class="p">(</code><code class="n">features</code><code class="p">,</code><code class="kc">false</code><code class="p">);</code>
<code class="linenos">91 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Predicted output: "</code><code class="o">+</code> <code class="n">predicted</code><code class="p">);</code>
<code class="linenos">92 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Desired output: "</code><code class="o">+</code> <code class="n">labels</code><code class="p">);</code>
<code class="linenos">93 </code>      <code class="n">eval</code><code class="p">.</code><code class="na">eval</code><code class="p">(</code><code class="n">labels</code><code class="p">,</code> <code class="n">predicted</code><code class="p">);</code>
<code class="linenos">94 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">();</code>
<code class="linenos">95 </code>    <code class="p">}</code>
<code class="linenos">96 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Evaluate model...."</code><code class="p">);</code>
<code class="linenos">97 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">eval</code><code class="p">.</code><code class="na">stats</code><code class="p">());</code>
<code class="linenos">98 </code>  <code class="p">}</code>
<code class="linenos">99 </code><code class="p">}</code>
</pre></div>

</figure>

<p>It is very important to not use training data for testing because performance on recognizing training data should always be good assuming that you have enough memory capacity in a network (i.e., enough hidden units and enough neurons in each hidden layer).</p>

<p>The program output is (much output removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Input features: [[6.0000, 10.0000, 10.0000, 2.0000,    8.0000, 10.0000, 7.0000, 3.00\
00, 3.0000], 
  ...
  ]]
Predicted output: [ 
 [0.1611, 0.8389],
   ...
   ]]
Desired output: [ 
 [0, 1.0000],
 ...
 ]

========================Evaluation Metrics========================
 # of classes:    2
 Accuracy:        0.8846
 Precision:       0.9000
 Recall:          0.8929
 F1 Score:        0.8800
Precision, recall &amp; F1: macro-averaged (equally weighted avg. of 2 classes)

=========================Confusion Matrix=========================
  0  1
-------
 12  0 | 0 = 0
  3 11 | 1 = 1

Confusion matrix format: Actual (rowClass) predicted as (columnClass) N times
==================================================================
</pre></div>

</figure>

<p>The F1 score is calculated as twice precision times recall, divided by precision + recall. We would like F1 to be as close to 1.0 as possible and it is common to spend a fair amount of time experimenting with meta learning parameters to increase F1.</p>

<p>It is also fairly common to try to learn good values of meta learning parameters also. We won’t do this here but the process involves splitting the data into three disjoint sets: training, validation, and testing. The meta parameters are varied, training is performed, and using the validation data the best set of meta parameters is selected. Finally, we test the network as defined by meta parameters and learned weights for those meta parameters with the separate test data to see what the effective F1 score is.</p>

<h3 id="leanpub-auto-configuring-the-example-using-maven">Configuring the Example Using Maven</h3>

<p>There is a Maven pom.xml configuration file for this example that is configured for a recent version of DL4J (as I write this in July 2020). DL4J is fairly good at detecting if the Open BLAS library is available, if CUDA software support for any GPUs on your system are available, etc. If you try running the <em>Makefile</em> and get any errors, then check the <a href="https://deeplearning4j.konduit.ai/getting-started/quickstart">DL4J Quickstart and setup guide</a> to see if there are any dependencies that you need on your system. The <em>Makefile</em> has a single target:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">deep_wisconsin</code><code class="o">:</code>
  <code class="n">mvn</code> <code class="n">install</code>
  <code class="n">mvn</code> <code class="n">exec</code><code class="o">:</code><code class="n">java</code> <code class="o">\</code>
    <code class="o">-</code><code class="n">Dexec</code><code class="o">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s2">"com.markwatson.deeplearning.ClassifierWisconsinData"</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-documentation-for-other-types-of-deep-learning-layers">Documentation for Other Types of Deep Learning Layers</h3>

<p>The <a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/package-tree.html">documentation for the built-in layer classes in DL4J</a> is probably more than you need for now so let’s review the most other types of layers that I sometimes use. In the simple example we used in the last section we used two types of layers:</p>

<ul>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/DenseLayer.html">org.deeplearning4j.nn.conf.layers.DenseLayer</a> - maintains connections to all neurons in the previous and next layer, or it is “fully connected.”</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/OutputLayer.html">org.deeplearning4j.nn.conf.layers.OutputLayer</a> - has built-in behavior for starting the back propagation calculations back through previous layers.</li>
</ul>

<p>As you build more deep learning enabled applications, depending on what requirements you have, you will likely need to use at least some of the following Dl4J layer classes:</p>

<ul>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/AutoEncoder.html">org.deeplearning4j.nn.conf.layers.AutoEncoder</a> - often used to remove noise from data. Autoencoders work by making the target training output values equal to the input training values while reducing the number of neurons in the AutoEncoding layer. The layer learns a concise representation of data, or “generalizes” data by learning in which features are important.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/CapsuleLayer.html">org.deeplearning4j.nn.conf.layers.CapsuleLayer</a> - Capsule networks are an attempt to be more efficient versions of convolutional models. Convolutional networks discard position information of detected features while capsule models maintain and use this information.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Convolution1DLayer.html">org.deeplearning4j.nn.conf.layers.Convolution1D</a> - one dimensional convolutional layers learn one dimensional feature detectors. Trained layers learn to recognize features but discard the information of where the feature is located. These are often used for data input streams like signal data and word tokens in natural language processing.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Convolution2D.html">org.deeplearning4j.nn.conf.layers.Convolution2D</a> - two dimensional convolutional layers learn two dimensional feature detectors. Trained layers learn to recognize features but discard the information of where the feature is located. These are often used for recognizing if a type of object appears inside a picture. Note that features, for example representing a nose or a mouth, are recognized but their location in an input picture does not matter. For example, you could cut up an image of someone’s face, moving the ears to the picture center, the mouth to the upper left corner, etc., and the picture would still be predicted to contain a face with some probability because using soft max output layers produces class labels that can be interpreted as probabilities since the values over all output classes sum to the value 1.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/EmbeddingLayer.html">org.deeplearning4j.nn.conf.layers.EmbeddingLayer</a> - embedding layers are used to transform input data into integer data. My most frequent use of embedding layers is word embedding where each word in training data is assigned an integer value. This data can be “one hot encoded” and in the case of processing words, if there are 5000 unique words in the training data for a classifier, then the embedding layer would have 5001 neurons, one for each word and one to represent all words not in the training data. If the word index (indexing is zero-based) is, for example 117, then the activation value for neuron at index 117 is set to one and all others in the layer are set to zero.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/FeedForwardLayer.html">org.deeplearning4j.nn.conf.layers.FeedForwardLayer</a> - this is a super class for most specialized types of feed forward layers so reading through the class reference is recommended.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/DropoutLayer.html">org.deeplearning4j.nn.conf.layers.DropoutLayer</a> - dropout layers are very useful for preventing learning new input patterns from making the network forget previously learned patterns. For each training batch, some fraction of neurons in a dropout layer are turned off and don’t update their weights during a training batch cycle. The development of using dropout was key historically for getting deep learning networks to work with many layers and large amounts of training data.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/LSTM.html">org.deeplearning4j.nn.conf.layers.LSTM</a> - LSTM layers are used to extend the temporal memory of what a layer can remember. LSTM are a refinement of RNN models that use an input window to pass through a data stream and the RNN model can only use what is inside this temporal sampling window.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Pooling1D.html">org.deeplearning4j.nn.conf.layers.Pooling1D</a> - a one dimensional pooling layer transforms a longer input to a shorter output by downsampling, i.e., there are fewer output connections than input connections.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Pooling2D.html">org.deeplearning4j.nn.conf.layers.Pooling2D</a> - a two dimensional pooling layer transforms a larger two dimensional array of data input to a smaller output two dimensional array by downsampling.</li>
</ul>

<h3 id="leanpub-auto-running-the-dl4j-example-programs-and-modifying-them-for-your-use">Running the DL4J Example Programs and Modifying Them For Your Use</h3>

<p>To get started clone the DL4J examples repository written by the authors of DL4J (if you have not already done so) and fetch all of the required libraries:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>git clone https://github.com/eclipse/deeplearning4j-examples
<code class="nb">cd</code> deeplearning4j-examples/dl4j-examples
mvn install
</pre></div>

</figure>

<p>In the next section we will modify <a href="https://github.com/AlexDBlack">Alex Black’s</a> character generating LSTM example for a different application (modeling and generating CSV data). Before moving on to the example in the next section you may want to run his example using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">cd</code> deeplearning4j-examples/dl4j-examples
mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"org.deeplearning4j.examples.advanced.modelling.charm\</code>
<code class="s2">odelling.generatetext.GenerateTxtModel"</code>
</pre></div>

</figure>

<p>His example downloads the complete works of Shakespeare from the web and trains a recurrent network LSTM model by passing an input window through the complete text. Each input character is one-hot encoded and the target output is the same one-hot encoded text data in the input window except the sample is shifted one character further in the input text. The model learns to predict the next character in a sequence given a sample of input seed text.</p>

<p>Let’s review one-hot encoding. We need to convert each character in the training data to a one-hot encoding which is a vector of all 0.0 values except for a single value of 1.0. If there are, for example,  256 unique characters in the training data the vector will have 256+1 elements because we add an “unknown character” that represents characters the model may see in the future that are not in the training data. For example if the index of character “m” is 77, then we set element at index 77 to one, all other elements being zero. We won’t look at the implementation of one-hot encoding here because DL4J provides APIs for this. I cover one-hot-encoding implementation in another book in the chapter on <a href="https://leanpub.com/hy-lisp-python/read#leanpub-auto-deep-learning">Deep Learning for the Hy Language</a> that you can read online.</p>

<p>Here we will be using one-hot encoding for characters but it also works well for encoding words in a vocabulary. Training data may typically have about 10,000 unique words so the one-hot encoding vector would have 10,001 elements. We add a special word position for “unknown word.” For some applications we also use word-embeddings using a smaller vector, 500 elements being a reasonable size. We won’t be using word-embeddings here, or one-hot word embedding but I want you to know what these terms mean.</p>

<p>By processing sufficient sample text, an LSTM network can learn to model the “language” of the input text. If you train on samples from Shakespeare then the model generates text that looks like Shakespeare wrote it. This also works for any author with a specific writing style. LSTM networks are used to model programming languages and many types of structured information.</p>

<p>For a customer, I used an LSTM model trained on JSON log data from AWS. They wanted to have a large amount of test data that did not contain any sensitive information so we generated “fake data” in the correct schema. The LSTM model worked fairly well, the major restriction being that I checked each generated JSON datum for having valid syntax and be valid to the Schema of the original data, discarding samples that failed these tests.</p>

<p>The examples provided with DL4J cover most of the deep learning use cases you may require for your work so I want you to be comfortable running all of the examples and knowing where to start if you want to modify them for a different purposes. If you load the entire DL4J examples repository in a Java IDE and use global search then you should be able to find appropriate CNN, Classification, Regression, etc., examples similar to your current use case that you can modify.</p>

<p>As an experiment, I wanted to try using an LSTM character generation model to generate CSV style spreadsheet data and you can see the implementation of this idea in next section where I modified Alex Black’s character generating LSTM example.</p>

<h3 id="leanpub-auto-modifying-the-character-generating-lstm-example-to-model-and-generate-csv-spreadsheet-data">Modifying the Character Generating LSTM Example to Model and Generate CSV Spreadsheet Data</h3>

<p>Here are the major changes the I made to the <strong>GenerateTxtModel</strong> example written by Alex Black. I start by preparing the text training data where I substitute the original method that uses the complete works of William Shakespeare in the class <strong>getShakespeareIterator</strong> with a new class <strong>getWisconsinDataIterator</strong> that processes the CSV file in <strong>data/training.csv</strong> in class <strong>LstmCharGenerator</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">static</code> <code class="n">CharacterIterator</code> <code class="nf">getWisconsinDataIterator</code><code class="p">(</code><code class="kt">int</code> <code class="n">miniBatchSize</code><code class="p">,</code>
                           <code class="kt">int</code> <code class="n">sequenceLength</code><code class="p">)</code>
                 <code class="kd">throws</code> <code class="n">IOException</code> <code class="p">{</code>
    <code class="n">String</code> <code class="n">fileLocation</code> <code class="o">=</code> <code class="s">"data/training.csv"</code><code class="p">;</code>
    <code class="kt">char</code><code class="o">[]</code> <code class="n">validCharacters</code> <code class="o">=</code> <code class="p">{</code><code class="sc">'0'</code><code class="p">,</code> <code class="sc">'1'</code><code class="p">,</code> <code class="sc">'2'</code><code class="p">,</code> <code class="sc">'3'</code><code class="p">,</code> <code class="sc">'4'</code><code class="p">,</code> <code class="sc">'5'</code><code class="p">,</code> <code class="sc">'6'</code><code class="p">,</code> <code class="sc">'7'</code><code class="p">,</code> <code class="sc">'8'</code><code class="p">,</code>
                              <code class="sc">'9'</code><code class="p">,</code> <code class="sc">','</code><code class="p">,</code> <code class="sc">'\n'</code><code class="p">};</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"++ valid characters in training data: "</code><code class="p">);</code>
    <code class="k">for</code> <code class="p">(</code><code class="kt">char</code> <code class="n">ch</code> <code class="p">:</code> <code class="n">validCharacters</code><code class="p">)</code> <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">" "</code> <code class="o">+</code> <code class="n">ch</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">();</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">CharacterIterator</code><code class="p">(</code><code class="n">fileLocation</code><code class="p">,</code> <code class="n">StandardCharsets</code><code class="p">.</code><code class="na">UTF_8</code><code class="p">,</code>
        <code class="n">miniBatchSize</code><code class="p">,</code> <code class="n">sequenceLength</code><code class="p">,</code> <code class="n">validCharacters</code><code class="p">,</code> <code class="k">new</code> <code class="n">Random</code><code class="p">(</code><code class="mi">12345</code><code class="p">));</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>Changes for configuring the model:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kt">int</code> <code class="n">lstmLayerSize</code> <code class="o">=</code> <code class="mi">400</code><code class="p">;</code> <code class="c1">//Number of units in each LSTM layer</code>
    <code class="kt">int</code> <code class="n">miniBatchSize</code> <code class="o">=</code> <code class="mi">16</code><code class="p">;</code> <code class="c1">//Size of mini batch to use when  training</code>
    <code class="kt">int</code> <code class="n">exampleLength</code> <code class="o">=</code> <code class="mi">250</code><code class="p">;;</code> <code class="c1">//Length of each training example sequence to use.</code>
    <code class="kt">int</code> <code class="n">tbpttLength</code> <code class="o">=</code> <code class="mi">40</code><code class="p">;</code> <code class="c1">//Length for truncated backpropagation through time</code>
    <code class="kt">int</code> <code class="n">numEpochs</code> <code class="o">=</code> <code class="mi">100</code><code class="p">;</code> <code class="c1">//Total number of training epochs</code>
    <code class="kt">int</code> <code class="n">generateSamplesEveryNMinibatches</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="c1">//How frequently to generate samples</code>
    <code class="kt">int</code> <code class="n">nSamplesToGenerate</code> <code class="o">=</code> <code class="mi">20</code><code class="p">;</code> <code class="c1">//Number of samples to generate each training epoch</code>
    <code class="kt">int</code> <code class="n">nCharactersToSample</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code> <code class="c1">//Length of each sample to generate</code>
</pre></div>

</figure>

<p>I made a third change to Alex Black’s example: I discarded generated samples that didn’t match the schema of the original data in the method <strong>sampleCharactersFromNetwork</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>          <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"----- Samples -----"</code><code class="p">);</code>
          <code class="k">for</code><code class="p">(</code> <code class="kt">int</code> <code class="n">j</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">j</code><code class="o">&lt;</code><code class="n">samples</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code> <code class="p">)</code> <code class="p">{</code>
            <code class="c1">// discard samples that don't contain 10 numbers per line</code>
            <code class="n">String</code> <code class="o">[]</code> <code class="n">lines</code> <code class="o">=</code> <code class="n">samples</code><code class="o">[</code><code class="n">j</code><code class="o">]</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">k</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">k</code><code class="o">&lt;</code><code class="n">lines</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">k</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">StringUtils</code><code class="p">.</code><code class="na">countMatches</code><code class="p">(</code><code class="n">lines</code><code class="o">[</code><code class="n">k</code><code class="o">]</code><code class="p">,</code> <code class="s">","</code><code class="p">)</code> <code class="o">==</code> <code class="mi">9</code> <code class="o">&amp;&amp;</code>
                  <code class="n">lines</code><code class="o">[</code><code class="n">k</code><code class="o">]</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">","</code><code class="p">).</code><code class="na">length</code> <code class="o">==</code> <code class="mi">10</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">lines</code><code class="o">[</code><code class="n">k</code><code class="o">]</code><code class="p">);</code>
              <code class="p">}</code>
            <code class="p">}</code>
          <code class="p">}</code>
</pre></div>

</figure>

<p>We will look at three samples taken about two minutes into the training process, after ten minutes, and finally after twenty minutes. You might want to look at the training file <strong>data/training.csv</strong> to understand what we are trying to model and then generate similar data.</p>

<p>Here is sample output after training the model for about two minutes (most lines are not properly formatted or valid):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="mf">0</code><code class="p">,</code><code class="mf">4</code><code class="p">,</code><code class="mf">000</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">5</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">5</code><code class="p">,</code><code class="mf">8</code><code class="p">,</code><code class="mf">0</code>
<code class="p">,,,,</code><code class="mf">61</code><code class="p">,,,,,</code><code class="mf">8</code>
<code class="p">,,,</code><code class="mf">6014</code><code class="p">,</code><code class="mf">0</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">1</code><code class="p">,</code><code class="mf">4</code><code class="p">,,</code><code class="mf">3</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">5</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">1</code><code class="p">,,</code><code class="mf">7</code><code class="p">,,,,</code><code class="mf">60</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code><code class="p">,</code><code class="mf">7</code>
<code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">6</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">6</code>
<code class="mf">0</code><code class="p">,</code><code class="mf">5</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,,</code><code class="mf">000000</code><code class="p">,</code><code class="mf">8</code>
<code class="mf">8</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">5</code><code class="p">,</code><code class="mf">1</code><code class="p">,,</code><code class="mf">8</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">6</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">8</code><code class="p">,</code><code class="mf">0</code><code class="p">,</code><code class="mf">2</code>
</pre></div>

</figure>

<p>The next sample shows output after training the model for a ten minutes. There are errors in lines 1 and 4. Line 1 has a value of “16” in the row that is outside the allowed data range. Line 4 has the value “13” that is also outside the allowed data range.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">16</code><code class="p">,</code><code class="mf">7</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code>
<code class="linenos">2 </code><code class="mf">6</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="linenos">3 </code><code class="mf">6</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="linenos">4 </code><code class="mf">13</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">4</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">7</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code>
<code class="linenos">5 </code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="linenos">6 </code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
</pre></div>

</figure>

<p>Final model after training for twenty minutes:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">5</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">8</code><code class="p">,</code><code class="mf">8</code><code class="p">,</code><code class="mf">6</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">7</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code>
<code class="mf">5</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">4</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">0</code>
<code class="mf">4</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">3</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">1</code><code class="p">,</code><code class="mf">10</code><code class="p">,</code><code class="mf">2</code><code class="p">,</code><code class="mf">1</code>
</pre></div>

</figure>

<p>This example should convince you, dear reader, that the language modeling capabilities of LSTM models is surprising and effective. </p>

<p>You can modify this example to try modeling other types of test. You might try modeling a large sample of Python or Java source code, or text in any language you might know like German, Farsi, Hebrew, or Spanish. For languages like Farsi and Hebrew that read from right to left you would need to either use a Bidirectional LSTM or change the program to stream input “backwards” for each line so a standard LSTM could correctly predict characters in the order that a human reader processes.</p>

<p>There are interesting papers on using LSTM models to analyze design specifications that feeds into convolutional layers that generate images for design documents. Is this process perfect? No, but still impressive and provides some intuition into what may be possible in the future.</p>

<h3 id="zoo">Roadmap for the DL4J Model Zoo</h3>

<p>DL4J supports a Model Zoo containing the following pre-trained models your own projects (<a href="https://deeplearning4j.konduit.ai/model-zoo/zoo-models">see documentation</a>):</p>

<ul>
  <li>AlexNet - was a breakthrough for image recognition, AlexNet is a convolutional neural network designed by Alex Krizhevsky (with Ilya Sutskever and Geoffrey Hinton). AlexNet used Relu instead of arc-tangent or Sigmoid activation.</li>
  <li>Darknet19 - is a type of realtime YOLO model.</li>
  <li>FaceNetNN4Small2 - is a small version of the FaceNet embeddings for face recognition.</li>
  <li>InceptionResNetV1 - Inception models use many convolutional layers. </li>
  <li>LeNet - of historical interest, a convolutional model design by Yann LeCun and his colleagues (1998).</li>
  <li>NASNet - like Inception and Xception models, with claimed superior results.</li>
  <li>ResNet50 - residual neural network that uses “skip connections” that connect neurons in non-adjacent layers which helps reduce the vanishing gradient problem for models with many layers. Skipped layers are connected later in the training process (example class <strong>AlphaGoZeroTrainer</strong>).</li>
  <li>SimpleCNN - simple architecture using alternating pooling and convolutional layers.</li>
  <li>SqueezeNet - architecture for computer vision that experiments with smaller neural networks with fewer parameters.</li>
  <li>TextGenerationLSTM - a general model architecture for using LSTM layers for building language models from input text and then generating new similar text.</li>
  <li>TinyYOLO - a small YOLO model (example class *TinyYoloHouseNumberDetection** demonstrates Transfer Learning).</li>
  <li>UNet - convolutional model designed to perform medical image segmentation.</li>
  <li>VGG16 - convolutional model for classification and detection using convolutional (with ReLu), max pooling, and fully connected layers (example class <strong>FitFromFeaturized</strong> demonstrates Transfer Learning).</li>
  <li>VGG19 - a larger variant of VGG16 that uses (16 convolution layers, 3 fully connected layers, 5 max pooling layers and 1 SoftMax layer.</li>
  <li>Xception - a newer version of Inception V3 with slightly better performance but long training times.</li>
  <li>YOLO2 - “you only look once” real time object detection.</li>
</ul>

<p>If you are interested in fine tuning existing models (Transfer Learning) then I suggest that you start with the example class <strong>FitFromFeaturized</strong>. You can look at the code using your favorite editor and run this example using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ <code class="nb">cd</code> deeplearning4j-examples/dl4j-examples

$ emacs src/main/java/org/deeplearning4j/examples/advanced/features/transferlearning<code class="se">\</code>
/editlastlayer/presave/FitFromFeaturized.java

$ mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"org.deeplearning4j.examples.advanced.features.tran\</code>
<code class="s2">sferlearning.editlastlayer.presave.FitFromFeaturized"</code>
</pre></div>

</figure>

<p>This is a good example to get started with because it is short (about 90 lines of code) and shows clearly how to take a saved model and build a configuration to add your own output layer and then perform additional training using your own data.</p>

<h3 id="leanpub-auto-deep-learning-wrapup">Deep Learning Wrapup</h3>

<p>I first used complex neural network topologies in the late 1980s for phoneme (speech) recognition, specifically using time delay neural networks and I gave a talk about it at <a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp?reload=true&amp;arnumber=4307059">IEEE First Annual International Conference on Neural Networks San Diego, California June 21-24, 1987</a>. In the following year I wrote the Backpropagation neural network code that my company used in a bomb detector that we built for the FAA. Back then, neural networks were not widely accepted but in the present time Google, Microsoft, and many other companies are using deep learning for a wide range of practical problems. Exciting work is also being done in the field of natural language processing. The examples in this chapter are simple so you can experiment with them easily. I wanted to introduce you to <a href="http://deeplearning4j.org/">Deeplearning4j</a> because I think it is probably the easiest way for Java developers to get started working with many layered neural networks and I refer you to <a href="http://deeplearning4j.org/documentation.html">the project documentation</a>.</p>

<p>I managed a deep learning team at Capital One (2018-2019) and while there much of my work involved GANs and LSTM deep models (and several of my 55 US patents were at least partially inspired by this work). I refer you to a good GAN DL4J example on the web <a href="https://github.com/wmeddie/dl4j-gans">https://github.com/wmeddie/dl4j-gans</a> and a tutorial on LSTM applications from the developers of DL4J <a href="https://deeplearning4j.konduit.ai/getting-started/tutorials/clinical-time-series-lstm">https://deeplearning4j.konduit.ai/getting-started/tutorials/clinical-time-series-lstm</a>.</p>

<p>Deep Learning has become a standard tool for modeling data and making predictions or classifying data. Most of the online classes on Deep Learning use Python. DL4J can import Keras/TensorFlow models so one strategy is for you to build models using Python and import trained models into DL4J.</p>


<h2 id="leanpub-auto-natural-language-processing">Natural Language Processing</h2>

<p>I have been working in the field of Natural Language Processing (NLP) since 1982. In this chapter we will use a few of my open source NLP project. In the next chapter I have selected the open source NLP project <a href="https://opennlp.apache.org/">OpenNLP</a> to provide more examples of using NLP to get you started using NLP in your own projects. For my current work I usually use a combination of my own library discussed in this chapter, OpenNLP (covered in the next chapter), and two deep learning NLP libraries for the Python language (<a href="https://spacy.io/">spaCy</a> and <a href="https://huggingface.co/">Hugging Face</a> pre-trained deep learning models). Wile I don’t cover these Python libraries in this book, I do have examples of using spaCy in my <a href="https://leanpub.com/hy-lisp-python/">Hy Language book</a>. Hy is a Lisp language that is implemented in Python. For difficult NLP problems like coreference resolution (or anaphora resolution) I use deep learning models like BERT.</p>

<p>Deep learning is apparently “eating” the AI world but I firmly believe that hybrid systems stand the best chance of getting us to real artificial general intelligence (AGI) - time will tell as more NLP, knowledge representation, reasoning, etc., tasks are implemented in hybrid systems. Many experts in AI believe that deep learning only takes us so far, and in order to reach general artificial intelligence we will use some form of hybrid deep learning, symbolic AI, and probabalistic systems. That said, there are deep learning specialists who predict their favored technology will probably be sufficient to get to AGI.</p>

<h3 id="leanpub-auto-overview-of-the-nlp--library-and-running-the-examples">Overview of the NLP  Library and Running the Examples</h3>

<p>We will cover a wide variety of techniques for processing text in this chapter. The part of speech tagger (POS), text categorization, and entity extraction examples are all derived from either my open source projects or my commercial projects that I developed in the 1990-2010 time frame.</p>

<p>The following UML class diagrams will give you an overview of my NLP library code:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/nlp-uml.png" alt="UML class diagram for top level NLP code" style="width: 100%">
    <figcaption>UML class diagram for top level NLP code</figcaption>
  </figure>
</div>


<p>The XML parsing code is for reading the file <strong>test_data/classification_tags.xml</strong> that contains ranked word terms for various categories we cover (e.g., politics, economy, etc.), often referred to as term frequency–inverse document frequency (<a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">tf-idf</a>).</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 50%">
    <img src="images/nlp-utils-uml.png" alt="UML class diagram for low-level utilities" style="width: 100%">
    <figcaption>UML class diagram for low-level utilities</figcaption>
  </figure>
</div>


<p>Each main class in this library has a <strong>main</strong> method that provides a short demonstration of using the class. The <em>Makefile</em> has targets for running the <strong>main</strong> method for each of the top level classes:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">names</code><code class="o">:</code>
<code class="linenos"> 2 </code>  <code class="n">mvn</code> <code class="n">install</code> <code class="o">-</code><code class="n">DskipTests</code>
<code class="linenos"> 3 </code>  <code class="n">mvn</code> <code class="n">exec</code><code class="o">:</code><code class="n">java</code> <code class="o">-</code><code class="n">Dexec</code><code class="o">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s2">"com.markwatson.nlp.ExtractNames"</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">autotagger</code><code class="o">:</code>
<code class="linenos"> 6 </code>  <code class="n">mvn</code> <code class="n">install</code> <code class="o">-</code><code class="n">DskipTests</code>
<code class="linenos"> 7 </code>  <code class="n">mvn</code> <code class="n">exec</code><code class="o">:</code><code class="n">java</code> <code class="o">-</code><code class="n">Dexec</code><code class="o">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s2">"com.markwatson.nlp.AutoTagger"</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="n">fasttag</code><code class="o">:</code>
<code class="linenos">10 </code>  <code class="n">mvn</code> <code class="n">install</code> <code class="o">-</code><code class="n">DskipTests</code>
<code class="linenos">11 </code>  <code class="n">mvn</code> <code class="n">exec</code><code class="o">:</code><code class="n">java</code> <code class="o">-</code><code class="n">Dexec</code><code class="o">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s2">"com.markwatson.nlp.FastTag"</code>
</pre></div>

</figure>

<p>You might find it useful to run the examples before we look at the code.</p>

<h3 id="tokenizing-and-tagging">Tokenizing, Stemming, and Part of Speech Tagging Text</h3>

<p>Tokenizing text is the process of splitting a string containing text into individual tokens. Stemming is the reduction of words to abbreviated word roots that allow for easy comparison for equality of similar words. Tagging is identifying what part of speech each word is in input text. Tagging is complicated by many words having different parts of speech depending on context (examples: “<em>bank</em> the airplane,” “the river <em>bank</em>,” etc.) You can find the code in this section in the
GitHub repository in the files <strong>src/com/markwatson/nlp/fasttag/FastTag.java</strong> and <strong>src/com/markwatson/nlp/util/Tokenizer.java</strong>. The required data files are in the directory <strong>test_data</strong> in the files <strong>lexicon.txt</strong> (for processing English text) and <strong>lexicon_medpost.txt</strong> (for processing medical text).</p>

<p>We will also look at a public domain word stemmer that I frequently use in this section.</p>

<p>Before we can process any text we need to break text into individual tokens. Tokens can be words, numbers and punctuation symbols. The class <strong>Tokenizer</strong> has two static methods, both take an input string to tokenize and return a list of token strings. The second method has an extra argument to specify the maximum number of tokens that you want returned:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>      <code class="kd">static</code> <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">wordsToList</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code>
<code class="linenos">2 </code>      <code class="kd">static</code> <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">wordsToList</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">,</code> <code class="kt">int</code> <code class="n">maxR</code><code class="p">)</code>
</pre></div>

</figure>

<p>In line 2, <strong>maxR</strong> is maximum number of tokens to return and is useful when you want to sample the first part of a very long text.</p>

<p>The following listing shows a fragment of example code using this class with the output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>       <code class="n">String</code> <code class="n">text</code> <code class="o">=</code>
         <code class="s">"The ball, rolling quickly, went down the hill."</code><code class="p">;</code>
       <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">tokens</code> <code class="o">=</code> <code class="n">Tokenizer</code><code class="p">.</code><code class="na">wordsToList</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
       <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
       <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="n">token</code> <code class="p">:</code> <code class="n">tokens</code><code class="p">)</code>
          <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"\""</code><code class="o">+</code><code class="n">token</code><code class="o">+</code><code class="s">"\" "</code><code class="p">);</code>
       <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">();</code>
</pre></div>

</figure>

<p>This code fragment produces the following output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    The ball, rolling quickly, went down the hill.
    "The" "ball" "," "rolling" "quickly" "," "went"
    "down" "the" "hill" "." 
</pre></div>

</figure>

<p>For many applications, it is better to “stem” word tokens to simplify comparison of similar words. For example “run,” “runs,” and “running” all stem to “run.” The stemmer that we will use, which I believe to be in the public domain, is in the file <strong>src/public_domain/Stemmer.java</strong>. There are two convenient APIs defined at the end of the class, one to stem a string of multiple words and one to stem a single word token:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        public List&lt;String&gt; stemString(String str)
        public String stemOneWord(String word)
</pre></div>

</figure>

<p>My FastTag part of speech (POS) tagger project resulted from my using in the early 1990s the excellent tagger written by Eric Brill while he was at the University of Pennsylvania. He used machine learning techniques to learn transition rules for tagging text using manually tagged text as training examples. In reading through his doctoral thesis I noticed that there were a few transition rules that covered most of the cases and I implemented a simple “fast tagger” in Common Lisp, Ruby, Scheme and Java. The Java version is in the file <strong>src/com/markwatson/nlp/fasttag/FastTag.java</strong>.</p>

<p>The file <strong>src/com/markwatson/nlp/fasttag/README.txt</strong> contains information on where to obtain Eric Brill’s original tagging system and also defines the tags for both his English language lexicon and the Medpost lexicon. The following table shows the most commonly used tags (see the README.txt file for a complete description).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>NN   singular noun          dog
NNS  plural noun            dogs
NNP  singular proper noun   California
CC   conjunction            and, but, or
DT   determiner             the, some
IN   preposition            of, in, by
JJ   adjective              large, small, green
PP   proper pronoun         I, he, you
RB   adverb                 slowly
RBR  comparative adverb     slowest
VB   verb                   eat
VBN  past participle verb   eaten
VBG  gerund verb            eating
WP   wh\* pronoun           who, what
WDT  wh\* determiner        which, that
</pre></div>

</figure>

<p>Brill’s system worked by processing manually tagged text and then creating a list of words followed by the tags found for each word. Here are a few random lines selected from the <strong>test_data/lexicon.txt</strong> file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    Arco NNP
    Arctic NNP JJ
    fair JJ NN RB
</pre></div>

</figure>

<p>Here “Arco” is a proper noun because it is the name of a corporation. The word “Arctic” can be either a proper noun or an adjective; it is used most frequently as a proper noun so the tag “NNP” is listed before “JJ.” The word “fair” can be an adjective, singular noun, or an adverb.</p>

<p>The class <strong>Tagger</strong> reads the file lexicon either as a resource stream (if, for example, you put <strong>lexicon.txt **in the same JAR file as the compiled **Tagger</strong> and <strong>Tokenizer</strong> class files) or as a local file. Each line in the <strong>lexicon.txt</strong> file is passed through the utility method <strong>parseLine</strong> that processes an input string using the first token in the line as a hash key and places the remaining tokens in an array that is the hash value. So, we would process the line “fair JJ NN RB” as a hash key of “fair” and the hash value would be the array of strings (only the first value is currently used but I keep the other values for future use).</p>

<p>When the tagger is processing a list of word tokens, it looks each token up in the hash table and stores the first possible tag type for the word. In our example, the word “fair” would be assigned (possibly temporarily) the tag “JJ.” We now have a list of word tokens and an associated list of possible tag types. We now loop through all of the word tokens applying eight transition rules that Eric Brill’s system learned. We will look at the first rule in some detail; <strong>i</strong> is the loop variable in the range [0, number of word tokens - 1] and <strong>word</strong> is the current word at index <strong>i</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="c1">//  rule 1: DT, {VBD | VBP} --&gt; DT, NN</code>
      <code class="k">if</code> <code class="p">(</code><code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="o">&amp;&amp;</code> <code class="n">ret</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code> <code class="o">-</code> <code class="mi">1</code><code class="p">).</code><code class="na">equals</code><code class="p">(</code><code class="s">"DT"</code><code class="p">))</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">word</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"VBD"</code><code class="p">)</code> <code class="o">||</code>
              <code class="n">word</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"VBP"</code><code class="p">)</code> <code class="o">||</code>
              <code class="n">word</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"VB"</code><code class="p">))</code> <code class="p">{</code>
                         <code class="n">ret</code><code class="p">.</code><code class="na">set</code><code class="p">(</code><code class="n">i</code><code class="p">,</code> <code class="s">"NN"</code><code class="p">);</code>
          <code class="p">}</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>In English, this rule states that if a determiner (DT) at word token index <strong>i - 1</strong> is followed by either a past tense verb (VBD) or a present tense verb (VBP) then replace the tag type at index <strong>i</strong> with “NN.”</p>

<p>I list the remaining seven rules in a short syntax here and you can look at the Java source code to see how they are implemented:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="nv">rule</code> <code class="mi">2</code>: <code class="nv">convert</code> <code class="nv">a</code> <code class="nv">noun</code> <code class="nv">to</code> <code class="nv">a</code> <code class="nv">number</code> <code class="ss">(</code><code class="nv">CD</code><code class="ss">)</code> <code class="k">if</code> <code class="s2">"</code><code class="s">.</code><code class="s2">"</code>
              <code class="nv">appears</code> <code class="nv">in</code> <code class="nv">the</code> <code class="nv">word</code>
      <code class="nv">rule</code> <code class="mi">3</code>: <code class="nv">convert</code> <code class="nv">a</code> <code class="nv">noun</code> <code class="nv">to</code> <code class="nv">a</code> <code class="nv">past</code> <code class="nv">participle</code> <code class="k">if</code>
              <code class="nv">words</code>.<code class="nv">get</code><code class="ss">(</code><code class="nv">i</code><code class="ss">)</code> <code class="nv">ends</code> <code class="nv">with</code> <code class="s2">"</code><code class="s">ed</code><code class="s2">"</code>
      <code class="nv">rule</code> <code class="mi">4</code>: <code class="nv">convert</code> <code class="nv">any</code> <code class="nv">type</code> <code class="nv">to</code> <code class="nv">adverb</code> <code class="k">if</code> <code class="nv">it</code> <code class="nv">ends</code> <code class="nv">in</code> <code class="s2">"</code><code class="s">ly</code><code class="s2">"</code>
      <code class="nv">rule</code> <code class="mi">5</code>: <code class="nv">convert</code> <code class="nv">a</code> <code class="nv">common</code> <code class="nv">noun</code> <code class="ss">(</code><code class="nv">NN</code> <code class="nv">or</code> <code class="nv">NNS</code><code class="ss">)</code> <code class="nv">to</code> <code class="nv">an</code>
              <code class="nv">adjective</code> <code class="k">if</code> <code class="nv">it</code> <code class="nv">ends</code> <code class="nv">with</code> <code class="s2">"</code><code class="s">al</code><code class="s2">"</code>
      <code class="nv">rule</code> <code class="mi">6</code>: <code class="nv">convert</code> <code class="nv">a</code> <code class="nv">noun</code> <code class="nv">to</code> <code class="nv">a</code> <code class="nv">verb</code> <code class="k">if</code> <code class="nv">the</code> <code class="nv">preceding</code>
              <code class="nv">work</code> <code class="nv">is</code> <code class="s2">"</code><code class="s">would</code><code class="s2">"</code>
      <code class="nv">rule</code> <code class="mi">7</code>: <code class="k">if</code> <code class="nv">a</code> <code class="nv">word</code> <code class="nv">has</code> <code class="nv">been</code> <code class="nv">categorized</code> <code class="nv">as</code> <code class="nv">a</code> <code class="nv">common</code>
              <code class="nv">anoun</code> <code class="nv">nd</code> <code class="nv">it</code> <code class="nv">ends</code> <code class="nv">with</code> <code class="s2">"</code><code class="s">s</code><code class="s2">"</code>, <code class="k">then</code> <code class="nv">set</code> <code class="nv">its</code> <code class="nv">type</code>
              <code class="nv">to</code> <code class="nv">plural</code> <code class="nv">common</code> <code class="nv">noun</code> <code class="ss">(</code><code class="nv">NNS</code><code class="ss">)</code>
      <code class="nv">rule</code> <code class="mi">8</code>: <code class="nv">convert</code> <code class="nv">a</code> <code class="nv">common</code> <code class="nv">noun</code> <code class="nv">to</code> <code class="nv">a</code> <code class="nv">present</code> <code class="nv">participle</code>
              <code class="nv">verb</code> <code class="ss">(</code><code class="nv">i</code>.<code class="nv">e</code>., <code class="nv">a</code> <code class="nv">gerund</code><code class="ss">)</code>
</pre></div>

</figure>

<p>My FastTag tagger is not quite as accurate as Brill’s original tagger so you might want to use his system written in C but which can be executed from Java as an external process or with a JNI interface.</p>

<p>In the next section we will use the tokenizer, stemmer, and tagger from this section to develop a system for identifying named entities in text.</p>

<h3 id="named-entity-extraction">Named Entity Extraction From Text</h3>

<p>In this section we will look at identifying names of people and places in text. This can be useful for automatically tagging news articles with the people and place names that occur in the articles. The “secret sauce” for identifying names and places in text is the data in the file <strong>test_data/propername.ser</strong> – a serialized Java data file containing hash tables for human and place names. This data is read in the constructor for the class <strong>Names</strong>; it is worthwhile looking at the code if you have not used the Java serialization APIs before:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">ObjectInputStream</code> <code class="n">p</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ObjectInputStream</code><code class="p">(</code><code class="n">ins</code><code class="p">);</code>
      <code class="n">Hashtable</code> <code class="n">lastNameHash</code> <code class="o">=</code> <code class="p">(</code><code class="n">Hashtable</code><code class="p">)</code> <code class="n">p</code><code class="p">.</code><code class="na">readObject</code><code class="p">();</code>
      <code class="n">Hashtable</code> <code class="n">firstNameHash</code> <code class="o">=</code> <code class="p">(</code><code class="n">Hashtable</code><code class="p">)</code> <code class="n">p</code><code class="p">.</code><code class="na">readObject</code><code class="p">();</code>
      <code class="n">Hashtable</code> <code class="n">placeNameHash</code> <code class="o">=</code> <code class="p">(</code><code class="n">Hashtable</code><code class="p">)</code> <code class="n">p</code><code class="p">.</code><code class="na">readObject</code><code class="p">();</code>
      <code class="n">Hashtable</code> <code class="n">prefixHash</code> <code class="o">=</code> <code class="p">(</code><code class="n">Hashtable</code><code class="p">)</code> <code class="n">p</code><code class="p">.</code><code class="na">readObject</code><code class="p">();</code>
</pre></div>

</figure>

<p>If you want to see these data values, use code like</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">Enumeration</code> <code class="n">keysE</code> <code class="o">=</code> <code class="n">placeNameHash</code><code class="p">.</code><code class="na">keys</code><code class="p">();</code>
      <code class="k">while</code> <code class="p">(</code><code class="n">keysE</code><code class="p">.</code><code class="na">hasMoreElements</code><code class="p">())</code> <code class="p">{</code>
        <code class="n">Object</code> <code class="n">key</code> <code class="o">=</code> <code class="n">keysE</code><code class="p">.</code><code class="na">nextElement</code><code class="p">();</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">key</code> <code class="o">+</code> <code class="s">" : "</code> <code class="o">+</code>
                           <code class="n">placeNameHash</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">key</code><code class="p">));</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The small part of the output from running this code snippet is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    Mauritius : country
    Port-Vila : country_capital
    Hutchinson : us_city
    Mississippi : us_state
    Lithuania : country
</pre></div>

</figure>

<p>Before we look at the entity extraction code and how it works, we will first look at an example of using the main APIs for the <strong>Names</strong> class. The following example uses the methods <strong>isPlaceName</strong>, <strong>isHumanName</strong>, and
<strong>getProperNames</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Los Angeles: "</code> <code class="o">+</code>
                  <code class="n">names</code><code class="p">.</code><code class="na">isPlaceName</code><code class="p">(</code><code class="s">"Los Angeles"</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"President Bush: "</code> <code class="o">+</code>
                  <code class="n">names</code><code class="p">.</code><code class="na">isHumanName</code><code class="p">(</code><code class="s">"President Bush"</code><code class="p">));</code>           
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"President George Bush: "</code> <code class="o">+</code>
           <code class="n">names</code><code class="p">.</code><code class="na">isHumanName</code><code class="p">(</code><code class="s">"President George Bush"</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"President George W. Bush: "</code> <code class="o">+</code>
           <code class="n">names</code><code class="p">.</code><code class="na">isHumanName</code><code class="p">(</code><code class="s">"President George W. Bush"</code><code class="p">));</code>
      <code class="n">ScoredList</code><code class="o">[]</code> <code class="n">ret</code> <code class="o">=</code> <code class="n">names</code><code class="p">.</code><code class="na">getProperNames</code><code class="p">(</code>
            <code class="s">"George Bush played golf. President     \</code>
<code class="s">             George W. Bush went to London England, \</code>
<code class="s">             and Mexico to see Mary    \</code>
<code class="s">             Smith in Moscow. President Bush will   \</code>
<code class="s">             return home Monday."</code><code class="p">);</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Human names: "</code> <code class="o">+</code>
                         <code class="n">ret</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="p">.</code><code class="na">getValuesAsString</code><code class="p">());</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Place names: "</code> <code class="o">+</code>
                         <code class="n">ret</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">.</code><code class="na">getValuesAsString</code><code class="p">());</code>
</pre></div>

</figure>

<p>The output from running this example is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    Los Angeles: true
    President Bush: true
    President George Bush: true
    President George W. Bush: true
    * place name: London,
            placeNameHash.get(name): country_capital
    * place name: Mexico,
            placeNameHash.get(name): country_capital
    * place name: Moscow, 
            placeNameHash.get(name): country_capital
    Human names: George Bush:1,
                 President George W . Bush:1,
                 Mary Smith:1,
                 President Bush:1
    Place names: London:1, Mexico:1, Moscow:1
</pre></div>

</figure>

<p>The complete implementation that you can read through in the source file
<strong>ExtractNames.java</strong> is reasonably simple. The methods <strong>isHumanName</strong> and
<strong>isPlaceName</strong> simply look up a string in either of the human or place name hash tables. For testing a single word this is very easy; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">isPlaceName</code><code class="p">(</code><code class="n">String</code> <code class="n">name</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="n">placeNameHash</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The versions of these APIs that handle names containing multiple words are just a little more complicated; we need to construct a string from the words between the starting and ending indices and test to see if this new string value is a valid key in the human names or place names hash tables. Here is the code for finding multi-word place names:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">isPlaceName</code><code class="p">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">words</code><code class="p">,</code>
                                 <code class="kt">int</code> <code class="n">startIndex</code><code class="p">,</code>
                                 <code class="kt">int</code> <code class="n">numWords</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">((</code><code class="n">startIndex</code> <code class="o">+</code> <code class="n">numWords</code><code class="p">)</code> <code class="o">&gt;</code> <code class="n">words</code><code class="p">.</code><code class="na">size</code><code class="p">())</code> <code class="p">{</code>
          <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">numWords</code> <code class="o">==</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">return</code> <code class="n">isPlaceName</code><code class="p">(</code><code class="n">words</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">startIndex</code><code class="p">));</code>
        <code class="p">}</code>
        <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="s">""</code><code class="p">;</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="n">startIndex</code><code class="p">;</code>
             <code class="n">i</code><code class="o">&lt;</code><code class="p">(</code><code class="n">startIndex</code> <code class="o">+</code> <code class="n">numWords</code><code class="p">);</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">i</code> <code class="o">&lt;</code> <code class="p">(</code><code class="n">startIndex</code> <code class="o">+</code> <code class="n">numWords</code> <code class="o">-</code> <code class="mi">1</code><code class="p">))</code> <code class="p">{</code>
            <code class="n">s</code> <code class="o">=</code> <code class="n">s</code> <code class="o">+</code> <code class="n">words</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">startIndex</code><code class="p">)</code> <code class="o">+</code> <code class="s">" "</code><code class="p">;</code>
          <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="n">s</code> <code class="o">=</code> <code class="n">s</code> <code class="o">+</code> <code class="n">words</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">startIndex</code><code class="p">);</code>
          <code class="p">}</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="n">isPlaceName</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>This same scheme is used to test for multi-word human names. The top-level utility method <strong>getProperNames</strong> is used to find human and place names in text. The code in <strong>getProperNames</strong> is intentionally easy to understand but not very efficient because of all of the temporary test strings that need to be constructed.</p>

<h3 id="leanpub-auto-automatically-assigning-categories-to-text">Automatically Assigning Categories to Text</h3>

<p>Here we will assign zero or more categories like “politics”, “economy”, etc. to text based on the words contained in the text. While the code for doing this is simple there is usually much work to do to build a word count database for different classifications. The approach we use here is often called “bag of words” because the words in input text matter but not the order of words in text or proximity to other words.</p>

<p>I have been working on open source products for automatic tagging and semantic extraction since the 1990s (see my old web site www.knowledgebooks.com if you are interested). In this section I will show you some simple techniques for automatically assigning tags or categories to text. We will use a set of category tags for which I have collected word frequency statistics. For example, a category of “Java” might be associated with the use of the words “Java,” “JVM,” “Sun,” etc. You can find my pre-trained tag data in the file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    test_data/classification_tags.xml
</pre></div>

</figure>

<p>The Java source code for the class <strong>AutoTagger</strong> is in the file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    src-statistical-nlp/com/markwatson/nlp/AutoTagger.java
</pre></div>

</figure>

<p>The <strong>AutoTagger</strong> class uses a few data structures to keep track of both the names of categories (tags) and the word count statistics for words associated with each tag name. I use a temporary hash table for processing the XML input data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">private</code> <code class="kd">static</code> <code class="n">Hashtable</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Hashtable</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Float</code><code class="o">&gt;&gt;</code> <code class="n">tagClasses</code><code class="p">;</code>
</pre></div>

</figure>

<p>The names of categories (tags) used are defined in the XML tag data file: change this file, and you alter both the tags and behavior of this utility class. Please note that the data in this XML file is from a small set of hand-labeled text found on the Web (i.e., my wife and I labelled articles as being about “religion”, “politics”, etc.). </p>

<p>This approach is called “bag of words.” The following listing shows a snippet of data defined in the XML tag data file describing some words (and their scores) associated with the tag “religion_buddhism”:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="nt">&lt;tags&gt;</code>
      <code class="nt">&lt;topic</code> <code class="na">name=</code><code class="s">"religion_buddhism"</code><code class="nt">&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"buddhism"</code> <code class="na">score=</code><code class="s">"52"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"buddhist"</code> <code class="na">score=</code><code class="s">"50"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"mind"</code> <code class="na">score=</code><code class="s">"50"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"buddha"</code> <code class="na">score=</code><code class="s">"37"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"practic"</code> <code class="na">score=</code><code class="s">"31"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"teach"</code> <code class="na">score=</code><code class="s">"15"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"path"</code> <code class="na">score=</code><code class="s">"14"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"mantra"</code> <code class="na">score=</code><code class="s">"14"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"thought"</code> <code class="na">score=</code><code class="s">"14"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"school"</code> <code class="na">score=</code><code class="s">"13"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"zen"</code> <code class="na">score=</code><code class="s">"13"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"mahayana"</code> <code class="na">score=</code><code class="s">"13"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"suffer"</code> <code class="na">score=</code><code class="s">"12"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"dharma"</code> <code class="na">score=</code><code class="s">"12"</code> <code class="nt">/&gt;</code>
        <code class="nt">&lt;term</code> <code class="na">name=</code><code class="s">"tibetan"</code> <code class="na">score=</code><code class="s">"11"</code> <code class="nt">/&gt;</code>
        . . .
      <code class="nt">&lt;/topic&gt;</code>
      . . .
    <code class="nt">&lt;/tags&gt;</code>
</pre></div>

</figure>

<p>Notice that the term names are stemmed words and all lower case. There are 28 categories (tags) defined in the input XML file included in the <a href="https://github.com/mark-watson/Java-AI-Book-Code">GitHub repository for this book</a>.</p>

<p>For data access, I also maintain an array of tag names and an associated list of the word frequency hash tables for each tag name:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code><code class="o">[]</code> <code class="n">tagClassNames</code><code class="p">;</code>
      <code class="kd">private</code> <code class="kd">static</code>
        <code class="n">List</code><code class="o">&lt;</code><code class="n">Hashtable</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Float</code><code class="o">&gt;&gt;</code> <code class="n">hashes</code> <code class="o">=</code>
           <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">Hashtable</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Float</code><code class="o">&gt;&gt;</code><code class="p">();</code>
</pre></div>

</figure>

<p>The XML data is read and these data structures are filled during static class load time so creating multiple instances of the class <strong>AutoTagger</strong> has no performance penalty in memory use. Except for an empty default class constructor, there is only one public API for this class, the method <strong>getTags</strong> gets the categories for input text:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">NameValue</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Float</code><code class="o">&gt;&gt;</code>
                     <code class="nf">getTags</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>To be clear, the tags returned are classification tags like “politics,” “economy,” etc. The utility class <strong>NameValue</strong> is defined in the file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>src-statistical-nlp/com/markwatson/nlp/util/NameValue.java
</pre></div>

</figure>

<p>To determine the tags for input text, we keep a running score for each defined tag type. I use the internal class <strong>SFtriple</strong> to hold triple values of word, score, and tag index. I choose the tags with the highest scores as the automatically assigned tags for the input text. Scores for each tag are calculated by taking each word in the input text, stemming it, and if the stem is in the word frequency hash table for the tag then add the score value in the hash table to the running sum for the tag. You can refer to the AutoTagger.java source code for details. Here is an example use of class <strong>AutoTagger</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">AutoTagger</code> <code class="n">test</code> <code class="o">=</code> <code class="k">new</code> <code class="n">AutoTagger</code><code class="p">();</code>
      <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="s">"The President went to Congress to argue</code>
<code class="s">                  for his tax bill before leaving on a</code>
<code class="s">                  vacation to Las Vegas to see some shows</code>
<code class="s">                  and gamble."</code><code class="p">;</code>
      <code class="n">List</code><code class="o">&lt;</code><code class="n">NameValue</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Float</code><code class="o">&gt;&gt;</code> <code class="n">results</code> <code class="o">=</code>
                                        <code class="n">test</code><code class="p">.</code><code class="na">getTags</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
      <code class="k">for</code> <code class="p">(</code><code class="n">NameValue</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Float</code><code class="o">&gt;</code> <code class="n">result</code> <code class="p">:</code> <code class="n">results</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">result</code><code class="p">);</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The output looks like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    [NameValue: news_economy : 1.0]
    [NameValue: news_politics : 0.84]
</pre></div>

</figure>

<h3 id="text-clustering">Text Clustering</h3>

<p>Clustering text documents refers to associating similar text documents with each other. The text clustering system that I have written for my own projects is simple and effective but it inefficient for large numbers of documents. The example code in this section is inherently inefficient for clustering a large number of text documents because I perform significant semantic processing on each text document and then compare all combinations of documents. The runtime performance is <strong>O(N<sup>2</sup>)</strong> where <strong>N</strong> is the number of text documents. If you need to cluster or compare a very large number of documents you will probably want to use a K-Mean clustering algorithm instead.</p>

<p>I use a few different algorithms to rate the similarity of any two text documents and I will combine these depending on the requirements of the project that I am working on:</p>

<ul>
  <li>Calculate the intersection of common words in the two documents.</li>
  <li>Calculate the intersection of common word stems in the two documents.</li>
  <li>Calculate the intersection of tags assigned to the two documents.</li>
  <li>Calculate the intersection of human and place names in the two documents.</li>
</ul>

<p>In this section we will implement the second option: calculate the intersection of word stems in two documents. Without showing the package and import statements, it takes just a few lines of code to implement this algorithm when we use the <strong>Stemmer</strong> class.</p>

<p>The following listing shows the implementation of class
<strong>ComparableDocument</strong> with comments. We start by defining constructors for documents defined by a <strong>File</strong> object and a <strong>String</strong> object:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="kd">public</code> <code class="kd">class</code> <code class="nc">ComparableDocument</code> <code class="p">{</code>
        <code class="c1">// disable default constructor calls:</code>
        <code class="kd">private</code> <code class="nf">ComparableDocument</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
        <code class="kd">public</code> <code class="nf">ComparableDocument</code><code class="p">(</code><code class="n">File</code> <code class="n">document</code><code class="p">)</code>
                     <code class="kd">throws</code> <code class="n">FileNotFoundException</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">(</code><code class="k">new</code> <code class="n">Scanner</code><code class="p">(</code><code class="n">document</code><code class="p">).</code>
                       <code class="n">useDelimiter</code><code class="p">(</code><code class="s">"\\Z"</code><code class="p">).</code><code class="na">next</code><code class="p">());</code>
        <code class="p">}</code>
        <code class="kd">public</code> <code class="nf">ComparableDocument</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">stems</code> <code class="o">=</code>
                   <code class="k">new</code> <code class="n">Stemmer</code><code class="p">().</code><code class="na">stemString</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
            <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="n">stem</code> <code class="p">:</code> <code class="n">stems</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">stem_count</code><code class="o">++</code><code class="p">;</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">stemCountMap</code><code class="p">.</code><code class="na">containsKey</code><code class="p">(</code><code class="n">stem</code><code class="p">))</code> <code class="p">{</code>
                    <code class="n">Integer</code> <code class="n">count</code> <code class="o">=</code> <code class="n">stemCountMap</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">stem</code><code class="p">);</code>
                    <code class="n">stemCountMap</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">stem</code><code class="p">,</code> <code class="mi">1</code> <code class="o">+</code> <code class="n">count</code><code class="p">);</code>
                <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                    <code class="n">stemCountMap</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">stem</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">}</code>
</pre></div>

</figure>

<p>In the last constructor, I simply create a count of how many times each stem occurs in the document.</p>

<p>The public API allows us to get the stem count hash table, the number of stems in the original document, and a numeric comparison value for comparing this document with another (this is the first version – we will add an improvement later):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="kd">public</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Integer</code><code class="o">&gt;</code> <code class="nf">getStemMap</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="n">stemCountMap</code><code class="p">;</code>
      <code class="p">}</code>
      <code class="kd">public</code> <code class="kt">int</code> <code class="nf">getStemCount</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="n">stem_count</code><code class="p">;</code>
      <code class="p">}</code>
      <code class="kd">public</code> <code class="kt">float</code>
             <code class="nf">compareTo</code><code class="p">(</code><code class="n">ComparableDocument</code> <code class="n">otherDocument</code><code class="p">)</code> <code class="p">{</code>
        <code class="kt">long</code> <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="n">Integer</code><code class="o">&gt;</code> <code class="n">map2</code> <code class="o">=</code> <code class="n">otherDocument</code><code class="p">.</code><code class="na">getStemMap</code><code class="p">();</code>
        <code class="n">Iterator</code> <code class="n">iter</code> <code class="o">=</code> <code class="n">stemCountMap</code><code class="p">.</code><code class="na">keySet</code><code class="p">().</code><code class="na">iterator</code><code class="p">();</code>
        <code class="k">while</code> <code class="p">(</code><code class="n">iter</code><code class="p">.</code><code class="na">hasNext</code><code class="p">())</code> <code class="p">{</code>
          <code class="n">Object</code> <code class="n">key</code> <code class="o">=</code> <code class="n">iter</code><code class="p">.</code><code class="na">next</code><code class="p">();</code>
          <code class="n">Integer</code> <code class="n">count1</code> <code class="o">=</code> <code class="n">stemCountMap</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">key</code><code class="p">);</code>
          <code class="n">Integer</code> <code class="n">count2</code> <code class="o">=</code> <code class="n">map2</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">key</code><code class="p">);</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">count1</code><code class="o">!=</code><code class="kc">null</code> <code class="o">&amp;&amp;</code> <code class="n">count2</code><code class="o">!=</code><code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
            <code class="n">count</code> <code class="o">+=</code> <code class="n">count1</code> <code class="o">*</code> <code class="n">count2</code><code class="p">;</code>
          <code class="p">}</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="p">(</code><code class="kt">float</code><code class="p">)</code> <code class="n">Math</code><code class="p">.</code><code class="na">sqrt</code><code class="p">(</code>
                 <code class="p">((</code><code class="kt">float</code><code class="p">)(</code><code class="n">count</code><code class="o">*</code><code class="n">count</code><code class="p">)</code> <code class="o">/</code>
                  <code class="p">(</code><code class="kt">double</code><code class="p">)(</code><code class="n">stem_count</code> <code class="o">*</code>
                           <code class="n">otherDocument</code><code class="p">.</code><code class="na">getStemCount</code><code class="p">())))</code>
                <code class="o">/</code> <code class="mf">2f</code><code class="p">;</code>
      <code class="p">}</code>
      <code class="kd">private</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Integer</code><code class="o">&gt;</code> <code class="n">stemCountMap</code> <code class="o">=</code>
                        <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Integer</code><code class="o">&gt;</code><code class="p">();</code>
      <code class="kd">private</code> <code class="kt">int</code> <code class="n">stem_count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>I normalize the return value for the method <strong>compareTo</strong> to return a value of 1.0 if compared documents are identical (after stemming) and 0.0 if they contain no common stems. There are four test text documents
in the test_data directory and the following test code compares various combinations. Note that I am careful to test the case of comparing identical documents:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="n">ComparableDocument</code> <code class="n">news1</code> <code class="o">=</code> 
         <code class="k">new</code> <code class="n">ComparableDocument</code><code class="p">(</code><code class="s">"testdata/news_1.txt"</code><code class="p">);</code>
      <code class="n">ComparableDocument</code> <code class="n">news2</code> <code class="o">=</code>
         <code class="k">new</code> <code class="n">ComparableDocument</code><code class="p">(</code><code class="s">"testdata/news_2.txt"</code><code class="p">);</code>
      <code class="n">ComparableDocument</code> <code class="n">econ1</code> <code class="o">=</code>
         <code class="k">new</code> <code class="n">ComparableDocument</code><code class="p">(</code><code class="s">"testdata/economy_1.txt"</code><code class="p">);</code>
      <code class="n">ComparableDocument</code> <code class="n">econ2</code> <code class="o">=</code>
         <code class="k">new</code> <code class="n">ComparableDocument</code><code class="p">(</code><code class="s">"testdata/economy_2.txt"</code><code class="p">);</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"news 1 - news1: "</code> <code class="o">+</code>
                         <code class="n">news1</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">news1</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"news 1 - news2: "</code> <code class="o">+</code>
                         <code class="n">news1</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">news2</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"news 2 - news2: "</code> <code class="o">+</code>
                         <code class="n">news2</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">news2</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"news 1 - econ1: "</code> <code class="o">+</code>
                         <code class="n">news1</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">econ1</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"econ 1 - econ1: "</code> <code class="o">+</code>
                         <code class="n">econ1</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">econ1</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"news 1 - econ2: "</code> <code class="o">+</code>
                         <code class="n">news1</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">econ2</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"econ 1 - econ2: "</code> <code class="o">+</code>
                         <code class="n">econ1</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">econ2</code><code class="p">));</code>
      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"econ 2 - econ2: "</code> <code class="o">+</code>
                         <code class="n">econ2</code><code class="p">.</code><code class="na">compareTo</code><code class="p">(</code><code class="n">econ2</code><code class="p">));</code>
</pre></div>

</figure>

<p>The following listing shows output that indicates mediocre results; we will soon make an improvement that makes the results better. The output for this test code is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    news 1 - news1: 1.0
    news 1 - news2: 0.4457711
    news 2 - news2: 1.0
    news 1 - econ1: 0.3649214
    econ 1 - econ1: 1.0
    news 1 - econ2: 0.32748842
    econ 1 - econ2: 0.42922822
    econ 2 - econ2: 1.0
</pre></div>

</figure>

<p>There is not as much differentiation in comparison scores between political news stories and economic news stories. What is up here? The problem is that I did not remove common words (and therefore common word stems) when creating stem counts for each document. I wrote a utility class <strong>NoiseWords</strong> for identifying both common words and their stems; you can see the implementation in the file NoiseWords.java. Removing noise words improves the comparison results (I added a few tests since the last printout):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    news 1 - news1: 1.0
    news 1 - news2: 0.1681978
    news 1 - econ1: 0.04279895
    news 1 - econ2: 0.034234844
    econ 1 - econ2: 0.26178515
    news 2 - econ2: 0.106673114
    econ 1 - econ2: 0.26178515
</pre></div>

</figure>

<p>Much better results! The API for <strong>com.markwatson.nlp.util.NoiseWords</strong> is a single static method:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">public</code> <code class="kd">static</code> <code class="kt">boolean</code> <code class="nf">checkFor</code><code class="p">(</code><code class="n">String</code> <code class="n">stem</code><code class="p">)</code>
</pre></div>

</figure>

<p>You can add additional noise words to the data section in the file <strong>NoiseWords.java</strong>, depending on your application.</p>

<h3 id="leanpub-auto-wrapup">Wrapup</h3>

<p>This chapter contains my own experiments with ad-hoc NLP that I often find useful for my work.</p>

<p>In the next chapter <a href="#opennlp">Natural Language Processing Using OpenNLP</a> we use the Apache OpenNLP library that I also often use in my work.</p>


<h2 id="opennlp">Natural Language Processing Using OpenNLP</h2>

<p>Here we use the <a href="https://opennlp.apache.org">Apache OpenNLP project</a>. OpenNLP has pre-trained models for tokenization, sentence segmentation, part-of-speech tagging, named entity extraction, chunking, parsing, and coreference resolution. As we see later OpenNLP has tools to also build our own models.</p>

<p>I have worked in the field of Natural Language Processing (NLP) since the early 1980s. Many more people are now interested in the field of NLP and the techniques have changed drastically in the last decade.</p>

<p>Currently, OpenNLP has support for Danish, German, English, Spanish, Portuguese, and Swedish. I include in the github repository some trained models for English that are used in the examples in this chapter. You can download models for other languages at the <a href="http://opennlp.sourceforge.net/models-1.5/">web page for OpenNLP 1.5 models</a> (we are using version 1..6.0 of OpenNLP in this book which uses the version 1.5 models).</p>

<p>The following figure shows the project for this chapter in the Community Edition of IntelliJ:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/intellij_opennlp_proj.png" alt="IntelliJ project view for the examples in this chapter" style="width: 100%">
    <figcaption>IntelliJ project view for the examples in this chapter</figcaption>
  </figure>
</div>


<p>We will use pre-trained models for tokenizing text, recognizing the names of organizations, people, locations, and parts of speech for words in input text. We will also train a new model (the file <strong>opennlp/models/en-newscat.bin</strong> in the github repository) for recognizing the category of input text. The section on training new maximum entropy classification models using your own training data may be the material in this chapter that you will use the most in your own projects. We will train one model to recognize the categories of <strong>COMPUTERS</strong>, <strong>ECONOMY</strong>, <strong>HEALTH</strong>, and <strong>POLITICS</strong>. You should then have the knowledge for training your own models using your own training texts for the categories that you need for your applications. The <a href="https://opennlp.apache.org/docs/1.9.2/manual/opennlp.html#opennlp">OpenNLP documentation</a> has additional detail on custom models. We will also use both some pre-trained models that are included with the OpenNLP distribution in the next chapter when we combine using OpenNLP with the WordNet lexical database developed at Princeton University.</p>

<p>After building a classification model we finish up this chapter with an interesting topic: statistically parsing sentences to discover the most probable linguistic structure of each sentence in input text. We will not use parsing in the rest of this book so you may skip the last section of this chapter if you are not currently interested in understanding sentence parse tree structure of components like noun and verb phrases, proper nouns, nouns, and adjectives, etc.</p>

<p>The following UML class diagrams will give you an overview of my wrapper for the OpenNLP library and for the unit test class:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/opennlp-uml.png" alt="UML class diagram for wrapper code for OpenNLP examples" style="width: 100%">
    <figcaption>UML class diagram for wrapper code for OpenNLP examples</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-using-opennlp-pre-trained-models">Using OpenNLP Pre-Trained Models</h3>

<p>Assuming that you have cloned the github repository for this book, you can fetch the maven dependencies, compile the code, install the generated library locally, and run the unit tests using the command:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>mvn install
</pre></div>

</figure>

<p>The model files, including the categorization model you will learn to build later in this chapter, are found in the subdirectory <strong>models</strong>. The unit tests in <strong>src/test/java/com/markwatson/opennlp/NLPTest.java</strong> provide examples for using the code we develop in this chapter. As for many examples in this book, I use unit tests as examples for using a library and not as tests that check computed values.</p>

<p>The Java example code for tokenization (splitting text into individual words), splitting sentences, and recognizing organizations, locations, and people in text is all in the Java class <strong>NLP</strong>. You can look at the source code in the repository for this book. Here I will just show a few snippets of the code to make clear how to load and use pre-trained models.</p>

<p>I use static class initialization to load the model files:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">Tokenizer</code> <code class="n">tokenizer</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="n">SentenceDetectorME</code> <code class="n">sentenceSplitter</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="kd">static</code> <code class="n">POSTaggerME</code> <code class="n">tagger</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="kd">static</code> <code class="n">NameFinderME</code> <code class="n">organizationFinder</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="kd">static</code> <code class="n">NameFinderME</code> <code class="n">locationFinder</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="kd">static</code> <code class="n">NameFinderME</code> <code class="n">personNameFinder</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>

  <code class="kd">static</code> <code class="p">{</code>

    <code class="k">try</code> <code class="p">{</code>
      <code class="n">InputStream</code> <code class="n">organizationInputStream</code> <code class="o">=</code>
	    <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-ner-organization.bin"</code><code class="p">);</code>
      <code class="n">TokenNameFinderModel</code> <code class="n">model</code> <code class="o">=</code>
	    <code class="k">new</code> <code class="n">TokenNameFinderModel</code><code class="p">(</code><code class="n">organizationInputStream</code><code class="p">);</code>
      <code class="n">organizationFinder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">NameFinderME</code><code class="p">(</code><code class="n">model</code><code class="p">);</code>
      <code class="n">organizationInputStream</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>

      <code class="n">InputStream</code> <code class="n">locationInputStream</code> <code class="o">=</code>
	    <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-ner-location.bin"</code><code class="p">);</code>
      <code class="n">model</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TokenNameFinderModel</code><code class="p">(</code><code class="n">locationInputStream</code><code class="p">);</code>
      <code class="n">locationFinder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">NameFinderME</code><code class="p">(</code><code class="n">model</code><code class="p">);</code>
      <code class="n">locationInputStream</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>

      <code class="n">InputStream</code> <code class="n">personNameInputStream</code> <code class="o">=</code>
	    <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-ner-person.bin"</code><code class="p">);</code>
      <code class="n">model</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TokenNameFinderModel</code><code class="p">(</code><code class="n">personNameInputStream</code><code class="p">);</code>
      <code class="n">personNameFinder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">NameFinderME</code><code class="p">(</code><code class="n">model</code><code class="p">);</code>
      <code class="n">personNameInputStream</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>

      <code class="n">InputStream</code> <code class="n">tokienizerInputStream</code> <code class="o">=</code>
	    <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-token.bin"</code><code class="p">);</code>
      <code class="n">TokenizerModel</code> <code class="n">modelTokenizer</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TokenizerModel</code><code class="p">(</code><code class="n">tokienizerInputStream</code><code class="p">);</code>
      <code class="n">tokenizer</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TokenizerME</code><code class="p">(</code><code class="n">modelTokenizer</code><code class="p">);</code>
      <code class="n">tokienizerInputStream</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>

      <code class="n">InputStream</code> <code class="n">sentenceInputStream</code> <code class="o">=</code>
	    <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-sent.bin"</code><code class="p">);</code>
      <code class="n">SentenceModel</code> <code class="n">sentenceTokenizer</code> <code class="o">=</code> <code class="k">new</code> <code class="n">SentenceModel</code><code class="p">(</code><code class="n">sentenceInputStream</code><code class="p">);</code>
      <code class="n">sentenceSplitter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">SentenceDetectorME</code><code class="p">(</code><code class="n">sentenceTokenizer</code><code class="p">);</code>
      <code class="n">tokienizerInputStream</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>

      <code class="n">organizationInputStream</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-pos-maxent.bin"</code><code class="p">);</code>
      <code class="n">POSModel</code> <code class="n">posModel</code> <code class="o">=</code> <code class="k">new</code> <code class="n">POSModel</code><code class="p">(</code><code class="n">organizationInputStream</code><code class="p">);</code>
      <code class="n">tagger</code> <code class="o">=</code> <code class="k">new</code> <code class="n">POSTaggerME</code><code class="p">(</code><code class="n">posModel</code><code class="p">);</code>

    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">IOException</code> <code class="n">e</code><code class="p">)</code> <code class="p">{</code>
      <code class="n">e</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code>
    <code class="p">}</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>The first operation that you will usually start with for processing natural language text is breaking input text into individual words and sentences. Here is the code for using the tokenizing code that separates text stored as a Java String into individual words:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">String</code><code class="o">[]</code> <code class="nf">tokenize</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">tokenizer</code><code class="p">.</code><code class="na">tokenize</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>Here is the similar code for breaking text into individual sentences:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">String</code><code class="o">[]</code> <code class="nf">sentenceSplitter</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">sentenceSplitter</code><code class="p">.</code><code class="na">sentDetect</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>Here is some sample code to use <strong>sentenceSplitter</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nt">String</code> <code class="nt">sentence</code> <code class="o">=</code>
<code class="linenos">2 </code>      <code class="s2">"Apple Computer, Microsoft, and Google are in the "</code> <code class="o">+</code>
<code class="linenos">3 </code>      <code class="s2">" tech sector. Each is very profitable."</code><code class="o">;</code>
<code class="linenos">4 </code>    <code class="nt">String</code> <code class="cp">[]</code> <code class="nt">sentences</code> <code class="o">=</code> <code class="nt">NLP</code><code class="p">.</code><code class="nc">sentenceSplitter</code><code class="o">(</code><code class="nt">sentence</code><code class="o">);</code>
<code class="linenos">5 </code>    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"Sentences found:\n"</code> <code class="o">+</code> <code class="nt">Arrays</code><code class="p">.</code><code class="nc">toString</code><code class="o">(</code><code class="nt">sentences</code><code class="o">));</code>
</pre></div>

</figure>

<p>In line 4 the static method <strong>NLP.sentenceSplitter</strong> returns an array of strings. In line 5 I use a common Java idiom for printing arrays by using the static method <strong>Arrays.toString</strong> to convert the array of strings into a <strong>List&lt;String&gt;</strong> object. The trick is that the <strong>List</strong> class has a <strong>toString</strong> method that formats list nicely for printing.</p>

<p>Here is the output of this code snippet (edited for page width and clarity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Sentences found:
  ["Apple Computer, Microsoft, and Google are in the tech sector.",
   "Each is very profitable."]
</pre></div>

</figure>

<p>The code for finding organizations, locations, and people’s names is almost identical so I will only show the code in the next listing for recognizing locations. Please look at the methods <strong>companyNames</strong> and <strong>personNames</strong>  in the class <strong>com.markwatson.opennlp.NLP</strong> to see the implementations for finding the names of companies and people.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">locationNames</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 2 </code>    <code class="k">return</code> <code class="n">locationNames</code><code class="p">(</code><code class="n">tokenizer</code><code class="p">.</code><code class="na">tokenize</code><code class="p">(</code><code class="n">text</code><code class="p">));</code>
<code class="linenos"> 3 </code>  <code class="p">}</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="nf">locationNames</code><code class="p">(</code><code class="n">String</code> <code class="n">tokens</code><code class="o">[]</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 6 </code>    <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashSet</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
<code class="linenos"> 7 </code>    <code class="n">Span</code><code class="o">[]</code> <code class="n">nameSpans</code> <code class="o">=</code> <code class="n">locationFinder</code><code class="p">.</code><code class="na">find</code><code class="p">(</code><code class="n">tokens</code><code class="p">);</code>
<code class="linenos"> 8 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">nameSpans</code><code class="p">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
<code class="linenos"> 9 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">nameSpans</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>      <code class="n">Span</code> <code class="n">span</code> <code class="o">=</code> <code class="n">nameSpans</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">;</code>
<code class="linenos">11 </code>      <code class="n">StringBuilder</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>
<code class="linenos">12 </code>      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code> <code class="o">=</code> <code class="n">span</code><code class="p">.</code><code class="na">getStart</code><code class="p">();</code> <code class="n">j</code> <code class="o">&lt;</code> <code class="n">span</code><code class="p">.</code><code class="na">getEnd</code><code class="p">();</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code>
<code class="linenos">13 </code>        <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">tokens</code><code class="o">[</code><code class="n">j</code><code class="o">]</code> <code class="o">+</code> <code class="s">" "</code><code class="p">);</code>
<code class="linenos">14 </code>      <code class="n">ret</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">().</code><code class="na">trim</code><code class="p">().</code><code class="na">replaceAll</code><code class="p">(</code><code class="s">" ,"</code><code class="p">,</code> <code class="s">","</code><code class="p">));</code>
<code class="linenos">15 </code>    <code class="p">}</code>
<code class="linenos">16 </code>    <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
<code class="linenos">17 </code>  <code class="p">}</code>
</pre></div>

</figure>

<p>The public methods in the class <strong>com.markwatson.opennlp.NLP</strong> are overriden to take either a single string value which gets tokenized inside of the method and also a method that takes as input text that has already been tokenized into a <strong>String tokens[]</strong> object. In the last example the method starting on line 1 accepts an input string and the overriden method starting on line 5 accepts an array of strings. Often you will want to tokenize text stored in a single input string into tokens and reuse the tokens for calling several of the public methods in <strong>com.markwatson.opennlp.NLP</strong> that can take input that is already tokenized. In line 2 we simply tokenize the input text and call the method that accepts tokenized input text.</p>

<p>In line 6 we create a <strong>HashSet&lt;String&gt;</strong> object that will hold the return value of a set of location names. The <strong>NameFinderME</strong> object <strong>locationFinder</strong> returns an array of <strong>Span</strong> objects. The <strong>Span</strong> class is used to represent a sequence of adjacent words. The <strong>Span</strong> class has a public static attribute <strong>length</strong> and instance methods <strong>getstart</strong> and <strong>getEnd</strong> that return the indices of the beginning and ending (plus one) index of a span in the original input text.</p>

<p>Here is some sample code to use <strong>locationNames</strong> along with the output (edited for page width and clarity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>   <code class="n">String</code> <code class="n">sentence</code> <code class="o">=</code>
     <code class="s">"Apple Computer is located in Cupertino, California and Microsoft "</code> <code class="o">+</code>
     <code class="s">"is located in Seattle, Washington. He went to Oregon"</code><code class="p">;</code>
   <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">names</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="na">locationNames</code><code class="p">(</code><code class="n">sentence</code><code class="p">);</code>
   <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Location names found: "</code> <code class="o">+</code> <code class="n">names</code><code class="p">);</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">Location</code> <code class="n">names</code> <code class="nl">found:</code> <code class="p">[</code><code class="n">Oregon</code><code class="p">,</code> <code class="n">Cupertino</code><code class="p">,</code> <code class="n">Seattle</code><code class="p">,</code> <code class="n">California</code><code class="p">,</code> <code class="n">Washington</code><code class="p">]</code>
</pre></div>

</figure>

<p>Note that the pre-trained model does not provide information when city and state names are associated with each other in the original sentence. The maximum entropy models used in OpenNLP do use information on the context or a word in a sentence, for example, the preceeding and following word. This combination of available contextual information makes maximum entropy models more accurate than the “bag of words” technique we used in the last chapter.</p>

<h3 id="leanpub-auto-training-a-new-categorization-model-for-opennlp">Training a New Categorization Model for OpenNLP</h3>

<p>The OpenNLP class <strong>DoccatTrainer</strong> can process specially formatted input text files and produce categorization models using maximum entropy which is a technique that handles data with many features. Features that are automatically extracted from text and used in a model are things like words in a document and word adjacency. Maximum entropy models can recognize multiple classes. In testing a model on new text data the probablilities of all possible classes add up to the value 1 (this is often refered to as “softmax”). For example we will be training a classifier on four categories and the probablilities of these categories for some test input text add up to the value of one:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>[[COMPUTERS, 0.1578880260493374], [ECONOMY, 0.2163099374638936],
 [HEALTH, 0.35546925520388845], [POLITICS, 0.27033278128288035]]
</pre></div>

</figure>

<p>The format of the input file for training a maximum entropy classifier is simple but has to be correct: each line starts with a category name, followed by sample text for each category which must be <strong>all</strong> <strong>on</strong> <strong>one</strong> <strong>line</strong>. Please note that I have already trained the model producing the model file <strong>models/en-newscat.bin</strong> so you don’t need to run the example in this section unless you want to regenerate this model file.</p>

<p>The file <strong>sample_category_training_text.txt</strong> contains four lines, defining four categories. Here are two lines from this file (I edited the following to look better on the printed page, but these are just two lines in the file):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>COMPUTERS Computers are often used to access the Internet to meet business functions.
ECONOMY The Austrian School (also known as the Vienna School or the Psychological Sc\
hool ) is a Schools of economic thought|school of economic thought that emphasizes t\
he spontaneous organizing power of the price mechanism.
</pre></div>

</figure>

<p>Here is one training example each for the categories COMPUTERS and ECONOMY.</p>

<p>You must format the training file perfectly. As an example, if you have empty (or blank) lines in your input training file then you will get an error like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Computing event counts...  java.io.IOException: Empty lines, or lines with
                           only a category string are not allowed!
</pre></div>

</figure>

<p>The OpenNLP documentation has examples for writing custom Java code to build models but I usually just use the command line tool; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>bin/opennlp DoccatTrainer -model models/en-newscat.bin -lang en \
                          -data sample_category_training_text.txt \
                          -encoding UTF-8
</pre></div>

</figure>

<p>The model is written to the relative file path <strong>models/en-newscat.bin</strong>. The training file I am using is tiny so the model is trained in a few seconds. For serious applications, the more training text the better! By default the <strong>DoccatTrainer</strong> tool uses the default text feature generator which uses word frequencies in documents but ignores word ordering. As I mention in the next section, I sometimes like to mix word frequency feature generation with 2gram (that is, frequencies of two adjacent words). In this case you cannot simply use the <strong>DoccatTrainer</strong>  command line tool. You need to write a little Java code yourself that you can plug another feature generator into using the alternative API:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">public</code> <code class="kd">static</code> <code class="n">DoccatModel</code> <code class="nf">train</code><code class="p">(</code><code class="n">String</code> <code class="n">languageCode</code><code class="p">,</code>
                                <code class="n">ObjectStream</code><code class="o">&lt;</code><code class="n">DocumentSample</code><code class="o">&gt;</code> <code class="n">samples</code><code class="p">,</code>
                                <code class="kt">int</code> <code class="n">cutoff</code><code class="p">,</code> <code class="kt">int</code> <code class="n">iterations</code><code class="p">,</code>
                                <code class="n">FeatureGenerator</code><code class="p">...</code> <code class="n">featureGenerators</code><code class="p">)</code>
</pre></div>

</figure>

<p>In the next section, you will note that the last argument would look like the case where we combine two feature generators, one that uses “bag of words” and the other that uses adjacent word sequences:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">public</code> <code class="nf">DocumentCategorizerME</code><code class="p">(</code><code class="n">DoccatModel</code> <code class="n">model</code><code class="p">,</code>
           <code class="k">new</code> <code class="n">FeatureGenerator</code><code class="o">[]</code><code class="p">{</code><code class="k">new</code> <code class="n">BagOfWordsFeatureGenerator</code><code class="p">(),</code>
                                  <code class="k">new</code> <code class="n">NGramFeatureGenerator</code><code class="p">()});</code>
</pre></div>

</figure>

<p>For some purposes the default word frequency (or bag of words) feature generator is probably OK so using the command line tool is a good place to start because models are smaller and training time is minimal. Adding the <strong>NGramFeatureGenerator</strong> increases both training time and model size but should produce better results. Here is the output from running the <strong>DoccatTrainer</strong> command line tool:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">&gt;</code> <code class="nv">bin</code><code class="o">/</code><code class="nv">opennlp</code> <code class="nv">DoccatTrainer</code> <code class="o">-</code><code class="nv">model</code> <code class="nv">models</code><code class="o">/</code><code class="nv">en</code><code class="o">-</code><code class="nv">newscat</code>.<code class="nv">bin</code> <code class="o">-</code><code class="nv">lang</code> <code class="nv">en</code> \
                            <code class="o">-</code><code class="nv">data</code> <code class="nv">sample_category_training_text</code>.<code class="nv">txt</code> \
                            <code class="o">-</code><code class="nv">encoding</code> <code class="nv">UTF</code><code class="o">-</code><code class="mi">8</code>
<code class="nv">Indexing</code> <code class="nv">events</code> <code class="nv">using</code> <code class="nv">cutoff</code> <code class="nv">of</code> <code class="mi">5</code>

	<code class="nv">Computing</code> <code class="nv">event</code> <code class="nv">counts</code>...  <code class="nv">done</code>. <code class="mi">4</code> <code class="nv">events</code>
	<code class="nv">Indexing</code>...  <code class="nv">done</code>.
<code class="nv">Sorting</code> <code class="nv">and</code> <code class="nv">merging</code> <code class="nv">events</code>... <code class="nv">done</code>. <code class="nv">Reduced</code> <code class="mi">4</code> <code class="nv">events</code> <code class="nv">to</code> <code class="mi">4</code>.
<code class="nv">Done</code> <code class="nv">indexing</code>.
<code class="nv">Incorporating</code> <code class="nv">indexed</code> <code class="nv">data</code> <code class="k">for</code> <code class="nv">training</code>...  
<code class="nv">done</code>.
	<code class="nv">Number</code> <code class="nv">of</code> <code class="nv">Event</code> <code class="nv">Tokens</code>: <code class="mi">4</code>
	    <code class="nv">Number</code> <code class="nv">of</code> <code class="nv">Outcomes</code>: <code class="mi">4</code>
	  <code class="nv">Number</code> <code class="nv">of</code> <code class="nv">Predicates</code>: <code class="mi">153</code>
...<code class="nv">done</code>.
<code class="nv">Computing</code> <code class="nv">model</code> <code class="nv">parameters</code> ...
<code class="nv">Performing</code> <code class="mi">100</code> <code class="nv">iterations</code>.
  <code class="mi">1</code>:  ... <code class="nv">loglikelihood</code><code class="o">=-</code><code class="mi">5</code>.<code class="mi">545177444479562</code>	<code class="mi">0</code>.<code class="mi">25</code>
  <code class="mi">2</code>:  ... <code class="nv">loglikelihood</code><code class="o">=-</code><code class="mi">4</code>.<code class="mi">730232204542369</code>	<code class="mi">0</code>.<code class="mi">5</code>
  <code class="mi">3</code>:  ... <code class="nv">loglikelihood</code><code class="o">=-</code><code class="mi">4</code>.<code class="mi">232192673282495</code>	<code class="mi">0</code>.<code class="mi">75</code>
   ...
 <code class="mi">98</code>:  ... <code class="nv">loglikelihood</code><code class="o">=-</code><code class="mi">0</code>.<code class="mi">23411803835475453</code>	<code class="mi">1</code>.<code class="mi">0</code>
 <code class="mi">99</code>:  ... <code class="nv">loglikelihood</code><code class="o">=-</code><code class="mi">0</code>.<code class="mi">23150121909902377</code>	<code class="mi">1</code>.<code class="mi">0</code>
<code class="mi">100</code>:  ... <code class="nv">loglikelihood</code><code class="o">=-</code><code class="mi">0</code>.<code class="mi">22894028845170055</code>	<code class="mi">1</code>.<code class="mi">0</code>
<code class="nv">Writing</code> <code class="nv">document</code> <code class="nv">categorizer</code> <code class="nv">model</code> ... <code class="nv">done</code> <code class="ss">(</code><code class="mi">0</code>.<code class="mi">041</code><code class="nv">s</code><code class="ss">)</code>

<code class="nv">Wrote</code> <code class="nv">document</code> <code class="nv">categorizer</code> <code class="nv">model</code> <code class="nv">to</code>
<code class="nv">path</code>: <code class="o">/</code><code class="nv">Users</code><code class="o">/</code><code class="nv">mark</code><code class="o">/</code><code class="nv">power</code><code class="o">-</code><code class="nv">java</code><code class="o">/</code><code class="nv">opennlp</code><code class="o">/</code><code class="nv">models</code><code class="o">/</code><code class="nv">en</code><code class="o">-</code><code class="nv">newscat</code>.<code class="nv">bin</code>
</pre></div>

</figure>

<p>We will use our new trained model file <strong>en-newscat.bin</strong> in the next section.</p>

<p><strong>Please</strong> <strong>note</strong> that in this simple example I used very little data, just a few hundred words for each training category. I have used the OpenNLP maximum entropy library on various projects, mostly to good effect, but I used many thousands of words for each category. The more data, the better.</p>

<h3 id="leanpub-auto-using-our-new-trained-classification-model">Using Our New Trained Classification Model</h3>

<p>The code that uses the model we trained in the last section is short enough to list in its entirety:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.opennlp</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">opennlp.tools.doccat.DoccatModel</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">opennlp.tools.doccat.DocumentCategorizerME</code><code class="p">;</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">java.io.*</code><code class="p">;</code>
<code class="linenos"> 7 </code><code class="kn">import</code> <code class="nn">java.util.*</code><code class="p">;</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="cm">/**</code>
<code class="linenos">10 </code><code class="cm"> * This program uses the maximum entropy model we trained</code>
<code class="linenos">11 </code><code class="cm"> * using the instructions in the chapter on OpenNLP in the book.</code>
<code class="linenos">12 </code><code class="cm"> */</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">NewsClassifier</code> <code class="p">{</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="n">Double</code><code class="o">&gt;&gt;</code> <code class="nf">allRankedCategories</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">17 </code>    <code class="n">DocumentCategorizerME</code> <code class="n">aCategorizer</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DocumentCategorizerME</code><code class="p">(</code><code class="n">docCatModel</code><code class="p">);</code>
<code class="linenos">18 </code>    <code class="kt">double</code><code class="o">[]</code> <code class="n">outcomes</code> <code class="o">=</code> <code class="n">aCategorizer</code><code class="p">.</code><code class="na">categorize</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
<code class="linenos">19 </code>    <code class="n">List</code><code class="o">&lt;</code><code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="n">Double</code><code class="o">&gt;&gt;</code> <code class="n">results</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Double</code><code class="o">&gt;&gt;</code><code class="p">();</code>
<code class="linenos">20 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">outcomes</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">21 </code>      <code class="n">results</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="k">new</code> <code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Double</code><code class="o">&gt;</code><code class="p">(</code><code class="n">aCategorizer</code><code class="p">.</code><code class="na">getCategory</code><code class="p">(</code><code class="n">i</code><code class="p">),</code> <code class="n">outcomes</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">)</code><code class="err">\</code>
<code class="linenos">22 </code><code class="p">);</code>
<code class="linenos">23 </code>    <code class="p">}</code>
<code class="linenos">24 </code>    <code class="k">return</code> <code class="n">results</code><code class="p">;</code>
<code class="linenos">25 </code>  <code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">bestCategory</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">28 </code>    <code class="n">DocumentCategorizerME</code> <code class="n">aCategorizer</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DocumentCategorizerME</code><code class="p">(</code><code class="n">docCatModel</code><code class="p">);</code>
<code class="linenos">29 </code>    <code class="kt">double</code><code class="o">[]</code> <code class="n">outcomes</code> <code class="o">=</code> <code class="n">aCategorizer</code><code class="p">.</code><code class="na">categorize</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
<code class="linenos">30 </code>    <code class="k">return</code> <code class="n">aCategorizer</code><code class="p">.</code><code class="na">getBestCategory</code><code class="p">(</code><code class="n">outcomes</code><code class="p">);</code>
<code class="linenos">31 </code>  <code class="p">}</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="n">Float</code><code class="o">&gt;</code> <code class="nf">classifyWithScore</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">34 </code>    <code class="n">DocumentCategorizerME</code> <code class="n">classifier</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DocumentCategorizerME</code><code class="p">(</code><code class="n">docCatModel</code><code class="p">);</code>
<code class="linenos">35 </code>    <code class="kt">double</code> <code class="o">[]</code> <code class="n">scores</code> <code class="o">=</code> <code class="n">classifier</code><code class="p">.</code><code class="na">categorize</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
<code class="linenos">36 </code>    <code class="kt">int</code> <code class="n">num_categories</code> <code class="o">=</code> <code class="n">classifier</code><code class="p">.</code><code class="na">getNumberOfCategories</code><code class="p">();</code>
<code class="linenos">37 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">num_categories</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">38 </code>      <code class="n">String</code> <code class="n">bestString</code> <code class="o">=</code>  <code class="n">classifier</code><code class="p">.</code><code class="na">getBestCategory</code><code class="p">(</code><code class="n">scores</code><code class="p">);</code>
<code class="linenos">39 </code>      <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">num_categories</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">40 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">classifier</code><code class="p">.</code><code class="na">getCategory</code><code class="p">(</code><code class="n">i</code><code class="p">).</code><code class="na">equals</code><code class="p">(</code><code class="n">bestString</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos">41 </code>          <code class="k">return</code> <code class="k">new</code> <code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="n">Float</code><code class="o">&gt;</code><code class="p">(</code><code class="n">bestString</code><code class="p">,</code> <code class="p">(</code><code class="kt">float</code><code class="p">)</code><code class="n">scores</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos">42 </code>        <code class="p">}</code>
<code class="linenos">43 </code>      <code class="p">}</code>
<code class="linenos">44 </code>    <code class="p">}</code>
<code class="linenos">45 </code>    <code class="k">return</code> <code class="k">new</code> <code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code><code class="n">Float</code><code class="o">&gt;</code><code class="p">(</code><code class="s">"&lt;no category&gt;"</code><code class="p">,</code> <code class="mf">0f</code><code class="p">);</code>
<code class="linenos">46 </code>  <code class="p">}</code>
<code class="linenos">47 </code>  
<code class="linenos">48 </code>  <code class="kd">static</code> <code class="n">DoccatModel</code> <code class="n">docCatModel</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
<code class="linenos">49 </code>
<code class="linenos">50 </code>  <code class="kd">static</code> <code class="p">{</code>
<code class="linenos">51 </code>
<code class="linenos">52 </code>    <code class="k">try</code> <code class="p">{</code>
<code class="linenos">53 </code>      <code class="n">InputStream</code> <code class="n">modelIn</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-newscat.bin"</code><code class="p">);</code>
<code class="linenos">54 </code>      <code class="n">docCatModel</code> <code class="o">=</code> <code class="k">new</code> <code class="n">DoccatModel</code><code class="p">(</code><code class="n">modelIn</code><code class="p">);</code>
<code class="linenos">55 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">IOException</code> <code class="n">e</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">56 </code>      <code class="n">e</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code>
<code class="linenos">57 </code>    <code class="p">}</code>
<code class="linenos">58 </code>  <code class="p">}</code>
<code class="linenos">59 </code><code class="p">}</code>
</pre></div>

</figure>

<p>In lines 48-57 we initialize the static data for an instance of the class <strong>DoccatModel</strong> that loads the model file created in the last section.</p>

<p>A new instance of the class <strong>DocumentCategorizerME</strong> is created in line 28 each time we want to classify input text. I called the one argument constructor for this class that uses the default feature detector. An alternative constructor is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">public</code> <code class="nf">DocumentCategorizerME</code><code class="p">(</code><code class="n">DoccatModel</code> <code class="n">model</code><code class="p">,</code>
                             <code class="n">FeatureGenerator</code><code class="p">...</code> <code class="n">featureGenerators</code><code class="p">)</code>
</pre></div>

</figure>

<p>The default feature generator is <strong>BagOfWordsFeatureGenerator</strong> which just uses word frequencies for classification. This is reasonable for smaller training sets as we used in the last section but when I have a large amount of training data available I prefer to combine <strong>BagOfWordsFeatureGenerator</strong> with <strong>NGramFeatureGenerator</strong>. You would use the constructor call:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">public</code> <code class="nf">DocumentCategorizerME</code><code class="p">(</code><code class="n">DoccatModel</code> <code class="n">model</code><code class="p">,</code>
           <code class="k">new</code> <code class="n">FeatureGenerator</code><code class="o">[]</code><code class="p">{</code><code class="k">new</code> <code class="n">BagOfWordsFeatureGenerator</code><code class="p">(),</code>
                                  <code class="k">new</code> <code class="n">NGramFeatureGenerator</code><code class="p">()});</code>
</pre></div>

</figure>

<p>The following listings show interspersed both example code snippets for using the <strong>NewsClassifier</strong> class followed by the output printed by each code snippet:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="nt">String</code> <code class="nt">sentence</code> <code class="o">=</code> <code class="s2">"Apple Computer, Microsoft, and Google are in the tech sector.\</code>
<code class="s2"> Each is very profitable."</code><code class="o">;</code>
    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"\nNew test sentence:\n\n"</code> <code class="o">+</code> <code class="nt">sentence</code> <code class="o">+</code> <code class="s2">"\n"</code><code class="o">);</code>
    <code class="nt">String</code> <code class="cp">[]</code> <code class="nt">sentences</code> <code class="o">=</code> <code class="nt">NLP</code><code class="p">.</code><code class="nc">sentenceSplitter</code><code class="o">(</code><code class="nt">sentence</code><code class="o">);</code>
    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"Sentences found: "</code> <code class="o">+</code> <code class="nt">Arrays</code><code class="p">.</code><code class="nc">toString</code><code class="o">(</code><code class="nt">sentences</code><code class="o">));</code>

<code class="nt">New</code> <code class="nt">test</code> <code class="nt">sentence</code><code class="o">:</code>

<code class="nt">Apple</code> <code class="nt">Computer</code><code class="o">,</code> <code class="nt">Microsoft</code><code class="o">,</code> <code class="nt">and</code> <code class="nt">Google</code> <code class="nt">are</code> <code class="nt">in</code> <code class="nt">the</code> <code class="nt">tech</code> <code class="nt">sector</code><code class="o">.</code>
<code class="nt">Each</code> <code class="nt">is</code> <code class="nt">very</code> <code class="nt">profitable</code><code class="o">.</code>

<code class="nt">Sentences</code> <code class="nt">found</code><code class="o">:</code> <code class="cp">[</code><code class="nx">Apple</code> <code class="nx">Computer</code><code class="p">,</code> <code class="nx">Microsoft</code><code class="p">,</code> <code class="ow">and</code> <code class="nx">Google</code> <code class="n">are</code> <code class="k">in</code> <code class="nx">the</code> <code class="nx">tech</code> <code class="nx">sector.</code><code class="p">,</code>
                  <code class="nx">Each</code> <code class="nx">is</code> <code class="nx">very</code> <code class="nx">profitable.</code><code class="cp">]</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">sentence</code> <code class="o">=</code> <code class="s">"Apple Computer, Microsoft, and Google are in the tech sector."</code><code class="p">;</code>
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">names</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="n">companyNames</code><code class="p">(</code><code class="n">sentence</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="n">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"Company names found: "</code> <code class="o">+</code> <code class="n">names</code><code class="p">);</code>

<code class="n">Company</code> <code class="n">names</code> <code class="nl">found:</code> <code class="p">[</code><code class="n">Apple</code> <code class="n">Computer</code><code class="p">,</code> <code class="n">Microsoft</code><code class="p">]</code>

    <code class="n">sentence</code> <code class="o">=</code> <code class="s">"Apple Computer is located in Cupertino, California and Microsoft is \</code>
<code class="s">located in Seattle, Washington. He went to Oregon"</code><code class="p">;</code>
    <code class="n">System</code><code class="p">.</code><code class="n">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">New test sentence:</code><code class="se">\n\n</code><code class="s">"</code> <code class="o">+</code> <code class="n">sentence</code> <code class="o">+</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">names1</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="n">locationNames</code><code class="p">(</code><code class="n">sentence</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="n">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"Location names found: "</code> <code class="o">+</code> <code class="n">names1</code><code class="p">);</code>

<code class="n">New</code> <code class="n">test</code> <code class="nl">sentence:</code>

<code class="n">Apple</code> <code class="n">Computer</code> <code class="n">is</code> <code class="n">located</code> <code class="n">in</code> <code class="n">Cupertino</code><code class="p">,</code> <code class="n">California</code> <code class="k">and</code> <code class="n">Microsoft</code> <code class="n">is</code> <code class="n">located</code> <code class="n">in</code> <code class="n">Seatt</code>\
<code class="n">le</code><code class="p">,</code> <code class="n">Washington</code><code class="p">.</code> <code class="n">He</code> <code class="n">went</code> <code class="n">to</code> <code class="n">Oregon</code>

<code class="n">Location</code> <code class="n">names</code> <code class="nl">found:</code> <code class="p">[</code><code class="n">Oregon</code><code class="p">,</code> <code class="n">Cupertino</code><code class="p">,</code> <code class="n">Seattle</code><code class="p">,</code> <code class="n">California</code><code class="p">,</code> <code class="n">Washington</code><code class="p">]</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">sentence</code> <code class="o">=</code> <code class="s">"President Bill Clinton left office."</code><code class="p">;</code>
    <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">New test sentence:</code><code class="se">\n\n</code><code class="s">"</code> <code class="o">+</code> <code class="n">sentence</code> <code class="o">+</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">names2</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="n">personNames</code><code class="p">(</code><code class="n">sentence</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"Person names found: "</code> <code class="o">+</code> <code class="n">names2</code><code class="p">);</code>

<code class="n">New</code> <code class="n">test</code> <code class="nl">sentence</code><code class="p">:</code>

<code class="n">President</code> <code class="n">Bill</code> <code class="n">Clinton</code> <code class="n">left</code> <code class="n">office</code><code class="p">.</code>

<code class="n">Person</code> <code class="n">names</code> <code class="nl">found</code><code class="p">:</code> <code class="p">[</code><code class="n">Bill</code> <code class="n">Clinton</code><code class="p">]</code>

    <code class="n">sentence</code> <code class="o">=</code> <code class="s">"The White House is often mentioned in the news about U.S. foreign po\</code>
<code class="s">licy. Members of Congress and the President are worried about the next election and \</code>
<code class="s">may pander to voters by promising tax breaks. Diplomacy with Iran, Iraq, and North K\</code>
<code class="s">orea is non existent in spite of a worry about nuclear weapons. A uni-polar world re\</code>
<code class="s">fers to the hegemony of one country, often a militaristic empire. War started with a\</code>
<code class="s"> single military strike. The voting public wants peace not war. Democrats and Republ\</code>
<code class="s">icans argue about policy."</code><code class="p">;</code>
    <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">New test sentence:</code><code class="se">\n\n</code><code class="s">"</code> <code class="o">+</code> <code class="n">sentence</code> <code class="o">+</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">);</code>
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Pair</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">Double</code><code class="o">&gt;&gt;</code> <code class="n">results</code> <code class="o">=</code> <code class="n">NewsClassifier</code><code class="p">.</code><code class="n">allRankedCategories</code><code class="p">(</code><code class="n">sentence</code>\
<code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="k">out</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"All ranked categories found: "</code> <code class="o">+</code> <code class="n">results</code><code class="p">);</code>

<code class="n">New</code> <code class="n">test</code> <code class="nl">sentence</code><code class="p">:</code>

<code class="n">The</code> <code class="n">White</code> <code class="n">House</code> <code class="n">is</code> <code class="n">often</code> <code class="n">mentioned</code> <code class="k">in</code> <code class="n">the</code> <code class="n">news</code> <code class="n">about</code>  <code class="n">U</code><code class="p">.</code><code class="n">S</code><code class="p">.</code> <code class="n">foreign</code> <code class="n">policy</code><code class="p">.</code> <code class="n">Members</code> <code class="n">o</code>\
<code class="n">f</code> <code class="n">Congress</code> <code class="n">and</code> <code class="n">the</code> <code class="n">President</code> <code class="n">are</code> <code class="n">worried</code> <code class="n">about</code> <code class="n">the</code> <code class="n">next</code> <code class="n">election</code> <code class="n">and</code> <code class="n">may</code> <code class="n">pander</code> <code class="n">to</code> <code class="n">v</code>\
<code class="n">oters</code> <code class="n">by</code> <code class="n">promising</code> <code class="n">tax</code> <code class="n">breaks</code><code class="p">.</code> <code class="n">Diplomacy</code> <code class="n">with</code> <code class="n">Iran</code><code class="p">,</code> <code class="n">Iraq</code><code class="p">,</code> <code class="n">and</code> <code class="n">North</code> <code class="n">Korea</code> <code class="n">is</code> <code class="n">non</code> <code class="n">exi</code>\
<code class="n">stent</code> <code class="k">in</code> <code class="n">spite</code> <code class="n">of</code> <code class="n">a</code> <code class="n">worry</code> <code class="n">about</code> <code class="n">nuclear</code> <code class="n">weapons</code><code class="p">.</code> <code class="n">A</code> <code class="n">uni</code><code class="o">-</code><code class="n">polar</code> <code class="n">world</code> <code class="n">refers</code> <code class="n">to</code> <code class="n">the</code> <code class="n">heg</code>\
<code class="n">emony</code> <code class="n">of</code> <code class="n">one</code> <code class="n">country</code><code class="p">,</code> <code class="n">often</code> <code class="n">a</code> <code class="n">militaristic</code> <code class="n">empire</code><code class="p">.</code> <code class="n">War</code> <code class="n">started</code> <code class="n">with</code> <code class="n">a</code> <code class="n">single</code> <code class="n">militar</code>\
<code class="n">y</code> <code class="n">strike</code><code class="p">.</code> <code class="n">The</code> <code class="n">voting</code> <code class="n">public</code> <code class="n">wants</code> <code class="n">peace</code> <code class="n">not</code> <code class="n">war</code><code class="p">.</code> <code class="n">Democrats</code> <code class="n">and</code> <code class="n">Republicans</code> <code class="n">argue</code> <code class="n">abo</code>\
<code class="n">ut</code> <code class="n">policy</code><code class="p">.</code>

<code class="n">All</code> <code class="n">ranked</code> <code class="n">categories</code> <code class="nl">found</code><code class="p">:</code> <code class="p">[[</code><code class="n">COMPUTERS</code><code class="p">,</code> <code class="mf">0.07257665117660535</code><code class="p">],</code> <code class="p">[</code><code class="n">ECONOMY</code><code class="p">,</code> <code class="mf">0.23559821</code>\
<code class="mi">969425127</code><code class="p">],</code> <code class="p">[</code><code class="n">HEALTH</code><code class="p">,</code> <code class="mf">0.29907267186308945</code><code class="p">],</code> <code class="p">[</code><code class="n">POLITICS</code><code class="p">,</code> <code class="mf">0.39275245726605396</code><code class="p">]]</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="nt">sentence</code> <code class="o">=</code> <code class="s2">"The food affects colon cancer and ulcerative colitis. There is some \</code>
<code class="s2">evidence that sex helps keep us healthy. Eating antioxidant rich foods may prevent d\</code>
<code class="s2">esease. Smoking may raise estrogen levels in men and lead to heart failure."</code><code class="o">;</code>
    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"\nNew test sentence:\n\n"</code> <code class="o">+</code> <code class="nt">sentence</code> <code class="o">+</code> <code class="s2">"\n"</code><code class="o">);</code>
    <code class="nt">String</code> <code class="nt">results2</code> <code class="o">=</code> <code class="nt">NewsClassifier</code><code class="p">.</code><code class="nc">bestCategory</code><code class="o">(</code><code class="nt">sentence</code><code class="o">);</code>
    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"Best category found found (HEALTH): "</code> <code class="o">+</code> <code class="nt">results2</code><code class="o">);</code>
    <code class="nt">List</code><code class="o">&lt;</code><code class="nt">Pair</code><code class="o">&lt;</code><code class="nt">String</code><code class="o">,</code> <code class="nt">Double</code><code class="o">&gt;&gt;</code> <code class="nt">results3</code> <code class="o">=</code> <code class="nt">NewsClassifier</code><code class="p">.</code><code class="nc">allRankedCategories</code><code class="o">(</code><code class="nt">sentenc</code><code class="err">\</code>
<code class="nt">e</code><code class="o">);</code>
    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"All ranked categories found (HEALTH): "</code> <code class="o">+</code> <code class="nt">results3</code><code class="o">);</code>
    <code class="nt">System</code><code class="p">.</code><code class="nc">out</code><code class="p">.</code><code class="nc">println</code><code class="o">(</code><code class="s2">"Best category with score: "</code> <code class="o">+</code> <code class="nt">NewsClassifier</code><code class="p">.</code><code class="nc">classifyWithSco</code><code class="err">\</code>
<code class="nt">re</code><code class="o">(</code><code class="nt">sentence</code><code class="o">));</code>

<code class="nt">New</code> <code class="nt">test</code> <code class="nt">sentence</code><code class="o">:</code>

<code class="nt">The</code> <code class="nt">food</code> <code class="nt">affects</code> <code class="nt">colon</code> <code class="nt">cancer</code> <code class="nt">and</code> <code class="nt">ulcerative</code> <code class="nt">colitis</code><code class="o">.</code> <code class="nt">There</code> <code class="nt">is</code> <code class="nt">some</code> <code class="nt">evidence</code> <code class="nt">that</code> <code class="nt">se</code><code class="err">\</code>
<code class="nt">x</code> <code class="nt">helps</code> <code class="nt">keep</code> <code class="nt">us</code> <code class="nt">healthy</code><code class="o">.</code> <code class="nt">Eating</code> <code class="nt">antioxidant</code> <code class="nt">rich</code> <code class="nt">foods</code> <code class="nt">may</code> <code class="nt">prevent</code> <code class="nt">desease</code><code class="o">.</code> <code class="nt">Smoking</code> <code class="err">\</code>
<code class="nt">may</code> <code class="nt">raise</code> <code class="nt">estrogen</code> <code class="nt">levels</code> <code class="nt">in</code> <code class="nt">men</code> <code class="nt">and</code> <code class="nt">lead</code> <code class="nt">to</code> <code class="nt">heart</code> <code class="nt">failure</code><code class="o">.</code>

<code class="nt">Best</code> <code class="nt">category</code> <code class="nt">found</code> <code class="nt">found</code> <code class="o">(</code><code class="nt">HEALTH</code><code class="o">):</code> <code class="nt">HEALTH</code>
<code class="nt">All</code> <code class="nt">ranked</code> <code class="nt">categories</code> <code class="nt">found</code> <code class="o">(</code><code class="nt">HEALTH</code><code class="o">):</code> <code class="cp">[</code><code class="err">[</code><code class="nx">COMPUTERS</code><code class="p">,</code> <code class="mf">0.1578880260493374</code><code class="cp">]</code><code class="o">,</code> <code class="cp">[</code><code class="nx">ECONOMY</code><code class="p">,</code> <code class="mi">0</code><code class="nx">.</code><code class="o">\</code>
<code class="mi">2163099374638936</code><code class="cp">]</code><code class="o">,</code> <code class="cp">[</code><code class="nx">HEALTH</code><code class="p">,</code> <code class="mf">0.35546925520388845</code><code class="cp">]</code><code class="o">,</code> <code class="cp">[</code><code class="nx">POLITICS</code><code class="p">,</code> <code class="mf">0.27033278128288035</code><code class="cp">]</code><code class="o">]</code>
<code class="nt">Best</code> <code class="nt">category</code> <code class="nt">with</code> <code class="nt">score</code><code class="o">:</code> <code class="cp">[</code><code class="nx">HEALTH</code><code class="p">,</code> <code class="mf">0.35546926</code><code class="cp">]</code>
</pre></div>

</figure>

<p>As this example shows it is simple to train new classifier models once you have prepared training data. In my work I have often needed to train models customized for specific topics.</p>

<h3 id="leanpub-auto-using-the-opennlp-parsing-model">Using the OpenNLP Parsing Model</h3>

<p>We will use the parsing model that is included in the OpenNLP distribution to parse English language input text into syntax trees. You are unlikely to use a statistical parsing model in your work but I think you will enjoy the material in the section.</p>

<p>The following example code listing is long (68 lines) but I will explain the interesting parts after the listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.opennlp</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">opennlp.tools.cmdline.parser.ParserTool</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">opennlp.tools.parser.Parse</code><code class="p">;</code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">opennlp.tools.parser.ParserModel</code><code class="p">;</code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">opennlp.tools.parser.chunking.Parser</code><code class="p">;</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="kn">import</code> <code class="nn">java.io.FileInputStream</code><code class="p">;</code>
<code class="linenos"> 9 </code><code class="kn">import</code> <code class="nn">java.io.IOException</code><code class="p">;</code>
<code class="linenos">10 </code><code class="kn">import</code> <code class="nn">java.io.InputStream</code><code class="p">;</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="cm">/**</code>
<code class="linenos">13 </code><code class="cm"> * Experiments with the chunking parser model</code>
<code class="linenos">14 </code><code class="cm"> */</code>
<code class="linenos">15 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">ChunkingParserDemo</code> <code class="p">{</code>
<code class="linenos">16 </code>  <code class="kd">public</code> <code class="n">Parse</code><code class="o">[]</code> <code class="nf">parse</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">17 </code>    <code class="n">Parser</code> <code class="n">parser</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Parser</code><code class="p">(</code><code class="n">parserModel</code><code class="p">);</code>
<code class="linenos">18 </code>    <code class="k">return</code> <code class="n">ParserTool</code><code class="p">.</code><code class="na">parseLine</code><code class="p">(</code><code class="n">text</code><code class="p">,</code> <code class="n">parser</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>
<code class="linenos">19 </code>  <code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">prettyPrint</code><code class="p">(</code><code class="n">Parse</code> <code class="n">p</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">22 </code>    <code class="n">StringBuffer</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuffer</code><code class="p">();</code>
<code class="linenos">23 </code>    <code class="n">p</code><code class="p">.</code><code class="na">show</code><code class="p">(</code><code class="n">sb</code><code class="p">);</code>
<code class="linenos">24 </code>    <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">()</code> <code class="o">+</code> <code class="s">" "</code><code class="p">;</code>
<code class="linenos">25 </code>    <code class="kt">int</code> <code class="n">depth</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="linenos">26 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">size</code> <code class="o">=</code> <code class="n">s</code><code class="p">.</code><code class="na">length</code><code class="p">()</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">size</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">27 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">==</code> <code class="sc">' '</code> <code class="o">&amp;&amp;</code> <code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">==</code> <code class="sc">'('</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">28 </code>        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
<code class="linenos">29 </code>        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">j</code> <code class="o">&lt;</code> <code class="n">depth</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code> <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"  "</code><code class="p">);</code>
<code class="linenos">30 </code>      <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">==</code> <code class="sc">'('</code><code class="p">)</code> <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">));</code>
<code class="linenos">31 </code>      <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">!=</code> <code class="sc">')'</code> <code class="o">||</code> <code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)</code> <code class="o">==</code> <code class="sc">')'</code><code class="p">)</code>
<code class="linenos">32 </code>        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">));</code>
<code class="linenos">33 </code>      <code class="k">else</code> <code class="p">{</code>
<code class="linenos">34 </code>        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">));</code>
<code class="linenos">35 </code>        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">j</code> <code class="o">&lt;</code> <code class="n">depth</code><code class="p">;</code> <code class="n">j</code><code class="o">++</code><code class="p">)</code> <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">print</code><code class="p">(</code><code class="s">"  "</code><code class="p">);</code>
<code class="linenos">36 </code>      <code class="p">}</code>
<code class="linenos">37 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">==</code> <code class="sc">'('</code><code class="p">)</code> <code class="n">depth</code><code class="o">++</code><code class="p">;</code>
<code class="linenos">38 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">charAt</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">==</code> <code class="sc">')'</code><code class="p">)</code> <code class="n">depth</code><code class="o">--</code><code class="p">;</code>
<code class="linenos">39 </code>    <code class="p">}</code>
<code class="linenos">40 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">();</code>
<code class="linenos">41 </code>  <code class="p">}</code>
<code class="linenos">42 </code>
<code class="linenos">43 </code>  <code class="kd">static</code> <code class="n">ParserModel</code> <code class="n">parserModel</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
<code class="linenos">44 </code>
<code class="linenos">45 </code>  <code class="kd">static</code> <code class="p">{</code>
<code class="linenos">46 </code>
<code class="linenos">47 </code>    <code class="k">try</code> <code class="p">{</code>
<code class="linenos">48 </code>      <code class="n">InputStream</code> <code class="n">modelIn</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileInputStream</code><code class="p">(</code><code class="s">"models/en-parser-chunking.bin"</code><code class="p">);</code>
<code class="linenos">49 </code>      <code class="n">parserModel</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ParserModel</code><code class="p">(</code><code class="n">modelIn</code><code class="p">);</code>
<code class="linenos">50 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">IOException</code> <code class="n">e</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">51 </code>      <code class="n">e</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code>
<code class="linenos">52 </code>    <code class="p">}</code>
<code class="linenos">53 </code>  <code class="p">}</code>
<code class="linenos">54 </code>
<code class="linenos">55 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">56 </code>    <code class="n">ChunkingParserDemo</code> <code class="n">cpd</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ChunkingParserDemo</code><code class="p">();</code>
<code class="linenos">57 </code>    <code class="n">Parse</code><code class="o">[]</code> <code class="n">possibleParses</code> <code class="o">=</code>
<code class="linenos">58 </code>      <code class="n">cpd</code><code class="p">.</code><code class="na">parse</code><code class="p">(</code><code class="s">"John Smith went to the store on his way home from work "</code><code class="p">);</code>
<code class="linenos">59 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">Parse</code> <code class="n">p</code> <code class="p">:</code> <code class="n">possibleParses</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">60 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"parse:\n"</code><code class="p">);</code>
<code class="linenos">61 </code>      <code class="n">p</code><code class="p">.</code><code class="na">show</code><code class="p">();</code>
<code class="linenos">62 </code>      <code class="c1">//p.showCodeTree();</code>
<code class="linenos">63 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\npretty printed parse:\n"</code><code class="p">);</code>
<code class="linenos">64 </code>      <code class="n">cpd</code><code class="p">.</code><code class="na">prettyPrint</code><code class="p">(</code><code class="n">p</code><code class="p">);</code>
<code class="linenos">65 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
<code class="linenos">66 </code>    <code class="p">}</code>
<code class="linenos">67 </code>  <code class="p">}</code>
<code class="linenos">68 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The OpenNLP parsing model is read from a file in lines 45 through 53. The static variable <strong>parserModel</strong> (instance of class <strong>ParserModel</strong>) if created in line 49 and used in lines 17 and 18 to parse input text. It is instructive to look at the intermediate calculation results. The value for variable parser defined in line 17 has a value of:</p>

<p>Note that the parser returned 5 different results because we specified this number in line 18. For a long sentence the parser generates a very large number of possible parses for the sentence and returns, in order of probability of being correct, the number of results we requested.</p>

<p>The OpenNLP chunking parser code prints out results in a flat list, one result on a line. This is difficult to read which is why I wrote the method <strong>prettyPrint</strong> (lines 21 through 41) to print the parse results indented. Here is the output from the last code example (the first parse shown is all on one line but line wraps in the following listing):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>parse:

(TOP (S (NP (NNP John) (NNP Smith)) (VP (VBD went) (PP (TO to) (NP (DT the) (NN stor\
e))) (PP (IN on) (NP (NP (NP (PRP$ his) (NN way)) (ADVP (NN home))) (PP (IN from) (N\
P (NN work))))))))

pretty printed parse:

(TOP
  (S
    (NP
      (NNP John)        
      (NNP Smith))      
    (VP
      (VBD went)        
      (PP
        (TO to)          
        (NP
          (DT the)            
          (NN store)))        
      (PP
        (IN on)          
        (NP
          (NP
            (NP
              (PRP$ his)                
              (NN way))              
            (ADVP
              (NN home)))            
          (PP
            (IN from)              
            (NP
              (NN work))))))))
</pre></div>

</figure>

<p>In the 1980s I spent much time on syntax level parsing. I no longer find these models very relevant to my own work.</p>

<p>OpenNLP is a good resource for Java programmers and its Apache 2 license is “business friendly.” If you can use software with a GPL license then please also look at the <a href="https://nlp.stanford.edu/software/">Stanford NLP libraries</a>.</p>


<h2 id="leanpub-auto-combining-the-wordnet-linguistic-database-with-opennlp">Combining the WordNet Linguistic Database With OpenNLP</h2>

<p>Here we build on the material from the last chapter by using OpenNLP to process input text to identify parts of speech and then looking up words with their parts of speech in WordNet. You can use WordNet to look up all uses of a word so using OpenNLP as we do here is not required but I think makes a good example of blending libraries.</p>

<p>The WordNet linguistic database is complex and you may want to review the <a href="https://wordnet.princeton.edu/documentation">WordNet documentation</a> after working through the following example of finding synonyms and hypernyms for nouns in text input.</p>

<h3 id="stat-nlp-wordnet">Using the WordNet Linguistic Database</h3>

<p>The Maven <strong>pom.xml</strong> file (that we will look at later) for this example is configured to download both the WordNet data and the <a href="https://github.com/extjwnl/extjwnl"><strong>extjwnl</strong></a> library. The home page for the WordNet project is <a href="http://wordnet.princeton.edu">http://wordnet.princeton.edu</a>.</p>

<h4 id="leanpub-auto-tutorial-on-wordnet">Tutorial on WordNet</h4>

<p>The WordNet lexical database is an ongoing research project spanning decades that includes many years of effort by professional linguists. My own use of WordNet over the last twenty years has been simple, mainly using the database to determine synonyms (called synsets in WordNet) and looking at the possible parts of speech of words. For reference from a <a href="https://en.wikipedia.org/wiki/WordNet">Wikipedia article on WordNet</a>, here is a small subset of the type of relationships contained in WordNet for nouns (we will look at relations for verbs, adjectives, and adverbs at the end of this chapter):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">hypernyms</code>
<code class="o">:</code>   <code class="n">parent</code> <code class="k">is</code> <code class="n">a</code> <code class="n">hypernym</code> <code class="n">of</code> <code class="n">mother</code> <code class="n">since</code> <code class="n">every</code> <code class="n">mother</code> <code class="k">is</code> <code class="n">of</code> <code class="n">type</code> <code class="n">parent</code>

<code class="n">hyponyms</code>
<code class="o">:</code>   <code class="n">father</code> <code class="o">(</code><code class="n">less</code> <code class="n">general</code><code class="o">)</code> <code class="k">is</code> <code class="n">a</code> <code class="n">hyponym</code> <code class="n">of</code> <code class="n">parent</code> <code class="o">(</code><code class="n">more</code> <code class="n">general</code><code class="o">)</code>

<code class="n">holonym</code>
<code class="o">:</code>   <code class="n">building</code> <code class="k">is</code> <code class="n">a</code> <code class="n">holonym</code> <code class="n">of</code> <code class="n">window</code> <code class="n">because</code> <code class="n">a</code> <code class="n">window</code> <code class="k">is</code> <code class="n">part</code> <code class="n">of</code> <code class="n">a</code>
    <code class="n">building</code>

<code class="n">meronym</code>
<code class="o">:</code>   <code class="n">window</code> <code class="k">is</code> <code class="n">a</code> <code class="n">meronym</code> <code class="n">of</code> <code class="n">building</code> <code class="n">because</code> <code class="n">a</code> <code class="n">window</code> <code class="k">is</code> <code class="n">part</code> <code class="n">of</code> <code class="n">a</code>
    <code class="n">building</code>
</pre></div>

</figure>

<p>I find the WordNet book (<em>WordNet: An Electronic Lexical Database (Language, Speech, and Communication)</em> by Christiane Fellbaum, 1998) to be a detailed reference for WordNet but there have been several new releases of WordNet since the book was published. The WordNet site and the Wikipedia article on WordNet are also good sources of information if you decide to make WordNet part of your toolkit.</p>

<p>When you look up words in WordNet you can optionally specify one of the following parts of speech (POS):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">POS</code><code class="p">.</code><code class="na">NOUN</code>
    <code class="n">POS</code><code class="p">.</code><code class="na">VERB</code>
    <code class="n">POS</code><code class="p">.</code><code class="na">ADJECTIVE</code>
    <code class="n">POS</code><code class="p">.</code><code class="na">ADVERB</code>
</pre></div>

</figure>

<p>Rather than using Open NLP in this example to find nouns, we could try all four possible parts of speech on every input word. I was motivated to use OpenNLP partly because I wanted to provide an example of reusing a library developed in a different chapter, in this case the previous chapter on OpenNLP.</p>

<p>What are hypernyms?  A hypernym is in a semantic type-of relationship with another word that is more general. As an example, the word “country” is a hypernym of the word “Mexico.” The opposite of hypernym is a hyponym, that is a hyponym has a more narrow meaning. The word “country” is a hyponym of the word “Mexico.”</p>

<p>The following example is simple. We only look up WordNet hypernyms and synonyms entries for nouns and for nouns. In the chapter wrap-up I will give you some ideas for more extended projects that you may want to do using WordNet.</p>

<p>Before diving into the code I want to show you what the generated synonym and hypernym data looks like.</p>

<p>The following two figures show the generated structured output data in a IntelliJ Community Edition debug session, in particular look at the structure of <strong>synonymMap</strong>. While I rarely use the debugger to actually debug code, I frequently us it to inspect data.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 467px">
    <img src="images/wordnet-synonym.png" alt="WordNet example: examining generated synonym data" style="width: 100%">
    <figcaption>WordNet example: examining generated synonym data</figcaption>
  </figure>
</div>


<p>Here is a closeup showing generated data in the variable <strong>hypernymMap</strong>:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/wordnet-hypernym.png" alt="WordNet example: examining generated hypernym data using the IntelliJ debugger" style="width: 100%">
    <figcaption>WordNet example: examining generated hypernym data using the IntelliJ debugger</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-installing-the-libraries-and-linguistic-data-for-this-example">Installing the Libraries and Linguistic Data for this Example</h3>

<p>The maven <strong>pom.xml</strong> configuration file for this project contains the following requirements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="nt">&lt;dependency&gt;</code>
            <code class="nt">&lt;groupId&gt;</code>net.sf.extjwnl<code class="nt">&lt;/groupId&gt;</code>
            <code class="nt">&lt;artifactId&gt;</code>extjwnl<code class="nt">&lt;/artifactId&gt;</code>
            <code class="nt">&lt;version&gt;</code>2.0.2<code class="nt">&lt;/version&gt;</code>
        <code class="nt">&lt;/dependency&gt;</code>
        <code class="c">&lt;!-- Princeton WordNet 3.1 data dependency --&gt;</code>
        <code class="nt">&lt;dependency&gt;</code>
            <code class="nt">&lt;groupId&gt;</code>net.sf.extjwnl<code class="nt">&lt;/groupId&gt;</code>
            <code class="nt">&lt;artifactId&gt;</code>extjwnl-data-wn31<code class="nt">&lt;/artifactId&gt;</code>
            <code class="nt">&lt;version&gt;</code>1.2<code class="nt">&lt;/version&gt;</code>
        <code class="nt">&lt;/dependency&gt;</code>
</pre></div>

</figure>

<p>The second dependency loads the WordNet linguistic database.</p>

<p>I assume that you have performed a maven install for the project in the last chapter:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>push ~../opennlp
mvn install -DskipTests
popd
</pre></div>

</figure>

<p>We also need the OpenNLP library and my OpenNLP wrapper library developed in the last chapter:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>        <code class="nt">&lt;dependency&gt;</code>
            <code class="nt">&lt;groupId&gt;</code>opennlp<code class="nt">&lt;/groupId&gt;</code>
            <code class="nt">&lt;artifactId&gt;</code>tools<code class="nt">&lt;/artifactId&gt;</code>
            <code class="nt">&lt;version&gt;</code>1.5.0<code class="nt">&lt;/version&gt;</code>
        <code class="nt">&lt;/dependency&gt;</code>
        <code class="nt">&lt;dependency&gt;</code>
            <code class="nt">&lt;groupId&gt;</code>com.markwatson<code class="nt">&lt;/groupId&gt;</code>
            <code class="nt">&lt;artifactId&gt;</code>opennlp<code class="nt">&lt;/artifactId&gt;</code>
            <code class="nt">&lt;version&gt;</code>1.0-SNAPSHOT<code class="nt">&lt;/version&gt;</code>
        <code class="nt">&lt;/dependency&gt;</code>
</pre></div>

</figure>

<p>There is a <strong>Makefile</strong> for running the example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="n">example</code><code class="o">:</code>
 <code class="n">mvn</code> <code class="n">install</code>
 <code class="n">mvn</code> <code class="n">exec</code><code class="o">:</code><code class="n">java</code>  <code class="o">\</code>
    <code class="o">-</code><code class="n">Dexec</code><code class="o">.</code><code class="na">mainClass</code><code class="o">=</code><code class="s2">"com.markwatson.wordnet_example.WordNetAndOpenNlpExample"</code>
</pre></div>

</figure>

<p>Run the example using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>make example
</pre></div>

</figure>

<p>The example identifies all nouns (in the example code they are: President, cat, Bill, Mexico, dog, and Clinton) and for each noun finds all WordNet “word senses.” The noun “Mexico” only has  one word sense while the noun “cat” has eight word senses.</p>

<p>For each word sense (for each noun) the example code returns a list of strings where the first element is a descriptive “word gloss” for the particular sense and the remaining strings are hypernyms or synonyms depending whether we are calling the functions <strong>getHypernyms</strong> or <strong>getSynonyms</strong> whose method signatures are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kd">static</code> <code class="kd">public</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code> <code class="nf">getHypernyms</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code>
              <code class="kd">throws</code> <code class="n">JWNLException</code> <code class="p">{</code>
<code class="kd">static</code> <code class="kd">public</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code> <code class="nf">getSynonyms</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code>
              <code class="kd">throws</code> <code class="n">JWNLException</code> <code class="p">{</code>
</pre></div>

</figure>

<p>The following UML class diagram shows this public API for the example code. There is only one source file in this example <strong>WordNetAndOpenNlpExample.java</strong> because our goal here is not building a reusable library, rather to provide a short example and a “starter project” for your own experiments. That said this project does get installed as a local Maven library so you can require the library and call <strong>getHypernyms</strong> and <strong>getSynonyms</strong> in other projects. I will later suggest further projects in the wrap-up.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/wordnet-uml.png" alt="UML class diagram for WordNet example" style="width: 100%">
    <figcaption>UML class diagram for WordNet example</figcaption>
  </figure>
</div>


<p>The values returned from both <strong>getHypernyms</strong> and <strong>getSynonyms</strong> are maps where the keys are nouns in the input text. The map value for each key (a noun) will be a list, one element for each word sense for the noun. Each of these sub-lists is a list of strings where the first element is the gloss for the word sense and the remaining strings are either hypernyms or synonyms depending of which function is called.</p>

<p>Let’s look at the word “Clinton” which has four different word senses; here we list the gloss for each word sense:</p>

<ul>
  <li>wife of President Clinton and later a woman member of the United States Senate (1947-)</li>
  <li>42nd President of the United States (1946-)</li>
  <li>United States politician who as governor of New York supported the project to build the Erie Canal (1769-1828)</li>
  <li>a town in east central Iowa</li>
</ul>

<p>As an example, the hypernyms for the first word sense are: legislator, state senator, Clinton, Hiliary Clinton, etc.</p>

<p>WordNet is a linguistic database for automating the processing of text and does contain some “real world” knowledge but does not have the wide coverage of semantic web knowledge graphs like DBPedia and WikiData. We will discuss the semantic web and Knowledge Graphs in later chapters as a source of information. Here we seek ways to understand words in text.</p>

<p>Here is a small segment of the output of the example program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">****</code> <code class="nt">Hypernyms</code><code class="o">:</code>

<code class="p">{</code><code class="err">President=</code><code class="cp">[</code><code class="err">[</code><code class="nx">an</code> <code class="nx">executive</code> <code class="nx">officer</code> <code class="nx">of</code> <code class="nx">a</code> <code class="nx">firm</code> <code class="ow">or</code> <code class="nx">corporation</code><code class="p">,</code> <code class="nx">executive</code><code class="p">,</code> <code class="nx">executive</code> <code class="nb">dir</code><code class="o">\</code>
<code class="nx">ector</code><code class="p">,</code> <code class="nx">chairman</code> <code class="nx">of</code> <code class="nx">the</code> <code class="nx">board</code><code class="p">,</code> <code class="nx">chief</code> <code class="nx">executive</code> <code class="nx">officer</code><code class="p">,</code> <code class="nx">CEO</code><code class="p">,</code> <code class="nx">chief</code> <code class="nx">operating</code> <code class="nx">officer</code><code class="p">,</code><code class="o">\</code>
 <code class="nx">chief</code> <code class="nx">financial</code> <code class="nx">officer</code><code class="p">,</code> <code class="nx">CFO</code><code class="p">,</code> <code class="nx">insider</code><code class="p">,</code> <code class="nx">president</code><code class="cp">]</code><code class="err">,</code> 
 <code class="err">...</code>
 
 <code class="err">****</code> <code class="n">Synonyms</code><code class="p">:</code>

<code class="err">{</code><code class="n">President</code><code class="o">=</code><code class="cp">[</code><code class="err">[</code><code class="nx">an</code> <code class="nx">executive</code> <code class="nx">officer</code> <code class="nx">of</code> <code class="nx">a</code> <code class="nx">firm</code> <code class="ow">or</code> <code class="nx">corporation</code><code class="p">,</code> <code class="nx">president</code><code class="cp">]</code><code class="p">,</code> <code class="cp">[</code><code class="nx">the</code> <code class="nx">person</code> <code class="o">\</code>
<code class="nx">who</code> <code class="nx">holds</code> <code class="nx">the</code> <code class="nx">office</code> <code class="nx">of</code> <code class="nx">head</code> <code class="nx">of</code> <code class="nx">state</code> <code class="nx">of</code> <code class="nx">the</code> <code class="nx">United</code> <code class="nx">States</code> <code class="nx">government</code><code class="p">;</code> <code class="s2">"the Presiden</code><code class="se">\</code><code class="s2"></code>
<code class="s2">t likes to jog every morning"</code><code class="p">,</code> <code class="nx">President</code> <code class="nx">of</code> <code class="nx">the</code> <code class="nx">United</code> <code class="nx">States</code><code class="p">,</code> <code class="nx">United</code> <code class="nx">States</code> <code class="nx">Preside</code><code class="o">\</code>
<code class="nx">nt</code><code class="p">,</code> <code class="nx">President</code><code class="p">,</code> <code class="nx">Chief</code> <code class="nx">Executive</code><code class="cp">]</code><code class="p">,</code> <code class="cp">[</code><code class="nx">the</code> <code class="nx">chief</code> <code class="nx">executive</code> <code class="nx">of</code> <code class="nx">a</code> <code class="nx">republic</code><code class="p">,</code> <code class="nx">president</code><code class="cp">]</code><code class="p">,</code> 
 <code class="o">...</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-implementation">Implementation</h3>

<p>You will never need to instantiate an instance of the class <strong>WordNetAndOpenNlpExample</strong> because all data is static class data and the two public methods are both static. The methods <strong>getHypernyms</strong> (lines 27-58) and <strong>getSynonyms</strong> (lines 60-81) are similar except the APIs for getting synonyms (lines 68-69) differ than those for getting hypernyms (lines 39-43). These two methods could be combined into a single method with an argument to control which APIs to use but I thought the code looked simpler as it is.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.wordnet_example</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">com.markwatson.opennlp.NLP</code><code class="p">;</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">net.sf.extjwnl.JWNLException</code><code class="p">;</code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">net.sf.extjwnl.data.*</code><code class="p">;</code>
<code class="linenos"> 7 </code><code class="kn">import</code> <code class="nn">net.sf.extjwnl.data.list.PointerTargetNode</code><code class="p">;</code>
<code class="linenos"> 8 </code><code class="kn">import</code> <code class="nn">net.sf.extjwnl.dictionary.Dictionary</code><code class="p">;</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="kn">import</code> <code class="nn">java.util.*</code><code class="p">;</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">WordNetAndOpenNlpExample</code> <code class="p">{</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code>  <code class="kd">private</code> <code class="nf">WordNetAndOpenNlpExample</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>  <code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>  <code class="kd">static</code> <code class="n">Dictionary</code> <code class="n">dictionary</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
<code class="linenos">18 </code>  <code class="kd">static</code> <code class="p">{</code>
<code class="linenos">19 </code>    <code class="k">try</code> <code class="p">{</code>
<code class="linenos">20 </code>      <code class="n">dictionary</code> <code class="o">=</code> <code class="n">Dictionary</code><code class="p">.</code><code class="na">getDefaultResourceInstance</code><code class="p">();</code>
<code class="linenos">21 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">JWNLException</code> <code class="n">e</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">22 </code>      <code class="n">e</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code>
<code class="linenos">23 </code>      <code class="n">System</code><code class="p">.</code><code class="na">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
<code class="linenos">24 </code>    <code class="p">}</code>
<code class="linenos">25 </code>  <code class="p">}</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code> <code class="nf">getHypernyms</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code>
<code class="linenos">28 </code>      <code class="kd">throws</code> <code class="n">JWNLException</code> <code class="p">{</code>
<code class="linenos">29 </code>    <code class="n">Map</code> <code class="n">hypernymMap</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code><code class="p">();</code>
<code class="linenos">30 </code>    <code class="n">String</code><code class="o">[]</code> <code class="n">tokens</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="na">tokenize</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="linenos">31 </code>    <code class="n">String</code><code class="o">[]</code> <code class="n">pos</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="na">POS</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="linenos">32 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">tokens</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">33 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">.</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"N"</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos">34 </code>        <code class="n">IndexWord</code> <code class="n">iw</code> <code class="o">=</code> <code class="n">dictionary</code><code class="p">.</code><code class="na">getIndexWord</code><code class="p">(</code><code class="n">POS</code><code class="p">.</code><code class="na">NOUN</code><code class="p">,</code> <code class="n">tokens</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos">35 </code>        <code class="n">List</code> <code class="n">hypernymList</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code><code class="p">();</code>
<code class="linenos">36 </code>        <code class="k">for</code> <code class="p">(</code><code class="n">Synset</code> <code class="n">aSense</code> <code class="p">:</code> <code class="n">iw</code><code class="p">.</code><code class="na">getSenses</code><code class="p">())</code> <code class="p">{</code>
<code class="linenos">37 </code>          <code class="n">List</code> <code class="n">lemmaList</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code><code class="p">();</code>
<code class="linenos">38 </code>          <code class="n">lemmaList</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">aSense</code><code class="p">.</code><code class="na">getGloss</code><code class="p">());</code>
<code class="linenos">39 </code>          <code class="k">for</code> <code class="p">(</code><code class="n">PointerTargetNode</code> <code class="n">ptn</code> <code class="p">:</code> <code class="n">PointerUtils</code><code class="p">.</code><code class="na">getDirectHypernyms</code><code class="p">(</code><code class="n">aSense</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos">40 </code>            <code class="n">List</code><code class="o">&lt;</code><code class="n">PointerTarget</code><code class="o">&gt;</code> <code class="n">pthTargets</code> <code class="o">=</code> <code class="n">ptn</code><code class="p">.</code><code class="na">getPointerTarget</code><code class="p">().</code><code class="na">getTargets</code><code class="p">();</code>
<code class="linenos">41 </code>            <code class="k">for</code> <code class="p">(</code><code class="n">Object</code> <code class="n">pt</code> <code class="p">:</code> <code class="n">pthTargets</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">42 </code>              <code class="k">try</code> <code class="p">{</code>
<code class="linenos">43 </code>                <code class="n">Synset</code> <code class="n">spt</code> <code class="o">=</code> <code class="p">(</code><code class="n">Synset</code><code class="p">)</code> <code class="n">pt</code><code class="p">;</code>
<code class="linenos">44 </code>                <code class="n">List</code><code class="o">&lt;</code><code class="n">Word</code><code class="o">&gt;</code> <code class="n">words</code> <code class="o">=</code> <code class="n">spt</code><code class="p">.</code><code class="na">getWords</code><code class="p">();</code>
<code class="linenos">45 </code>                <code class="k">for</code> <code class="p">(</code><code class="n">Word</code> <code class="n">word</code> <code class="p">:</code> <code class="n">words</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">46 </code>                  <code class="n">lemmaList</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">word</code><code class="p">.</code><code class="na">getLemma</code><code class="p">());</code>
<code class="linenos">47 </code>                <code class="p">}</code>
<code class="linenos">48 </code>              <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ignore</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">49 </code>              <code class="p">}</code>
<code class="linenos">50 </code>            <code class="p">}</code>
<code class="linenos">51 </code>          <code class="p">}</code>
<code class="linenos">52 </code>          <code class="n">hypernymList</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">lemmaList</code><code class="p">);</code>
<code class="linenos">53 </code>        <code class="p">}</code>
<code class="linenos">54 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">hypernymList</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="n">hypernymMap</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">tokens</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">,</code> <code class="n">hypernymList</code><code class="p">);</code>
<code class="linenos">55 </code>      <code class="p">}</code>
<code class="linenos">56 </code>    <code class="p">}</code>
<code class="linenos">57 </code>    <code class="k">return</code> <code class="n">hypernymMap</code><code class="p">;</code>
<code class="linenos">58 </code>  <code class="p">}</code>
<code class="linenos">59 </code>
<code class="linenos">60 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code> <code class="nf">getSynonyms</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code>
<code class="linenos">61 </code>      <code class="kd">throws</code> <code class="n">JWNLException</code> <code class="p">{</code>
<code class="linenos">62 </code>    <code class="n">Map</code> <code class="n">synonymMap</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;&gt;</code><code class="p">();</code>
<code class="linenos">63 </code>    <code class="n">String</code><code class="o">[]</code> <code class="n">tokens</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="na">tokenize</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="linenos">64 </code>    <code class="n">String</code><code class="o">[]</code> <code class="n">pos</code> <code class="o">=</code> <code class="n">NLP</code><code class="p">.</code><code class="na">POS</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="linenos">65 </code>    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">tokens</code><code class="p">.</code><code class="na">length</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">66 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">pos</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">.</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"N"</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos">67 </code>        <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">lemmaList</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code><code class="p">();</code>
<code class="linenos">68 </code>        <code class="n">IndexWord</code> <code class="n">iw</code> <code class="o">=</code> <code class="n">dictionary</code><code class="p">.</code><code class="na">getIndexWord</code><code class="p">(</code><code class="n">POS</code><code class="p">.</code><code class="na">NOUN</code><code class="p">,</code> <code class="n">tokens</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">);</code>
<code class="linenos">69 </code>        <code class="k">for</code> <code class="p">(</code><code class="n">Synset</code> <code class="n">aSense</code> <code class="p">:</code> <code class="n">iw</code><code class="p">.</code><code class="na">getSenses</code><code class="p">())</code> <code class="p">{</code>
<code class="linenos">70 </code>          <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">lemmas</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
<code class="linenos">71 </code>          <code class="n">lemmas</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">aSense</code><code class="p">.</code><code class="na">getGloss</code><code class="p">());</code>
<code class="linenos">72 </code>          <code class="k">for</code> <code class="p">(</code><code class="n">Word</code> <code class="n">word</code> <code class="p">:</code> <code class="n">aSense</code><code class="p">.</code><code class="na">getWords</code><code class="p">())</code> <code class="p">{</code>
<code class="linenos">73 </code>            <code class="n">lemmas</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">word</code><code class="p">.</code><code class="na">getLemma</code><code class="p">());</code>
<code class="linenos">74 </code>          <code class="p">}</code>
<code class="linenos">75 </code>          <code class="n">lemmaList</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">lemmas</code><code class="p">);</code>
<code class="linenos">76 </code>        <code class="p">}</code>
<code class="linenos">77 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">lemmaList</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="n">synonymMap</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">tokens</code><code class="o">[</code><code class="n">i</code><code class="o">]</code><code class="p">,</code> <code class="n">lemmaList</code><code class="p">);</code>
<code class="linenos">78 </code>      <code class="p">}</code>
<code class="linenos">79 </code>    <code class="p">}</code>
<code class="linenos">80 </code>    <code class="k">return</code> <code class="n">synonymMap</code><code class="p">;</code>
<code class="linenos">81 </code>  <code class="p">}</code>
<code class="linenos">82 </code>
<code class="linenos">83 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code>
<code class="linenos">84 </code>      <code class="kd">throws</code> <code class="n">JWNLException</code> <code class="p">{</code>
<code class="linenos">85 </code>    <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="s">"The cat, and dog, ran after President Bill Clinton in Mexico"</code><code class="p">;</code>
<code class="linenos">86 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n**** Hypernyms:\n"</code><code class="p">);</code>
<code class="linenos">87 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">getHypernyms</code><code class="p">(</code><code class="n">s</code><code class="p">));</code>
<code class="linenos">88 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n**** Synonyms:\n"</code><code class="p">);</code>
<code class="linenos">89 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">getSynonyms</code><code class="p">(</code><code class="n">s</code><code class="p">));</code>
<code class="linenos">90 </code>  <code class="p">}</code>
<code class="linenos">91 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The Java class <strong>PointerTargetNode</strong> (line 39) contains two instance variables: a <strong>Sysnset</strong> and a pointer type (e.g., noun or verb). The class <strong>Synset</strong> contains a part of speech (e.g., a noun), pointers to related synsets, descriptive words (or lemmas) for the synset, and a descriptive gloss that we have seen examples of. The class <strong>IndexWord</strong> contains a part of speech for the current word sense, a descriptive word (lemma) and a list of available synsets.</p>

<p>Earlier you saw two screen shots examining the output data in a IntelliJ Community Edition debug session. To better understand the Java interface to WordNet, I suggest also setting breakpoints to examine the data structures used by the <strong>net.sf.extjwnl</strong> library, especially the Java classes <strong>net.sf.extjwnl.data</strong> and <strong>net.sf.extjwnl.data.IndexWord</strong>. </p>

<h3 id="leanpub-auto-other-type-relationships-supported-by-wordnet">Other Type Relationships Supported by WordNet</h3>

<p>For reference (from the <a href="http://en.wikipedia.org/wiki/WordNet">Wikipedia article on WordNet</a>), here is a small subset of the type of relationships contained in WordNet for verbs shown by examples (also from the <a href="http://en.wikipedia.org/wiki/WordNet">Wikipedia article</a>):</p>

<ul>
  <li>hypernym: travel (less general) is an hypernym of movement (more general)</li>
  <li>entailment: to sleep is entailed by to snore because you must be asleep to snore</li>
</ul>

<p>Here are a few of the relations supported for nouns:</p>

<ul>
  <li>hypernyms: canine is a hypernym of dog since every dog is of type canine</li>
  <li>hyponyms: dog (less general) is a hyponym of canine (more general)</li>
  <li>holonym : building is a holonym of window because a window is part of a building</li>
  <li>meronym: window is a meronym of building because a window is part of a building</li>
</ul>

<p>Some of the related information maintained for adjectives is:</p>

<ul>
  <li>related nouns:</li>
  <li>similar to</li>
</ul>

<p>As mentioned before, I find the book <strong>WordNet: An Electronic Lexical Database (Language, Speech, and Communication)</strong> useful as is the <a href="http://wordnet.princeton.edu/">WordNet site</a> and the <a href="http://en.wikipedia.org/wiki/WordNet">Wikipedia article on WordNet</a>. I hope that I have motivated you, dear reader, to make WordNet and OpenNLP parts of your toolkit.</p>

<h3 id="leanpub-auto-wrap-up-and-ideas-for-using-wordnet">Wrap-up and Ideas for Using WordNet</h3>

<p>WordNet provides a rich linguistic database for human linguists but although I have been using WordNet since 1999, I do not often use it in automated systems. I tend to use it for manual reference and sometimes for simple tasks like augmenting a list of terms with synonyms.</p>

<p>The following three sub-sections are suggested projects.</p>

<h4 id="leanpub-auto-process-all-possible-word-senses">Process all possible word senses</h4>

<p>We only used WordNet entries for nouns. You might want to make copies of the file <strong>WordNetAndOpenNlpExample.java</strong> and instead of looking up entries for nouns, you might want to try other parts of speech: verbs, adjectives, and adverbs. You might also make a copy of <strong>WordNetAndOpenNlpExample.java</strong> and don’t use OpenNLP to tag text but rather look up all four supported parts of speech for each word in the input text.</p>

<p>WordNet is a powerful tool for automating natural language processing but it is not easy to work with. I hope that with this simple example you are now motivated to dive in deeper and consider using WordNet for your projects, where it is appropriate to do so.</p>

<h4 id="leanpub-auto-using-a-part-of-speech-tagger-to-use-the-correct-wordnet-synonyms">Using a Part of Speech Tagger to Use the Correct WordNet Synonyms</h4>

<p>WordNet will give us both synonyms and antonyms (opposite meaning) of words. The problem is that we can only get words with similar and opposite meanings for specific “senses” of a word. Using for  example synonyms of the word “bank” in the sense of a verb meaning “have confidence or faith in” are:</p>

<ul>
  <li>trust</li>
  <li>swear</li>
  <li>rely</li>
</ul>

<p>while synonyms for “bank” in the sense of a noun meaning “a financial institution that accepts deposits and channels the money into lending activities” are:</p>

<ul>
  <li>depository financial institution</li>
  <li>banking concern</li>
  <li>banking company</li>
</ul>

<p>So it does not make too much sense to try to maintain a data map of synonyms for a given word unless we use the word sense or a word in the context of a sentence.</p>

<h4 id="leanpub-auto-using-wordnet-synonyms-to-improve-document-clustering">Using WordNet Synonyms to Improve Document Clustering</h4>

<p>Another suggestion for a OpenNLP and WordNet-based project is to use the OpenNLP part of speech to identify the probable part of speech for each word in all text documents that you want to cluster, and augment the documents with WordNet synset (synonym) data. You can then cluster the documents similarly to how we used a “bag of words” in the earlier chapter <strong>Natural Language Processing</strong> but instead of counting word frequencies, count composite word/part-of-speech token frequencies as well as implied synonym-word/part-of-speech token frequencies.</p>


<h2 id="leanpub-auto-information-gathering">Information Gathering</h2>

<p>I often write software to automatically collect and use data from the web and other sources. In this chapter I have collected utility code that I have written over the years into a small library supporting two approaches to web scraping, DBPedia lookup, and GeoNames lookup. This code is simple but I hope you will find useful.</p>

<p>The following UML class diagram shows the public APIs the libraries developed in this chapter:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 467px">
    <img src="images/info-spider-uml.png" alt="UML class diagram for DBPedia lookup, Geonames, and web spiders" style="width: 100%">
    <figcaption>UML class diagram for DBPedia lookup, Geonames, and web spiders</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-web-scraping-examples">Web Scraping Examples</h3>

<p>As a practical matter, much of the data that many people use for machine learning either comes from the web or from internal data sources. This section provides some guidance and examples for getting text data from the web.</p>

<p>Before we start a technical discussion about web scraping I want to point out to you that much of the information on the web is copyright and the first thing that you should do is to read the terms of service for web sites to insure that your use of “scraped” or “spidered” data conforms with the wishes of the persons or organizations who own the content and pay to run scraped web sites.</p>

<h4 id="leanpub-auto-motivation-for-web-scraping">Motivation for Web Scraping</h4>

<p>There is a huge amount of structured data available on the web via web services, semantic web/linked data markup, and APIs. That said, you will frequently find data that is useful to pull raw text from web sites but this text is usually fairly unstructured and in a messy (and frequently changing) format as web pages meant for human consumption and not meant to be ingested by software agents. In this chapter we will cover useful “web scraping” techniques. You will see that there is often a fair amount of work in dealing with different web design styles and layouts. To make things even more inconvenient you might find that your software information gathering agents will often break because of changes in web sites.</p>

<p>I tend to use one of three general techniques for scraping web sites. Only the first two will be covered in this chapter:</p>

<ul>
  <li>Use an HTML parsing library that strips all HTML markup and Javascript from a page and returns a “pure text” block of text. The text in navigation menus, headers, etc. will be interspersed with what we might usually think of a “content” from a web site.</li>
  <li>Exploit HTML DOM (Document Object Model) formatting information on web sites to pick out headers, page titles, navigation menus, and large blocks of content text.</li>
  <li>Use a tool like <a href="http://docs.seleniumhq.org/">Selenium</a> to programatically control a web browser so your software agents can login to site and otherwise perform navigation. In other words your software agents can simulate a human using a web browser.</li>
</ul>

<p>I seldom need to use tools like Selenium but as the saying goes “when you need them, you need them.” For simple sites I favor extracting all text as a single block and use DOM processing as needed.</p>

<p>I am not going to cover the use of Selenium and the Java Selenium Web-Driver APIs in this chapter because, as I mentioned, I tend to not use it frequently and I think that you are unlikely to need to do so either. I refer you to the Selenium documentation if the first two approaches in the last list do not work for your application. Selenium is primarily intended for building automating testing of complex web applications, so my occasional use in web spidering is not the common use case.</p>

<p>I assume that you have some experience with HTML and DOM. DOM is a tree data structure.</p>

<h4 id="leanpub-auto-web-scraping-using-the-jsoup-library">Web Scraping Using the Jsoup Library</h4>

<p>We will use the MIT licensed library <a href="http://jsoup.org/">jsoup</a>. One reason I selected jsoup for the examples in this chapter out of many fine libraries that provide similar functionality is the particularly nice documentation, especially <a href="http://jsoup.org/cookbook/">The jsoup Cookbook</a> which I urge you to bookmark as a general reference. In this chapter I will concentrate on just the most frequent web scraping use cases that I use in my own work.</p>

<p>The following bit of example code uses jsoup to get the text inside all P (paragraph) elements that are direct children of any DIV element. On line 14 we use the jsoup library to fetch my home web page:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.web_scraping</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">org.jsoup.*</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">org.jsoup.nodes.Document</code><code class="p">;</code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">org.jsoup.nodes.Element</code><code class="p">;</code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">org.jsoup.select.Elements</code><code class="p">;</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="cm">/**</code>
<code class="linenos"> 9 </code><code class="cm"> * Examples of using jsoup</code>
<code class="linenos">10 </code><code class="cm"> */</code>
<code class="linenos">11 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">MySitesExamples</code> <code class="p">{</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos">14 </code>    <code class="n">Document</code> <code class="n">doc</code> <code class="o">=</code> <code class="n">Jsoup</code><code class="p">.</code><code class="na">connect</code><code class="p">(</code><code class="s">"https://markwatson.com"</code><code class="p">)</code>
<code class="linenos">15 </code>        <code class="p">.</code><code class="na">userAgent</code><code class="p">(</code><code class="s">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.0; rv:77.0) Gecko/2010\</code>
<code class="linenos">16 </code><code class="s">0101 Firefox/77.0"</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="p">.</code><code class="na">timeout</code><code class="p">(</code><code class="mi">2000</code><code class="p">).</code><code class="na">get</code><code class="p">();</code>
<code class="linenos">18 </code>    <code class="n">Elements</code> <code class="n">newsHeadlines</code> <code class="o">=</code> <code class="n">doc</code><code class="p">.</code><code class="na">select</code><code class="p">(</code><code class="s">"div p"</code><code class="p">);</code>
<code class="linenos">19 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">Element</code> <code class="n">element</code> <code class="p">:</code> <code class="n">newsHeadlines</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">20 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" next element text: "</code> <code class="o">+</code> <code class="n">element</code><code class="p">.</code><code class="na">text</code><code class="p">());</code>
<code class="linenos">21 </code>    <code class="p">}</code>
<code class="linenos">22 </code>    <code class="n">String</code> <code class="n">all_page_text</code> <code class="o">=</code> <code class="n">doc</code><code class="p">.</code><code class="na">text</code><code class="p">();</code>
<code class="linenos">23 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"All text on web page:\n"</code> <code class="o">+</code> <code class="n">all_page_text</code><code class="p">);</code>
<code class="linenos">24 </code>    <code class="n">Elements</code> <code class="n">anchors</code> <code class="o">=</code> <code class="n">doc</code><code class="p">.</code><code class="na">select</code><code class="p">(</code><code class="s">"a[href]"</code><code class="p">);</code>
<code class="linenos">25 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">Element</code> <code class="n">anchor</code> <code class="p">:</code> <code class="n">anchors</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">26 </code>      <code class="n">String</code> <code class="n">uri</code> <code class="o">=</code> <code class="n">anchor</code><code class="p">.</code><code class="na">attr</code><code class="p">(</code><code class="s">"href"</code><code class="p">);</code>
<code class="linenos">27 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" next anchor uri: "</code> <code class="o">+</code> <code class="n">uri</code><code class="p">);</code>
<code class="linenos">28 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" next anchor text: "</code> <code class="o">+</code> <code class="n">anchor</code><code class="p">.</code><code class="na">text</code><code class="p">());</code>
<code class="linenos">29 </code>    <code class="p">}</code>
<code class="linenos">30 </code>    <code class="n">Elements</code> <code class="n">absolute_uri_anchors</code> <code class="o">=</code> <code class="n">doc</code><code class="p">.</code><code class="na">select</code><code class="p">(</code><code class="s">"a[href]"</code><code class="p">);</code>
<code class="linenos">31 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">Element</code> <code class="n">anchor</code> <code class="p">:</code> <code class="n">absolute_uri_anchors</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">32 </code>      <code class="n">String</code> <code class="n">uri</code> <code class="o">=</code> <code class="n">anchor</code><code class="p">.</code><code class="na">attr</code><code class="p">(</code><code class="s">"abs:href"</code><code class="p">);</code>
<code class="linenos">33 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" next anchor absolute uri: "</code> <code class="o">+</code> <code class="n">uri</code><code class="p">);</code>
<code class="linenos">34 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">" next anchor absolute text: "</code> <code class="o">+</code> <code class="n">anchor</code><code class="p">.</code><code class="na">text</code><code class="p">());</code>
<code class="linenos">35 </code>    <code class="p">}</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code>  <code class="p">}</code>
<code class="linenos">38 </code><code class="p">}</code>
</pre></div>

</figure>

<p>In line 18 I am selecting the pattern that returns all P elements that are direct children of any DIV element and in lines 19-21 print the text inside these P elements.</p>

<p>For training data for machine learning it is useful to just grab all text on a web page and assume that common phrases dealing with web navigation, etc. will be dropped from learned models because they occur in many different training examples for different classifications. In the above listing, line 22 shows how to fetch the plain text from an entire web page. The code on line 24 fetched anchor elements and the loop in lines 25-29 prints out this anchor data as URI and text. The code in lines 30-35 does the same thing except we are converting relative URIs to absolute URIs.</p>

<p>Output might look like (most of the output is not shown from running this example file <strong>MySitesExamples.java</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code> <code class="k">next</code> <code class="nv">element</code> <code class="nv">text</code>: <code class="nv">I</code> <code class="nv">am</code> <code class="nv">the</code> <code class="nv">author</code> <code class="nv">of</code> <code class="mi">20</code><code class="o">+</code> <code class="nv">books</code> <code class="nv">on</code> <code class="nv">Artificial</code> <code class="nv">Intelligence</code>, <code class="nv">Common</code> \
<code class="nv">Lisp</code>, <code class="nv">Deep</code> <code class="nv">Learning</code>, <code class="nv">Haskell</code>, <code class="nv">Java</code>, <code class="nv">Ruby</code>, <code class="nv">JavaScript</code>, <code class="nv">and</code> <code class="nv">the</code> <code class="nv">Semantic</code> <code class="nv">Web</code>. <code class="nv">I</code> <code class="nv">have</code> <code class="mi">5</code>\
<code class="mi">5</code> <code class="nv">US</code> <code class="nv">Patents</code>.
 <code class="k">next</code> <code class="nv">element</code> <code class="nv">text</code>: <code class="nv">My</code> <code class="nv">customer</code> <code class="nv">list</code> <code class="nv">includes</code>: <code class="nv">Google</code>, <code class="nv">Capital</code> <code class="nv">One</code>, <code class="nv">CompassLabs</code>, <code class="nv">Dis</code>\
<code class="nv">ney</code>, <code class="nv">SAIC</code>, <code class="nv">Americast</code>, <code class="nv">PacBell</code>, <code class="nv">CastTV</code>, <code class="nv">Lutris</code> <code class="nv">Technology</code>, <code class="nv">Arctan</code> <code class="nv">Group</code>, <code class="nv">Sitescout</code>.<code class="nv">co</code>\
<code class="nv">m</code>, <code class="nv">Embed</code>.<code class="nv">ly</code>, <code class="nv">and</code> <code class="nv">Webmind</code> <code class="nv">Corporation</code>.
<code class="nv">All</code> <code class="nv">text</code> <code class="nv">on</code> <code class="nv">web</code> <code class="nv">page</code>:
<code class="nv">Mark</code> <code class="nv">Watson</code>: <code class="nv">consultant</code> <code class="nv">specializing</code> <code class="nv">in</code> <code class="nv">Common</code> <code class="nv">Lisp</code>, <code class="nv">deep</code> <code class="nv">learning</code> <code class="nv">and</code> <code class="nv">natural</code> <code class="nv">langu</code>\
<code class="nv">age</code> <code class="nv">processing</code>
<code class="nv">learning</code> <code class="nv">Toggle</code> <code class="nv">navigation</code> <code class="nv">Mark</code> <code class="nv">Watson</code> <code class="nv">consultant</code> <code class="nv">and</code> <code class="nv">author</code> <code class="nv">specializing</code> <code class="nv">in</code> <code class="nv">Common</code> \
<code class="nv">Lisp</code> <code class="nv">development</code> <code class="nv">and</code> <code class="nv">AI</code> 
 ...
 
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">uri</code>: #
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">text</code>: <code class="nv">Mark</code> <code class="nv">Watson</code> <code class="nv">consultant</code> <code class="nv">and</code> <code class="nv">author</code> <code class="nv">specializing</code> <code class="nv">in</code> <code class="nv">Common</code> <code class="nv">Lisp</code> <code class="nv">dev</code>\
<code class="nv">elopment</code> <code class="nv">and</code> <code class="nv">AI</code> <code class="nv">research</code> <code class="nv">projects</code> <code class="nv">and</code> <code class="nv">commercial</code> <code class="nv">products</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">uri</code>: <code class="o">/</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">text</code>: <code class="nv">Home</code> <code class="nv">page</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">uri</code>: <code class="o">/</code><code class="nv">consulting</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">text</code>: <code class="nv">Consulting</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">uri</code>: <code class="o">/</code><code class="nv">blog</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">text</code>: <code class="nv">My</code> <code class="nv">Blog</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">uri</code>: <code class="o">/</code><code class="nv">books</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">text</code>: <code class="nv">My</code> <code class="nv">Books</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">uri</code>: <code class="o">/</code><code class="nv">opensource</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">text</code>: <code class="nv">Open</code> <code class="nv">Source</code>
   ...
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">absolute</code> <code class="nv">uri</code>: <code class="nv">https</code>:<code class="o">//</code><code class="nv">markwatson</code>.<code class="nv">com</code>#
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">absolute</code> <code class="nv">text</code>: <code class="nv">Mark</code> <code class="nv">Watson</code> <code class="nv">consultant</code> <code class="nv">and</code> <code class="nv">author</code> <code class="nv">specializing</code> <code class="nv">in</code> <code class="nv">Common</code>\
 <code class="nv">Lisp</code> <code class="nv">development</code> <code class="nv">and</code> <code class="nv">AI</code> <code class="nv">research</code> <code class="nv">projects</code> <code class="nv">and</code> <code class="nv">commercial</code> <code class="nv">products</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">absolute</code> <code class="nv">uri</code>: <code class="nv">https</code>:<code class="o">//</code><code class="nv">markwatson</code>.<code class="nv">com</code><code class="o">/</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">absolute</code> <code class="nv">text</code>: <code class="nv">Home</code> <code class="nv">page</code>
 <code class="k">next</code> <code class="nv">anchor</code> <code class="nv">absolute</code> <code class="nv">uri</code>: <code class="nv">https</code>:<code class="o">//</code><code class="nv">markwatson</code>.<code class="nv">com</code><code class="o">/</code><code class="nv">consulting</code>
  ...
</pre></div>

</figure>

<p>The 2gram (i.e., two words in sequence) “Toggle navigation” in the last listing has nothing to do with the real content in my site and is an artifact of using the Bootstrap CSS and Javascript tools. Often “noise” like this is simply ignored by machine learning models if it appears on many different sites but beware that this might be a problem and you might need to precisely fetch text from specific DOM elements. Similarly, notice that this last listing picks up the plain text from the navigation menus.</p>

<p>Notice that there are different types of URIs like #, relative, and absolute. Any characters following a # character do not affect the routing of which web page is shown (or which API is called) but the characters after the # character are available for use in specifying anchor positions on a web page or extra parameters for API calls. Relative APIs like consulting/ are understood to be relative to the base URI of the web site.</p>

<p>I often require that URIs be absolute URIs (i.e., starts with a protocol like “http:” or “https:”) and lines 28-33 show how to select just absolute URI anchors. In line 31 I am specifying the attribute as “abs:href” to be more selective.</p>

<h3> </h3>
<p>## Web Spidering Using the Jericho Library</p>

<p>Here is another web spidering example that is different than the earlier example using the <strong>jsoup</strong> library. Here we will implement a spider using built in Java standard library network classes and also the Jericho HTML parser library.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.info_spiders</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">net.htmlparser.jericho.*</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">java.io.InputStream</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.net.URL</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.net.URLConnection</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.*</code><code class="p">;</code>

<code class="cm">/**</code>
<code class="cm"> * This simple web spider returns a list of lists, each containing two strings</code>
<code class="cm"> * representing "URL" and "text".</code>
<code class="cm"> * Specifically, I do not return links on each page.</code>
<code class="cm"> */</code>

<code class="cm">/**</code>
<code class="cm"> * Copyright Mark Watson 2008-2020. All Rights Reserved.</code>
<code class="cm"> * License: Apache 2</code>
<code class="cm"> */</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">WebSpider</code> <code class="p">{</code>
  <code class="kd">public</code> <code class="nf">WebSpider</code><code class="p">(</code><code class="n">String</code> <code class="n">root_url</code><code class="p">,</code> <code class="kt">int</code> <code class="n">max_returned_pages</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="n">String</code> <code class="n">host</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="p">(</code><code class="n">root_url</code><code class="p">).</code><code class="na">getHost</code><code class="p">();</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"+ host: "</code> <code class="o">+</code> <code class="n">host</code><code class="p">);</code>
    <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">urls</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
    <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">already_visited</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashSet</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
    <code class="n">urls</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">root_url</code><code class="p">);</code>
    <code class="kt">int</code> <code class="n">num_fetched</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="k">while</code> <code class="p">(</code><code class="n">num_fetched</code> <code class="o">&lt;=</code> <code class="n">max_returned_pages</code> <code class="o">&amp;&amp;</code> <code class="o">!</code><code class="n">urls</code><code class="p">.</code><code class="na">isEmpty</code><code class="p">())</code> <code class="p">{</code>
      <code class="k">try</code> <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"+ urls: "</code> <code class="o">+</code> <code class="n">urls</code><code class="p">);</code>
        <code class="n">String</code> <code class="n">url_str</code> <code class="o">=</code> <code class="n">urls</code><code class="p">.</code><code class="na">remove</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"+ url_str: "</code> <code class="o">+</code> <code class="n">url_str</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">url_str</code><code class="p">.</code><code class="na">toLowerCase</code><code class="p">().</code><code class="na">indexOf</code><code class="p">(</code><code class="n">host</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code> <code class="o">&amp;&amp;</code>
            <code class="o">!</code><code class="n">already_visited</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="n">url_str</code><code class="p">))</code> <code class="p">{</code>
          <code class="n">already_visited</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">url_str</code><code class="p">);</code>
          <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="p">(</code><code class="n">url_str</code><code class="p">);</code>
          <code class="n">URLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="n">url</code><code class="p">.</code><code class="na">openConnection</code><code class="p">();</code>
          <code class="n">connection</code><code class="p">.</code><code class="na">setAllowUserInteraction</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
          <code class="n">InputStream</code> <code class="n">ins</code> <code class="o">=</code> <code class="n">url</code><code class="p">.</code><code class="na">openStream</code><code class="p">();</code>
          <code class="n">Source</code> <code class="n">source</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Source</code><code class="p">(</code><code class="n">ins</code><code class="p">);</code>
          <code class="n">num_fetched</code><code class="o">++</code><code class="p">;</code>
          <code class="n">TextExtractor</code> <code class="n">te</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TextExtractor</code><code class="p">(</code><code class="n">source</code><code class="p">);</code>
          <code class="n">String</code> <code class="n">text</code> <code class="o">=</code> <code class="n">te</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
          <code class="c1">// Skip any pages where text on page is identical to existing</code>
          <code class="c1">// page (e.g., http://example.com and http://exaple.com/index.html</code>
          <code class="kt">boolean</code> <code class="n">process</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
          <code class="k">for</code> <code class="p">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">ls</code> <code class="p">:</code> <code class="n">url_content_lists</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">text</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="n">ls</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="mi">1</code><code class="p">)))</code> <code class="p">{</code>
              <code class="n">process</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
              <code class="k">break</code><code class="p">;</code>
            <code class="p">}</code>
          <code class="p">}</code>
          <code class="k">if</code> <code class="p">(</code><code class="n">process</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">try</code> <code class="p">{</code>
              <code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code>
            <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ignore</code><code class="p">)</code> <code class="p">{</code>
            <code class="p">}</code>
            <code class="n">List</code><code class="o">&lt;</code><code class="n">StartTag</code><code class="o">&gt;</code> <code class="n">anchorTags</code> <code class="o">=</code> <code class="n">source</code><code class="p">.</code><code class="na">getAllStartTags</code><code class="p">(</code><code class="s">"a "</code><code class="p">);</code>
            <code class="n">ListIterator</code> <code class="n">iter</code> <code class="o">=</code> <code class="n">anchorTags</code><code class="p">.</code><code class="na">listIterator</code><code class="p">();</code>
            <code class="k">while</code> <code class="p">(</code><code class="n">iter</code><code class="p">.</code><code class="na">hasNext</code><code class="p">())</code> <code class="p">{</code>
              <code class="n">StartTag</code> <code class="n">anchor</code> <code class="o">=</code> <code class="p">(</code><code class="n">StartTag</code><code class="p">)</code> <code class="n">iter</code><code class="p">.</code><code class="na">next</code><code class="p">();</code>
              <code class="n">Attributes</code> <code class="n">attr</code> <code class="o">=</code> <code class="n">anchor</code><code class="p">.</code><code class="na">parseAttributes</code><code class="p">();</code>
              <code class="n">Attribute</code> <code class="n">link</code> <code class="o">=</code> <code class="n">attr</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="s">"href"</code><code class="p">);</code>
              <code class="n">String</code> <code class="n">link_str</code> <code class="o">=</code> <code class="n">link</code><code class="p">.</code><code class="na">getValue</code><code class="p">();</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">link_str</code><code class="p">.</code><code class="na">indexOf</code><code class="p">(</code><code class="s">"http:"</code><code class="p">)</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
                <code class="n">String</code> <code class="n">path</code> <code class="o">=</code> <code class="n">url</code><code class="p">.</code><code class="na">getPath</code><code class="p">();</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">path</code><code class="p">.</code><code class="na">endsWith</code><code class="p">(</code><code class="s">"/"</code><code class="p">))</code> <code class="n">path</code> <code class="o">=</code> <code class="n">path</code><code class="p">.</code><code class="na">substring</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">path</code><code class="p">.</code><code class="na">length</code><code class="p">()</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>
                <code class="kt">int</code> <code class="n">index</code> <code class="o">=</code> <code class="n">path</code><code class="p">.</code><code class="na">lastIndexOf</code><code class="p">(</code><code class="s">"/"</code><code class="p">);</code>
                <code class="k">if</code> <code class="p">(</code><code class="n">index</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="n">path</code> <code class="o">=</code> <code class="n">path</code><code class="p">.</code><code class="na">substring</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">index</code><code class="p">);</code>
                <code class="n">link_str</code> <code class="o">=</code> <code class="n">url</code><code class="p">.</code><code class="na">getHost</code><code class="p">()</code> <code class="o">+</code> <code class="s">"/"</code> <code class="o">+</code> <code class="n">path</code> <code class="o">+</code> <code class="s">"/"</code> <code class="o">+</code> <code class="n">link_str</code><code class="p">;</code>
                <code class="n">link_str</code> <code class="o">=</code> <code class="s">"http://"</code> <code class="o">+</code> <code class="n">link_str</code><code class="p">.</code><code class="na">replaceAll</code><code class="p">(</code><code class="s">"///"</code><code class="p">,</code> <code class="s">"/"</code><code class="p">).</code><code class="na">replaceAll</code><code class="p">(</code><code class="s">"/\</code>
<code class="s">/"</code><code class="p">,</code> <code class="s">"/"</code><code class="p">);</code>
              <code class="p">}</code>
              <code class="n">urls</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">link_str</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">ls</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>
            <code class="n">ls</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">url_str</code><code class="p">);</code>
            <code class="n">ls</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
            <code class="n">url_content_lists</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">ls</code><code class="p">);</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Error: "</code> <code class="o">+</code> <code class="n">ex</code><code class="p">);</code>
        <code class="n">ex</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">url_content_lists</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code><code class="p">();</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The test class <strong>WebClientTest</strong> shows how to use this class:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">WebSpider</code> <code class="n">client</code> <code class="o">=</code> <code class="k">new</code> <code class="n">WebSpider</code><code class="p">(</code><code class="s">"http://pbs.org"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Found URIs: "</code> <code class="o">+</code> <code class="n">client</code><code class="p">.</code><code class="na">url_content_lists</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here is the output for the test class <strong>WebClientTest</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>+ host: pbs.org
+ urls: [http://pbs.org]
+ url_str: http://pbs.org
Found URIs: [[http://pbs.org, ]]
</pre></div>

</figure>

<h3 id="leanpub-auto-dbpedia-entity-lookup">DBPedia Entity Lookup</h3>

<p>DBPedia contains structured data for the WikiPedia web site. In later chapters we will learn how to use the SPARQL query language to access DBPedia. Here we use a simple lookup service for any entity name. If an entity name is found in DBPedia then information on the entity is returned as an XML payload.</p>

<p>The implementation file is DBpediaLookupClient.java:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.info_spiders</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">org.apache.http.impl.client.CloseableHttpClient</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">org.apache.http.impl.client.HttpClients</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">org.xml.sax.Attributes</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">org.xml.sax.SAXException</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">org.xml.sax.helpers.DefaultHandler</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">javax.xml.parsers.SAXParser</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">javax.xml.parsers.SAXParserFactory</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.*</code><code class="p">;</code>

<code class="cm">/**</code>
<code class="cm"> * Copyright Mark Watson 2008-2020. All Rights Reserved.</code>
<code class="cm"> * License: Apache-2.0</code>
<code class="cm"> */</code>

<code class="c1">// Use Georgi Kobilarov's DBpedia lookup web service</code>
<code class="c1">//    ref: http://lookup.dbpedia.org/api/search.asmx?op=KeywordSearch</code>
<code class="c1">//    example:</code>
<code class="c1">// http://lookup.dbpedia.org/api/search.asmx/KeywordSearch?QueryString=Flagstaff</code>

<code class="cm">/**</code>
<code class="cm"> * Searches return results that contain any of the search terms. I am going to filter</code>
<code class="cm"> * the results to ignore results that do not contain all search terms.</code>
<code class="cm"> */</code>


<code class="kd">public</code> <code class="kd">class</code> <code class="nc">DBpediaLookupClient</code> <code class="kd">extends</code> <code class="n">DefaultHandler</code> <code class="p">{</code>
  <code class="kd">public</code> <code class="nf">DBpediaLookupClient</code><code class="p">(</code><code class="n">String</code> <code class="n">query</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="na">query</code> <code class="o">=</code> <code class="n">query</code><code class="p">;</code>
    <code class="n">CloseableHttpClient</code> <code class="n">client</code> <code class="o">=</code> <code class="n">HttpClients</code><code class="p">.</code><code class="na">createDefault</code><code class="p">();</code>

    <code class="n">String</code> <code class="n">query2</code> <code class="o">=</code> <code class="n">query</code><code class="p">.</code><code class="na">replaceAll</code><code class="p">(</code><code class="s">" "</code><code class="p">,</code> <code class="s">"+"</code><code class="p">);</code>

    <code class="n">SAXParserFactory</code> <code class="n">factory</code> <code class="o">=</code> <code class="n">SAXParserFactory</code><code class="p">.</code><code class="na">newInstance</code><code class="p">();</code>
    <code class="n">SAXParser</code> <code class="n">sax</code> <code class="o">=</code> <code class="n">factory</code><code class="p">.</code><code class="na">newSAXParser</code><code class="p">();</code>
    <code class="n">sax</code><code class="p">.</code><code class="na">parse</code><code class="p">(</code>
      <code class="s">"http://lookup.dbpedia.org/api/search.asmx/KeywordSearch?QueryString="</code> <code class="o">+</code>
      <code class="n">query2</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>

  <code class="p">}</code>

  <code class="kd">private</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">variableBindings</code> <code class="o">=</code> 
      <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code><code class="p">();</code>
  <code class="kd">private</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">tempBinding</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="kd">private</code> <code class="n">String</code> <code class="n">lastElementName</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>

  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">startElement</code><code class="p">(</code><code class="n">String</code> <code class="n">uri</code><code class="p">,</code> <code class="n">String</code> <code class="n">localName</code><code class="p">,</code> <code class="n">String</code> <code class="n">qName</code><code class="p">,</code>
                           <code class="n">Attributes</code> <code class="n">attributes</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">SAXException</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">qName</code><code class="p">.</code><code class="na">equalsIgnoreCase</code><code class="p">(</code><code class="s">"result"</code><code class="p">))</code> <code class="p">{</code>
      <code class="n">tempBinding</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="n">lastElementName</code> <code class="o">=</code> <code class="n">qName</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">endElement</code><code class="p">(</code><code class="n">String</code> <code class="n">uri</code><code class="p">,</code> <code class="n">String</code> <code class="n">localName</code><code class="p">,</code> <code class="n">String</code> <code class="n">qName</code><code class="p">)</code>
         <code class="kd">throws</code> <code class="n">SAXException</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">qName</code><code class="p">.</code><code class="na">equalsIgnoreCase</code><code class="p">(</code><code class="s">"result"</code><code class="p">))</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">variableBindings</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="n">tempBinding</code><code class="p">)</code> <code class="o">&amp;&amp;</code>
           <code class="n">containsSearchTerms</code><code class="p">(</code><code class="n">tempBinding</code><code class="p">))</code>
        <code class="n">variableBindings</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">tempBinding</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">characters</code><code class="p">(</code><code class="kt">char</code><code class="o">[]</code> <code class="n">ch</code><code class="p">,</code> <code class="kt">int</code> <code class="n">start</code><code class="p">,</code> <code class="kt">int</code> <code class="n">length</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">SAXException</code> <code class="p">{</code>
    <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="k">new</code> <code class="n">String</code><code class="p">(</code><code class="n">ch</code><code class="p">,</code> <code class="n">start</code><code class="p">,</code> <code class="n">length</code><code class="p">).</code><code class="na">trim</code><code class="p">();</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">length</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="s">"Description"</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="n">lastElementName</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">tempBinding</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="s">"Description"</code><code class="p">)</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">tempBinding</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="s">"Description"</code><code class="p">,</code> <code class="n">s</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="n">tempBinding</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="s">"Description"</code><code class="p">,</code> <code class="s">""</code> <code class="o">+</code> <code class="n">tempBinding</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="s">"Description"</code><code class="p">)</code> <code class="o">+</code>
                        <code class="s">" "</code> <code class="o">+</code> <code class="n">s</code><code class="p">);</code>
      <code class="p">}</code>
      <code class="k">if</code> <code class="p">(</code><code class="s">"URI"</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="n">lastElementName</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">s</code><code class="p">.</code><code class="na">indexOf</code><code class="p">(</code><code class="s">"Category"</code><code class="p">)</code><code class="o">==-</code><code class="mi">1</code> <code class="o">&amp;&amp;</code>
          <code class="n">tempBinding</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="s">"URI"</code><code class="p">)</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">tempBinding</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="s">"URI"</code><code class="p">,</code> <code class="n">s</code><code class="p">);</code>
      <code class="p">}</code>
      <code class="k">if</code> <code class="p">(</code><code class="s">"Label"</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="n">lastElementName</code><code class="p">))</code> <code class="n">tempBinding</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="s">"Label"</code><code class="p">,</code> <code class="n">s</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code> <code class="nf">variableBindings</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">variableBindings</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kd">private</code> <code class="kt">boolean</code> <code class="nf">containsSearchTerms</code><code class="p">(</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">bindings</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">StringBuilder</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="n">value</code> <code class="p">:</code> <code class="n">bindings</code><code class="p">.</code><code class="na">values</code><code class="p">())</code> <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">value</code><code class="p">);</code>  <code class="c1">// no white space</code>
    <code class="n">String</code> <code class="n">text</code> <code class="o">=</code> <code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">().</code><code class="na">toLowerCase</code><code class="p">();</code>
    <code class="n">StringTokenizer</code> <code class="n">st</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringTokenizer</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="na">query</code><code class="p">);</code>
    <code class="k">while</code> <code class="p">(</code><code class="n">st</code><code class="p">.</code><code class="na">hasMoreTokens</code><code class="p">())</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="n">text</code><code class="p">.</code><code class="na">indexOf</code><code class="p">(</code><code class="n">st</code><code class="p">.</code><code class="na">nextToken</code><code class="p">().</code><code class="na">toLowerCase</code><code class="p">())</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
      <code class="p">}</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="kc">true</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kd">private</code> <code class="n">String</code> <code class="n">query</code> <code class="o">=</code> <code class="s">""</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The unit test class <strong>DBpediaLookupClientTest</strong> shows how to call this library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">DBpediaLookupClient</code> <code class="n">client</code> <code class="o">=</code>
        <code class="k">new</code> <code class="n">DBpediaLookupClient</code><code class="p">(</code><code class="s">"London UK"</code><code class="p">);</code>
    <code class="n">List</code><code class="o">&lt;</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">results</code> <code class="o">=</code> <code class="n">client</code><code class="p">.</code><code class="na">variableBindings</code><code class="p">();</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"# query results: "</code> <code class="o">+</code> <code class="n">results</code><code class="p">.</code><code class="na">size</code><code class="p">());</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">map</code> <code class="p">:</code> <code class="n">results</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">for</code> <code class="p">(</code><code class="n">Map</code><code class="p">.</code><code class="na">Entry</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">entry</code> <code class="p">:</code> <code class="n">map</code><code class="p">.</code><code class="na">entrySet</code><code class="p">())</code> <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">entry</code><code class="p">.</code><code class="na">getKey</code><code class="p">()</code> <code class="o">+</code> <code class="s">" - "</code> <code class="o">+</code> <code class="n">entry</code><code class="p">.</code><code class="na">getValue</code><code class="p">());</code>
      <code class="p">}</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>Here is the output from this test code (with some output not shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="c1"># query results: 2</code>
<code class="n">Description</code> <code class="o">-</code> <code class="n">The</code> <code class="n">O2</code> <code class="n">Arena</code> <code class="p">(</code><code class="n">visually</code> <code class="n">typeset</code> <code class="ow">in</code> <code class="n">branding</code> <code class="k">as</code> <code class="n">The</code> <code class="n">O2</code> <code class="n">arena</code><code class="p">,</code> <code class="n">referred</code> <code class="n">t</code>\
<code class="n">o</code> <code class="k">as</code> <code class="n">North</code> <code class="n">Greenwich</code> <code class="n">Arena</code> <code class="ow">in</code> <code class="n">context</code> <code class="n">of</code> <code class="n">the</code> <code class="mi">2012</code> <code class="n">Summer</code> <code class="n">Olympics</code> <code class="ow">and</code> <code class="n">Paralympics</code><code class="p">)</code> <code class="n">i</code>\
<code class="n">s</code> <code class="n">a</code> <code class="n">multi</code><code class="o">-</code><code class="n">purpose</code> <code class="n">indoor</code> <code class="n">arena</code> <code class="n">located</code> <code class="ow">in</code> <code class="n">the</code> <code class="n">centre</code> <code class="n">of</code> <code class="n">The</code> <code class="n">O2</code><code class="p">,</code> <code class="n">a</code> <code class="n">large</code> <code class="n">entertainmen</code>\
<code class="n">t</code> <code class="n">complex</code> <code class="n">on</code> <code class="n">the</code> <code class="n">Greenwich</code> <code class="n">peninsula</code> <code class="ow">in</code> <code class="n">London</code><code class="p">,</code> <code class="n">England</code><code class="o">.</code>
  <code class="o">...</code>
<code class="n">Label</code> <code class="o">-</code> <code class="n">Sports</code> <code class="n">venues</code> <code class="ow">in</code> <code class="n">London</code>
<code class="n">URI</code> <code class="o">-</code> <code class="n">http</code><code class="p">:</code><code class="o">//</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">resource</code><code class="o">/</code><code class="n">The_O2_Arena_</code><code class="p">(</code><code class="n">London</code><code class="p">)</code>
<code class="n">Description</code> <code class="o">-</code> <code class="n">The</code> <code class="n">City</code> <code class="n">of</code> <code class="n">London</code> <code class="n">was</code> <code class="n">a</code> <code class="n">United</code> <code class="n">Kingdom</code> <code class="n">Parliamentary</code> <code class="n">constituency</code><code class="o">.</code> <code class="n">It</code>\
 <code class="n">was</code> <code class="n">a</code> <code class="n">constituency</code> <code class="n">of</code> <code class="n">the</code> <code class="n">House</code> <code class="n">of</code> <code class="n">Commons</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Parliament</code> <code class="n">of</code> <code class="n">England</code> <code class="n">then</code> <code class="n">of</code> <code class="n">the</code>\
 <code class="n">Parliament</code> <code class="n">of</code> <code class="n">Great</code> <code class="n">Britain</code> <code class="n">from</code> <code class="mi">1707</code> <code class="n">to</code> <code class="mi">1800</code> <code class="ow">and</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Parliament</code> <code class="n">of</code> <code class="n">the</code> <code class="n">United</code> <code class="n">K</code>\
<code class="n">ingdom</code> <code class="n">from</code> <code class="mi">1801</code> <code class="n">to</code> <code class="mf">1950.</code> <code class="n">The</code> <code class="n">City</code> <code class="n">of</code> <code class="n">London</code> <code class="n">was</code> <code class="n">a</code> <code class="n">United</code> <code class="n">Kingdom</code> <code class="n">Parliamentary</code> <code class="n">cons</code>\
<code class="n">tituency</code><code class="o">.</code>
  <code class="o">...</code>
<code class="n">Label</code> <code class="o">-</code> <code class="n">United</code> <code class="n">Kingdom</code> <code class="n">Parliamentary</code> <code class="n">constituencies</code> <code class="n">represented</code> <code class="n">by</code> <code class="n">a</code> <code class="n">sitting</code> <code class="n">Prime</code> <code class="n">M</code>\
<code class="n">inister</code>
<code class="n">URI</code> <code class="o">-</code> <code class="n">http</code><code class="p">:</code><code class="o">//</code><code class="n">dbpedia</code><code class="o">.</code><code class="n">org</code><code class="o">/</code><code class="n">resource</code><code class="o">/</code><code class="n">City_of_London_</code><code class="p">(</code><code class="n">UK_Parliament_constituency</code><code class="p">)</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-client-for-geonames-service">Client for GeoNames Service</h3>

<p>The GeoNames service looks up information about locations. You need to [sign up for a free account])http://www.geonames.org/login) and the access key needs to be stored in an environment variable <strong>GEONAMES</strong> which is accessed in Java code using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="n">System</code><code class="p">.</code><code class="na">getenv</code><code class="p">(</code><code class="s">"GEONAMES"</code><code class="p">)</code>
</pre></div>

</figure>

<p>The implementation file is <strong>GeoNamesClient.java</strong> uses the utility class <strong>GeoNameData</strong> that we will look at later:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.info_spiders</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">org.geonames.*</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>

<code class="cm">/**</code>
<code class="cm"> * Copyright Mark Watson 2008-2020. All Rights Reserved.</code>
<code class="cm"> * License: Apache 2</code>
<code class="cm"> */</code>

<code class="c1">// You will need a free GeoNames account. Sign up:  https://www.geonames.org/login</code>
<code class="c1">// Then, set an environment variable: export GEONAMES=your-geonames-account-name</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">GeoNamesClient</code> <code class="p">{</code>
  <code class="kd">public</code> <code class="nf">GeoNamesClient</code><code class="p">()</code> <code class="p">{</code>
  <code class="p">}</code>

  <code class="kd">private</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="nf">helper</code><code class="p">(</code><code class="n">String</code> <code class="n">name</code><code class="p">,</code> <code class="n">String</code> <code class="n">type</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code><code class="p">();</code>

    <code class="n">String</code> <code class="n">geonames_account_name</code> <code class="o">=</code> <code class="n">System</code><code class="p">.</code><code class="na">getenv</code><code class="p">(</code><code class="s">"GEONAMES"</code><code class="p">);</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">geonames_account_name</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
      <code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"You will need a free GeoNames account."</code><code class="p">);</code>
      <code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Sign up:  https://www.geonames.org/login"</code><code class="p">);</code>
      <code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Then, set an environment variable:"</code><code class="p">);</code>
      <code class="n">System</code><code class="p">.</code><code class="na">err</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"     export GEONAMES=your-geonames-account-name"</code><code class="p">);</code>
      <code class="k">throw</code> <code class="k">new</code> <code class="n">Exception</code><code class="p">(</code><code class="s">"Need API key"</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="n">WebService</code><code class="p">.</code><code class="na">setUserName</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="na">getenv</code><code class="p">(</code><code class="s">"GEONAMES"</code><code class="p">));</code>

    <code class="n">ToponymSearchCriteria</code> <code class="n">searchCriteria</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ToponymSearchCriteria</code><code class="p">();</code>
    <code class="n">searchCriteria</code><code class="p">.</code><code class="na">setStyle</code><code class="p">(</code><code class="n">Style</code><code class="p">.</code><code class="na">LONG</code><code class="p">);</code>
    <code class="n">searchCriteria</code><code class="p">.</code><code class="na">setQ</code><code class="p">(</code><code class="n">name</code><code class="p">);</code>
    <code class="n">ToponymSearchResult</code> <code class="n">searchResult</code> <code class="o">=</code> <code class="n">WebService</code><code class="p">.</code><code class="na">search</code><code class="p">(</code><code class="n">searchCriteria</code><code class="p">);</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">Toponym</code> <code class="n">toponym</code> <code class="p">:</code> <code class="n">searchResult</code><code class="p">.</code><code class="na">getToponyms</code><code class="p">())</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">()</code> <code class="o">!=</code> <code class="kc">null</code> <code class="o">&amp;&amp;</code>
        <code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">().</code><code class="na">toString</code><code class="p">().</code><code class="na">indexOf</code><code class="p">(</code><code class="n">type</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code> <code class="o">&amp;&amp;</code>
        <code class="n">toponym</code><code class="p">.</code><code class="na">getName</code><code class="p">().</code><code class="na">indexOf</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code> <code class="o">&amp;&amp;</code>
        <code class="n">valid</code><code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getName</code><code class="p">()))</code> <code class="p">{</code>
        <code class="n">ret</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="k">new</code> <code class="n">GeoNameData</code><code class="p">(</code><code class="n">toponym</code><code class="p">));</code>
      <code class="p">}</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="kd">private</code> <code class="kt">boolean</code> <code class="nf">valid</code><code class="p">(</code><code class="n">String</code> <code class="n">str</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"0"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"1"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"2"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"3"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"4"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"5"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"6"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"7"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"8"</code><code class="p">))</code> <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">return</code> <code class="o">!</code><code class="n">str</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="s">"9"</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="nf">getCityData</code><code class="p">(</code><code class="n">String</code> <code class="n">city_name</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">helper</code><code class="p">(</code><code class="n">city_name</code><code class="p">,</code> <code class="s">"city"</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="nf">getCountryData</code><code class="p">(</code><code class="n">String</code> <code class="n">country_name</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">helper</code><code class="p">(</code><code class="n">country_name</code><code class="p">,</code> <code class="s">"country"</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="nf">getStateData</code><code class="p">(</code><code class="n">String</code> <code class="n">state_name</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="n">states</code> <code class="o">=</code> <code class="n">helper</code><code class="p">(</code><code class="n">state_name</code><code class="p">,</code> <code class="s">"state"</code><code class="p">);</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">GeoNameData</code> <code class="n">state</code> <code class="p">:</code> <code class="n">states</code><code class="p">)</code> <code class="p">{</code>
      <code class="n">state</code><code class="p">.</code><code class="na">geoType</code> <code class="o">=</code> <code class="n">GeoNameData</code><code class="p">.</code><code class="na">GeoType</code><code class="p">.</code><code class="na">STATE</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="n">states</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="nf">getRiverData</code><code class="p">(</code><code class="n">String</code> <code class="n">river_name</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">helper</code><code class="p">(</code><code class="n">river_name</code><code class="p">,</code> <code class="s">"stream"</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">GeoNameData</code><code class="o">&gt;</code> <code class="nf">getMountainData</code><code class="p">(</code><code class="n">String</code> <code class="n">mountain_name</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">helper</code><code class="p">(</code><code class="n">mountain_name</code><code class="p">,</code> <code class="s">"mountain"</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>GeoNamesClient</strong> in the last listing uses the class <strong>GeoNameData</strong> which processes the structured data returned from the GeoNames service and provides public fields to access this information and an implementation of <strong>toString</strong> to pretty-print the data to a string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.info_spiders</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">org.geonames.Toponym</code><code class="p">;</code>

<code class="cm">/**</code>
<code class="cm"> * Copyright Mark Watson 2008-2020. All Rights Reserved.</code>
<code class="cm"> * License: Apache-2.0</code>
<code class="cm"> */</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">GeoNameData</code> <code class="p">{</code>
  <code class="kd">public</code> <code class="kd">enum</code> <code class="n">GeoType</code> <code class="p">{</code>
    <code class="n">CITY</code><code class="p">,</code> <code class="n">COUNTRY</code><code class="p">,</code> <code class="n">STATE</code><code class="p">,</code> <code class="n">RIVER</code><code class="p">,</code> <code class="n">MOUNTAIN</code><code class="p">,</code> <code class="n">UNKNOWN</code>
  <code class="p">}</code>
  <code class="kd">public</code> <code class="kt">int</code> <code class="n">geoNameId</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="kd">public</code> <code class="n">GeoType</code> <code class="n">geoType</code> <code class="o">=</code> <code class="n">GeoType</code><code class="p">.</code><code class="na">UNKNOWN</code><code class="p">;</code>
  <code class="kd">public</code> <code class="n">String</code> <code class="n">name</code> <code class="o">=</code> <code class="s">""</code><code class="p">;</code>
  <code class="kd">public</code> <code class="kt">double</code> <code class="n">latitude</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="kd">public</code> <code class="kt">double</code> <code class="n">longitude</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="kd">public</code> <code class="n">String</code> <code class="n">countryCode</code> <code class="o">=</code> <code class="s">""</code><code class="p">;</code>

  <code class="kd">public</code> <code class="nf">GeoNameData</code><code class="p">(</code><code class="n">Toponym</code> <code class="n">toponym</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">geoNameId</code> <code class="o">=</code> <code class="n">toponym</code><code class="p">.</code><code class="na">getGeoNameId</code><code class="p">();</code>
    <code class="n">latitude</code> <code class="o">=</code> <code class="n">toponym</code><code class="p">.</code><code class="na">getLatitude</code><code class="p">();</code>
    <code class="n">longitude</code> <code class="o">=</code> <code class="n">toponym</code><code class="p">.</code><code class="na">getLongitude</code><code class="p">();</code>
    <code class="n">name</code> <code class="o">=</code> <code class="n">toponym</code><code class="p">.</code><code class="na">getName</code><code class="p">();</code>
    <code class="n">countryCode</code> <code class="o">=</code> <code class="n">toponym</code><code class="p">.</code><code class="na">getCountryCode</code><code class="p">();</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">().</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"city"</code><code class="p">))</code> <code class="n">geoType</code> <code class="o">=</code> <code class="n">GeoType</code><code class="p">.</code><code class="na">CITY</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">().</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"country"</code><code class="p">))</code>
       <code class="n">geoType</code> <code class="o">=</code> <code class="n">GeoType</code><code class="p">.</code><code class="na">COUNTRY</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">().</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"state"</code><code class="p">))</code> <code class="n">geoType</code> <code class="o">=</code> <code class="n">GeoType</code><code class="p">.</code><code class="na">STATE</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">().</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"stream"</code><code class="p">))</code> <code class="n">geoType</code> <code class="o">=</code> <code class="n">GeoType</code><code class="p">.</code><code class="na">RIVER</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">toponym</code><code class="p">.</code><code class="na">getFeatureClassName</code><code class="p">().</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"mountain"</code><code class="p">))</code>
        <code class="n">geoType</code> <code class="o">=</code> <code class="n">GeoType</code><code class="p">.</code><code class="na">MOUNTAIN</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="nf">GeoNameData</code><code class="p">()</code> <code class="p">{</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s">"[GeoNameData: "</code> <code class="o">+</code> <code class="n">name</code> <code class="o">+</code> <code class="s">", type: "</code> <code class="o">+</code> <code class="n">geoType</code> <code class="o">+</code> <code class="s">", country code: "</code> <code class="o">+</code> <code class="n">cou</code><code class="err">\</code>
<code class="n">ntryCode</code> <code class="o">+</code>
      <code class="s">", ID: "</code> <code class="o">+</code> <code class="n">geoNameId</code> <code class="o">+</code> <code class="s">", latitude: "</code> <code class="o">+</code> <code class="n">latitude</code> <code class="o">+</code>
      <code class="s">", longitude: "</code> <code class="o">+</code> <code class="n">longitude</code> <code class="o">+</code> <code class="s">"]"</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The test class <strong>GeoNamesClientTest</strong> shows how to use these two classes:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="n">GeoNamesClient</code> <code class="n">client</code> <code class="o">=</code> <code class="k">new</code> <code class="n">GeoNamesClient</code><code class="p">();</code>
<code class="linenos">2 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">client</code><code class="p">.</code><code class="na">getCityData</code><code class="p">(</code><code class="s">"Paris"</code><code class="p">));</code>    <code class="n">pause</code><code class="p">();</code>
<code class="linenos">3 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">client</code><code class="p">.</code><code class="na">getCountryData</code><code class="p">(</code><code class="s">"Canada"</code><code class="p">));</code>   <code class="n">pause</code><code class="p">();</code>
<code class="linenos">4 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">client</code><code class="p">.</code><code class="na">getStateData</code><code class="p">(</code><code class="s">"California"</code><code class="p">));</code> <code class="n">pause</code><code class="p">();</code>
<code class="linenos">5 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">client</code><code class="p">.</code><code class="na">getRiverData</code><code class="p">(</code><code class="s">"Amazon"</code><code class="p">));</code>     <code class="n">pause</code><code class="p">();</code>
<code class="linenos">6 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">client</code><code class="p">.</code><code class="na">getMountainData</code><code class="p">(</code><code class="s">"Whitney"</code><code class="p">));</code>
</pre></div>

</figure>

<p>The output from this test is shown below:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="err">[[</code><code class="nl">GeoNameData:</code> <code class="nf">Paris</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">CITY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">FR</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">2988507</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">48</code><code class="no">.85341</code><code class="p">,</code><code class="err">\</code>
<code class="linenos"> 2 </code> <code class="nl">longitude:</code> <code class="err">2</code><code class="nf">.3488</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Le</code> <code class="no">Touquet-Paris-Plage</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">CITY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code><code class="err">\</code>
<code class="linenos"> 3 </code> <code class="nf">FR</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">2999139</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">50</code><code class="no">.52432</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">1</code><code class="no">.58571</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Paris</code><code class="p">,</code> <code class="no">type</code><code class="err">\</code>
<code class="linenos"> 4 </code><code class="err">:</code> <code class="nf">CITY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">4717560</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">33</code><code class="no">.66094</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-95</code><code class="no">.55551</code><code class="p">],</code> <code class="p">[</code><code class="no">G</code><code class="err">\</code>
<code class="linenos"> 5 </code><code class="nl">eoNameData:</code> <code class="nf">Balneario</code> <code class="no">Nuevo</code> <code class="no">Paris</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">CITY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">UY</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">3441475</code><code class="p">,</code> <code class="no">latitu</code><code class="err">\</code>
<code class="linenos"> 6 </code><code class="nl">de:</code> <code class="err">-34</code><code class="nf">.85</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-56</code><code class="no">.23333</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Paris</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">CITY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">BY</code><code class="err">\</code>
<code class="linenos"> 7 </code><code class="err">,</code> <code class="nl">ID:</code> <code class="err">8221628,</code> <code class="nl">latitude:</code> <code class="err">55</code><code class="nf">.15464</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">27</code><code class="no">.38456</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Paris</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="err">\</code>
<code class="linenos"> 8 </code><code class="nf">CITY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">TG</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">2364431</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">7</code><code class="no">.15</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">1</code><code class="no">.08333</code><code class="p">]]</code>
<code class="linenos"> 9 </code><code class="err">[[</code><code class="nl">GeoNameData:</code> <code class="nf">Canada</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">COUNTRY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">CA</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">6251999</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">60</code><code class="no">.10</code><code class="err">\</code>
<code class="linenos">10 </code><code class="err">867,</code> <code class="nl">longitude:</code> <code class="err">-113</code><code class="nf">.64258</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Canada</code> <code class="no">Bay</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">COUNTRY</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="err">\</code>
<code class="linenos">11 </code><code class="nf">AU</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">7839706</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">-33</code><code class="no">.8659</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">151</code><code class="no">.11591</code><code class="p">]]</code>
<code class="linenos">12 </code><code class="err">[[</code><code class="nl">GeoNameData:</code> <code class="nf">Baja</code> <code class="no">California</code> <code class="no">Sur</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">STATE</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">MX</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">4017698</code><code class="p">,</code> <code class="no">lati</code><code class="err">\</code>
<code class="linenos">13 </code><code class="nl">tude:</code> <code class="err">25</code><code class="nf">.83333</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-111</code><code class="no">.83333</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Baja</code> <code class="no">California</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">STATE</code><code class="p">,</code> <code class="err">\</code>
<code class="linenos">14 </code><code class="nf">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">MX</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">4017700</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">30</code><code class="no">.0</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-115</code><code class="no">.0</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Cal</code><code class="err">\</code>
<code class="linenos">15 </code><code class="nf">ifornia</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">STATE</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5332921</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">37</code><code class="no">.25022</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="err">\</code>
<code class="linenos">16 </code><code class="err">-119</code><code class="nf">.75126</code><code class="p">]]</code>
<code class="linenos">17 </code><code class="err">[[</code><code class="nl">GeoNameData:</code> <code class="nf">Amazon</code> <code class="no">Bay</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">RIVER</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">PG</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">2133985</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">-10</code><code class="err">\</code>
<code class="linenos">18 </code><code class="nf">.30264</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">149</code><code class="no">.36313</code><code class="p">]]</code>
<code class="linenos">19 </code><code class="err">[[</code><code class="nl">GeoNameData:</code> <code class="nf">Mount</code> <code class="no">Whitney</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5409018</code><code class="p">,</code> <code class="no">latitud</code><code class="err">\</code>
<code class="linenos">20 </code><code class="nl">e:</code> <code class="err">36</code><code class="nf">.57849</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-118</code><code class="no">.29194</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Peak</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">cou</code><code class="err">\</code>
<code class="linenos">21 </code><code class="nf">ntry</code> <code class="no">code</code><code class="p">:</code> <code class="no">AQ</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">6628058</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">-76</code><code class="no">.43333</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-126</code><code class="no">.05</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="err">\</code>
<code class="linenos">22 </code><code class="nf">Whitney</code> <code class="no">Point</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">AQ</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">6628059</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">-66</code><code class="no">.25</code><code class="p">,</code> <code class="no">long</code><code class="err">\</code>
<code class="linenos">23 </code><code class="nl">itude:</code> <code class="err">110</code><code class="nf">.51667</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Island</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">RU</code><code class="p">,</code> <code class="no">I</code><code class="err">\</code>
<code class="linenos">24 </code><code class="nl">D:</code> <code class="err">1500850,</code> <code class="nl">latitude:</code> <code class="err">81</code><code class="nf">.01149</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">60</code><code class="no">.88737</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Island</code><code class="p">,</code> <code class="err">\</code>
<code class="linenos">25 </code><code class="nl">type:</code> <code class="nf">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">AQ</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">6628055</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">-69</code><code class="no">.66187</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-68</code><code class="no">.5</code><code class="err">\</code>
<code class="linenos">26 </code><code class="err">0341],</code> <code class="err">[</code><code class="nl">GeoNameData:</code> <code class="nf">Whitney</code> <code class="no">Meadow</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5409010</code><code class="p">,</code> <code class="err">\</code>
<code class="linenos">27 </code><code class="nl">latitude:</code> <code class="err">36</code><code class="nf">.43216</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-118</code><code class="no">.26648</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Peak</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTA</code><code class="err">\</code>
<code class="linenos">28 </code><code class="nf">IN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5444110</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">39</code><code class="no">.43276</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-106</code><code class="no">.47309</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoN</code><code class="err">\</code>
<code class="linenos">29 </code><code class="nl">ameData:</code> <code class="nf">Whitney</code> <code class="no">Portal</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5409011</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">36</code><code class="err">\</code>
<code class="linenos">30 </code><code class="nf">.58882</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-118</code><code class="no">.22592</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Mountain</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">coun</code><code class="err">\</code>
<code class="linenos">31 </code><code class="nf">try</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">4136375</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">36</code><code class="no">.40146</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-93</code><code class="no">.91742</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="err">\</code>
<code class="linenos">32 </code><code class="nf">Whitney</code> <code class="no">Bridge</code> <code class="no">Dip</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">AU</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">11878190</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">-28</code><code class="no">.61</code><code class="err">\</code>
<code class="linenos">33 </code><code class="err">241,</code> <code class="nl">longitude:</code> <code class="err">153</code><code class="nf">.16546</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Point</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">cod</code><code class="err">\</code>
<code class="linenos">34 </code><code class="nl">e:</code> <code class="nf">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5815920</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">47</code><code class="no">.76037</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-122</code><code class="no">.85127</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitne</code><code class="err">\</code>
<code class="linenos">35 </code><code class="nf">y</code> <code class="no">Pass</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">US</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">5409024</code><code class="p">,</code> <code class="no">latitude</code><code class="p">:</code> <code class="mi">36</code><code class="no">.55577</code><code class="p">,</code> <code class="no">longitude</code><code class="err">\</code>
<code class="linenos">36 </code><code class="err">:</code> <code class="err">-118</code><code class="nf">.2812</code><code class="p">],</code> <code class="p">[</code><code class="no">GeoNameData</code><code class="p">:</code> <code class="no">Whitney</code> <code class="no">Island</code><code class="p">,</code> <code class="no">type</code><code class="p">:</code> <code class="no">MOUNTAIN</code><code class="p">,</code> <code class="no">country</code> <code class="no">code</code><code class="p">:</code> <code class="no">CA</code><code class="p">,</code> <code class="no">ID</code><code class="p">:</code> <code class="mi">61</code><code class="err">\</code>
<code class="linenos">37 </code><code class="err">81293,</code> <code class="nl">latitude:</code> <code class="err">58</code><code class="nf">.6505</code><code class="p">,</code> <code class="no">longitude</code><code class="p">:</code> <code class="mi">-78</code><code class="no">.71621</code><code class="p">]]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrap-up-for-information-gathering">Wrap-up for Information Gathering</h3>

<p>Access to data is an advantage large companies usually have over individuals and small organizations. That said, there is a lot of free information on the web and I hope my simple utility classes we have covered here will be of some use to you.</p>

<p>I respect the rights of people and organizations who put information on the web. This includes:</p>

<ul>
  <li>Read the terms of service on web sites to make sure your your of the site’s data is compliant and also avoid accessing any one web site too frequently.</li>
  <li>When you access services like DBpedia and Geonames consider caching the results so that you don’t ask the service for the same information repeatedly. This is particularly important during development and testing. In a later chapter we will see how to use the Apache Derby database to cache SPARQL queries to the DBPedia service.</li>
</ul>


<h2 id="ner">Resolve Entity Names to DBPedia References</h2>

<p>As a personal research project I have collected a large data set that maps entity names (e.g., people’s names, city names, names of music groups, company names, etc.) to the DBPedia URI for each entity. I have developed libraries to use this data in <a href="https://leanpub.com/lovinglisp">Common Lisp</a>, <a href="https://leanpub.com/haskell-cookbook">Haskell</a>, and Java. Here we use the Java version of this library.</p>

<p>The Java library is found in the directory <strong>ner_dbpedia</strong> in the GitHub repository. The raw data for these entity to URI mappings are found in the directory <strong>ner_dbpedia/dbpedia_as_text</strong>.</p>

<p>This example shows the use of a standard Java and Maven packaging technique: building a JAR file that contains resource files in addition to compiled Java code. The example code reads the required data resources from the JAR file (or the temporary <strong>target</strong> directory during development). This makes the JAR file self contained when we use this example library in later chapters.</p>

<h3 id="leanpub-auto-dbpedia-entities">DBPedia Entities</h3>

<p>DBPedia is the structured RDF database that is automatically created from WikiPedia info boxes. We will go into some detail on RDF data in the later chapter <a href="#semantic-web">Semantic Web</a>. The raw data for these entity to URI mappings is found in the directory <strong>ner_dbpedia/dbpedia_as_text</strong> files have the format (for people in this case):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Al Stewart      &lt;http://dbpedia.org/resource/Al_Stewart&gt;
Alan Watts      &lt;http://dbpedia.org/resource/Alan_Watts&gt;
</pre></div>

</figure>

<p>If you visit any or these URIs using a web browser, for example <a href="http://dbpedia.org/page/Al_Stewart">http://dbpedia.org/page/Al_Stewart</a> you will see the DBPedia data for the entity formatted for human reading but to be clear the primary purpose of information in DBPedia is for use by software, not humans.</p>

<p>There are 58953 entities defined with their DBPedia URI and the following listing shows the breakdown of number of entities by entity type by counting the number of lines in each resource file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>ner_dbpedia: $ wc -l ./src/main/resources/*.txt
     108 ./src/main/resources/BroadcastNetworkNamesDbPedia.txt
    2580 ./src/main/resources/CityNamesDbpedia.txt
    1786 ./src/main/resources/CompanyNamesDbPedia.txt
     167 ./src/main/resources/CountryNamesDbpedia.txt
   14315 ./src/main/resources/MusicGroupNamesDbPedia.txt
   35606 ./src/main/resources/PeopleDbPedia.txt
     555 ./src/main/resources/PoliticalPartyNamesDbPedia.txt
     351 ./src/main/resources/TradeUnionNamesDbPedia.txt
    3485 ./src/main/resources/UniversityNamesDbPedia.txt
   58953 total
</pre></div>

</figure>

<p>The URI for each entity defines a unique identifier for real world entities as well as concepts. 
## Library Implementation</p>

<p>The following UML class diagram shows the APIs and fields for the two classes in the package <strong>com.markwatson.ner_dbpedia</strong> for this example: <strong>NerMaps</strong> and <strong>TextToDbpediaUris</strong>:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/nerdbpedia-uml.png" alt="Overview of Java Class UML Diagram for this Example" style="width: 100%">
    <figcaption>Overview of Java Class UML Diagram for this Example</figcaption>
  </figure>
</div>


<p>As you see in the following figure showing the IntelliJ Community Edition project for this example, there are nine text files, one for each entity type in the directory <strong>src/main/resources</strong>. Later we will look at the code required to read these files in two cases:</p>

<ul>
  <li>During development these files are read from <strong>target/classes</strong>.</li>
  <li>During client application use of the JAR file (created using <em>mvn install</em>) these files are read as resources from the Java class loader.</li>
</ul>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/nerdbpedia-ide.png" alt="IDE View of Project" style="width: 100%">
    <figcaption>IDE View of Project</figcaption>
  </figure>
</div>


<p>The class <strong>com.markwatson.ner_dbpedia.NerMaps</strong> is a utility for reading the raw entity mapping data files and creating hash tables for these mappings:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.ner_dbpedia</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">java.io.*</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.nio.file.Files</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.nio.file.Paths</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.HashMap</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.Map</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.stream.Stream</code><code class="p">;</code>

<code class="cm">/**</code>
<code class="cm"> * Copyright Mark Watson 2020. Apache 2 license,</code>
<code class="cm"> */</code>
<code class="kd">public</code> <code class="kd">class</code> <code class="nc">NerMaps</code> <code class="p">{</code>

  <code class="kd">private</code> <code class="kd">static</code> <code class="n">String</code> <code class="nf">enforceAngleBrackets</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"&lt;"</code><code class="p">))</code> <code class="k">return</code> <code class="n">s</code><code class="p">;</code>
    <code class="k">return</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">s</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kd">private</code> <code class="kd">static</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="nf">textFileToMap</code><code class="p">(</code><code class="n">String</code> <code class="n">nerFileName</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">ret</code> <code class="o">=</code> <code class="k">new</code> <code class="n">HashMap</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
    <code class="k">try</code> <code class="p">{</code>
      <code class="n">InputStream</code> <code class="n">in</code> <code class="o">=</code> <code class="n">ClassLoader</code><code class="p">.</code><code class="na">getSystemResourceAsStream</code><code class="p">(</code><code class="n">nerFileName</code><code class="p">);</code>
      <code class="n">BufferedReader</code> <code class="n">reader</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BufferedReader</code><code class="p">(</code><code class="k">new</code> <code class="n">InputStreamReader</code><code class="p">(</code><code class="n">in</code><code class="p">));</code>
      <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">lines</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
      <code class="n">String</code> <code class="n">line2</code><code class="p">;</code>
      <code class="k">while</code><code class="p">((</code><code class="n">line2</code> <code class="o">=</code> <code class="n">reader</code><code class="p">.</code><code class="na">readLine</code><code class="p">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">lines</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">line2</code><code class="p">);</code>
      <code class="p">}</code>
      <code class="n">reader</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>
      <code class="n">lines</code><code class="p">.</code><code class="na">forEach</code><code class="p">(</code><code class="n">line</code> <code class="o">-&gt;</code> <code class="p">{</code>
        <code class="n">String</code><code class="o">[]</code> <code class="n">tokens</code> <code class="o">=</code> <code class="n">line</code><code class="p">.</code><code class="na">split</code><code class="p">(</code><code class="s">"\t"</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">tokens</code><code class="p">.</code><code class="na">length</code> <code class="o">&gt;</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
          <code class="n">ret</code><code class="p">.</code><code class="na">put</code><code class="p">(</code><code class="n">tokens</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="p">,</code> <code class="n">enforceAngleBrackets</code><code class="p">(</code><code class="n">tokens</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">));</code>
        <code class="p">}</code>
      <code class="p">});</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="p">)</code> <code class="p">{</code>
      <code class="n">ex</code><code class="p">.</code><code class="na">printStackTrace</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">broadcastNetworks</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"BroadcastNetworkNamesDbPedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">cityNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"CityNamesDbpedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">companyames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"CompanyNamesDbPedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">countryNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"CountryNamesDbpedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">musicGroupNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"MusicGroupNamesDbPedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">personNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"PeopleDbPedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">politicalPartyNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"PoliticalPartyNamesDbPedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">tradeUnionNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"TradeUnionNamesDbPedia.txt"</code><code class="p">);</code>
  <code class="kd">static</code> <code class="kd">public</code> <code class="kd">final</code> <code class="n">Map</code><code class="o">&lt;</code><code class="n">String</code><code class="p">,</code> <code class="n">String</code><code class="o">&gt;</code> <code class="n">universityNames</code> <code class="o">=</code> 
    <code class="n">textFileToMap</code><code class="p">(</code><code class="s">"UniversityNamesDbPedia.txt"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>com.markwatson.ner_dbpedia.TextToDbpediaUris</strong> processes an input string and uses public fields to output found entity names and matching DBPedia URIs. We will use this code later in the chapter <em>Automatically Generating Data for Knowledge Graphs</em>.</p>

<p>The code in the class <strong>TextToDbpediaUris</strong> is simple and repeats two common patterns for each entity type. We will look at some of the code here.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.ner_dbpedia</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">TextToDbpediaUris</code> <code class="p">{</code>
  <code class="kd">private</code> <code class="nf">TextToDbpediaUris</code><code class="p">()</code> <code class="p">{</code>
  <code class="p">}</code>

  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">personUris</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">personNames</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">companyUris</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code><code class="p">();</code>
  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">companyNames</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="o">&lt;&gt;</code><code class="p">();</code>
</pre></div>

</figure>

<p>The empty constructor is private since it makes no sense to create an instance of <strong>TextToDbpediaUris</strong> without text input. The code supports nine entity types. Here we show the definition of public output fields for just two entity types (people and companies).</p>

<p>As a matter of programming style I generally no longer use getter and setter methods, preferring a more concise coding style. I usually make output fields package default visibility (i.e., no <strong>private</strong> or <strong>public</strong> specification so the fields are public within a package and private from other packages). Here I make them public because the package <strong>nerdbpedia</strong> developed here is meant to be used by other packages. If you prefer using getter and setter methods, modern IDEs like IntelliJ and Eclipse can generate those for you for the example code in this book.</p>

<p>We will handle entity names comprised of one, two, and three word sequences. We check for longer word sequences before shorter sequences:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">public</code> <code class="nf">TextToDbpediaUris</code><code class="p">(</code><code class="n">String</code> <code class="n">text</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">String</code><code class="o">[]</code> <code class="n">tokens</code> <code class="o">=</code> <code class="n">tokenize</code><code class="p">(</code><code class="n">text</code> <code class="o">+</code> <code class="s">" . . ."</code><code class="p">);</code>
    <code class="n">String</code> <code class="n">uri</code> <code class="o">=</code> <code class="s">""</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">size</code> <code class="o">=</code> <code class="n">tokens</code><code class="p">.</code><code class="na">length</code> <code class="o">-</code> <code class="mi">2</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">size</code><code class="p">;</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
      <code class="n">String</code> <code class="n">n2gram</code> <code class="o">=</code> <code class="n">tokens</code><code class="o">[</code><code class="n">i</code><code class="o">]</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">tokens</code><code class="o">[</code><code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="o">]</code><code class="p">;</code>
      <code class="n">String</code> <code class="n">n3gram</code> <code class="o">=</code> <code class="n">n2gram</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">tokens</code><code class="o">[</code><code class="n">i</code> <code class="o">+</code> <code class="mi">2</code><code class="o">]</code><code class="p">;</code>
      <code class="c1">// check for 3grams:</code>
      <code class="k">if</code> <code class="p">((</code><code class="n">uri</code> <code class="o">=</code> <code class="n">NerMaps</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">n3gram</code><code class="p">))</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">log</code><code class="p">(</code><code class="s">"person"</code><code class="p">,</code> <code class="n">i</code><code class="p">,</code> <code class="n">i</code> <code class="o">+</code> <code class="mi">2</code><code class="p">,</code> <code class="n">n3gram</code><code class="p">,</code> <code class="n">uri</code><code class="p">);</code>
        <code class="n">i</code> <code class="o">+=</code> <code class="mi">2</code><code class="p">;</code>
        <code class="k">continue</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>NerMaps</strong> that we previously saw listed converts text files of entities to DBPedia URIs mappings to Java hash maps. The method <strong>log</strong> does two things:</p>

<ul>
  <li>Prints out the entity type, the word indices from the original tokenized text, the entity name as a single string (combine tokens for an entity to a string), and the DBPedia URI.</li>
  <li>Saves entity mapping in the public fields <strong>personUris</strong>, <strong>personNames</strong>, etc.</li>
</ul>

<p>After we check for three word entity names, we process two word names, and one word names. Here is an example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>      <code class="c1">// check for 2grams:</code>
      <code class="k">if</code> <code class="p">((</code><code class="n">s</code> <code class="o">=</code> <code class="n">NerMaps</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">n2gram</code><code class="p">))</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="n">log</code><code class="p">(</code><code class="s">"person"</code><code class="p">,</code> <code class="n">i</code><code class="p">,</code> <code class="n">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="n">n2gram</code><code class="p">,</code> <code class="n">s</code><code class="p">);</code>
        <code class="n">i</code> <code class="o">+=</code> <code class="mi">1</code><code class="p">;</code>
        <code class="k">continue</code><code class="p">;</code>
      <code class="p">}</code>
</pre></div>

</figure>

<p>The following listing shows the <strong>log</strong> method that write descriptive output and saves entity mappings. We only show the code for the entity type <em>person</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">log</code><code class="p">(</code><code class="n">String</code> <code class="n">nerType</code><code class="p">,</code> <code class="kt">int</code> <code class="n">index1</code><code class="p">,</code> <code class="kt">int</code> <code class="n">index2</code><code class="p">,</code> <code class="n">String</code> <code class="n">ngram</code><code class="p">,</code> <code class="n">String</code> <code class="n">uri</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">nerType</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code> <code class="n">index1</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code> <code class="n">index2</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code> 
                       <code class="n">ngram</code> <code class="o">+</code> <code class="s">"\t"</code> <code class="o">+</code> <code class="n">uri</code><code class="p">);</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">uri</code><code class="p">.</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"&lt;"</code><code class="p">))</code> <code class="n">uri</code> <code class="o">=</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">uri</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">nerType</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"person"</code><code class="p">))</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="n">personUris</code><code class="p">.</code><code class="na">contains</code><code class="p">(</code><code class="n">uri</code><code class="p">))</code> <code class="p">{</code>
        <code class="n">personUris</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">uri</code><code class="p">);</code>
        <code class="n">personNames</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">ngram</code><code class="p">);</code>
      <code class="p">}</code>
    <code class="p">}</code>
</pre></div>

</figure>

<p>For some NLP applications I will use a standard tokenizer like the OpenNLP tokenizer that we used in two previous chapters. Here, I simply add spaces around punctuation characters and use the Java string <strong>split</strong> method:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="kd">private</code> <code class="n">String</code><code class="o">[]</code> <code class="nf">tokenize</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">s</code><code class="p">.</code><code class="na">replaceAll</code><code class="p">(</code><code class="s">"\\."</code><code class="p">,</code> <code class="s">" \\. "</code><code class="p">).</code>
             <code class="n">replaceAll</code><code class="p">(</code><code class="s">","</code><code class="p">,</code> <code class="s">" , "</code><code class="p">).</code>
             <code class="n">replaceAll</code><code class="p">(</code><code class="s">"\\?"</code><code class="p">,</code> <code class="s">" ? "</code><code class="p">).</code>
             <code class="n">replaceAll</code><code class="p">(</code><code class="s">"\n"</code><code class="p">,</code> <code class="s">" "</code><code class="p">).</code>
             <code class="n">replaceAll</code><code class="p">(</code><code class="s">";"</code><code class="p">,</code> <code class="s">" ; "</code><code class="p">).</code><code class="na">split</code><code class="p">(</code><code class="s">" "</code><code class="p">);</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>The following listing shows the code snippet from the unit test code in the class <strong>TextToDbpediaUrisTest</strong> that calls the <strong>TextToDbpediaUris</strong> constructor with a text sample (<strong>junit</strong> boilerplate code is not shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.markwatson.ner_dbpedia</code><code class="p">;</code>
<code class="linenos"> 2 </code> 
<code class="linenos"> 3 </code>  <code class="p">...</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code>  <code class="cm">/**</code>
<code class="linenos"> 6 </code><code class="cm">   * Test that is just for side effect printouts:</code>
<code class="linenos"> 7 </code><code class="cm">   */</code>
<code class="linenos"> 8 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">test1</code><code class="p">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos"> 9 </code>    <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="s">"PTL Satellite Network covered President Bill Clinton going to "</code>   
<code class="linenos">10 </code>      <code class="o">+</code> <code class="s">" Guatemala and visiting the Coca Cola Company."</code><code class="p">;</code>
<code class="linenos">11 </code>    <code class="n">TextToDbpediaUris</code> <code class="n">test</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TextToDbpediaUris</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="linenos">12 </code>  <code class="p">}</code>
<code class="linenos">13 </code><code class="p">}</code>
</pre></div>

</figure>

<p>On line 11, the object <strong>test</strong> contains public fields for accessing the entity names and corresponding URIs. We will use these fields in the later chapters <a href="#kgcreator">Automatically Generating Data for Knowledge Graphs</a> and <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<p>Here is the output from running the unit test code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>broadcastNetwork 0 2 PTL Satellite Network &lt;http://dbpedia.org/resource/PTL_Satellit\
e_Network&gt;
person	 5	 6	 Bill Clinton	&lt;http://dbpedia.org/resource/Bill_Clinton&gt;
country	 9 10  Guatemala	 &lt;http://dbpedia.org/resource/Guatemala&gt;
company	13	 14  Coca Cola	&lt;http://dbpedia.org/resource/Coca-Cola&gt;
</pre></div>

</figure>

<h3 id="leanpub-auto-wrap-up-for-resolving-entity-names-to-dbpedia-references">Wrap-up for Resolving Entity Names to DBPedia References</h3>

<p>The idea behind this example is simple but useful for information processing applications using raw text input. We will use this library later in two semantic web examples.</p>


<h2 id="semantic-web">Semantic Web</h2>

<p>We will start with a tutorial on semantic web data standards like RDF, RDFS, and OWL, then implement a wrapper for the Apache Jena library, and finally take a deeper dive into some examples. You will learn how to do the following:</p>

<ul>
  <li>Understand RDF data formats.</li>
  <li>Understand SPARQL queries for RDF data stores (both local and remote).</li>
  <li>Use the Apache Jena library to use local RDF data and perform SPARQL queries that return pure Java data structures.</li>
  <li>Use the Apache Jena library to query remote SPARQL endpoints like DBPedia and WikiData.</li>
  <li>Use the Apache Derby relational database to cache SPARQL remote queries for both efficiency and for building systems that may have intermittent access to the Internet.</li>
  <li>Take a deeper dive into RDF, RDFS, and OWL reasoners.</li>
</ul>

<p>The semantic web is intended to provide a massive linked set of data for use by software systems just as the World Wide Web provides a massive collection of linked web pages for human reading and browsing. The semantic web is like the web in that anyone can generate any content that they want. This freedom to publish anything works for the web because we use our ability to understand natural language to interpret what we read – and often to dismiss material that based upon our own knowledge we consider to be incorrect.</p>

<p>Semantic web and linked data technologies are also useful for smaller amounts of data, an example being a Knowledge Graph containing information for a business. We will further explore Knowledge Graphs in the next two chapters.</p>

<p>The core concept for the semantic web is data integration and use from different sources. As we will soon see, the tools for implementing the semantic web are designed for encoding data and sharing data from many different sources.</p>

<p>I cover the semantic web in this book because I believe that semantic web technologies are complementary to AI systems for gathering and processing data on the web. As more web pages are generated by applications (as opposed to simply showing static HTML files) it becomes easier to produce both HTML for human readers and semantic data for software agents.</p>

<p>There are several very good semantic web toolkits for the Java language and platform. Here we use Apache Jena because it is what I often use in my own work and I believe that it is a good starting technology for your first experiments with semantic web technologies. This chapter provides an incomplete coverage of semantic web technologies and is intended as a gentle introduction to a few useful techniques and how to implement those techniques in Java. This chapter is the start of a journey in the technology that I think is as important as technologies like deep learning that get more public mindshare.</p>

<p>The following figure shows a layered hierarchy of data models that are used to implement semantic web applications. To design and implement these applications we need to think in terms of physical models (storage and access of RDF, RDFS, and perhaps OWL data), logical models (how we use RDF and RDFS to define relationships between data represented as unique URIs and string literals and how we logically combine data from different sources) and conceptual modeling (higher level knowledge representation and reasoning using OWL). Originally RDF data was serialized as XML data but other formats have become much more popular because they are easier to read and manually create. The top three layers in the figure might be represented as XML, or as LD-JSON (linked data JSON) or formats like N-Triples and N3 that we will use later.</p>


<div class="figure-wrapper center">
  <figure id="semantic-web-data-models" class="image" style="width: 249px">
    <img src="images/semantic_web_data.png" alt="Semantic Web Data Models" style="width: 100%">
    <figcaption>Semantic Web Data Models</figcaption>
  </figure>
</div>


<p>This chapter is meant to get you interested in this technology but is not intended as a complete guide. RDF data is the bedrock of the semantic web. I am also lightly covering RDFS/OWL modeling, and Descriptive Logic Reasoners which are important topics for more advanced semantic web projects.</p>

<h3 id="leanpub-auto-available-tools">Available Tools</h3>

<p>In the previous edition of this book I used the open source Sesame library for the material on RDF. Sesame is now called RDF4J and is part of the Eclipse organization’s projects.</p>

<p>I decided to use the Apache Jena project in this new edition because I think Jena is slightly easier to set up a light weight development environment. If you need to set up an RDF server I recommend using the <a href="https://jena.apache.org/documentation/fuseki2/">Fuseki</a> server which is part of the Apache Jena project. For client applications we will use the Jena library for working with RDF and performing SPARQL queries using the example classss <strong>JenaApis</strong> that we implement later and also for querying remote SPARQL endpoints (i.e., public RDF data sources with SPARQL query interfaces) like DBPedia and WikiData.</p>

<h3 id="rdms-problems">Relational Database Model Has Problems Dealing with Rapidly Changing Data Requirements</h3>

<p>When people are first introduced to semantic web technologies their first reaction is often something like, “I can just do that with a database.” The relational database model is an efficient way to express and work with slowly changing data schemas. There are some clever tools for dealing with data change requirements in the database world (ActiveRecord and migrations being a good example) but it is awkward to have end users and even developers tagging on new data attributes to relational database tables.</p>

<p>This same limitation also applies to object oriented programming and object modeling. Even with dynamic languages that facilitate modifying classes at runtime, the options for adding attributes to existing models are just too limiting. The same argument can be made against the use of XML constrained by conformance to either DTDs or XML Schemas. It is true that RDF and RDFS can be serialized to XML using many pre existing XML namespaces for different knowledge sources and schemas but it turns out that this is done in a way that does not reduce the flexibility for extending data models. XML storage is really only a serialization of RDF and many developers who are just starting to use semantic web technologies initially get confused trying to read XML serialization of RDF – almost like trying to read a PDF file with a plain text editor and something to be avoided. We will use the N-Triple and N3 formats that are simpler to read and understand.</p>

<p>One goal for the rest of this chapter is convincing you that modeling data with RDF and RDFS facilitates freely extending data models and also allows fairly easy integration of data from different sources using different schemas without explicitly converting data from one schema to another for reuse. You are free to add new data properties and add information to existing graphs (which we refer to a <em>models</em>).</p>

<h3 id="leanpub-auto-rdf-the-universal-data-format">RDF: The Universal Data Format</h3>

<p>The Resource Description Framework (RDF) is used to encode information and the RDF Schema (RDFS) facilitates using data with different RDF encodings without the need to convert one set of schemas to another. Later, using OWL we can simply declare that one predicate is the same as another, that is, one predicate is a sub-predicate of another (e.g., a property <strong>containsCity</strong> can be declared to be a sub-property of <strong>containsPlace</strong> so if something contains a city then it also contains a place), etc. The predicate part of an RDF statement often refers to a property.</p>

<p>RDF data was originally encoded as XML and intended for automated processing. In this chapter we will use two simple to read formats called “N-Triples” and “N3.” Apache Jena can be used to convert between all RDF formats so we might as well use formats that are easier to read and understand. RDF data consists of a set of triple values:</p>

<ul>
  <li>subject</li>
  <li>predicate</li>
  <li>object</li>
</ul>

<p>Some of my work with semantic web technologies deals with processing news stories, extracting semantic information from the text, and storing it in RDF. I will use this application domain for the examples in this chapter and the next chapter when we implement code to automatically generate RDF for Knowledge Graphs. I deal with triples like:</p>

<ul>
  <li>subject: a URL (or URI) of a news article.</li>
  <li>predicate: a relation like “containsPerson”.</li>
  <li>object: a literal value like “Bill Clinton” or a URI representing Bill Clinton.</li>
</ul>

<p>In the next chapter we will use the entity recognition library we developed in an earlier chapter to create RDF from text input.</p>

<p>We will use either URIs or string literals as values for objects. We will always use URIs for representing subjects and predicates. In any case URIs are usually preferred to string literals. We will see an example of this preferred use but first we need to learn the N-Triple and N3 RDF formats.</p>

<p>I proposed the idea that RDF was more flexible than Object Modeling in programming languages, relational databases, and XML with schemas. If we can tag new attributes on the fly to existing data, how do we prevent what I might call “data chaos” as we modify existing data sources? It turns out that the solution to this problem is also the solution for encoding real semantics (or meaning) with data: we usually use unique URIs for RDF subjects, predicates, and objects, and usually with a preference for not using string literals. The definitions of predicates are tied to a namespace and later with OWL we will state the equivalence of predicates in different namespaces with the same semantic meaning. I will try to make this idea more clear with some examples and <a href="https://en.wikipedia.org/wiki/Resource_Description_Framework">Wikipedia has a good writeup on RDF</a>.</p>

<p>Any part of a triple (subject, predicate, or object) is either a URI or a string literal. URIs encode namespaces. For example, the containsPerson predicate in the last example could be written as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">knowledgebooks</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">ontology</code><code class="o">/</code><code class="c">#containsPerson</code>
</pre></div>

</figure>

<p>The first part of this URI is considered to be the namespace for this predicate “containsPerson.” When different RDF triples use this same predicate, this is some assurance to us that all users of this predicate understand to the same meaning. Furthermore, we will see later that we can use RDFS to state equivalency between this predicate (in the namespace http://knowledgebooks.com/ontology/) with predicates represented by different URIs used in other data sources. In an “artificial intelligence” sense, software that we write does not understand predicates like “containsCity”,  “containsPerson”, or “isLocation” in the way that a human reader can by combining understood common meanings for the words “contains”, “city”, “is”, “person”, and “location” but for many interesting and useful types of applications that is fine as long as the predicate is used consistently. We will see shortly that we can define abbreviation prefixes for namespaces which makes RDF and RDFS files shorter and easier to read.</p>

<p>The Jena library supports most serialization formats for RDF:</p>

<ul>
  <li>Turtle</li>
  <li>N3</li>
  <li>N-Triples</li>
  <li>NQuads</li>
  <li>TriG</li>
  <li>JSON-LD</li>
  <li>RDF/XML</li>
  <li>RDF/JSON</li>
  <li>TriX</li>
  <li>RDF Binary</li>
</ul>

<p>A statement in N-Triple format consists of three URIs (two URIs and a string literals for the object) followed by a period to end the statement. While statements are often written one per line in a source file they can be broken across lines; it is the ending period which marks the end of a statement. The standard file extension for N-Triple format files is *.nt and the standard format for N3 format files is *.n3.</p>

<p>My preference is to use N-Triple format files as output from programs that I write to save data as RDF. N-Triple files don’t use any abbreviations and each RDF statement is self-contained. I often use tools like the command line commands in Jena or RDF4J to convert N-Triple files to N3 or other formats if I will be reading them or even hand editing them. Here is an example using the N3 syntax:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"China"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>The N3 format adds prefixes (abbreviations) to the N-Triple format. In practice it would be better to use the URI <strong><a href="http://dbpedia.org/resource/China">http://dbpedia.org/resource/China</a></strong> instead of the literal value “China.”</p>

<p>Here we see the use of an abbreviation prefix “kb:” for the namespace for my company KnowledgeBooks.com ontologies. The first term in the RDF statement (the subject) is the URI of a news article. The second term (the predicate) is “containsCountry” in the “kb:” namespace. The last item in the statement (the object) is a string literal “China.” I would describe this RDF statement in English as, “The news article at URI http://news.com/201234 mentions the country China.”</p>

<p>This was a very simple N3 example which we will expand to show additional features of the N3 notation. As another example, let’s look at the case if this news article also mentions the USA. Instead of adding a whole new statement like this we can combine them using N3 notation. Here we have two separate RDF statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
</pre></div>

</figure>

<p>We can collapse multiple RDF statements that share the same subject and optionally the same predicate:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
    <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code> <code class="p">,</code>
    <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
</pre></div>

</figure>

<p>The indentation and placement on separate lines is arbitrary - use whatever style you like that is readable. We can also add in additional predicates that use the same subject (I am going to use string literals here instead of URIs for objects to make the following example more concise but in practice prefer using URIs):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"China"</code> <code class="p">,</code>
                           <code class="s">"USA"</code> <code class="p">.</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"United Nations"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Ban Ki-moon"</code> <code class="p">,</code> <code class="s">"Gordon Brown"</code> <code class="p">,</code>
                          <code class="s">"Hu Jintao"</code> <code class="p">,</code> <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Pervez Musharraf"</code> <code class="p">,</code>
                          <code class="s">"Vladimir Putin"</code> <code class="p">,</code> 
                          <code class="s">"Mahmoud Ahmadinejad"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>This single N3 statement represents ten individual RDF triples. Each section defining triples with the same subject and predicate have objects separated by commas and ending with a period. Please note that whatever RDF storage system you use (we will be using Jena) it makes no difference if we load RDF as XML, N-Triple, of N3 format files: internally subject, predicate, and object triples are stored in the same way and are used in the same way. RDF triples in a data store represent directed graphs that may not all be connected.</p>

<p>I promised you that the data in RDF data stores was easy to extend. As an example, let us assume that we have written software that is able to read online news articles and create RDF data that captures some of the semantics in the articles. If we extend our program to also recognize dates when the articles are published, we can simply reprocess articles and for each article add a triple to our RDF data store using a form like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">datePublished</code> <code class="s">"2008-05-11"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Here we just represent the date as a string. We can add a type to the object representing a specific date:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">xsd</code><code class="p">:</code> <code class="nl">&lt;http://www.w3.org/2001/XMLSchema#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
 
 <code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">datePublished</code> <code class="s">"2008-05-11"</code><code class="o">^^</code><code class="nn">xsd</code><code class="p">:</code><code class="nt">date</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Furthermore, if we do not have dates for all news articles that is often acceptable because when constructing SPARQL queries you can match optional patterns. If for example you are looking up articles on a specific subject then some results may have a publication date attached to the results for that article and some might not. In practice RDF supports types and we would use a date type as seen in the last example, not a string. However, in designing the example programs for this chapter I decided to simplify our representation of URIs and often use string literals as simple Java strings. For many applications this isn’t a real limitation.</p>

<h3 id="rdfs">Extending RDF with RDF Schema</h3>

<p>RDF Schema (RDFS) supports the definition of classes and properties based on set inclusion. In RDFS classes and properties are orthogonal. Let’s start with looking at an example using additional namespaces:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdf</code><code class="p">:</code> <code class="nl">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>   <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">dbo</code><code class="p">:</code> <code class="nl">&lt;http://dbpedia.org/ontology/&gt;</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>
  <code class="nn">rdfs</code><code class="p">:</code><code class="nt">label</code> <code class="s">"China"</code><code class="o">@</code><code class="nf">en</code><code class="p">,</code>
  <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">dbo</code><code class="p">:</code><code class="nt">Place</code> <code class="p">,</code>
  <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">dbo</code><code class="p">:</code><code class="nt">Country</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Because the semantic web is intended to be processed automatically by software systems it is encoded as RDF. There is a problem that must be solved in implementing and using the semantic web: everyone who publishes semantic web data is free to create their own RDF schemas for storing data; for example, there is usually no single standard RDF schema definition for topics like news stories and stock market data. The <a href="https://www.w3.org/2009/08/skos-reference/skos.html">SKOS</a> is a namespace containing standard schemas and the most widely used standard is <a href="https://schema.org/docs/schemas.html">schema.org</a>. Understanding the ways of integrating different data sources using different schemas helps to understand the design decisions behind the semantic web applications. In this chapter I often use my own schemas in the knowledgebooks.com namespace for the simple examples you see here. When you build your own production systems part of the work is searching through <strong>schema.org</strong> and <strong>SKOS</strong> to use standard name spaces and schemas when possible. The use of standard schemas helps when you link internal proprietary Knowledge Graphs used in organization with public open data from sources like <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">WikiData</a> and <a href="https://wiki.dbpedia.org/about">DBPedia</a>.</p>

<p>We will start with an example that is an extension of the example in the last section that also uses RDFS. We add a few additional RDF statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>  <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
</pre></div>

</figure>

<p>The last three lines declare that:</p>

<ul>
  <li>The property containsCity is a sub-property of containsPlace.</li>
  <li>The property containsCountry is a sub-property of containsPlace.</li>
  <li>The property containsState is a sub-property of containsPlace.</li>
</ul>

<p>Why is this useful? For at least two reasons:</p>

<ul>
  <li>You can query an RDF data store for all triples that use property containsPlace and also match triples with properties equal to containsCity, containsCountry, or containsState. There may not even be any triples that explicitly use the property containsPlace.</li>
  <li>Consider a hypothetical case where you are using two different RDF data stores that use different properties for naming cities: <strong>cityName</strong> and <strong>city</strong>. You can define <strong>cityName</strong> to be a sub-property of <strong>city</strong> and then write all queries against the single property name <strong>city</strong>. This removes the necessity to convert data from different sources to use the same Schema. You can also use OWL to state property and class equivalency.</li>
</ul>

<p>In addition to providing a vocabulary for describing properties and class membership by properties, RDFS is also used for logical inference to infer new triples, combine data from different RDF data sources, and to allow effective querying of RDF data stores. We will see examples of all of these features of RDFS when we later start using the Jena libraries to perform SPARQL queries.</p>

<h3 id="leanpub-auto-the-sparql-query-language">The SPARQL Query Language</h3>

<p>SPARQL is a query language used to query RDF data stores. While SPARQL may initially look like SQL, we will see that there are some important differences like support for RDFS and OWL inferencing and graph-based instead of relational matching operations. We will cover the basics of SPARQL in this section and then see more examples later when we learn how to embed Jena in Java applications, and see more examples in the last chapter <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<p>We will use the N3 format RDF file test_data/news.n3 for the examples. I created this file automatically by spidering Reuters news stories on the news.yahoo.com web site and automatically extracting named entities from the text of the articles. We saw techniques for extracting named entities from text in earlier chapters. In this chapter we use these sample RDF files.</p>

<p>You have already seen snippets of this file and I list the entire file here for reference, edited to fit line width: you may find the file news.n3 easier to read if you are at your computer and open the file in a text editor so you will not be limited to what fits on a book page:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>  <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/20080616/usa_flooding_dc_16/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Burlington"</code> <code class="p">,</code> <code class="s">"Denver"</code> <code class="p">,</code>
                        <code class="s">"St. Paul"</code> <code class="p">,</code><code class="s">" Chicago"</code> <code class="p">,</code>
                        <code class="s">"Quincy"</code> <code class="p">,</code> <code class="s">"CHICAGO"</code> <code class="p">,</code>
                        <code class="s">"Iowa City"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsRegion</code> <code class="s">"U.S. Midwest"</code> <code class="p">,</code> <code class="s">"Midwest"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Japan"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Minnesota"</code> <code class="p">,</code> <code class="s">"Illinois"</code> <code class="p">,</code> 
                         <code class="s">"Mississippi"</code> <code class="p">,</code> <code class="s">"Iowa"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"National Guard"</code> <code class="p">,</code>
                         <code class="s">"U.S. Department of Agriculture"</code> <code class="p">,</code>
                         <code class="s">"White House"</code> <code class="p">,</code>
                         <code class="s">"Chicago Board of Trade"</code> <code class="p">,</code>
                         <code class="s">"Department of Transportation"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Dena Gray-Fisher"</code> <code class="p">,</code>
                          <code class="s">"Donald Miller"</code> <code class="p">,</code>
                          <code class="s">"Glenn Hollander"</code> <code class="p">,</code>
                          <code class="s">"Rich Feltes"</code> <code class="p">,</code>
                          <code class="s">"George W. Bush"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"food inflation"</code> <code class="p">,</code> <code class="s">"food"</code> <code class="p">,</code>
                                <code class="s">"finance ministers"</code> <code class="p">,</code>
                                <code class="s">"oil"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/78325/ts_nm/usa_politics_dc_2/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Washington"</code> <code class="p">,</code> <code class="s">"Baghdad"</code> <code class="p">,</code>
                        <code class="s">"Arlington"</code> <code class="p">,</code> <code class="s">"Flint"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code>
                           <code class="s">"Afghanistan"</code> <code class="p">,</code>
                           <code class="s">"Iraq"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Illinois"</code> <code class="p">,</code> <code class="s">"Virginia"</code> <code class="p">,</code>
                         <code class="s">"Arizona"</code> <code class="p">,</code> <code class="s">"Michigan"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"White House"</code> <code class="p">,</code>
                                <code class="s">"Obama administration"</code> <code class="p">,</code>
                                <code class="s">"Iraqi government"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"David Petraeus"</code> <code class="p">,</code>
                          <code class="s">"John McCain"</code> <code class="p">,</code>
                          <code class="s">"Hoshiyar Zebari"</code> <code class="p">,</code>
                          <code class="s">"Barack Obama"</code> <code class="p">,</code>
                          <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Carly Fiorina"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"oil prices"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/10944/ts_nm/worldleaders_dc_1/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"WASHINGTON"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Pakistan"</code> <code class="p">,</code>
                           <code class="s">"Islamic Republic of Iran"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Maryland"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"University of Maryland"</code> <code class="p">,</code>
                                <code class="s">"United Nations"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Ban Ki-moon"</code> <code class="p">,</code> <code class="s">"Gordon Brown"</code> <code class="p">,</code>
                          <code class="s">"Hu Jintao"</code> <code class="p">,</code> <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Pervez Musharraf"</code> <code class="p">,</code>
                          <code class="s">"Vladimir Putin"</code> <code class="p">,</code>
                          <code class="s">"Steven Kull"</code> <code class="p">,</code>
                          <code class="s">"Mahmoud Ahmadinejad"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/10622/global_economy_dc_4/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Sao Paulo"</code> <code class="p">,</code> <code class="s">"Kuala Lumpur"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsRegion</code> <code class="s">"Midwest"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Britain"</code> <code class="p">,</code>
                           <code class="s">"Saudi Arabia"</code> <code class="p">,</code> <code class="s">"Spain"</code> <code class="p">,</code>
                           <code class="s">"Italy"</code> <code class="p">,</code> <code class="err">Indi</code><code class="k">a</code><code class="s">" , </code>
                           <code class="s">""</code><code class="err">France</code><code class="s">" , "</code><code class="err">Canad</code><code class="k">a</code><code class="s">" ,</code>
                           <code class="s">"Russia"</code> <code class="p">,</code> <code class="s">"Germany"</code> <code class="p">,</code> <code class="s">"China"</code> <code class="p">,</code>
                           <code class="s">"Japan"</code> <code class="p">,</code> <code class="s">"South Korea"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"Federal Reserve Bank"</code> <code class="p">,</code>
                                <code class="s">"European Union"</code> <code class="p">,</code>
                                <code class="s">"European Central Bank"</code> <code class="p">,</code>
                                <code class="s">"European Commission"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Lee Myung-bak"</code> <code class="p">,</code> <code class="s">"Rajat Nag"</code> <code class="p">,</code>
                          <code class="s">"Luiz Inacio Lula da Silva"</code> <code class="p">,</code>
                          <code class="s">"Jeffrey Lacker"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCompany</code> <code class="s">"Development Bank Managing"</code> <code class="p">,</code>
                           <code class="s">"Reuters"</code> <code class="p">,</code>
                           <code class="s">"Richmond Federal Reserve Bank"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"central bank"</code> <code class="p">,</code> <code class="s">"food"</code> <code class="p">,</code>
                                <code class="s">"energy costs"</code> <code class="p">,</code>
                                <code class="s">"finance ministers"</code> <code class="p">,</code>
                                <code class="s">"crude oil prices"</code> <code class="p">,</code>
                                <code class="s">"oil prices"</code> <code class="p">,</code>
                                <code class="s">"oil shock"</code> <code class="p">,</code>
                                <code class="s">"food prices"</code> <code class="p">,</code>
                                <code class="s">"Finance ministers"</code> <code class="p">,</code>
                                <code class="s">"Oil prices"</code> <code class="p">,</code> <code class="s">"oil"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>In the following examples, we will use the main method in the class <strong>JenaApi</strong> (developed in the next section) that allows us to load multiple RDF input files and then to interactively enter SPARQL queries.</p>

<p>We will start with a simple SPARQL query for subjects (news article URLs) and objects (matching countries) with the value for the predicate equal to <strong>containsCountry</strong>. Variables in queries start with a question mark character and can have any names:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
      <code class="k">WHERE</code> <code class="p">{</code>
        <code class="nv">?subject</code>
        <code class="nl">&lt;http://knowledgebooks.com/ontology#containsCountry&gt;</code>
        <code class="nv">?object</code> <code class="p">.</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>It is important for you to understand what is happening when we apply the last SPARQL query to our sample data. Conceptually, all the triples in the sample data are scanned, keeping the ones where the predicate part of a triple is equal to <strong><a href="http://knowledgebooks.com/ontology#containsCountry">http://knowledgebooks.com/ontology#containsCountry</a></strong>. In practice RDF data stores supporting SPARQL queries index RDF data so a complete scan of the sample data is not required. This is analogous to relational databases where indices are created to avoid needing to perform complete scans of database tables.</p>

<p>In practice, when you are exploring a Knowledge Graph like DBPedia or WikiData (that are just very large collections of RDF triples), you might run a query and discover a useful or interesting entity URI in the triple store, then drill down to find out more about the entity. In a later chapter <a href="#kgn">Knowledge Graph Navigator</a> we attempt to automate this exploration process using the DBPedia data as a Knowledge Graph.</p>

<p>We will be using the same code to access the small example of RDF statements in our sample data as we will for accessing DBPedia or WikiData.</p>

<p>We can make this last query easier to read and reduce the chance of misspelling errors by using a namespace prefix:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
  <code class="k">WHERE</code> <code class="p">{</code>
      <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nv">?object</code> <code class="p">.</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p><strong>Using the command line option in the Jena wrapper example</strong></p>

<p>We will later implement the Java class <strong>JenaApis</strong>. You can run the method <strong>main</strong> in the Java class <strong>JenaApis</strong> using the following to load RDF input files and interactively make SPARQL queries against the RDF data in the input files:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"com.markwatson.semanticweb.JenaApis"</code> <code class="se">\</code>
<code class="linenos">2 </code>               -Dexec.args<code class="o">=</code><code class="s2">"data/news.n3 data/sample_news.nt"</code>
</pre></div>

</figure>

<p>The command line argument in line 3 starting with <strong>-Dexec.args=</strong> is one way to pass command line arguments to the method <strong>main</strong>. The backslash character at the end of line 2 is the way to continue a long command line request in bash or zsh.</p>

<p>Here is an interactive example of the last SPARQL example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ mvn exec:java -Dexec.mainClass<code class="o">=</code><code class="s2">"com.markwatson.semanticweb.JenaApis"</code> <code class="se">\</code>
               -Dexec.args<code class="o">=</code><code class="s2">"data/news.n3"</code>

Multi-line queries are OK but don<code class="err">'</code>t use blank lines.
Enter a blank line to process query.
Enter a SPARQL query:
PREFIX kb:  &lt;http://knowledgebooks.com/ontology#&gt;
SELECT ?subject ?object
  WHERE <code class="o">{</code>
      ?subject kb:containsCountry ?object .
  <code class="o">}</code>

<code class="o">[</code>QueryResult vars:<code class="o">[</code>subject, object<code class="o">]</code>
Rows:
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Russia<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/usa_flooding_dc_16/, Japan<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, India<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/, United States<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/usa_politics_dc_2/, Afghanistan<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Saudi Arabia<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, United States<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, France<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/usa_politics_dc_2/, Iraq<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/, Pakistan<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Spain<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Italy<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 Islamic Republic of Iran<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Canada<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Britain<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/usa_politics_dc_2/, United States<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, South Korea<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Germany<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/usa_flooding_dc_16/, United States<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, China<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/bs_nm/global_economy_dc_4/, Japan<code class="o">]</code>

Enter a SPARQL query:
</pre></div>

</figure>

<p>We could have filtered on any other predicate, for instance <strong>containsPlace</strong>. Here is another example using a match against a string literal to find all articles exactly matching the text “Maryland.”</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="k">WHERE</code> <code class="p">{</code> <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Maryland"</code> <code class="p">.</code> <code class="p">}</code>
</pre></div>

</figure>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Enter a SPARQL query:
PREFIX kb:  &lt;http://knowledgebooks.com/ontology#&gt;
SELECT ?subject WHERE <code class="o">{</code> ?subject kb:containsState <code class="s2">"Maryland"</code> . <code class="o">}</code>

<code class="o">[</code>QueryResult vars:<code class="o">[</code>subject<code class="o">]</code>
Rows:
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/<code class="o">]</code>
</pre></div>

</figure>

<p>We can also match partial string literals against regular expressions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code> <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
       <code class="k">WHERE</code> <code class="p">{</code>
         <code class="nv">?subject</code>
         <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code>
         <code class="nv">?object</code> <code class="k">FILTER</code> <code class="nf">regex</code><code class="p">(</code><code class="nv">?object</code><code class="p">,</code> <code class="s">"University"</code><code class="p">)</code> <code class="p">.</code>
       <code class="p">}</code>
</pre></div>

</figure>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Enter a SPARQL query:
PREFIX kb: &lt;http://knowledgebooks.com/ontology#&gt;
SELECT ?subject ?object
       WHERE <code class="o">{</code>
         ?subject
         kb:containsOrganization
         ?object FILTER regex<code class="o">(</code>?object, <code class="s2">"University"</code><code class="o">)</code> .
       <code class="o">}</code>

<code class="o">[</code>QueryResult vars:<code class="o">[</code>subject, object<code class="o">]</code>
Rows:
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/, 
	 University of Maryland<code class="o">]</code>
</pre></div>

</figure>

<p>Prior to this last example query we only requested that the query return values for subject and predicate for triples that matched the query.
However, we might want to return all triples whose subject (in this case a news article URI) is in one of the matched triples. Note that there are two matching triples, each terminated with a period:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code> <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?subject</code> <code class="nv">?a_predicate</code> <code class="nv">?an_object</code>
 <code class="k">WHERE</code> <code class="p">{</code>
    <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="nv">?object</code> <code class="k">FILTER</code> <code class="nf">regex</code><code class="p">(</code><code class="nv">?object</code><code class="p">,</code><code class="s">"University"</code><code class="p">)</code> <code class="p">.</code>
    <code class="nv">?subject</code> <code class="nv">?a_predicate</code> <code class="nv">?an_object</code> <code class="p">.</code>
<code class="p">}</code>
<code class="k">ORDER BY</code> <code class="nv">?a_predicate</code> <code class="nv">?an_object</code>
<code class="k">LIMIT</code> <code class="mi">10</code>
<code class="k">OFFSET</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>When WHERE clauses contain more than one triple pattern to match, this is equivalent to a Boolean “and” operation. The DISTINCT clause removes duplicate results. The ORDER BY clause sorts the output in alphabetical order: in this case first by predicate (containsCity, containsCountry, etc.) and then by object. The LIMIT modifier limits the number of results returned and the OFFSET modifier sets the number of matching results to skip.</p>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Enter a SPARQL query:
PREFIX kb: &lt;http://knowledgebooks.com/ontology#&gt;
SELECT DISTINCT ?subject ?a_predicate ?an_object
 WHERE <code class="o">{</code>
    ?subject kb:containsOrganization ?object FILTER regex<code class="o">(</code>?object,<code class="s2">"University"</code><code class="o">)</code> .
    ?subject ?a_predicate ?an_object .
<code class="o">}</code>
ORDER BY ?a_predicate ?an_object
LIMIT <code class="m">10</code>
OFFSET <code class="m">5</code>

<code class="o">[</code>QueryResult vars:<code class="o">[</code>subject, a_predicate, an_object<code class="o">]</code>
Rows:
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsOrganization,
	  University of Maryland<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Ban Ki-moon<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, George W. Bush<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Gordon Brown<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Hu Jintao<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Mahmoud Ahmadinejad<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Pervez Musharraf<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Steven Kull<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsPerson, Vladimir Putin<code class="o">]</code>
	<code class="o">[</code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_trust_dc_1/,
	 http://knowledgebooks.com/ontology#containsState, Maryland<code class="o">]</code>
</pre></div>

</figure>

<p>We are finished with our quick tutorial on using the SELECT query form. There are three other query forms that I am not covering in this chapter:</p>

<ul>
  <li>
<a href="https://www.w3.org/TR/rdf-sparql-query/#construct">CONSTRUCT</a> – returns a new RDF graph of query results</li>
  <li>
<a href="https://www.w3.org/TR/rdf-sparql-query/#ask">ASK</a> – returns Boolean true or false indicating if a query matches
any triples</li>
  <li>
<a href="https://www.w3.org/TR/rdf-sparql-query/#describe">DESCRIBE</a> – returns a new RDF graph containing matched resources</li>
</ul>

<p>A common matching pattern that I don’t cover in this chapter is <a href="https://www.w3.org/TR/rdf-sparql-query/#optionals">optional</a> but the <strong>optional</strong> matching pattern is used in the examples in the later chapter <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<h3 id="leanpub-auto-using-jena">Using Jena</h3>

<p>Apache Jena is a complete Java library for developing RDF/RDFS/OWL applications and we will use it in this chapter. Other available libraries that we don’t use here include RDF4J (used to be Sesame), OWLAPI, AllegroGraph, Protege library, etc.</p>

<p>The following figure shows a UML diagram for the wrapper classes and interface that I wrote for Jena to make it easier for you to get started. My wrapper uses an in-memory RDF repository that supports inference, loading RDF/RDFS/OWL files, and performing both local and remote SPARQL queries. If you decide to use semantic web technologies in your development you will eventually want to use the full Jena APIs for programmatically creating new RDF triples, finer control of the type of repository (options are in-memory, disk based, and database), <a href="https://www.w3.org/TR/swbp-xsch-datatypes/">type definitions</a> and inferencing, and programmatically using query results. That said, using my wrapper library is a good place for you to start experimenting.</p>

<p>Referring to the following figure, the class constructor <strong>JenaApis</strong> opens a new in-memory RDF triple store and supplies the public APIs we will use later. The data class <strong>QueryResults</strong> has public class variables for variable names used in a query and a list or rows, one row for each query result. The class <strong>Cache</strong> is used internally to cache SPARQL query results for later to improve performance and use without having online access a remote SPARQL endpoint like DBPedia or WikiData.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/jenaapis-uml.png" alt="UML Class Diagram for Apache Jena Wrapper Classes" style="width: 100%">
    <figcaption>UML Class Diagram for Apache Jena Wrapper Classes</figcaption>
  </figure>
</div>


<p>We will look in some detail at the code in this UML Class Diagram. To improve portability to alternative RDF libraries, I wrote two wrapper classes for Jena, one class to represent query results and the other to wrap the Jena APIs that I use.</p>

<p>The following screen shot shows the free IntelliJ Community Edition IDE used to edit one of the unit tests and run it:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/jena-ide-sparql-example.png" alt="Example query in the unit test class" style="width: 100%">
    <figcaption>Example query in the unit test class</figcaption>
  </figure>
</div>


<p>We will now look at the Java implementation of the examples for this chapter.</p>

<h4 id="leanpub-auto-java-wrapper-for-jena-apis-and-an-example">Java Wrapper for Jena APIs and an Example</h4>

<p>For portability to other RDF and semantic web libraries, when we wrap the Jena APIs we want the results to be in standard Java data classes. The following listing shows the class <strong>QueryResult</strong> that contains the variables used in a SPARQL query and a list or rows containing matched value bindings for these variables:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.semanticweb</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">java.io.Serializable</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">QueryResult</code> <code class="kd">implements</code> <code class="n">Serializable</code> <code class="p">{</code>
  <code class="kd">private</code> <code class="nf">QueryResult</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
  <code class="kd">public</code> <code class="nf">QueryResult</code><code class="p">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">variableList</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="na">variableList</code> <code class="o">=</code> <code class="n">variableList</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">variableList</code><code class="p">;</code>
  <code class="kd">public</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;&gt;</code> <code class="n">rows</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
  <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="p">()</code> <code class="p">{</code>
    <code class="n">StringBuilder</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">(</code><code class="s">"[QueryResult vars:"</code> <code class="o">+</code> <code class="n">variableList</code> <code class="o">+</code>
                  <code class="s">"\nRows:\n"</code><code class="p">);</code>
    <code class="k">for</code> <code class="p">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">row</code> <code class="p">:</code> <code class="n">rows</code><code class="p">)</code> <code class="p">{</code>
      <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">"\t"</code> <code class="o">+</code> <code class="n">row</code> <code class="o">+</code> <code class="s">"\n"</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
  <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>I defined a <strong>toString</strong> method so when you print an instance of the class <strong>QueryResult</strong> you see the contained data.</p>

<p>The following listing shows the wrapper class <strong>JenaApis</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="kn">package</code> <code class="nn">com.markwatson.semanticweb</code><code class="p">;</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="kn">import</code> <code class="nn">org.apache.commons.lang3.SerializationUtils</code><code class="p">;</code>
<code class="linenos">  4 </code><code class="kn">import</code> <code class="nn">org.apache.jena.query.*</code><code class="p">;</code>
<code class="linenos">  5 </code><code class="kn">import</code> <code class="nn">org.apache.jena.rdf.model.*</code><code class="p">;</code>
<code class="linenos">  6 </code><code class="kn">import</code> <code class="nn">org.apache.jena.riot.RDFDataMgr</code><code class="p">;</code>
<code class="linenos">  7 </code><code class="kn">import</code> <code class="nn">org.apache.jena.riot.RDFFormat</code><code class="p">;</code>
<code class="linenos">  8 </code>
<code class="linenos">  9 </code><code class="kn">import</code> <code class="nn">java.io.FileNotFoundException</code><code class="p">;</code>
<code class="linenos"> 10 </code><code class="kn">import</code> <code class="nn">java.io.FileOutputStream</code><code class="p">;</code>
<code class="linenos"> 11 </code><code class="kn">import</code> <code class="nn">java.io.IOException</code><code class="p">;</code>
<code class="linenos"> 12 </code><code class="kn">import</code> <code class="nn">java.sql.Blob</code><code class="p">;</code>
<code class="linenos"> 13 </code><code class="kn">import</code> <code class="nn">java.sql.SQLException</code><code class="p">;</code>
<code class="linenos"> 14 </code><code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="linenos"> 15 </code><code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>
<code class="linenos"> 16 </code><code class="kn">import</code> <code class="nn">java.util.Scanner</code><code class="p">;</code>
<code class="linenos"> 17 </code>
<code class="linenos"> 18 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">JenaApis</code> <code class="p">{</code>
<code class="linenos"> 19 </code>
<code class="linenos"> 20 </code>  <code class="kd">public</code> <code class="nf">JenaApis</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 21 </code>    <code class="c1">//model = ModelFactory.createDefaultModel(); // if OWL reasoning not required</code>
<code class="linenos"> 22 </code>    <code class="n">model</code> <code class="o">=</code> <code class="n">ModelFactory</code><code class="p">.</code><code class="na">createOntologyModel</code><code class="p">();</code> <code class="c1">// use OWL reasoner</code>
<code class="linenos"> 23 </code> <code class="p">}</code>
<code class="linenos"> 24 </code>
<code class="linenos"> 25 </code>  <code class="kd">public</code> <code class="n">Model</code> <code class="nf">model</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 26 </code>    <code class="k">return</code> <code class="n">model</code><code class="p">;</code>
<code class="linenos"> 27 </code>  <code class="p">}</code>
<code class="linenos"> 28 </code>
<code class="linenos"> 29 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">loadRdfFile</code><code class="p">(</code><code class="n">String</code> <code class="n">fpath</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 30 </code>    <code class="n">model</code><code class="p">.</code><code class="na">read</code><code class="p">(</code><code class="n">fpath</code><code class="p">);</code>
<code class="linenos"> 31 </code>  <code class="p">}</code>
<code class="linenos"> 32 </code>
<code class="linenos"> 33 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">saveModelToTurtleFormat</code><code class="p">(</code><code class="n">String</code> <code class="n">outputPath</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="p">{</code>
<code class="linenos"> 34 </code>    <code class="n">FileOutputStream</code> <code class="n">fos</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileOutputStream</code><code class="p">(</code><code class="n">outputPath</code><code class="p">);</code>
<code class="linenos"> 35 </code>    <code class="n">RDFDataMgr</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="n">fos</code><code class="p">,</code> <code class="n">model</code><code class="p">,</code> <code class="n">RDFFormat</code><code class="p">.</code><code class="na">TRIG_PRETTY</code><code class="p">);</code>
<code class="linenos"> 36 </code>    <code class="n">fos</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>
<code class="linenos"> 37 </code>  <code class="p">}</code>
<code class="linenos"> 38 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">saveModelToN3Format</code><code class="p">(</code><code class="n">String</code> <code class="n">outputPath</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="p">{</code>
<code class="linenos"> 39 </code>    <code class="n">FileOutputStream</code> <code class="n">fos</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileOutputStream</code><code class="p">(</code><code class="n">outputPath</code><code class="p">);</code>
<code class="linenos"> 40 </code>    <code class="n">RDFDataMgr</code><code class="p">.</code><code class="na">write</code><code class="p">(</code><code class="n">fos</code><code class="p">,</code> <code class="n">model</code><code class="p">,</code> <code class="n">RDFFormat</code><code class="p">.</code><code class="na">NTRIPLES</code><code class="p">);</code>
<code class="linenos"> 41 </code>    <code class="n">fos</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>
<code class="linenos"> 42 </code>  <code class="p">}</code>
<code class="linenos"> 43 </code>
<code class="linenos"> 44 </code>  <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">query</code><code class="p">(</code><code class="n">String</code> <code class="n">sparqlQuery</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 45 </code>    <code class="n">Query</code> <code class="n">query</code> <code class="o">=</code> <code class="n">QueryFactory</code><code class="p">.</code><code class="na">create</code><code class="p">(</code><code class="n">sparqlQuery</code><code class="p">);</code>
<code class="linenos"> 46 </code>    <code class="n">QueryExecution</code> <code class="n">qexec</code> <code class="o">=</code> <code class="n">QueryExecutionFactory</code><code class="p">.</code><code class="na">create</code><code class="p">(</code><code class="n">query</code><code class="p">,</code> <code class="n">model</code><code class="p">);</code>
<code class="linenos"> 47 </code>    <code class="n">ResultSet</code> <code class="n">results</code> <code class="o">=</code> <code class="n">qexec</code><code class="p">.</code><code class="na">execSelect</code><code class="p">();</code>
<code class="linenos"> 48 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="k">new</code> <code class="n">QueryResult</code><code class="p">(</code><code class="n">results</code><code class="p">.</code><code class="na">getResultVars</code><code class="p">());</code>
<code class="linenos"> 49 </code>    <code class="k">for</code> <code class="p">(;</code> <code class="n">results</code><code class="p">.</code><code class="na">hasNext</code><code class="p">();</code> <code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 50 </code>      <code class="n">QuerySolution</code> <code class="n">solution</code> <code class="o">=</code> <code class="n">results</code><code class="p">.</code><code class="na">nextSolution</code><code class="p">();</code>
<code class="linenos"> 51 </code>      <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">newResultRow</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
<code class="linenos"> 52 </code>      <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="kd">var</code> <code class="err">: </code><code class="n">qr</code><code class="p">.</code><code class="na">variableList</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 53 </code>        <code class="n">newResultRow</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">solution</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">var</code><code class="p">).</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos"> 54 </code>      <code class="p">}</code>
<code class="linenos"> 55 </code>      <code class="n">qr</code><code class="p">.</code><code class="na">rows</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">newResultRow</code><code class="p">);</code>
<code class="linenos"> 56 </code>    <code class="p">}</code>
<code class="linenos"> 57 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">;</code>
<code class="linenos"> 58 </code>  <code class="p">}</code>
<code class="linenos"> 59 </code>
<code class="linenos"> 60 </code>  <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">queryRemote</code><code class="p">(</code><code class="n">String</code> <code class="n">service</code><code class="p">,</code> <code class="n">String</code> <code class="n">sparqlQuery</code><code class="p">)</code>
<code class="linenos"> 61 </code>         <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 62 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">cache</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="n">cache</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Cache</code><code class="p">();</code>
<code class="linenos"> 63 </code>    <code class="kt">byte</code> <code class="o">[]</code> <code class="n">b</code> <code class="o">=</code> <code class="n">cache</code><code class="p">.</code><code class="na">fetchResultFromCache</code><code class="p">(</code><code class="n">sparqlQuery</code><code class="p">);</code>
<code class="linenos"> 64 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">b</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 65 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Found query in cache."</code><code class="p">);</code>
<code class="linenos"> 66 </code>      <code class="n">QueryResult</code> <code class="n">l</code> <code class="o">=</code> <code class="n">SerializationUtils</code><code class="p">.</code><code class="na">deserialize</code><code class="p">(</code><code class="n">b</code><code class="p">);</code>
<code class="linenos"> 67 </code>      <code class="k">return</code> <code class="n">l</code><code class="p">;</code>
<code class="linenos"> 68 </code>    <code class="p">}</code>
<code class="linenos"> 69 </code>    <code class="n">Query</code> <code class="n">query</code> <code class="o">=</code> <code class="n">QueryFactory</code><code class="p">.</code><code class="na">create</code><code class="p">(</code><code class="n">sparqlQuery</code><code class="p">);</code>
<code class="linenos"> 70 </code>    <code class="n">QueryExecution</code> <code class="n">qexec</code> <code class="o">=</code> <code class="n">QueryExecutionFactory</code><code class="p">.</code><code class="na">sparqlService</code><code class="p">(</code><code class="n">service</code><code class="p">,</code> <code class="n">sparqlQuery</code><code class="p">);</code>
<code class="linenos"> 71 </code>    <code class="n">ResultSet</code> <code class="n">results</code> <code class="o">=</code> <code class="n">qexec</code><code class="p">.</code><code class="na">execSelect</code><code class="p">();</code>
<code class="linenos"> 72 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="k">new</code> <code class="n">QueryResult</code><code class="p">(</code><code class="n">results</code><code class="p">.</code><code class="na">getResultVars</code><code class="p">());</code>
<code class="linenos"> 73 </code>    <code class="k">for</code> <code class="p">(;</code> <code class="n">results</code><code class="p">.</code><code class="na">hasNext</code><code class="p">();</code> <code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 74 </code>      <code class="n">QuerySolution</code> <code class="n">solution</code> <code class="o">=</code> <code class="n">results</code><code class="p">.</code><code class="na">nextSolution</code><code class="p">();</code>
<code class="linenos"> 75 </code>      <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">newResultRow</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
<code class="linenos"> 76 </code>      <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="kd">var</code> <code class="err">: </code><code class="n">qr</code><code class="p">.</code><code class="na">variableList</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 77 </code>        <code class="n">newResultRow</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">solution</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">var</code><code class="p">).</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos"> 78 </code>      <code class="p">}</code>
<code class="linenos"> 79 </code>      <code class="n">qr</code><code class="p">.</code><code class="na">rows</code><code class="p">.</code><code class="na">add</code><code class="p">(</code><code class="n">newResultRow</code><code class="p">);</code>
<code class="linenos"> 80 </code>    <code class="p">}</code>
<code class="linenos"> 81 </code>    <code class="kt">byte</code> <code class="o">[]</code> <code class="n">b3</code> <code class="o">=</code> <code class="n">SerializationUtils</code><code class="p">.</code><code class="na">serialize</code><code class="p">(</code><code class="n">qr</code><code class="p">);</code>
<code class="linenos"> 82 </code>    <code class="n">cache</code><code class="p">.</code><code class="na">saveQueryResultInCache</code><code class="p">(</code><code class="n">sparqlQuery</code><code class="p">,</code> <code class="n">b3</code><code class="p">);</code>
<code class="linenos"> 83 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">;</code>
<code class="linenos"> 84 </code>  <code class="p">}</code>
<code class="linenos"> 85 </code>
<code class="linenos"> 86 </code>  <code class="kd">private</code> <code class="n">Cache</code> <code class="n">cache</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
<code class="linenos"> 87 </code>  <code class="kd">private</code> <code class="n">Model</code> <code class="n">model</code><code class="p">;</code>
<code class="linenos"> 88 </code>
<code class="linenos"> 89 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 90 </code>    <code class="cm">/*</code>
<code class="linenos"> 91 </code><code class="cm">    Execute using, for example:</code>
<code class="linenos"> 92 </code><code class="cm">         mvn exec:java -Dexec.mainClass="com.markwatson.semanticweb.JenaApis" \</code>
<code class="linenos"> 93 </code><code class="cm">              -Dexec.args="data/news.n3"</code>
<code class="linenos"> 94 </code><code class="cm">     */</code>
<code class="linenos"> 95 </code>    <code class="n">JenaApis</code> <code class="n">ja</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JenaApis</code><code class="p">();</code>
<code class="linenos"> 96 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">args</code><code class="p">.</code><code class="na">length</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 97 </code>      <code class="c1">// no RDF input file names on command line so use a default file:</code>
<code class="linenos"> 98 </code>      <code class="n">ja</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="s">"data/news.n3"</code><code class="p">);</code>
<code class="linenos"> 99 </code>    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">100 </code>      <code class="k">for</code> <code class="p">(</code><code class="n">String</code> <code class="n">fpath</code> <code class="p">:</code> <code class="n">args</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">101 </code>        <code class="n">ja</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="n">fpath</code><code class="p">);</code>
<code class="linenos">102 </code>      <code class="p">}</code>
<code class="linenos">103 </code>    <code class="p">}</code>
<code class="linenos">104 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Multi-line queries are OK but don't use blank lines."</code><code class="p">);</code>
<code class="linenos">105 </code>    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Enter a blank line to process query."</code><code class="p">);</code>
<code class="linenos">106 </code>    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">107 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Enter a SPARQL query:"</code><code class="p">);</code>
<code class="linenos">108 </code>      <code class="n">Scanner</code> <code class="n">sc</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Scanner</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="na">in</code><code class="p">);</code>
<code class="linenos">109 </code>      <code class="n">StringBuilder</code> <code class="n">sb</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>
<code class="linenos">110 </code>      <code class="k">while</code> <code class="p">(</code><code class="n">sc</code><code class="p">.</code><code class="na">hasNextLine</code><code class="p">())</code> <code class="p">{</code>  <code class="c1">// process all inputs</code>
<code class="linenos">111 </code>        <code class="n">String</code> <code class="n">s</code> <code class="o">=</code> <code class="n">sc</code><code class="p">.</code><code class="na">nextLine</code><code class="p">();</code>
<code class="linenos">112 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"quit"</code><code class="p">)</code> <code class="o">||</code> <code class="n">s</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"QUIT"</code><code class="p">)</code> <code class="o">||</code> 
<code class="linenos">113 </code>            <code class="n">s</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"exit"</code><code class="p">)</code> <code class="o">||</code> <code class="n">s</code><code class="p">.</code><code class="na">equals</code><code class="p">(</code><code class="s">"EXIT"</code><code class="p">))</code>
<code class="linenos">114 </code>          <code class="n">System</code><code class="p">.</code><code class="na">exit</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>
<code class="linenos">115 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">length</code><code class="p">()</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="k">break</code><code class="p">;</code>
<code class="linenos">116 </code>        <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="linenos">117 </code>        <code class="n">sb</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
<code class="linenos">118 </code>      <code class="p">}</code>
<code class="linenos">119 </code>      <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">ja</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">sb</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos">120 </code>      <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">qr</code><code class="p">);</code>
<code class="linenos">121 </code>    <code class="p">}</code>
<code class="linenos">122 </code>  <code class="p">}</code>
<code class="linenos">123 </code><code class="p">}</code>
</pre></div>

</figure>

<p>This code is largely self-explanatory. Line 21 or 22 should be commented out, depending on whether you want to enable OWL reasoning. In method <strong>queryRemote</strong> on line 62 we check to see if an instance of <strong>Cache</strong> has been created and if not, create one. The argument <strong>service</strong> for the method <strong>queryRemote</strong> is a SPARQL endpoint (e.g., “https://dbpedia.org/sparql”). The class <strong>QueryResult</strong> implemented <strong>Serializable</strong> so it can be converted and stored in the Derby cache database.</p>

<p>The method <strong>main</strong> implements a command line interface for accepting multiple lines of input. When the user enters a blank line then the previously entered non-blank lines are passed as a SPARQL local query. When run from the command line, you can enter one or more RDF input files to load prior to the SPARQL query loop.</p>

<p>The following class shows the unit test class <strong>JenaApisTest</strong> that provides examples for:</p>

<ul>
  <li>Create an instance of <strong>JenaApis</strong>.</li>
  <li>Run a SPARQL query against the remote public DBPedia service endpoint.</li>
  <li>Repeat the remote SPARQL query to show query caching using the Apache Derby relational database.</li>
  <li>Load three input data files in N-Triple and N3 format.</li>
  <li>Run a SPARQL query against the RDF data that we just loaded.</li>
  <li>Save the current model as RDF text files in both N-Triple and N3 format.</li>
  <li>Making SPARQL queries that require OWL reasoning.</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="kn">package</code> <code class="nn">com.markwatson.semanticweb</code><code class="p">;</code>

<code class="kn">import</code> <code class="nn">junit.framework.Test</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">junit.framework.TestCase</code><code class="p">;</code>
<code class="kn">import</code> <code class="nn">junit.framework.TestSuite</code><code class="p">;</code>

<code class="kd">public</code> <code class="kd">class</code> <code class="nc">JenaApisTest</code> <code class="kd">extends</code> <code class="n">TestCase</code> <code class="p">{</code>
  <code class="cm">/**</code>
<code class="cm">   * Create the test case</code>
<code class="cm">   *</code>
<code class="cm">   * @param testName name of the test case</code>
<code class="cm">   */</code>
  <code class="kd">public</code> <code class="nf">JenaApisTest</code><code class="p">(</code><code class="n">String</code> <code class="n">testName</code><code class="p">)</code>
  <code class="p">{</code>
    <code class="kd">super</code><code class="p">(</code> <code class="n">testName</code> <code class="p">);</code>
  <code class="p">}</code>

  <code class="cm">/**</code>
<code class="cm">   * @return the suite of tests being tested</code>
<code class="cm">   */</code>
  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Test</code> <code class="nf">suite</code><code class="p">()</code>
  <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">TestSuite</code><code class="p">(</code> <code class="n">JenaApisTest</code><code class="p">.</code><code class="na">class</code> <code class="p">);</code>
  <code class="p">}</code>

  <code class="cm">/**</code>
<code class="cm">   * Test that is just for side effect printouts:</code>
<code class="cm">   */</code>
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">test1</code><code class="p">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="n">JenaApis</code> <code class="n">jenaApis</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JenaApis</code><code class="p">();</code>
    <code class="c1">// test remote SPARQL queries against DBPedia SPARQL endpoint</code>
    <code class="n">QueryResult</code> <code class="n">qrRemote</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">queryRemote</code><code class="p">(</code>
        <code class="s">"https://dbpedia.org/sparql"</code><code class="p">,</code>
        <code class="s">"select distinct ?s { ?s ?p &lt;http://dbpedia.org/resource/Parks&gt; } LIMIT 10"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qrRemote:"</code> <code class="o">+</code> <code class="n">qrRemote</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"Repeat query to test caching:"</code><code class="p">);</code>
    <code class="n">qrRemote</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">queryRemote</code><code class="p">(</code>
        <code class="s">"https://dbpedia.org/sparql"</code><code class="p">,</code>
        <code class="s">"select distinct ?s { ?s ?p &lt;http://dbpedia.org/resource/Parks&gt; } LIMIT 10"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qrRemote (hopefully from cache):"</code> <code class="o">+</code> <code class="n">qrRemote</code><code class="p">);</code>

    <code class="n">jenaApis</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="s">"data/rdfs_business.nt"</code><code class="p">);</code>
    <code class="n">jenaApis</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="s">"data/sample_news.nt"</code><code class="p">);</code>
    <code class="n">jenaApis</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="s">"data/sample_news.n3"</code><code class="p">);</code>

    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>
        <code class="s">"select ?s ?o where { ?s &lt;http://knowledgebooks.com/title&gt; ?o } limit 15"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>

    <code class="n">jenaApis</code><code class="p">.</code><code class="na">saveModelToTurtleFormat</code><code class="p">(</code><code class="s">"model_save.nt"</code><code class="p">);</code>
    <code class="n">jenaApis</code><code class="p">.</code><code class="na">saveModelToN3Format</code><code class="p">(</code><code class="s">"model_save.n3"</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="cm">/**</code>
<code class="cm">   * Test that is just for side effect printouts:</code>
<code class="cm">   */</code>
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">testOwlReasoning</code><code class="p">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
    <code class="n">JenaApis</code> <code class="n">jenaApis</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JenaApis</code><code class="p">();</code>
    <code class="n">jenaApis</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="s">"data/news.n3"</code><code class="p">);</code>

    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>
        <code class="s">"prefix kb:  &lt;http://knowledgebooks.com/ontology#&gt; \n"</code> <code class="o">+</code>
        <code class="s">"select ?s ?o where { ?s kb:containsCity ?o } "</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>

    <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>
        <code class="s">"prefix kb:  &lt;http://knowledgebooks.com/ontology#&gt; \n"</code> <code class="o">+</code>
            <code class="s">"select ?s ?o where { ?s kb:containsPlace ?o }"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>

    <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>   <code class="c1">// count for each place name</code>
        <code class="s">"prefix kb:  &lt;http://knowledgebooks.com/ontology#&gt; \n"</code> <code class="o">+</code>
            <code class="s">"select ?o (count(*) as ?count) where { ?s kb:containsPlace ?o } "</code> <code class="o">+</code>
            <code class="s">"group by ?o"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>To reuse the example code in this section, I recommend that you clone the entire directory <strong>semantic_web_apache_jena</strong> because it is set up for using Maven and and default logging. If you want to use the code in an existing Java project then copy the dependencies from the file <strong>pom.xml</strong> to your project. If you run <strong>mvn install</strong> then you will have a local copy installed on your system and can just install the dependency with Maven group ID <strong>com.markwatson</strong> and artifact <strong>semanticweb</strong>.</p>

<h3 id="owl">OWL: The Web Ontology Language</h3>

<p>We have already seen a few examples of using RDFS to define sub-properties in this chapter. The Web Ontology Language (OWL) extends the expressive power of RDFS. We now look at a few OWL examples and then look at parts of the Java unit test showing three SPARQL queries that use OWL reasoning. The following RDF data stores support at least some level of OWL reasoning:</p>

<ul>
  <li>ProtegeOwlApis - compatible with the Protege Ontology editor</li>
  <li>Pellet - DL reasoner</li>
  <li>Owlim - OWL DL reasoner compatible with some versions of Sesame</li>
  <li>Jena - General purpose library</li>
  <li>OWLAPI - a simpler API using many other libraries</li>
  <li>Stardog - a commercial OWL and RDF reasoning system and datastore</li>
  <li>Allegrograph - a commercial RDF+ and RDF reasoning system and datastore</li>
</ul>

<p>OWL is more expressive than RDFS in that it supports cardinality, richer class relationships, and Descriptive Logic (DL) reasoning. OWL treats the idea of classes very differently than object oriented programming languages like Java and Smalltalk, but similar to the way PowerLoom (see chapter on <em>Reasoning</em>) uses concepts (PowerLoom’s rough equivalent to a class). In OWL, instances of a class are referred to as individuals and class membership is determined by a set of properties that allow a DL reasoner to infer class membership of an individual (this is called entailment.)</p>

<p>We saw an example of expressing transitive relationships when we were using PowerLoom in the chapter on <em>Reasoning</em> where we defined a PowerLoom rule to express that the relation “contains” is transitive. We will now look at a similar example using OWL.</p>

<p>We have been using the RDF file news.n3 in previous examples and we will layer new examples by adding new triples that represent RDF, RDFS, and OWL. We saw in news.n3 the definition of three triples using <strong>rdfs:subPropertyOf</strong> properties to create a more general kb:containsPlace property:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">owl</code><code class="p">:</code><code class="nt">transitiveProperty</code> <code class="p">.</code>

<code class="nn">kbplace</code><code class="p">:</code><code class="nt">UnitedStates</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">kbplace</code><code class="p">:</code><code class="nt">Illinois</code> <code class="p">.</code>
<code class="nn">kbplace</code><code class="p">:</code><code class="nt">Illinois</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">kbplace</code><code class="p">:</code><code class="nt">Chicago</code> <code class="p">.</code>
</pre></div>

</figure>

<p>We can also infer that:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">kbplace</code><code class="p">:</code><code class="nt">UnitedStates</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="nn">kbplace</code><code class="p">:</code><code class="nt">Chicago</code> <code class="p">.</code>
</pre></div>

</figure>

<p>We can also model inverse properties in OWL. For example, here we add an inverse property kb:containedIn, adding it to the example in the last listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">kb</code><code class="p">:</code><code class="nt">containedIn</code> <code class="nn">owl</code><code class="p">:</code><code class="nt">inverseOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Given an RDF container that supported extended OWL DL SPARQL queries, we can now execute SPARQL queries matching the property kb:containedIn and “match” triples in the RDF triple store that have never been asserted but are inferred by the OWL reasoner.</p>

<p>OWL DL is a very large subset of full OWL. From reading the chapter on Reasoning and the very light coverage of OWL in this section, you should understand the concept of class membership not by explicitly stating that an object (or individual) is a member of a class, but rather because an individual has properties that can be used to infer class membership.</p>

<p>The World Wide Web Consortium has defined three versions of the OWL language that are in increasing order of complexity: OWL Lite, OWL DL, and OWL Full. OWL DL (supports Description Logic) is the most widely used (and recommended) version of OWL. OWL Full is not computationally decidable since it supports full logic, multiple class inheritance, and other things that probably make it computationally intractable for all but smaller problems.</p>

<p>We will now look at some Java code from the method <strong>testOwlReasoning</strong> in the unit test class <strong>JenaApisTest</strong>.</p>

<p>The following is not affected by using an OWL reasoner because the property <strong>kb:containsCity</strong> occurs directly in the input RDF data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">JenaApis</code> <code class="n">jenaApis</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JenaApis</code><code class="p">();</code>
    <code class="n">jenaApis</code><code class="p">.</code><code class="na">loadRdfFile</code><code class="p">(</code><code class="s">"data/news.n3"</code><code class="p">);</code>

    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>
        <code class="s">"prefix kb:  &lt;http://knowledgebooks.com/ontology#&gt; \n"</code> <code class="o">+</code>
        <code class="s">"select ?s ?o where { ?s kb:containsCity ?o } "</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>
</pre></div>

</figure>

<p>The following has been edited to keep just a few output lines per result set:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">qr</code><code class="p">:[</code><code class="err">QueryResult</code> <code class="nn">vars</code><code class="p">:[</code><code class="err">s</code><code class="p">,</code> <code class="err">o</code><code class="p">]</code>
<code class="nn">Rows</code><code class="p">:</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">St</code><code class="p">.</code> <code class="err">Paul</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_politics_dc_</code><code class="mi">2</code><code class="o">/</code><code class="p">,</code> <code class="err">FLINT</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">CHICAGO</code><code class="p">]</code>
	
	  <code class="p">...</code> <code class="err">output</code> <code class="err">removed</code><code class="p">.</code> <code class="nn">note</code><code class="p">:</code> <code class="err">there</code> <code class="err">were</code> <code class="mi">15</code> <code class="err">results</code> <code class="err">for</code> <code class="err">query</code>
	  
  	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">Quincy</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">Iow</code><code class="k">a</code> <code class="err">City</code><code class="p">]</code>
</pre></div>

</figure>

<p>Here we use a query that is affected by using an OWL reasoner (i.e., if OWL is not enabled there will be no query results):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>
        <code class="s">"prefix kb:  &lt;http://knowledgebooks.com/ontology#&gt; \n"</code> <code class="o">+</code>
            <code class="s">"select ?s ?o where { ?s kb:containsPlace ?o }"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>
</pre></div>

</figure>

<p>The code in the GitHub repo for this book is configured to use OWL by default. If you edited lines 21-22 in the file <strong>JenaApis.jav</strong> to disable OWL reasoning then revert your changes and rebuild the project.</p>

<p>The following has been edited to just keep a few output lines per result set:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">qr</code><code class="p">:[</code><code class="err">QueryResult</code> <code class="nn">vars</code><code class="p">:[</code><code class="err">s</code><code class="p">,</code> <code class="err">o</code><code class="p">]</code>
<code class="nn">Rows</code><code class="p">:</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">St</code><code class="p">.</code> <code class="err">Paul</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_politics_dc_</code><code class="mi">2</code><code class="o">/</code><code class="p">,</code> <code class="err">FLINT</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">CHICAGO</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">bs_nm</code><code class="o">/</code><code class="err">global_economy_dc_</code><code class="mi">4</code><code class="o">/</code><code class="p">,</code> <code class="err">Kual</code><code class="k">a</code> <code class="err">Lumpur</code><code class="p">]</code>
	
	  <code class="p">...</code> <code class="err">output</code> <code class="err">removed</code><code class="p">.</code> <code class="nn">note</code><code class="p">:</code> <code class="err">there</code> <code class="err">were</code> <code class="mi">46</code> <code class="err">results</code> <code class="err">for</code> <code class="err">query</code>
	  
	<code class="err">global_economy_dc_</code><code class="mi">4</code><code class="o">/</code><code class="p">,</code> <code class="err">United</code> <code class="err">States</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">bs_nmglobal_economy_dc_</code><code class="mi">4</code><code class="o">/</code><code class="p">,</code> <code class="err">Germany</code><code class="p">]</code>
	<code class="p">[</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">news</code><code class="p">.</code><code class="err">yahoo</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">s</code><code class="o">/</code><code class="err">nm</code><code class="o">/</code><code class="mi">20080616</code><code class="o">/</code><code class="err">ts_nm</code><code class="o">/</code><code class="err">usa_flooding_dc_</code><code class="mi">16</code><code class="o">/</code><code class="p">,</code> <code class="err">United</code> <code class="err">States</code><code class="p">]</code>
</pre></div>

</figure>

<p>We now group (aggregate) query results and count the number of times each place name has occurred in the result (this query requires an OWL reasoner):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>    <code class="n">qr</code> <code class="o">=</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">query</code><code class="p">(</code>   <code class="c1">// count for each place name</code>
        <code class="s">"prefix kb:  &lt;http://knowledgebooks.com/ontology#&gt; \n"</code> <code class="o">+</code>
            <code class="s">"select ?o (count(*) as ?count) where { ?s kb:containsPlace ?o } "</code> <code class="o">+</code>
            <code class="s">"group by ?o"</code><code class="p">);</code>
    <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"qr:"</code> <code class="o">+</code> <code class="n">qr</code><code class="p">);</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">qr</code><code class="p">:[</code><code class="err">QueryResult</code> <code class="nn">vars</code><code class="p">:[</code><code class="err">o</code><code class="p">,</code> <code class="nf">count</code><code class="p">]</code>
<code class="nn">Rows</code><code class="p">:</code>
	<code class="p">[</code><code class="err">Chicago</code><code class="p">,</code> <code class="mi">1</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
	<code class="p">[</code><code class="err">Illinois</code><code class="p">,</code> <code class="mi">2</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
	<code class="p">[</code><code class="err">Arizon</code><code class="k">a</code><code class="p">,</code> <code class="mi">1</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
	
	  <code class="p">...</code> <code class="err">output</code> <code class="err">removed</code><code class="p">.</code> <code class="nn">note</code><code class="p">:</code> <code class="err">there</code> <code class="err">were</code> <code class="mi">40</code> <code class="err">results</code> <code class="err">for</code> <code class="err">query</code>
	
	<code class="p">[</code><code class="err">United</code> <code class="err">States</code><code class="p">,</code> <code class="mi">4</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
	<code class="p">[</code><code class="err">Iow</code><code class="k">a</code><code class="p">,</code> <code class="mi">1</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
	<code class="p">[</code><code class="err">Japan</code><code class="p">,</code> <code class="mi">2</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
	<code class="p">[</code><code class="err">Spa</code><code class="k">in</code><code class="p">,</code> <code class="mi">1</code><code class="p">^^</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">2001</code><code class="o">/</code><code class="err">XMLSchem</code><code class="k">a</code><code class="c">#integer]</code>
</pre></div>

</figure>

<p>Note the type <strong>http://www.w3.org/2001/XMLSchema#integer</strong> using the <strong><sup></sup></strong> notation
for integer values bound to the variable <strong>count</strong>.</p>

<h3 id="leanpub-auto-semantic-web-wrap-up">Semantic Web Wrap-up</h3>

<p>Writing semantic web applications in Java is a very large topic, worthy of an entire book. I have covered in this chapter what for my work has been the most useful semantic web techniques: storing and querying RDF and RDFS for a specific application and using OWL when required. We will see in the next two chapters the use of RDF when automatically creating Knowledge Graphs from text data and for automatic navigation of Knowledge Graphs.</p>


<h2 id="kgcreator">Automatically Generating Data for Knowledge Graphs</h2>

<p>Here we develop a complete application using the package developed in the earlier chapter <a href="#ner">Resolve Entity Names to DBPedia References</a>. The Knowledge Graph Creator (KGcreator) is a tool for automating the generation of data for Knowledge Graphs from raw text data. Here we generate RDF data for a Knowledge Graph. You might also be interested in the Knowledge Graph Creator implementation in <a href="https://leanpub.com/lovinglisp">my Common Lisp book</a> that generates data for the Neo4J open source graph database in addition to generating RDF data.</p>

<p>Data created by KGcreator generates data in RDF triples suitable for loading into any linked data/semantic web data store.</p>

<p>This example application works by identifying entities in text. Example entity types are people, companies, country names, city names, broadcast network names, political party names, and university names. We saw earlier code for detecting entities in the chapter on making named entities to DBPedia URIs and we will reuse this code.</p>

<p>I originally wrote KGCreator as two research prototypes, one in Common Lisp (see my <a href="https://leanpub.com/lovinglisp">Common Lisp book</a>) and one in <a href="https://leanpub.com/haskell-cookbook/">Haskell</a>. The example in this chapter is a port of these systems to Java.</p>

<h3 id="leanpub-auto-implementation-notes">Implementation Notes</h3>

<p>The implementation is contained in a single Java class <strong>KGC</strong> and the <strong>junit</strong> test class <strong>KgcTest</strong> is used to process the test files included with this example.</p>

<p>As can be seen in the following figure I have defined final static strings for each type of entity type URI. For example, <strong>personTypeUri</strong> has the value <strong><a href="http://www.w3.org/2000/01/rdf-schema#person">http://www.w3.org/2000/01/rdf-schema#person</a></strong>.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 331px">
    <img src="images/kgc-uml.png" alt="Overview of Java Class UML Diagram for the Knowledge Graph Creator" style="width: 100%">
    <figcaption>Overview of Java Class UML Diagram for the Knowledge Graph Creator</figcaption>
  </figure>
</div>


<p>The following figure shows a screen shot of this example project in the free Community Edition of IntelliJ.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/kgc-ide.png" alt="IDE View of Project" style="width: 100%">
    <figcaption>IDE View of Project</figcaption>
  </figure>
</div>


<p>Notice in this screen shot that there are several test files in the directory <strong>test_data</strong>. The files with the file extension <strong>.meta</strong> contain a single line which is the URI for the source of the text in the matching text file. For example, the meta file <strong>test1.meta</strong> provides the URI for the source of the text in the file <strong>test1.txt</strong>.</p>

<h3 id="leanpub-auto-generating-rdf-data">Generating RDF Data</h3>

<p>RDF data is comprised of triples, where the value for each triple are a subject, a predicate, and an object. Subjects are URIs, predicates are usually URIs, and objects are either literal values or URIs. Here are two triples written by this example application:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>&lt;http://dbpedia.org/resource/The_Wall_Street_Journal&gt; 
  &lt;http://knowledgebooks.com/schema/aboutCompanyName&gt; 
  "Wall Street Journal" .
&lt;https://newsshop.com/june/z902.html&gt;
  &lt;http://knowledgebooks.com/schema/containsCountryDbPediaLink&gt;
  &lt;http://dbpedia.org/resource/Canada&gt; .
</pre></div>

</figure>

<p>The following listing of the file <strong>KGC.java</strong> contains the implementation the main Java class for generating RDF data. Code for different entity types is similar so the following listing only shows the code for handling entity types for people and companies. The following is reformatted to fit the page width:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphcreator</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">com.markwatson.ner_dbpedia.TextToDbpediaUris</code><code class="p">;</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">java.io.*</code><code class="p">;</code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">java.nio.charset.StandardCharsets</code><code class="p">;</code>
<code class="linenos"> 7 </code><code class="kn">import</code> <code class="nn">java.nio.file.Files</code><code class="p">;</code>
<code class="linenos"> 8 </code><code class="kn">import</code> <code class="nn">java.nio.file.Paths</code><code class="p">;</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="cm">/**</code>
<code class="linenos">11 </code><code class="cm"> * Java implementation of Knowledge Graph Creator.</code>
<code class="linenos">12 </code><code class="cm"> *</code>
<code class="linenos">13 </code><code class="cm"> * Copyright 2020 Mark Watson. All Rights Reserved. Apache 2 license.</code>
<code class="linenos">14 </code><code class="cm"> *</code>
<code class="linenos">15 </code><code class="cm"> * For documentation see my book "Practical Artificial Intelligence Programming</code>
<code class="linenos">16 </code><code class="cm"> * With Java", chapter "Automatically Generating Data for Knowledge Graphs"</code>
<code class="linenos">17 </code><code class="cm"> * at https://leanpub.com/javaai that can be read free online.</code>
<code class="linenos">18 </code><code class="cm"> *</code>
<code class="linenos">19 </code><code class="cm"> */</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">KGC</code>  <code class="p">{</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>	<code class="kd">static</code> <code class="n">String</code> <code class="n">subjectUri</code> <code class="o">=</code> 
<code class="linenos">24 </code>	  <code class="s">"&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#/subject&gt;"</code><code class="p">;</code>
<code class="linenos">25 </code>	<code class="kd">static</code> <code class="n">String</code> <code class="n">labelUri</code> <code class="o">=</code> 
<code class="linenos">26 </code>	  <code class="s">"&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#/label&gt;"</code><code class="p">;</code>
<code class="linenos">27 </code>	<code class="kd">static</code> <code class="n">String</code> <code class="n">personTypeUri</code> <code class="o">=</code> 
<code class="linenos">28 </code>	  <code class="s">"&lt;http://www.w3.org/2000/01/rdf-schema#person&gt;"</code><code class="p">;</code>
<code class="linenos">29 </code>	<code class="kd">static</code> <code class="n">String</code> <code class="n">companyTypeUri</code> <code class="o">=</code> 
<code class="linenos">30 </code>	  <code class="s">"&lt;http://www.w3.org/2000/01/rdf-schema#company&gt;"</code><code class="p">;</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code>	<code class="kd">static</code> <code class="n">String</code> <code class="n">typeOfUri</code> <code class="o">=</code> 
<code class="linenos">33 </code>	  <code class="s">"&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt;"</code><code class="p">;</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code>	<code class="kd">private</code> <code class="nf">KGC</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
<code class="linenos">36 </code>	
<code class="linenos">37 </code>	<code class="kd">public</code> <code class="nf">KGC</code><code class="p">(</code><code class="n">String</code> <code class="n">directoryPath</code><code class="p">,</code> <code class="n">String</code> <code class="n">outputRdfPath</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="p">{</code>
<code class="linenos">38 </code>		<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"KGN"</code><code class="p">);</code>
<code class="linenos">39 </code>		<code class="n">PrintStream</code> <code class="n">out</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PrintStream</code><code class="p">(</code><code class="n">outputRdfPath</code><code class="p">);</code>
<code class="linenos">40 </code>		<code class="n">File</code> <code class="n">dir</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="p">(</code><code class="n">directoryPath</code><code class="p">);</code>
<code class="linenos">41 </code>		<code class="n">File</code><code class="o">[]</code> <code class="n">directoryListing</code> <code class="o">=</code> <code class="n">dir</code><code class="p">.</code><code class="na">listFiles</code><code class="p">();</code>
<code class="linenos">42 </code>		<code class="k">if</code> <code class="p">(</code><code class="n">directoryListing</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">43 </code>			<code class="k">for</code> <code class="p">(</code><code class="n">File</code> <code class="n">child</code> <code class="p">:</code> <code class="n">directoryListing</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">44 </code>				<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"child:"</code> <code class="o">+</code> <code class="n">child</code><code class="p">);</code>
<code class="linenos">45 </code>				<code class="k">if</code> <code class="p">(</code><code class="n">child</code><code class="p">.</code><code class="na">toString</code><code class="p">().</code><code class="na">endsWith</code><code class="p">(</code><code class="s">".txt"</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos">46 </code>					<code class="c1">// try to open the meta file with the same extension:</code>
<code class="linenos">47 </code>					<code class="n">String</code> <code class="n">metaAbsolutePath</code> <code class="o">=</code> <code class="n">child</code><code class="p">.</code><code class="na">getAbsolutePath</code><code class="p">();</code>
<code class="linenos">48 </code>					<code class="n">File</code> <code class="n">meta</code> <code class="o">=</code> 
<code class="linenos">49 </code>					  <code class="k">new</code> <code class="n">File</code><code class="p">(</code><code class="n">metaAbsolutePath</code><code class="p">.</code><code class="na">substring</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code>
<code class="linenos">50 </code>					                                  <code class="n">metaAbsolutePath</code><code class="p">.</code><code class="na">length</code><code class="p">()</code> <code class="o">-</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos">51 </code>					                                   <code class="o">+</code> <code class="s">".meta"</code><code class="p">);</code>
<code class="linenos">52 </code>					<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"meta:"</code> <code class="o">+</code> <code class="n">meta</code><code class="p">);</code>
<code class="linenos">53 </code>					<code class="n">String</code> <code class="o">[]</code> <code class="n">text_and_meta</code> <code class="o">=</code> 
<code class="linenos">54 </code>					  <code class="n">readData</code><code class="p">(</code><code class="n">child</code><code class="p">.</code><code class="na">getAbsolutePath</code><code class="p">(),</code> <code class="n">meta</code><code class="p">.</code><code class="na">getAbsolutePath</code><code class="p">());</code>
<code class="linenos">55 </code>					<code class="n">String</code> <code class="n">metaData</code> <code class="o">=</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">text_and_meta</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">.</code><code class="na">strip</code><code class="p">()</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">;</code>
<code class="linenos">56 </code>					<code class="n">TextToDbpediaUris</code> <code class="n">kt</code> <code class="o">=</code> 
<code class="linenos">57 </code>					  <code class="k">new</code> <code class="n">TextToDbpediaUris</code><code class="p">(</code><code class="n">text_and_meta</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code><code class="p">);</code>
<code class="linenos">58 </code>					<code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">kt</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">59 </code>						<code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">metaData</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">subjectUri</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> 
<code class="linenos">60 </code>						            <code class="n">kt</code><code class="p">.</code><code class="na">personUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">" ."</code><code class="p">);</code>
<code class="linenos">61 </code>						<code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">personUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">labelUri</code> <code class="o">+</code> 
<code class="linenos">62 </code>						            <code class="s">" \""</code> <code class="o">+</code> <code class="n">kt</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">"\" ."</code><code class="p">);</code>
<code class="linenos">63 </code>						<code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">personUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">typeOfUri</code> <code class="o">+</code> 
<code class="linenos">64 </code>						            <code class="s">" "</code> <code class="o">+</code> <code class="n">personTypeUri</code> <code class="o">+</code> <code class="s">" ."</code><code class="p">);</code>
<code class="linenos">65 </code>					<code class="p">}</code>
<code class="linenos">66 </code>					<code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">kt</code><code class="p">.</code><code class="na">companyNames</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">67 </code>						<code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">metaData</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> 
<code class="linenos">68 </code>						            <code class="n">subjectUri</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> 
<code class="linenos">69 </code>						            <code class="n">kt</code><code class="p">.</code><code class="na">companyUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">" ."</code><code class="p">);</code>
<code class="linenos">70 </code>						<code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">companyUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code>
<code class="linenos">71 </code>						           <code class="n">labelUri</code> <code class="o">+</code> <code class="s">" \""</code> <code class="o">+</code>
<code class="linenos">72 </code>						           <code class="n">kt</code><code class="p">.</code><code class="na">companyNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">"\" ."</code><code class="p">);</code>
<code class="linenos">73 </code>						<code class="n">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">companyUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">typeOfUri</code> <code class="o">+</code> 
<code class="linenos">74 </code>						            <code class="s">" "</code> <code class="o">+</code> <code class="n">companyTypeUri</code> <code class="o">+</code> <code class="s">" ."</code><code class="p">);</code>
<code class="linenos">75 </code>					<code class="p">}</code>
<code class="linenos">76 </code>				<code class="p">}</code>
<code class="linenos">77 </code>			<code class="p">}</code>
<code class="linenos">78 </code>		<code class="p">}</code>
<code class="linenos">79 </code>		<code class="n">out</code><code class="p">.</code><code class="na">close</code><code class="p">();</code>
<code class="linenos">80 </code>	<code class="p">}</code>
<code class="linenos">81 </code>
<code class="linenos">82 </code>	<code class="kd">private</code> <code class="n">String</code> <code class="o">[]</code> <code class="n">readData</code><code class="p">(</code><code class="n">String</code> <code class="n">textPath</code><code class="p">,</code> <code class="n">String</code> <code class="n">metaPath</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">IOException</code> <code class="p">{</code>
<code class="linenos">83 </code>		<code class="n">String</code> <code class="n">text</code> <code class="o">=</code> <code class="n">Files</code><code class="p">.</code><code class="na">readString</code><code class="p">(</code><code class="n">Paths</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">textPath</code><code class="p">),</code> <code class="n">StandardCharsets</code><code class="p">.</code><code class="na">UTF_8</code><code class="p">);</code>
<code class="linenos">84 </code>		<code class="n">String</code> <code class="n">meta</code> <code class="o">=</code> <code class="n">Files</code><code class="p">.</code><code class="na">readString</code><code class="p">(</code><code class="n">Paths</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">metaPath</code><code class="p">),</code> <code class="n">StandardCharsets</code><code class="p">.</code><code class="na">UTF_8</code><code class="p">);</code>
<code class="linenos">85 </code>		<code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="s">"\n\n** text:\n\n"</code> <code class="o">+</code> <code class="n">text</code><code class="p">);</code>
<code class="linenos">86 </code>		<code class="k">return</code> <code class="k">new</code> <code class="n">String</code><code class="o">[]</code> <code class="p">{</code> <code class="n">text</code><code class="p">,</code> <code class="n">meta</code> <code class="p">};</code>
<code class="linenos">87 </code>	<code class="p">}</code>
<code class="linenos">88 </code><code class="p">}</code>
</pre></div>

</figure>

<p>This code works on a list of paired files for text data and the meta data for each text file. As an example, if there is an input text file test123.txt then there would be a matching meta file test123.meta that contains the source of the data in the file test123.txt. This data source will be a URI on the web or a local file URI. The class contractor for <strong>KGC</strong> takes an output file path for writing the generated RDF data and a list of pairs of text and meta file paths.</p>

<p>The <strong>junit</strong> test class <strong>KgcTest</strong> will process the local directory <strong>test_data</strong> and generate an RDF output file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphcreator</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">junit.framework.Test</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">junit.framework.TestCase</code><code class="p">;</code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">junit.framework.TestSuite</code><code class="p">;</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">KgcTest</code> <code class="kd">extends</code> <code class="n">TestCase</code> <code class="p">{</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>  <code class="kd">public</code> <code class="nf">KgcTest</code><code class="p">(</code><code class="n">String</code> <code class="n">testName</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>    <code class="kd">super</code><code class="p">(</code><code class="n">testName</code><code class="p">);</code>
<code class="linenos">11 </code>  <code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Test</code> <code class="nf">suite</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">14 </code>    <code class="k">return</code> <code class="k">new</code> <code class="n">TestSuite</code><code class="p">(</code><code class="n">KgcTest</code><code class="p">.</code><code class="na">class</code><code class="p">);</code>
<code class="linenos">15 </code>  <code class="p">}</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">testKGC</code><code class="p">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos">18 </code>    <code class="n">assertTrue</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
<code class="linenos">19 </code>    <code class="n">KGC</code> <code class="n">client</code> <code class="o">=</code> <code class="k">new</code> <code class="n">KGC</code><code class="p">(</code><code class="s">"test_data/"</code><code class="p">,</code> <code class="s">"output_with_duplicates.rdf"</code><code class="p">);</code>
<code class="linenos">20 </code>  <code class="p">}</code>
<code class="linenos">21 </code>  <code class="kd">private</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">pause</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">22 </code>    <code class="k">try</code> <code class="p">{</code> <code class="n">Thread</code><code class="p">.</code><code class="na">sleep</code><code class="p">(</code><code class="mi">2000</code><code class="p">);</code>
<code class="linenos">23 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ignore</code><code class="p">)</code> <code class="p">{</code> <code class="p">}</code>
<code class="linenos">24 </code>  <code class="p">}</code>
<code class="linenos">25 </code><code class="p">}</code>
</pre></div>

</figure>

<p>If specific entity names occur in multiple input files there will be a few duplicated RDF statements generated. The simplest way to deal with this is to add a one line call to the <strong>awk</strong> utility to efficiently remove duplicate lines in the RDF output file. Here is a listing of the <strong>Makefile</strong> for this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>create_data_and_remove_duplicates:
	mvn <code class="nb">test</code>
	<code class="nb">echo</code> <code class="s2">"Removing duplicate RDF statements"</code>
	awk <code class="s1">'!visited[$$0]++'</code> output_with_duplicates.rdf &gt; output.rdf
	rm -f output_with_duplicates.rdf
</pre></div>

</figure>

<p>If you are not familiar with <strong>awk</strong> and want to learn the basics then I recommend <a href="http://www.hcs.harvard.edu/~dholland/computers/awk.html">this short tutorial</a>.</p>

<h3 id="leanpub-auto-kgcreator-wrap-up">KGCreator Wrap Up</h3>

<p>When developing applications or systems using Knowledge Graphs it is useful to be able to quickly generate test data which is the primary purpose of KGCreator. A secondary use is to generate  Knowledge Graphs for production use using text data sources. In this second use case you will want to manually inspect the generated data to verify its correctness or usefulness for your application.</p>


<h2 id="kgn">Knowledge Graph Navigator</h2>

<p>The Knowledge Graph Navigator (which I will often refer to as KGN) is a tool for processing a set of entity names and automatically exploring the public Knowledge Graph <a href="http://dbpedia.org">DBPedia</a> using SPARQL queries. I started to write KGN for my own use, to automate some things I used to do manually when exploring Knowledge Graphs, and later thought that KGN might be also useful for educational purposes. KGN shows the user the auto-generated SPARQL queries so hopefully the user will learn by seeing examples. KGN uses code developed in the earlier chapter <a href="#ner">Resolve Entity Names to DBPedia References</a> and we will reuse here as well as the two Java classes <strong>JenaAPis</strong> and <strong>QueryResults</strong> (which wrap the Apache Jena library) from the chapter <a href="#semantic-web">Semantic Web</a>.</p>

<p>I have a <a href="http://www.knowledgegraphnavigator.com/">web site devoted to different versions of KGN</a> that you might find interesting. The most full featured version of KGN, including a full user interface, is featured in my book <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, or the Savvy Programmer’s Secret Weapon</a> that you can read free online. That version performs more speculative SPARQL queries to find information compared to the example here that I designed for ease of understanding, modification, and embedding in larger Java projects.</p>

<p>I chose to use DBPedia instead of WikiData for this example because DBPedia URIs are human readable. The following URIs represent the concept of a <em>person</em>. The semantic meanings of DBPedia and FOAF (friend of a friend) URIs are self-evident to a human reader while the WikiData URI is not:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>http://www.wikidata.org/entity/Q215627
http://dbpedia.org/ontology/Person
http://xmlns.com/foaf/0.1/name
</pre></div>

</figure>

<p>I frequently use WikiData in my work and WikiData is one of the most useful public knowledge bases. I have both DBPedia and WikiData Sparql endpoints in the file <strong>Sparql.java</strong> that we will look at later, with the WikiData endpoint comment out. You can try manually querying WikiData at the <a href="https://query.wikidata.org">WikiData SPARL endpoint</a>. For example, you might explore the WikiData URI for the <em>person</em> concept using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="nv">?p</code> <code class="nv">?o</code> <code class="k">where</code> <code class="p">{</code> <code class="nl">&lt;http://www.wikidata.org/entity/Q215627&gt;</code> <code class="nv">?p</code> <code class="nv">?o</code>  <code class="p">}</code> <code class="k">limit</code> <code class="mi">10</code>
</pre></div>

</figure>

<p>For the rest of this chapter we will just use DBPedia.</p>

<p>After looking an interactive session using the example program for this chapter (that also includes listing automatically generated SPARQL queries) we will look at the implementation.</p>

<h3 id="leanpub-auto-entity-types-handled-by-kgn">Entity Types Handled by KGN</h3>

<p>To keep this example simple we handle just four entity types:</p>

<ul>
  <li>People</li>
  <li>Companies</li>
  <li>Cities</li>
  <li>Countries</li>
</ul>

<p>The entity detection library that we use from an earlier chapter also supports the following entity types that we don’t use here:</p>

<ul>
  <li>Broadcast Networks</li>
  <li>Music Groups</li>
  <li>Political Parties</li>
  <li>Trade Unions</li>
  <li>Universities</li>
</ul>

<p>In addition to finding detailed information for people, companies, cities, and countries we will also search for relationships between person entities and company entities. This search process consists of generating a series of SPARQL queries and calling the DBPedia SPARQL endpoint.</p>

<p>As we look at the KGN implementation I will point out where and how you can easily add support for more entity types and in the wrap-up I will suggest further projects that you might want to try implementing with this example.</p>

<h3 id="leanpub-auto-general-design-of-kgn-with-example-output">General Design of KGN with Example Output</h3>

<p>The example application works by first having the user enter names of people and companies. Using libraries written in two previous chapters, we find entities in the user’s input text, and generate SPARQL queries to DBPedia to find information about the entities and relationships between them.</p>

<p>We will start with looking at sample output so you have some understanding on what this implementation of KGN will and will not do. Here is the console output for the example query <em>“Bill Gates, Melinda Gates and Steve Jobs at Apple Computer, IBM and Microsoft”</em> (with some output removed for brevity). As you remember from the chapter <em>Semantic Web</em>, SPAQRL query results are expressed in class <strong>QueryResult</strong> that contains the variables (labelled as <strong>vars</strong>) in a query and a list of rows (one query result per row). Starting at line 117 in the following listing we see discovered relationships between entities in the input query.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="n">Enter</code> <code class="n">entities</code> <code class="nl">query</code><code class="p">:</code>
<code class="linenos">  2 </code><code class="n">Bill</code> <code class="n">Gates</code><code class="p">,</code> <code class="n">Melinda</code> <code class="n">Gates</code> <code class="n">and</code> <code class="n">Steve</code> <code class="n">Jobs</code> <code class="n">at</code> <code class="n">Apple</code> <code class="n">Computer</code><code class="p">,</code> <code class="n">IBM</code> <code class="n">and</code> <code class="n">Microsoft</code>
<code class="linenos">  3 </code>
<code class="linenos">  4 </code><code class="n">Processing</code> <code class="nl">query</code><code class="p">:</code>
<code class="linenos">  5 </code><code class="n">Bill</code> <code class="n">Gates</code><code class="p">,</code> <code class="n">Melinda</code> <code class="n">Gates</code> <code class="n">and</code> <code class="n">Steve</code> <code class="n">Jobs</code> <code class="n">at</code> <code class="n">Apple</code> <code class="n">Computer</code><code class="p">,</code> <code class="n">IBM</code> <code class="n">and</code> <code class="n">Microsoft</code>
<code class="linenos">  6 </code>
<code class="linenos">  7 </code><code class="n">person</code>	<code class="mi">0</code>	<code class="mi">1</code>	<code class="n">Bill</code> <code class="n">Gates</code>	<code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Bill_Gates&gt;</code>
<code class="linenos">  8 </code><code class="n">person</code>	<code class="mi">4</code>	<code class="mi">5</code>	<code class="n">Melinda</code> <code class="n">Gates</code>	<code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Melinda_Gates&gt;</code>
<code class="linenos">  9 </code><code class="n">person</code>	<code class="mi">7</code>	<code class="mi">8</code>	<code class="n">Steve</code> <code class="n">Jobs</code>	<code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Steve_Jobs&gt;</code>
<code class="linenos"> 10 </code><code class="n">company</code>	<code class="mi">10</code>	<code class="mi">11</code>	<code class="n">Apple</code> <code class="n">Computer</code>	<code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Apple_Inc.&gt;</code>
<code class="linenos"> 11 </code><code class="n">company</code>	<code class="mi">14</code>	<code class="mi">15</code>	<code class="n">IBM</code>	<code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/IBM&gt;</code>
<code class="linenos"> 12 </code><code class="n">company</code>	<code class="mi">16</code>	<code class="mi">17</code>	<code class="n">Microsoft</code>	<code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Microsoft&gt;</code>
<code class="linenos"> 13 </code>
<code class="linenos"> 14 </code><code class="n">Individual</code> <code class="nl">People</code><code class="p">:</code>
<code class="linenos"> 15 </code>
<code class="linenos"> 16 </code>  <code class="n">Bill</code> <code class="nl">Gates</code>                <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Bill_Gates</code>
<code class="linenos"> 17 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">birthplace</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">almamater</code><code class="p">,</code> <code class="n">spouse</code><code class="p">]</code>
<code class="linenos"> 18 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 19 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle, Bill Gates, William Henry \"Bill\" Gates III\</code>
<code class="linenos"> 20 </code><code class="c1"> (born October 28, 1955) is an American business magnate, investor, author and phila\</code>
<code class="linenos"> 21 </code><code class="c1">nthropist. In 1975, Gates and Paul Allen co-founded Microsoft, which became the worl\</code>
<code class="linenos"> 22 </code><code class="c1">d's largest PC software company. During his career at Microsoft, Gates held the posi\</code>
<code class="linenos"> 23 </code><code class="c1">tions of chairman, CEO and chief software architect, and was the largest individual \</code>
<code class="linenos"> 24 </code><code class="c1">shareholder until May 2014. Gates has authored and co-authored several books., http:\</code>
<code class="linenos"> 25 </code><code class="c1">//dbpedia.org/resource/Harvard_University, http://dbpedia.org/resource/Melinda_Gates\</code>
<code class="linenos"> 26 </code><code class="c1">]</code>
<code class="linenos"> 27 </code>
<code class="linenos"> 28 </code>  <code class="n">Melinda</code> <code class="nl">Gates</code>             <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Melinda_Gates</code>
<code class="linenos"> 29 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">birthplace</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">almamater</code><code class="p">,</code> <code class="n">spouse</code><code class="p">]</code>
<code class="linenos"> 30 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 31 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Dallas | http://dbpedia.org/resource/Dallas,_Texas, M\</code>
<code class="linenos"> 32 </code><code class="c1">elinda Gates, Melinda Ann Gates (née French; born August 15, 1964), DBE is an Americ\</code>
<code class="linenos"> 33 </code><code class="c1">an businesswoman and philanthropist. She is co-founder of the Bill &amp; Melinda Gates F\</code>
<code class="linenos"> 34 </code><code class="c1">oundation. She worked at Microsoft, where she was project manager for Microsoft Bob,\</code>
<code class="linenos"> 35 </code><code class="c1"> Microsoft Encarta and Expedia., http://dbpedia.org/resource/Duke_University, http:/\</code>
<code class="linenos"> 36 </code><code class="c1">/dbpedia.org/resource/Bill_Gates]</code>
<code class="linenos"> 37 </code>
<code class="linenos"> 38 </code>  <code class="n">Steve</code> <code class="nl">Jobs</code>                <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Steve_Jobs</code>
<code class="linenos"> 39 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">birthplace</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">almamater</code><code class="p">,</code> <code class="n">spouse</code><code class="p">]</code>
<code class="linenos"> 40 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 41 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/San_Francisco, Steve Jobs, Steven Paul \"Steve\" Jobs\</code>
<code class="linenos"> 42 </code><code class="c1"> (/ˈdʒɒbz/; February 24, 1955 – October 5, 2011) was an American information technol\</code>
<code class="linenos"> 43 </code><code class="c1">ogy entrepreneur and inventor. He was the co-founder, chairman, and chief executive \</code>
<code class="linenos"> 44 </code><code class="c1">officer (CEO) of Apple Inc.; CEO and majority shareholder of Pixar Animation Studios\</code>
<code class="linenos"> 45 </code><code class="c1">; a member of The Walt Disney Company's board of directors following its acquisition\</code>
<code class="linenos"> 46 </code><code class="c1"> of Pixar; and founder, chairman, and CEO of NeXT Inc. Jobs is widely recognized as \</code>
<code class="linenos"> 47 </code><code class="c1">a pioneer of the microcomputer revolution of the 1970s and 1980s, along with Apple c\</code>
<code class="linenos"> 48 </code><code class="c1">o-founder Steve Wozniak. Shortly after his death, Jobs's official biographer, Walter\</code>
<code class="linenos"> 49 </code><code class="c1"> Isaacson, described him as a \"creative entrepreneur whose passion for perfection a\</code>
<code class="linenos"> 50 </code><code class="c1">nd ferocious drive revolutionized six industries: personal computers, animated movie\</code>
<code class="linenos"> 51 </code><code class="c1">s, music, phones, tab, http://dbpedia.org/resource/Reed_College, http://dbpedia.org/\</code>
<code class="linenos"> 52 </code><code class="c1">resource/Laurene_Powell_Jobs]</code>
<code class="linenos"> 53 </code>
<code class="linenos"> 54 </code>
<code class="linenos"> 55 </code><code class="n">Individual</code> <code class="nl">Companies</code><code class="p">:</code>
<code class="linenos"> 56 </code>
<code class="linenos"> 57 </code>  <code class="n">Apple</code> <code class="nl">Computer</code>            <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Apple_Inc.</code>
<code class="linenos"> 58 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">industry</code><code class="p">,</code> <code class="n">netIncome</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">numberOfEmployees</code><code class="p">]</code>
<code class="linenos"> 59 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 60 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Computer_hardware | http://dbpedia.org/resource/Compu\</code>
<code class="linenos"> 61 </code><code class="c1">ter_software | http://dbpedia.org/resource/Consumer_electronics | http://dbpedia.org\</code>
<code class="linenos"> 62 </code><code class="c1">/resource/Corporate_Venture_Capital | http://dbpedia.org/resource/Digital_distributi\</code>
<code class="linenos"> 63 </code><code class="c1">on | http://dbpedia.org/resource/Fabless_manufacturing, 5.3394E10, Apple Inc., Apple\</code>
<code class="linenos"> 64 </code><code class="c1"> Inc. is an American multinational technology company headquartered in Cupertino, Ca\</code>
<code class="linenos"> 65 </code><code class="c1">lifornia, that designs, develops, and sells consumer electronics, computer software,\</code>
<code class="linenos"> 66 </code><code class="c1"> and online services. Its hardware products include the iPhone smartphone, the iPad \</code>
<code class="linenos"> 67 </code><code class="c1">tablet computer, the Mac personal computer, the iPod portable media player, the Appl\</code>
<code class="linenos"> 68 </code><code class="c1">e Watch smartwatch, and the Apple TV digital media player. Apple's consumer software\</code>
<code class="linenos"> 69 </code><code class="c1"> includes the macOS and iOS operating systems, the iTunes media player, the Safari w\</code>
<code class="linenos"> 70 </code><code class="c1">eb browser, and the iLife and iWork creativity and productivity suites. Its online s\</code>
<code class="linenos"> 71 </code><code class="c1">ervices include the iTunes Store, the iOS App Store and Mac App Store, Apple Music, \</code>
<code class="linenos"> 72 </code><code class="c1">and iCloud., 115000]</code>
<code class="linenos"> 73 </code>
<code class="linenos"> 74 </code>  <code class="nl">IBM</code>                       <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/IBM</code>
<code class="linenos"> 75 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">industry</code><code class="p">,</code> <code class="n">netIncome</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">numberOfEmployees</code><code class="p">]</code>
<code class="linenos"> 76 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 77 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Cloud_computing | http://dbpedia.org/resource/Cogniti\</code>
<code class="linenos"> 78 </code><code class="c1">ve_computing | http://dbpedia.org/resource/Information_technology, 1.319E10, IBM, In\</code>
<code class="linenos"> 79 </code><code class="c1">ternational Business Machines Corporation (commonly referred to as IBM) is an Americ\</code>
<code class="linenos"> 80 </code><code class="c1">an multinational technology company headquartered in Armonk, New York, United States\</code>
<code class="linenos"> 81 </code><code class="c1">, with operations in over 170 countries. The company originated in 1911 as the Compu\</code>
<code class="linenos"> 82 </code><code class="c1">ting-Tabulating-Recording Company (CTR) and was renamed \"International Business Mac\</code>
<code class="linenos"> 83 </code><code class="c1">hines\" in 1924., 377757]</code>
<code class="linenos"> 84 </code>
<code class="linenos"> 85 </code>  <code class="nl">Microsoft</code>                 <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Microsoft</code>
<code class="linenos"> 86 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">industry</code><code class="p">,</code> <code class="n">netIncome</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">numberOfEmployees</code><code class="p">]</code>
<code class="linenos"> 87 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 88 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Computer_hardware | http://dbpedia.org/resource/Consu\</code>
<code class="linenos"> 89 </code><code class="c1">mer_electronics | http://dbpedia.org/resource/Digital_distribution | http://dbpedia.\</code>
<code class="linenos"> 90 </code><code class="c1">org/resource/Software, , Microsoft, Microsoft Corporation /ˈmaɪkrəˌsɒft, -roʊ-, -ˌsɔ\</code>
<code class="linenos"> 91 </code><code class="c1">ːft/ (commonly referred to as Microsoft or MS) is an American multinational technolo\</code>
<code class="linenos"> 92 </code><code class="c1">gy company headquartered in Redmond, Washington, that develops, manufactures, licens\</code>
<code class="linenos"> 93 </code><code class="c1">es, supports and sells computer software, consumer electronics and personal computer\</code>
<code class="linenos"> 94 </code><code class="c1">s and services. Its best known software products are the Microsoft Windows line of o\</code>
<code class="linenos"> 95 </code><code class="c1">perating systems, Microsoft Office office suite, and Internet Explorer and Edge web \</code>
<code class="linenos"> 96 </code><code class="c1">browsers. Its flagship hardware products are the Xbox video game consoles and the Mi\</code>
<code class="linenos"> 97 </code><code class="c1">crosoft Surface tablet lineup. As of 2011, it was the world's largest software maker\</code>
<code class="linenos"> 98 </code><code class="c1"> by revenue, and one of the world's most valuable companies., 114000]</code>
<code class="linenos"> 99 </code>
<code class="linenos">100 </code>
<code class="linenos">101 </code><code class="n">Individual</code> <code class="nl">Cities</code><code class="p">:</code>
<code class="linenos">102 </code>
<code class="linenos">103 </code>  <code class="nl">Seattle</code>                   <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle</code>
<code class="linenos">104 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">latitude_longitude</code><code class="p">,</code> <code class="n">populationDensity</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">country</code><code class="p">]</code>
<code class="linenos">105 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos">106 </code>  <code class="p">[</code><code class="n">POINT</code><code class="p">(</code><code class="mf">-122.33305358887</code> <code class="mf">47.609722137451</code><code class="p">),</code> <code class="mf">3150.979715864901</code><code class="p">,</code> <code class="n">Seattle</code><code class="p">,</code> <code class="n">Seattle</code> <code class="n">is</code> <code class="n">a</code>\
<code class="linenos">107 </code> <code class="n">West</code> <code class="n">Coast</code> <code class="n">seaport</code> <code class="n">city</code> <code class="n">and</code> <code class="n">the</code> <code class="n">seat</code> <code class="n">of</code> <code class="n">King</code> <code class="n">County</code><code class="p">,</code> <code class="n">Washington</code><code class="p">.</code> <code class="n">With</code> <code class="n">an</code> <code class="n">estimated</code> \
<code class="linenos">108 </code><code class="mi">684</code><code class="p">,</code><code class="mi">451</code> <code class="n">residents</code> <code class="n">as</code> <code class="n">of</code> <code class="mi">2015</code><code class="p">,</code> <code class="n">Seattle</code> <code class="n">is</code> <code class="n">the</code> <code class="n">largest</code> <code class="n">city</code> <code class="k">in</code> <code class="n">both</code> <code class="n">the</code> <code class="n">state</code> <code class="n">of</code> <code class="n">Washi</code>\
<code class="linenos">109 </code><code class="n">ngton</code> <code class="n">and</code> <code class="n">the</code> <code class="n">Pacific</code> <code class="n">Northwest</code> <code class="n">region</code> <code class="n">of</code> <code class="n">North</code> <code class="n">America</code><code class="p">.</code> <code class="n">As</code> <code class="n">of</code> <code class="mi">2015</code><code class="p">,</code> <code class="n">it</code> <code class="n">is</code> <code class="n">estimated</code>\
<code class="linenos">110 </code> <code class="n">to</code> <code class="n">be</code> <code class="n">the</code> <code class="mi">18</code><code class="n">th</code> <code class="n">largest</code> <code class="n">city</code> <code class="k">in</code> <code class="n">the</code> <code class="n">United</code> <code class="n">States</code><code class="p">.</code> <code class="n">In</code> <code class="n">July</code> <code class="mi">2013</code><code class="p">,</code> <code class="n">it</code> <code class="n">was</code> <code class="n">the</code> <code class="n">fastest</code><code class="o">-</code>\
<code class="linenos">111 </code><code class="n">growing</code> <code class="n">major</code> <code class="n">city</code> <code class="k">in</code> <code class="n">the</code> <code class="n">United</code> <code class="n">States</code> <code class="n">and</code> <code class="n">remained</code> <code class="k">in</code> <code class="n">the</code> <code class="n">Top</code> <code class="mi">5</code> <code class="k">in</code> <code class="n">May</code> <code class="mi">2015</code> <code class="n">with</code> <code class="n">a</code>\
<code class="linenos">112 </code><code class="n">n</code> <code class="n">annual</code> <code class="n">growth</code> <code class="n">rate</code> <code class="n">of</code> <code class="mf">2.1</code><code class="o">%</code><code class="p">.</code> <code class="n">The</code> <code class="n">Seattle</code> <code class="n">metropolitan</code> <code class="n">area</code> <code class="n">is</code> <code class="n">the</code> <code class="mi">15</code><code class="n">th</code> <code class="n">largest</code> <code class="n">metr</code>\
<code class="linenos">113 </code><code class="n">opolitan</code> <code class="n">area</code> <code class="k">in</code> <code class="n">the</code> <code class="n">United</code> <code class="n">States</code> <code class="n">with</code> <code class="n">over</code> <code class="mf">3.7</code> <code class="n">million</code> <code class="n">inhabitants</code><code class="p">.</code> <code class="n">The</code> <code class="n">city</code> <code class="n">is</code> <code class="n">si</code>\
<code class="linenos">114 </code><code class="n">tuated</code> <code class="n">on</code> <code class="n">an</code> <code class="n">isthmus</code> <code class="n">between</code> <code class="n">Puget</code> <code class="n">Sound</code> <code class="p">(</code><code class="n">an</code> <code class="n">inlet</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Pacific</code> <code class="n">Ocean</code><code class="p">)</code> <code class="n">and</code> <code class="n">Lake</code> <code class="n">Wa</code>\
<code class="linenos">115 </code><code class="n">shington</code><code class="p">,</code> <code class="n">about</code> <code class="mi">100</code> <code class="n">miles</code> <code class="p">(</code><code class="mi">160</code> <code class="n">km</code><code class="p">)</code> <code class="n">south</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Canada</code><code class="err">–</code><code class="n">United</code> <code class="n">States</code> <code class="n">border</code><code class="p">.</code> <code class="n">A</code> <code class="n">major</code>\
<code class="linenos">116 </code> <code class="n">gateway</code> <code class="k">for</code> <code class="n">trade</code> <code class="n">w</code><code class="p">,</code> <code class="p">]</code>
<code class="linenos">117 </code>
<code class="linenos">118 </code><code class="n">Individual</code> <code class="nl">Countries</code><code class="p">:</code>
<code class="linenos">119 </code>
<code class="linenos">120 </code>
<code class="linenos">121 </code><code class="n">Relationships</code> <code class="n">between</code> <code class="n">person</code> <code class="n">Bill</code> <code class="n">Gates</code> <code class="n">person</code> <code class="n">Melinda</code> <code class="nl">Gates</code><code class="p">:</code>
<code class="linenos">122 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">p</code><code class="p">]</code>
<code class="linenos">123 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos">124 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/spouse]</code>
<code class="linenos">125 </code>
<code class="linenos">126 </code><code class="n">Relationships</code> <code class="n">between</code> <code class="n">person</code> <code class="n">Melinda</code> <code class="n">Gates</code> <code class="n">person</code> <code class="n">Bill</code> <code class="nl">Gates</code><code class="p">:</code>
<code class="linenos">127 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">p</code><code class="p">]</code>
<code class="linenos">128 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos">129 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/spouse]</code>
<code class="linenos">130 </code>
<code class="linenos">131 </code><code class="n">Relationships</code> <code class="n">between</code> <code class="n">person</code> <code class="n">Bill</code> <code class="n">Gates</code> <code class="n">company</code> <code class="nl">Microsoft</code><code class="p">:</code>
<code class="linenos">132 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">p</code><code class="p">]</code>
<code class="linenos">133 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos">134 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/board]</code>
<code class="linenos">135 </code>
<code class="linenos">136 </code><code class="n">Relationships</code> <code class="n">between</code> <code class="n">person</code> <code class="n">Steve</code> <code class="n">Jobs</code> <code class="n">company</code> <code class="n">Apple</code> <code class="nl">Computer</code><code class="p">:</code>
<code class="linenos">137 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">p</code><code class="p">]</code>
<code class="linenos">138 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos">139 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//www.w3.org/2000/01/rdf-schema#seeAlso]</code>
<code class="linenos">140 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/board]</code>
<code class="linenos">141 </code>  <code class="p">[</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/occupation]</code>
</pre></div>

</figure>

<p>Since the DBPedia queries are time consuming, we use the caching layer from the earlier chapter <em>Semantic Web</em> when making SPARQL queries to DBPedia. The cache is especially helpful during development when the same queries are repeatedly used for testing.</p>

<p>The KGN user interface loop allows you to enter queries and see the results. There are two special options that you can enter instead of a query:</p>

<ul>
  <li>sparql - this will print out all previous SPARQL queries used to present results. After entering this command the buffer of previous SPARQL queries is emptied. This option is useful for learning SPARQL and you might try pasting a few into the input field for the <a href="http://dbpedia.org/sparql">public DBPedia SPARQL web app</a> and modifying them. We will use this command later in an example.</li>
  <li>demo - this will randomly choose a sample query.</li>
</ul>

<h3 id="leanpub-auto-uml-class-diagram-for-example-application">UML Class Diagram for Example Application</h3>

<p>The following UML Class Diagram for KGN shows you an overview of the Java classes we use and their public methods and fields.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/kgn-uml.png" alt="UML Class Diagram for KGN Example Application" style="width: 100%">
    <figcaption>UML Class Diagram for KGN Example Application</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-implementation-1">Implementation</h3>

<p>We will walk through the classes in the UML Class Diagram for KGN in alphabetical order, the exception being that we will look at the main program in <strong>KGN.java</strong> last.</p>

<p>The class <strong>EntityAndDescription</strong> contains two strings, a name and a URI reference. We also override the default implementation of <strong>toString</strong> to format and display the data in an instance of this class:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EntityAndDescription</code> <code class="p">{</code>
<code class="linenos"> 4 </code>  <code class="kd">public</code> <code class="n">String</code> <code class="n">entityName</code><code class="p">;</code>
<code class="linenos"> 5 </code>  <code class="kd">public</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">;</code>
<code class="linenos"> 6 </code>  <code class="kd">public</code> <code class="nf">EntityAndDescription</code><code class="p">(</code><code class="n">String</code> <code class="n">entityName</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 7 </code>    <code class="k">this</code><code class="p">.</code><code class="na">entityName</code> <code class="o">=</code> <code class="n">entityName</code><code class="p">;</code>
<code class="linenos"> 8 </code>    <code class="k">this</code><code class="p">.</code><code class="na">entityUri</code> <code class="o">=</code> <code class="n">entityUri</code><code class="p">;</code>
<code class="linenos"> 9 </code>  <code class="p">}</code>
<code class="linenos">10 </code>  <code class="kd">public</code> <code class="n">String</code> <code class="nf">toString</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">11 </code>    <code class="k">return</code> <code class="s">"[EntityAndDescription name: "</code> <code class="o">+</code> <code class="n">entityName</code> <code class="o">+</code>
<code class="linenos">12 </code>        <code class="s">" description: "</code> <code class="o">+</code> <code class="n">entityUri</code> <code class="o">+</code> <code class="s">"]"</code><code class="p">;</code>
<code class="linenos">13 </code>  <code class="p">}</code>
<code class="linenos">14 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>EntityDetail</strong> defines SPARQL query templates in lines 80-154 that have slots (using <strong>%s</strong> for string replacement) for the URI of an entity. We use different templates for different entity types. Before we look at these SPARQL query templates, let’s learn two additional features of the SPARQL language that we will need to use in these entity templates.</p>

<p>We mentioned the <strong>OPTIONAL</strong> triple matching patterns in the chapter <em>Semantic Web</em>. Before looking at the Java code, let’s first look at how optional matching works. We will run the KGN application asking for information on the city Seattle and then use the <strong>sparql</strong> command to print the generated SPARQL produced by the method <strong>cityResults</strong> (most output is not shown here for brevity). On line 2 I enter the query string “Seattle” and on line 22 I enter the command “sparql” to print out the generated SPARQL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">Enter</code> <code class="n">entities</code> <code class="nl">query</code><code class="p">:</code>
<code class="linenos"> 2 </code><code class="n">Seattle</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="n">Individual</code> <code class="nl">Cities</code><code class="p">:</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>  <code class="nl">Seattle</code>                   <code class="p">:</code> <code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle</code>
<code class="linenos"> 7 </code><code class="p">[</code><code class="n">QueryResult</code> <code class="nl">vars</code><code class="p">:[</code><code class="n">latitude_longitude</code><code class="p">,</code> <code class="n">populationDensity</code><code class="p">,</code> <code class="n">label</code><code class="p">,</code> <code class="n">comment</code><code class="p">,</code> <code class="n">country</code><code class="p">]</code>
<code class="linenos"> 8 </code><code class="nl">Rows</code><code class="p">:</code>
<code class="linenos"> 9 </code>  <code class="p">[</code><code class="n">POINT</code><code class="p">(</code><code class="mf">-122.33305358887</code> <code class="mf">47.609722137451</code><code class="p">),</code> <code class="mf">3150.979715864901</code><code class="p">,</code> <code class="n">Seattle</code><code class="p">,</code> <code class="n">Seattle</code> <code class="n">is</code> <code class="n">a</code>\
<code class="linenos">10 </code> <code class="n">West</code> <code class="n">Coast</code> <code class="n">seaport</code> <code class="n">city</code> <code class="n">and</code> <code class="n">the</code> <code class="n">seat</code> <code class="n">of</code> <code class="n">King</code> <code class="n">County</code><code class="p">,</code> <code class="n">Washington</code><code class="p">.</code> <code class="n">With</code> <code class="n">an</code> <code class="n">estimated</code> \
<code class="linenos">11 </code><code class="mi">684</code><code class="p">,</code><code class="mi">451</code> <code class="n">residents</code> <code class="n">as</code> <code class="n">of</code> <code class="mi">2015</code><code class="p">,</code> <code class="n">Seattle</code> <code class="n">is</code> <code class="n">the</code> <code class="n">largest</code> <code class="n">city</code> <code class="k">in</code> <code class="n">both</code> <code class="n">the</code> <code class="n">state</code> <code class="n">of</code> <code class="n">Washi</code>\
<code class="linenos">12 </code><code class="n">ngton</code> <code class="n">and</code> <code class="n">the</code> <code class="n">Pacific</code> <code class="n">Northwest</code> <code class="n">region</code> <code class="n">of</code> <code class="n">North</code> <code class="n">America</code><code class="p">.</code> <code class="n">As</code> <code class="n">of</code> <code class="mi">2015</code><code class="p">,</code> <code class="n">it</code> <code class="n">is</code> <code class="n">estimated</code>\
<code class="linenos">13 </code> <code class="n">to</code> <code class="n">be</code> <code class="n">the</code> <code class="mi">18</code><code class="n">th</code> <code class="n">largest</code> <code class="n">city</code> <code class="k">in</code> <code class="n">the</code> <code class="n">United</code> <code class="n">States</code><code class="p">.</code> <code class="n">In</code> <code class="n">July</code> <code class="mi">2013</code><code class="p">,</code> <code class="n">it</code> <code class="n">was</code> <code class="n">the</code> <code class="n">fastest</code><code class="o">-</code>\
<code class="linenos">14 </code><code class="n">growing</code> <code class="n">major</code> <code class="n">city</code> <code class="k">in</code> <code class="n">the</code> <code class="n">United</code> <code class="n">States</code> <code class="n">and</code> <code class="n">remained</code> <code class="k">in</code> <code class="n">the</code> <code class="n">Top</code> <code class="mi">5</code> <code class="k">in</code> <code class="n">May</code> <code class="mi">2015</code> <code class="n">with</code> <code class="n">a</code>\
<code class="linenos">15 </code><code class="n">n</code> <code class="n">annual</code> <code class="n">growth</code> <code class="n">rate</code> <code class="n">of</code> <code class="mf">2.1</code><code class="o">%</code><code class="p">.</code> <code class="n">The</code> <code class="n">Seattle</code> <code class="n">metropolitan</code> <code class="n">area</code> <code class="n">is</code> <code class="n">the</code> <code class="mi">15</code><code class="n">th</code> <code class="n">largest</code> <code class="n">metr</code>\
<code class="linenos">16 </code><code class="n">opolitan</code> <code class="n">area</code> <code class="k">in</code> <code class="n">the</code> <code class="n">United</code> <code class="n">States</code> <code class="n">with</code> <code class="n">over</code> <code class="mf">3.7</code> <code class="n">million</code> <code class="n">inhabitants</code><code class="p">.</code> <code class="n">The</code> <code class="n">city</code> <code class="n">is</code> <code class="n">si</code>\
<code class="linenos">17 </code><code class="n">tuated</code> <code class="n">on</code> <code class="n">an</code> <code class="n">isthmus</code> <code class="n">between</code> <code class="n">Puget</code> <code class="n">Sound</code> <code class="p">(</code><code class="n">an</code> <code class="n">inlet</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Pacific</code> <code class="n">Ocean</code><code class="p">)</code> <code class="n">and</code> <code class="n">Lake</code> <code class="n">Wa</code>\
<code class="linenos">18 </code><code class="n">shington</code><code class="p">,</code> <code class="n">about</code> <code class="mi">100</code> <code class="n">miles</code> <code class="p">(</code><code class="mi">160</code> <code class="n">km</code><code class="p">)</code> <code class="n">south</code> <code class="n">of</code> <code class="n">the</code> <code class="n">Canada</code><code class="err">–</code><code class="n">United</code> <code class="n">States</code> <code class="n">border</code><code class="p">.</code> <code class="n">A</code> <code class="n">major</code>\
<code class="linenos">19 </code> <code class="n">gateway</code> <code class="k">for</code> <code class="n">trade</code> <code class="n">w</code><code class="p">,</code> <code class="p">]</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="n">Processing</code> <code class="nl">query</code><code class="p">:</code>
<code class="linenos">22 </code><code class="n">sparql</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="n">Generated</code> <code class="n">SPARQL</code> <code class="n">used</code> <code class="n">to</code> <code class="n">get</code> <code class="n">current</code> <code class="nl">results</code><code class="p">:</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="n">SELECT</code> <code class="n">DISTINCT</code>
<code class="linenos">27 </code>    <code class="p">(</code><code class="n">GROUP_CONCAT</code> <code class="p">(</code><code class="n">DISTINCT</code> <code class="o">?</code><code class="n">latitude_longitude2</code><code class="p">;</code> <code class="n">SEPARATOR</code><code class="o">=</code><code class="err">'</code> <code class="o">|</code> <code class="err">'</code><code class="p">)</code> 
<code class="linenos">28 </code>        <code class="n">AS</code> <code class="o">?</code><code class="n">latitude_longitude</code><code class="p">)</code> 
<code class="linenos">29 </code>    <code class="p">(</code><code class="n">GROUP_CONCAT</code> <code class="p">(</code><code class="n">DISTINCT</code> <code class="o">?</code><code class="n">populationDensity2</code><code class="p">;</code> <code class="n">SEPARATOR</code><code class="o">=</code><code class="err">'</code> <code class="o">|</code> <code class="err">'</code><code class="p">)</code>
<code class="linenos">30 </code>        <code class="n">AS</code> <code class="o">?</code><code class="n">populationDensity</code><code class="p">)</code> 
<code class="linenos">31 </code>    <code class="p">(</code><code class="n">GROUP_CONCAT</code> <code class="p">(</code><code class="n">DISTINCT</code> <code class="o">?</code><code class="n">label2</code><code class="p">;</code> <code class="n">SEPARATOR</code><code class="o">=</code><code class="err">'</code> <code class="o">|</code> <code class="err">'</code><code class="p">)</code> <code class="n">AS</code> <code class="o">?</code><code class="n">label</code><code class="p">)</code> 
<code class="linenos">32 </code>    <code class="p">(</code><code class="n">GROUP_CONCAT</code> <code class="p">(</code><code class="n">DISTINCT</code> <code class="o">?</code><code class="n">comment2</code><code class="p">;</code> <code class="n">SEPARATOR</code><code class="o">=</code><code class="err">'</code> <code class="o">|</code> <code class="err">'</code><code class="p">)</code> <code class="n">AS</code> <code class="o">?</code><code class="n">comment</code><code class="p">)</code> 
<code class="linenos">33 </code>    <code class="p">(</code><code class="n">GROUP_CONCAT</code> <code class="p">(</code><code class="n">DISTINCT</code> <code class="o">?</code><code class="n">country2</code><code class="p">;</code> <code class="n">SEPARATOR</code><code class="o">=</code><code class="err">'</code> <code class="o">|</code> <code class="err">'</code><code class="p">)</code> <code class="n">AS</code> <code class="o">?</code><code class="n">country</code><code class="p">)</code> <code class="p">{</code> 
<code class="linenos">34 </code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle&gt;</code>
<code class="linenos">35 </code>   <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//www.w3.org/2000/01/rdf-schema#comment&gt;</code>
<code class="linenos">36 </code>   <code class="o">?</code><code class="n">comment2</code> <code class="p">.</code>
<code class="linenos">37 </code>        <code class="n">FILTER</code>  <code class="p">(</code><code class="n">lang</code><code class="p">(</code><code class="o">?</code><code class="n">comment2</code><code class="p">)</code> <code class="o">=</code> <code class="err">'</code><code class="n">en</code><code class="err">'</code><code class="p">)</code> <code class="p">.</code> 
<code class="linenos">38 </code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle&gt;</code>
<code class="linenos">39 </code>            <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//www.w3.org/2003/01/geo/wgs84_pos#geometry&gt;</code>
<code class="linenos">40 </code>            <code class="o">?</code><code class="n">latitude_longitude2</code> <code class="p">}</code> <code class="p">.</code> 
<code class="linenos">41 </code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle&gt;</code>
<code class="linenos">42 </code>            <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/PopulatedPlace/populationDensity&gt;</code>
<code class="linenos">43 </code>            <code class="o">?</code><code class="n">populationDensity2</code> <code class="p">}</code> <code class="p">.</code> 
<code class="linenos">44 </code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle&gt;</code>
<code class="linenos">45 </code>            <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/ontology/country&gt;</code>
<code class="linenos">46 </code>            <code class="o">?</code><code class="n">country2</code> <code class="p">}</code> <code class="p">.</code> 
<code class="linenos">47 </code> <code class="n">OPTIONAL</code> <code class="p">{</code> <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//dbpedia.org/resource/Seattle&gt;</code>
<code class="linenos">48 </code>            <code class="o">&lt;</code><code class="nl">http</code><code class="p">:</code><code class="c1">//www.w3.org/2000/01/rdf-schema#label&gt;</code>
<code class="linenos">49 </code>            <code class="o">?</code><code class="n">label2</code> <code class="p">.</code> <code class="p">}</code> 
<code class="linenos">50 </code> <code class="p">}</code> <code class="n">LIMIT</code> <code class="mi">30</code>
</pre></div>

</figure>

<p>This listing was manually edited to fit page width. In lines 34-36, we are trying to find a triple stating which country Seattle is in. Please note that this triple matching pattern is generated as one line but I had to manually edit it here to fit the page width.</p>

<p>The triple matching pattern in lines 34-36 must match some triple in DBPedia or no results will be returned. In other words this matching pattern is mandatory. The four optional matching patterns in lines 38-49 specify triple patterns that may be matched. In this example there is no triple matching the following statement in the DBPedia knowledge base so the variable <strong>country2</strong> is not bound and the query returns no results for the variable <strong>country</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nl">&lt;http://dbpedia.org/resource/Seattle&gt;</code> <code class="nl">&lt;http://dbpedia.org/ontology/country&gt;</code> <code class="nv">?country2</code>
</pre></div>

</figure>

<p>Notice also the syntax for <strong>GROUP_CONCAT</strong> used in lines 27-33, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>  <code class="p">(</code><code class="nf">GROUP_CONCAT</code> <code class="p">(</code><code class="k">DISTINCT</code> <code class="nv">?country2</code><code class="p">;</code> <code class="nf">SEPARATOR</code><code class="o">=</code><code class="s">' | '</code><code class="p">)</code> <code class="k">AS</code> <code class="nv">?country</code><code class="p">)</code>
</pre></div>

</figure>

<p>This collects all values assigned to the binding variable <strong>?country2</strong> into a string value using the separator string “ | “. Using <strong>DISTINCT</strong> with <strong>GROUP_CONCAT</strong> conveniently discards duplicate bindings for binding variables like <strong>?country2</strong>.</p>

<p>Now that we have looked at SPARQL examples using <strong>OPTIONAL</strong> and <strong>GROUP_CONCAT</strong>, the templates at the end of the following listing should be easier to understand.</p>

<p>The methods <strong>genericResults</strong> and <strong>genericAsString</strong> in the following listing are not currently used in this example but I leave them as easy way to get information, given any entity URI. You are likely to use these if you use the code for KGN in your projects.</p>

<p>For each entity type, for example <em>city</em>, I wrote one method like <strong>cityResults</strong> that returns an instance of <strong>QueryResult</strong> calculated by using the <strong>JenaApis</strong> library from the chapter <em>Semantic Web</em>. For each entity type there is another method, like <strong>cityAsString</strong> that converts an instance of <strong>QueryResult</strong> to a formatted string for display.</p>

<p>We use the code pattern seen in lines 29-30 for each entity type. We use the static method <strong>String.format</strong>  to replace occurrences of <strong>%s</strong> in the entity template string with the string representation of entity URIs.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="kn">import</code> <code class="nn">com.markwatson.semanticweb.QueryResult</code><code class="p">;</code>
<code class="linenos">  4 </code>
<code class="linenos">  5 </code><code class="kn">import</code> <code class="nn">java.sql.SQLException</code><code class="p">;</code> <code class="c1">// Cache layer in JenaApis library throws this</code>
<code class="linenos">  6 </code>
<code class="linenos">  7 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EntityDetail</code> <code class="p">{</code>
<code class="linenos">  8 </code>
<code class="linenos">  9 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">genericResults</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 10 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 11 </code>    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code>
<code class="linenos"> 12 </code>        <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code>
<code class="linenos"> 13 </code>            <code class="s">"select distinct ?p ?o where { %s ?p ?o . "</code> <code class="o">+</code>
<code class="linenos"> 14 </code>            <code class="s">"  FILTER (!regex(str(?p), 'wiki', 'i')) . "</code> <code class="o">+</code>
<code class="linenos"> 15 </code>            <code class="s">"  FILTER (!regex(str(?p), 'wiki', 'i')) } limit 10"</code><code class="p">,</code>
<code class="linenos"> 16 </code>            <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 17 </code>    <code class="k">return</code> <code class="n">endpoint</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos"> 18 </code>  <code class="p">}</code>
<code class="linenos"> 19 </code>
<code class="linenos"> 20 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">String</code> <code class="nf">genericAsString</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 21 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 22 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">genericResults</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 23 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
<code class="linenos"> 24 </code>  <code class="p">}</code>
<code class="linenos"> 25 </code>
<code class="linenos"> 26 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">cityResults</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 27 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 28 </code>    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code>
<code class="linenos"> 29 </code>        <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="n">cityTemplate</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code>
<code class="linenos"> 30 </code>                      <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 31 </code>    <code class="k">return</code> <code class="n">endpoint</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos"> 32 </code>  <code class="p">}</code>
<code class="linenos"> 33 </code>
<code class="linenos"> 34 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">String</code> <code class="nf">cityAsString</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 35 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 36 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">cityResults</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 37 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
<code class="linenos"> 38 </code>  <code class="p">}</code>
<code class="linenos"> 39 </code>
<code class="linenos"> 40 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">countryResults</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 41 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 42 </code>    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code>
<code class="linenos"> 43 </code>        <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="n">countryTemplate</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code>
<code class="linenos"> 44 </code>                      <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 45 </code>    <code class="k">return</code> <code class="n">endpoint</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos"> 46 </code>  <code class="p">}</code>
<code class="linenos"> 47 </code>
<code class="linenos"> 48 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">String</code> <code class="nf">countryAsString</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 49 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 50 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">countryResults</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 51 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
<code class="linenos"> 52 </code>  <code class="p">}</code>
<code class="linenos"> 53 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">personResults</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 54 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 55 </code>    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code>
<code class="linenos"> 56 </code>        <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="n">personTemplate</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code>
<code class="linenos"> 57 </code>                      <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 58 </code>    <code class="k">return</code> <code class="n">endpoint</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos"> 59 </code>  <code class="p">}</code>
<code class="linenos"> 60 </code>
<code class="linenos"> 61 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">String</code> <code class="nf">personAsString</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 62 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 63 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">personResults</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 64 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
<code class="linenos"> 65 </code>  <code class="p">}</code>
<code class="linenos"> 66 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">companyResults</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 67 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 68 </code>    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code>
<code class="linenos"> 69 </code>        <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="n">companyTemplate</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">,</code>
<code class="linenos"> 70 </code>                      <code class="n">entityUri</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 71 </code>    <code class="k">return</code> <code class="n">endpoint</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos"> 72 </code>  <code class="p">}</code>
<code class="linenos"> 73 </code>
<code class="linenos"> 74 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">String</code> <code class="nf">companyAsString</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code> <code class="n">String</code> <code class="n">entityUri</code><code class="p">)</code>
<code class="linenos"> 75 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos"> 76 </code>    <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> <code class="n">companyResults</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">entityUri</code><code class="p">);</code>
<code class="linenos"> 77 </code>    <code class="k">return</code> <code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">();</code>
<code class="linenos"> 78 </code>  <code class="p">}</code>
<code class="linenos"> 79 </code>
<code class="linenos"> 80 </code>  <code class="kd">static</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">companyTemplate</code> <code class="o">=</code>
<code class="linenos"> 81 </code>    <code class="s">"SELECT DISTINCT"</code> <code class="o">+</code>
<code class="linenos"> 82 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?industry2; SEPARATOR=' | ') AS ?industry)\n"</code> <code class="o">+</code>
<code class="linenos"> 83 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?netIncome2; SEPARATOR=' | ') AS ?netIncome)\n"</code> <code class="o">+</code>
<code class="linenos"> 84 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?label2; SEPARATOR=' | ') AS ?label)\n"</code> <code class="o">+</code>
<code class="linenos"> 85 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?comment2; SEPARATOR=' | ') AS ?comment)\n"</code> <code class="o">+</code>
<code class="linenos"> 86 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?numberOfEmployees2; SEPARATOR=' | ')\n"</code> <code class="o">+</code>
<code class="linenos"> 87 </code>    <code class="s">"         AS ?numberOfEmployees) {\n"</code> <code class="o">+</code>
<code class="linenos"> 88 </code>    <code class="s">"  %s &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment2 .\n"</code> <code class="o">+</code>
<code class="linenos"> 89 </code>    <code class="s">"            FILTER  (lang(?comment2) = 'en') .\n"</code> <code class="o">+</code>
<code class="linenos"> 90 </code>    <code class="s">"  OPTIONAL { %s &lt;http://dbpedia.org/ontology/industry&gt; ?industry2 } .\n"</code> <code class="o">+</code>
<code class="linenos"> 91 </code>    <code class="s">"  OPTIONAL { %s &lt;http://dbpedia.org/ontology/netIncome&gt; ?netIncome2 } .\n"</code> <code class="o">+</code>
<code class="linenos"> 92 </code>    <code class="s">"  OPTIONAL {\n"</code> <code class="o">+</code>
<code class="linenos"> 93 </code>    <code class="s">"    %s &lt;http://dbpedia.org/ontology/numberOfEmployees&gt; ?numberOfEmployees2\n"</code> <code class="o">+</code>
<code class="linenos"> 94 </code>    <code class="s">"  } .\n"</code> <code class="o">+</code>
<code class="linenos"> 95 </code>    <code class="s">"  OPTIONAL { %s &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label2 .\n"</code> <code class="o">+</code>
<code class="linenos"> 96 </code>    <code class="s">"            FILTER (lang(?label2) = 'en') } \n"</code> <code class="o">+</code>
<code class="linenos"> 97 </code>    <code class="s">"} LIMIT 30"</code><code class="p">;</code>
<code class="linenos"> 98 </code>  
<code class="linenos"> 99 </code>  <code class="kd">static</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">personTemplate</code> <code class="o">=</code>
<code class="linenos">100 </code>    <code class="s">"SELECT DISTINCT\n"</code> <code class="o">+</code>
<code class="linenos">101 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?birthplace2; SEPARATOR=' | ') AS ?birthplace)  \n"</code><code class="err">\</code>
<code class="linenos">102 </code> <code class="o">+</code>
<code class="linenos">103 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?label2; SEPARATOR=' | ') AS ?label)  \n"</code> <code class="o">+</code>
<code class="linenos">104 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?comment2; SEPARATOR=' | ') AS ?comment)  \n"</code> <code class="o">+</code>
<code class="linenos">105 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?almamater2; SEPARATOR=' | ') AS ?almamater)  \n"</code> <code class="o">+</code>
<code class="linenos">106 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?spouse2; SEPARATOR=' | ') AS ?spouse) {  \n"</code> <code class="o">+</code>
<code class="linenos">107 </code>    <code class="s">" %s &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment2 .\n"</code> <code class="o">+</code>
<code class="linenos">108 </code>    <code class="s">" FILTER  (lang(?comment2) = 'en') .  \n"</code> <code class="o">+</code>
<code class="linenos">109 </code>    <code class="s">" OPTIONAL { %s &lt;http://dbpedia.org/ontology/birthPlace&gt; ?birthplace2 } .  \n"</code> <code class="o">+</code>
<code class="linenos">110 </code>    <code class="s">" OPTIONAL { %s &lt;http://dbpedia.org/ontology/almaMater&gt; ?almamater2 } .  \n"</code> <code class="o">+</code>
<code class="linenos">111 </code>    <code class="s">" OPTIONAL { %s &lt;http://dbpedia.org/ontology/spouse&gt; ?spouse2 } .  \n"</code> <code class="o">+</code>
<code class="linenos">112 </code>    <code class="s">" OPTIONAL { %s  &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label2 . \n"</code> <code class="o">+</code>
<code class="linenos">113 </code>    <code class="s">"    FILTER  (lang(?label2) = 'en') }  \n"</code> <code class="o">+</code>
<code class="linenos">114 </code>    <code class="s">" } LIMIT 10"</code><code class="p">;</code>
<code class="linenos">115 </code>
<code class="linenos">116 </code>  <code class="kd">static</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">countryTemplate</code> <code class="o">=</code>
<code class="linenos">117 </code>   <code class="s">"SELECT DISTINCT"</code> <code class="o">+</code>
<code class="linenos">118 </code>   <code class="s">"   (GROUP_CONCAT (DISTINCT ?areaTotal2; SEPARATOR=' | ') AS ?areaTotal)\n"</code> <code class="o">+</code>
<code class="linenos">119 </code>   <code class="s">"   (GROUP_CONCAT (DISTINCT ?label2; SEPARATOR=' | ') AS ?label)\n"</code> <code class="o">+</code>
<code class="linenos">120 </code>   <code class="s">"   (GROUP_CONCAT (DISTINCT ?comment2; SEPARATOR=' | ') AS ?comment)\n"</code> <code class="o">+</code>
<code class="linenos">121 </code>   <code class="s">"   (GROUP_CONCAT (DISTINCT ?populationDensity2; SEPARATOR=' | ')\n"</code> <code class="o">+</code>
<code class="linenos">122 </code>   <code class="s">"     AS ?populationDensity) {\n"</code> <code class="o">+</code>
<code class="linenos">123 </code>   <code class="s">"  %s &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment2 .\n"</code> <code class="o">+</code>
<code class="linenos">124 </code>   <code class="s">"                           FILTER  (lang(?comment2) = 'en') .\n"</code> <code class="o">+</code>
<code class="linenos">125 </code>   <code class="s">"  OPTIONAL { %s &lt;http://dbpedia.org/ontology/areaTotal&gt; ?areaTotal2 } .\n"</code> <code class="o">+</code>
<code class="linenos">126 </code>   <code class="s">"  OPTIONAL {\n"</code> <code class="o">+</code>
<code class="linenos">127 </code>   <code class="s">"       %s &lt;http://dbpedia.org/ontology/populationDensity&gt; ?populationDensity2\n"</code><code class="err">\</code>
<code class="linenos">128 </code> <code class="o">+</code>
<code class="linenos">129 </code>   <code class="s">"  } .\n"</code> <code class="o">+</code>
<code class="linenos">130 </code>   <code class="s">"  OPTIONAL { %s &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label2 . }\n"</code> <code class="o">+</code>
<code class="linenos">131 </code>   <code class="s">"} LIMIT 30"</code><code class="p">;</code>
<code class="linenos">132 </code>
<code class="linenos">133 </code>  <code class="kd">static</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">cityTemplate</code> <code class="o">=</code>
<code class="linenos">134 </code>    <code class="s">"SELECT DISTINCT\n"</code> <code class="o">+</code>
<code class="linenos">135 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?latitude_longitude2; SEPARATOR=' | ') \n"</code> <code class="o">+</code>
<code class="linenos">136 </code>    <code class="s">"              AS ?latitude_longitude) \n"</code> <code class="o">+</code>
<code class="linenos">137 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?populationDensity2; SEPARATOR=' | ')\n"</code> <code class="o">+</code>
<code class="linenos">138 </code>    <code class="s">"              AS ?populationDensity) \n"</code> <code class="o">+</code>
<code class="linenos">139 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?label2; SEPARATOR=' | ') AS ?label) \n"</code> <code class="o">+</code>
<code class="linenos">140 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?comment2; SEPARATOR=' | ') AS ?comment) \n"</code> <code class="o">+</code>
<code class="linenos">141 </code>    <code class="s">"    (GROUP_CONCAT (DISTINCT ?country2; SEPARATOR=' | ') AS ?country) { \n"</code> <code class="o">+</code>
<code class="linenos">142 </code>    <code class="s">" %s &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment2 .\n"</code> <code class="o">+</code>
<code class="linenos">143 </code>    <code class="s">"       FILTER  (lang(?comment2) = 'en') . \n"</code> <code class="o">+</code>
<code class="linenos">144 </code>    <code class="s">" OPTIONAL {\n"</code> <code class="o">+</code>
<code class="linenos">145 </code>    <code class="s">"   %s &lt;http://www.w3.org/2003/01/geo/wgs84_pos#geometry&gt;\n"</code> <code class="o">+</code>
<code class="linenos">146 </code>    <code class="s">"      ?latitude_longitude2\n"</code> <code class="o">+</code>
<code class="linenos">147 </code>    <code class="s">" } . \n"</code> <code class="o">+</code>
<code class="linenos">148 </code>    <code class="s">" OPTIONAL {\n"</code> <code class="o">+</code>
<code class="linenos">149 </code>    <code class="s">"    %s &lt;http://dbpedia.org/ontology/PopulatedPlace/populationDensity&gt;\n"</code> <code class="o">+</code>
<code class="linenos">150 </code>    <code class="s">"      ?populationDensity2\n"</code> <code class="o">+</code>
<code class="linenos">151 </code>    <code class="s">" } . \n"</code> <code class="o">+</code>
<code class="linenos">152 </code>    <code class="s">" OPTIONAL { %s &lt;http://dbpedia.org/ontology/country&gt; ?country2 } . \n"</code> <code class="o">+</code>
<code class="linenos">153 </code>    <code class="s">" OPTIONAL { %s &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label2 . "</code> <code class="o">+</code>
<code class="linenos">154 </code>    <code class="s">"             FILTER  (lang(?label2) = 'en') } \n"</code> <code class="o">+</code>
<code class="linenos">155 </code>    <code class="s">"} LIMIT 30\n"</code><code class="p">;</code>
<code class="linenos">156 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>EntityRelationships</strong> in the next listing is used to find property relationships between two entity URIs. The RDF statement matching <strong>FILTER</strong> on line 15 prevents matching statements where the property contains the string “wiki” to avoid WikiData URI references. This class would need to be rewritten to handle, for example, the WikiData Knowledge Base instead of the DBPedia Knowledge Base. This class uses the <strong>JenaApis</strong> library developed in the chapter <em>Semantic Web</em>. The class <strong>Sparql</strong> that we will look at later wraps the use of the <strong>JenaApis</strong> library.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">com.markwatson.semanticweb.QueryResult</code><code class="p">;</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kn">import</code> <code class="nn">java.sql.SQLException</code><code class="p">;</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">EntityRelationships</code> <code class="p">{</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">results</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code>
<code class="linenos">10 </code>                                    <code class="n">String</code> <code class="n">entity1Uri</code><code class="p">,</code> <code class="n">String</code> <code class="n">entity2Uri</code><code class="p">)</code>
<code class="linenos">11 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos">12 </code>    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code>
<code class="linenos">13 </code>        <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code>
<code class="linenos">14 </code>         <code class="s">"select ?p where { %s ?p %s . "</code>  <code class="o">+</code>
<code class="linenos">15 </code>         <code class="s">"   FILTER (!regex(str(?p), 'wikiPage', 'i')) } limit 10"</code><code class="p">,</code>
<code class="linenos">16 </code>            <code class="n">entity1Uri</code><code class="p">,</code> <code class="n">entity2Uri</code><code class="p">);</code>
<code class="linenos">17 </code>    <code class="k">return</code> <code class="n">endpoint</code><code class="p">.</code><code class="na">query</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos">18 </code>  <code class="p">}</code>
<code class="linenos">19 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>Log</strong> in the next listing defines a shorthand <strong>out</strong> for calling <strong>System.out.println</strong>, an instance of <strong>StringBuilder</strong> for storing all generated SPARQL queries made to DBPedia, and a utility method for clearing the stored SPARQL queries. We use the cache of SPARQL queries to support the interactive command “sparql” in the <strong>KGN</strong> application that we previously saw in an example when we saw the use of this command to display all cached SPARQL queries demonstrating the use of <strong>DISTINCT</strong> and <strong>GROUP_CONCAT</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Log</code> <code class="p">{</code>
<code class="linenos">4 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="kt">void</code> <code class="nf">out</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code> <code class="p">{</code> <code class="n">System</code><code class="p">.</code><code class="na">out</code><code class="p">.</code><code class="na">println</code><code class="p">(</code><code class="n">s</code><code class="p">);</code> <code class="p">}</code>
<code class="linenos">5 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">StringBuilder</code> <code class="n">sparql</code>  <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>
<code class="linenos">6 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="kt">void</code> <code class="nf">clearSparql</code><code class="p">()</code> <code class="p">{</code> <code class="n">sparql</code><code class="p">.</code><code class="na">delete</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">sparql</code><code class="p">.</code><code class="na">length</code><code class="p">());</code> <code class="p">}</code>
<code class="linenos">7 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>PrintEntityResearchResults</strong> in the next listing takes results from multiple DBPedia queries, formats the results, and displays them. The class constructor has no use except for the side effect of displaying results to a user. The constructor requires the arguments:</p>

<ul>
  <li>Sparql endpoint - we will look at the definition of class <strong>Sparql</strong> in the next section.</li>
  <li>List&lt;EntityAndDescription&gt; people - a list of person names and URIs.</li>
  <li>List&lt;EntityAndDescription&gt; companies - a list of company names and URIs.</li>
  <li>List&lt;EntityAndDescription&gt; cities - a list of city names and URIs.</li>
  <li>List&lt;EntityAndDescription&gt; countries - a list of country names and URIs.</li>
</ul>

<p>I define static string values for a few ANSI terminal escape sequences for changing the default color of text written to a terminal. If you are running on Windows you may need to set initialization values for <strong>RESET</strong>, <strong>GREEN</strong>, <strong>YELLOW</strong>, <strong>PURPLE</strong>, and <strong>CYAN</strong> to empty strings “”.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Log.out</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Utils.removeBrackets</code><code class="p">;</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kn">import</code> <code class="nn">java.sql.SQLException</code><code class="p">;</code>
<code class="linenos"> 7 </code><code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">PrintEntityResearchResults</code> <code class="p">{</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code>  <code class="cm">/**</code>
<code class="linenos">12 </code><code class="cm">   * Note for Windows users: the Windows console may not render the following</code>
<code class="linenos">13 </code><code class="cm">   * ANSI terminal escape sequences correctly. If yo have problems, just</code>
<code class="linenos">14 </code><code class="cm">   * change the following to the empty string "":</code>
<code class="linenos">15 </code><code class="cm">   */</code>
<code class="linenos">16 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">RESET</code>  <code class="o">=</code> <code class="s">"\u001B[0m"</code><code class="p">;</code> <code class="c1">// ANSI characters for styling</code>
<code class="linenos">17 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">GREEN</code>  <code class="o">=</code> <code class="s">"\u001B[32m"</code><code class="p">;</code>
<code class="linenos">18 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">YELLOW</code> <code class="o">=</code> <code class="s">"\u001B[33m"</code><code class="p">;</code>
<code class="linenos">19 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">PURPLE</code> <code class="o">=</code> <code class="s">"\u001B[35m"</code><code class="p">;</code>
<code class="linenos">20 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">CYAN</code>   <code class="o">=</code> <code class="s">"\u001B[36m"</code><code class="p">;</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code>  <code class="kd">private</code> <code class="nf">PrintEntityResearchResults</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code>  <code class="kd">public</code> <code class="nf">PrintEntityResearchResults</code><code class="p">(</code><code class="n">Sparql</code> <code class="n">endpoint</code><code class="p">,</code>
<code class="linenos">25 </code>                                    <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">people</code><code class="p">,</code>
<code class="linenos">26 </code>                                    <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">companies</code><code class="p">,</code>
<code class="linenos">27 </code>                                    <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">cities</code><code class="p">,</code>
<code class="linenos">28 </code>                                    <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">countries</code><code class="p">)</code>
<code class="linenos">29 </code>      <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos">30 </code>    <code class="n">out</code><code class="p">(</code><code class="s">"\n"</code> <code class="o">+</code> <code class="n">GREEN</code> <code class="o">+</code> <code class="s">"Individual People:\n"</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">31 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">person</code> <code class="p">:</code> <code class="n">people</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">32 </code>      <code class="n">out</code><code class="p">(</code><code class="s">"  "</code> <code class="o">+</code> <code class="n">GREEN</code> <code class="o">+</code> <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="s">"%-25s"</code><code class="p">,</code> <code class="n">person</code><code class="p">.</code><code class="na">entityName</code><code class="p">)</code> <code class="o">+</code>
<code class="linenos">33 </code>          <code class="n">PURPLE</code> <code class="o">+</code> <code class="s">" : "</code> <code class="o">+</code> <code class="n">removeBrackets</code><code class="p">(</code><code class="n">person</code><code class="p">.</code><code class="na">entityUri</code><code class="p">)</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">34 </code>      <code class="n">out</code><code class="p">(</code><code class="n">EntityDetail</code><code class="p">.</code><code class="na">personAsString</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">person</code><code class="p">.</code><code class="na">entityUri</code><code class="p">));</code>
<code class="linenos">35 </code>    <code class="p">}</code>
<code class="linenos">36 </code>    <code class="n">out</code><code class="p">(</code><code class="s">"\n"</code> <code class="o">+</code> <code class="n">CYAN</code> <code class="o">+</code> <code class="s">"Individual Companies:\n"</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">37 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">company</code> <code class="p">:</code> <code class="n">companies</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">38 </code>      <code class="n">out</code><code class="p">(</code><code class="s">"  "</code> <code class="o">+</code> <code class="n">CYAN</code> <code class="o">+</code> <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="s">"%-25s"</code><code class="p">,</code> <code class="n">company</code><code class="p">.</code><code class="na">entityName</code><code class="p">)</code> <code class="o">+</code>
<code class="linenos">39 </code>          <code class="n">YELLOW</code> <code class="o">+</code> <code class="s">" : "</code> <code class="o">+</code> <code class="n">removeBrackets</code><code class="p">(</code><code class="n">company</code><code class="p">.</code><code class="na">entityUri</code><code class="p">)</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">40 </code>      <code class="n">out</code><code class="p">(</code><code class="n">EntityDetail</code><code class="p">.</code><code class="na">companyAsString</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">company</code><code class="p">.</code><code class="na">entityUri</code><code class="p">));</code>
<code class="linenos">41 </code>    <code class="p">}</code>
<code class="linenos">42 </code>    <code class="n">out</code><code class="p">(</code><code class="s">"\n"</code> <code class="o">+</code> <code class="n">GREEN</code> <code class="o">+</code> <code class="s">"Individual Cities:\n"</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">43 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">city</code> <code class="p">:</code> <code class="n">cities</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">44 </code>      <code class="n">out</code><code class="p">(</code><code class="s">"  "</code> <code class="o">+</code> <code class="n">GREEN</code> <code class="o">+</code> <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="s">"%-25s"</code><code class="p">,</code> <code class="n">city</code><code class="p">.</code><code class="na">entityName</code><code class="p">)</code> <code class="o">+</code>
<code class="linenos">45 </code>          <code class="n">PURPLE</code> <code class="o">+</code> <code class="s">" : "</code> <code class="o">+</code> <code class="n">removeBrackets</code><code class="p">(</code><code class="n">city</code><code class="p">.</code><code class="na">entityUri</code><code class="p">)</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">46 </code>      <code class="n">out</code><code class="p">(</code><code class="n">EntityDetail</code><code class="p">.</code><code class="na">cityAsString</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">city</code><code class="p">.</code><code class="na">entityUri</code><code class="p">));</code>
<code class="linenos">47 </code>    <code class="p">}</code>
<code class="linenos">48 </code>    <code class="n">out</code><code class="p">(</code><code class="s">"\n"</code> <code class="o">+</code> <code class="n">GREEN</code> <code class="o">+</code> <code class="s">"Individual Countries:\n"</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">49 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">country</code> <code class="p">:</code> <code class="n">countries</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">50 </code>      <code class="n">out</code><code class="p">(</code><code class="s">"  "</code> <code class="o">+</code> <code class="n">GREEN</code> <code class="o">+</code> <code class="n">String</code><code class="p">.</code><code class="na">format</code><code class="p">(</code><code class="s">"%-25s"</code><code class="p">,</code> <code class="n">country</code><code class="p">.</code><code class="na">entityName</code><code class="p">)</code> <code class="o">+</code>
<code class="linenos">51 </code>          <code class="n">PURPLE</code> <code class="o">+</code> <code class="s">" : "</code> <code class="o">+</code> <code class="n">removeBrackets</code><code class="p">(</code><code class="n">country</code><code class="p">.</code><code class="na">entityUri</code><code class="p">)</code> <code class="o">+</code> <code class="n">RESET</code><code class="p">);</code>
<code class="linenos">52 </code>      <code class="n">out</code><code class="p">(</code><code class="n">EntityDetail</code><code class="p">.</code><code class="na">countryAsString</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">country</code><code class="p">.</code><code class="na">entityUri</code><code class="p">));</code>
<code class="linenos">53 </code>    <code class="p">}</code>
<code class="linenos">54 </code>    <code class="n">out</code><code class="p">(</code><code class="s">""</code><code class="p">);</code>
<code class="linenos">55 </code>  <code class="p">}</code>
<code class="linenos">56 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>Sparql</strong> in the next listing wraps the <strong>JenaApis</strong> library from the chapter <em>Semantic Web</em>. I set the SPARQL endpoint for DBPedia on line 13. I set and commented out the WikiData SPARQL endpoint on lines 11-12. The KGN application will not work with WikiData without some modifications. If you enjoy experimenting with KGN then you might want to clone it and enable it to work simultaneously with DBPedia, WikiData, and local RDF files by using three instances of the class <strong>JenaApis</strong>.</p>

<p>Notice that we are importing the value of a static StringBuffer <strong>com.knowledgegraphnavigator.Log.sparql</strong> on line 5. We will use this for storing SPARQL queries for display to the user.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kn">import</code> <code class="nn">com.markwatson.semanticweb.QueryResult</code><code class="p">;</code>
<code class="linenos"> 4 </code><code class="kn">import</code> <code class="nn">com.markwatson.semanticweb.JenaApis</code><code class="p">;</code>
<code class="linenos"> 5 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Log.sparql</code><code class="p">;</code>
<code class="linenos"> 6 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Log.out</code><code class="p">;</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="kn">import</code> <code class="nn">java.sql.SQLException</code><code class="p">;</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Sparql</code> <code class="p">{</code>
<code class="linenos">11 </code>  <code class="c1">//static private String endpoint =</code>
<code class="linenos">12 </code>  <code class="c1">//      "https://query.wikidata.org/bigdata/namespace/wdq/sparql";</code>
<code class="linenos">13 </code>  <code class="kd">static</code> <code class="kd">private</code> <code class="n">String</code> <code class="n">endpoint</code> <code class="o">=</code> <code class="s">"https://dbpedia.org/sparql"</code><code class="p">;</code>
<code class="linenos">14 </code>  <code class="kd">public</code> <code class="nf">Sparql</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">15 </code>    <code class="k">this</code><code class="p">.</code><code class="na">jenaApis</code> <code class="o">=</code> <code class="k">new</code> <code class="n">JenaApis</code><code class="p">();</code>
<code class="linenos">16 </code>  <code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code>  <code class="kd">public</code> <code class="n">QueryResult</code> <code class="nf">query</code><code class="p">(</code><code class="n">String</code> <code class="n">sparqlQuery</code><code class="p">)</code>
<code class="linenos">19 </code>         <code class="kd">throws</code> <code class="n">SQLException</code><code class="p">,</code> <code class="n">ClassNotFoundException</code> <code class="p">{</code>
<code class="linenos">20 </code>    <code class="c1">//out(sparqlQuery); // debug for now...</code>
<code class="linenos">21 </code>    <code class="n">sparql</code><code class="p">.</code><code class="na">append</code><code class="p">(</code><code class="n">sparqlQuery</code><code class="p">);</code>
<code class="linenos">22 </code>    <code class="n">sparql</code><code class="p">.</code><code class="na">append</code><code class="p">((</code><code class="s">"\n\n"</code><code class="p">));</code>
<code class="linenos">23 </code>    <code class="k">return</code> <code class="n">jenaApis</code><code class="p">.</code><code class="na">queryRemote</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">sparqlQuery</code><code class="p">);</code>
<code class="linenos">24 </code>  <code class="p">}</code>
<code class="linenos">25 </code>  <code class="kd">private</code> <code class="n">JenaApis</code> <code class="n">jenaApis</code><code class="p">;</code>
<code class="linenos">26 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The class <strong>Utils</strong> contains one utility method <strong>removeBrackets</strong> that is used to convert a URI in SPARQL RDF statement form:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>&lt;http://dbpedia.org/resource/Seattle&gt;
</pre></div>

</figure>

<p>to:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>http://dbpedia.org/resource/Seattle
</pre></div>

</figure>

<p>The single method <strong>removeBrackets</strong> is only used in the class <strong>PrintEntityResearchResults</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Utils</code> <code class="p">{</code>
<code class="linenos">4 </code>  <code class="kd">static</code> <code class="kd">public</code> <code class="n">String</code> <code class="nf">removeBrackets</code><code class="p">(</code><code class="n">String</code> <code class="n">s</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">5 </code>    <code class="k">if</code> <code class="p">(</code><code class="n">s</code><code class="p">.</code><code class="na">startsWith</code><code class="p">(</code><code class="s">"&lt;"</code><code class="p">))</code> <code class="k">return</code> <code class="n">s</code><code class="p">.</code><code class="na">substring</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">s</code><code class="p">.</code><code class="na">length</code><code class="p">()</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>
<code class="linenos">6 </code>    <code class="k">return</code> <code class="n">s</code><code class="p">;</code>
<code class="linenos">7 </code>  <code class="p">}</code>
<code class="linenos">8 </code><code class="p">}</code>
</pre></div>

</figure>

<p>Finally we get to the main program implemented in the class <strong>KGN</strong>. The interactive program is implemented in the class constructor with the heart of the code being the <strong>while</strong> loop in lines 26-119 that accepts text input from the user, detects entity names and the corresponding entity types in the input text, and uses the Java classes we just looked at to find information on DBPedia for the entities in the input text as well as finding relations between these entities. Instead of entering a list of entity names the user can also enter either of the commands <em>sparql</em> (which we saw earlier in an example) or <em>demo</em> (to use a randomly chosen example query).</p>

<p>We use the class <strong>TextToDbpediaUris</strong> on line 38 to get the entity names and types found in the input text. You can refer back to chapter <em>Resolve Entity Names to DBPedia References</em> for details on using the class <strong>TextToDbpediaUris</strong>.</p>

<p>The loops in lines 39-70 store entity details that are displayed by calling <strong>PrintEntityResearchResults</strong> in lines 72-76. The nested loops over person entities in lines 78-91 calls <strong>EntityRelationships.results</strong> to look for relationships between two different person URIs. The same operation is done in the nested loops in lines 93-104 to find relationships between people and companies. The nested loops in lines 105-118 finds relationships between different company entities.</p>

<p>The static method <strong>main</strong> in lines 134-136 simply creates an instance of class <strong>KGN</strong> which has the side effect of running the example KGN program.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="kn">package</code> <code class="nn">com.knowledgegraphnavigator</code><code class="p">;</code>
<code class="linenos">  2 </code>
<code class="linenos">  3 </code><code class="kn">import</code> <code class="nn">com.markwatson.ner_dbpedia.TextToDbpediaUris</code><code class="p">;</code>
<code class="linenos">  4 </code><code class="kn">import</code> <code class="nn">com.markwatson.semanticweb.QueryResult</code><code class="p">;</code>
<code class="linenos">  5 </code>
<code class="linenos">  6 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Log.out</code><code class="p">;</code>
<code class="linenos">  7 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Log.sparql</code><code class="p">;</code>
<code class="linenos">  8 </code><code class="kn">import static</code> <code class="nn">com.knowledgegraphnavigator.Log.clearSparql</code><code class="p">;</code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code><code class="kn">import</code> <code class="nn">java.util.ArrayList</code><code class="p">;</code>
<code class="linenos"> 11 </code><code class="kn">import</code> <code class="nn">java.util.Arrays</code><code class="p">;</code>
<code class="linenos"> 12 </code><code class="kn">import</code> <code class="nn">java.util.List</code><code class="p">;</code>
<code class="linenos"> 13 </code><code class="kn">import</code> <code class="nn">java.util.Scanner</code><code class="p">;</code>
<code class="linenos"> 14 </code>
<code class="linenos"> 15 </code><code class="kd">public</code> <code class="kd">class</code> <code class="nc">KGN</code> <code class="p">{</code>
<code class="linenos"> 16 </code>
<code class="linenos"> 17 </code>  <code class="kd">private</code> <code class="kd">static</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">demosList</code> <code class="o">=</code>
<code class="linenos"> 18 </code>   <code class="n">Arrays</code><code class="p">.</code><code class="na">asList</code><code class="p">(</code>
<code class="linenos"> 19 </code>    <code class="s">"Bill Gates and Melinda Gates worked at Microsoft"</code><code class="p">,</code>
<code class="linenos"> 20 </code>    <code class="s">"IBM opened an office in Canada"</code><code class="p">,</code>
<code class="linenos"> 21 </code>    <code class="s">"Steve Jobs worked at Apple Computer and visited IBM and Microsoft in Seattle"</code><code class="p">);</code>
<code class="linenos"> 22 </code>
<code class="linenos"> 23 </code>  <code class="kd">public</code> <code class="nf">KGN</code><code class="p">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos"> 24 </code>    <code class="n">Sparql</code> <code class="n">endpoint</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Sparql</code><code class="p">();</code>
<code class="linenos"> 25 </code>
<code class="linenos"> 26 </code>    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 27 </code>      <code class="n">String</code> <code class="n">query</code> <code class="o">=</code> <code class="n">getUserQueryFromConsole</code><code class="p">();</code>
<code class="linenos"> 28 </code>      <code class="n">out</code><code class="p">(</code><code class="s">"\nProcessing query:\n"</code> <code class="o">+</code> <code class="n">query</code> <code class="o">+</code> <code class="s">"\n"</code><code class="p">);</code>
<code class="linenos"> 29 </code>      <code class="k">if</code> <code class="p">(</code><code class="n">query</code><code class="p">.</code><code class="na">equalsIgnoreCase</code><code class="p">(</code><code class="s">"sparql"</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos"> 30 </code>        <code class="n">out</code><code class="p">(</code><code class="s">"Generated SPARQL used to get current results:\n"</code><code class="p">);</code>
<code class="linenos"> 31 </code>        <code class="n">out</code><code class="p">(</code><code class="n">sparql</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos"> 32 </code>        <code class="n">out</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
<code class="linenos"> 33 </code>        <code class="n">clearSparql</code><code class="p">();</code>
<code class="linenos"> 34 </code>      <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos"> 35 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">query</code><code class="p">.</code><code class="na">equalsIgnoreCase</code><code class="p">(</code><code class="s">"demo"</code><code class="p">))</code> <code class="p">{</code>
<code class="linenos"> 36 </code>          <code class="n">query</code> <code class="o">=</code> <code class="n">demosList</code><code class="p">.</code><code class="na">get</code><code class="p">((</code><code class="kt">int</code><code class="p">)</code> <code class="p">(</code><code class="n">Math</code><code class="p">.</code><code class="na">random</code><code class="p">()</code> <code class="o">*</code> <code class="p">(</code><code class="n">demosList</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">+</code> <code class="mi">1</code><code class="p">)));</code>
<code class="linenos"> 37 </code>        <code class="p">}</code>
<code class="linenos"> 38 </code>        <code class="n">TextToDbpediaUris</code> <code class="n">kt</code> <code class="o">=</code> <code class="k">new</code> <code class="n">TextToDbpediaUris</code><code class="p">(</code><code class="n">query</code><code class="p">);</code>
<code class="linenos"> 39 </code>        <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">userSelectedPeople</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
<code class="linenos"> 40 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 41 </code>          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">kt</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 42 </code>            <code class="n">userSelectedPeople</code><code class="p">.</code><code class="na">add</code><code class="p">(</code>
<code class="linenos"> 43 </code>                <code class="k">new</code> <code class="n">EntityAndDescription</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">personNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">),</code>
<code class="linenos"> 44 </code>                                     <code class="n">kt</code><code class="p">.</code><code class="na">personUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)));</code>
<code class="linenos"> 45 </code>          <code class="p">}</code>
<code class="linenos"> 46 </code>        <code class="p">}</code>
<code class="linenos"> 47 </code>        <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">userSelectedCompanies</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
<code class="linenos"> 48 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">companyNames</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 49 </code>          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">kt</code><code class="p">.</code><code class="na">companyNames</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 50 </code>            <code class="n">userSelectedCompanies</code><code class="p">.</code><code class="na">add</code><code class="p">(</code>
<code class="linenos"> 51 </code>                <code class="k">new</code> <code class="n">EntityAndDescription</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">companyNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">),</code>
<code class="linenos"> 52 </code>                                     <code class="n">kt</code><code class="p">.</code><code class="na">companyUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)));</code>
<code class="linenos"> 53 </code>          <code class="p">}</code>
<code class="linenos"> 54 </code>        <code class="p">}</code>
<code class="linenos"> 55 </code>        <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">userSelectedCities</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
<code class="linenos"> 56 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">cityNames</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 57 </code>          <code class="n">out</code><code class="p">(</code><code class="s">"+++++ kt.cityNames:"</code> <code class="o">+</code> <code class="n">kt</code><code class="p">.</code><code class="na">cityNames</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos"> 58 </code>          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">kt</code><code class="p">.</code><code class="na">cityNames</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 59 </code>            <code class="n">userSelectedCities</code><code class="p">.</code><code class="na">add</code><code class="p">(</code>
<code class="linenos"> 60 </code>                <code class="k">new</code> <code class="n">EntityAndDescription</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">cityNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">),</code> <code class="n">kt</code><code class="p">.</code><code class="na">cityUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)));</code>
<code class="linenos"> 61 </code>          <code class="p">}</code>
<code class="linenos"> 62 </code>        <code class="p">}</code>
<code class="linenos"> 63 </code>        <code class="n">List</code><code class="o">&lt;</code><code class="n">EntityAndDescription</code><code class="o">&gt;</code> <code class="n">userSelectedCountries</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ArrayList</code><code class="p">();</code>
<code class="linenos"> 64 </code>        <code class="k">if</code> <code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">countryNames</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 65 </code>          <code class="n">out</code><code class="p">(</code><code class="s">"+++++ kt.countryNames:"</code> <code class="o">+</code> <code class="n">kt</code><code class="p">.</code><code class="na">countryNames</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos"> 66 </code>          <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">i</code> <code class="o">&lt;</code> <code class="n">kt</code><code class="p">.</code><code class="na">countryNames</code><code class="p">.</code><code class="na">size</code><code class="p">();</code> <code class="n">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 67 </code>            <code class="n">userSelectedCountries</code><code class="p">.</code><code class="na">add</code><code class="p">(</code>
<code class="linenos"> 68 </code>                <code class="k">new</code> <code class="n">EntityAndDescription</code><code class="p">(</code><code class="n">kt</code><code class="p">.</code><code class="na">countryNames</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">),</code>
<code class="linenos"> 69 </code>                                     <code class="n">kt</code><code class="p">.</code><code class="na">countryUris</code><code class="p">.</code><code class="na">get</code><code class="p">(</code><code class="n">i</code><code class="p">)));</code>
<code class="linenos"> 70 </code>          <code class="p">}</code>
<code class="linenos"> 71 </code>        <code class="p">}</code>
<code class="linenos"> 72 </code>        <code class="k">new</code> <code class="n">PrintEntityResearchResults</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code>
<code class="linenos"> 73 </code>            <code class="n">userSelectedPeople</code><code class="p">,</code>
<code class="linenos"> 74 </code>            <code class="n">userSelectedCompanies</code><code class="p">,</code>
<code class="linenos"> 75 </code>            <code class="n">userSelectedCities</code><code class="p">,</code>
<code class="linenos"> 76 </code>            <code class="n">userSelectedCountries</code><code class="p">);</code>
<code class="linenos"> 77 </code>
<code class="linenos"> 78 </code>        <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">person1</code> <code class="p">:</code> <code class="n">userSelectedPeople</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 79 </code>          <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">person2</code> <code class="p">:</code> <code class="n">userSelectedPeople</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 80 </code>            <code class="k">if</code> <code class="p">(</code><code class="n">person1</code> <code class="o">!=</code> <code class="n">person2</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 81 </code>              <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> 
<code class="linenos"> 82 </code>                <code class="n">EntityRelationships</code><code class="p">.</code><code class="na">results</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">person1</code><code class="p">.</code><code class="na">entityUri</code><code class="p">,</code>
<code class="linenos"> 83 </code>                                            <code class="n">person2</code><code class="p">.</code><code class="na">entityUri</code><code class="p">);</code>
<code class="linenos"> 84 </code>              <code class="k">if</code> <code class="p">(</code><code class="n">qr</code><code class="p">.</code><code class="na">rows</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 85 </code>                <code class="n">out</code><code class="p">(</code><code class="s">"Relationships between person "</code> <code class="o">+</code> <code class="n">person1</code><code class="p">.</code><code class="na">entityName</code> <code class="o">+</code>
<code class="linenos"> 86 </code>                    <code class="s">" person "</code> <code class="o">+</code> <code class="n">person2</code><code class="p">.</code><code class="na">entityName</code> <code class="o">+</code> <code class="s">":"</code><code class="p">);</code>
<code class="linenos"> 87 </code>                <code class="n">out</code><code class="p">(</code><code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos"> 88 </code>              <code class="p">}</code>
<code class="linenos"> 89 </code>            <code class="p">}</code>
<code class="linenos"> 90 </code>          <code class="p">}</code>
<code class="linenos"> 91 </code>        <code class="p">}</code>
<code class="linenos"> 92 </code>
<code class="linenos"> 93 </code>        <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">person</code> <code class="p">:</code> <code class="n">userSelectedPeople</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 94 </code>          <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">company</code> <code class="p">:</code> <code class="n">userSelectedCompanies</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 95 </code>            <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> 
<code class="linenos"> 96 </code>              <code class="n">EntityRelationships</code><code class="p">.</code><code class="na">results</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">person</code><code class="p">.</code><code class="na">entityUri</code><code class="p">,</code>
<code class="linenos"> 97 </code>                                          <code class="n">company</code><code class="p">.</code><code class="na">entityUri</code><code class="p">);</code>
<code class="linenos"> 98 </code>            <code class="k">if</code> <code class="p">(</code><code class="n">qr</code><code class="p">.</code><code class="na">rows</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 99 </code>              <code class="n">out</code><code class="p">(</code><code class="s">"Relationships between person "</code> <code class="o">+</code> <code class="n">person</code><code class="p">.</code><code class="na">entityName</code> <code class="o">+</code>
<code class="linenos">100 </code>                  <code class="s">" company "</code> <code class="o">+</code> <code class="n">company</code><code class="p">.</code><code class="na">entityName</code> <code class="o">+</code> <code class="s">":"</code><code class="p">);</code>
<code class="linenos">101 </code>              <code class="n">out</code><code class="p">(</code><code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos">102 </code>            <code class="p">}</code>
<code class="linenos">103 </code>          <code class="p">}</code>
<code class="linenos">104 </code>        <code class="p">}</code>
<code class="linenos">105 </code>        <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">company1</code> <code class="p">:</code> <code class="n">userSelectedCompanies</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">106 </code>          <code class="k">for</code> <code class="p">(</code><code class="n">EntityAndDescription</code> <code class="n">company2</code> <code class="p">:</code> <code class="n">userSelectedCompanies</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">107 </code>            <code class="k">if</code> <code class="p">(</code><code class="n">company1</code> <code class="o">!=</code> <code class="n">company2</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">108 </code>              <code class="n">QueryResult</code> <code class="n">qr</code> <code class="o">=</code> 
<code class="linenos">109 </code>                <code class="n">EntityRelationships</code><code class="p">.</code><code class="na">results</code><code class="p">(</code><code class="n">endpoint</code><code class="p">,</code> <code class="n">company1</code><code class="p">.</code><code class="na">entityUri</code><code class="p">,</code> 
<code class="linenos">110 </code>                                            <code class="n">company2</code><code class="p">.</code><code class="na">entityUri</code><code class="p">);</code>
<code class="linenos">111 </code>              <code class="k">if</code> <code class="p">(</code><code class="n">qr</code><code class="p">.</code><code class="na">rows</code><code class="p">.</code><code class="na">size</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">112 </code>                <code class="n">out</code><code class="p">(</code><code class="s">"Relationships between company "</code> <code class="o">+</code> <code class="n">company1</code><code class="p">.</code><code class="na">entityName</code> <code class="o">+</code>
<code class="linenos">113 </code>                    <code class="s">" company "</code> <code class="o">+</code> <code class="n">company2</code><code class="p">.</code><code class="na">entityName</code> <code class="o">+</code> <code class="s">":"</code><code class="p">);</code>
<code class="linenos">114 </code>                <code class="n">out</code><code class="p">(</code><code class="n">qr</code><code class="p">.</code><code class="na">toString</code><code class="p">());</code>
<code class="linenos">115 </code>              <code class="p">}</code>
<code class="linenos">116 </code>            <code class="p">}</code>
<code class="linenos">117 </code>          <code class="p">}</code>
<code class="linenos">118 </code>        <code class="p">}</code>
<code class="linenos">119 </code>      <code class="p">}</code>
<code class="linenos">120 </code>    <code class="p">}</code>
<code class="linenos">121 </code>  <code class="p">}</code>
<code class="linenos">122 </code>
<code class="linenos">123 </code>  <code class="kd">private</code> <code class="n">String</code> <code class="nf">getUserQueryFromConsole</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">124 </code>    <code class="n">out</code><code class="p">(</code><code class="s">"Enter entities query:"</code><code class="p">);</code>
<code class="linenos">125 </code>    <code class="n">Scanner</code> <code class="n">input</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Scanner</code><code class="p">(</code><code class="n">System</code><code class="p">.</code><code class="na">in</code><code class="p">);</code>
<code class="linenos">126 </code>    <code class="n">String</code> <code class="n">ret</code> <code class="o">=</code> <code class="s">""</code><code class="p">;</code>
<code class="linenos">127 </code>    <code class="k">while</code> <code class="p">(</code><code class="n">input</code><code class="p">.</code><code class="na">hasNext</code><code class="p">())</code> <code class="p">{</code>
<code class="linenos">128 </code>      <code class="n">ret</code> <code class="o">=</code> <code class="n">input</code><code class="p">.</code><code class="na">nextLine</code><code class="p">();</code>
<code class="linenos">129 </code>      <code class="k">break</code><code class="p">;</code>
<code class="linenos">130 </code>    <code class="p">}</code>
<code class="linenos">131 </code>    <code class="k">return</code> <code class="n">ret</code><code class="p">;</code>
<code class="linenos">132 </code>  <code class="p">}</code>
<code class="linenos">133 </code>
<code class="linenos">134 </code>  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">main</code><code class="p">(</code><code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="p">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="p">{</code>
<code class="linenos">135 </code>    <code class="k">new</code> <code class="n">KGN</code><code class="p">();</code>
<code class="linenos">136 </code>  <code class="p">}</code>
<code class="linenos">137 </code><code class="p">}</code>
</pre></div>

</figure>

<p>This KGN example was hopefully both interesting to you and simple enough in its implementation (because we relied heavily on code from the last two chapters) that you feel comfortable modifying it and reusing it as a part of your own Java applications.</p>

<h3 id="leanpub-auto-wrap-up">Wrap-up</h3>

<p>If you enjoyed running and experimenting with this example and want to modify it for your own projects then I hope that I provided a sufficient road map for you to do so.</p>

<p>I suggest further projects that you might want to try implementing with this example:</p>

<ul>
  <li>Write a web application that processes news stories and annotates them with additional data from DBPedia and/or WikiData.</li>
  <li>In a web or desktop application, detect entities in text and display additional information when the user’s mouse cursor hovers over a word or phrase that is identified as an entity found in DBPedia or WikiData.</li>
  <li>Clone this KGN example and enable it to work simultaneously with DBPedia, WikiData, and local RDF files by using three instances of the class <strong>JenaApis</strong> and in the main application loop access all three data sources.</li>
</ul>

<p>I had the idea for the KGN application because I was spending quite a bit of time manually setting up SPARQL queries for DBPedia (and other public sources like WikiData) and I wanted to experiment with partially automating this process. I have experimented with versions of KGN written in Java, Hy language (<a href="https://leanpub.com/hy-lisp-python/read">Lisp running on Python that I wrote a short book on</a>), Swift, and Common Lisp and all four implementations take different approaches as I experimented with different ideas. You might want to check out my <a href="http://www.knowledgegraphnavigator.com/">web site devoted to different versions of KGN: www.knowledgegraphnavigator.com</a>.</p>


<h2 id="leanpub-auto-conclusions">Conclusions</h2>

<p>The material in this book was informed by my own work experience
designing systems and writing software for artificial intelligence and information processing. If
you enjoyed reading this book and you make practical use of at least some of
the material I covered, then I consider my effort to be worthwhile.</p>

<p>Writing software is a combination of a business activity, promoting good
for society, and an exploration to try out new ideas for self
improvement. I believe that there is sometimes a fine line between
spending too many resources tracking many new technologies versus
getting stuck using old technologies at the expense of lost
opportunities. My hope is that reading this book was an efficient and
pleasurable use of your time, letting you try some new techniques and
technologies that you had not considered before.</p>

<p>When we do expend resources to try new things it is almost always best
to perform many small experiments and then dig deeper into areas that
have a good chance of providing high value and capturing your interest.</p>

<p>Fail fast is a common meme but failure that we do not learn from is a
waste.</p>

<p>I have been using the Java platform from the very beginning and although
I also use many other programming languages in my work and studies, both
the Java language and the Java platform provide high efficiency, scalability,
many well-trained developers, and a wealth of existing infrastructure
software and libraries. Investment in Java development also pays when
using alternative JVM languages like JRuby, Scala, and Clojure.</p>

<p>If we never get to meet in person or talk on the telephone, then I would
like to thank you now for taking the time to read my book.</p>

</div>
</body>
</html>
