<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Artificial Intelligence Using Swift</title>
  <link href="stylesheet.css" rel="stylesheet" />
</head>
<body dir="" class="lfm">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-cover-material-copyright-and-license'>Cover Material, Copyright, and License</a>
    <ul>
      <li>
        <a href='#leanpub-auto-this-book-is-licensed-with-creative-commons-attribution-cc-by-version-3-that-allows-reuse-in-derived-works'>This Book is Licensed with Creative Commons Attribution CC BY Version 3 That Allows Reuse In Derived Works</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-parts-of-this-book-are-specific-for-macos-and-ios-with-some-support-for-linux'>Parts of this Book are Specific for macOS and iOS, with Some Support for Linux</a>
      </li>
      <li>
        <a href='#leanpub-auto-code-for-this-book'>Code for this Book</a>
      </li>
      <li>
        <a href='#leanpub-auto-authors-background'>Author’s Background</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-request-from-the-author'>A Request from the Author</a>
      </li>
      <li>
        <a href='#leanpub-auto-cover-art'>Cover Art</a>
      </li>
      <li>
        <a href='#leanpub-auto-coreml-libraries-used-in-this-book'>CoreML Libraries Used in this Book</a>
      </li>
      <li>
        <a href='#leanpub-auto-swift-3rd-party-libraries'>Swift 3rd Party Libraries</a>
      </li>
      <li>
        <a href='#leanpub-auto-acknowledgements'>Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-part-1-introduction-and-short-examples'>Part 1: Introduction and Short Examples</a>
  </li>
  <li>
    <a href='#leanpub-auto-setting-up-swift-for-command-line-development'>Setting Up Swift for Command Line Development</a>
    <ul>
      <li>
        <a href='#leanpub-auto-installing-swift-packages'>Installing Swift Packages</a>
      </li>
      <li>
        <a href='#leanpub-auto-creating-swift-packages'>Creating Swift Packages</a>
      </li>
      <li>
        <a href='#leanpub-auto-accessing-libraries-that-you-write-in-other-projects'>Accessing Libraries that You Write in Other Projects</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-background-information-for-writing-swift-command-line-utilities'>Background Information for Writing Swift Command Line Utilities</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-shell-processes'>Using Shell Processes</a>
      </li>
      <li>
        <a href='#leanpub-auto-fileio-examples'>FileIO Examples</a>
      </li>
      <li>
        <a href='#leanpub-auto-swift-repl'>Swift REPL</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-web-scraping'>Web Scraping</a>
    <ul>
      <li>
        <a href='#leanpub-auto-running-in-the-swift-repl'>Running in the Swift REPL</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-part-2-apples-coreml-and-nlp-libraries'>Part 2: Apple’s CoreML and NLP Libraries</a>
  </li>
  <li>
    <a href='#leanpub-auto-deep-learning-introduction'>Deep Learning Introduction</a>
    <ul>
      <li>
        <a href='#leanpub-auto-simple-multi-layer-perceptron-neural-networks'>Simple Multi-layer Perceptron Neural Networks</a>
      </li>
      <li>
        <a href='#leanpub-auto-deep-learning'>Deep Learning</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-apples-core-ml-machine-learning-and-deep-learning-libraries'>Using Apple’s Core ML Machine Learning and Deep Learning Libraries</a>
    <ul>
      <li>
        <a href='#leanpub-auto-training-a-classification-model-for-the-university-of-wisconsin-cancer-data'>Training a Classification Model For the University of Wisconsin Cancer Data</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-classification-model-for-the-university-of-wisconsin-cancer-data'>Using the Classification Model for the University of Wisconsin Cancer Data</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-natural-language-processing-using-apples-natural-language-framework'>Natural Language Processing Using Apple’s Natural Language Framework</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-apples-naturallanguage-swift-library'>Using Apple’s <strong>NaturalLanguage</strong> Swift Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-simple-wrapper-library-for-apples-nlp-models'>A simple Wrapper Library for Apple’s NLP Models</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-openai-apis'>Using the OpenAI APIs</a>
  </li>
  <li>
    <a href='#leanpub-auto-part-3-knowledge-representation-and-data-acquisition'>Part 3: Knowledge Representation and Data Acquisition</a>
  </li>
  <li>
    <a href='#leanpub-auto-linked-data-and-the-semantic-web'>Linked Data and the Semantic Web</a>
    <ul>
      <li>
        <a href='#leanpub-auto-understanding-the-resource-description-framework-rdf'>Understanding the Resource Description Framework (RDF)</a>
      </li>
      <li>
        <a href='#leanpub-auto-frequently-used-resource-namespaces'>Frequently Used Resource Namespaces</a>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-the-sparql-query-language'>Understanding the SPARQL Query Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-semantic-web-and-linked-data-wrap-up'>Semantic Web and Linked Data Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-example-application-ios-and-macos-versions-of-my-knowledgebooknavigator'>Example Application: iOS and macOS Versions of my KnowledgeBookNavigator</a>
    <ul>
      <li>
        <a href='#leanpub-auto-screen-shots-of-macos-application'>Screen Shots of macOS Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-application-code-listings'>Application Code Listings</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-book-wrap-up'>Book Wrap Up</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="lfm">
<h2 id="leanpub-auto-cover-material-copyright-and-license">Cover Material, Copyright, and License</h2>

<p>Copyright 2022 Mark Watson. All rights reserved.</p>

<h3 id="leanpub-auto-this-book-is-licensed-with-creative-commons-attribution-cc-by-version-3-that-allows-reuse-in-derived-works">This Book is Licensed with Creative Commons Attribution CC BY Version 3 That Allows Reuse In Derived Works</h3>

<p>You are free to:</p>

<ul>
  <li>Share — copy and redistribute the material in any medium or format</li>
  <li>Adapt — remix, transform, and build upon the material
for any purpose, even commercially.</li>
</ul>

<p>You are required to give appropriate credit in any derived works:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>This work is derived from all or part of "Artificial Intelligence Using Swift" by
<code class="linenos">2 </code>Mark Watson. Source: https://leanpub.com/lovinglisp
</pre></div>

</figure>

<p>This eBook will be updated occasionally so please periodically check the <a href="https://leanpub.com/SwiftAI">leanpub.com web page for this book</a> for updates.</p>

<p>This is the first edition released spring of 2022.</p>

<p>Please visit the <a href="http://markwatson.com">author’s website</a>.</p>

<p>If you found a copy of this book on the web and find it of value then please consider buying a copy at <a href="https://leanpub.com/SwiftAI">leanpub.com/SwiftAI</a> to support the author and fund work for future updates.  You can also see all of my books on <a href="https://markwatson.com/#books">my website https://markwatson.com/#books</a>.</p>

<h2 id="leanpub-auto-preface">Preface</h2>

<p>Why use Swift for hacking AI? Common Lisp has been my go-to language for artificial intelligence development and research since 1982. The transition to using Swift was a slow transition for me. During this transition I prototyped a new project in parallel using both Swift and Common Lisp, weighing the advantages of both for my current requirements. The Swift version of this project included in this book runs on macOS, iOS, and iPadOS. The macOS version is available on the Apple Store. Several of the utilities developed in this book were used in this project.</p>

<p>This book starts out slowly with simple examples which I wrote showing how to access the Swift library packages on GitHub, tips on writing Swift command line apps, and web scraping. We then proceed to using Apple’s CoreML for Natural Language Processing (NLP), training and using your own CoreML models, using OpenAI’s GPT-3 APIs, and finally several semantic web/linked data examples. The book ends with the example <a href="https://apps.apple.com/us/app/kgn/id1514197947?mt=12">KGN on the App Store</a>. It is not my intention to cover in detail the use of SwiftUI for building iOS/iPadOS/macOS applications but I thought my readers might enjoy seeing several of the techniques covered in the book integrated into an example app.</p>

<p>I have used Common Lisp for AI research projects and for AI product development and delivery since 1982. There is something special about using a language for almost forty years. All that said, I find Swift a compelling choice now for several reasons:</p>

<ul>
  <li>Flexible language with many features I rely on like supporting closures and an interactive functional programming style.</li>
  <li>Built in support for deep learning neural network models for natural language processing, predictive models, etc.</li>
  <li>First class support for iOS and macOS development.</li>
  <li>Good support for server side applications hosted on Linux.</li>
</ul>

<p>Swift is a programmer-efficient language: code is concise and easy to read, and high quality libraries from Apple and third parties mean that often there is less code to write. I will share with you my Swift development work flow that combines interactive development of code in playgrounds, development of higher level libraries in text only or command line applications, and my general strategy for writing iOS and macOS applications after low level and intermediate code is written and debugged.</p>

<h3 id="leanpub-auto-parts-of-this-book-are-specific-for-macos-and-ios-with-some-support-for-linux">Parts of this Book are Specific for macOS and iOS, with Some Support for Linux</h3>

<p>Swift is a general purpose language that is well supported in macOS, iOS, and Linux, with some support in Windows. Here, we cover the use of Swift on macOS and iOS. Some of the examples in this book rely on libraries that are specifically available on macOS and iOS like CoreML and the NLP libraries. Several book examples also work on Linux, such as the examples using SQLite, the Microsoft Azure search APIs, web scraping, and semantic web/linked data.</p>

<h3 id="leanpub-auto-code-for-this-book">Code for this Book</h3>

<p>Because of the way the Swift Package Manager works, I organized all book examples that build libraries as separate GitHub repos so the libraries can be easily used in other book examples as well as your own software projects. The separate library GitHub repositories are:</p>

<ul>
  <li>
<a href="https://github.com/mark-watson/SparqlQuery_swift">https://github.com/mark-watson/SparqlQuery_swift</a> - SPARQL Swift library for my Swift AI book.</li>
  <li>
<a href="https://github.com/mark-watson/QuestionAnswering_BERT_swift">https://github.com/mark-watson/QuestionAnswering_BERT_swift</a> - modification of Apple’s question answering demo to use DBPedia.</li>
  <li>
<a href="https://github.com/mark-watson/swift-coreml-wisconsin_data_create_model">https://github.com/mark-watson/swift-coreml-wisconsin_data_create_model</a> - create CoreML models from training data files of Wisconsin Caner data.</li>
  <li>
<a href="https://github.com/mark-watson/swift-coreml-wisconsin_data_predict_with_model">https://github.com/mark-watson/swift-coreml-wisconsin_data_predict_with_model</a> - use the pretrained Wisconsin Cancer data model.</li>
  <li>
<a href="https://github.com/mark-watson/ShellProcess_swift">https://github.com/mark-watson/ShellProcess_swift</a> - library for spawning shell processes and capturing output to stdout.</li>
  <li>
<a href="https://github.com/mark-watson/WebScraping_swift">https://github.com/mark-watson/WebScraping_swift</a> - library for scrapping web sites.</li>
  <li>
<a href="https://github.com/mark-watson/OpenAI_swift">https://github.com/mark-watson/OpenAI_swift</a> - library for using OpenAI’s GPT3 APIs.</li>
  <li>
<a href="https://github.com/mark-watson/Nlp_swift">https://github.com/mark-watson/Nlp_swift</a> - library that uses pretrained CoreML NLP models.</li>
  <li>
<a href="https://github.com/mark-watson/KGN">https://github.com/mark-watson/KGN</a> - SwiftUI based application supporting macOS, iPadOS, and iOS. The macOS version is in Apple’s app store.</li>
</ul>

<p>I suggest cloning all of these GitHub repositories right now so you can have the example source code at hand while reading this book.</p>

<p>All of the code examples are licensed using the Apache 2 license. You are free to reuse the book example code in your own projects (open source, commercial), with attribution of my copyright and the Apache 2 license.</p>

<p>Except for the last SwiftUI example application, all sample programs are written as command line utilities. I considered using Swift playgrounds for some of the examples but decided that packaging as a combination of libraries and command line utilities would tend to make the example code more useful for your own projects.</p>

<p>http://www.knowledgegraphnavigator.com/</p>

<h3 id="leanpub-auto-authors-background">Author’s Background</h3>

<p>I live in Sedona, Arizona with my wife and pet parrot. Our children and grandchildren live in California, Rhode Island, and the state of Washington.</p>

<p>I have written 20+ books, mostly about artificial intelligence. I have over 50 US patents.</p>

<p>I write about technologies that I have used throughout my career: knowledge representation using semantic web and linked data, machine learning and deep learning, and natural language processing. I am grateful for the companies where I have worked (SAIC, Google, Capital One, Olive AI, Babylist, etc.) that have supported this work since 1982.</p>

<p>As an author, I hope that the material in this book entertains you and will be useful in your work.</p>

<h3 id="leanpub-auto-a-request-from-the-author">A Request from the Author</h3>

<p>I spent time writing this book to help you, dear reader. I release this book under the Creative Commons license and set the minimum purchase price to <strong>Free</strong> in order to reach the most readers. If you found this book on the web (or it was given to you) and if it provides value to you then please consider doing the following to support my future writing efforts and also to support future updates to this book:</p>

<ul>
  <li>Purchase a copy of <a href="https://leanpub.com/SwiftAI">this book</a> or any other of my leanpub books at <a href="https://leanpub.com/u/markwatson">https://leanpub.com/u/markwatson</a>
</li>
</ul>

<p>I enjoy writing and your support helps me write new editions and updates for my books and to develop new book projects. Thank you!</p>

<h3 id="leanpub-auto-cover-art">Cover Art</h3>

<p>The cover picture was taken by <a href="https://commons.wikimedia.org/wiki/User:Keta">WikiMedia Commons user Keta</a> and is available for use under the Creative Commons License CC BY-SA 2.5.</p>

<h3 id="leanpub-auto-coreml-libraries-used-in-this-book">CoreML Libraries Used in this Book</h3>

<ul>
  <li>CoreML general overview: https://developer.apple.com/documentation/coreml</li>
  <li>MLClassifier https://developer.apple.com/documentation/createml/mlclassifier</li>
  <li>MLTextClassifier https://developer.apple.com/documentation/createml/mltextclassifier</li>
  <li>NLModel https://developer.apple.com/documentation/naturallanguage/nlmodel</li>
  <li>Natural Language Framework https://developer.apple.com/documentation/naturallanguage</li>
  <li>MLCustomLayer https://developer.apple.com/documentation/coreml/mlcustomlayer</li>
</ul>

<h3 id="leanpub-auto-swift-3rd-party-libraries">Swift 3rd Party Libraries</h3>

<p>We use the following 3rd party libraries:</p>

<ul>
  <li><a href="https://github.com/SwiftyJSON/SwiftyJSON">https://github.com/SwiftyJSON/SwiftyJSON</a></li>
</ul>

<h3 id="leanpub-auto-acknowledgements">Acknowledgements</h3>

<p>I thank my wife Carol for editing this manuscript, finding typos, and suggesting improvements.</p>


<h2 id="leanpub-auto-part-1-introduction-and-short-examples">Part 1: Introduction and Short Examples</h2>

<p>We begin with a sufficient introduction for Swift to understand the programming examples. After introducing the language we will look at a few short examples that provide code and techniques we use later in the book:</p>

<ul>
  <li>Creating Swift projects </li>
  <li>Writing command line utilities</li>
  <li>Web scraping</li>
</ul>


<h2 id="leanpub-auto-setting-up-swift-for-command-line-development">Setting Up Swift for Command Line Development</h2>

<p>Except for the last chapter in this book that uses Xcode for developing a complete macOS/iOS/iPadOS example application, I assume that you will work through the book examples using the command line and your favorite editor. If you want to use Xcode for the command line examples, you can open the Swift package file on the command line and open Xcode using, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>cd SparqlQuery_swift
open Package.swift
</pre></div>

</figure>

<p>You notice that most of the examples are command line apps or libraries with command line test programs and the <strong>README.md</strong> files in the example directories provide instructions for building and running on the command line.</p>

<p>You can also run Xcode and from the File Menu open an example  <strong>Package.swift</strong> file. You can then use the Product / Test menu to run the test code for the example. You might need to use the View / Debug Area / Active Console menu to show the output area.</p>

<p>I assume that you are familiar with the Swift programming language and Xcode.</p>

<p>Swift is a general purpose language that is well supported in macOS and iOS, with good support for Linux, and with some support in Windows. For the purposes of this book, we are only considering the use of Swift on macOS and iOS. Most of the examples in this book rely on libraries that are specifically available on macOS and iOS like CoreML and the NLP libraries.</p>

<p>There are great free resources for the Swift language on the web, in other commercial books, and Apple’s free Swift books. Here I provide just enough material on the Swift language for you to understand and work with the book examples. After working through this book’s material you will be able to add machine learning, natural language processing, and knowledge representation to your applications. There will be parts of the Swift language that we don’t need for the material here, and we won’t cover.</p>

<h3 id="leanpub-auto-installing-swift-packages">Installing Swift Packages</h3>

<p>We will use the <a href="https://swift.org/package-manager/">Swift Package Manager</a>. You should pause reading now and install the Swift Package Manager if you have not already done so.</p>

<p>I occasionally use <a href="https://vapor.codes">https://vapor.codes web framework</a> library (although not in this book). We use this 3rd party library as an example for building a library locally from source code. Start by cloning the git repository <a href="https://github.com/vapor/vapor">https://github.com/vapor/vapor</a>. Then:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>git clone https://github.com/vapor/vapor.git
cd vapor
swift build
</pre></div>

</figure>

<p>I don’t usually install libraries locally from source code unless I am curious about the implementation and want to read through the source code. Later we will see how to reference Swift libraries hosted on GitHub in a project’s <strong>Package.swift</strong> file.</p>

<h3 id="leanpub-auto-creating-swift-packages">Creating Swift Packages</h3>

<p>We will cover using the Swift Package Manager to create new packages using the command line here. Later we will create projects using Apple’s XCode IDE when we develop the example application Knowledge Graph Navigator.</p>

<p>You will want to use the <a href="https://github.com/apple/swift-package-manager/blob/main/Documentation/Usage.md">Swift Package Manager documentation</a> for reference.</p>

<p>We will be generating executable projects and library (with a sample main program) projects. The commands for generating the stub for an executable application project are:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>mkdir BingSearch
cd BingSearch
swift package init --type executable
</pre></div>

</figure>

<p>and build the stub of a library with a demo main program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>mkdir SparqlQuery
cd SparqlQuery
swift package init --type library
</pre></div>

</figure>

<h3 id="leanpub-auto-accessing-libraries-that-you-write-in-other-projects">Accessing Libraries that You Write in Other Projects</h3>

<p>You can reference Swift libraries using the <strong>Swift.package</strong> file for each of your projects. We will look at parts of two <strong>Swift.package</strong> files here. The first is for my SPARQL query client library that we will develop in a later chapter. This library <strong>SparqlQuery_swift</strong> is used in both book examples Knowledge Graph Navigator (<strong>KGN</strong>) macOS/iOS/iPadOS example application as well as a text version <strong>KnowledgeGraphNavigator_swift</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">PackageDescription</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kd">let</code> <code class="nv">package</code> <code class="p">=</code> <code class="n">Package</code><code class="p">(</code>
<code class="linenos"> 4 </code>    <code class="n">name</code><code class="p">:</code> <code class="s">"SparqlQuery_swift"</code><code class="p">,</code>
<code class="linenos"> 5 </code>    <code class="n">products</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos"> 6 </code>        <code class="p">.</code><code class="n">library</code><code class="p">(</code>
<code class="linenos"> 7 </code>            <code class="n">name</code><code class="p">:</code> <code class="s">"SparqlQuery_swift"</code><code class="p">,</code>
<code class="linenos"> 8 </code>            <code class="n">targets</code><code class="p">:</code> <code class="p">[</code><code class="s">"SparqlQuery_swift"</code><code class="p">]),</code>
<code class="linenos"> 9 </code>    <code class="p">],</code>
<code class="linenos">10 </code>    <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos">11 </code>      <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"https://github.com/SwiftyJSON/SwiftyJSON.git"</code><code class="p">,</code>
<code class="linenos">12 </code>          <code class="p">.</code><code class="n">branch</code><code class="p">(</code><code class="s">"master"</code><code class="p">)),</code>
<code class="linenos">13 </code>   <code class="p">],</code>
<code class="linenos">14 </code>    <code class="n">targets</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos">15 </code>        <code class="p">.</code><code class="n">target</code><code class="p">(</code>
<code class="linenos">16 </code>            <code class="n">name</code><code class="p">:</code> <code class="s">"SparqlQuery_swift"</code><code class="p">,</code>
<code class="linenos">17 </code>            <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code><code class="s">"SwiftyJSON"</code><code class="p">]),</code>
<code class="linenos">18 </code>        <code class="p">.</code><code class="n">testTarget</code><code class="p">(</code>
<code class="linenos">19 </code>            <code class="n">name</code><code class="p">:</code> <code class="s">"SparqlQuery_swiftTests"</code><code class="p">,</code>
<code class="linenos">20 </code>            <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code><code class="s">"SparqlQuery_swift"</code><code class="p">,</code> <code class="s">"SwiftyJSON"</code><code class="p">]),</code>
<code class="linenos">21 </code>    <code class="p">]</code>
<code class="linenos">22 </code><code class="p">)</code>
</pre></div>

</figure>

<p>The <strong>Swift.package</strong> file for text version <strong>KnowledgeGraphNavigator_swift</strong> is shown here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">PackageDescription</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kd">let</code> <code class="nv">package</code> <code class="p">=</code> <code class="n">Package</code><code class="p">(</code>
<code class="linenos"> 4 </code>    <code class="n">name</code><code class="p">:</code> <code class="s">"KnowledgeGraphNavigator_swift"</code><code class="p">,</code>
<code class="linenos"> 5 </code>    <code class="n">platforms</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos"> 6 </code>        <code class="p">.</code><code class="n">macOS</code><code class="p">(.</code><code class="n">v10_15</code><code class="p">),</code>
<code class="linenos"> 7 </code>    <code class="p">],</code>
<code class="linenos"> 8 </code>    <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos"> 9 </code>        <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"https://github.com/SwiftyJSON/SwiftyJSON.git"</code><code class="p">,</code>
<code class="linenos">10 </code>            <code class="p">.</code><code class="n">branch</code><code class="p">(</code><code class="s">"master"</code><code class="p">)),</code>
<code class="linenos">11 </code>        <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"https://github.com/scinfu/SwiftSoup.git"</code><code class="p">,</code> <code class="n">from</code><code class="p">:</code> <code class="s">"1.7.4"</code><code class="p">),</code>
<code class="linenos">12 </code>        <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"git@github.com:mark-watson/SparqlQuery_swift.git"</code><code class="p">,</code>
<code class="linenos">13 </code>            <code class="p">.</code><code class="n">branch</code><code class="p">(</code><code class="s">"main"</code><code class="p">)),</code>
<code class="linenos">14 </code>        <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"git@github.com:mark-watson/Nlp_swift.git"</code><code class="p">,</code> <code class="p">.</code><code class="n">branch</code><code class="p">(</code><code class="s">"main"</code><code class="p">)),</code>
<code class="linenos">15 </code>    <code class="p">],</code>
<code class="linenos">16 </code>    <code class="n">targets</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos">17 </code>        <code class="c1">// Targets are the basic building blocks of a package.</code>
<code class="linenos">18 </code>        <code class="c1">// A target can define a module or a test suite.</code>
<code class="linenos">19 </code>        <code class="c1">// Targets can depend on other targets in this package,</code>
<code class="linenos">20 </code>        <code class="c1">// and on products in packages this package depends on.</code>
<code class="linenos">21 </code>        <code class="p">.</code><code class="n">target</code><code class="p">(</code>
<code class="linenos">22 </code>            <code class="n">name</code><code class="p">:</code> <code class="s">"KnowledgeGraphNavigator_swift"</code><code class="p">,</code>
<code class="linenos">23 </code>            <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code><code class="s">"SparqlQuery_swift"</code><code class="p">,</code> <code class="s">"Nlp_swift"</code><code class="p">,</code>
<code class="linenos">24 </code>              <code class="s">"SwiftyJSON"</code><code class="p">,</code> <code class="s">"SwiftSoup"</code><code class="p">]),</code>
<code class="linenos">25 </code>    <code class="p">]</code>
<code class="linenos">26 </code><code class="p">)</code>
</pre></div>

</figure>

<p>Hopefully you have cloned the git repositories for each book example and understand how I have configured the examples for your use.</p>

<p>For the rest of this book, you can read chapters in any order. In some cases, earlier chapters will contain implementations of libraries used in later chapters.</p>


<h2 id="leanpub-auto-background-information-for-writing-swift-command-line-utilities">Background Information for Writing Swift Command Line Utilities</h2>

<p>This short chapter contains example code and utilities for writing command line programs, using external shell processes, and using the FileIO library.</p>

<h3 id="leanpub-auto-using-shell-processes">Using Shell Processes</h3>

<p>The library for using shell processes is one of my GitHub projects so you can include it in other projects using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code> <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos">2 </code>   <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"git@github.com:mark-watson/ShellProcess_swift.git"</code><code class="p">,</code>
<code class="linenos">3 </code>            <code class="p">.</code><code class="n">branch</code><code class="p">(</code><code class="s">"main"</code><code class="p">)),</code>
<code class="linenos">4 </code> <code class="p">],</code>
</pre></div>

</figure>

<p>You can clone this repository if you want to have the source code at hand:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>git clone https://github.com/mark-watson/ShellProcess_swift.git
</pre></div>

</figure>

<p>The following listing shows the library implementation. In line 5 we use the constructor <strong>Process</strong> from the Apple <strong>Foundation</strong> library to get a new process object that we set fields <strong>executableURL</strong> and <strong>argList</strong>. In lines 8 and 9 we create a new Unix style pipe to capture the output from the shell process we are starting and attach it to the process. After we run the task, we capture the output and return it as the value of function <strong>run_in_shell</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">@</code><code class="n">available</code><code class="p">(</code><code class="n">OSX</code> <code class="mf">10.13</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">run_in_shell</code><code class="p">(</code><code class="n">commandPath</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">argList</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[])</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 5 </code>    <code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="nb">Process</code><code class="p">()</code>
<code class="linenos"> 6 </code>    <code class="n">task</code><code class="p">.</code><code class="n">executableURL</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">fileURLWithPath</code><code class="p">:</code> <code class="n">commandPath</code><code class="p">)</code>
<code class="linenos"> 7 </code>    <code class="n">task</code><code class="p">.</code><code class="n">arguments</code> <code class="p">=</code> <code class="n">argList</code>
<code class="linenos"> 8 </code>    <code class="kd">let</code> <code class="nv">pipe</code> <code class="p">=</code> <code class="n">Pipe</code><code class="p">()</code>
<code class="linenos"> 9 </code>    <code class="n">task</code><code class="p">.</code><code class="n">standardOutput</code> <code class="p">=</code> <code class="n">pipe</code>
<code class="linenos">10 </code>    <code class="k">do</code> <code class="p">{</code>
<code class="linenos">11 </code>        <code class="k">try</code><code class="p">!</code> <code class="n">task</code><code class="p">.</code><code class="n">run</code><code class="p">()</code>
<code class="linenos">12 </code>        <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">pipe</code><code class="p">.</code><code class="n">fileHandleForReading</code><code class="p">.</code><code class="n">readDataToEndOfFile</code><code class="p">()</code>
<code class="linenos">13 </code>        <code class="kd">let</code> <code class="nv">output</code><code class="p">:</code> <code class="nb">String</code><code class="p">?</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">data</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="nb">String</code><code class="p">.</code><code class="n">Encoding</code><code class="p">.</code><code class="n">utf8</code><code class="p">)</code>
<code class="linenos">14 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">output</code> <code class="p">=</code> <code class="n">output</code> <code class="p">{</code>
<code class="linenos">15 </code>          <code class="k">if</code> <code class="o">!</code><code class="n">output</code><code class="p">.</code><code class="bp">isEmpty</code> <code class="p">{</code>
<code class="linenos">16 </code>            <code class="k">return</code> <code class="n">output</code><code class="p">.</code><code class="n">trimmingCharacters</code><code class="p">(</code><code class="k">in</code><code class="p">:</code> <code class="p">.</code><code class="n">whitespacesAndNewlines</code><code class="p">)</code>
<code class="linenos">17 </code>          <code class="p">}</code>
<code class="linenos">18 </code>        <code class="p">}</code>
<code class="linenos">19 </code>    <code class="p">}</code>
<code class="linenos">20 </code>    <code class="k">return</code> <code class="s">""</code>
<code class="linenos">21 </code><code class="p">}</code>
</pre></div>

</figure>

<p>As in most examples in this book we use the Swift testing framework to run the example code at the command line using <em>swift test</em>. Running <em>swift test</em> does an implicit <em>swift build</em>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">XCTest</code>
<code class="linenos"> 2 </code><code class="p">@</code><code class="n">testable</code> <code class="kd">import</code> <code class="nc">ShellProcess_swift</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="kr">final</code> <code class="kd">class</code> <code class="nc">ShellProcessTests</code><code class="p">:</code> <code class="n">XCTestCase</code> <code class="p">{</code>
<code class="linenos"> 5 </code>    <code class="kd">func</code> <code class="nf">testExample</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>        <code class="c1">// This is an example of a functional test case.</code>
<code class="linenos"> 7 </code>        <code class="c1">// Use XCTAssert and related functions to verify your tests produce the</code>
<code class="linenos"> 8 </code>        <code class="c1">// correct results.</code>
<code class="linenos"> 9 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"** s1:"</code><code class="p">)</code>
<code class="linenos">10 </code>        <code class="kd">let</code> <code class="nv">s1</code> <code class="p">=</code> <code class="n">run_in_shell</code><code class="p">(</code><code class="n">commandPath</code><code class="p">:</code> <code class="s">"/bin/ps"</code><code class="p">,</code> <code class="n">argList</code><code class="p">:</code> <code class="p">[</code><code class="s">"a"</code><code class="p">])</code>
<code class="linenos">11 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">s1</code><code class="p">)</code>
<code class="linenos">12 </code>        <code class="kd">let</code> <code class="nv">s2</code> <code class="p">=</code> <code class="n">run_in_shell</code><code class="p">(</code><code class="n">commandPath</code><code class="p">:</code> <code class="s">"/bin/ls"</code><code class="p">,</code> <code class="n">argList</code><code class="p">:</code> <code class="p">[</code><code class="s">"."</code><code class="p">])</code>
<code class="linenos">13 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"** s2:"</code><code class="p">)</code>
<code class="linenos">14 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">s2</code><code class="p">)</code>
<code class="linenos">15 </code>        <code class="kd">let</code> <code class="nv">s3</code> <code class="p">=</code> <code class="n">run_in_shell</code><code class="p">(</code><code class="n">commandPath</code><code class="p">:</code> <code class="s">"/bin/sleep"</code><code class="p">,</code> <code class="n">argList</code><code class="p">:</code> <code class="p">[</code><code class="s">"2"</code><code class="p">])</code>
<code class="linenos">16 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"** s3:"</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">s3</code><code class="p">)</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code>    <code class="p">}</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code>    <code class="kd">static</code> <code class="kd">var</code> <code class="nv">allTests</code> <code class="p">=</code> <code class="p">[</code>
<code class="linenos">22 </code>        <code class="p">(</code><code class="s">"testExample"</code><code class="p">,</code> <code class="n">testExample</code><code class="p">),</code>
<code class="linenos">23 </code>    <code class="p">]</code>
<code class="linenos">24 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The test output (with some text removed for brevity) is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="err">$</code> <code class="n">swift</code> <code class="n">test</code>
<code class="linenos"> 2 </code><code class="n">Test</code> <code class="n">Suite</code> <code class="err">'</code><code class="n">All</code> <code class="n">tests</code><code class="err">'</code> <code class="n">started</code> <code class="n">at</code> <code class="mi">2021</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">06</code> <code class="mi">16</code><code class="p">:</code><code class="mi">36</code><code class="p">:</code><code class="mf">21.447</code>
<code class="linenos"> 3 </code><code class="o">**</code> <code class="n">s1</code><code class="p">:</code>
<code class="linenos"> 4 </code><code class="n">PID</code>   <code class="n">TT</code>  <code class="n">STAT</code>      <code class="n">TIME</code> <code class="n">COMMAND</code>
<code class="linenos"> 5 </code> <code class="mi">3898</code> <code class="n">s000</code>  <code class="n">Ss</code>     <code class="mi">0</code><code class="p">:</code><code class="mf">00.01</code> <code class="n">login</code> <code class="o">-</code><code class="n">pf</code> <code class="n">markw8</code>
<code class="linenos"> 6 </code> <code class="mi">3899</code> <code class="n">s000</code>  <code class="n">S</code><code class="o">+</code>     <code class="mi">0</code><code class="p">:</code><code class="mf">00.18</code> <code class="o">-</code><code class="n">zsh</code>
<code class="linenos"> 7 </code> <code class="mi">3999</code> <code class="n">s001</code>  <code class="n">Ss</code>     <code class="mi">0</code><code class="p">:</code><code class="mf">00.02</code> <code class="n">login</code> <code class="o">-</code><code class="n">pfl</code> <code class="n">markw8</code> <code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">bash</code> <code class="o">-</code><code class="n">c</code> <code class="n">exec</code> <code class="o">-</code><code class="n">la</code> <code class="n">zsh</code> <code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">zsh</code>
<code class="linenos"> 8 </code> <code class="mi">4000</code> <code class="n">s001</code>  <code class="n">S</code><code class="o">+</code>     <code class="mi">0</code><code class="p">:</code><code class="mf">00.38</code> <code class="o">-</code><code class="n">zsh</code>
<code class="linenos"> 9 </code> <code class="mi">5760</code> <code class="n">s002</code>  <code class="n">Ss</code>     <code class="mi">0</code><code class="p">:</code><code class="mf">00.02</code> <code class="n">login</code> <code class="o">-</code><code class="n">pfl</code> <code class="n">markw8</code> <code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">bash</code> <code class="o">-</code><code class="n">c</code> <code class="n">exec</code> <code class="o">-</code><code class="n">la</code> <code class="n">zsh</code> <code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">zsh</code>
<code class="linenos">10 </code> <code class="mi">5761</code> <code class="n">s002</code>  <code class="n">S</code>      <code class="mi">0</code><code class="p">:</code><code class="mf">00.14</code> <code class="o">-</code><code class="n">zsh</code>
<code class="linenos">11 </code> <code class="mi">8654</code> <code class="n">s002</code>  <code class="n">S</code><code class="o">+</code>     <code class="mi">0</code><code class="p">:</code><code class="mf">00.06</code> <code class="o">/</code><code class="n">Applications</code><code class="o">/</code><code class="n">Xcode</code><code class="p">.</code><code class="n">app</code><code class="o">/</code><code class="n">Contents</code><code class="o">/</code><code class="n">Developer</code><code class="o">/</code><code class="n">Toolchains</code><code class="o">/</code><code class="n">Xco</code><code class="err">\</code>
<code class="linenos">12 </code><code class="n">deDefault</code><code class="p">.</code><code class="n">xctoolchain</code><code class="o">/</code><code class="n">usr</code><code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">swift</code><code class="o">-</code><code class="n">test</code>
<code class="linenos">13 </code> <code class="mi">8665</code> <code class="n">s002</code>  <code class="n">S</code>      <code class="mi">0</code><code class="p">:</code><code class="mf">00.03</code> <code class="o">/</code><code class="n">Applications</code><code class="o">/</code><code class="n">Xcode</code><code class="p">.</code><code class="n">app</code><code class="o">/</code><code class="n">Contents</code><code class="o">/</code><code class="n">Developer</code><code class="o">/</code><code class="n">usr</code><code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">xctest</code><code class="err">\</code>
<code class="linenos">14 </code> <code class="o">/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw_1</code><code class="o">/</code><code class="n">GIT_swift_book</code><code class="o">/</code><code class="n">ShellProcess_swift</code><code class="o">/</code><code class="p">.</code><code class="n">build</code><code class="o">/</code><code class="n">arm64</code><code class="o">-</code><code class="n">apple</code><code class="o">-</code><code class="n">macosx</code><code class="o">/</code><code class="n">debug</code><code class="o">/</code><code class="n">Sh</code><code class="err">\</code>
<code class="linenos">15 </code><code class="n">ellProcess_swiftPackageTests</code><code class="p">.</code><code class="n">xctest</code>
<code class="linenos">16 </code> <code class="mi">8666</code> <code class="n">s002</code>  <code class="n">R</code>      <code class="mi">0</code><code class="p">:</code><code class="mf">00.00</code> <code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="n">ps</code> <code class="n">a</code>
<code class="linenos">17 </code><code class="o">**</code> <code class="n">s2</code><code class="p">:</code>
<code class="linenos">18 </code><code class="n">Package</code><code class="p">.</code><code class="n">swift</code>
<code class="linenos">19 </code><code class="n">README</code><code class="p">.</code><code class="n">md</code>
<code class="linenos">20 </code><code class="n">Sources</code>
<code class="linenos">21 </code><code class="n">Tests</code>
<code class="linenos">22 </code><code class="o">**</code> <code class="n">s3</code><code class="p">:</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="n">Test</code> <code class="n">Suite</code> <code class="err">'</code><code class="n">All</code> <code class="n">tests</code><code class="err">'</code> <code class="n">passed</code> <code class="n">at</code> <code class="mi">2021</code><code class="o">-</code><code class="mi">08</code><code class="o">-</code><code class="mi">06</code> <code class="mi">16</code><code class="p">:</code><code class="mi">36</code><code class="p">:</code><code class="mf">23.468</code><code class="p">.</code>
<code class="linenos">25 </code>	 <code class="n">Executed</code> <code class="mi">1</code> <code class="n">test</code><code class="p">,</code> <code class="n">with</code> <code class="mi">0</code> <code class="n">failures</code> <code class="p">(</code><code class="mi">0</code> <code class="n">unexpected</code><code class="p">)</code> <code class="k">in</code> <code class="mf">2.019</code> <code class="p">(</code><code class="mf">2.021</code><code class="p">)</code> <code class="n">seconds</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-fileio-examples">FileIO Examples</h3>

<p>This file I/O example uses the ShellProcess_swift library we saw in the last section so if you were to create your own Swift project with the following code listing, you would have to add this dependency in the <strong>Project.swift</strong> file.</p>

<p>When writing command line Swift programs you will often need to do simple file IO so let’s look at some examples here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code><code class="kd">import</code> <code class="nc">ShellProcess_swift</code> <code class="c1">// my library</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">@</code><code class="n">available</code><code class="p">(</code><code class="n">OSX</code> <code class="mf">10.13</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="kd">func</code> <code class="nf">test_files_demo</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="nb">Void</code> <code class="p">{</code>
<code class="linenos"> 6 </code>    <code class="c1">// In order to append to an existing file, you need to get a file handle</code>
<code class="linenos"> 7 </code>    <code class="c1">// and seek to the end of a file. The following will not work:</code>
<code class="linenos"> 8 </code>    <code class="kd">let</code> <code class="nv">s</code> <code class="p">=</code> <code class="s">"the dog chased the cat</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 9 </code>    <code class="k">try</code><code class="p">!</code> <code class="n">s</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">toFile</code><code class="p">:</code> <code class="s">"out.txt"</code><code class="p">,</code> <code class="n">atomically</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="linenos">10 </code>                 <code class="n">encoding</code><code class="p">:</code> <code class="nb">String</code><code class="p">.</code><code class="n">Encoding</code><code class="p">.</code><code class="n">ascii</code><code class="p">)</code>
<code class="linenos">11 </code>    <code class="kd">let</code> <code class="nv">s2</code> <code class="p">=</code> <code class="s">"a second string</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">12 </code>    <code class="k">try</code><code class="p">!</code> <code class="n">s2</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">toFile</code><code class="p">:</code> <code class="s">"out.txt"</code><code class="p">,</code> <code class="n">atomically</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="linenos">13 </code>                  <code class="n">encoding</code><code class="p">:</code> <code class="nb">String</code><code class="p">.</code><code class="n">Encoding</code><code class="p">.</code><code class="n">ascii</code><code class="p">)</code>
<code class="linenos">14 </code>    <code class="kd">let</code> <code class="nv">aString</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="nb">String</code><code class="p">(</code><code class="n">contentsOfFile</code><code class="p">:</code> <code class="s">"out.txt"</code><code class="p">)</code>
<code class="linenos">15 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">aString</code><code class="p">)</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code>    <code class="c1">// For simple use cases, simply appending strings, then writing</code>
<code class="linenos">18 </code>    <code class="c1">// the result atomically works fine:</code>
<code class="linenos">19 </code>    <code class="kd">var</code> <code class="nv">s3</code> <code class="p">=</code> <code class="s">"the dog chased the cat</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">20 </code>    <code class="n">s3</code> <code class="o">+=</code> <code class="s">"a second string</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">21 </code>    <code class="k">try</code><code class="p">!</code> <code class="n">s3</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">toFile</code><code class="p">:</code> <code class="s">"out2.txt"</code><code class="p">,</code> <code class="n">atomically</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="linenos">22 </code>                  <code class="n">encoding</code><code class="p">:</code> <code class="nb">String</code><code class="p">.</code><code class="n">Encoding</code><code class="p">.</code><code class="n">ascii</code><code class="p">)</code>
<code class="linenos">23 </code>    <code class="kd">let</code> <code class="nv">aString2</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="nb">String</code><code class="p">(</code><code class="n">contentsOfFile</code><code class="p">:</code> <code class="s">"out2.txt"</code><code class="p">)</code>
<code class="linenos">24 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">aString2</code><code class="p">)</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code>    <code class="c1">// list files in current directory:</code>
<code class="linenos">27 </code>    <code class="kd">let</code> <code class="nv">ls</code> <code class="p">=</code> <code class="n">run_in_shell</code><code class="p">(</code><code class="n">commandPath</code><code class="p">:</code> <code class="s">"/bin/ls"</code><code class="p">,</code> <code class="n">argList</code><code class="p">:</code> <code class="p">[</code><code class="s">"."</code><code class="p">])</code>
<code class="linenos">28 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">ls</code><code class="p">)</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code>    <code class="c1">// remove two temnporary files:</code>
<code class="linenos">31 </code>    <code class="kd">let</code> <code class="nv">shellOutput</code> <code class="p">=</code> <code class="n">run_in_shell</code><code class="p">(</code><code class="n">commandPath</code><code class="p">:</code> <code class="s">"/bin/rm"</code><code class="p">,</code>
<code class="linenos">32 </code>                                   <code class="n">argList</code><code class="p">:</code> <code class="p">[</code><code class="s">"out.txt"</code><code class="p">,</code> <code class="s">"out2.txt"</code><code class="p">])</code>
<code class="linenos">33 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">shellOutput</code><code class="p">)</code>
<code class="linenos">34 </code><code class="p">}</code>
<code class="linenos">35 </code>
<code class="linenos">36 </code><code class="k">if</code> <code class="cp">#available</code><code class="p">(</code><code class="cp">OSX</code> <code class="mf">10.13</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">37 </code>    <code class="n">test_files_demo</code><code class="p">()</code>
<code class="linenos">38 </code><code class="p">}</code>
</pre></div>

</figure>

<p>I created a temporary Swift project with the previous code listing and a <strong>Project.swift</strong> file. I built and ran this example using the <strong>swift</strong> command line tool.</p>

<p>Unlike the example in the last section where we built a reusable library with a test program, here we have a standalone program contained in a single file so we will use <em>swift run</em> to build and run this example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="err">$</code> <code class="n">swift</code> <code class="n">run</code>
<code class="linenos"> 2 </code><code class="n">Fetching</code> <code class="n">git</code><code class="p">@</code><code class="n">github</code><code class="p">.</code><code class="n">com</code><code class="p">:</code><code class="n">mark</code><code class="o">-</code><code class="n">watson</code><code class="o">/</code><code class="n">ShellProcess_swift</code><code class="p">.</code><code class="n">git</code> <code class="n">from</code> <code class="n">cache</code>
<code class="linenos"> 3 </code><code class="n">Cloning</code> <code class="n">git</code><code class="p">@</code><code class="n">github</code><code class="p">.</code><code class="n">com</code><code class="p">:</code><code class="n">mark</code><code class="o">-</code><code class="n">watson</code><code class="o">/</code><code class="n">ShellProcess_swift</code><code class="p">.</code><code class="n">git</code>
<code class="linenos"> 4 </code><code class="n">Resolving</code> <code class="n">git</code><code class="p">@</code><code class="n">github</code><code class="p">.</code><code class="n">com</code><code class="p">:</code><code class="n">mark</code><code class="o">-</code><code class="n">watson</code><code class="o">/</code><code class="n">ShellProcess_swift</code><code class="p">.</code><code class="n">git</code> <code class="n">at</code> <code class="n">main</code>
<code class="linenos"> 5 </code><code class="p">[</code><code class="mi">5</code><code class="o">/</code><code class="mi">5</code><code class="p">]</code> <code class="n">Build</code> <code class="n">complete</code><code class="p">!</code>
<code class="linenos"> 6 </code><code class="n">a</code> <code class="n">second</code> <code class="n">string</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="n">the</code> <code class="n">dog</code> <code class="n">chased</code> <code class="n">the</code> <code class="n">cat</code>
<code class="linenos"> 9 </code><code class="n">a</code> <code class="n">second</code> <code class="n">string</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="n">Package</code><code class="p">.</code><code class="n">resolved</code>
<code class="linenos">12 </code><code class="n">Package</code><code class="p">.</code><code class="n">swift</code>
<code class="linenos">13 </code><code class="n">README</code><code class="p">.</code><code class="n">md</code>
<code class="linenos">14 </code><code class="n">Sources</code>
<code class="linenos">15 </code><code class="n">out</code><code class="p">.</code><code class="n">txt</code>
<code class="linenos">16 </code><code class="n">out2</code><code class="p">.</code><code class="n">txt</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-swift-repl">Swift REPL</h3>

<p>There is an example of using the Swift REPL at the end of the next chapter on web scraping. For reference, you can start a REPL with:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="err">$</code> <code class="n">swift</code> <code class="n">run</code> <code class="o">--</code><code class="n">repl</code>
<code class="linenos">2 </code><code class="kr">Type</code> <code class="p">:</code><code class="n">help</code> <code class="k">for</code> <code class="n">assistance</code><code class="p">.</code>
<code class="linenos">3 </code><code class="mi">1</code><code class="p">&gt;</code> <code class="kd">import</code> <code class="nc">WebScraping_swift</code>
<code class="linenos">4 </code><code class="mi">2</code><code class="p">&gt;</code> <code class="n">webPageText</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="s">"https://markwatson.com"</code><code class="p">)</code>
<code class="linenos">5 </code><code class="err">$</code><code class="n">R0</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"Mark Watson: AI Practitioner and Polyglot Programmer"</code><code class="p">...</code>
<code class="linenos">6 </code><code class="mi">3</code><code class="p">&gt;</code> <code class="kd">public</code> <code class="kd">func</code> <code class="nf">foo</code><code class="p">(</code><code class="n">s</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code> <code class="k">return</code> <code class="n">s</code> <code class="p">}</code> 
<code class="linenos">7 </code><code class="mi">4</code><code class="p">&gt;</code> <code class="n">foo</code><code class="p">(</code><code class="n">s</code><code class="p">:</code> <code class="s">"cat"</code><code class="p">)</code> 
<code class="linenos">8 </code><code class="err">$</code><code class="n">R1</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"cat"</code>
<code class="linenos">9 </code><code class="mi">5</code><code class="p">&gt;</code> 
</pre></div>

</figure>

<p>You can import packages and interactively enter Swift expressions, including defining functions.</p>

<p>In the next chapter we will look at a longer example that scrapes web sites.</p>

<p>In the next chapter we will look at one more simple example, building a web scraping library, before getting to the machine learning and NLP part of the book.</p>


<h2 id="leanpub-auto-web-scraping">Web Scraping</h2>

<p>It is important to respect the property rights of web site owners and abide by their terms and conditions for use. This <a href="https://en.wikipedia.org/wiki/Fair_use">Wikipedia article on Fair Use</a> provides a good overview of using copyright material.</p>

<p>The web scraping code we develop here uses the Swift library <strong>SwiftSoup</strong> that is loosely based on the BeautifulSoup libraries available in other programming languages.</p>

<p>For my work and research, I have been most interested in using web scraping to collect text data for natural language processing but other common applications include writing AI news collection and summarization assistants, trying to predict stock prices based on comments in social media which is what we did at Webmind Corporation in 2000 and 2001, etc.</p>

<p>I wrote a simple web scraping library that is available at <a href="https://github.com/mark-watson/WebScraping_swift">https://github.com/mark-watson/WebScraping_swift</a> that you can use in your projects by putting the following dependency in your <strong>Project.swift</strong> file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="n">dependencies</code><code class="p">:</code> <code class="p">[</code>
<code class="linenos">2 </code>         <code class="p">.</code><code class="n">package</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="s">"git@github.com:mark-watson/WebScraping_swift.git"</code><code class="p">,</code>
<code class="linenos">3 </code>             <code class="p">.</code><code class="n">branch</code><code class="p">(</code><code class="s">"main"</code><code class="p">)),</code>
<code class="linenos">4 </code>    <code class="p">],</code>
</pre></div>

</figure>

<p>Here is the main implementation file for the library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code><code class="kd">import</code> <code class="nc">SwiftSoup</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">webPageText</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 5 </code>    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">myURL</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="n">uri</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos"> 6 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"Error: </code><code class="si">\(</code><code class="n">uri</code><code class="si">)</code><code class="s"> doesn't seem to be a valid URL"</code><code class="p">)</code>
<code class="linenos"> 7 </code>        <code class="bp">fatalError</code><code class="p">(</code><code class="s">"invalid URI"</code><code class="p">)</code>
<code class="linenos"> 8 </code>    <code class="p">}</code>
<code class="linenos"> 9 </code>    <code class="kd">let</code> <code class="nv">html</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="nb">String</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">myURL</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">ascii</code><code class="p">)</code>
<code class="linenos">10 </code>    <code class="kd">let</code> <code class="nv">doc</code><code class="p">:</code> <code class="n">Document</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="n">SwiftSoup</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code><code class="n">html</code><code class="p">)</code>
<code class="linenos">11 </code>    <code class="kd">let</code> <code class="nv">plain_text</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="n">doc</code><code class="p">.</code><code class="n">text</code><code class="p">()</code>
<code class="linenos">12 </code>    <code class="k">return</code> <code class="n">plain_text</code>
<code class="linenos">13 </code><code class="p">}</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="kd">func</code> <code class="nf">webPageHeadersHelper</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">headerName</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">16 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">17 </code>    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">myURL</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="n">uri</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">18 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"Error: </code><code class="si">\(</code><code class="n">uri</code><code class="si">)</code><code class="s"> doesn't seem to be a valid URL"</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="bp">fatalError</code><code class="p">(</code><code class="s">"invalid URI"</code><code class="p">)</code>
<code class="linenos">20 </code>    <code class="p">}</code>
<code class="linenos">21 </code>    <code class="k">do</code> <code class="p">{</code>
<code class="linenos">22 </code>        <code class="kd">let</code> <code class="nv">html</code> <code class="p">=</code> <code class="k">try</code> <code class="nb">String</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">myURL</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">ascii</code><code class="p">)</code>
<code class="linenos">23 </code>        <code class="kd">let</code> <code class="nv">doc</code><code class="p">:</code> <code class="n">Document</code> <code class="p">=</code> <code class="k">try</code> <code class="n">SwiftSoup</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code><code class="n">html</code><code class="p">)</code>
<code class="linenos">24 </code>        <code class="kd">let</code> <code class="nv">h1_headers</code> <code class="p">=</code> <code class="k">try</code> <code class="n">doc</code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="n">headerName</code><code class="p">)</code>
<code class="linenos">25 </code>        <code class="k">for</code> <code class="n">el</code> <code class="k">in</code> <code class="n">h1_headers</code> <code class="p">{</code>
<code class="linenos">26 </code>            <code class="kd">let</code> <code class="nv">h1</code> <code class="p">=</code> <code class="k">try</code> <code class="n">el</code><code class="p">.</code><code class="n">text</code><code class="p">()</code>
<code class="linenos">27 </code>            <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">h1</code><code class="p">)</code>
<code class="linenos">28 </code>        <code class="p">}</code>
<code class="linenos">29 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>
<code class="linenos">30 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"Error"</code><code class="p">)</code>
<code class="linenos">31 </code>    <code class="p">}</code>
<code class="linenos">32 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos">33 </code><code class="p">}</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">webPageH1Headers</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">36 </code>    <code class="k">return</code> <code class="n">webPageHeadersHelper</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">uri</code><code class="p">,</code> <code class="n">headerName</code><code class="p">:</code> <code class="s">"h1"</code><code class="p">)</code>
<code class="linenos">37 </code><code class="p">}</code>
<code class="linenos">38 </code>    
<code class="linenos">39 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">webPageH2Headers</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">40 </code>    <code class="k">return</code> <code class="n">webPageHeadersHelper</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">uri</code><code class="p">,</code> <code class="n">headerName</code><code class="p">:</code> <code class="s">"h2"</code><code class="p">)</code>
<code class="linenos">41 </code><code class="p">}</code>
<code class="linenos">42 </code>
<code class="linenos">43 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">webPageAnchors</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[[</code><code class="nb">String</code><code class="p">]]</code> <code class="p">{</code>
<code class="linenos">44 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[[</code><code class="nb">String</code><code class="p">]]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">45 </code>    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">myURL</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="n">uri</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">46 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"Error: </code><code class="si">\(</code><code class="n">uri</code><code class="si">)</code><code class="s"> doesn't seem to be a valid URL"</code><code class="p">)</code>
<code class="linenos">47 </code>        <code class="bp">fatalError</code><code class="p">(</code><code class="s">"invalid URI"</code><code class="p">)</code>
<code class="linenos">48 </code>    <code class="p">}</code>
<code class="linenos">49 </code>    <code class="k">do</code> <code class="p">{</code>
<code class="linenos">50 </code>        <code class="kd">let</code> <code class="nv">html</code> <code class="p">=</code> <code class="k">try</code> <code class="nb">String</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">myURL</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">ascii</code><code class="p">)</code>
<code class="linenos">51 </code>        <code class="kd">let</code> <code class="nv">doc</code><code class="p">:</code> <code class="n">Document</code> <code class="p">=</code> <code class="k">try</code> <code class="n">SwiftSoup</code><code class="p">.</code><code class="n">parse</code><code class="p">(</code><code class="n">html</code><code class="p">)</code>
<code class="linenos">52 </code>        <code class="kd">let</code> <code class="nv">anchors</code> <code class="p">=</code> <code class="k">try</code> <code class="n">doc</code><code class="p">.</code><code class="n">select</code><code class="p">(</code><code class="s">"a"</code><code class="p">)</code>
<code class="linenos">53 </code>        <code class="k">for</code> <code class="n">a</code> <code class="k">in</code> <code class="n">anchors</code> <code class="p">{</code>
<code class="linenos">54 </code>            <code class="kd">let</code> <code class="nv">text</code> <code class="p">=</code> <code class="k">try</code> <code class="n">a</code><code class="p">.</code><code class="n">text</code><code class="p">()</code>
<code class="linenos">55 </code>            <code class="kd">let</code> <code class="nv">a_uri</code> <code class="p">=</code> <code class="k">try</code> <code class="n">a</code><code class="p">.</code><code class="n">attr</code><code class="p">(</code><code class="s">"href"</code><code class="p">)</code>
<code class="linenos">56 </code>            <code class="k">if</code> <code class="n">a_uri</code><code class="p">.</code><code class="n">hasPrefix</code><code class="p">(</code><code class="s">"#"</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">57 </code>                <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">([</code><code class="n">text</code><code class="p">,</code> <code class="n">uri</code> <code class="o">+</code> <code class="n">a_uri</code><code class="p">])</code>
<code class="linenos">58 </code>            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">59 </code>                <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">([</code><code class="n">text</code><code class="p">,</code> <code class="n">a_uri</code><code class="p">])</code>
<code class="linenos">60 </code>            <code class="p">}</code>
<code class="linenos">61 </code>        <code class="p">}</code>
<code class="linenos">62 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>
<code class="linenos">63 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"Error"</code><code class="p">)</code>
<code class="linenos">64 </code>    <code class="p">}</code>
<code class="linenos">65 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos">66 </code><code class="p">}</code>
</pre></div>

</figure>

<p>Here I wrote utility functions to get the plain text from a web site, HTML header text, and anchors. You can clone this library and extend it for other types of HTML elements you may need to process.</p>

<p>The test program shows how to call the APIs in the library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">XCTest</code>
<code class="linenos"> 2 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 3 </code><code class="kd">import</code> <code class="nc">SwiftSoup</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">@</code><code class="n">testable</code> <code class="kd">import</code> <code class="nc">WebScraping_swift</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kr">final</code> <code class="kd">class</code> <code class="nc">WebScrapingTests</code><code class="p">:</code> <code class="n">XCTestCase</code> <code class="p">{</code>
<code class="linenos"> 8 </code>    <code class="kd">func</code> <code class="nf">testGetWebPage</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 9 </code>        <code class="kd">let</code> <code class="nv">text</code> <code class="p">=</code> <code class="n">webPageText</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="s">"https://markwatson.com"</code><code class="p">)</code>
<code class="linenos">10 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n\n\t</code><code class="s">TEXT FROM MARK's WEB SITE:</code><code class="se">\n\n</code><code class="s">"</code><code class="p">,</code> <code class="n">text</code><code class="p">)</code>
<code class="linenos">11 </code>    <code class="p">}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code>    <code class="kd">func</code> <code class="nf">testToShowSwiftSoupExamples</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">14 </code>        <code class="kd">let</code> <code class="nv">myURLString</code> <code class="p">=</code> <code class="s">"https://markwatson.com"</code>
<code class="linenos">15 </code>        <code class="kd">let</code> <code class="nv">h1_headers</code> <code class="p">=</code> <code class="n">webPageH1Headers</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">myURLString</code><code class="p">)</code>
<code class="linenos">16 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n\n</code><code class="s">++ h1_headers:"</code><code class="p">,</code> <code class="n">h1_headers</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="kd">let</code> <code class="nv">h2_headers</code> <code class="p">=</code> <code class="n">webPageH2Headers</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">myURLString</code><code class="p">)</code>
<code class="linenos">18 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n\n</code><code class="s">++ h2_headers:"</code><code class="p">,</code> <code class="n">h2_headers</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="kd">let</code> <code class="nv">anchors</code> <code class="p">=</code> <code class="n">webPageAnchors</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">myURLString</code><code class="p">)</code>
<code class="linenos">20 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n\n</code><code class="s">++ anchors:"</code><code class="p">,</code> <code class="n">anchors</code><code class="p">)</code>
<code class="linenos">21 </code><code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code>    <code class="kd">static</code> <code class="kd">var</code> <code class="nv">allTests</code> <code class="p">=</code> <code class="p">[(</code><code class="s">"testGetWebPage"</code><code class="p">,</code> <code class="n">testGetWebPage</code><code class="p">),</code>
<code class="linenos">24 </code>                           <code class="p">(</code><code class="s">"testToShowSwiftSoupExamples"</code><code class="p">,</code>
<code class="linenos">25 </code>                            <code class="n">testToShowSwiftSoupExamples</code><code class="p">)]</code>
<code class="linenos">26 </code><code class="p">}</code>
</pre></div>

</figure>

<p>Here we run the unit tests (with much of the output not shown for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ swift <code class="nb">test</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code>	TEXT FROM MARK<code class="s1">'s WEB SITE:</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="s1"> Mark Watson: AI Practitioner and Polyglot Programmer | Mark Watson    Read my Blog \</code>
<code class="linenos"> 6 </code><code class="s1">   Fun stuff    My Books    My Open Source Projects    Hire Me    Free Mentoring    \</code>
<code class="linenos"> 7 </code><code class="s1">Privacy Policy Mark Watson: AI Practitioner and Polyglot Programmer I am the author \</code>
<code class="linenos"> 8 </code><code class="s1">of 20+ books on Artificial Intelligence, Common Lisp, Deep Learning, Haskell, Clojur\</code>
<code class="linenos"> 9 </code><code class="s1">e, Java, Ruby, Hy language, and the Semantic Web. I have 55 US Patents. My customer \</code>
<code class="linenos">10 </code><code class="s1">list includes: Google, Capital One, Olive AI, CompassLabs, Disney, SAIC, Americast, \</code>
<code class="linenos">11 </code><code class="s1">PacBell, CastTV, Lutris Technology, Arctan Group, Sitescout.com, Embed.ly, and Webmi\</code>
<code class="linenos">12 </code><code class="s1">nd Corporation.</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="s1">++ h1_headers: ["Mark Watson: AI Practitioner and Polyglot Programmer", "The books t\</code>
<code class="linenos">15 </code><code class="s1">hat I have written", "Fun stuff", "Open Source", "Hire Me", "Free Mentoring", "Priva\</code>
<code class="linenos">16 </code><code class="s1">cy Policy"]</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="s1">++ h2_headers: ["I am the author of 20+ books on Artificial Intelligence, Common Lis\</code>
<code class="linenos">19 </code><code class="s1">p, Deep Learning, Haskell, Clojure, Java, Ruby, Hy language, and the Semantic Web. I\</code>
<code class="linenos">20 </code><code class="s1"> have 55 US Patents.", "Other published books:"]</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="s1">++ anchors: [["Read my Blog", "https://mark-watson.blogspot.com"], ["Fun stuff", "ht\</code>
<code class="linenos">23 </code><code class="s1">tps://markwatson.com#fun"], ["My Books", "https://markwatson.com#books"], ["My Open \</code>
<code class="linenos">24 </code><code class="s1">Source Projects", "https://markwatson.com#opensource"], ["Hire Me", "https://markwat\</code>
<code class="linenos">25 </code><code class="s1">son.com#consulting"], ["Free Mentoring", "https://markwatson.com#mentoring"], ["Priv\</code>
<code class="linenos">26 </code><code class="s1">acy Policy", "https://markwatson.com/privacy.html"], ["leanpub", "https://leanpub.co\</code>
<code class="linenos">27 </code><code class="s1">m/u/markwatson"], ["GitHub", "https://github.com/mark-watson"], ["LinkedIn", "https:\</code>
<code class="linenos">28 </code><code class="s1">//www.linkedin.com/in/marklwatson/"], ["Twitter", "https://twitter.com/mark_l_watson\</code>
<code class="linenos">29 </code><code class="s1">"], ["leanpub", "https://leanpub.com/lovinglisp"], ["leanpub", "https://leanpub.com/\</code>
<code class="linenos">30 </code><code class="s1">haskell-cookbook/"], ["leanpub", "https://leanpub.com/javaai"], </code>
<code class="linenos">31 </code><code class="s1">]</code>
<code class="linenos">32 </code><code class="s1">Test Suite '</code>All tests<code class="err">'</code> passed at <code class="m">2021</code>-08-06 <code class="m">17</code>:37:11.062.
<code class="linenos">33 </code>	 Executed <code class="m">2</code> tests, with <code class="m">0</code> failures <code class="o">(</code><code class="m">0</code> unexpected<code class="o">)</code> <code class="k">in</code> <code class="m">0</code>.471 <code class="o">(</code><code class="m">0</code>.472<code class="o">)</code> seconds
</pre></div>

</figure>

<h3 id="leanpub-auto-running-in-the-swift-repl">Running in the Swift REPL</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="err">$</code> <code class="n">swift</code> <code class="n">run</code> <code class="o">--</code><code class="n">repl</code>
<code class="linenos"> 2 </code><code class="p">[</code><code class="mi">1</code><code class="o">/</code><code class="mi">1</code><code class="p">]</code> <code class="n">Build</code> <code class="n">complete</code><code class="p">!</code>
<code class="linenos"> 3 </code><code class="n">Launching</code> <code class="n">Swift</code> <code class="n">REPL</code> <code class="n">with</code> <code class="n">arguments</code><code class="p">:</code> <code class="o">-</code><code class="n">I</code><code class="o">/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw_1</code><code class="o">/</code><code class="n">GIT_swift_book</code><code class="o">/</code><code class="n">WebScraping_swi</code><code class="err">\</code>
<code class="linenos"> 4 </code><code class="n">ft</code><code class="o">/</code><code class="p">.</code><code class="n">build</code><code class="o">/</code><code class="n">arm64</code><code class="o">-</code><code class="n">apple</code><code class="o">-</code><code class="n">macosx</code><code class="o">/</code><code class="n">debug</code> <code class="o">-</code><code class="n">L</code><code class="o">/</code><code class="n">Users</code><code class="o">/</code><code class="n">markw_1</code><code class="o">/</code><code class="n">GIT_swift_book</code><code class="o">/</code><code class="n">WebScraping_swift</code><code class="err">\</code>
<code class="linenos"> 5 </code><code class="o">/</code><code class="p">.</code><code class="n">build</code><code class="o">/</code><code class="n">arm64</code><code class="o">-</code><code class="n">apple</code><code class="o">-</code><code class="n">macosx</code><code class="o">/</code><code class="n">debug</code> <code class="o">-</code><code class="n">lWebScraping_swift__REPL</code>
<code class="linenos"> 6 </code><code class="n">Welcome</code> <code class="n">to</code> <code class="n">Apple</code> <code class="n">Swift</code> <code class="n">version</code> <code class="mf">5.5</code> <code class="p">(</code><code class="n">swiftlang</code><code class="o">-</code><code class="mf">1300.0</code><code class="p">.</code><code class="mf">29.102</code> <code class="n">clang</code><code class="o">-</code><code class="mf">1300.0</code><code class="p">.</code><code class="mf">28.1</code><code class="p">).</code>
<code class="linenos"> 7 </code><code class="kr">Type</code> <code class="p">:</code><code class="n">help</code> <code class="k">for</code> <code class="n">assistance</code><code class="p">.</code>
<code class="linenos"> 8 </code>  <code class="mi">1</code><code class="p">&gt;</code> <code class="kd">import</code> <code class="nc">WebScraping_swift</code>
<code class="linenos"> 9 </code>  <code class="mi">2</code><code class="p">&gt;</code> <code class="n">webPageText</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="s">"https://markwatson.com"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="err">$</code><code class="n">R0</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"Mark Watson: AI Practitioner and Polyglot Programmer | Mark Watson   \</code>
<code class="linenos">11 </code><code class="s"> Read my Blog    Fun stuff    My Books    My Open Source Projects    Privacy Policy \</code>
<code class="linenos">12 </code><code class="s">Mark Watson: AI Practitioner and Polyglot Programmer I am the author of 20+ books on\</code>
<code class="linenos">13 </code><code class="s"> Artificial Intelligence, Common Lisp, Deep Learning, Haskell, Clojure, Java, Ruby, \</code>
<code class="linenos">14 </code><code class="s">Hy language, and the Semantic Web. I have 55 US Patents. My customer list includes: \</code>
<code class="linenos">15 </code><code class="s">Google, Capital One, Babylist, Olive AI, CompassLabs, Disney, SAIC, Americast, PacBe\</code>
<code class="linenos">16 </code><code class="s">ll, CastTV, Lutris Technology, Arctan Group, Sitescout.com, Embed.ly, and Webmind Co\</code>
<code class="linenos">17 </code><code class="s">rporation"</code><code class="p">...</code>
<code class="linenos">18 </code>  <code class="mi">3</code><code class="p">&gt;</code>  
</pre></div>

</figure>

<p>This chapter finishes a quick introduction to using Swift and Swift packages for command line utilities. The remainder of this book comprises machine learning, natural language processing, and semantic web/linked data examples.</p>


<h2 id="leanpub-auto-part-2-apples-coreml-and-nlp-libraries">Part 2: Apple’s CoreML and NLP Libraries</h2>

<p>In this part we cover:</p>

<ul>
  <li>Short introduction to the ideas behind Deep Learning</li>
  <li>Introduction of CoreML</li>
  <li>Examples using CoreML</li>
  <li>Introduction of NLP</li>
  <li>Examples using NLP libraries</li>
</ul>


<h2 id="leanpub-auto-deep-learning-introduction">Deep Learning Introduction</h2>

<p>Apple’s work in smoothly integrating deep learning into their developer tools for macOS, iOS, and iPadOS applications is in my opinion nothing short of brilliant. We will finish this book with an application that uses two deep learning models that provide almost all of the functionality of the application.</p>

<p>Before diving into Apple’s CoreML libraries in later chapters we will take a shallow dive into the principles of deep learning and take a lay-of-the-land look at the type of most commonly used models. This chapter has no example programs and is intended as background material.</p>

<p>Most of my professional career since 2014 has involved Deep Learning, mostly with TensorFlow using the Keras APIs. In the late 1980s I was on a DARPA neural network technology advisory panel for a year, I wrote the first prototype of the SAIC ANSim neural network library commercial product, and I wrote the neural network prediction code for a bomb detector my company designed and built for the FAA for deployment in airports. More recently I have used GAN (generative adversarial networks) models for synthesizing numeric spreadsheet data and LSTM (long short term memory) models to synthesize highly structured text data like nested JSON and for NLP (natural language processing).  I have also written a product recommendation model for an online store using TensorFlow Recommenders. I have several USA and European patents using neural network and Deep Learning technology.</p>

<p>Here we will learn a vocabulary for discussing Deep Learning neural network models and look at possible architectures.</p>

<p>If you want to use Deep Learning professionally, there are two specific online resources that I recommend: Andrew Ng leads the efforts at <a href="https://www.deeplearning.ai/">deeplearning.ai</a> and Jeremy Howard leads the efforts at <a href="https://www.fast.ai/">fast.ai</a>.</p>

<p>There are many Deep Learning neural architectures in current practical use; a few types that I use are:</p>

<ul>
  <li>Multi-layer perceptron networks with many fully connected layers. An input layer contains placeholders for input data. Each element in the input layer is connected by a two-dimensional weight matrix to each element in the first hidden layer. We can use any number of fully connected hidden layers, with the last hidden layer connected to an output layer.</li>
  <li>Convolutional networks for image processing and text classification. Convolutions, or filters, are small windows that can process input images (filters are two-dimensional) or sequences like text (filters are one-dimensional). Each filter uses a single set of learned weights independent of where the filter is applied in an input image or input sequence.</li>
  <li>Autoencoders have the same number of input layer and output layer elements with one or more hidden fully connected layers. Autoencoders are trained to produce the same output as training input values using a relatively small number of hidden layer elements. Autoencoders are capable of removing noise in input data.</li>
  <li>LSTM (long short term memory) process elements in a sequence in order and are capable of remembering patterns that they have seen earlier in the sequence.</li>
  <li>GAN (generative adversarial networks) models comprise two different and competing neural models, the generator and the discriminator. GANs are often trained on input images (although in my work I have applied GANs to two-dimensional numeric spreadsheet data). The generator model takes as input a “latent input vector” (this is just a vector of specific size with random values) and generates a random output image. The weights of the generator model are trained to produce random images that are similar to how training images look. The discriminator model is trained to recognize if an arbitrary output image is original training data or an image created by the generator model. The generator and discriminator models are trained together.</li>
</ul>

<p>The core functionality of libraries like TensorFlow are written in C++ and take advantage of special hardware like GPUs, custom ASICs, and devices like Google’s TPUs. Most people who work with Deep Learning models don’t need to even be aware of the low level optimizations used to make training and using Deep Learning models more efficient. That said, in the following section I am going to show you how simple neural networks are trained and used.</p>

<h3 id="leanpub-auto-simple-multi-layer-perceptron-neural-networks">Simple Multi-layer Perceptron Neural Networks</h3>

<p>I use the terms Multi-layer perceptron neural networks, backpropagation neural networks and delta-rule networks interchangeably. Backpropagation refers to the model training process of calculating the output errors when training inputs are passed in the forward direction from input layer, to hidden layers, and then to the output layer. There will be an error which is the difference between the calculated outputs and the training outputs. This error can be used to adjust the weights from the last hidden layer to the output layer to reduce the error. The error is then backprogated backwards through the hidden layers, updating all weights in the model. I have detailed example code in several of my older artificial intelligence books. Here I am satisfied to give you an intuition of how simple neural networks are trained.</p>

<p>The basic idea is that we start with a network initialized with random weights and for each training case we propagate the inputs through the network towards the output neurons, calculate the output errors, and back-up the errors from the output neurons back towards the input neurons in order to make small changes to the weights to lower the error for the current training example. We repeat this process by cycling through the training examples many times.</p>

<p>The following figure shows a simple backpropagation network with one hidden layer. Neurons in adjacent layers are connected by floating point connection strength weights. These weights start out as small random values that change as the network is trained. Weights are represented in the following figure by arrows; in the code the weights connecting the input to the output neurons are represented as a two-dimensional array.</p>


<div class="figure-wrapper center">
  <figure id="nn-backprop" class="image" style="width: 217px">
    <img src="images/nn_backprop2d.png" alt="Example Backpropagation network with One Hidden Layer" style="width: 100%">
    <figcaption>Example Backpropagation network with One Hidden Layer</figcaption>
  </figure>
</div>


<p>Each non-input neuron has an activation value that is calculated from the activation values of connected neurons feeding into it, gated (adjusted) by the connection weights. For example, in the above figure, the value of Output 1 neuron is calculated by summing the activation of Input 1 times weight W1,1 and Input 2 activation times weight W2,1 and applying a “squashing function” like Sigmoid or Relu (see figures below) to this sum to get the final value for Output 1’s activation value. We want to flatten activation values to a relatively small range but still maintain relative values. To do this flattening we use the Sigmoid function that is seen in the next figure, along with the derivative of the Sigmoid function which we will use in the code for training a network by adjusting the weights.</p>


<div class="figure-wrapper center">
  <figure id="nn-sigmoid" class="image" style="width: 288px">
    <img src="images/nn_sigmoid.png" alt="Sigmoid Function and Derivative of Sigmoid Function (SigmoidP)" style="width: 100%">
    <figcaption>Sigmoid Function and Derivative of Sigmoid Function (SigmoidP)</figcaption>
  </figure>
</div>


<p>Simple neural network architectures with just one or two hidden layers are easy to train using backpropagation and I have from scratch code (using no libraries) for this several of my previous books. However, here we are using Hy to write models using the TensorFlow framework which has the huge advantage that small models you experiment with on your laptop can be scaled to more parameters (usually this means more neurons in hidden layers which increases the number of weights in a model) and run in the cloud using multiple GPUs.</p>

<p>Except for pedantic purposes, I now never write neural network code from scratch. I take instead advantage of the many person-years of engineering work put into the development of frameworks like TensorFlow, PyTorch, mxnet, etc. We now move on to two examples built with TensorFlow.</p>

<h3 id="leanpub-auto-deep-learning">Deep Learning</h3>

<p>Deep Learning models are generally understood to have many more hidden layers than simple multi-layer perceptron neural networks and often comprise multiple simple models combined together in series or in parallel.
Complex architectures can be iteratively developed by manually adjusting the size of model components, changing the components, etc. Alternatively, model architecture search can be automated. At Capital One I used Google’s 
<a href="https://github.com/tensorflow/adanet">AdaNet project</a> that efficiently searches for effective model architectures inside a single TensorFlow session. Now all major cloud compute provides support some form of AutoML. You need to make a decision for yourself how much effort you want to put into deeply understanding the technology, or simply learning how to use pre-trained models.</p>


<h2 id="leanpub-auto-using-apples-core-ml-machine-learning-and-deep-learning-libraries">Using Apple’s Core ML Machine Learning and Deep Learning Libraries</h2>

<p>NOTE: as of April 2022, this example does not work - problem with latest CreateML library.</p>

<p>Please note that this chapter is specific to Apple’s libraries using pre-trained deep learning models.</p>

<p>I assume that you are generally familiar with <a href="https://developer.apple.com/documentation/coreml">Apple’s CoreML documentation</a></p>

<p>There are two example GitHub repositories for this chapter:</p>

<ul>
  <li>
<a href="https://github.com/mark-watson/swift-coreml-wisconsin_data_create_model">https://github.com/mark-watson/swift-coreml-wisconsin_data_create_model</a> generates a deep learning model and saves it for reuse.</li>
  <li>
<a href="https://github.com/mark-watson/swift-coreml-wisconsin_data_predict_with_model">https://github.com/mark-watson/swift-coreml-wisconsin_data_predict_with_model</a> uses the trained model.</li>
</ul>

<p>In the last chapter we will use two deep learning models in a MacOS application that is available on Apple’s App Store.</p>

<p>If you have taken a class in Machine Learning or Deep Learning, you learned how to divide a training data set into separate training, development (often refered to as “dev” sets), and test data sets. This process is handled internally by the CoreML libraries we use here so we will only be using a single training data file. The CoreML APIs we use here perform a type of AutoML (automatic machine learning) by trying to train a model using several model types and choosing the model type with the best accuracy. This is convenient and saves engineering time. A trained model imported into XCode automatically generates Swift APIs for using the model. You can also take a trained CoreML model and use it in Python programs (<a href="https://coremltools.readme.io/docs/mlmodel">documentation for Python use cases</a>).</p>

<h3 id="leanpub-auto-training-a-classification-model-for-the-university-of-wisconsin-cancer-data">Training a Classification Model For the University of Wisconsin Cancer Data</h3>

<p>When building the example model (data in files <strong>wisconsin.mlmodel</strong>*), a Swift file <strong>wisconsin.swift</strong> is auto-generated. In the project Makefile, notice that the make target <strong>clean</strong> removes these files:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nf">build_model</code><code class="o">:</code> <code class="n">clean</code>
<code class="linenos">2 </code>	swift build
<code class="linenos">3 </code>	swift run
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="nf">clean</code><code class="o">:</code>
<code class="linenos">6 </code>	rm -f Sources/wisconsin_data/wisconsin.mlmodel*
<code class="linenos">7 </code>	rm -f Sources/wisconsin_data/wisconsin.swift
</pre></div>

</figure>

<p>The file <strong>Sources/wisconsin_data/main.swift</strong> reads a training file in CSV format and uses the CoreML libraries to train a prediction model. You might want to uncomment the print statement in line 10 to see the contents of the CSV formatted (i.e., a spreadsheet file) training data file. In lines 11-13 we define which columns in the input training CSV file that we will use to build our model (in this case we use all the data features).</p>

<p>In this example we use Apple’s APIs for <strong>MLClassifier</strong> that trains the following learning algorithms and keeps the best for the saved model:</p>

<ul>
  <li>Boosted trees classifier</li>
  <li>Random forest classifier</li>
  <li>Decision tree classifier</li>
  <li>SVM</li>
  <li>Logistic regression</li>
</ul>

<p>There is optional material at the end of this chapter with background for these five types of models.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code><code class="kd">import</code> <code class="nc">CoreML</code>
<code class="linenos"> 3 </code><code class="kd">import</code> <code class="nc">CreateML</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kd">func</code> <code class="nf">create_model</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>    <code class="k">if</code> <code class="cp">#available</code><code class="p">(</code><code class="cp">macOS</code> <code class="mf">10.14</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 7 </code>        <code class="kd">let</code> <code class="nv">fileUrl</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">fileURLWithPath</code><code class="p">:</code> <code class="s">"labeled_cancer_data.csv"</code><code class="p">)</code>
<code class="linenos"> 8 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">fileUrl</code><code class="p">)</code>
<code class="linenos"> 9 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">dataTable</code> <code class="p">=</code> <code class="k">try</code><code class="p">?</code> <code class="n">MLDataTable</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">fileUrl</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>            <code class="c1">//print(dataTable)</code>
<code class="linenos">11 </code>            <code class="kd">let</code> <code class="nv">regressorColumns</code> <code class="p">=</code> <code class="p">[</code><code class="s">"Cl.thickness"</code><code class="p">,</code> <code class="s">"Cell.size"</code><code class="p">,</code>
<code class="linenos">12 </code>                                    <code class="s">"Cell.shape"</code><code class="p">,</code> <code class="s">"Marg.adhesion"</code><code class="p">,</code>
<code class="linenos">13 </code>                                    <code class="s">"Epith.c.size"</code><code class="p">,</code> <code class="s">"Bare.nuclei"</code><code class="p">,</code>
<code class="linenos">14 </code>                                    <code class="s">"Bl.cromatin"</code><code class="p">,</code> <code class="s">"Normal.nucleoli"</code><code class="p">,</code>
<code class="linenos">15 </code>                                    <code class="s">"Mitoses"</code><code class="p">,</code> <code class="s">"Class"</code><code class="p">]</code>
<code class="linenos">16 </code>            
<code class="linenos">17 </code>            <code class="c1">// Classifier:</code>
<code class="linenos">18 </code>            <code class="kd">let</code> <code class="nv">classifierTable</code> <code class="p">=</code> <code class="n">dataTable</code><code class="p">[</code><code class="n">regressorColumns</code><code class="p">]</code>
<code class="linenos">19 </code>            <code class="kd">let</code> <code class="p">(</code><code class="n">classifierEvaluationTable</code><code class="p">,</code> <code class="n">classifierTrainingTable</code><code class="p">)</code> <code class="p">=</code>
<code class="linenos">20 </code>              <code class="n">classifierTable</code><code class="p">.</code><code class="n">randomSplit</code><code class="p">(</code><code class="n">by</code><code class="p">:</code> <code class="mf">0.20</code><code class="p">,</code> <code class="n">seed</code><code class="p">:</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">21 </code>            <code class="kd">let</code> <code class="nv">classifier</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="n">MLClassifier</code><code class="p">(</code><code class="n">trainingData</code><code class="p">:</code> <code class="n">classifierTrainingTable</code><code class="p">,</code>
<code class="linenos">22 </code>                                              <code class="n">targetColumn</code><code class="p">:</code> <code class="s">"Class"</code><code class="p">)</code>
<code class="linenos">23 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"++ classifier.description:"</code><code class="p">,</code> <code class="n">classifier</code><code class="p">)</code>
<code class="linenos">24 </code>            <code class="c1">/// Classifier training accuracy as a percentage</code>
<code class="linenos">25 </code>            <code class="kd">let</code> <code class="nv">trainingError</code> <code class="p">=</code> <code class="n">classifier</code><code class="p">.</code><code class="n">trainingMetrics</code><code class="p">.</code><code class="n">classificationError</code>
<code class="linenos">26 </code>            <code class="kd">let</code> <code class="nv">trainingAccuracy</code> <code class="p">=</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">-</code> <code class="n">trainingError</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">27 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"trainingAccuracy:"</code><code class="p">,</code> <code class="n">trainingAccuracy</code><code class="p">)</code>
<code class="linenos">28 </code>            
<code class="linenos">29 </code>            <code class="c1">/// Classifier validation accuracy as a percentage</code>
<code class="linenos">30 </code>            <code class="kd">let</code> <code class="nv">validationError</code> <code class="p">=</code> <code class="n">classifier</code><code class="p">.</code><code class="n">validationMetrics</code><code class="p">.</code><code class="n">classificationError</code>
<code class="linenos">31 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"validationError:"</code><code class="p">,</code> <code class="n">validationError</code><code class="p">)</code>
<code class="linenos">32 </code>            <code class="kd">let</code> <code class="nv">validationAccuracy</code> <code class="p">=</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">-</code> <code class="n">validationError</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">33 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"validationAccuracy:"</code><code class="p">,</code> <code class="n">validationAccuracy</code><code class="p">)</code>
<code class="linenos">34 </code>            <code class="c1">/// Evaluate the classifier</code>
<code class="linenos">35 </code>            <code class="kd">let</code> <code class="nv">classifierEvaluation</code> <code class="p">=</code>
<code class="linenos">36 </code>              <code class="n">classifier</code><code class="p">.</code><code class="n">evaluation</code><code class="p">(</code><code class="n">on</code><code class="p">:</code> <code class="n">classifierEvaluationTable</code><code class="p">)</code>
<code class="linenos">37 </code>            
<code class="linenos">38 </code>            <code class="c1">/// Classifier evaluation accuracy as a percentage</code>
<code class="linenos">39 </code>            <code class="kd">let</code> <code class="nv">evaluationError</code> <code class="p">=</code> <code class="n">classifierEvaluation</code><code class="p">.</code><code class="n">classificationError</code>
<code class="linenos">40 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"evaluationError:"</code><code class="p">,</code> <code class="n">evaluationError</code><code class="p">)</code>
<code class="linenos">41 </code>            <code class="kd">let</code> <code class="nv">evaluationAccuracy</code> <code class="p">=</code> <code class="p">(</code><code class="mf">1.0</code> <code class="o">-</code> <code class="n">evaluationError</code><code class="p">)</code> <code class="o">*</code> <code class="mi">100</code>
<code class="linenos">42 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"evaluationAccuracy:"</code><code class="p">,</code> <code class="n">evaluationAccuracy</code><code class="p">)</code>
<code class="linenos">43 </code>            
<code class="linenos">44 </code>            <code class="kd">let</code> <code class="nv">classifierMetadata</code> <code class="p">=</code>
<code class="linenos">45 </code>              <code class="n">MLModelMetadata</code><code class="p">(</code><code class="n">author</code><code class="p">:</code> <code class="s">"Mark Watson"</code><code class="p">,</code>
<code class="linenos">46 </code>                              <code class="n">shortDescription</code><code class="p">:</code> <code class="s">"Wisconsin Cancer Dataset"</code><code class="p">,</code>
<code class="linenos">47 </code>                              <code class="n">version</code><code class="p">:</code> <code class="s">"1.0"</code><code class="p">)</code>
<code class="linenos">48 </code>            
<code class="linenos">49 </code>            <code class="c1">/// Save the trained classifier model to the Desktop.</code>
<code class="linenos">50 </code>            <code class="kd">let</code> <code class="nv">_</code> <code class="p">=</code>
<code class="linenos">51 </code>              <code class="k">try</code><code class="p">?</code> <code class="n">classifier</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">to</code><code class="p">:</code> <code class="n">URL</code><code class="p">(</code><code class="n">fileURLWithPath</code><code class="p">:</code>
<code class="linenos">52 </code>                                           <code class="s">"Sources/wisconsin_data/wisconsin.mlmodel\</code>
<code class="linenos">53 </code><code class="s">"</code><code class="p">),</code>
<code class="linenos">54 </code>                                           <code class="n">metadata</code><code class="p">:</code> <code class="n">classifierMetadata</code><code class="p">)</code>
<code class="linenos">55 </code>        <code class="p">}</code>
<code class="linenos">56 </code>    <code class="p">}</code>
<code class="linenos">57 </code><code class="p">}</code>
<code class="linenos">58 </code>
<code class="linenos">59 </code><code class="n">create_model</code><code class="p">()</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code>$ make
<code class="linenos">  2 </code>rm -f Sources/wisconsin_data/wisconsin.mlmodel*
<code class="linenos">  3 </code>rm -f Sources/wisconsin_data/wisconsin.swift
<code class="linenos">  4 </code>swift build
<code class="linenos">  5 </code><code class="o">[</code><code class="m">0</code>/0<code class="o">]</code> Build complete!
<code class="linenos">  6 </code>swift run
<code class="linenos">  7 </code><code class="o">[</code><code class="m">0</code>/0<code class="o">]</code> Build complete!
<code class="linenos">  8 </code><code class="nv">column_type_hints</code> <code class="o">=</code> <code class="o">{}</code>
<code class="linenos">  9 </code>Finished parsing file /Users/markw_1/GITHUB/wisconsin_data_create_model/labeled_canc<code class="se">\</code>
<code class="linenos"> 10 </code>er_data.csv
<code class="linenos"> 11 </code>Parsing completed. Parsed <code class="m">100</code> lines <code class="k">in</code> <code class="m">0</code>.01006 secs.
<code class="linenos"> 12 </code>Finished parsing file /Users/markw_1/GITHUB/wisconsin_data_create_model/labeled_canc<code class="se">\</code>
<code class="linenos"> 13 </code>er_data.csv
<code class="linenos"> 14 </code>Parsing completed. Parsed <code class="m">683</code> lines <code class="k">in</code> <code class="m">0</code>.003458 secs.
<code class="linenos"> 15 </code>Using <code class="m">9</code> features to train a model to predict Class.
<code class="linenos"> 16 </code>
<code class="linenos"> 17 </code>Automatically generating validation <code class="nb">set</code> from <code class="m">5</code>% of the data.
<code class="linenos"> 18 </code>Boosted trees classifier:
<code class="linenos"> 19 </code>--------------------------------------------------------
<code class="linenos"> 20 </code>Number of examples          : <code class="m">522</code>
<code class="linenos"> 21 </code>Number of classes           : <code class="m">2</code>
<code class="linenos"> 22 </code>Number of feature columns   : <code class="m">9</code>
<code class="linenos"> 23 </code>Number of unpacked features : <code class="m">9</code>
<code class="linenos"> 24 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 25 </code>-----+---------------------+
<code class="linenos"> 26 </code><code class="p">|</code> Iteration <code class="p">|</code> Elapsed Time <code class="p">|</code> Training Accuracy <code class="p">|</code> Validation Accuracy <code class="p">|</code> Training Log <code class="se">\</code>
<code class="linenos"> 27 </code>Loss <code class="p">|</code> Validation Log Loss <code class="p">|</code>
<code class="linenos"> 28 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 29 </code>-----+---------------------+
<code class="linenos"> 30 </code><code class="p">|</code> <code class="m">1</code>         <code class="p">|</code> <code class="m">0</code>.006108     <code class="p">|</code> <code class="m">0</code>.988506          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.459892     <code class="se">\</code>
<code class="linenos"> 31 </code>     <code class="p">|</code> <code class="m">0</code>.520190            <code class="p">|</code>
<code class="linenos"> 32 </code><code class="p">|</code> <code class="m">2</code>         <code class="p">|</code> <code class="m">0</code>.010718     <code class="p">|</code> <code class="m">0</code>.984674          <code class="p">|</code> <code class="m">0</code>.857143            <code class="p">|</code> <code class="m">0</code>.329561     <code class="se">\</code>
<code class="linenos"> 33 </code>     <code class="p">|</code> <code class="m">0</code>.412062            <code class="p">|</code>
<code class="linenos"> 34 </code><code class="p">|</code> <code class="m">3</code>         <code class="p">|</code> <code class="m">0</code>.015658     <code class="p">|</code> <code class="m">0</code>.984674          <code class="p">|</code> <code class="m">0</code>.857143            <code class="p">|</code> <code class="m">0</code>.245602     <code class="se">\</code>
<code class="linenos"> 35 </code>     <code class="p">|</code> <code class="m">0</code>.337748            <code class="p">|</code>
<code class="linenos"> 36 </code><code class="p">|</code> <code class="m">4</code>         <code class="p">|</code> <code class="m">0</code>.020130     <code class="p">|</code> <code class="m">0</code>.986590          <code class="p">|</code> <code class="m">0</code>.857143            <code class="p">|</code> <code class="m">0</code>.186529     <code class="se">\</code>
<code class="linenos"> 37 </code>     <code class="p">|</code> <code class="m">0</code>.291379            <code class="p">|</code>
<code class="linenos"> 38 </code><code class="p">|</code> <code class="m">5</code>         <code class="p">|</code> <code class="m">0</code>.024706     <code class="p">|</code> <code class="m">0</code>.990421          <code class="p">|</code> <code class="m">0</code>.857143            <code class="p">|</code> <code class="m">0</code>.144306     <code class="se">\</code>
<code class="linenos"> 39 </code>     <code class="p">|</code> <code class="m">0</code>.262312            <code class="p">|</code>
<code class="linenos"> 40 </code><code class="p">|</code> <code class="m">10</code>        <code class="p">|</code> <code class="m">0</code>.043619     <code class="p">|</code> <code class="m">0</code>.996169          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.049835     <code class="se">\</code>
<code class="linenos"> 41 </code>     <code class="p">|</code> <code class="m">0</code>.180445            <code class="p">|</code>
<code class="linenos"> 42 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 43 </code>-----+---------------------+
<code class="linenos"> 44 </code>Random forest classifier:
<code class="linenos"> 45 </code>--------------------------------------------------------
<code class="linenos"> 46 </code>Number of examples          : <code class="m">522</code>
<code class="linenos"> 47 </code>Number of classes           : <code class="m">2</code>
<code class="linenos"> 48 </code>Number of feature columns   : <code class="m">9</code>
<code class="linenos"> 49 </code>Number of unpacked features : <code class="m">9</code>
<code class="linenos"> 50 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 51 </code>-----+---------------------+
<code class="linenos"> 52 </code><code class="p">|</code> Iteration <code class="p">|</code> Elapsed Time <code class="p">|</code> Training Accuracy <code class="p">|</code> Validation Accuracy <code class="p">|</code> Training Log <code class="se">\</code>
<code class="linenos"> 53 </code>Loss <code class="p">|</code> Validation Log Loss <code class="p">|</code>
<code class="linenos"> 54 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 55 </code>-----+---------------------+
<code class="linenos"> 56 </code><code class="p">|</code> <code class="m">1</code>         <code class="p">|</code> <code class="m">0</code>.002102     <code class="p">|</code> <code class="m">0</code>.984674          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.173523     <code class="se">\</code>
<code class="linenos"> 57 </code>     <code class="p">|</code> <code class="m">0</code>.305533            <code class="p">|</code>
<code class="linenos"> 58 </code><code class="p">|</code> <code class="m">2</code>         <code class="p">|</code> <code class="m">0</code>.003890     <code class="p">|</code> <code class="m">0</code>.986590          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.171982     <code class="se">\</code>
<code class="linenos"> 59 </code>     <code class="p">|</code> <code class="m">0</code>.306030            <code class="p">|</code>
<code class="linenos"> 60 </code><code class="p">|</code> <code class="m">3</code>         <code class="p">|</code> <code class="m">0</code>.005461     <code class="p">|</code> <code class="m">0</code>.984674          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.173111     <code class="se">\</code>
<code class="linenos"> 61 </code>     <code class="p">|</code> <code class="m">0</code>.276622            <code class="p">|</code>
<code class="linenos"> 62 </code><code class="p">|</code> <code class="m">4</code>         <code class="p">|</code> <code class="m">0</code>.006758     <code class="p">|</code> <code class="m">0</code>.984674          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.171693     <code class="se">\</code>
<code class="linenos"> 63 </code>     <code class="p">|</code> <code class="m">0</code>.285118            <code class="p">|</code>
<code class="linenos"> 64 </code><code class="p">|</code> <code class="m">5</code>         <code class="p">|</code> <code class="m">0</code>.007481     <code class="p">|</code> <code class="m">0</code>.982759          <code class="p">|</code> <code class="m">0</code>.952381            <code class="p">|</code> <code class="m">0</code>.172563     <code class="se">\</code>
<code class="linenos"> 65 </code>     <code class="p">|</code> <code class="m">0</code>.273630            <code class="p">|</code>
<code class="linenos"> 66 </code><code class="p">|</code> <code class="m">10</code>        <code class="p">|</code> <code class="m">0</code>.011962     <code class="p">|</code> <code class="m">0</code>.984674          <code class="p">|</code> <code class="m">0</code>.952381            <code class="p">|</code> <code class="m">0</code>.171195     <code class="se">\</code>
<code class="linenos"> 67 </code>     <code class="p">|</code> <code class="m">0</code>.261603            <code class="p">|</code>
<code class="linenos"> 68 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 69 </code>-----+---------------------+
<code class="linenos"> 70 </code>Decision tree classifier:
<code class="linenos"> 71 </code>--------------------------------------------------------
<code class="linenos"> 72 </code>Number of examples          : <code class="m">522</code>
<code class="linenos"> 73 </code>Number of classes           : <code class="m">2</code>
<code class="linenos"> 74 </code>Number of feature columns   : <code class="m">9</code>
<code class="linenos"> 75 </code>Number of unpacked features : <code class="m">9</code>
<code class="linenos"> 76 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 77 </code>-----+---------------------+
<code class="linenos"> 78 </code><code class="p">|</code> Iteration <code class="p">|</code> Elapsed Time <code class="p">|</code> Training Accuracy <code class="p">|</code> Validation Accuracy <code class="p">|</code> Training Log <code class="se">\</code>
<code class="linenos"> 79 </code>Loss <code class="p">|</code> Validation Log Loss <code class="p">|</code>
<code class="linenos"> 80 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 81 </code>-----+---------------------+
<code class="linenos"> 82 </code><code class="p">|</code> <code class="m">1</code>         <code class="p">|</code> <code class="m">0</code>.002216     <code class="p">|</code> <code class="m">0</code>.988506          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code> <code class="m">0</code>.170105     <code class="se">\</code>
<code class="linenos"> 83 </code>     <code class="p">|</code> <code class="m">0</code>.352356            <code class="p">|</code>
<code class="linenos"> 84 </code>+-----------+--------------+-------------------+---------------------+--------------<code class="se">\</code>
<code class="linenos"> 85 </code>-----+---------------------+
<code class="linenos"> 86 </code>SVM:
<code class="linenos"> 87 </code>--------------------------------------------------------
<code class="linenos"> 88 </code>Number of examples          : <code class="m">522</code>
<code class="linenos"> 89 </code>Number of classes           : <code class="m">2</code>
<code class="linenos"> 90 </code>Number of feature columns   : <code class="m">9</code>
<code class="linenos"> 91 </code>Number of unpacked features : <code class="m">9</code>
<code class="linenos"> 92 </code>Number of coefficients    : <code class="m">10</code>
<code class="linenos"> 93 </code>Starting L-BFGS 
<code class="linenos"> 94 </code>--------------------------------------------------------
<code class="linenos"> 95 </code>+-----------+----------+-----------+--------------+-------------------+-------------<code class="se">\</code>
<code class="linenos"> 96 </code>--------+
<code class="linenos"> 97 </code><code class="p">|</code> Iteration <code class="p">|</code> Passes   <code class="p">|</code> Step size <code class="p">|</code> Elapsed Time <code class="p">|</code> Training Accuracy <code class="p">|</code> Validation A<code class="se">\</code>
<code class="linenos"> 98 </code>ccuracy <code class="p">|</code>
<code class="linenos"> 99 </code>+-----------+----------+-----------+--------------+-------------------+-------------<code class="se">\</code>
<code class="linenos">100 </code>--------+
<code class="linenos">101 </code><code class="p">|</code> <code class="m">0</code>         <code class="p">|</code> <code class="m">2</code>        <code class="p">|</code> <code class="m">1</code>.000000  <code class="p">|</code> <code class="m">0</code>.000629     <code class="p">|</code> <code class="m">0</code>.350575          <code class="p">|</code> <code class="m">0</code>.285714    <code class="se">\</code>
<code class="linenos">102 </code>        <code class="p">|</code>
<code class="linenos">103 </code><code class="p">|</code> <code class="m">1</code>         <code class="p">|</code> <code class="m">6</code>        <code class="p">|</code> <code class="m">3</code>.000000  <code class="p">|</code> <code class="m">0</code>.001610     <code class="p">|</code> <code class="m">0</code>.908046          <code class="p">|</code> <code class="m">0</code>.857143    <code class="se">\</code>
<code class="linenos">104 </code>        <code class="p">|</code>
<code class="linenos">105 </code><code class="p">|</code> <code class="m">2</code>         <code class="p">|</code> <code class="m">7</code>        <code class="p">|</code> <code class="m">3</code>.000000  <code class="p">|</code> <code class="m">0</code>.002089     <code class="p">|</code> <code class="m">0</code>.840996          <code class="p">|</code> <code class="m">0</code>.809524    <code class="se">\</code>
<code class="linenos">106 </code>        <code class="p">|</code>
<code class="linenos">107 </code><code class="p">|</code> <code class="m">3</code>         <code class="p">|</code> <code class="m">12</code>       <code class="p">|</code> <code class="m">1</code>.053671  <code class="p">|</code> <code class="m">0</code>.004093     <code class="p">|</code> <code class="m">0</code>.961686          <code class="p">|</code> <code class="m">0</code>.952381    <code class="se">\</code>
<code class="linenos">108 </code>        <code class="p">|</code>
<code class="linenos">109 </code><code class="p">|</code> <code class="m">4</code>         <code class="p">|</code> <code class="m">13</code>       <code class="p">|</code> <code class="m">1</code>.053671  <code class="p">|</code> <code class="m">0</code>.004610     <code class="p">|</code> <code class="m">0</code>.959770          <code class="p">|</code> <code class="m">0</code>.904762    <code class="se">\</code>
<code class="linenos">110 </code>        <code class="p">|</code>
<code class="linenos">111 </code><code class="p">|</code> <code class="m">9</code>         <code class="p">|</code> <code class="m">20</code>       <code class="p">|</code> <code class="m">1</code>.053671  <code class="p">|</code> <code class="m">0</code>.007046     <code class="p">|</code> <code class="m">0</code>.971264          <code class="p">|</code> <code class="m">0</code>.904762    <code class="se">\</code>
<code class="linenos">112 </code>        <code class="p">|</code>
<code class="linenos">113 </code>+-----------+----------+-----------+--------------+-------------------+-------------<code class="se">\</code>
<code class="linenos">114 </code>--------+
<code class="linenos">115 </code>Logistic regression:
<code class="linenos">116 </code>--------------------------------------------------------
<code class="linenos">117 </code>Number of examples          : <code class="m">522</code>
<code class="linenos">118 </code>Number of classes           : <code class="m">2</code>
<code class="linenos">119 </code>Number of feature columns   : <code class="m">9</code>
<code class="linenos">120 </code>Number of unpacked features : <code class="m">9</code>
<code class="linenos">121 </code>Number of coefficients      : <code class="m">10</code>
<code class="linenos">122 </code>Starting Newton Method 
<code class="linenos">123 </code>--------------------------------------------------------
<code class="linenos">124 </code>+-----------+----------+--------------+-------------------+---------------------+
<code class="linenos">125 </code><code class="p">|</code> Iteration <code class="p">|</code> Passes   <code class="p">|</code> Elapsed Time <code class="p">|</code> Training Accuracy <code class="p">|</code> Validation Accuracy <code class="p">|</code>
<code class="linenos">126 </code>+-----------+----------+--------------+-------------------+---------------------+
<code class="linenos">127 </code><code class="p">|</code> <code class="m">1</code>         <code class="p">|</code> <code class="m">2</code>        <code class="p">|</code> <code class="m">0</code>.000373     <code class="p">|</code> <code class="m">0</code>.967433          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code>
<code class="linenos">128 </code><code class="p">|</code> <code class="m">2</code>         <code class="p">|</code> <code class="m">3</code>        <code class="p">|</code> <code class="m">0</code>.000724     <code class="p">|</code> <code class="m">0</code>.969349          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code>
<code class="linenos">129 </code><code class="p">|</code> <code class="m">3</code>         <code class="p">|</code> <code class="m">4</code>        <code class="p">|</code> <code class="m">0</code>.001080     <code class="p">|</code> <code class="m">0</code>.975096          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code>
<code class="linenos">130 </code><code class="p">|</code> <code class="m">4</code>         <code class="p">|</code> <code class="m">5</code>        <code class="p">|</code> <code class="m">0</code>.001427     <code class="p">|</code> <code class="m">0</code>.978927          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code>
<code class="linenos">131 </code><code class="p">|</code> <code class="m">5</code>         <code class="p">|</code> <code class="m">6</code>        <code class="p">|</code> <code class="m">0</code>.001796     <code class="p">|</code> <code class="m">0</code>.978927          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code>
<code class="linenos">132 </code><code class="p">|</code> <code class="m">7</code>         <code class="p">|</code> <code class="m">8</code>        <code class="p">|</code> <code class="m">0</code>.002388     <code class="p">|</code> <code class="m">0</code>.978927          <code class="p">|</code> <code class="m">0</code>.904762            <code class="p">|</code>
<code class="linenos">133 </code>+-----------+----------+--------------+-------------------+---------------------+
<code class="linenos">134 </code>SUCCESS: Optimal solution found.
<code class="linenos">135 </code>
<code class="linenos">136 </code>++ classifier.description: RandomForestClassifier
<code class="linenos">137 </code>
<code class="linenos">138 </code>Parameters
<code class="linenos">139 </code>Max Depth: <code class="m">6</code>
<code class="linenos">140 </code>Max Iterations: <code class="m">10</code>
<code class="linenos">141 </code>Min Loss Reduction: <code class="m">0</code>.0
<code class="linenos">142 </code>Min Child Weight: <code class="m">0</code>.0
<code class="linenos">143 </code>Random Seed: <code class="m">42</code>
<code class="linenos">144 </code>Row Subsample: <code class="m">0</code>.8
<code class="linenos">145 </code>Column Subsample: <code class="m">0</code>.8
<code class="linenos">146 </code>
<code class="linenos">147 </code>Performance on Training Data
<code class="linenos">148 </code>Number of examples: <code class="m">522</code>
<code class="linenos">149 </code>Number of classes: <code class="m">2</code>
<code class="linenos">150 </code>Accuracy: <code class="m">98</code>.47%
<code class="linenos">151 </code>
<code class="linenos">152 </code>Performance on Validation Data
<code class="linenos">153 </code>Number of examples: <code class="m">21</code>
<code class="linenos">154 </code>Number of classes: <code class="m">2</code>
<code class="linenos">155 </code>Accuracy: <code class="m">95</code>.24%
<code class="linenos">156 </code>
<code class="linenos">157 </code>trainingAccuracy: <code class="m">98</code>.46743295019157
<code class="linenos">158 </code>validationError: <code class="m">0</code>.04761904761904767
<code class="linenos">159 </code>validationAccuracy: <code class="m">95</code>.23809523809523
<code class="linenos">160 </code>evaluationError: <code class="m">0</code>.050000000000000044
<code class="linenos">161 </code>evaluationAccuracy: <code class="m">95</code>.0
<code class="linenos">162 </code>Trained model successfully saved at /Users/markw_1/GITHUB/SwiftAI-book-code/wisconsi<code class="se">\</code>
<code class="linenos">163 </code>n_data_create_model/Sources/wisconsin_data/wisconsin.mlmodel.
</pre></div>

</figure>

<h3 id="leanpub-auto-using-the-classification-model-for-the-university-of-wisconsin-cancer-data">Using the Classification Model for the University of Wisconsin Cancer Data</h3>

<p>The GitHub repo <a href="https://github.com/mark-watson/swift-coreml-wisconsin_data_predict_with_model">https://github.com/mark-watson/swift-coreml-wisconsin_data_predict_with_model</a> contains a <strong>Makefile</strong> with a target for building the prediction code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nf">build_preditor</code><code class="o">:</code> <code class="n">clean</code>
<code class="linenos"> 2 </code>	cp ../wisconsin_data_create_model/Sources/wisconsin_data/wisconsin.mlmodel <code class="se">\</code>
<code class="linenos"> 3 </code>	   Sources/wisconsin_data/
<code class="linenos"> 4 </code>	<code class="nb">cd</code> Sources/wisconsin_data<code class="p">;</code> <code class="se">\</code>
<code class="linenos"> 5 </code>	   xcrun coremlcompiler generate wisconsin.mlmodel --language Swift .
<code class="linenos"> 6 </code>	<code class="nb">cd</code> Sources/wisconsin_data<code class="p">;</code> xcrun coremlcompiler compile wisconsin.mlmodel .
<code class="linenos"> 7 </code>	swift build
<code class="linenos"> 8 </code>	swift run
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="nf">clean</code><code class="o">:</code>
<code class="linenos">11 </code>	rm -rf Sources/wisconsin_data/wisconsin.mlmodel*
<code class="linenos">12 </code>	rm -rf Sources/wisconsin_data/wisconsin.swift
</pre></div>

</figure>

<p>The file <strong>swift-coreml-wisconsin_data_predict_with_model/Sources/wisconsin_data/main.swift</strong> contains the prediction code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code><code class="kd">import</code> <code class="nc">CoreML</code>
<code class="linenos"> 3 </code><code class="kd">import</code> <code class="nc">CreateML</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="kd">func</code> <code class="nf">predict</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos"> 6 </code>    <code class="k">if</code> <code class="cp">#available</code><code class="p">(</code><code class="cp">macOS</code> <code class="mf">10.14</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 7 </code>        
<code class="linenos"> 8 </code>        <code class="kd">let</code> <code class="nv">modelUrl</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">fileURLWithPath</code><code class="p">:</code>
<code class="linenos"> 9 </code>            <code class="s">"Sources/wisconsin_data/wisconsin.mlmodelc"</code><code class="p">)</code>
<code class="linenos">10 </code>        <code class="kd">let</code> <code class="nv">pretrained_model</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="n">wisconsin</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">modelUrl</code><code class="p">,</code>
<code class="linenos">11 </code>             <code class="n">configuration</code><code class="p">:</code> <code class="bp">MLModelConfiguration</code><code class="p">())</code>
<code class="linenos">12 </code>        
<code class="linenos">13 </code>        <code class="kd">let</code> <code class="nv">sampleInput</code> <code class="p">=</code> <code class="n">wisconsinInput</code><code class="p">(</code><code class="n">Cl_thickness</code><code class="p">:</code> <code class="mi">3</code><code class="p">,</code> <code class="n">Cell_size</code><code class="p">:</code> <code class="mi">2</code><code class="p">,</code>
<code class="linenos">14 </code>            <code class="n">Cell_shape</code><code class="p">:</code> <code class="mi">5</code><code class="p">,</code> <code class="n">Marg_adhesion</code><code class="p">:</code> <code class="mi">8</code><code class="p">,</code> <code class="n">Epith_c_size</code><code class="p">:</code> <code class="mi">8</code><code class="p">,</code> <code class="n">Bare_nuclei</code><code class="p">:</code> <code class="mi">2</code><code class="p">,</code> <code class="n">Bl_cro</code><code class="err">\</code>
<code class="linenos">15 </code><code class="n">matin</code><code class="p">:</code> <code class="mi">3</code><code class="p">,</code>
<code class="linenos">16 </code>            <code class="n">Normal_nucleoli</code><code class="p">:</code> <code class="mi">7</code><code class="p">,</code> <code class="n">Mitoses</code><code class="p">:</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="kd">let</code> <code class="nv">a_prediction</code> <code class="p">=</code> <code class="k">try</code><code class="p">!</code> <code class="n">pretrained_model</code><code class="p">.</code><code class="n">prediction</code><code class="p">(</code><code class="n">input</code><code class="p">:</code> <code class="n">sampleInput</code><code class="p">)</code>
<code class="linenos">18 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">a_prediction</code><code class="p">.</code><code class="n">featureNames</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"Class:"</code><code class="p">,</code> <code class="n">a_prediction</code><code class="p">.</code><code class="n">featureValue</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="s">"Class"</code><code class="p">)</code><code class="o">!</code><code class="p">)</code>
<code class="linenos">20 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"ClassProbability:"</code><code class="p">,</code>
<code class="linenos">21 </code>              <code class="n">a_prediction</code><code class="p">.</code><code class="n">featureValue</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="s">"ClassProbability"</code><code class="p">)</code><code class="o">!</code><code class="p">)</code>
<code class="linenos">22 </code>    <code class="p">}</code>
<code class="linenos">23 </code><code class="p">}</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="n">predict</code><code class="p">()</code>
</pre></div>

</figure>

<p>We can run the prediction example on the command line:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ make
<code class="linenos"> 2 </code>rm -rf Sources/wisconsin_data/wisconsin.mlmodel*
<code class="linenos"> 3 </code>rm -rf Sources/wisconsin_data/wisconsin.swift
<code class="linenos"> 4 </code>cp ../wisconsin_data_create_model/Sources/wisconsin_data/wisconsin.mlmodel <code class="se">\</code>
<code class="linenos"> 5 </code>    Sources/wisconsin_data/
<code class="linenos"> 6 </code><code class="nb">cd</code> Sources/wisconsin_data<code class="p">;</code> <code class="se">\</code>
<code class="linenos"> 7 </code>    xcrun coremlcompiler generate wisconsin.mlmodel --language Swift .
<code class="linenos"> 8 </code>/Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/wisco<code class="se">\</code>
<code class="linenos"> 9 </code>nsin.swift
<code class="linenos">10 </code><code class="nb">cd</code> Sources/wisconsin_data<code class="p">;</code> xcrun coremlcompiler compile wisconsin.mlmodel .
<code class="linenos">11 </code>/Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/wisco<code class="se">\</code>
<code class="linenos">12 </code>nsin.mlmodelc/coremldata.bin
<code class="linenos">13 </code>/Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/wisco<code class="se">\</code>
<code class="linenos">14 </code>nsin.mlmodelc/analytics/coremldata.bin
<code class="linenos">15 </code>/Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/wisco<code class="se">\</code>
<code class="linenos">16 </code>nsin.mlmodelc/model0/coremldata.bin
<code class="linenos">17 </code>/Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/wisco<code class="se">\</code>
<code class="linenos">18 </code>nsin.mlmodelc/model1/coremldata.bin
<code class="linenos">19 </code>/Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/wisco<code class="se">\</code>
<code class="linenos">20 </code>nsin.mlmodelc/model1/_B0000.DAT
<code class="linenos">21 </code>swift build
<code class="linenos">22 </code><code class="s1">'wisconsin_data'</code> /Users/markw_1/GITHUB/wisconsin_data_predict_with_model: warning: f<code class="se">\</code>
<code class="linenos">23 </code>ound <code class="m">1</code> file<code class="o">(</code>s<code class="o">)</code> which are unhandled<code class="p">;</code> explicitly <code class="nb">declare</code> them as resources or exclude <code class="se">\</code>
<code class="linenos">24 </code>from the target
<code class="linenos">25 </code>    /Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/w<code class="se">\</code>
<code class="linenos">26 </code>isconsin.mlmodel
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="o">[</code><code class="m">4</code>/4<code class="o">]</code> Build complete!
<code class="linenos">29 </code>swift run
<code class="linenos">30 </code><code class="s1">'wisconsin_data'</code> /Users/markw_1/GITHUB/wisconsin_data_predict_with_model: warning: f<code class="se">\</code>
<code class="linenos">31 </code>ound <code class="m">1</code> file<code class="o">(</code>s<code class="o">)</code> which are unhandled<code class="p">;</code> explicitly <code class="nb">declare</code> them as resources or exclude <code class="se">\</code>
<code class="linenos">32 </code>from the target
<code class="linenos">33 </code>    /Users/markw_1/GITHUB/wisconsin_data_predict_with_model/Sources/wisconsin_data/w<code class="se">\</code>
<code class="linenos">34 </code>isconsin.mlmodel
<code class="linenos">35 </code>
<code class="linenos">36 </code><code class="o">[</code><code class="m">0</code>/0<code class="o">]</code> Build complete!
<code class="linenos">37 </code><code class="o">[</code><code class="s2">"Class"</code>, <code class="s2">"ClassProbability"</code><code class="o">]</code>
<code class="linenos">38 </code>Class: Int : <code class="m">0</code>
<code class="linenos">39 </code>ClassProbability: Dictionary : <code class="o">{</code>
<code class="linenos">40 </code>    <code class="nv">0</code> <code class="o">=</code> <code class="s2">"0.7969631955468645"</code><code class="p">;</code>
<code class="linenos">41 </code>    <code class="nv">1</code> <code class="o">=</code> <code class="s2">"0.2030368044531356"</code><code class="p">;</code>
<code class="linenos">42 </code><code class="o">}</code>
</pre></div>

</figure>

<p>I recommend that you read through Apple’s documentation and bookmark the page for the <a href="https://apple.github.io/turicreate/docs/userguide/supervised-learning/classifier.html">CoreML classification modes</a>.</p>

<p>Boosted Trees Classifiers are comprised of individual models summed together, where the simpler models are learned decision trees (a type of ensemble models).</p>

<p>Random Forest Classifiers are similar to Boosted Trees Classifiers except the ensemble sub-classifier comprising Random Forest Classifiers are each trained with a subset of the data.</p>

<p>You might also want to review Apple’s documentation for the following conventional Machine Learning algorithms: Decision tree classifier, SVM, and Logistic regression.</p>


<h2 id="leanpub-auto-natural-language-processing-using-apples-natural-language-framework">Natural Language Processing Using Apple’s Natural Language Framework</h2>

<p>I have been working in the field of Natural Language Processing (NLP) since 1985 so I ‘lived through’ the revolutionary change in NLP that has occurred since 2014: Deep Learning results out-classed results from previous symbolic methods.</p>

<p>https://developer.apple.com/documentation/naturallanguage</p>

<p>I will not cover older symbolic methods of NLP here, rather I refer you to my previous books <a href="https://leanpub.com/javaai">Practical Artificial Intelligence Programming With Java</a>, <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, or the Savvy Programmer’s Secret Weapon</a>, and <a href="https://leanpub.com/haskell-cookbook">Haskell Tutorial and Cookbook</a> for examples. We get better results using Deep Learning (DL) for NLP and the libraries that Apple provides.</p>

<p>You will learn how to apply both DL and NLP by using the state-of-the-art full-feature libraries that Apple provides in their iOS and macOS development tools.</p>

<h3 id="leanpub-auto-using-apples-naturallanguage-swift-library">Using Apple’s <strong>NaturalLanguage</strong> Swift Library</h3>

<p>We will use one of Apple’s NLP libraries consisting of pre-built models in the last chapter of this book. In order to fully understand the example in the last chapter you will need to read Apple’s high-level discussion of using CoreML <a href="https://developer.apple.com/documentation/coreml">https://developer.apple.com/documentation/coreml</a> and their specific support for NLP <a href="https://developer.apple.com/documentation/naturallanguage/">https://developer.apple.com/documentation/naturallanguage/</a>.</p>

<p>There are many pre-trained CoreML compatible models on the web, both from Apple and also from third party (e.g., <a href="https://github.com/likedan/Awesome-CoreML-Models">https://github.com/likedan/Awesome-CoreML-Models</a>).</p>

<p>Apple also provides tools for converting TensorFlow and PyTorch models to be compatible with CoreML <a href="https://coremltools.readme.io/docs">https://coremltools.readme.io/docs</a>.</p>

<h3 id="leanpub-auto-a-simple-wrapper-library-for-apples-nlp-models">A simple Wrapper Library for Apple’s NLP Models</h3>

<p>I will not go into too much detail here but I created a small wrapper library for Apple’s NLP models that will make it easier for you to jump in and have fun experimenting with them: <a href="https://github.com/mark-watson/Nlp_swift">https://github.com/mark-watson/Nlp_swift</a>.</p>

<p>The main library implementation file is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code><code class="kd">import</code> <code class="nc">NaturalLanguage</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="kd">let</code> <code class="nv">tagger</code> <code class="p">=</code> <code class="bp">NSLinguisticTagger</code><code class="p">(</code><code class="n">tagSchemes</code><code class="p">:[.</code><code class="n">tokenType</code><code class="p">,</code> <code class="p">.</code><code class="n">language</code><code class="p">,</code> <code class="p">.</code><code class="n">lexicalClass</code><code class="p">,</code>
<code class="linenos"> 5 </code>    <code class="p">.</code><code class="n">nameType</code><code class="p">,</code> <code class="p">.</code><code class="n">lemma</code><code class="p">],</code> <code class="n">options</code><code class="p">:</code> <code class="mi">0</code><code class="p">)</code> 
<code class="linenos"> 6 </code><code class="kd">let</code> <code class="nv">options</code><code class="p">:</code> <code class="bp">NSLinguisticTagger</code><code class="p">.</code><code class="n">Options</code> <code class="p">=</code> <code class="p">[.</code><code class="n">omitPunctuation</code><code class="p">,</code> <code class="p">.</code><code class="n">omitWhitespace</code><code class="p">,</code>
<code class="linenos"> 7 </code>    <code class="p">.</code><code class="n">joinNames</code><code class="p">]</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">@</code><code class="n">available</code><code class="p">(</code><code class="n">OSX</code> <code class="mf">10.13</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code>
<code class="linenos">10 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getEntities</code><code class="p">(</code><code class="k">for</code> <code class="n">text</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">{</code>
<code class="linenos">11 </code>    <code class="kd">var</code> <code class="nv">words</code><code class="p">:</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">12 </code>    <code class="n">tagger</code><code class="p">.</code><code class="n">string</code> <code class="p">=</code> <code class="n">text</code>
<code class="linenos">13 </code>    <code class="kd">let</code> <code class="nv">range</code> <code class="p">=</code> <code class="n">NSRange</code><code class="p">(</code><code class="n">location</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code> <code class="n">length</code><code class="p">:</code> <code class="n">text</code><code class="p">.</code><code class="n">utf16</code><code class="p">.</code><code class="bp">count</code><code class="p">)</code>
<code class="linenos">14 </code>    <code class="n">tagger</code><code class="p">.</code><code class="n">enumerateTags</code><code class="p">(</code><code class="k">in</code><code class="p">:</code> <code class="n">range</code><code class="p">,</code> <code class="n">unit</code><code class="p">:</code> <code class="p">.</code><code class="n">word</code><code class="p">,</code> <code class="n">scheme</code><code class="p">:</code> <code class="p">.</code><code class="n">nameType</code><code class="p">,</code>
<code class="linenos">15 </code>    <code class="n">options</code><code class="p">:</code> <code class="n">options</code><code class="p">)</code> <code class="p">{</code> <code class="n">tag</code><code class="p">,</code> <code class="n">tokenRange</code><code class="p">,</code> <code class="n">stop</code> <code class="k">in</code>
<code class="linenos">16 </code>        <code class="kd">let</code> <code class="nv">word</code> <code class="p">=</code> <code class="p">(</code><code class="n">text</code> <code class="k">as</code> <code class="bp">NSString</code><code class="p">).</code><code class="n">substring</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">tokenRange</code><code class="p">)</code>
<code class="linenos">17 </code>        <code class="n">words</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">word</code><code class="p">,</code> <code class="n">tag</code><code class="p">?.</code><code class="n">rawValue</code> <code class="p">??</code> <code class="s">"unkown"</code><code class="p">))</code>
<code class="linenos">18 </code>    <code class="p">}</code>
<code class="linenos">19 </code>    <code class="k">return</code> <code class="n">words</code>
<code class="linenos">20 </code><code class="p">}</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="p">@</code><code class="n">available</code><code class="p">(</code><code class="n">OSX</code> <code class="mf">10.13</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code>
<code class="linenos">23 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getLemmas</code><code class="p">(</code><code class="k">for</code> <code class="n">text</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">{</code>
<code class="linenos">24 </code>    <code class="kd">var</code> <code class="nv">words</code><code class="p">:</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">25 </code>    <code class="n">tagger</code><code class="p">.</code><code class="n">string</code> <code class="p">=</code> <code class="n">text</code>
<code class="linenos">26 </code>    <code class="kd">let</code> <code class="nv">range</code> <code class="p">=</code> <code class="n">NSRange</code><code class="p">(</code><code class="n">location</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code> <code class="n">length</code><code class="p">:</code> <code class="n">text</code><code class="p">.</code><code class="n">utf16</code><code class="p">.</code><code class="bp">count</code><code class="p">)</code>
<code class="linenos">27 </code>    <code class="n">tagger</code><code class="p">.</code><code class="n">enumerateTags</code><code class="p">(</code><code class="k">in</code><code class="p">:</code> <code class="n">range</code><code class="p">,</code> <code class="n">unit</code><code class="p">:</code> <code class="p">.</code><code class="n">word</code><code class="p">,</code> <code class="n">scheme</code><code class="p">:</code> <code class="p">.</code><code class="n">lemma</code><code class="p">,</code> 
<code class="linenos">28 </code>            <code class="n">options</code><code class="p">:</code> <code class="n">options</code><code class="p">)</code> <code class="p">{</code> <code class="n">tag</code><code class="p">,</code> <code class="n">tokenRange</code><code class="p">,</code> <code class="n">stop</code> <code class="k">in</code>
<code class="linenos">29 </code>        <code class="kd">let</code> <code class="nv">word</code> <code class="p">=</code> <code class="p">(</code><code class="n">text</code> <code class="k">as</code> <code class="bp">NSString</code><code class="p">).</code><code class="n">substring</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">tokenRange</code><code class="p">)</code>
<code class="linenos">30 </code>        <code class="n">words</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">word</code><code class="p">,</code> <code class="n">tag</code><code class="p">?.</code><code class="n">rawValue</code> <code class="p">??</code> <code class="s">"unkown"</code><code class="p">))</code>
<code class="linenos">31 </code>    <code class="p">}</code>
<code class="linenos">32 </code>    <code class="k">return</code> <code class="n">words</code>
<code class="linenos">33 </code><code class="p">}</code>
</pre></div>

</figure>

<p>Here is some test code:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">let</code> <code class="nv">quote</code> <code class="p">=</code> <code class="s">"President George Bush went to Mexico with IBM representatives. Here's t\</code>
<code class="linenos"> 2 </code><code class="s">o the crazy ones. The misfits. The rebels. The troublemakers. The round pegs in the \</code>
<code class="linenos"> 3 </code><code class="s">square holes. The ones who see things differently. They're not fond of rules. And th\</code>
<code class="linenos"> 4 </code><code class="s">ey have no respect for the status quo. You can quote them, disagree with them, glori\</code>
<code class="linenos"> 5 </code><code class="s">fy or vilify them. About the only thing you can't do is ignore them. Because they ch\</code>
<code class="linenos"> 6 </code><code class="s">ange things. They push the human race forward. And while some may see them as the cr\</code>
<code class="linenos"> 7 </code><code class="s">azy ones, we see genius. Because the people who are crazy enough to think they can c\</code>
<code class="linenos"> 8 </code><code class="s">hange the world, are the ones who do. - Steve Jobs (Founder of Apple Inc.)"</code>
<code class="linenos"> 9 </code><code class="k">if</code> <code class="cp">#available</code><code class="p">(</code><code class="cp">OSX</code> <code class="mf">10.13</code><code class="p">,</code> <code class="o">*</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">10 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">Entities:</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">11 </code>            <code class="bp">print</code><code class="p">(</code><code class="n">getEntities</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">quote</code><code class="p">))</code>
<code class="linenos">12 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">Lemmas:</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">13 </code>            <code class="bp">print</code><code class="p">(</code><code class="n">getLemmas</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">quote</code><code class="p">))</code>
<code class="linenos">14 </code><code class="p">}</code>
</pre></div>

</figure>


<h2 id="leanpub-auto-using-the-openai-apis">Using the OpenAI APIs</h2>

<p>I have been working as an artificial intelligence practitioner since 1982 and the capability of the beta OpenAI APIs is the most impressive thing that I have seen (so far!) in my career. These APIs use the GPT-3 model. You will need to apply to OpenAI for a free API access key. I use their APIs frequently enough in my projects that I am on their paid plan.</p>

<p>I recommend reading the online documentation for the <a href="https://beta.openai.com/docs/introduction/key-concepts">online documentation for the APIs</a> to see all the capabilities of the beta OpenAI APIs.  Let’s start by jumping into the example code that is a GitHub repository <a href="https://github.com/mark-watson/OpenAI_swift">https://github.com/mark-watson/OpenAI_swift</a> that you can use in your projects.</p>

<p>The library that I wrote for this chapter supports three functions: for completing text, summarizing text, and answering general questions. The single OpenAI model that the beta OpenAI APIs use is fairly general purpose and can generate cooking directions when given an ingredient list, grammar correction, write an advertisement from a product description, generate spreadsheet data from data descriptions in English text, etc. </p>

<p>Given the examples from <a href="https://beta.openai.com">https://beta.openai.com</a> and the Clojure examples here, you should be able to modify my example code to use any of the functionality that OpenAI documents.</p>

<p>We will look closely at the function <strong>completions</strong> and then just look at the small differences to the other two example functions. The definitions for all three exported functions are kept in the file <strong>src/openai_api/core.clj</strong>*. You need to request an API key (I had to wait a few weeks to recieve my key) and set the value of the environment variable <strong>OPENAI_KEY</strong> to your key. You can add a statement like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">export</code> <code class="n">OPENAI_KEY</code><code class="o">=</code><code class="n">sa</code><code class="o">-</code><code class="n">hdedds7</code><code class="o">&amp;</code><code class="n">dhdhsdffd</code>
</pre></div>

</figure>

<p>to your <strong>.profile</strong> or other shell resource file that contains your key value (the above key value is made-up and invalid).</p>

<p>While I sometimes use pure Clojure libraries to make HTTP requests, I prefer using the <strong>curl</strong> utility to experiment with API calls from the command line before starting to write any code.</p>

<p>An example <strong>curl</strong> command line call to the beta OpenAI APIs is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>curl <code class="se">\</code>
<code class="linenos">2 </code>  https://api.openai.com/v1/engines/davinci/completions <code class="se">\</code>
<code class="linenos">3 </code>   -H <code class="s2">"Content-Type: application/json"</code>
<code class="linenos">4 </code>   -H <code class="s2">"Authorization: Bearer sa-hdffds7&amp;dhdhsdgffd"</code> <code class="se">\</code>
<code class="linenos">5 </code>   -d <code class="s1">'{"prompt": "The President went to Congress", \</code>
<code class="linenos">6 </code><code class="s1">        "max_tokens": 22}'</code>
</pre></div>

</figure>

<p>Here the API token “sa-hdffds7&amp;dhdhsdgffd” on line 4 is made up - that is not my API token. All of the OpenAI APIs expect JSON data with query parameters. To use the completion API, we set values for <strong>prompt</strong> and <strong>max_tokens</strong>. The value of <strong>max_tokens</strong> is the requested number of returns words or tokens. We will look at several examples later.</p>

<p>In the file <strong>Sources/OpenAI_swift/OpenAI_swift.swift</strong> we start with a helper function <strong>openAiHelper</strong> that takes a string with the OpenAI API call arguments then extracts the results from the returned JSON data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">func</code> <code class="nf">openAiHelper</code><code class="p">(</code><code class="n">body</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code>  <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 2 </code>    <code class="kd">var</code> <code class="nv">ret</code> <code class="p">=</code> <code class="s">""</code>
<code class="linenos"> 3 </code>    <code class="kd">var</code> <code class="nv">content</code> <code class="p">=</code> <code class="s">"{}"</code>
<code class="linenos"> 4 </code>    <code class="kd">let</code> <code class="nv">requestUrl</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="n">openAiHost</code><code class="p">)</code><code class="o">!</code>
<code class="linenos"> 5 </code>    <code class="kd">var</code> <code class="nv">request</code> <code class="p">=</code> <code class="n">URLRequest</code><code class="p">(</code><code class="n">url</code><code class="p">:</code> <code class="n">requestUrl</code><code class="p">)</code>
<code class="linenos"> 6 </code>    <code class="n">request</code><code class="p">.</code><code class="n">httpMethod</code> <code class="p">=</code> <code class="s">"POST"</code>
<code class="linenos"> 7 </code>    <code class="n">request</code><code class="p">.</code><code class="n">httpBody</code> <code class="p">=</code> <code class="n">body</code><code class="p">.</code><code class="n">data</code><code class="p">(</code><code class="n">using</code><code class="p">:</code> <code class="nb">String</code><code class="p">.</code><code class="n">Encoding</code><code class="p">.</code><code class="n">utf8</code><code class="p">);</code>
<code class="linenos"> 8 </code>    <code class="n">request</code><code class="p">.</code><code class="n">setValue</code><code class="p">(</code><code class="s">"application/json"</code><code class="p">,</code> <code class="n">forHTTPHeaderField</code><code class="p">:</code> <code class="s">"Content-Type"</code><code class="p">)</code>
<code class="linenos"> 9 </code>    <code class="n">request</code><code class="p">.</code><code class="n">setValue</code><code class="p">(</code><code class="s">"Bearer "</code> <code class="o">+</code> <code class="n">openai_key</code><code class="p">,</code> <code class="n">forHTTPHeaderField</code><code class="p">:</code> <code class="s">"Authorization"</code><code class="p">)</code>
<code class="linenos">10 </code>    <code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">request</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>
<code class="linenos">11 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>
<code class="linenos">12 </code>            <code class="bp">print</code><code class="p">(</code><code class="s">"--&gt;&gt; Error accessing OpenAI servers: </code><code class="si">\(</code><code class="n">error</code><code class="si">)</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">13 </code>            <code class="k">return</code>
<code class="linenos">14 </code>        <code class="p">}</code>
<code class="linenos">15 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code><code class="p">,</code> <code class="kd">let</code> <code class="nv">s</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">data</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">16 </code>            <code class="n">content</code> <code class="p">=</code> <code class="n">s</code>
<code class="linenos">17 </code>            <code class="n">CFRunLoopStop</code><code class="p">(</code><code class="n">CFRunLoopGetMain</code><code class="p">())</code>
<code class="linenos">18 </code>        <code class="p">}</code>
<code class="linenos">19 </code>    <code class="p">}</code>
<code class="linenos">20 </code>    <code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code>
<code class="linenos">21 </code>    <code class="n">CFRunLoopRun</code><code class="p">()</code>
<code class="linenos">22 </code>    <code class="kd">let</code> <code class="nv">c</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">content</code><code class="p">)</code>
<code class="linenos">23 </code>    <code class="kd">let</code> <code class="nv">i1</code> <code class="p">=</code> <code class="n">c</code><code class="p">.</code><code class="n">range</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"</code><code class="se">\"</code><code class="s">text</code><code class="se">\"</code><code class="s">: "</code><code class="p">)</code>
<code class="linenos">24 </code>    <code class="k">if</code> <code class="kd">let</code> <code class="nv">r1</code> <code class="p">=</code> <code class="n">i1</code> <code class="p">{</code>
<code class="linenos">25 </code>        <code class="kd">let</code> <code class="nv">i2</code> <code class="p">=</code> <code class="n">c</code><code class="p">.</code><code class="n">range</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"</code><code class="se">\"</code><code class="s">index</code><code class="se">\"</code><code class="s">:"</code><code class="p">)</code>
<code class="linenos">26 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">r2</code> <code class="p">=</code> <code class="n">i2</code> <code class="p">{</code>
<code class="linenos">27 </code>            <code class="n">ret</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="n">c</code><code class="p">[</code><code class="n">r1</code><code class="p">.</code><code class="n">lowerBound</code><code class="p">..&lt;</code><code class="n">r2</code><code class="p">.</code><code class="n">lowerBound</code><code class="p">])</code>
<code class="linenos">28 </code>             <code class="p">.</code><code class="bp">dropFirst</code><code class="p">(</code><code class="mi">9</code><code class="p">)).</code><code class="bp">dropLast</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="linenos">29 </code>        <code class="p">}</code>
<code class="linenos">30 </code>    <code class="p">}</code>
<code class="linenos">31 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos">32 </code><code class="p">}</code>
</pre></div>

</figure>

<p>I convert JSON data to a string output by searching for constants “text:” and “index:” instead of using a JSON parser like I do in the later KGN example.</p>

<p>The three example functions all use this <strong>openAiHelper</strong> function. The first example function <strong>completions</strong> sets the parameters to complete a text fragment. You have probably seen examples of the OpenAI GPT-3 model writing stories, given a starting sentence. We are using the same model and functionality here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">completions</code><code class="p">(</code><code class="n">promptText</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">maxTokens</code><code class="p">:</code> <code class="nb">Int</code> <code class="p">=</code> <code class="mi">25</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos">2 </code>    <code class="kd">let</code> <code class="nv">body</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"{</code><code class="se">\"</code><code class="s">prompt</code><code class="se">\"</code><code class="s">: </code><code class="se">\"</code><code class="s">"</code> <code class="o">+</code> <code class="n">promptText</code> <code class="o">+</code> <code class="s">"</code><code class="se">\"</code><code class="s">,</code>
<code class="linenos">3 </code><code class="s">        </code><code class="se">\"</code><code class="s">max_tokens</code><code class="se">\"</code><code class="s">: </code><code class="si">\(</code><code class="n">maxTokens</code><code class="si">)</code><code class="s">"</code> <code class="o">+</code> <code class="s">"}"</code>
<code class="linenos">4 </code>    <code class="k">return</code> <code class="n">openAiHelper</code><code class="p">(</code><code class="n">body</code><code class="p">:</code> <code class="n">body</code><code class="p">)}</code>
</pre></div>

</figure>

<p>Note that the OpenAI models are stochastic. When generating output words (or tokens), the model assigns probabilities to possible words to generate and samples a word using these probabilities. As a simple example, suppose given prompt text “it fell and”, then the model could only generate three words, with probabilities for each word based on this prompt text:</p>

<ul>
  <li>the 0.9</li>
  <li>that 0.1</li>
  <li>a 0.1</li>
</ul>

<p>The model would <em>emit</em> the word <strong>the</strong> 90% of the time, the word <strong>that</strong> 10% of the time, or the word <strong>a</strong> 10% of the time. As a result, the model can generate different completion text for the same text prompt. Let’s look at some examples using the same prompt text. Notice the stochastic nature of the returned results with prompt text ““He walked to the river” passed twice to the OpenAI GPT-3 model:</p>

<p>First example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code> and sat down thinking, the warm evening clotted with insects. The river lapping the<code class="se">\</code>
<code class="linenos">2 </code> bank <code class="k">in</code> the long grass. He
</pre></div>

</figure>

<p>Another example of text completion:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>, the beast running slowly behind him. He looked away from the cave now, using rain <code class="se">\</code>
<code class="linenos">2 </code>and clouds as his curtain to hide
</pre></div>

</figure>

<p>The function <strong>summarize</strong> is very similar to the function <strong>completions</strong> except the JSON data passed to the API has a few additional parameters that let the API know that we want a text summary:</p>

<ul>
  <li>presence_penalty - penalize words found in the original text (we set this to zero)</li>
  <li>temperature - higher values the randomness used to select output tokens. If you set this to zero, then the same prompt text will always yield the same results (I never use a zero value).</li>
  <li>top_p - also affects randomness. All examples I have seen use a value of 1.</li>
  <li>frequency_penalty - penalize using the same words repeatedly (I usually set this to zero, but you should experiment with different values)</li>
</ul>

<p>When summarizing text, try varying the number of generated tokens to get shorter or longer summaries; in the following examples we ask for 24, 90, and 150 output tokens (lines are broken to fit page width):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">summarize</code><code class="p">(</code><code class="n">text</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">maxTokens</code><code class="p">:</code> <code class="nb">Int</code> <code class="p">=</code> <code class="mi">40</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos">2 </code>    <code class="kd">let</code> <code class="nv">body</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"{</code><code class="se">\"</code><code class="s">prompt</code><code class="se">\"</code><code class="s">: </code><code class="se">\"</code><code class="s">"</code> <code class="o">+</code> <code class="n">text</code> <code class="o">+</code> <code class="s">"</code><code class="se">\"</code><code class="s">,</code>
<code class="linenos">3 </code><code class="s">       </code><code class="se">\"</code><code class="s">max_tokens</code><code class="se">\"</code><code class="s">: </code><code class="si">\(</code><code class="n">maxTokens</code><code class="si">)</code><code class="s">, </code><code class="se">\"</code><code class="s">presence_penalty</code><code class="se">\"</code><code class="s">: 0.0, </code><code class="se">\"</code><code class="s">temperature</code><code class="se">\"</code><code class="s">: 0.3,</code>
<code class="linenos">4 </code><code class="s">       </code><code class="se">\"</code><code class="s">top_p</code><code class="se">\"</code><code class="s">: 1.0, </code><code class="se">\"</code><code class="s">frequency_penalty</code><code class="se">\"</code><code class="s">: 0.0}"</code>
<code class="linenos">5 </code>    <code class="k">return</code> <code class="n">openAiHelper</code><code class="p">(</code><code class="n">body</code><code class="p">:</code> <code class="n">body</code><code class="p">)}</code>
</pre></div>

</figure>

<p>Notice the stochastic nature of the returned summarization results with prompt text “Jupiter is the fifth planet from the Sun and the largest in the Solar System. It is a gas giant with a mass one-thousandth that of the Sun, but two-and-a-half times that of all the other planets in the Solar System combined. Jupiter is one of the brightest objects visible to the naked eye in the night sky, and has been known to ancient civilizations since before recorded history. It is named after the Roman god Jupiter.[19] When viewed from Earth, Jupiter can be bright enough for its reflected light to cast visible shadows,[20] and is on average the third-brightest natural object in the night sky after the Moon and Venus.”:</p>

<p>First summarization example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code> Jupiter is a gas giant because it is predominantly composed of hydrogen and
<code class="linenos">2 </code> helium<code class="p">;</code> it has a solid core, but it has no surface. Jupiter is a gas giant
<code class="linenos">3 </code> because it is predominantly composed<code class="s2">"</code>
</pre></div>

</figure>

<p>Another summarization example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>The planet is usually the fourth-brightest <code class="k">in</code> the night sky, after the Sun,
<code class="linenos">2 </code>Venus and the Moon.
<code class="linenos">3 </code>
<code class="linenos">4 </code>Jupiter is a gas giant because it is predominantly composed of hydrogen
</pre></div>

</figure>

<p>The function <strong>answerQuestion</strong> is very similar to the function <strong>summarize</strong> except the JSON data passed to the API has one additional parameter that let the API know that we want a question answered:</p>

<ul>
  <li>stop - The OpenAI API examples use the value: <strong>[\n]</strong>, which is what I use here.</li>
</ul>

<p>We also need to prepend the string “nQ: “ to the prompt text.</p>

<p>Additionally, the model returns a series of answers with the string “nQ:” acting as a delimiter between the answers. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">questionAnsweering</code><code class="p">(</code><code class="n">question</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 2 </code>    <code class="kd">let</code> <code class="nv">body</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"{</code><code class="se">\"</code><code class="s">prompt</code><code class="se">\"</code><code class="s">: </code><code class="se">\"</code><code class="s">nQ: "</code> <code class="o">+</code> <code class="n">question</code> <code class="o">+</code> <code class="s">" nA:</code><code class="se">\"</code><code class="s">, </code><code class="se">\"</code><code class="s">max_tokens</code><code class="se">\"</code><code class="s">: 2\</code>
<code class="linenos"> 3 </code><code class="s">5, </code><code class="se">\"</code><code class="s">presence_penalty</code><code class="se">\"</code><code class="s">: 0.0, </code><code class="se">\"</code><code class="s">temperature</code><code class="se">\"</code><code class="s">: 0.3, </code><code class="se">\"</code><code class="s">top_p</code><code class="se">\"</code><code class="s">: 1.0, </code><code class="se">\"</code><code class="s">frequency_pena\</code>
<code class="linenos"> 4 </code><code class="s">lty</code><code class="se">\"</code><code class="s">: 0.0 , </code><code class="se">\"</code><code class="s">stop</code><code class="se">\"</code><code class="s">: [</code><code class="se">\"\\</code><code class="s">n</code><code class="se">\"</code><code class="s">]}"</code>
<code class="linenos"> 5 </code>    <code class="kd">let</code> <code class="nv">answer</code> <code class="p">=</code> <code class="n">openAiHelper</code><code class="p">(</code><code class="n">body</code><code class="p">:</code> <code class="n">body</code><code class="p">)</code>
<code class="linenos"> 6 </code>    <code class="k">if</code> <code class="kd">let</code> <code class="nv">i1</code> <code class="p">=</code> <code class="n">answer</code><code class="p">.</code><code class="n">range</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"nQ:"</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 7 </code>        <code class="k">return</code> <code class="nb">String</code><code class="p">(</code><code class="n">answer</code><code class="p">[</code><code class="n">answer</code><code class="p">.</code><code class="n">startIndex</code><code class="p">..&lt;</code><code class="n">i1</code><code class="p">.</code><code class="n">lowerBound</code><code class="p">])</code>
<code class="linenos"> 8 </code>        <code class="c1">//return String(answer.prefix(i1.lowerBound))</code>
<code class="linenos"> 9 </code>    <code class="p">}</code>
<code class="linenos">10 </code>    <code class="k">return</code> <code class="n">answer</code><code class="p">}</code>
</pre></div>

</figure>

<p>I strongly urge you to add a debug printout to the question answering code to print the full answer before we check for the delimiter string. For some questions, the OpenAI APIs generate a series of answers that increase in generality. In the example code we just take the most specific answer.</p>

<p>Let’s look at a few question answering examples and we will discuss possible problems and workarounds. The first two examples ask the same question and get back different, but reasonable answers. The third example asks a general question. The GPT-3 model is trained using a massive amount of text from the web which is why it can generate reasonable answers. Here are two examples for answering the question “Where was Leonardo da Vinci born?”:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>In Vinci, Italy.
</pre></div>

</figure>

<p>And another generated output for the same question:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>In Italy.
</pre></div>

</figure>

<p>In addition to reading the beta OpenAI API documentation you might want to read general material on the use of OpenAI’s GPT-3 model. Since the APIs we are using are beta they may change. I will update this chapter and the source code on GitHub if the APIs change.</p>


<h2 id="leanpub-auto-part-3-knowledge-representation-and-data-acquisition">Part 3: Knowledge Representation and Data Acquisition</h2>

<p>In this part we cover:</p>

<ul>
  <li>Introduction to the semantic web and linked data</li>
  <li>A general discussion of Knowledge Representation</li>
  <li>Create Knowledge Graphs from text input</li>
  <li>Knowledge Graph Explorer application</li>
</ul>


<h2 id="leanpub-auto-linked-data-and-the-semantic-web">Linked Data and the Semantic Web</h2>

<p>Tim Berners Lee, James Hendler, and Ora Lassila wrote in 2001 an article for Scientific American where they introduced the term Semantic Web. Here I do not capitalize semantic web and use the similar term linked data somewhat interchangeably with semantic web.</p>

<p>In the same way that the web allows links between related web pages, linked data supports linking associated data on the web together. I view linked data as a relatively simple way to specify relationships between data sources on the web while the semantic web has a much larger vision: the semantic web has the potential to be the entirety of human knowledge represented as data on the web in a form that software agents can work with to answer questions, perform research, and to infer new data from existing data.</p>

<p>While the “web” describes information for human readers, the semantic web is meant to provide structured data for ingestion by software agents. This distinction will be clear as we compare WikiPedia, made for human readers, with DBPedia which uses the info boxes on WikiPedia topics to automatically extract RDF data describing WikiPedia topics. Let’s look at the WikiPedia topic for the town I live in Sedona, Arizona, and show how the info box on the English version of the <a href="https://en.wikipedia.org/wiki/Sedona,_Arizona">WikiPedia topic page for Sedona https://en.wikipedia.org/wiki/Sedona,_Arizona</a> maps to the <a href="http://dbpedia.org/page/Sedona,_Arizona">DBPedia page http://dbpedia.org/page/Sedona,_Arizona</a>. Please open both of these WikiPedia and DBPedia URIs in two browser tabs and keep them open for reference.</p>

<p>I assume that the format of the WikiPedia page is familiar so let’s look at the DBPedia page for Sedona that in human readble form shows the RDF statements with Sedona Arizona as the subject. RDF is used to model and represent data. RDF is defined by three values so an instance of an RDF statement is called a <em>triple</em> with three parts:</p>

<ul>
  <li>subject: a URI (also referred to as a “Resource”)</li>
  <li>property: a URI (also referred to as a “Resource”)</li>
  <li>value: a URI (also referred to as a “Resource”) or a literal value (like a string or a number with optional units)</li>
</ul>

<p>The subject for each Sedona related triple is the above URI for the DBPedia human readable page. The subject and property references in an RDF triple will almost always be a URI that can ground an entity to information on the web. The human readable page for Sedona lists several properties and the values of these properties. One of the properties is “dbo:areaCode” where “dbo” is a name space reference (in this case for a <a href="http://www.w3.org/2002/07/owl#DatatypeProperty">DatatypeProperty</a>).</p>

<p>The following two figures show an abstract representation of linked data and then a sample of linked data with actual web URIs for resources and properties:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 50%">
    <img src="images/rdf1.png" alt="Abstract RDF representation with 2 Resources, 2 literal values, and 3 Properties" style="width: 100%">
    <figcaption>Abstract RDF representation with 2 Resources, 2 literal values, and 3 Properties</figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 75%">
    <img src="images/rdf2.png" alt="Concrete example using RDF seen in last chapter showing the RDF representation with 2 Resources, 2 literal values, and 3 Properties" style="width: 100%">
    <figcaption>Concrete example using RDF seen in last chapter showing the RDF representation with 2 Resources, 2 literal values, and 3 Properties</figcaption>
  </figure>
</div>


<p>We will use the SPARQL query language (SPARQL for RDF data is similar to SQL for relational database queries). Let’s look at an example using the RDF in the last figure:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    "select ?v where { &lt;http://markwatson.com/index.rdf#Sun_ONE&gt;
<code class="linenos">2 </code>                       &lt;http://www.ontoweb.org/ontology/1#booktitle&gt;
<code class="linenos">3 </code>                       ?v }
</pre></div>

</figure>

<p>This query should return the result “Sun ONE Services - J2EE”. If you wanted to query for all URI resources that are books with the literal value of their titles, then you can use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    "select ?s ?v where { ?s
<code class="linenos">2 </code>                          &lt;http://www.ontoweb.org/ontology/1#booktitle&gt;
<code class="linenos">3 </code>                          ?v }
</pre></div>

</figure>

<p>Note that <strong>?s</strong> and <strong>?v</strong> are arbitrary query variable names, here standing for “subject” and “value”. You can use more descriptive variable names like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    "select ?bookURI ?bookTitle where 
<code class="linenos">2 </code>        { ?bookURI
<code class="linenos">3 </code>          &lt;http://www.ontoweb.org/ontology/1#booktitle&gt;
<code class="linenos">4 </code>          ?bookTitle }
</pre></div>

</figure>

<p>We will be diving a little deeper into RDF examples in the next chapter when we write a tool for using RDF data from DBPedia to find information about entities (e.g., people, places, organizations) and the relationships between entities.  For now I want you to understand the idea of RDF statements represented as triples, that web URIs represent things, properties, and sometimes values, and that URIs can be followed manually (often called “dereferencing”) to see what they reference in human readable form.</p>

<h3 id="leanpub-auto-understanding-the-resource-description-framework-rdf">Understanding the Resource Description Framework (RDF)</h3>

<p>Text data on the web has some structure in the form of HTML elements like headers, page titles, anchor links, etc. but this structure is too imprecise for general use by software agents. RDF is a method for encoding structured data in a more precise way.</p>

<p>RDF specifies graph structures and can be serialized for storage  or for service calls in XML, Turtle, N3, and other formats. I like the Turtle format and suggest that you pause reading this book for a few minutes and look at this World Wide Web Consortium Turtle RDF primer at <a href="https://www.w3.org/2007/02/turtle/primer/">https://www.w3.org/2007/02/turtle/primer/</a>.</p>

<h3 id="leanpub-auto-frequently-used-resource-namespaces">Frequently Used Resource Namespaces</h3>

<p>The following standard namespaces are frequently used:</p>

<ul>
  <li>RDF       <a href="https://www.w3.org/TR/rdf-syntax-grammar/">https://www.w3.org/TR/rdf-syntax-grammar/</a>
</li>
  <li>RDFS      <a href="https://www.w3.org/TR/rdf-schema/">https://www.w3.org/TR/rdf-schema/</a>
</li>
  <li>OWL       <a href="http://www.w3.org/2002/07/owl#">http://www.w3.org/2002/07/owl#</a>
</li>
  <li>XSD       <a href="http://www.w3.org/2001/XMLSchema#">http://www.w3.org/2001/XMLSchema#</a>
</li>
  <li>FOAF      <a href="http://xmlns.com/foaf/0.1/">http://xmlns.com/foaf/0.1/</a>
</li>
  <li>SKOS      <a href="http://www.w3.org/2004/02/skos/core#">http://www.w3.org/2004/02/skos/core#</a>
</li>
  <li>DOAP      <a href="http://usefulinc.com/ns/doap#">http://usefulinc.com/ns/doap#</a>
</li>
  <li>DC        <a href="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</a>
</li>
  <li>DCTERMS   <a href="http://purl.org/dc/terms/">http://purl.org/dc/terms/</a>
</li>
  <li>VOID      <a href="http://rdfs.org/ns/void#">http://rdfs.org/ns/void#</a>
</li>
</ul>

<p>Let’s look into the Friend of a Friend (FOAF) namespace. Click on the above link for FOAF <a href="http://xmlns.com/foaf/0.1/">http://xmlns.com/foaf/0.1/</a> and find the definitions for the FOAF Core:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>    Agent
<code class="linenos"> 2 </code>    Person
<code class="linenos"> 3 </code>    name
<code class="linenos"> 4 </code>    title
<code class="linenos"> 5 </code>    img
<code class="linenos"> 6 </code>    depiction (depicts)
<code class="linenos"> 7 </code>    familyName
<code class="linenos"> 8 </code>    givenName
<code class="linenos"> 9 </code>    knows
<code class="linenos">10 </code>    based_near
<code class="linenos">11 </code>    age
<code class="linenos">12 </code>    made (maker)
<code class="linenos">13 </code>    primaryTopic (primaryTopicOf)
<code class="linenos">14 </code>    Project
<code class="linenos">15 </code>    Organization
<code class="linenos">16 </code>    Group
<code class="linenos">17 </code>    member
<code class="linenos">18 </code>    Document
<code class="linenos">19 </code>    Image
</pre></div>

</figure>

<p>and for the Social Web:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>mbox
<code class="linenos"> 2 </code>homepage
<code class="linenos"> 3 </code>weblog
<code class="linenos"> 4 </code>openid
<code class="linenos"> 5 </code>jabberID
<code class="linenos"> 6 </code>mbox_sha1sum
<code class="linenos"> 7 </code>interest
<code class="linenos"> 8 </code>topic_interest
<code class="linenos"> 9 </code>topic (page)
<code class="linenos">10 </code>workplaceHomepage
<code class="linenos">11 </code>workInfoHomepage
<code class="linenos">12 </code>schoolHomepage
<code class="linenos">13 </code>publications
<code class="linenos">14 </code>currentProject
<code class="linenos">15 </code>pastProject
<code class="linenos">16 </code>account
<code class="linenos">17 </code>OnlineAccount
<code class="linenos">18 </code>accountName
<code class="linenos">19 </code>accountServiceHomepage
<code class="linenos">20 </code>PersonalProfileDocument
<code class="linenos">21 </code>tipjar
<code class="linenos">22 </code>sha1
<code class="linenos">23 </code>thumbnail
<code class="linenos">24 </code>logo
</pre></div>

</figure>

<p>You now have seen a few common Schemas for RDF data. Another Schema that is widely used for annotating web sites that we won’t need for our examples here, is <a href="https://schema.org">schema.org</a>.</p>

<h3 id="leanpub-auto-understanding-the-sparql-query-language">Understanding the SPARQL Query Language</h3>

<p>For the purposes of the material in this book, the two sample SPARQL queries here are sufficient for you to get started using my SPARQL library <a href="https://github.com/mark-watson/SparqlQuery_swift">https://github.com/mark-watson/SparqlQuery_swift</a> with arbitrary RDF data sources and simple queries.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/xcode_sparql.png" alt="My Swift SPARQL library open in Xcode" style="width: 100%">
    <figcaption>My Swift SPARQL library open in Xcode</figcaption>
  </figure>
</div>


<p>The Apache Foundation has a <a href="https://jena.apache.org/tutorials/sparql.html">good introduction to SPARQL</a> that I refer you to for more information.</p>

<h3 id="leanpub-auto-semantic-web-and-linked-data-wrap-up">Semantic Web and Linked Data Wrap Up</h3>

<p>In the next chapter we will use natural language processing to extract structured information from raw text from SPARQL queries. We will be using my Swift SPARQL library <a href="https://github.com/mark-watson/SparqlQuery_swift">https://github.com/mark-watson/SparqlQuery_swift</a> as well as two pre-trained CoreML deep learning models.</p>


<h2 id="leanpub-auto-example-application-ios-and-macos-versions-of-my-knowledgebooknavigator">Example Application: iOS and macOS Versions of my KnowledgeBookNavigator</h2>

<p>I used many of the techniques discussed in this book, the Swift language, and the SwiftUI user interface framework to develop Swift version of my Knowledge Graph Navigator application for macOS. I originally wrote this as an example program in Common Lisp for another book project. </p>

<p>The <a href="https://github.com/mark-watson/KGN">GitHub repository for the KGN example is https://github.com/mark-watson/KGN</a>. I copied the code from my stand-alone Swift libraries to this example to make it self contained. The easiest way to browse the source code is to open this project in Xcode.</p>

<p>I submitted the KGN app that we discuss in this chapter to Apple’s store and is available as a macOS app. If you load this project into Xcode, you can also build and run the iOS and iPadOS targets.</p>

<p>You will need to have read through the last chapter on semantic web and linked data technologies to understand this example because quite a lot of the code has embedded SPARQL queries to get information from <a href="https://dbpedia.org">DBPedia.org</a>.</p>

<p>The other major part of this app is a slightly modified version of Apple’s question answering (QA) example using the BERT model in CoreML. Apple’s code is in the subdirectory <strong>AppleBERT</strong>. Please read the README file for this project and follow the directions for downloading and using Apple’s model and vocabulary file.</p>

<h3 id="leanpub-auto-screen-shots-of-macos-application">Screen Shots of macOS Application</h3>

<p>In the first screenshot seen below, I had entered query text that included “Steve Jobs” and the popup list selector is used to let the user select which “Steve Jobs” entity from DBPedia that they want to use.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/KGN1.png" alt='Entered query and KGN is asking user to disambiguate which "Steve Jobs" they want information for' style="width: 100%">
    <figcaption>Entered query and KGN is asking user to disambiguate which “Steve Jobs” they want information for</figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/KGN2.png" alt="Showing results" style="width: 100%">
    <figcaption>Showing results</figcaption>
  </figure>
</div>


<p>The previous screenshot shows the results to the query displayed as English text.</p>

<p>Notice the app prompt “Behind the scenes SPARQL queries” near the bottom of the app window. If you click on this field then the SPARQL queries used to answer the question are shown, as on the next screenshot:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/KGN3.png" alt="Showing SPARQL queries used to gather data" style="width: 100%">
    <figcaption>Showing SPARQL queries used to gather data</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-application-code-listings">Application Code Listings</h3>

<p>I will list some of the code for this example application and I suggest that you, dear reader, also open this project in Xcode in order to navigate the sample code and more carefully read through it.</p>

<h4 id="leanpub-auto-sparql">SPARQL</h4>

<p>I introduced you to the use of SPARQL in the last chapter. This library can be used by adding a reference to the <strong>Project.swift</strong> file for this project. You can also clone <a href="https://github.com/mark-watson/Nlp_swift">the GitHub repository https://github.com/mark-watson/Nlp_swift</a> to have the source code for local viewing and modification and I have copied the code into the KGN project.</p>

<p>The file <strong>SparqlQuery.swift</strong> is shown here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">Array</code><code class="p">&lt;</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;</code><code class="o">&gt;</code> <code class="p">{</code>
<code class="linenos"> 4 </code>    <code class="k">return</code> <code class="n">SparqlEndpointHelpter</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">query</code><code class="p">,</code>
<code class="linenos"> 5 </code>        <code class="n">endPointUri</code><code class="p">:</code> <code class="s">"https://dbpedia.org/sparql?query="</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">sparqlWikidata</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">Array</code><code class="p">&lt;</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;</code><code class="o">&gt;</code> <code class="p">{</code>
<code class="linenos"> 8 </code>    <code class="k">return</code> <code class="n">SparqlEndpointHelpter</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">query</code><code class="p">,</code>
<code class="linenos"> 9 </code>        <code class="n">endPointUri</code><code class="p">:</code>
<code class="linenos">10 </code>          <code class="s">"https://query.wikidata.org/bigdata/namespace/wdq/sparql?query="</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">SparqlEndpointHelpter</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code>
<code class="linenos">13 </code>                                  <code class="n">endPointUri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code>
<code class="linenos">14 </code>                            <code class="nb">Array</code><code class="p">&lt;</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;</code><code class="o">&gt;</code> <code class="p">{</code>
<code class="linenos">15 </code>    <code class="kd">var</code> <code class="nv">ret</code> <code class="p">=</code> <code class="n">Set</code><code class="p">&lt;</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;</code><code class="o">&gt;</code><code class="p">();</code>
<code class="linenos">16 </code>    <code class="kd">var</code> <code class="nv">content</code> <code class="p">=</code> <code class="s">"{}"</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code>    <code class="kd">let</code> <code class="nv">maybeString</code> <code class="p">=</code> <code class="n">cacheLookupQuery7</code><code class="p">(</code><code class="n">key</code><code class="p">:</code> <code class="n">query</code><code class="p">)</code>
<code class="linenos">19 </code>    <code class="k">if</code> <code class="n">maybeString</code><code class="p">?.</code><code class="bp">count</code> <code class="p">??</code> <code class="mi">0</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">20 </code>        <code class="n">content</code> <code class="p">=</code> <code class="n">maybeString</code> <code class="p">??</code> <code class="s">""</code>
<code class="linenos">21 </code>    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">22 </code>        <code class="kd">let</code> <code class="nv">requestUrl</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="nb">String</code><code class="p">(</code><code class="n">endPointUri</code> <code class="o">+</code> <code class="n">query</code><code class="p">.</code><code class="n">addingPercentEncodin</code><code class="err">\</code>
<code class="linenos">23 </code><code class="n">g</code><code class="p">(</code><code class="n">withAllowedCharacters</code><code class="p">:</code>
<code class="linenos">24 </code>          <code class="p">.</code><code class="n">urlHostAllowed</code><code class="p">)</code><code class="o">!</code><code class="p">)</code> <code class="o">+</code> <code class="s">"&amp;format=json"</code><code class="p">)</code><code class="o">!</code>
<code class="linenos">25 </code>        <code class="k">do</code> <code class="p">{</code> <code class="n">content</code> <code class="p">=</code> <code class="k">try</code> <code class="nb">String</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">requestUrl</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos">26 </code>          <code class="k">catch</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">{</code> <code class="bp">print</code><code class="p">(</code><code class="n">error</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos">27 </code>    <code class="p">}</code>
<code class="linenos">28 </code>    <code class="kd">let</code> <code class="nv">json</code> <code class="p">=</code> <code class="k">try</code><code class="p">?</code> <code class="n">JSONSerialization</code><code class="p">.</code><code class="n">jsonObject</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">Data</code><code class="p">(</code><code class="n">content</code><code class="p">.</code><code class="n">utf8</code><code class="p">),</code>
<code class="linenos">29 </code>                                                 <code class="n">options</code><code class="p">:</code> <code class="p">[])</code>
<code class="linenos">30 </code>    <code class="k">if</code> <code class="kd">let</code> <code class="nv">json2</code> <code class="p">=</code> <code class="n">json</code> <code class="k">as</code><code class="p">!</code> <code class="nb">Optional</code><code class="p">&lt;</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code> <code class="nb">Any</code><code class="p">?</code><code class="o">&gt;&gt;</code> <code class="p">{</code>
<code class="linenos">31 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">head</code> <code class="p">=</code> <code class="n">json2</code><code class="p">[</code><code class="s">"head"</code><code class="p">]</code> <code class="k">as</code><code class="p">?</code> <code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code> <code class="nb">Any</code><code class="p">&gt;</code> <code class="p">{</code>
<code class="linenos">32 </code>            <code class="k">if</code> <code class="kd">let</code> <code class="nv">xvars</code> <code class="p">=</code> <code class="n">head</code><code class="p">[</code><code class="s">"vars"</code><code class="p">]</code> <code class="k">as</code><code class="p">!</code> <code class="bp">NSArray</code><code class="p">?</code> <code class="p">{</code>
<code class="linenos">33 </code>                <code class="k">if</code> <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">json2</code><code class="p">[</code><code class="s">"results"</code><code class="p">]</code> <code class="k">as</code><code class="p">?</code> <code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code> <code class="nb">Any</code><code class="p">&gt;</code> <code class="p">{</code>
<code class="linenos">34 </code>                    <code class="k">if</code> <code class="kd">let</code> <code class="nv">bindings</code> <code class="p">=</code> <code class="n">results</code><code class="p">[</code><code class="s">"bindings"</code><code class="p">]</code> <code class="k">as</code><code class="p">!</code> <code class="bp">NSArray</code><code class="p">?</code> <code class="p">{</code>
<code class="linenos">35 </code>                        <code class="k">if</code> <code class="n">bindings</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">36 </code>                            <code class="k">for</code> <code class="n">i</code> <code class="k">in</code> <code class="mf">0.</code><code class="p">..(</code><code class="n">bindings</code><code class="p">.</code><code class="bp">count</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">37 </code>                                <code class="k">if</code> <code class="kd">let</code> <code class="nv">first_binding</code> <code class="p">=</code>
<code class="linenos">38 </code>                                <code class="n">bindings</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="k">as</code><code class="p">?</code> <code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code>
<code class="linenos">39 </code>                                <code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;</code><code class="o">&gt;</code> <code class="p">{</code>
<code class="linenos">40 </code>                                    <code class="kd">var</code> <code class="nv">ret2</code> <code class="p">=</code> <code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;();</code>
<code class="linenos">41 </code>                                    <code class="k">for</code> <code class="n">key</code> <code class="k">in</code> <code class="n">xvars</code> <code class="p">{</code>
<code class="linenos">42 </code>                                        <code class="kd">let</code> <code class="nv">key2</code> <code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="n">key</code> <code class="k">as</code><code class="p">!</code> <code class="nb">String</code>
<code class="linenos">43 </code>                                        <code class="k">if</code> <code class="kd">let</code> <code class="nv">vals</code> <code class="p">=</code> <code class="p">(</code><code class="n">first_binding</code><code class="p">[</code><code class="n">key2</code><code class="p">])</code> <code class="p">{</code>
<code class="linenos">44 </code>                                            <code class="kd">let</code> <code class="nv">vv</code> <code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="n">vals</code><code class="p">[</code><code class="s">"value"</code><code class="p">]</code> <code class="p">??</code> <code class="s">"err2"</code>
<code class="linenos">45 </code>                                            <code class="n">ret2</code><code class="p">[</code><code class="n">key2</code><code class="p">]</code> <code class="p">=</code> <code class="n">vv</code> <code class="p">}</code> <code class="p">}</code>
<code class="linenos">46 </code>                                    <code class="k">if</code> <code class="n">ret2</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">47 </code>                                        <code class="n">ret</code><code class="p">.</code><code class="bp">insert</code><code class="p">(</code><code class="n">ret2</code><code class="p">)</code>
<code class="linenos">48 </code>                                    <code class="p">}}}}}}}}}</code>
<code class="linenos">49 </code>    <code class="k">return</code> <code class="nb">Array</code><code class="p">(</code><code class="n">ret</code><code class="p">)</code> <code class="p">}</code>
</pre></div>

</figure>

<p>The file <strong>QueryCache.swift</strong> contains code written by Khoa Pham (MIT License) that can be found in the GitHub repository <a href="https://github.com/onmyway133/EasyStash">https://github.com/onmyway133/EasyStash</a>. This file is used to cache SPARQL queries and the results. In testing this application I noticed that there were many repeated queries to DBPedia so I decided to cache results. Here is the simple API I added on top of Khoa Pham’s code: </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">//  Created by khoa on 27/05/2019.</code>
<code class="linenos"> 2 </code><code class="c1">//  Copyright © 2019 Khoa Pham. All rights reserved. MIT License.</code>
<code class="linenos"> 3 </code><code class="c1">//  https://github.com/onmyway133/EasyStash</code>
<code class="linenos"> 4 </code><code class="c1">//</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="c1">//      Mark's simple wrapper:</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="kd">var</code> <code class="nv">storage</code><code class="p">:</code> <code class="n">Storage</code><code class="p">?</code> <code class="p">=</code> <code class="kc">nil</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">cacheStoreQuery</code><code class="p">(</code><code class="n">key</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">value</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">13 </code>    <code class="k">do</code> <code class="p">{</code> <code class="k">try</code> <code class="n">storage</code><code class="p">?.</code><code class="n">save</code><code class="p">(</code><code class="n">object</code><code class="p">:</code> <code class="n">value</code><code class="p">,</code> <code class="n">forKey</code><code class="p">:</code> <code class="n">key</code><code class="p">)</code> <code class="p">}</code> <code class="k">catch</code> <code class="p">{}</code>
<code class="linenos">14 </code><code class="p">}</code>
<code class="linenos">15 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">cacheLookupQuery7</code><code class="p">(</code><code class="n">key</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code><code class="p">?</code> <code class="p">{</code>
<code class="linenos">16 </code>    <code class="c1">// optional DEBUG code: clear cache</code>
<code class="linenos">17 </code>    <code class="c1">//do { try storage?.removeAll() } catch { print("ERROR CLEARING CACHE") }</code>
<code class="linenos">18 </code>    <code class="k">do</code> <code class="p">{</code>
<code class="linenos">19 </code>        <code class="k">return</code> <code class="k">try</code> <code class="n">storage</code><code class="p">?.</code><code class="n">load</code><code class="p">(</code><code class="n">forKey</code><code class="p">:</code> <code class="n">key</code><code class="p">,</code> <code class="k">as</code><code class="p">:</code> <code class="nb">String</code><code class="p">.</code><code class="kc">self</code><code class="p">)</code>
<code class="linenos">20 </code>    <code class="p">}</code> <code class="k">catch</code> <code class="p">{</code> <code class="k">return</code> <code class="s">""</code> <code class="p">}</code>
<code class="linenos">21 </code><code class="p">}</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="c1">// remaining code not shown for brevity.</code>
</pre></div>

</figure>

<p>The code in file <strong>GenerateSparql.swift</strong> is used to generate queries for DBPedia. The line-wrapping for embedded SPARQL queries in the next code section is difficult to read so you may want to open the source file in Xcode. Please note that the KGN application prints out the SPARQL queries used to fetch information from DBPedia. The embedded SPARQL query templates used here have variable slots that filled in at runtime to customize the queries.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">//</code>
<code class="linenos">  2 </code><code class="c1">//  GenerateSparql.swift</code>
<code class="linenos">  3 </code><code class="c1">//  KGNbeta1</code>
<code class="linenos">  4 </code><code class="c1">//</code>
<code class="linenos">  5 </code><code class="c1">//  Created by Mark Watson on 2/28/20.</code>
<code class="linenos">  6 </code><code class="c1">//  Copyright © 2021 Mark Watson. All rights reserved.</code>
<code class="linenos">  7 </code><code class="c1">//</code>
<code class="linenos">  8 </code>
<code class="linenos">  9 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos"> 10 </code>
<code class="linenos"> 11 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">uri_to_display_text</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code>
<code class="linenos"> 12 </code>                                     <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 13 </code>    <code class="k">return</code> <code class="n">uri</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"http://dbpedia.org/resource/Category/"</code><code class="p">,</code>
<code class="linenos"> 14 </code>        <code class="n">with</code><code class="p">:</code> <code class="s">""</code><code class="p">).</code>
<code class="linenos"> 15 </code>      <code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"http://dbpedia.org/resource/"</code><code class="p">,</code>
<code class="linenos"> 16 </code>        <code class="n">with</code><code class="p">:</code> <code class="s">""</code><code class="p">).</code>
<code class="linenos"> 17 </code>         <code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"_"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="s">" "</code><code class="p">)</code>
<code class="linenos"> 18 </code><code class="p">}</code>
<code class="linenos"> 19 </code>
<code class="linenos"> 20 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">get_SPARQL_for_finding_URIs_for_PERSON_NAME</code><code class="p">(</code><code class="n">nameString</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code>
<code class="linenos"> 21 </code>                                              <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 22 </code>    <code class="k">return</code>
<code class="linenos"> 23 </code>        <code class="s">"# SPARQL to find all URIs for name: "</code> <code class="o">+</code>
<code class="linenos"> 24 </code>        <code class="n">nameString</code> <code class="o">+</code> <code class="s">"</code><code class="se">\n</code><code class="s">SELECT DISTINCT ?person_uri ?comment {</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 25 </code>        <code class="s">"  ?person_uri &lt;http://xmlns.com/foaf/0.1/name&gt; </code><code class="se">\"</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 26 </code>        <code class="n">nameString</code> <code class="o">+</code> <code class="s">"</code><code class="se">\"</code><code class="s">@en .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 27 </code>        <code class="s">"  OPTIONAL { ?person_uri &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 28 </code>        <code class="s">"     ?comment . FILTER (lang(?comment) = 'en') } .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 29 </code>        <code class="s">"} LIMIT 10</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 30 </code><code class="p">}</code>
<code class="linenos"> 31 </code>
<code class="linenos"> 32 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">get_SPARQL_for_PERSON_URI</code><code class="p">(</code><code class="n">aURI</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 33 </code>    <code class="k">return</code>
<code class="linenos"> 34 </code>        <code class="s">"# &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt;</code><code class="se">\n</code><code class="s">SELECT DISTINCT ?comment (GROUP_CONCAT(DISTINCT ?birthpla\</code>
<code class="linenos"> 35 </code><code class="s">ce; SEPARATOR=' | ') AS ?birthplace)</code><code class="se">\n</code><code class="s">  (GROUP_CONCAT(DISTINCT ?almamater; SEPARATOR\</code>
<code class="linenos"> 36 </code><code class="s">=' | ') AS ?almamater) (GROUP_CONCAT(DISTINCT ?spouse; SEPARATOR=' | ') AS ?spouse) \</code>
<code class="linenos"> 37 </code><code class="s">{</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 38 </code>        <code class="s">"  &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt; &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .\</code>
<code class="linenos"> 39 </code><code class="s"> FILTER  (lang(?comment) = 'en') .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 40 </code>        <code class="s">"  OPTIONAL { &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt; &lt;http://dbpedia.org/ontology/birthPlace&gt; ?birth\</code>
<code class="linenos"> 41 </code><code class="s">place } .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 42 </code>        <code class="s">"  OPTIONAL { &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt; &lt;http://dbpedia.org/ontology/almaMater&gt; ?almama\</code>
<code class="linenos"> 43 </code><code class="s">ter } .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 44 </code>        <code class="s">"  OPTIONAL { &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt; &lt;http://dbpedia.org/ontology/spouse&gt; ?spouse } \</code>
<code class="linenos"> 45 </code><code class="s">.</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 46 </code>        <code class="s">"} LIMIT 5</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 47 </code><code class="p">}</code>
<code class="linenos"> 48 </code>
<code class="linenos"> 49 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">get_display_text_for_PERSON_URI</code><code class="p">(</code><code class="n">personURI</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 50 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"</code><code class="si">\(</code><code class="n">uri_to_display_text</code><code class="si">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">personURI</code><code class="si">))</code><code class="se">\n\n</code><code class="s">"</code>
<code class="linenos"> 51 </code>    <code class="kd">let</code> <code class="nv">person_details_sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_PERSON_URI</code><code class="p">(</code><code class="n">aURI</code><code class="p">:</code> <code class="n">personURI</code><code class="p">)</code>
<code class="linenos"> 52 </code>    <code class="kd">let</code> <code class="nv">person_details</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">person_details_sparql</code><code class="p">)</code>
<code class="linenos"> 53 </code>    
<code class="linenos"> 54 </code>    <code class="k">for</code> <code class="n">pd</code> <code class="k">in</code> <code class="n">person_details</code> <code class="p">{</code>
<code class="linenos"> 55 </code>        <code class="c1">//let comment = pd["comment"]</code>
<code class="linenos"> 56 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"</code><code class="si">\(</code><code class="n">pd</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="si">)</code><code class="se">\n\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos"> 57 </code>        <code class="kd">let</code> <code class="nv">subject_uris</code> <code class="p">=</code> <code class="n">pd</code><code class="p">[</code><code class="s">"subject_uris"</code><code class="p">]</code>
<code class="linenos"> 58 </code>        <code class="kd">let</code> <code class="nv">uri_list</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="n">subject_uris</code><code class="p">?.</code><code class="n">components</code><code class="p">(</code><code class="n">separatedBy</code><code class="p">:</code> <code class="s">" | "</code><code class="p">)</code> <code class="p">??</code> <code class="p">[]</code>
<code class="linenos"> 59 </code>        <code class="c1">//ret.append("&lt;ul&gt;\n")</code>
<code class="linenos"> 60 </code>        <code class="k">for</code> <code class="n">u</code> <code class="k">in</code> <code class="n">uri_list</code> <code class="p">{</code>
<code class="linenos"> 61 </code>            <code class="kd">let</code> <code class="nv">subject</code> <code class="p">=</code> <code class="n">uri_to_display_text</code><code class="p">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">u</code><code class="p">)</code>
<code class="linenos"> 62 </code>            <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"</code><code class="si">\(</code><code class="n">subject</code><code class="si">)</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos"> 63 </code>        <code class="c1">//ret.append("&lt;/ul&gt;\n")</code>
<code class="linenos"> 64 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">spouse</code> <code class="p">=</code> <code class="n">pd</code><code class="p">[</code><code class="s">"spouse"</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 65 </code>            <code class="k">if</code> <code class="n">spouse</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos"> 66 </code>                <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"Spouse: </code><code class="si">\(</code><code class="n">uri_to_display_text</code><code class="si">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">spouse</code><code class="si">))</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code> <code class="p">}</code> <code class="p">}</code>
<code class="linenos"> 67 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">almamater</code> <code class="p">=</code> <code class="n">pd</code><code class="p">[</code><code class="s">"almamater"</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 68 </code>            <code class="k">if</code> <code class="n">almamater</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos"> 69 </code>                <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"Almamater: </code><code class="si">\(</code><code class="n">uri_to_display_text</code><code class="si">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">almamater</code><code class="si">))</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code> <code class="p">}</code> <code class="p">}</code>
<code class="linenos"> 70 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">birthplace</code> <code class="p">=</code> <code class="n">pd</code><code class="p">[</code><code class="s">"birthplace"</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 71 </code>            <code class="k">if</code> <code class="n">birthplace</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos"> 72 </code>                <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"Birthplace: </code><code class="si">\(</code><code class="n">uri_to_display_text</code><code class="si">(</code><code class="n">uri</code><code class="p">:</code> <code class="n">birthplace</code><code class="si">))</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code> <code class="err">\</code>
<code class="linenos"> 73 </code><code class="p">}</code> <code class="p">}</code>
<code class="linenos"> 74 </code>    <code class="p">}</code>
<code class="linenos"> 75 </code>    <code class="k">return</code> <code class="p">[</code><code class="s">"# SPARQL for a specific person:</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code> <code class="n">person_details_sparql</code><code class="p">,</code> <code class="n">ret</code><code class="p">]</code>
<code class="linenos"> 76 </code><code class="p">}</code>
<code class="linenos"> 77 </code>
<code class="linenos"> 78 </code><code class="c1">//     "  ?place_uri &lt;http://xmlns.com/foaf/0.1/name&gt; \"" + placeString + "\"@en .\n\</code>
<code class="linenos"> 79 </code><code class="s">" +</code>
<code class="linenos"> 80 </code>
<code class="linenos"> 81 </code><code class="s">public func get_SPARQL_for_finding_URIs_for_PLACE_NAME(placeString: String)</code>
<code class="linenos"> 82 </code><code class="s">                                               -&gt; String {</code>
<code class="linenos"> 83 </code><code class="s">    return</code>
<code class="linenos"> 84 </code><code class="s">        "</code><code class="p">#</code> <code class="s">" + placeString + "</code><code class="err">\</code><code class="n">nSELECT</code> <code class="n">DISTINCT</code> <code class="p">?</code><code class="n">place_uri</code> <code class="p">?</code><code class="n">comment</code> <code class="p">{</code><code class="err">\</code><code class="n">n</code><code class="s">" +</code>
<code class="linenos"> 85 </code><code class="s">        "</code>  <code class="p">?</code><code class="n">place_uri</code> <code class="n">rdfs</code><code class="p">:</code><code class="n">label</code> <code class="err">\</code><code class="s">""</code> <code class="o">+</code> <code class="n">placeString</code> <code class="o">+</code> <code class="s">"</code><code class="se">\"</code><code class="s">@en .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 86 </code>        <code class="s">"  ?place_uri &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;http://sche\</code>
<code class="linenos"> 87 </code><code class="s">ma.org/Place&gt; .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 88 </code>        <code class="s">"  OPTIONAL { ?place_uri &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 89 </code>        <code class="s">"     ?comment . FILTER (lang(?comment) = 'en') } .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 90 </code>        <code class="s">"} LIMIT 10</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos"> 91 </code><code class="p">}</code>
<code class="linenos"> 92 </code>
<code class="linenos"> 93 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">get_SPARQL_for_PLACE_URI</code><code class="p">(</code><code class="n">aURI</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 94 </code>    <code class="k">return</code>
<code class="linenos"> 95 </code>        <code class="s">"# &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt;</code><code class="se">\n</code><code class="s">SELECT DISTINCT ?comment (GROUP_CONCAT(DISTINCT ?subject_\</code>
<code class="linenos"> 96 </code><code class="s">uris; SEPARATOR=' | ') AS ?subject_uris) {</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 97 </code>        <code class="s">"  &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt; &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .\</code>
<code class="linenos"> 98 </code><code class="s"> FILTER  (lang(?comment) = 'en') .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos"> 99 </code>        <code class="s">"  OPTIONAL { &lt;"</code> <code class="o">+</code> <code class="n">aURI</code> <code class="o">+</code> <code class="s">"&gt; &lt;http://purl.org/dc/terms/subject&gt; ?subject_uri\</code>
<code class="linenos">100 </code><code class="s">s } .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos">101 </code>        <code class="s">"} LIMIT 5</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">102 </code><code class="p">}</code>
<code class="linenos">103 </code>
<code class="linenos">104 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">get_HTML_for_place_URI</code><code class="p">(</code><code class="n">placeURI</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos">105 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">"&lt;h2&gt;"</code> <code class="o">+</code> <code class="n">placeURI</code> <code class="o">+</code> <code class="s">"&lt;/h2&gt;</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">106 </code>    <code class="kd">let</code> <code class="nv">place_details_sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_PLACE_URI</code><code class="p">(</code><code class="n">aURI</code><code class="p">:</code> <code class="n">placeURI</code><code class="p">)</code>
<code class="linenos">107 </code>    <code class="kd">let</code> <code class="nv">place_details</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">place_details_sparql</code><code class="p">)</code>
<code class="linenos">108 </code>    
<code class="linenos">109 </code>    <code class="k">for</code> <code class="n">pd</code> <code class="k">in</code> <code class="n">place_details</code> <code class="p">{</code>
<code class="linenos">110 </code>        <code class="c1">//let comment = pd["comment"]</code>
<code class="linenos">111 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"&lt;p&gt;&lt;strong&gt;</code><code class="si">\(</code><code class="n">pd</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="si">)</code><code class="s">&lt;/strong&gt;&lt;/p&gt;</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">112 </code>        <code class="kd">let</code> <code class="nv">subject_uris</code> <code class="p">=</code> <code class="n">pd</code><code class="p">[</code><code class="s">"subject_uris"</code><code class="p">]</code>
<code class="linenos">113 </code>        <code class="kd">let</code> <code class="nv">uri_list</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="n">subject_uris</code><code class="p">?.</code><code class="n">components</code><code class="p">(</code><code class="n">separatedBy</code><code class="p">:</code> <code class="s">" | "</code><code class="p">)</code> <code class="p">??</code> <code class="p">[]</code>
<code class="linenos">114 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"&lt;ul&gt;</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">115 </code>        <code class="k">for</code> <code class="n">u</code> <code class="k">in</code> <code class="n">uri_list</code> <code class="p">{</code>
<code class="linenos">116 </code>            <code class="kd">let</code> <code class="nv">subject</code> <code class="p">=</code> <code class="n">u</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"http://dbpedia.org/resource/Ca\</code>
<code class="linenos">117 </code><code class="s">tegory:"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="s">""</code><code class="p">).</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"_"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="s">" "</code><code class="p">).</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="err">\</code>
<code class="linenos">118 </code><code class="p">:</code> <code class="s">"-"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="s">" "</code><code class="p">)</code>
<code class="linenos">119 </code>            <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"  &lt;li&gt;</code><code class="si">\(</code><code class="n">subject</code><code class="si">)</code><code class="s">&lt;/li&gt;</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">120 </code>        <code class="p">}</code>
<code class="linenos">121 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="s">"&lt;/ul&gt;</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">122 </code>    <code class="p">}</code>
<code class="linenos">123 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos">124 </code><code class="p">}</code>
<code class="linenos">125 </code>
<code class="linenos">126 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">get_SPARQL_for_finding_URIs_for_ORGANIZATION_NAME</code><code class="p">(</code><code class="n">orgString</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="err">\</code>
<code class="linenos">127 </code><code class="nb">String</code> <code class="p">{</code>
<code class="linenos">128 </code>    <code class="k">return</code>
<code class="linenos">129 </code>        <code class="s">"# "</code> <code class="o">+</code> <code class="n">orgString</code> <code class="o">+</code> <code class="s">"</code><code class="se">\n</code><code class="s">SELECT DISTINCT ?org_uri ?comment {</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos">130 </code>        <code class="s">"  ?org_uri rdfs:label </code><code class="se">\"</code><code class="s">"</code> <code class="o">+</code> <code class="n">orgString</code> <code class="o">+</code> <code class="s">"</code><code class="se">\"</code><code class="s">@en .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos">131 </code>        <code class="s">"  ?org_uri &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;http://schema\</code>
<code class="linenos">132 </code><code class="s">.org/Organization&gt; .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos">133 </code>        <code class="s">"  OPTIONAL { ?org_uri &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos">134 </code>        <code class="s">"     ?comment . FILTER (lang(?comment) = 'en') } .</code><code class="se">\n</code><code class="s">"</code> <code class="o">+</code>
<code class="linenos">135 </code>        <code class="s">"} LIMIT 2</code><code class="se">\n</code><code class="s">"</code>
<code class="linenos">136 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The file <strong>AppSparql</strong> contains more utility functions for getting entity and relationship data from DBPedia:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">//  AppSparql.swift</code>
<code class="linenos">  2 </code><code class="c1">//  Created by ML Watson on 7/18/21.</code>
<code class="linenos">  3 </code>
<code class="linenos">  4 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos">  5 </code>
<code class="linenos">  6 </code><code class="kd">let</code> <code class="nv">detailSparql</code> <code class="p">=</code> <code class="s">"""</code>
<code class="linenos">  7 </code><code class="s">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code>
<code class="linenos">  8 </code><code class="s">select ?entity ?label ?description ?comment where {</code>
<code class="linenos">  9 </code><code class="s">    ?entity rdfs:label "</code><code class="p">&lt;</code><code class="n">name</code><code class="p">&gt;</code><code class="s">"@en .</code>
<code class="linenos"> 10 </code><code class="s">    ?entity schema:description ?description . filter (lang(?description) = 'en') . f\</code>
<code class="linenos"> 11 </code><code class="s">ilter(!regex(?description,"</code><code class="n">Wikimedia</code> <code class="n">disambiguation</code> <code class="n">page</code><code class="s">")) .</code>
<code class="linenos"> 12 </code><code class="s"> } limit 5000</code>
<code class="linenos"> 13 </code><code class="s">"""</code>
<code class="linenos"> 14 </code>
<code class="linenos"> 15 </code><code class="kd">let</code> <code class="nv">personSparql</code> <code class="p">=</code> <code class="s">"""</code>
<code class="linenos"> 16 </code><code class="s">  select ?uri ?comment {</code>
<code class="linenos"> 17 </code><code class="s">      ?uri &lt;http://xmlns.com/foaf/0.1/name&gt; "</code><code class="p">&lt;</code><code class="n">name</code><code class="p">&gt;</code><code class="s">"@en .</code>
<code class="linenos"> 18 </code><code class="s">      ?uri &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .</code>
<code class="linenos"> 19 </code><code class="s">          FILTER  (lang(?comment) = 'en') .</code>
<code class="linenos"> 20 </code><code class="s">  }</code>
<code class="linenos"> 21 </code><code class="s">"""</code>
<code class="linenos"> 22 </code>
<code class="linenos"> 23 </code>
<code class="linenos"> 24 </code><code class="kd">let</code> <code class="nv">personDetailSparql</code> <code class="p">=</code> <code class="s">"""</code>
<code class="linenos"> 25 </code><code class="s">SELECT DISTINCT ?label ?comment</code>
<code class="linenos"> 26 </code><code class="s">                     </code>
<code class="linenos"> 27 </code><code class="s">     (GROUP_CONCAT (DISTINCT ?birthplace; SEPARATOR=' | ') AS ?birthplace)</code>
<code class="linenos"> 28 </code><code class="s">     (GROUP_CONCAT (DISTINCT ?almamater; SEPARATOR=' | ') AS ?almamater)</code>
<code class="linenos"> 29 </code><code class="s">     (GROUP_CONCAT (DISTINCT ?spouse; SEPARATOR=' | ') AS ?spouse) {</code>
<code class="linenos"> 30 </code><code class="s">       &lt;name&gt; &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .</code>
<code class="linenos"> 31 </code><code class="s">       FILTER  (lang(?comment) = 'en') .</code>
<code class="linenos"> 32 </code><code class="s">     OPTIONAL { &lt;name&gt; &lt;http://dbpedia.org/ontology/birthPlace&gt; ?birthplace } .</code>
<code class="linenos"> 33 </code><code class="s">     OPTIONAL { &lt;name&gt; &lt;http://dbpedia.org/ontology/almaMater&gt; ?almamater } .</code>
<code class="linenos"> 34 </code><code class="s">     OPTIONAL { &lt;name&gt; &lt;http://dbpedia.org/ontology/spouse&gt; ?spouse } .</code>
<code class="linenos"> 35 </code><code class="s">     OPTIONAL { &lt;name&gt;  &lt;http://www.w3.org/2000/01/rdf-schema#label&gt; ?label .</code>
<code class="linenos"> 36 </code><code class="s">        FILTER  (lang(?label) = 'en') }</code>
<code class="linenos"> 37 </code><code class="s">} LIMIT 10</code>
<code class="linenos"> 38 </code><code class="s">"""</code>
<code class="linenos"> 39 </code>
<code class="linenos"> 40 </code><code class="kd">let</code> <code class="nv">placeSparql</code> <code class="p">=</code> <code class="s">"""</code>
<code class="linenos"> 41 </code><code class="s">SELECT DISTINCT ?uri ?comment WHERE {</code>
<code class="linenos"> 42 </code><code class="s">   ?uri rdfs:label "</code><code class="p">&lt;</code><code class="n">name</code><code class="p">&gt;</code><code class="s">"@en .</code>
<code class="linenos"> 43 </code><code class="s">   ?uri &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .</code>
<code class="linenos"> 44 </code><code class="s">   FILTER (lang(?comment) = 'en') .</code>
<code class="linenos"> 45 </code><code class="s">   ?place &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;http://schema.org/Place\</code>
<code class="linenos"> 46 </code><code class="s">&gt; .</code>
<code class="linenos"> 47 </code><code class="s">} LIMIT 80</code>
<code class="linenos"> 48 </code><code class="s">"""</code>
<code class="linenos"> 49 </code>
<code class="linenos"> 50 </code><code class="kd">let</code> <code class="nv">organizationSparql</code> <code class="p">=</code> <code class="s">"""</code>
<code class="linenos"> 51 </code><code class="s">SELECT DISTINCT ?uri ?comment WHERE {</code>
<code class="linenos"> 52 </code><code class="s">   ?uri rdfs:label "</code><code class="p">&lt;</code><code class="n">name</code><code class="p">&gt;</code><code class="s">"@en .</code>
<code class="linenos"> 53 </code><code class="s">   ?uri &lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;  ?comment .</code>
<code class="linenos"> 54 </code><code class="s">   FILTER (lang(?comment) = 'en') .</code>
<code class="linenos"> 55 </code><code class="s">   ?uri &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; &lt;http://schema.org/Organiz\</code>
<code class="linenos"> 56 </code><code class="s">ation&gt; .</code>
<code class="linenos"> 57 </code><code class="s">} LIMIT 80</code>
<code class="linenos"> 58 </code><code class="s">"""</code>
<code class="linenos"> 59 </code>
<code class="linenos"> 60 </code><code class="kd">func</code> <code class="nf">entityDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">{</code>
<code class="linenos"> 61 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 62 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">detailSparql</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;name&gt;"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos"> 63 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 64 </code>    <code class="kd">let</code> <code class="nv">r</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 65 </code>    <code class="n">r</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">result</code> <code class="k">in</code>
<code class="linenos"> 66 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos"> 67 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos"> 68 </code>    <code class="p">}</code>
<code class="linenos"> 69 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos"> 70 </code><code class="p">}</code>
<code class="linenos"> 71 </code>
<code class="linenos"> 72 </code><code class="kd">func</code> <code class="nf">personDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">{</code>
<code class="linenos"> 73 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 74 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">personSparql</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;name&gt;"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos"> 75 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 76 </code>    <code class="kd">let</code> <code class="nv">r</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 77 </code>    <code class="n">r</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">result</code> <code class="k">in</code>
<code class="linenos"> 78 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos"> 79 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos"> 80 </code>    <code class="p">}</code>
<code class="linenos"> 81 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos"> 82 </code><code class="p">}</code>
<code class="linenos"> 83 </code>
<code class="linenos"> 84 </code><code class="kd">func</code> <code class="nf">placeDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">{</code>
<code class="linenos"> 85 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 86 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">placeSparql</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;name&gt;"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos"> 87 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 88 </code>    <code class="kd">let</code> <code class="nv">r</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 89 </code>    <code class="n">r</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">result</code> <code class="k">in</code>
<code class="linenos"> 90 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos"> 91 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos"> 92 </code>    <code class="p">}</code>
<code class="linenos"> 93 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos"> 94 </code><code class="p">}</code>
<code class="linenos"> 95 </code>
<code class="linenos"> 96 </code><code class="kd">func</code> <code class="nf">organizationDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">{</code>
<code class="linenos"> 97 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">Dictionary</code><code class="p">&lt;</code><code class="nb">String</code><code class="p">,</code><code class="nb">String</code><code class="p">&gt;]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 98 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">organizationSparql</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;name&gt;"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="n">name</code><code class="p">)</code>
<code class="linenos"> 99 </code>    <code class="bp">print</code><code class="p">(</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos">100 </code>    <code class="kd">let</code> <code class="nv">r</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos">101 </code>    <code class="n">r</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">result</code> <code class="k">in</code>
<code class="linenos">102 </code>        <code class="bp">print</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos">103 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>
<code class="linenos">104 </code>    <code class="p">}</code>
<code class="linenos">105 </code>    <code class="k">return</code> <code class="n">ret</code>
<code class="linenos">106 </code><code class="p">}</code>
<code class="linenos">107 </code>
<code class="linenos">108 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">processEntities</code><code class="p">(</code><code class="n">inputString</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[(</code><code class="n">name</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">type</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">ur</code><code class="err">\</code>
<code class="linenos">109 </code><code class="n">i</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">comment</code><code class="p">:</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">{</code>
<code class="linenos">110 </code>    <code class="kd">let</code> <code class="nv">entities</code> <code class="p">=</code> <code class="n">getEntities</code><code class="p">(</code><code class="n">text</code><code class="p">:</code> <code class="n">inputString</code><code class="p">)</code>
<code class="linenos">111 </code>    <code class="kd">var</code> <code class="nv">augmentedEntities</code><code class="p">:</code> <code class="p">[(</code><code class="n">name</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">type</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">comment</code><code class="p">:</code> <code class="n">Strin</code><code class="err">\</code>
<code class="linenos">112 </code><code class="n">g</code><code class="p">)]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">113 </code>    <code class="k">for</code> <code class="p">(</code><code class="n">entityName</code><code class="p">,</code> <code class="n">entityType</code><code class="p">)</code> <code class="k">in</code> <code class="n">entities</code> <code class="p">{</code>
<code class="linenos">114 </code>        <code class="bp">print</code><code class="p">(</code><code class="s">"** entityName:"</code><code class="p">,</code> <code class="n">entityName</code><code class="p">,</code> <code class="s">"entityType:"</code><code class="p">,</code> <code class="n">entityType</code><code class="p">)</code>
<code class="linenos">115 </code>        <code class="k">if</code> <code class="n">entityType</code> <code class="p">==</code> <code class="s">"PersonalName"</code> <code class="p">{</code>
<code class="linenos">116 </code>            <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">personDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="n">entityName</code><code class="p">)</code>
<code class="linenos">117 </code>            <code class="k">for</code> <code class="n">d</code> <code class="k">in</code> <code class="n">data</code> <code class="p">{</code>
<code class="linenos">118 </code>                <code class="n">augmentedEntities</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">name</code><code class="p">:</code> <code class="n">entityName</code><code class="p">,</code> <code class="n">type</code><code class="p">:</code> <code class="n">entityType</code><code class="p">,</code>
<code class="linenos">119 </code>                    <code class="n">uri</code><code class="p">:</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">d</code><code class="p">[</code><code class="s">"uri"</code><code class="p">]</code><code class="o">!</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">,</code> <code class="n">comment</code><code class="p">:</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">d</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code><code class="o">!</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">))</code>
<code class="linenos">120 </code>            <code class="p">}</code>
<code class="linenos">121 </code>        <code class="p">}</code>
<code class="linenos">122 </code>        <code class="k">if</code> <code class="n">entityType</code> <code class="p">==</code> <code class="s">"OrganizationName"</code> <code class="p">{</code>
<code class="linenos">123 </code>            <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">organizationDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="n">entityName</code><code class="p">)</code>
<code class="linenos">124 </code>            <code class="k">for</code> <code class="n">d</code> <code class="k">in</code> <code class="n">data</code> <code class="p">{</code>
<code class="linenos">125 </code>                <code class="n">augmentedEntities</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">name</code><code class="p">:</code> <code class="n">entityName</code><code class="p">,</code> <code class="n">type</code><code class="p">:</code> <code class="n">entityType</code><code class="p">,</code>
<code class="linenos">126 </code>                    <code class="n">uri</code><code class="p">:</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">d</code><code class="p">[</code><code class="s">"uri"</code><code class="p">]</code><code class="o">!</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">,</code> <code class="n">comment</code><code class="p">:</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">d</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code><code class="o">!</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">))</code>
<code class="linenos">127 </code>            <code class="p">}</code>
<code class="linenos">128 </code>        <code class="p">}</code>
<code class="linenos">129 </code>        <code class="k">if</code> <code class="n">entityType</code> <code class="p">==</code> <code class="s">"PlaceName"</code> <code class="p">{</code>
<code class="linenos">130 </code>            <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">placeDetail</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="n">entityName</code><code class="p">)</code>
<code class="linenos">131 </code>            <code class="k">for</code> <code class="n">d</code> <code class="k">in</code> <code class="n">data</code> <code class="p">{</code>
<code class="linenos">132 </code>                <code class="n">augmentedEntities</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">name</code><code class="p">:</code> <code class="n">entityName</code><code class="p">,</code> <code class="n">type</code><code class="p">:</code> <code class="n">entityType</code><code class="p">,</code>
<code class="linenos">133 </code>                    <code class="n">uri</code><code class="p">:</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">d</code><code class="p">[</code><code class="s">"uri"</code><code class="p">]</code><code class="o">!</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">,</code> <code class="n">comment</code><code class="p">:</code> <code class="s">"&lt;"</code> <code class="o">+</code> <code class="n">d</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code><code class="o">!</code> <code class="o">+</code> <code class="s">"&gt;"</code><code class="p">))</code>
<code class="linenos">134 </code>            <code class="p">}</code>
<code class="linenos">135 </code>        <code class="p">}</code>
<code class="linenos">136 </code>    <code class="p">}</code>
<code class="linenos">137 </code>    <code class="k">return</code> <code class="n">augmentedEntities</code>
<code class="linenos">138 </code><code class="p">}</code>
<code class="linenos">139 </code>
<code class="linenos">140 </code>
<code class="linenos">141 </code><code class="kd">extension</code> <code class="nc">Array</code> <code class="k">where</code> <code class="n">Element</code><code class="p">:</code> <code class="nb">Hashable</code> <code class="p">{</code>
<code class="linenos">142 </code>    <code class="kd">func</code> <code class="nf">uniqueValuesHelper</code><code class="p">()</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="n">Element</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">143 </code>        <code class="kd">var</code> <code class="nv">addedDict</code> <code class="p">=</code> <code class="p">[</code><code class="n">Element</code><code class="p">:</code> <code class="nb">Bool</code><code class="p">]()</code>
<code class="linenos">144 </code>        <code class="k">return</code> <code class="bp">filter</code> <code class="p">{</code> <code class="n">addedDict</code><code class="p">.</code><code class="n">updateValue</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="n">forKey</code><code class="p">:</code> <code class="nv">$0</code><code class="p">)</code> <code class="p">==</code> <code class="kc">nil</code> <code class="p">}</code>
<code class="linenos">145 </code>    <code class="p">}</code>
<code class="linenos">146 </code>    <code class="kr">mutating</code> <code class="kd">func</code> <code class="nf">uniqueValues</code><code class="p">()</code> <code class="p">{</code>
<code class="linenos">147 </code>        <code class="kc">self</code> <code class="p">=</code> <code class="kc">self</code><code class="p">.</code><code class="n">uniqueValuesHelper</code><code class="p">()</code>
<code class="linenos">148 </code>    <code class="p">}</code>
<code class="linenos">149 </code><code class="p">}</code>
<code class="linenos">150 </code>
<code class="linenos">151 </code>
<code class="linenos">152 </code><code class="kd">func</code> <code class="nf">getAllRelationships</code><code class="p">(</code><code class="n">inputString</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">153 </code>    <code class="kd">let</code> <code class="nv">augmentedEntities</code> <code class="p">=</code> <code class="n">processEntities</code><code class="p">(</code><code class="n">inputString</code><code class="p">:</code> <code class="n">inputString</code><code class="p">)</code>
<code class="linenos">154 </code>    <code class="kd">var</code> <code class="nv">relationshipTriples</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">155 </code>    <code class="k">for</code> <code class="n">ae1</code> <code class="k">in</code> <code class="n">augmentedEntities</code> <code class="p">{</code>
<code class="linenos">156 </code>        <code class="k">for</code> <code class="n">ae2</code> <code class="k">in</code> <code class="n">augmentedEntities</code> <code class="p">{</code>
<code class="linenos">157 </code>            <code class="k">if</code> <code class="n">ae1</code> <code class="o">!=</code> <code class="n">ae2</code> <code class="p">{</code>
<code class="linenos">158 </code>                <code class="kd">let</code> <code class="nv">er1</code> <code class="p">=</code> <code class="n">dbpediaGetRelationships</code><code class="p">(</code><code class="n">entity1Uri</code><code class="p">:</code> <code class="n">ae1</code><code class="p">.</code><code class="n">uri</code><code class="p">,</code>
<code class="linenos">159 </code>                                                  <code class="n">entity2Uri</code><code class="p">:</code> <code class="n">ae2</code><code class="p">.</code><code class="n">uri</code><code class="p">)</code>
<code class="linenos">160 </code>                <code class="n">relationshipTriples</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">er1</code><code class="p">)</code>
<code class="linenos">161 </code>                <code class="kd">let</code> <code class="nv">er2</code> <code class="p">=</code> <code class="n">dbpediaGetRelationships</code><code class="p">(</code><code class="n">entity1Uri</code><code class="p">:</code> <code class="n">ae2</code><code class="p">.</code><code class="n">uri</code><code class="p">,</code>
<code class="linenos">162 </code>                                                  <code class="n">entity2Uri</code><code class="p">:</code> <code class="n">ae1</code><code class="p">.</code><code class="n">uri</code><code class="p">)</code>
<code class="linenos">163 </code>                <code class="n">relationshipTriples</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code> <code class="n">er2</code><code class="p">)</code>
<code class="linenos">164 </code>            <code class="p">}</code>
<code class="linenos">165 </code>        <code class="p">}</code>
<code class="linenos">166 </code>    <code class="p">}</code>
<code class="linenos">167 </code>    <code class="n">relationshipTriples</code><code class="p">.</code><code class="n">uniqueValues</code><code class="p">()</code>
<code class="linenos">168 </code>    <code class="n">relationshipTriples</code><code class="p">.</code><code class="bp">sort</code><code class="p">()</code>
<code class="linenos">169 </code>    <code class="k">return</code> <code class="n">relationshipTriples</code>
<code class="linenos">170 </code><code class="p">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-applebert">AppleBERT</h4>

<p>The files in the directory AppleBERT were copied from Apple’s example <a href="https://developer.apple.com/documentation/coreml/model_integration_samples/finding_answers_to_questions_in_a_text_document">https://developer.apple.com/documentation/coreml/model_integration_samples/finding_answers_to_questions_in_a_text_document</a> with a few changes to get returned results in a convenient format for this application. Apple’s BERT documentation is excellent and you should review it.</p>

<h4 id="leanpub-auto-relationships">Relationships</h4>

<p>The file <strong>Relationships.swift</strong> fetches relationship data for pairs of DBPedia entities. Note that the first SPARQL template has variable slots <strong>&lt;e1&gt;</strong> and <strong>&lt;e2&gt;</strong> that are replaced at runtime with URIs representing the entities that we are searching for relationships between these two entities:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">// relationships between DBPedia entities</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="kd">let</code> <code class="nv">relSparql</code> <code class="p">=</code>  <code class="s">"""</code>
<code class="linenos"> 4 </code><code class="s">SELECT DISTINCT ?p {&lt;e1&gt; ?p &lt;e2&gt; .FILTER (!regex(str(?p), 'wikiPage', 'i'))} LIMIT 5</code>
<code class="linenos"> 5 </code><code class="s">"""</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">dbpediaGetRelationships</code><code class="p">(</code><code class="n">entity1Uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">entity2Uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code>
<code class="linenos"> 8 </code>                                      <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 9 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">10 </code>    <code class="kd">let</code> <code class="nv">sparql1</code> <code class="p">=</code> <code class="n">relSparql</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;e1&gt;"</code><code class="p">,</code>
<code class="linenos">11 </code>      <code class="n">with</code><code class="p">:</code> <code class="n">entity1Uri</code><code class="p">).</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;e2&gt;"</code><code class="p">,</code>
<code class="linenos">12 </code>        <code class="n">with</code><code class="p">:</code> <code class="n">entity2Uri</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="kd">let</code> <code class="nv">r1</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql1</code><code class="p">)</code>
<code class="linenos">14 </code>    <code class="n">r1</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">result</code> <code class="k">in</code>
<code class="linenos">15 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">relName</code> <code class="p">=</code> <code class="n">result</code><code class="p">[</code><code class="s">"p"</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">16 </code>            <code class="kd">let</code> <code class="nv">rdfStatement</code> <code class="p">=</code> <code class="n">entity1Uri</code> <code class="o">+</code> <code class="s">" &lt;"</code> <code class="o">+</code> <code class="n">relName</code> <code class="o">+</code> <code class="s">"&gt; "</code> <code class="o">+</code> <code class="n">entity2Uri</code> <code class="o">+</code> <code class="s">" ."</code>
<code class="linenos">17 </code>            <code class="bp">print</code><code class="p">(</code><code class="n">rdfStatement</code><code class="p">)</code>
<code class="linenos">18 </code>            <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">rdfStatement</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="p">}</code>
<code class="linenos">20 </code>    <code class="p">}</code>
<code class="linenos">21 </code>    <code class="kd">let</code> <code class="nv">sparql2</code> <code class="p">=</code> <code class="n">relSparql</code><code class="p">.</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;e1&gt;"</code><code class="p">,</code>
<code class="linenos">22 </code>        <code class="n">with</code><code class="p">:</code> <code class="n">entity2Uri</code><code class="p">).</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"&lt;e2&gt;"</code><code class="p">,</code>
<code class="linenos">23 </code>            <code class="n">with</code><code class="p">:</code> <code class="n">entity1Uri</code><code class="p">)</code>
<code class="linenos">24 </code>    <code class="kd">let</code> <code class="nv">r2</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql2</code><code class="p">)</code>
<code class="linenos">25 </code>    <code class="n">r2</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="n">result</code> <code class="k">in</code>
<code class="linenos">26 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">relName</code> <code class="p">=</code> <code class="n">result</code><code class="p">[</code><code class="s">"p"</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos">27 </code>            <code class="kd">let</code> <code class="nv">rdfStatement</code> <code class="p">=</code> <code class="n">entity2Uri</code> <code class="o">+</code> <code class="s">" &lt;"</code> <code class="o">+</code> <code class="n">relName</code> <code class="o">+</code> <code class="s">"&gt; "</code> <code class="o">+</code> <code class="n">entity1Uri</code> <code class="o">+</code> <code class="s">" ."</code>
<code class="linenos">28 </code>            <code class="bp">print</code><code class="p">(</code><code class="n">rdfStatement</code><code class="p">)</code>
<code class="linenos">29 </code>            <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">rdfStatement</code><code class="p">)</code>
<code class="linenos">30 </code>        <code class="p">}</code>
<code class="linenos">31 </code>    <code class="p">}</code>
<code class="linenos">32 </code>    <code class="k">return</code> <code class="nb">Array</code><code class="p">(</code><code class="n">Set</code><code class="p">(</code><code class="n">ret</code><code class="p">))</code>
<code class="linenos">33 </code><code class="p">}</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">uriToPrintName</code><code class="p">(</code><code class="kc">_</code> <code class="n">uri</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos">36 </code>    <code class="kd">let</code> <code class="nv">slashIndex</code> <code class="p">=</code> <code class="n">uri</code><code class="p">.</code><code class="n">lastIndex</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"/"</code><code class="p">)</code>
<code class="linenos">37 </code>    <code class="k">if</code> <code class="n">slashIndex</code> <code class="p">==</code> <code class="kc">nil</code> <code class="p">{</code> <code class="k">return</code> <code class="n">uri</code> <code class="p">}</code>
<code class="linenos">38 </code>    <code class="kd">var</code> <code class="nv">s</code> <code class="p">=</code> <code class="n">uri</code><code class="p">[</code><code class="n">slashIndex</code><code class="p">!...]</code>
<code class="linenos">39 </code>    <code class="n">s</code> <code class="p">=</code> <code class="n">s</code><code class="p">.</code><code class="bp">dropFirst</code><code class="p">()</code>
<code class="linenos">40 </code>    <code class="k">if</code> <code class="n">s</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code> <code class="n">s</code><code class="p">.</code><code class="bp">removeLast</code><code class="p">()</code> <code class="p">}</code>
<code class="linenos">41 </code>    <code class="k">return</code> <code class="nb">String</code><code class="p">(</code><code class="n">s</code><code class="p">).</code><code class="n">replacingOccurrences</code><code class="p">(</code><code class="n">of</code><code class="p">:</code> <code class="s">"_"</code><code class="p">,</code> <code class="n">with</code><code class="p">:</code> <code class="s">" "</code><code class="p">)</code>
<code class="linenos">42 </code><code class="p">}</code>
<code class="linenos">43 </code>
<code class="linenos">44 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">relationshipsoEnglish</code><code class="p">(</code><code class="n">rs</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">])</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos">45 </code>    <code class="kd">var</code> <code class="nv">lines</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">46 </code>    <code class="k">for</code> <code class="n">r</code> <code class="k">in</code> <code class="n">rs</code> <code class="p">{</code>
<code class="linenos">47 </code>        <code class="kd">let</code> <code class="nv">triples</code> <code class="p">=</code> <code class="n">r</code><code class="p">.</code><code class="bp">split</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">" "</code><code class="p">,</code> <code class="n">maxSplits</code><code class="p">:</code> <code class="mi">3</code><code class="p">,</code>
<code class="linenos">48 </code>            <code class="n">omittingEmptySubsequences</code><code class="p">:</code> <code class="kc">true</code><code class="p">)</code>
<code class="linenos">49 </code>        <code class="k">if</code> <code class="n">triples</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">2</code> <code class="p">{</code>
<code class="linenos">50 </code>            <code class="n">lines</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">uriToPrintName</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="n">triples</code><code class="p">[</code><code class="mi">0</code><code class="p">]))</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code>
<code class="linenos">51 </code>              <code class="n">uriToPrintName</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="n">triples</code><code class="p">[</code><code class="mi">1</code><code class="p">]))</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code>
<code class="linenos">52 </code>                <code class="n">uriToPrintName</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="n">triples</code><code class="p">[</code><code class="mi">2</code><code class="p">])))</code>
<code class="linenos">53 </code>        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">54 </code>            <code class="n">lines</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">r</code><code class="p">)</code>
<code class="linenos">55 </code>        <code class="p">}</code>
<code class="linenos">56 </code>    <code class="p">}</code>
<code class="linenos">57 </code>    <code class="kd">let</code> <code class="nv">linesNoDuplicates</code> <code class="p">=</code> <code class="n">Set</code><code class="p">(</code><code class="n">lines</code><code class="p">)</code>
<code class="linenos">58 </code>    <code class="k">return</code> <code class="n">linesNoDuplicates</code><code class="p">.</code><code class="n">joined</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">59 </code><code class="p">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-nlp">NLP</h4>

<p>The file <strong>NlpWhiteboard</strong> provides high level NLP utility functions for the application:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="c1">//</code>
<code class="linenos"> 2 </code><code class="c1">//  NlpWhiteboard.swift</code>
<code class="linenos"> 3 </code><code class="c1">//  KGN</code>
<code class="linenos"> 4 </code><code class="c1">//</code>
<code class="linenos"> 5 </code><code class="c1">//  Copyright © 2021 Mark Watson. All rights reserved.</code>
<code class="linenos"> 6 </code><code class="c1">//</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="kd">public</code> <code class="kd">struct</code> <code class="nc">NlpWhiteboard</code> <code class="p">{</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code>    <code class="kd">var</code> <code class="nv">originalText</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">""</code>
<code class="linenos">11 </code>    <code class="kd">var</code> <code class="nv">people</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">12 </code>    <code class="kd">var</code> <code class="nv">places</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">13 </code>    <code class="kd">var</code> <code class="nv">organizations</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">14 </code>    <code class="kd">var</code> <code class="nv">sparql</code><code class="p">:</code> <code class="nb">String</code> <code class="p">=</code> <code class="s">""</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code>    <code class="kd">init</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code>    <code class="kr">mutating</code> <code class="kd">func</code> <code class="nf">set_text</code><code class="p">(</code><code class="n">originalText</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">19 </code>        <code class="kc">self</code><code class="p">.</code><code class="n">originalText</code> <code class="p">=</code> <code class="n">originalText</code>
<code class="linenos">20 </code>        <code class="kd">let</code> <code class="p">(</code><code class="n">people</code><code class="p">,</code> <code class="n">places</code><code class="p">,</code> <code class="n">organizations</code><code class="p">)</code> <code class="p">=</code> <code class="n">getAllEntities</code><code class="p">(</code><code class="n">text</code><code class="p">:</code>  <code class="n">originalText</code><code class="p">)</code>
<code class="linenos">21 </code>        <code class="kc">self</code><code class="p">.</code><code class="n">people</code> <code class="p">=</code> <code class="n">people</code><code class="p">;</code> <code class="kc">self</code><code class="p">.</code><code class="n">places</code> <code class="p">=</code> <code class="n">places</code><code class="p">;</code> <code class="kc">self</code><code class="p">.</code><code class="n">organizations</code> <code class="p">=</code> <code class="n">organizatio</code><code class="err">\</code>
<code class="linenos">22 </code><code class="n">ns</code>
<code class="linenos">23 </code>    <code class="p">}</code>
<code class="linenos">24 </code>    
<code class="linenos">25 </code>    <code class="kr">mutating</code> <code class="kd">func</code> <code class="nf">query_to_choices</code><code class="p">(</code><code class="n">behindTheScenesSparqlText</code><code class="p">:</code> <code class="kr">inout</code> <code class="nb">String</code><code class="p">)</code>
<code class="linenos">26 </code>          <code class="p">-&gt;</code> <code class="p">[[[</code><code class="nb">String</code><code class="p">]]]</code> <code class="p">{</code> <code class="c1">// return inner: [comment, uri]</code>
<code class="linenos">27 </code>        <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="n">Set</code><code class="o">&lt;</code><code class="p">[[</code><code class="nb">String</code><code class="p">]]</code><code class="o">&gt;</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">28 </code>        <code class="k">if</code> <code class="n">people</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">29 </code>            <code class="k">for</code> <code class="n">i</code> <code class="k">in</code> <code class="mf">0.</code><code class="p">..(</code><code class="n">people</code><code class="p">.</code><code class="bp">count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">30 </code>                <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code> <code class="p">=</code>
<code class="linenos">31 </code>                  <code class="n">get_SPARQL_for_finding_URIs_for_PERSON_NAME</code><code class="p">(</code><code class="n">nameString</code><code class="p">:</code> <code class="n">people</code><code class="p">[</code><code class="n">i</code><code class="p">])</code>
<code class="linenos">32 </code>                <code class="n">behindTheScenesSparqlText</code> <code class="o">+=</code> <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code>
<code class="linenos">33 </code>                <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos">34 </code>                <code class="k">if</code> <code class="n">results</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">35 </code>                    <code class="n">ret</code><code class="p">.</code><code class="bp">insert</code><code class="p">(</code> <code class="n">results</code><code class="p">.</code><code class="bp">map</code> <code class="p">{</code> <code class="p">[(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code>
<code class="linenos">36 </code>                                                <code class="p">??</code> <code class="s">""</code><code class="p">),</code>
<code class="linenos">37 </code>                                                <code class="p">(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"person_uri"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="p">)]</code> <code class="p">})</code>
<code class="linenos">38 </code>                <code class="p">}</code>
<code class="linenos">39 </code>            <code class="p">}</code>
<code class="linenos">40 </code>        <code class="p">}</code>
<code class="linenos">41 </code>        <code class="k">if</code> <code class="n">organizations</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">42 </code>            <code class="k">for</code> <code class="n">i</code> <code class="k">in</code> <code class="mf">0.</code><code class="p">..(</code><code class="n">organizations</code><code class="p">.</code><code class="bp">count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">43 </code>                <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_finding_URIs_for_ORGANIZATION_NAME</code><code class="p">(</code>
<code class="linenos">44 </code>                    <code class="n">orgString</code><code class="p">:</code> <code class="n">organizations</code><code class="p">[</code><code class="n">i</code><code class="p">])</code>
<code class="linenos">45 </code>                <code class="n">behindTheScenesSparqlText</code> <code class="o">+=</code> <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code>
<code class="linenos">46 </code>                <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos">47 </code>                <code class="k">if</code> <code class="n">results</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">48 </code>                    <code class="n">ret</code><code class="p">.</code><code class="bp">insert</code><code class="p">(</code><code class="n">results</code><code class="p">.</code><code class="bp">map</code> <code class="p">{</code> <code class="p">[(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code>
<code class="linenos">49 </code>                      <code class="s">""</code><code class="p">),</code> <code class="p">(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"org_uri"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="p">)]</code> <code class="p">})</code>
<code class="linenos">50 </code>                <code class="p">}</code>
<code class="linenos">51 </code>            <code class="p">}</code>
<code class="linenos">52 </code>        <code class="p">}</code>
<code class="linenos">53 </code>        <code class="k">if</code> <code class="n">places</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">54 </code>            <code class="k">for</code> <code class="n">i</code> <code class="k">in</code> <code class="mf">0.</code><code class="p">..(</code><code class="n">places</code><code class="p">.</code><code class="bp">count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos">55 </code>                <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_finding_URIs_for_PLACE_NAME</code><code class="p">(</code>
<code class="linenos">56 </code>                    <code class="n">placeString</code><code class="p">:</code> <code class="n">places</code><code class="p">[</code><code class="n">i</code><code class="p">])</code>
<code class="linenos">57 </code>                <code class="n">behindTheScenesSparqlText</code> <code class="o">+=</code> <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code>
<code class="linenos">58 </code>                <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="kc">self</code><code class="p">.</code><code class="n">sparql</code><code class="p">)</code>
<code class="linenos">59 </code>                <code class="k">if</code> <code class="n">results</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">60 </code>                    <code class="n">ret</code><code class="p">.</code><code class="bp">insert</code><code class="p">(</code> <code class="n">results</code><code class="p">.</code><code class="bp">map</code> <code class="p">{</code> <code class="p">[(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code>
<code class="linenos">61 </code>                      <code class="s">""</code><code class="p">),</code> <code class="p">(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"place_uri"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="p">)]</code> <code class="p">})</code>
<code class="linenos">62 </code>                <code class="p">}</code>
<code class="linenos">63 </code>            <code class="p">}</code>
<code class="linenos">64 </code>        <code class="p">}</code>
<code class="linenos">65 </code>        <code class="c1">//print("\n\n+++++++ ret:\n", ret, "\n\n")</code>
<code class="linenos">66 </code>        <code class="k">return</code> <code class="nb">Array</code><code class="p">(</code><code class="n">ret</code><code class="p">)</code>
<code class="linenos">67 </code>    <code class="p">}</code>
<code class="linenos">68 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The file <strong>NLPutils.swift</strong> provides lower level NLP utilities:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">  1 </code><code class="c1">//  NLPutils.swift</code>
<code class="linenos">  2 </code><code class="c1">//  KGN</code>
<code class="linenos">  3 </code><code class="c1">//</code>
<code class="linenos">  4 </code><code class="c1">//  Copyright © 2021 Mark Watson. All rights reserved.</code>
<code class="linenos">  5 </code><code class="c1">//</code>
<code class="linenos">  6 </code>
<code class="linenos">  7 </code><code class="kd">import</code> <code class="nc">Foundation</code>
<code class="linenos">  8 </code><code class="kd">import</code> <code class="nc">NaturalLanguage</code>
<code class="linenos">  9 </code>
<code class="linenos"> 10 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getPersonDescription</code><code class="p">(</code><code class="n">personName</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 11 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_finding_URIs_for_PERSON_NAME</code><code class="p">(</code><code class="n">nameString</code><code class="p">:</code> <code class="n">personName</code><code class="p">)</code>
<code class="linenos"> 12 </code>    <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 13 </code>    <code class="k">return</code> <code class="p">[</code><code class="n">sparql</code><code class="p">,</code> <code class="n">results</code><code class="p">.</code><code class="bp">map</code> <code class="p">{</code>
<code class="linenos"> 14 </code>      <code class="p">(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code> <code class="nv">$0</code><code class="p">[</code><code class="s">"abstract"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="p">)</code> <code class="p">}.</code><code class="n">joined</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">" . "</code><code class="p">)]</code>
<code class="linenos"> 15 </code><code class="p">}</code>
<code class="linenos"> 16 </code>
<code class="linenos"> 17 </code>
<code class="linenos"> 18 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getPlaceDescription</code><code class="p">(</code><code class="n">placeName</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 19 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_finding_URIs_for_PLACE_NAME</code><code class="p">(</code><code class="n">placeString</code><code class="p">:</code> <code class="n">placeName</code><code class="p">)</code>
<code class="linenos"> 20 </code>    <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 21 </code>    <code class="k">return</code> <code class="p">[</code><code class="n">sparql</code><code class="p">,</code> <code class="n">results</code><code class="p">.</code><code class="bp">map</code> <code class="p">{</code> <code class="p">(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code>
<code class="linenos"> 22 </code>        <code class="nv">$0</code><code class="p">[</code><code class="s">"abstract"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="p">)</code> <code class="p">}.</code><code class="n">joined</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">" . "</code><code class="p">)]</code>
<code class="linenos"> 23 </code><code class="p">}</code>
<code class="linenos"> 24 </code>
<code class="linenos"> 25 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getOrganizationDescription</code><code class="p">(</code><code class="n">organizationName</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 26 </code>    <code class="kd">let</code> <code class="nv">sparql</code> <code class="p">=</code> <code class="n">get_SPARQL_for_finding_URIs_for_ORGANIZATION_NAME</code><code class="p">(</code>
<code class="linenos"> 27 </code>        <code class="n">orgString</code><code class="p">:</code> <code class="n">organizationName</code><code class="p">)</code>
<code class="linenos"> 28 </code>    <code class="kd">let</code> <code class="nv">results</code> <code class="p">=</code> <code class="n">sparqlDbPedia</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">sparql</code><code class="p">)</code>
<code class="linenos"> 29 </code>    <code class="bp">print</code><code class="p">(</code><code class="s">"=== getOrganizationDescription results =</code><code class="se">\n</code><code class="s">"</code><code class="p">,</code> <code class="n">results</code><code class="p">)</code>
<code class="linenos"> 30 </code>    <code class="k">return</code> <code class="p">[</code><code class="n">sparql</code><code class="p">,</code> <code class="n">results</code><code class="p">.</code><code class="bp">map</code> <code class="p">{</code> <code class="p">(</code><code class="nv">$0</code><code class="p">[</code><code class="s">"comment"</code><code class="p">]</code> <code class="p">??</code> <code class="nv">$0</code><code class="p">[</code><code class="s">"abstract"</code><code class="p">]</code> <code class="p">??</code> <code class="s">""</code><code class="p">)</code> <code class="p">}</code>
<code class="linenos"> 31 </code>        <code class="p">.</code><code class="n">joined</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">" . "</code><code class="p">)]</code>
<code class="linenos"> 32 </code><code class="p">}</code>
<code class="linenos"> 33 </code>
<code class="linenos"> 34 </code><code class="kd">let</code> <code class="nv">tokenizer</code> <code class="p">=</code> <code class="bp">NLTokenizer</code><code class="p">(</code><code class="n">unit</code><code class="p">:</code> <code class="p">.</code><code class="n">word</code><code class="p">)</code>
<code class="linenos"> 35 </code><code class="kd">let</code> <code class="nv">tagger</code> <code class="p">=</code> <code class="bp">NSLinguisticTagger</code><code class="p">(</code><code class="n">tagSchemes</code><code class="p">:[.</code><code class="n">tokenType</code><code class="p">,</code> <code class="p">.</code><code class="n">language</code><code class="p">,</code> <code class="p">.</code><code class="n">lexicalClass</code><code class="p">,</code>
<code class="linenos"> 36 </code>  <code class="p">.</code><code class="n">nameType</code><code class="p">,</code> <code class="p">.</code><code class="n">lemma</code><code class="p">],</code> <code class="n">options</code><code class="p">:</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos"> 37 </code><code class="kd">let</code> <code class="nv">options</code><code class="p">:</code> <code class="bp">NSLinguisticTagger</code><code class="p">.</code><code class="n">Options</code> <code class="p">=</code>
<code class="linenos"> 38 </code>    <code class="p">[.</code><code class="n">omitPunctuation</code><code class="p">,</code> <code class="p">.</code><code class="n">omitWhitespace</code><code class="p">,</code> <code class="p">.</code><code class="n">joinNames</code><code class="p">]</code>
<code class="linenos"> 39 </code>
<code class="linenos"> 40 </code><code class="kd">let</code> <code class="nv">tokenizerOptions</code><code class="p">:</code> <code class="bp">NSLinguisticTagger</code><code class="p">.</code><code class="n">Options</code> <code class="p">=</code>
<code class="linenos"> 41 </code>    <code class="p">[.</code><code class="n">omitPunctuation</code><code class="p">,</code> <code class="p">.</code><code class="n">omitWhitespace</code><code class="p">,</code> <code class="p">.</code><code class="n">joinNames</code><code class="p">]</code>
<code class="linenos"> 42 </code>
<code class="linenos"> 43 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getEntities</code><code class="p">(</code><code class="n">text</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">{</code>
<code class="linenos"> 44 </code>    <code class="kd">var</code> <code class="nv">words</code><code class="p">:</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 45 </code>    <code class="n">tagger</code><code class="p">.</code><code class="n">string</code> <code class="p">=</code> <code class="n">text</code>
<code class="linenos"> 46 </code>    <code class="kd">let</code> <code class="nv">range</code> <code class="p">=</code> <code class="n">NSRange</code><code class="p">(</code><code class="n">location</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code> <code class="n">length</code><code class="p">:</code> <code class="n">text</code><code class="p">.</code><code class="n">utf16</code><code class="p">.</code><code class="bp">count</code><code class="p">)</code>
<code class="linenos"> 47 </code>    <code class="n">tagger</code><code class="p">.</code><code class="n">enumerateTags</code><code class="p">(</code><code class="k">in</code><code class="p">:</code> <code class="n">range</code><code class="p">,</code> <code class="n">unit</code><code class="p">:</code> <code class="p">.</code><code class="n">word</code><code class="p">,</code>
<code class="linenos"> 48 </code>        <code class="n">scheme</code><code class="p">:</code> <code class="p">.</code><code class="n">nameType</code><code class="p">,</code> <code class="n">options</code><code class="p">:</code> <code class="n">options</code><code class="p">)</code> <code class="p">{</code> <code class="n">tag</code><code class="p">,</code> <code class="n">tokenRange</code><code class="p">,</code> <code class="n">stop</code> <code class="k">in</code>
<code class="linenos"> 49 </code>        <code class="kd">let</code> <code class="nv">word</code> <code class="p">=</code> <code class="p">(</code><code class="n">text</code> <code class="k">as</code> <code class="bp">NSString</code><code class="p">).</code><code class="n">substring</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">tokenRange</code><code class="p">)</code>
<code class="linenos"> 50 </code>        <code class="kd">let</code> <code class="nv">tagType</code> <code class="p">=</code> <code class="n">tag</code><code class="p">?.</code><code class="n">rawValue</code> <code class="p">??</code> <code class="s">"unkown"</code>
<code class="linenos"> 51 </code>        <code class="k">if</code> <code class="n">tagType</code> <code class="o">!=</code> <code class="s">"unkown"</code> <code class="o">&amp;&amp;</code> <code class="n">tagType</code> <code class="o">!=</code> <code class="s">"OtherWord"</code> <code class="p">{</code>
<code class="linenos"> 52 </code>            <code class="n">words</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">word</code><code class="p">,</code> <code class="n">tagType</code><code class="p">))</code>
<code class="linenos"> 53 </code>        <code class="p">}</code>
<code class="linenos"> 54 </code>    <code class="p">}</code>
<code class="linenos"> 55 </code>    <code class="k">return</code> <code class="n">words</code>
<code class="linenos"> 56 </code><code class="p">}</code>
<code class="linenos"> 57 </code>
<code class="linenos"> 58 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">tokenizeText</code><code class="p">(</code><code class="n">text</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">{</code>
<code class="linenos"> 59 </code>    <code class="kd">var</code> <code class="nv">tokens</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 60 </code>    <code class="n">tokenizer</code><code class="p">.</code><code class="n">string</code> <code class="p">=</code> <code class="n">text</code>
<code class="linenos"> 61 </code>    <code class="n">tokenizer</code><code class="p">.</code><code class="n">enumerateTokens</code><code class="p">(</code><code class="k">in</code><code class="p">:</code> <code class="n">text</code><code class="p">.</code><code class="n">startIndex</code><code class="p">..&lt;</code><code class="n">text</code><code class="p">.</code><code class="n">endIndex</code><code class="p">)</code> <code class="p">{</code> <code class="n">tokenRange</code><code class="p">,</code> <code class="kc">_</code> <code class="k">in</code>
<code class="linenos"> 62 </code>        <code class="n">tokens</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="n">text</code><code class="p">[</code><code class="n">tokenRange</code><code class="p">]))</code>
<code class="linenos"> 63 </code>        <code class="k">return</code> <code class="kc">true</code>
<code class="linenos"> 64 </code>    <code class="p">}</code>
<code class="linenos"> 65 </code>    <code class="k">return</code> <code class="n">tokens</code>
<code class="linenos"> 66 </code><code class="p">}</code>
<code class="linenos"> 67 </code>
<code class="linenos"> 68 </code><code class="kd">let</code> <code class="nv">entityTagger</code> <code class="p">=</code> <code class="bp">NLTagger</code><code class="p">(</code><code class="n">tagSchemes</code><code class="p">:</code> <code class="p">[.</code><code class="n">nameType</code><code class="p">])</code>
<code class="linenos"> 69 </code><code class="kd">let</code> <code class="nv">entityOptions</code><code class="p">:</code> <code class="bp">NLTagger</code><code class="p">.</code><code class="n">Options</code> <code class="p">=</code> <code class="p">[.</code><code class="n">omitPunctuation</code><code class="p">,</code> <code class="p">.</code><code class="n">omitWhitespace</code><code class="p">,</code> <code class="p">.</code><code class="n">joinNames</code><code class="p">]</code>
<code class="linenos"> 70 </code><code class="kd">let</code> <code class="nv">entityTagTypess</code><code class="p">:</code> <code class="p">[</code><code class="n">NLTag</code><code class="p">]</code> <code class="p">=</code> <code class="p">[.</code><code class="n">personalName</code><code class="p">,</code> <code class="p">.</code><code class="n">placeName</code><code class="p">,</code> <code class="p">.</code><code class="n">organizationName</code><code class="p">]</code>
<code class="linenos"> 71 </code>
<code class="linenos"> 72 </code><code class="kd">public</code> <code class="kd">func</code> <code class="nf">getAllEntities</code><code class="p">(</code><code class="n">text</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">([</code><code class="nb">String</code><code class="p">],[</code><code class="nb">String</code><code class="p">],[</code><code class="nb">String</code><code class="p">])</code> <code class="p">{</code>
<code class="linenos"> 73 </code>    <code class="kd">var</code> <code class="nv">words</code><code class="p">:</code> <code class="p">[(</code><code class="nb">String</code><code class="p">,</code> <code class="nb">String</code><code class="p">)]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 74 </code>    <code class="kd">var</code> <code class="nv">people</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 75 </code>    <code class="kd">var</code> <code class="nv">places</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 76 </code>    <code class="kd">var</code> <code class="nv">organizations</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos"> 77 </code>    <code class="n">entityTagger</code><code class="p">.</code><code class="n">string</code> <code class="p">=</code> <code class="n">text</code>
<code class="linenos"> 78 </code>    <code class="n">entityTagger</code><code class="p">.</code><code class="n">enumerateTags</code><code class="p">(</code><code class="k">in</code><code class="p">:</code> <code class="n">text</code><code class="p">.</code><code class="n">startIndex</code><code class="p">..&lt;</code><code class="n">text</code><code class="p">.</code><code class="n">endIndex</code><code class="p">,</code> <code class="n">unit</code><code class="p">:</code> <code class="p">.</code><code class="n">word</code><code class="p">,</code>
<code class="linenos"> 79 </code>        <code class="n">scheme</code><code class="p">:</code> <code class="p">.</code><code class="n">nameType</code><code class="p">,</code> <code class="n">options</code><code class="p">:</code> <code class="n">entityOptions</code><code class="p">)</code> <code class="p">{</code> <code class="n">tag</code><code class="p">,</code> <code class="n">tokenRange</code> <code class="k">in</code>
<code class="linenos"> 80 </code>        <code class="k">if</code> <code class="kd">let</code> <code class="nv">tag</code> <code class="p">=</code> <code class="n">tag</code><code class="p">,</code> <code class="n">entityTagTypess</code><code class="p">.</code><code class="bp">contains</code><code class="p">(</code><code class="n">tag</code><code class="p">)</code> <code class="p">{</code>
<code class="linenos"> 81 </code>            <code class="kd">let</code> <code class="nv">word</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">text</code><code class="p">[</code><code class="n">tokenRange</code><code class="p">])</code>
<code class="linenos"> 82 </code>            <code class="k">if</code> <code class="n">tag</code><code class="p">.</code><code class="n">rawValue</code> <code class="p">==</code> <code class="s">"PersonalName"</code> <code class="p">{</code>
<code class="linenos"> 83 </code>                <code class="n">people</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">word</code><code class="p">)</code>
<code class="linenos"> 84 </code>            <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="n">tag</code><code class="p">.</code><code class="n">rawValue</code> <code class="p">==</code> <code class="s">"PlaceName"</code> <code class="p">{</code>
<code class="linenos"> 85 </code>                <code class="n">places</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">word</code><code class="p">)</code>
<code class="linenos"> 86 </code>            <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="n">tag</code><code class="p">.</code><code class="n">rawValue</code> <code class="p">==</code> <code class="s">"OrganizationName"</code> <code class="p">{</code>
<code class="linenos"> 87 </code>                <code class="n">organizations</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">word</code><code class="p">)</code>
<code class="linenos"> 88 </code>            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos"> 89 </code>                <code class="bp">print</code><code class="p">(</code><code class="s">"</code><code class="se">\n</code><code class="s">ERROR: unkown entity type: |</code><code class="si">\(</code><code class="n">tag</code><code class="p">.</code><code class="n">rawValue</code><code class="si">)</code><code class="s">|"</code><code class="p">)</code>
<code class="linenos"> 90 </code>            <code class="p">}</code>
<code class="linenos"> 91 </code>            <code class="n">words</code><code class="p">.</code><code class="n">append</code><code class="p">((</code><code class="n">word</code><code class="p">,</code> <code class="n">tag</code><code class="p">.</code><code class="n">rawValue</code><code class="p">))</code>
<code class="linenos"> 92 </code>        <code class="p">}</code>
<code class="linenos"> 93 </code>        <code class="k">return</code> <code class="kc">true</code>
<code class="linenos"> 94 </code>    <code class="p">}</code>
<code class="linenos"> 95 </code>    <code class="k">return</code> <code class="p">(</code><code class="n">people</code><code class="p">,</code> <code class="n">places</code><code class="p">,</code> <code class="n">organizations</code><code class="p">)</code>
<code class="linenos"> 96 </code><code class="p">}</code>
<code class="linenos"> 97 </code>
<code class="linenos"> 98 </code><code class="kd">func</code> <code class="nf">splitLongStrings</code><code class="p">(</code><code class="kc">_</code> <code class="n">s</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">limit</code><code class="p">:</code> <code class="nb">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">String</code> <code class="p">{</code>
<code class="linenos"> 99 </code>    <code class="kd">var</code> <code class="nv">ret</code><code class="p">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>
<code class="linenos">100 </code>    <code class="kd">let</code> <code class="nv">tokens</code> <code class="p">=</code> <code class="n">s</code><code class="p">.</code><code class="bp">split</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">" "</code><code class="p">)</code>
<code class="linenos">101 </code>    <code class="kd">var</code> <code class="nv">subLine</code> <code class="p">=</code> <code class="s">""</code>
<code class="linenos">102 </code>    <code class="k">for</code> <code class="n">token</code> <code class="k">in</code> <code class="n">tokens</code> <code class="p">{</code>
<code class="linenos">103 </code>        <code class="k">if</code> <code class="n">subLine</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="n">limit</code> <code class="p">{</code>
<code class="linenos">104 </code>            <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">subLine</code><code class="p">)</code>
<code class="linenos">105 </code>            <code class="n">subLine</code> <code class="p">=</code> <code class="s">""</code>
<code class="linenos">106 </code>        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="linenos">107 </code>            <code class="n">subLine</code> <code class="p">=</code> <code class="n">subLine</code> <code class="o">+</code> <code class="s">" "</code> <code class="o">+</code> <code class="n">token</code>
<code class="linenos">108 </code>        <code class="p">}</code>
<code class="linenos">109 </code>    <code class="p">}</code>
<code class="linenos">110 </code>    <code class="k">if</code> <code class="n">subLine</code><code class="p">.</code><code class="bp">count</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="p">{</code>
<code class="linenos">111 </code>        <code class="n">ret</code><code class="p">.</code><code class="n">append</code><code class="p">(</code><code class="n">subLine</code><code class="p">)</code>
<code class="linenos">112 </code>    <code class="p">}</code>
<code class="linenos">113 </code>    <code class="k">return</code> <code class="n">ret</code><code class="p">.</code><code class="n">joined</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">"</code><code class="se">\n</code><code class="s">"</code><code class="p">)</code>
<code class="linenos">114 </code><code class="p">}</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-views">Views</h4>

<p>This is not a book about SwiftUI programming, and indeed I expect many of you dear readers know much more about UI development with SwiftUI than I do. I am not going to list the four view files:</p>

<ul>
  <li>MainView.swift</li>
  <li>QueryView.swift</li>
  <li>AboutView.swift</li>
  <li>InfoView.swift</li>
</ul>

<h4 id="leanpub-auto-main-kgn">Main KGN</h4>

<p>The top level app code in the file <strong>KGNApp.swift</strong> is fairly simple. I hardcoded the window size for macOS and the window sizes for running this example on iPadOS or iOS are commented out:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kd">import</code> <code class="nc">SwiftUI</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">@</code><code class="n">main</code>
<code class="linenos"> 4 </code><code class="kd">struct</code> <code class="nc">KGNApp</code><code class="p">:</code> <code class="n">App</code> <code class="p">{</code>
<code class="linenos"> 5 </code>    <code class="kd">var</code> <code class="nv">body</code><code class="p">:</code> <code class="n">some</code> <code class="n">Scene</code> <code class="p">{</code>
<code class="linenos"> 6 </code>        <code class="n">WindowGroup</code> <code class="p">{</code>
<code class="linenos"> 7 </code>          <code class="n">MainView</code><code class="p">()</code>
<code class="linenos"> 8 </code>            <code class="p">.</code><code class="n">frame</code><code class="p">(</code><code class="n">width</code><code class="p">:</code> <code class="mi">1200</code><code class="p">,</code> <code class="n">height</code><code class="p">:</code> <code class="mi">770</code><code class="p">)</code>    <code class="c1">// &lt;&lt; here !!</code>
<code class="linenos"> 9 </code>            <code class="c1">//.frame(width: 660, height: 770)    // &lt;&lt; here !!</code>
<code class="linenos">10 </code>            <code class="c1">//..frame(width: 500, height: 800)    // &lt;&lt; here !!</code>
<code class="linenos">11 </code>        <code class="p">}</code>
<code class="linenos">12 </code>    <code class="p">}</code>
<code class="linenos">13 </code><code class="p">}</code>
</pre></div>

</figure>

<p>I was impressed by the SwiftUI framework. Applications are fairly portable across macOS, iOS, and iPadOS. I am not a UI developer by profession (as this application shows) but I enjoyed learning just enough about SwiftUI to write this example application.</p>


<h2 id="leanpub-auto-book-wrap-up">Book Wrap Up</h2>

<p>I hope that you dear reader enjoyed this short book. While I enjoy programming in Swift and appreciate how well Apple has integrated machine learning capabilities in their iOS/iPadOS/macOS ecosystems, I still find myself writing most of my experimental code in Lisp languages and using Python for deep learning experiments and projects. That said, I am very happy that I have done the work to add Swift, CoreML, and SwiftUI to my personal programming tool belt.</p>

<p>I usually update my eBooks so if there is some topic or application domain that you would like added to future versions of this book, then please let me know. My email address is markw &lt;at&gt; markwatson &lt;dot&gt; com.</p>

</div>
</body>
</html>
