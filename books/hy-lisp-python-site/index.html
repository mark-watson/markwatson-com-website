<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>A Lisp Programmer Living in Python-Land: The Hy Programming Language</title>
  <link href="stylesheet.css" rel="stylesheet" />
</head>
<body dir="" class="lfm">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-setting-up-your-development-environment'>Setting Up Your Development Environment</a>
      </li>
      <li>
        <a href='#leanpub-auto-what-is-lisp-programming-style'>What is Lisp Programming Style?</a>
      </li>
      <li>
        <a href='#leanpub-auto-hy-is-python-but-with-a-lisp-syntax'>Hy is Python, But With a Lisp Syntax</a>
      </li>
      <li>
        <a href='#leanpub-auto-how-this-book-reflects-my-views-on-artificial-intelligence-and-the-future-of-society-and-technology'>How This Book Reflects My Views on Artificial Intelligence and the Future of Society and Technology</a>
      </li>
      <li>
        <a href='#leanpub-auto-about-the-book-cover'>About the Book Cover</a>
      </li>
      <li>
        <a href='#leanpub-auto-a-request-from-the-author'>A Request from the Author</a>
      </li>
      <li>
        <a href='#leanpub-auto-acknowledgements'>Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-introduction-to-the-hy-language'>Introduction to the Hy Language</a>
    <ul>
      <li>
        <a href='#leanpub-auto-we-will-often-use-the-contributed-let-macro-in-book-example-code'>We Will Often Use the Contributed <strong>let</strong> Macro in Book Example Code</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-python-libraries'>Using Python Libraries</a>
      </li>
      <li>
        <a href='#leanpub-auto-global-vs-local-variables'>Global vs. Local Variables</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-python-code-in-hy-programs'>Using Python Code in Hy Programs</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-hy-libraries-in-python-programs'>Using Hy Libraries in Python Programs</a>
      </li>
      <li>
        <a href='#leanpub-auto-replacing-the-python-slice-cut-notation-with-the-hy-functional-form'>Replacing the Python slice (cut) Notation with the Hy Functional Form</a>
      </li>
      <li>
        <a href='#leanpub-auto-iterating-through-a-list-with-index-of-each-element'>Iterating Through a List With Index of Each Element</a>
      </li>
      <li>
        <a href='#leanpub-auto-formatted-output'>Formatted Output</a>
      </li>
      <li>
        <a href='#leanpub-auto-importing-libraries-from-different-directories-on-your-laptop'>Importing Libraries from Different Directories on Your Laptop</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-closures'>Using Closures</a>
      </li>
      <li>
        <a href='#leanpub-auto-hy-looks-like-clojure-how-similar-are-they'>Hy Looks Like Clojure: How Similar Are They?</a>
      </li>
      <li>
        <a href='#leanpub-auto-plotting-data-using-the-numpy-and-the-matplotlib-libraries'>Plotting Data Using the Numpy and the Matplotlib Libraries</a>
      </li>
      <li>
        <a href='#leanpub-auto-bonus-points-configuration-for-macos-and-iterm2-for-generating-plots-inline-in-a-hy-repl-and-shell'>Bonus Points: Configuration for macOS and ITerm2 for Generating Plots Inline in a Hy REPL and Shell</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-why-lisp'>Why Lisp?</a>
    <ul>
      <li>
        <a href='#leanpub-auto-i-hated-the-waterfall-method-in-the-1970s-but-learned-to-love-a-bottom-up-programming-style'>I Hated the Waterfall Method in the 1970s but Learned to Love a Bottom-Up Programming Style</a>
      </li>
      <li>
        <a href='#leanpub-auto-first-introduction-to-lisp'>First Introduction to Lisp</a>
      </li>
      <li>
        <a href='#leanpub-auto-commercial-product-development-and-deployment-using-lisp'>Commercial Product Development and Deployment Using Lisp</a>
      </li>
      <li>
        <a href='#leanpub-auto-hy-macros-let-you-extend-the-hy-language-in-your-programs'>Hy Macros Let You Extend the Hy Language in Your Programs</a>
      </li>
      <li>
        <a href='#leanpub-auto-performing-bottom-up-development-inside-a-repl-is-a-lifestyle-choice'>Performing Bottom Up Development Inside a REPL is a Lifestyle Choice</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-running-hy-in-jupyter-notebooks'>Running Hy in Jupyter Notebooks</a>
    <ul>
      <li>
        <a href='#leanpub-auto-install-requirements'>Install Requirements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-writing-web-applications'>Writing Web Applications</a>
    <ul>
      <li>
        <a href='#leanpub-auto-getting-started-with-flask-using-python-decorators-in-hy'>Getting Started With Flask: Using Python Decorators in Hy</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-jinja2-templates-to-generate-html'>Using Jinja2 Templates To Generate HTML</a>
      </li>
      <li>
        <a href='#leanpub-auto-handling-http-sessions-and-cookies'>Handling HTTP Sessions and Cookies</a>
      </li>
      <li>
        <a href='#leanpub-auto-deploying-hy-language-flask-apps-to-google-cloud-platform-appengine'>Deploying Hy Language Flask Apps to Google Cloud Platform AppEngine</a>
      </li>
      <li>
        <a href='#leanpub-auto-deploying-hy-language-flask-apps-to-the-heroku-platform'>Deploying Hy Language Flask Apps to the Heroku Platform</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-responsible-web-scraping'>Responsible Web Scraping</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-the-python-beautifulsoup-library-in-the-hy-language'>Using the Python BeautifulSoup Library in the Hy Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-getting-html-links-from-the-democracynoworg-news-web-site'>Getting HTML Links from the DemocracyNow.org News Web Site</a>
      </li>
      <li>
        <a href='#leanpub-auto-getting-summaries-of-front-page-from-the-nprorg-news-web-site'>Getting Summaries of Front Page from the NPR.org News Web Site</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-microsoft-bing-search-apis'>Using the Microsoft Bing Search APIs</a>
    <ul>
      <li>
        <a href='#leanpub-auto-getting-an-access-key-for-microsoft-bing-search-apis'>Getting an Access Key for Microsoft Bing Search APIs</a>
      </li>
      <li>
        <a href='#leanpub-auto-example-search-script'>Example Search Script</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-1'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-deep-learning'>Deep Learning</a>
    <ul>
      <li>
        <a href='#leanpub-auto-simple-multi-layer-perceptron-neural-networks'>Simple Multi-layer Perceptron Neural Networks</a>
      </li>
      <li>
        <a href='#leanpub-auto-deep-learning-1'>Deep Learning</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-keras-and-tensorflow-to-model-the-wisconsin-cancer-data-set'>Using Keras and TensorFlow to Model The Wisconsin Cancer Data Set</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-a-lstm-recurrent-neural-network-to-generate-english-text-similar-to-the--philosopher-nietzsches-writing'>Using a LSTM Recurrent Neural Network to Generate English Text Similar to the  Philosopher Nietzsche’s writing</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-natural-language-processing'>Natural Language Processing</a>
    <ul>
      <li>
        <a href='#leanpub-auto-exploring-the-spacy-library'>Exploring the spaCy Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-implementing-a-hynlp-wrapper-for-the-python-spacy-library'>Implementing a HyNLP Wrapper for the Python spaCy Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-coreference-anaphora-resolution'>Coreference (Anaphora Resolution)</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-2'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-datastores'>Datastores</a>
    <ul>
      <li>
        <a href='#leanpub-auto-sqlite'>Sqlite</a>
      </li>
      <li>
        <a href='#leanpub-auto-postgresql'>PostgreSQL</a>
      </li>
      <li>
        <a href='#rdflibintro'>RDF Data Using the “rdflib” Library</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-3'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-linked-data-the-semantic-web-and-knowledge-graphs'>Linked Data, the Semantic Web, and Knowledge Graphs</a>
    <ul>
      <li>
        <a href='#leanpub-auto-understanding-the-resource-description-framework-rdf'>Understanding the Resource Description Framework (RDF)</a>
      </li>
      <li>
        <a href='#leanpub-auto-resource-namespaces-provided-in-rdflib'>Resource Namespaces Provided in rdflib</a>
      </li>
      <li>
        <a href='#leanpub-auto-understanding-the-sparql-query-language'>Understanding the SPARQL Query Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrapping-the-python-rdflib-library'>Wrapping the Python <strong>rdflib</strong> Library</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-knowledge-graph-creator'>Knowledge Graph Creator</a>
    <ul>
      <li>
        <a href='#leanpub-auto-recommended-industrial-use-of-knowledge-graphs'>Recommended Industrial Use of Knowledge Graphs</a>
      </li>
      <li>
        <a href='#leanpub-auto-design-of-kgcreator-application'>Design of KGCreator Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-problems-with-using-literal-values-in-rdf'>Problems with using Literal Values in RDF</a>
      </li>
      <li>
        <a href='#leanpub-auto-revisiting-this-example-using-uris-instead-of-literal-values'>Revisiting This Example Using URIs Instead of Literal Values</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-4'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#kgn'>Knowledge Graph Navigator</a>
    <ul>
      <li>
        <a href='#leanpub-auto-review-of-nlp-utilities-used-in-application'>Review of NLP Utilities Used in Application</a>
      </li>
      <li>
        <a href='#leanpub-auto-developing-low-level-caching-sparql-utilities'>Developing Low-Level Caching SPARQL Utilities</a>
      </li>
      <li>
        <a href='#leanpub-auto-utilities-to-colorize-sparql-and-generated-output'>Utilities to Colorize SPARQL and Generated Output</a>
      </li>
      <li>
        <a href='#leanpub-auto-text-utilities-for-queries-and-results'>Text Utilities for Queries and Results</a>
      </li>
      <li>
        <a href='#leanpub-auto-finishing-the-main-function-for-kgn'>Finishing the Main Function for KGN</a>
      </li>
      <li>
        <a href='#leanpub-auto-wrap-up-5'>Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-book-wrap-up'>Book Wrap-up</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="lfm">
<h2 id="leanpub-auto-preface">Preface</h2>

<p>While this is a book on the Hy Lisp language, we have a wider theme here. In an age where artificial intelligence (AI) is a driver of the largest corporations and government agencies, the question is how do individuals and small organizations take advantage of AI technologies given disadvantages of small scale. The material I chose to write about here is selected to help you, dear reader, survive as a healthy small fish in a big bond.</p>

<p>I have been using Lisp languages professionally since 1982 and have written books covering the Common Lisp and Scheme languages. Most of my career has involved working on AI projects so tools for developing AI applications will be a major theme. In addition to covering the Hy language, you will get experience with AI tools and techniques that will help you craft your own AI platforms regardless of whether you are a consultant, work at a startup, or a corporation.</p>

<p>This book covers many programming topics using the Lisp language <strong>Hy</strong> that compiles to Python AST and is compatible with code, libraries, and frameworks written in Python. The main topics we will cover and write example applications for are:</p>

<ul>
  <li>Relational and graph databases</li>
  <li>Web app development</li>
  <li>Web scraping</li>
  <li>Accessing semantic web and linked data sources like Wikipedia, DBpedia, and Wikidata</li>
  <li>Automatically constructing Knowledge Graphs from text documents, semantic web and linked data</li>
  <li>Deep Learning</li>
  <li>Natural Language Processing (NLP) using Deep Learning</li>
</ul>

<p>The topics were chosen because of my work experience and the theme of this book is  how to increase programmer productivity and happiness using a Lisp language in a bottom-up development style. This style relies heavily on the use of an interactive REPL for exploring APIs and writing new code. I chose the above topics based on my experience working as a developer and researcher. Please note: you will see the term REPL frequently in this book. REPL stands for <em>Read Eval Print Loop</em>.</p>

<p>Some of the examples are very simple (e.g., the web app examples) while some are more complex (e.g., Deep Learning and knowledge graph examples). Regardless of the simplicity or complexity of the examples I hope that you find the code interesting, useful in your projects, and fun to experiment with.</p>

<h3 id="leanpub-auto-setting-up-your-development-environment">Setting Up Your Development Environment</h3>

<p>This is a hands-on book! I expect you, dear reader, to follow along with the examples as you read this book. I assume that you know some Python and know how to use the command line tools <strong>python</strong> and <strong>pip</strong> and use a virtual Python environment like <a href="https://www.anaconda.com/">Anaconda (<strong>conda</strong>)</a> or <a href="https://virtualenv.pypa.io/en/latest/"><strong>virtualenv</strong></a>. Personally I prefer <strong>conda</strong> but you can use any Python 3.x setup you like as long as you have a few packages installed.</p>

<p>You can install the current stable version of <strong>Hy</strong> using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">pip</code> <code class="nv">install</code> <code class="nv">git+https://github.com/hylang/hy.git</code>
</pre></div>

</figure>

<p>Depending on which examples you run and experiment with you will also need to install some of the following libraries:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">pip</code> <code class="nv">install</code> <code class="nv">beautifulsoup4</code> <code class="nv">Flask</code> <code class="nv">Jinja2</code> <code class="nv">Keras</code> <code class="nv">psycopg2</code>
<code class="linenos">2 </code>    <code class="nv">pip</code> <code class="nv">install</code> <code class="nv">rdflib</code> <code class="nv">rdflib-sqlite</code> <code class="nv">spacy</code> <code class="nv">tensorflow</code>
<code class="linenos">3 </code>    <code class="nv">pip</code> <code class="nv">install</code> <code class="nv">PyInquirer</code>
</pre></div>

</figure>

<p>The Hy language is under active development and it is not unusual for libraries and frameworks created more than a few months before the current Hy release to break. As a result of this, I have been careful in the selection of book material to leave out interesting functionality and libraries from the Hy ecosystem that I feel might not work with new releases. Here we stick with a few popular Python libraries like Keras, TensorFlow, and spaCy and otherwise we will work with mostly pure Hy language code in the examples.</p>

<h3 id="leanpub-auto-what-is-lisp-programming-style">What is Lisp Programming Style?</h3>

<p>I will give some examples here and also show exploratory Hy language REPL examples later in the book. How often do you search the web for documentation on how to use a library, write some code only to discover later that you didn’t use the API correctly? I reduce the amount of time that I spend writing code by having a Lisp REPL open so that I can experiment with API calls and returned results while reading the documentation.</p>

<p>When I am working on new code or a new algorithm I like to have a Lisp REPL open and try short snippets of code to get working code for solving low level problems, building up to more complex code. As I figure out how to do things I enter code that works and that I want to keep in a text editor and then convert this code into my own library. I then iterate on loading my new library into a REPL and stress test it, look for API improvements, etc.</p>

<p>I find, in general, that a “bottom-up” approach gets me to working high quality systems faster than spending too much time doing up front planning and design. The problem with spending too much up front time on design is that we change our minds as to what makes the most sense to solve a problem as we experiment with code. I try to avoid up front time spent on work that I will have to re-work or even toss out.</p>

<h3 id="leanpub-auto-hy-is-python-but-with-a-lisp-syntax">Hy is Python, But With a Lisp Syntax</h3>

<p>When I need a library for a Hy project I search for Python libraries and either write a thin Hy language “wrapper” around the Python library or just call the Python APIs directly from Hy code. You will see many examples of both approaches in this book.</p>

<h3 id="leanpub-auto-how-this-book-reflects-my-views-on-artificial-intelligence-and-the-future-of-society-and-technology">How This Book Reflects My Views on Artificial Intelligence and the Future of Society and Technology</h3>

<p>Since starting work on AI in 1982 I have seen the field progress from a niche technology where even international conferences had small attendances to a field that is generally viewed as transformative. In the USA there is legitimate concern that economic adversaries like China will exceed our abilities to develop core AI technologies and integrate these technologies into commercial and military systems. As I write this in February 2020, some people in our field including myself believe that the Chinese company Baidu may have already passed Google and Microsoft in applied AI.</p>

<p>Even though most of my professional work in the last five years has been in Deep Learning (and before that I worked with the Knowledge Graph at Google on a knowledge representation problem and application), I believe that human level Artificial General Intelligence (AGI) will use hybrid Deep Learning, “old fashioned” symbolic AI, and techniques that we have yet to discover.</p>

<p>This belief that Deep Learning will not get us to AGI capabilities is a motivation for me to use the Hy language because it offers transparent access to Python Deep Learning frameworks with a bottom-up Lisp development style that I have used for decades using symbolic AI and knowledge representation.</p>

<p>I hope you find that Hy meets your needs as it does my own.</p>

<h3 id="leanpub-auto-about-the-book-cover">About the Book Cover</h3>

<p>The official Hy Language logo is an octopus:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 22%">
    <img src="images/hylisplogo.jpg" alt="The Hy Language logo Cuddles by Karen Rustad" style="width: 100%">
    <figcaption>The Hy Language logo Cuddles by Karen Rustad</figcaption>
  </figure>
</div>


<p>Usually I use photographs that I take myself for covers of my LeanPub books. Although I have SCUBA dived since I was 13 years old, sadly I have no pictures of an octopus that I have taken myself. I did find a public domain picture I liked (that is the cover of this book) on Wikimedia. <strong>Cover Credit</strong>: Thanks to Wikimedia user Pseudopanax for placing the cover image in the public domain.</p>

<h3 id="leanpub-auto-a-request-from-the-author">A Request from the Author</h3>

<p>I spent time writing this book to help you, dear reader. I release this book under the Creative Commons “share and share alike, no modifications, no commercial reuse” license and set the minimum purchase price to $5.00 in order to reach the most readers. You can also download a free copy from <a href="https://markwatson.com/books">my website</a>. Under this license you can share a PDF version of this book with your friends and coworkers. If you found this book on the web (or it was given to you) and if it provides value to you then please consider doing one of the following to support my future writing efforts and also to support future updates to this book:</p>

<ul>
  <li>Purchase a copy of this book or any other of my leanpub books at <a href="https://leanpub.com/u/markwatson">https://leanpub.com/u/markwatson</a>
</li>
  <li><a href="https://markwatson.com/">Hire me as a consultant</a></li>
</ul>

<p>I enjoy writing and your support helps me write new editions and updates for my books and to develop new book projects. Thank you!</p>

<h3 id="leanpub-auto-acknowledgements">Acknowledgements</h3>

<p>I thank my wife Carol for editing this manuscript, finding typos, and suggesting improvements.</p>

<p>I would like to thank Pascal (Reddit user chuchana) for corrections and suggestions. I would like to thank Carlos Ungil for catching a typo and reporting it. I would like to thank Jud Taylor for finding several typo errors. I would like to thank Dave Smythe for finding some typos.</p>


<h2 id="leanpub-auto-introduction-to-the-hy-language">Introduction to the Hy Language</h2>

<p>The <a href="http://docs.hylang.org/en/stable/">Hy programming language</a> is a Lisp language that inter-operates smoothly with Python. We start with a few interactive examples that I encourage you to experiment with as you read. Then we will look at Hy data types and commonly used built-in functions that are used in the remainder of this book.</p>

<p>I assume that you know at least a little Python and more importantly the Python ecosystem and general tools like <strong>pip</strong>.</p>

<p>Please start by installing Hy in your current Python environment:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip install git+https://github.com/hylang/hy.git
</pre></div>

</figure>

<h3 id="leanpub-auto-we-will-often-use-the-contributed-let-macro-in-book-example-code">We Will Often Use the Contributed <strong>let</strong> Macro in Book Example Code</h3>

<p>In Scheme, Clojure, and Common Lisp languages the <strong>let</strong> special form is used to define blocks of code with local variables and functions. I will require (or import) the contributed <strong>let</strong> macro, that substitutes for a built-in special form in most examples in this book, but I might not include the <strong>require</strong> in short code listings. Always assume that the following lines start each example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nf">require</code> <code class="p">[</code><code class="nv">hy.contrib.walk</code> <code class="p">[</code><code class="nv">let</code><code class="p">]])</code>
</pre></div>

</figure>

<p>Line 1 is similar to how we make Python scripts into runnable programs. Here we run <strong>hy</strong> instead of <strong>python</strong>. Line 3 imports the <strong>let</strong> macro. We will occasionally use <strong>let</strong> for code blocks with local variable and function definitions and also for using closures (I will cover closures at the end of this chapter):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nf">require</code> <code class="p">[</code><code class="nv">hy.contrib.walk</code> <code class="p">[</code><code class="nv">let</code><code class="p">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">x</code> <code class="mi">1</code><code class="p">]</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="nb">print</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">x</code> <code class="mi">33</code><code class="p">]</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">x</code> <code class="mi">44</code><code class="p">)</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="nb">print</code> <code class="nv">x</code><code class="p">))</code>
</pre></div>

</figure>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="mi">1</code>
<code class="mi">33</code>
<code class="mi">44</code>
<code class="mi">1</code>
</pre></div>

</figure>

<p>Notice that setting a new value for <strong>x</strong> in the inner <strong>let</strong> expression does not change the value bound to the variable <strong>x</strong> in the outer <strong>let</strong> expression.</p>

<h3 id="leanpub-auto-using-python-libraries">Using Python Libraries</h3>

<p>Using Python libraries like TensorFlow, Keras, BeautifulSoup, etc. are the reason I use the Hy language. Importing Python code and libraries and calling out to Python is simple and here we look at sufficient examples so that you will understand example code that we will look at later.</p>

<p>For example, in the chapter <strong>Responsible Web Scraping</strong> we will use the BeautifulSoup library. We will look at some Python code snippets and the corresponding Hy language versions of these snippets. Let’s first look at a Python example that we will then convert to Hy:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="n">raw_data</code> <code class="o">=</code> <code class="s1">'&lt;html&gt;&lt;body&gt;&lt;a href="http://markwatson.com"&gt;Mark&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;'</code>
<code class="linenos">4 </code><code class="n">soup</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">raw_data</code><code class="p">)</code>
<code class="linenos">5 </code><code class="n">a_tags</code> <code class="o">=</code> <code class="n">soup</code><code class="o">.</code><code class="n">find_all</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
<code class="linenos">6 </code><code class="nb">print</code><code class="p">(</code><code class="s2">"a tags:"</code><code class="p">,</code> <code class="n">a_tags</code><code class="p">)</code>
</pre></div>

</figure>

<p>In the following listing notice how we import other code and libraries in Hy. The special form <strong>setv</strong> is used to define variables in a local context. Since the <strong>setv</strong> statements in lines 4, 6, and 7 are used at the top level, they are global in the Python/Hy module named after the root name of the source file.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.18</code><code class="nv">.0</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.4</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">bs4</code> <code class="p">[</code><code class="nv">BeautifulSoup</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">raw-data</code> <code class="s">"&lt;html&gt;&lt;body&gt;&lt;a href=\"http://markwatson.com\"&gt;Mark&lt;/a&gt;&lt;/body&gt;&lt;/ht\</code>
<code class="linenos"> 5 </code><code class="s">ml&gt;"</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">soup</code> <code class="p">(</code><code class="nf">BeautifulSoup</code> <code class="nv">raw-data</code> <code class="s">"lxml"</code><code class="p">))</code>
<code class="linenos"> 7 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">a</code> <code class="p">(</code><code class="nf">.find-all</code> <code class="nv">soup</code> <code class="s">"a"</code><code class="p">))</code>
<code class="linenos"> 8 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">print</code> <code class="s">"atags:"</code> <code class="nv">a</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="nv">atags:</code> <code class="p">[</code><code class="nv">&lt;a</code> <code class="nv">href=</code><code class="s">"http://markwatson.com"</code><code class="nv">&gt;Mark&lt;/a&gt;</code><code class="p">]</code>
<code class="linenos">10 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">type</code> <code class="nv">a</code><code class="p">)</code>
<code class="linenos">11 </code><code class="nv">&lt;class</code> <code class="ss">'bs4.element.ResultSet'&gt;</code>
<code class="linenos">12 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">dir</code> <code class="nv">a</code><code class="p">)</code>
<code class="linenos">13 </code><code class="p">[</code><code class="ss">'__add__</code><code class="o">'</code>, <code class="ss">'__class__</code><code class="o">'</code>, <code class="ss">'__contains__</code><code class="o">'</code>, <code class="ss">'__delattr__</code><code class="o">'</code>, <code class="ss">'__delitem__</code><code class="o">'</code>, <code class="ss">'__dict__</code><code class="o">'</code>, <code class="o">'</code><code class="err">\</code>
<code class="linenos">14 </code><code class="nv">__dir__</code><code class="o">'</code>, <code class="ss">'__doc__</code><code class="o">'</code>, <code class="ss">'__eq__</code><code class="o">'</code>, <code class="ss">'__format__</code><code class="o">'</code>, <code class="ss">'__ge__</code><code class="o">'</code>, <code class="ss">'__getattr__</code><code class="o">'</code>, <code class="ss">'__getattribut</code><code class="err">\</code>
<code class="linenos">15 </code><code class="nv">e__</code><code class="o">'</code>, <code class="ss">'__getitem__</code><code class="o">'</code>, <code class="ss">'__gt__</code><code class="o">'</code>, <code class="ss">'__hash__</code><code class="o">'</code>, <code class="ss">'__iadd__</code><code class="o">'</code>, <code class="ss">'__imul__</code><code class="o">'</code>, <code class="ss">'__init__</code><code class="o">'</code>, <code class="ss">'__in</code><code class="err">\</code>
<code class="linenos">16 </code><code class="nv">it_subclass__</code><code class="o">'</code>, <code class="ss">'__iter__</code><code class="o">'</code>, <code class="ss">'__le__</code><code class="o">'</code>, <code class="ss">'__len__</code><code class="o">'</code>, <code class="ss">'__lt__</code><code class="o">'</code>, <code class="ss">'__module__</code><code class="o">'</code>, <code class="ss">'__mul__</code><code class="o">'</code>, <code class="err">\</code>
<code class="linenos">17 </code><code class="ss">'__ne__</code><code class="o">'</code>, <code class="ss">'__new__</code><code class="o">'</code>, <code class="ss">'__reduce__</code><code class="o">'</code>, <code class="ss">'__reduce_ex__</code><code class="o">'</code>, <code class="ss">'__repr__</code><code class="o">'</code>, <code class="ss">'__reversed__</code><code class="o">'</code>, <code class="ss">'__r</code><code class="err">\</code>
<code class="linenos">18 </code><code class="nv">mul__</code><code class="o">'</code>, <code class="ss">'__setattr__</code><code class="o">'</code>, <code class="ss">'__setitem__</code><code class="o">'</code>, <code class="ss">'__sizeof__</code><code class="o">'</code>, <code class="ss">'__str__</code><code class="o">'</code>, <code class="ss">'__subclasshook__</code><code class="o">'</code>, <code class="o">'</code><code class="err">\</code>
<code class="linenos">19 </code><code class="nv">__weakref__</code><code class="o">'</code>, <code class="ss">'append</code><code class="o">'</code>, <code class="ss">'clear</code><code class="o">'</code>, <code class="ss">'copy</code><code class="o">'</code>, <code class="ss">'count</code><code class="o">'</code>, <code class="ss">'extend</code><code class="o">'</code>, <code class="ss">'index</code><code class="o">'</code>, <code class="ss">'insert</code><code class="o">'</code>, <code class="ss">'pop</code><code class="o">'</code><code class="err">\</code>
<code class="linenos">20 </code>, <code class="ss">'remove</code><code class="o">'</code>, <code class="ss">'reverse</code><code class="o">'</code>, <code class="ss">'sort</code><code class="o">'</code>, <code class="ss">'source</code><code class="o">'</code><code class="p">]</code>
</pre></div>

</figure>

<p>Notice in lines 3 and 6 that we can have “-“ characters inside of variable and function names (<strong>raw-data</strong> and <strong>find-all</strong> in this case) in the Hy language where we might use “_” underscore characters in Python. Like Python, we can use <strong>type</strong> get get the type of a value and <strong>dir</strong> to see what symbols are available for a object.</p>

<h3 id="leanpub-auto-global-vs-local-variables">Global vs. Local Variables</h3>

<p>Although I don’t generally recommend it, sometimes it is convenient to export local variables defined with <strong>setv</strong> or in a <strong>let</strong> macro expansion to be global variables in the context of the current module (that is defined by the current source file). As an example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">Marks-MacBook:deeplearning</code> <code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">defn </code><code class="nv">foo</code> <code class="p">[]</code>
<code class="linenos"> 4 </code><code class="nv">...</code> <code class="p">(</code><code class="k">global</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="nv">...</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">x</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="nv">...</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 7 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">foo</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="mi">1</code>
<code class="linenos"> 9 </code><code class="nv">=&gt;</code> <code class="nv">x</code>
<code class="linenos">10 </code><code class="mi">1</code>
<code class="linenos">11 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>Before executing function <strong>foo</strong> the global variable <strong>x</strong> is undefined (unless you coincidentally already defined somewhere else). When function <strong>foo</strong> is called, a global variable <strong>x</strong> is defined and then it equal to the value 1.</p>

<h3 id="leanpub-auto-using-python-code-in-hy-programs">Using Python Code in Hy Programs</h3>

<p>If there is a Python source file, named for example, <em>test.py</em> in the same directory as a Hy language file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">def</code> <code class="nf">factorial</code> <code class="p">(</code><code class="n">n</code><code class="p">):</code>
<code class="linenos">2 </code>  <code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> <code class="mi">2</code><code class="p">:</code>
<code class="linenos">3 </code>    <code class="k">return</code> <code class="mi">1</code>
<code class="linenos">4 </code>  <code class="k">return</code> <code class="n">n</code> <code class="o">*</code> <code class="n">factorial</code><code class="p">(</code><code class="n">n</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>
</pre></div>

</figure>

<p>This code will be in a module named <strong>test</strong> because that is the root source code file name. We might import the Python code using the following in Python:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kn">import</code> <code class="nn">test</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="nb">print</code><code class="p">(</code><code class="n">test</code><code class="o">.</code><code class="n">factorial</code><code class="p">(</code><code class="mi">5</code><code class="p">))</code>
</pre></div>

</figure>

<p>and we can use the following in Hy to import the Python module <strong>test</strong> (defined in <em>test.py</em>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="k">import </code><code class="nv">test</code><code class="p">)</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">test.factorial</code> <code class="mi">5</code><code class="p">))</code>
</pre></div>

</figure>

<p>Running this interactively in Hy:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos">2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos">3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="nv">test</code><code class="p">)</code>
<code class="linenos">4 </code><code class="nv">=&gt;</code> <code class="nv">test</code>
<code class="linenos">5 </code><code class="nv">&lt;module</code> <code class="ss">'test</code><code class="o">'</code> <code class="nv">from</code> <code class="ss">'/Users/markw/GITHUB/hy-lisp-python/test.py'&gt;</code>
<code class="linenos">6 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">test.factorial</code> <code class="mi">5</code><code class="p">))</code>
<code class="linenos">7 </code><code class="mi">120</code>
</pre></div>

</figure>

<p>If we only wanted to import <strong>BeautifulSoup</strong> from the Python BeautifulSoup library <strong>bs4</strong> we can specify this in the <strong>import</strong> form:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">bs4</code> <code class="p">[</code><code class="nv">BeautifulSoup</code><code class="p">]])</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-using-hy-libraries-in-python-programs">Using Hy Libraries in Python Programs</h3>

<p>There is nothing special about importing and using Hy library code or your own Hy scripts in Python programs. The directory <strong>hy-lisp-python/use_hy_in_python</strong> in the <a href="https://github.com/mark-watson/hy-lisp-python">git repository for this book https://github.com/mark-watson/hy-lisp-python</a> contains an example Hy script <strong>get_web_page.hy</strong> that is a slightly modified version of code we will explain and use in the later chapter on web scraping and a short Python script <strong>use_hy_stuff.py</strong> that uses a function defined in Hy:</p>

<p><strong>get_web_page.hy:</strong></p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="nv">argparse</code> <code class="nv">os</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">urllib.request</code> <code class="p">[</code><code class="nv">Request</code> <code class="nv">urlopen</code><code class="p">]])</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-raw-data-from-web</code> <code class="p">[</code><code class="nv">aUri</code> <code class="o">&amp;</code><code class="nv">optional</code> <code class="p">[</code><code class="nv">anAgent</code>
<code class="linenos"> 5 </code>                                            <code class="p">{</code><code class="s">"User-Agent"</code> <code class="s">"HyLangBook/1.0"</code><code class="p">}]]</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">req</code> <code class="p">(</code><code class="nf">Request</code> <code class="nv">aUri</code> <code class="ss">:headers</code> <code class="nv">anAgent</code><code class="p">))</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">httpResponse</code> <code class="p">(</code><code class="nf">urlopen</code> <code class="nv">req</code><code class="p">))</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">data</code> <code class="p">(</code><code class="nf">.read</code> <code class="nv">httpResponse</code><code class="p">))</code>
<code class="linenos"> 9 </code>  <code class="nv">data</code><code class="p">)</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">main_hy</code> <code class="p">[]</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">get-raw-data-from-web</code> <code class="s">"http://markwatson.com"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>We define two functions here. Notice the optional argument <strong>anAgent</strong> defined in lines 4-5 where we provide a default value in case the calling code does not provide a value. In the next Python listing we import the file in the last listing and call the Hy function <strong>main</strong> on line 4 using the Python calling syntax.</p>

<p>Hy is the same as Python once it is compiled to an abstract syntax tree (AST).</p>

<p><strong>hy-lisp-python/use_in_python:</strong></p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">import </code><code class="nv">hy</code>
<code class="linenos">2 </code><code class="nv">from</code> <code class="nv">get_web_page</code> <code class="k">import </code><code class="nv">main_hy</code>
<code class="linenos">3 </code>
<code class="linenos">4 </code><code class="nv">main_hy</code><code class="p">()</code>
</pre></div>

</figure>

<p>What I want you to understand and develop a feeling for is that Hy and Python are really the same but with a different syntax and that both languages can easily be used side by side.</p>

<h3 id="leanpub-auto-replacing-the-python-slice-cut-notation-with-the-hy-functional-form">Replacing the Python slice (cut) Notation with the Hy Functional Form</h3>

<p>In Python we use a special notation for extracting sub-sequences from lists or strings:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">$</code> <code class="n">python</code>
<code class="n">Python</code> <code class="mf">3.7.3</code> <code class="p">(</code><code class="n">default</code><code class="p">,</code> <code class="n">Mar</code> <code class="mi">27</code> <code class="mi">2019</code><code class="p">,</code> <code class="mi">16</code><code class="p">:</code><code class="mi">54</code><code class="p">:</code><code class="mi">48</code><code class="p">)</code> 
<code class="o">&gt;&gt;&gt;</code> <code class="n">s</code> <code class="o">=</code> <code class="s1">'0123456789'</code>
<code class="o">&gt;&gt;&gt;</code> <code class="n">s</code><code class="p">[</code><code class="mi">2</code><code class="p">:</code><code class="mi">4</code><code class="p">]</code>
<code class="s1">'23'</code>
<code class="o">&gt;&gt;&gt;</code> <code class="n">s</code><code class="p">[</code><code class="o">-</code><code class="mi">4</code><code class="p">:]</code>
<code class="s1">'6789'</code>
<code class="o">&gt;&gt;&gt;</code> <code class="n">s</code><code class="p">[</code><code class="o">-</code><code class="mi">4</code><code class="p">:</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code>
<code class="s1">'678'</code>
<code class="o">&gt;&gt;&gt;</code> 
</pre></div>

</figure>

<p>In Hy this would be:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">hy</code>
<code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">s</code> <code class="s">"0123456789"</code><code class="p">)</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">s</code> <code class="mi">2</code> <code class="mi">4</code><code class="p">)</code>
<code class="ss">'23</code><code class="o">'</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">s</code> <code class="mi">-4</code><code class="p">)</code>
<code class="ss">'6789</code><code class="o">'</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">s</code> <code class="mi">-4</code> <code class="mi">-1</code><code class="p">)</code>
<code class="ss">'678</code><code class="o">'</code>
<code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>It also works to use <strong>cut</strong> with <strong>setv</strong> to destructively change a list; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">x</code> <code class="p">[</code><code class="mi">0</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code> <code class="mi">6</code> <code class="mi">7</code> <code class="mi">8</code><code class="p">])</code>
<code class="nv">=&gt;</code> <code class="nv">x</code>
<code class="p">[</code><code class="mi">0</code>, <code class="mi">1</code>, <code class="mi">2</code>, <code class="mi">3</code>, <code class="mi">4</code>, <code class="mi">5</code>, <code class="mi">6</code>, <code class="mi">7</code>, <code class="mi">8</code><code class="p">]</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">x</code> <code class="mi">2</code> <code class="mi">4</code><code class="p">)</code>
<code class="p">[</code><code class="mi">2</code>, <code class="mi">3</code><code class="p">]</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="p">(</code><code class="nf">cut</code> <code class="nv">x</code> <code class="mi">2</code> <code class="mi">4</code><code class="p">)</code> <code class="p">[</code><code class="mi">22</code> <code class="mi">33</code><code class="p">])</code>
<code class="nv">=&gt;</code> <code class="nv">x</code>
<code class="p">[</code><code class="mi">0</code>, <code class="mi">1</code>, <code class="mi">22</code>, <code class="mi">33</code>, <code class="mi">4</code>, <code class="mi">5</code>, <code class="mi">6</code>, <code class="mi">7</code>, <code class="mi">8</code><code class="p">]</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-iterating-through-a-list-with-index-of-each-element">Iterating Through a List With Index of Each Element</h3>

<p>We will use <strong>lfor</strong> as a form of Python list comprehension; for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">sentence</code> <code class="s">"The ball rolled"</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">sentence</code><code class="p">)</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="p">[(</code><code class="mi">0</code>, <code class="ss">'T</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">1</code>, <code class="ss">'h</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">2</code>, <code class="ss">'e</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">3</code>, <code class="o">'</code> <code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">4</code>, <code class="ss">'b</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">5</code>, <code class="ss">'a</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">6</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">7</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">8</code>,<code class="err">\</code>
<code class="linenos"> 4 </code> <code class="o">'</code> <code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">9</code>, <code class="ss">'r</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">10</code>, <code class="ss">'o</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">11</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">12</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">13</code>, <code class="ss">'e</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">14</code>, <code class="ss">'d</code><code class="o">'</code><code class="p">)]</code>
<code class="linenos"> 5 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">vv</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">sentence</code><code class="p">)</code> <code class="nv">i</code><code class="p">))</code>
<code class="linenos"> 6 </code><code class="nv">=&gt;</code> <code class="nv">vv</code>
<code class="linenos"> 7 </code><code class="p">[(</code><code class="mi">0</code>, <code class="ss">'T</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">1</code>, <code class="ss">'h</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">2</code>, <code class="ss">'e</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">3</code>, <code class="o">'</code> <code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">4</code>, <code class="ss">'b</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">5</code>, <code class="ss">'a</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">6</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">7</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">8</code>,<code class="err">\</code>
<code class="linenos"> 8 </code> <code class="o">'</code> <code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">9</code>, <code class="ss">'r</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">10</code>, <code class="ss">'o</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">11</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">12</code>, <code class="ss">'l</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">13</code>, <code class="ss">'e</code><code class="o">'</code><code class="p">)</code>, <code class="p">(</code><code class="mi">14</code>, <code class="ss">'d</code><code class="o">'</code><code class="p">)]</code>
<code class="linenos"> 9 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">a</code> <code class="nv">b</code><code class="p">]</code> <code class="nv">vv</code><code class="p">]</code>
<code class="linenos">10 </code><code class="nv">...</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">a</code> <code class="nv">b</code><code class="p">))</code>
<code class="linenos">11 </code><code class="mi">0</code> <code class="nv">T</code>
<code class="linenos">12 </code><code class="mi">1</code> <code class="nv">h</code>
<code class="linenos">13 </code><code class="mi">2</code> <code class="nv">e</code>
<code class="linenos">14 </code><code class="mi">3</code>  
<code class="linenos">15 </code><code class="mi">4</code> <code class="nv">b</code>
<code class="linenos">16 </code><code class="mi">5</code> <code class="nv">a</code>
<code class="linenos">17 </code><code class="mi">6</code> <code class="nv">l</code>
<code class="linenos">18 </code><code class="mi">7</code> <code class="nv">l</code>
<code class="linenos">19 </code><code class="mi">8</code>  
<code class="linenos">20 </code><code class="mi">9</code> <code class="nv">r</code>
<code class="linenos">21 </code><code class="mi">10</code> <code class="nv">o</code>
<code class="linenos">22 </code><code class="mi">11</code> <code class="nv">l</code>
<code class="linenos">23 </code><code class="mi">12</code> <code class="nv">l</code>
<code class="linenos">24 </code><code class="mi">13</code> <code class="nv">e</code>
<code class="linenos">25 </code><code class="mi">14</code> <code class="nv">d</code>
<code class="linenos">26 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>On line 2, the expression <strong>(enumerate sentence)</strong> generates one character at a time from a string. <strong>enumerate</strong> operating on a list will generate one list element at a time.</p>

<p>Line 9 shows an example of <em>destructuring</em>: the values in the list <strong>vv</strong> are tuples (tuples are like lists but are immutable, that is, once a tuple is constructed the values it holds can not be changed) with two values. The values in each tuple are copied into binding variables in the list <strong>[a b]</strong>. We could have used the following code instead but it is more verbose:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">x</code> <code class="nv">vv</code><code class="p">]</code>
    <code class="p">(</code><code class="kd">setv </code><code class="nv">a</code> <code class="p">(</code><code class="k">first </code><code class="nv">x</code><code class="p">))</code>
    <code class="p">(</code><code class="kd">setv </code><code class="nv">b</code> <code class="p">(</code><code class="nf">second</code> <code class="nv">x</code><code class="p">))</code>
<code class="nv">...</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">a</code> <code class="nv">b</code><code class="p">))</code>
<code class="mi">0</code> <code class="nv">T</code>
<code class="mi">1</code> <code class="nv">h</code>
<code class="mi">2</code> <code class="nv">e</code>
<code class="mi">3</code>  
<code class="mi">4</code> <code class="nv">b</code>
 <code class="nv">.</code> <code class="nv">.</code> <code class="nv">.</code>
<code class="mi">13</code> <code class="nv">e</code>
<code class="mi">14</code> <code class="nv">d</code>
<code class="nv">=&gt;</code> 
</pre></div>

</figure>

<h3 id="leanpub-auto-formatted-output">Formatted Output</h3>

<p>I suggest using the Python <strong>format</strong> method when you need to format output. In the following repl listing, you can see a few formatting options: insert any Hy data into a string (line 3), print values with a specific width and right justified (in line 5 the width for both values is 15 characters), print values with a specific width and left justified (in line 7), and limiting the number of characters values can be expressed as (in line 9 the object “cat” is expressed as just the first two characters and the value 3.14159 is expressed as just three numbers, the period not counting).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">hy</code>
<code class="nv">hy</code> <code class="mf">0.18</code><code class="nv">.0</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.4</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"first: {} second: {}"</code> <code class="s">"cat"</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="ss">'first:</code> <code class="nv">cat</code> <code class="nv">second:</code> <code class="mf">3.14159</code><code class="o">'</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"first: {:&gt;15} second: {:&gt;15}"</code> <code class="s">"cat"</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="ss">'first:</code>             <code class="nv">cat</code> <code class="nv">second:</code>         <code class="mf">3.14159</code><code class="o">'</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"first: {:15} second: {:15}"</code> <code class="s">"cat"</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="ss">'first:</code> <code class="nv">cat</code>             <code class="nv">second:</code>         <code class="mf">3.14159</code><code class="o">'</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"first: {:.2} second: {:.3}"</code> <code class="s">"cat"</code> <code class="mf">3.14159</code><code class="p">)</code>
<code class="ss">'first:</code> <code class="nv">ca</code> <code class="nv">second:</code> <code class="mf">3.14</code><code class="o">'</code>
<code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>Notice the calling <strong>.format</strong> here returns a string value rather than writing to an output stream.</p>

<h3 id="leanpub-auto-importing-libraries-from-different-directories-on-your-laptop">Importing Libraries from Different Directories on Your Laptop</h3>

<p>I usually write applications by first implementing simpler low-level utility libraries that are often not in the same directory path as the application that I am working on. Let’s look at a simple example of accessing the library <strong>nlp_lib.hy</strong> in the directory <strong>hy-lisp-python/nlp</strong> from the directory <strong>hy-lisp-python/webscraping</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">Marks-MacBook:hy-lisp-python</code> <code class="nv">$</code> <code class="nv">pwd</code>
<code class="linenos"> 2 </code><code class="nv">/Users/markw/GITHUB/hy-lisp-python</code>
<code class="linenos"> 3 </code><code class="nv">Marks-MacBook:hy-lisp-python</code> <code class="nv">$</code> <code class="nv">cd</code> <code class="nv">webscraping</code> 
<code class="linenos"> 4 </code><code class="nv">Marks-MacBook:webscraping</code> <code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 5 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 6 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="nv">sys</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">sys.path.insert</code> <code class="mi">1</code> <code class="s">"../nlp"</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">nlp-lib</code> <code class="p">[</code><code class="nv">nlp</code><code class="p">]])</code>
<code class="linenos"> 9 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">nlp</code> <code class="s">"President George Bush went to Mexico and he had a very good meal"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">{</code><code class="ss">'text':</code> <code class="ss">'President</code> <code class="nv">George</code> <code class="nv">Bush</code> <code class="nv">went</code> <code class="nv">to</code> <code class="nv">Mexico</code> <code class="nv">and</code> <code class="nv">he</code> <code class="nv">had</code> <code class="nv">a</code> <code class="nv">very</code> <code class="nv">good</code> <code class="nv">meal</code><code class="o">'</code>, 
<code class="linenos">11 </code>  <code class="nv">...</code>
<code class="linenos">12 </code> <code class="ss">'entities':</code> <code class="p">[[</code><code class="ss">'George</code> <code class="nv">Bush</code><code class="o">'</code>, <code class="ss">'PERSON</code><code class="o">'</code><code class="p">]</code>, <code class="p">[</code><code class="ss">'Mexico</code><code class="o">'</code>, <code class="ss">'GPE</code><code class="o">'</code><code class="p">]]}</code>
<code class="linenos">13 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">coref-nlp-lib</code> <code class="p">[</code><code class="nv">coref-nlp</code><code class="p">]])</code>
<code class="linenos">14 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">coref-nlp</code> <code class="s">"President George Bush went to Mexico and he had a very good meal"</code><code class="p">)</code>
<code class="linenos">15 </code><code class="p">{</code><code class="ss">'corefs':</code> <code class="ss">'President</code> <code class="nv">George</code> <code class="nv">Bush</code> <code class="nv">went</code> <code class="nv">to</code> <code class="nv">Mexico</code> <code class="nv">and</code> <code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush</code> <code class="nv">had</code> <code class="nv">a</code> <code class="nv">ver</code><code class="err">\</code>
<code class="linenos">16 </code><code class="nv">y</code> <code class="nv">good</code> <code class="nv">meal</code><code class="o">'</code>,  <code class="nv">...</code>  <code class="p">}}}</code>
<code class="linenos">17 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>Here I did not install the library <strong>nlp_lib.hy</strong> using Python setuptools (which I don’t cover in this book, you can <a href="https://setuptools.readthedocs.io">read the documentation</a>) as a library on the system. I rely on relative paths between the library directory and the application code that uses the library.</p>

<p>On line 6 I am inserting the library directory into the Python system load path so the import statement on line 8 can find the <strong>nlp-lib</strong> library and on line 13 can find the <strong>coref-nlp-lib</strong> library.</p>

<h3 id="leanpub-auto-using-closures">Using Closures</h3>

<p>Function definitions can capture values defined outside of a function and even change the captured value as seen in this example (file <strong>closure_example.hy</strong> in the directory <strong>hy-lisp-python/misc</strong>):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="nf">require</code> <code class="p">[</code><code class="nv">hy.contrib.walk</code> <code class="p">[</code><code class="nv">let</code><code class="p">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">x</code> <code class="mi">1</code><code class="p">]</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">increment</code> <code class="p">[]</code>
<code class="linenos"> 7 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">x</code> <code class="p">(</code><code class="nf">+</code> <code class="nv">x</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos"> 8 </code>    <code class="nv">x</code><code class="p">))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">increment</code><code class="p">))</code>
<code class="linenos">11 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">increment</code><code class="p">))</code>
<code class="linenos">12 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">increment</code><code class="p">))</code>
</pre></div>

</figure>

<p>That produces:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="mi">2</code>
<code class="mi">3</code>
<code class="mi">4</code>
</pre></div>

</figure>

<p>Using closures is often a good alternative to object oriented programming for maintaining private state that only one or a few functions (that are defined inside the closure) are allowed to access and modify. In the last example the <strong>let</strong> statement could have defined more than one variable with initial values and many functions could have been defined to perform various calculations with the values of these captured variables and/or change the values of captured variables. This effectively hides the variables defined in the <strong>let</strong> statement from code outside of the let statement but the functions are accessible from outside the <strong>let</strong> statement.</p>

<h3 id="leanpub-auto-hy-looks-like-clojure-how-similar-are-they">Hy Looks Like Clojure: How Similar Are They?</h3>

<p><a href="https://clojure.org/">Clojure</a> is a dynamic general purpose Lisp language for the JVM. One of the great Clojure features is support of immutable data (read only after creation) that makes multi-threaded code easier to write and maintain.</p>

<p>Unfortunately, Clojure’s immutable  data structures cannot be easily implemented efficiently in Python so the Hy language does  not support immutable data, except for tuples. Otherwise the syntax for defining functions, using maps/hash tables/dictionaries, etc. is similar between the two languages.</p>

<p>The original Hy language developer Paul Tagliamonte was clearly inspired by Clojure.</p>

<p>The book <strong>Serious Python</strong> by Julien Danjou has an entire chapter (chapter 9) on the Python AST (abstract syntax tree), an introduction to Hy, and an interview with Paul Tagliamonte. Recommended!</p>

<p><a href="https://www.pythonpodcast.com/episode-23-hylang-core-developers/">This podcast</a> in 2015 interviews Hy developers Paul Tagliamonte, Tuukka Turto, and Morten Linderud. You can see the <a href="https://github.com/hylang/hy/graphs/contributors">current Hy contributer list on github</a>.</p>

<h3 id="leanpub-auto-plotting-data-using-the-numpy-and-the-matplotlib-libraries">Plotting Data Using the Numpy and the Matplotlib Libraries</h3>

<p>Data visualization is a common task when working with numeric data. In a later chapter on Deep Learning we will use two functions, the <strong>relu</strong> and <strong>sigmoid</strong> functions. Here we will use a few simple Hy language scripts to plot these functions.</p>

<p>The Numpy library supports what is called “broadcasting” in Python. In the function <strong>sigmoid</strong> that we define in the following REPL, we can pass either a single floating point number or a Numpy array as an argument. When we pass a Numpy array, then the function <strong>sigmoid</strong> is applied to each element of the Numpy array:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">numpy</code> <code class="ss">:as</code> <code class="nv">np</code><code class="p">])</code>
<code class="linenos"> 4 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">matplotlib.pyplot</code> <code class="ss">:as</code> <code class="nv">plt</code><code class="p">])</code>
<code class="linenos"> 5 </code><code class="nv">=&gt;</code> 
<code class="linenos"> 6 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">defn </code><code class="nv">sigmoid</code> <code class="p">[</code><code class="nv">x</code><code class="p">]</code>
<code class="linenos"> 7 </code><code class="nv">...</code>   <code class="p">(</code><code class="nf">/</code> <code class="mf">1.0</code> <code class="p">(</code><code class="nf">+</code> <code class="mf">1.0</code> <code class="p">(</code><code class="nf">np.exp</code> <code class="p">(</code><code class="nf">-</code> <code class="nv">x</code><code class="p">)))))</code>
<code class="linenos"> 8 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">sigmoid</code> <code class="mf">0.2</code><code class="p">)</code>
<code class="linenos"> 9 </code><code class="mf">0.549833997312478</code>
<code class="linenos">10 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">sigmoid</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">11 </code><code class="mf">0.8807970779778823</code>
<code class="linenos">12 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">np.array</code> <code class="p">[</code><code class="mi">-5</code> <code class="mi">-2</code> <code class="mi">0</code> <code class="mi">2</code> <code class="mi">5</code><code class="p">])</code>
<code class="linenos">13 </code><code class="nv">array</code><code class="p">([</code><code class="mi">-5</code>, <code class="mi">-2</code>,  <code class="mi">0</code>,  <code class="mi">2</code>,  <code class="mi">5</code><code class="p">])</code>
<code class="linenos">14 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">sigmoid</code> <code class="p">(</code><code class="nf">np.array</code> <code class="p">[</code><code class="mi">-5</code> <code class="mi">-2</code> <code class="mi">0</code> <code class="mi">2</code> <code class="mi">5</code><code class="p">]))</code>
<code class="linenos">15 </code><code class="nv">array</code><code class="p">([</code><code class="mf">0.00669285</code>, <code class="mf">0.11920292</code>, <code class="mf">0.5</code>, <code class="mf">0.88079708</code>, <code class="mf">0.99330715</code><code class="p">])</code>
<code class="linenos">16 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>The git repository directory <strong>hy-lisp-python/matplotlib</strong> contains two similar scripts for plotting the <strong>sigmoid</strong> and <strong>relu</strong> functions. Here is the script to plot the <strong>sigmoid</strong> function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">numpy</code> <code class="ss">:as</code> <code class="nv">np</code><code class="p">])</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">matplotlib.pyplot</code> <code class="ss">:as</code> <code class="nv">plt</code><code class="p">])</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">sigmoid</code> <code class="p">[</code><code class="nv">x</code><code class="p">]</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nf">/</code> <code class="mf">1.0</code> <code class="p">(</code><code class="nf">+</code> <code class="mf">1.0</code> <code class="p">(</code><code class="nf">np.exp</code> <code class="p">(</code><code class="nf">-</code> <code class="nv">x</code><code class="p">)))))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">X</code> <code class="p">(</code><code class="nf">np.linspace</code> <code class="mi">-8</code> <code class="mi">8</code> <code class="mi">50</code><code class="p">))</code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="nf">plt.plot</code> <code class="nv">X</code> <code class="p">(</code><code class="nf">sigmoid</code> <code class="nv">X</code><code class="p">))</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nf">plt.title</code> <code class="s">"Sigmoid Function"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">(</code><code class="nf">plt.ylabel</code> <code class="s">"Sigmoid"</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">(</code><code class="nf">plt.xlabel</code> <code class="s">"X"</code><code class="p">)</code>
<code class="linenos">12 </code><code class="p">(</code><code class="nf">plt.grid</code><code class="p">)</code>
<code class="linenos">13 </code><code class="p">(</code><code class="nf">plt.show</code><code class="p">)</code>
</pre></div>

</figure>

<p>The generated plot looks like this on macOS (Matplotlib is portable and also works on Windows and Linux):</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/sigmoid.png" alt="Sigmoid Function" style="width: 100%">
    <figcaption>Sigmoid Function</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-bonus-points-configuration-for-macos-and-iterm2-for-generating-plots-inline-in-a-hy-repl-and-shell">Bonus Points: Configuration for macOS and ITerm2 for Generating Plots Inline in a Hy REPL and Shell</h3>

<p>On the macOS ITerm2 terminal app and on most Linux terminal apps, it is possible to get inline matplotlib plots in a shell (bash, zsh, etc.), in Emacs, etc. This will take some setup work but it is well worth it especially if you work on remote servers via SSH or tmux. Here is the setup for macOS:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="nv">pip3</code> <code class="nv">install</code> <code class="nv">itermplot</code>
</pre></div>

</figure>

<p>The add the following to your .profile, .bash_profile, or .zshrc (depending on your shell setup):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>  <code class="nb">export</code> <code class="nv">MPLBACKEND=</code><code class="s">"module://itermplot"</code>
</pre></div>

</figure>

<p>Here we run an example from the last section in a zsh shell (bash, etc. also should work):</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 467px">
    <img src="images/mac-inline-matplotlib.png" alt="Inline matplotlib use in zsh shell in an ITerm on macOS" style="width: 100%">
    <figcaption>Inline matplotlib use in zsh shell in an ITerm on macOS</figcaption>
  </figure>
</div>


<p>The best part of generating inline plots is during interactive REPL-based coding sessions:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/mac-inline-matplotlib2.png" alt="Inline matplotlib use in a Hy REPL on macOS" style="width: 100%">
    <figcaption>Inline matplotlib use in a Hy REPL on macOS</figcaption>
  </figure>
</div>


<p>If you use a Mac laptop to SSH into a remote Linux server you need to install <strong>itermplot</strong> and set the environment variable <strong>MPLBACKEND</strong> on the remote server.</p>


<h2 id="leanpub-auto-why-lisp">Why Lisp?</h2>

<p>Now that we have learned the basics of the Hy Lisp language in the last chapter, I would like to move our conversation to a broader question of why we would want to use Lisp. I want to start with my personal history of why I turned to Lisp languages in the late 1970s for almost all of my creative and research oriented development and later transitioned to also using Lisp languages in production.</p>

<h3 id="leanpub-auto-i-hated-the-waterfall-method-in-the-1970s-but-learned-to-love-a-bottom-up-programming-style">I Hated the Waterfall Method in the 1970s but Learned to Love a Bottom-Up Programming Style</h3>

<p>I graduated UCSB in the mid 1970s with a degree in Physics and took a job as a scientific programmer in the 100% employee owned company SAIC. My manager had a PhD in Computer Science and our team and the organization we were in used what is known as the waterfall method where systems were designed carefully from the top down, carefully planned mostly in their entirety, and then coded up. We, and the whole industry I would guess, wasted a lot of time with early planning and design work that had to be discarded or heavily modified after some experience implementing the system.</p>

<p>What would be better? I grew to love bottom-up programming. When I was given a new project I would start by writing and testing small procedures for low level operations, things I was sure I would need. I then aggregated the functionality into higher levels of control logic, access to data, etc. Finally I would write the high level application.</p>

<p>I mostly did this for a while writing code in FORTRAN at SAIC and using Algol for weekend consulting work Salk Institute, working on hooking up lab equipment to minicomputers in Roger Guillemin’s lab (he won a Nobel Prize during that time, which was exciting). Learning Algol, a very different language than FORTRAN, helped broaden my perspectives.</p>

<p>I wanted a better programming language! I also wanted a more productive way to do my job both as a programmer and to make the best use of the few free hours a week that I had for my own research and learning about artificial intelligence (AI). I found my “better way” of development by adopting a bottom-up style that involves first writing low level libraries and utilities and then layering complete programs on top of well tested low level code.</p>

<h3 id="leanpub-auto-first-introduction-to-lisp">First Introduction to Lisp</h3>

<p>In the late 1970s I discovered a Lisp implementation on my company’s DECsystem-10 timesharing computer. I had heard of Lisp in reading Bertram Raphael’s book “THE THINKING COMPUTER. Mind Inside Matter” and I learned Lisp on my own time and then, during lunch hour, taught a one day a week class to anyone at work who wanted to learn Lisp. After a few months of Lisp experience I received permission to teach an informal lunch time class to teach anyone working in my building who wanted to to learn Lisp on our DECsystem-10.</p>

<p>Lisp is the perfect language to support the type of bottom-up iterative programming style that I like.</p>

<h3 id="leanpub-auto-commercial-product-development-and-deployment-using-lisp">Commercial Product Development and Deployment Using Lisp</h3>

<p>My company, SAIC, identified AI as an important technology in the early 1980s. Two friends at work (Bob Beyster who founded SAIC and Joe Walkush who was our corporate treasurer and who liked Lisp from his engineering studies at MIT) arranged for the company to buy a hardware Lisp Machine, a Xerox 1108 for me. I ported Charles Forgy’s expert system development language OPS5 to run on InterLisp-D on the Xerox Lisp Machines and we successfully sold this as a product. When Coral Common Lisp was released for the Apple Macintosh in 1984, I switched my research and development to the Mac and released ExperOPS5, which also sold well, and used Common Lisp to write the first prototypes for SAIC’s ANSim neural network library. I converted my code to C++ to productize it. We also continued to use Lisp for IR&amp;D projects and while working on the DARPA NMRD project.</p>

<p>Even though I proceeded to use C++ for much of my development, as well as writing C++ books for McGraw-Hill and J. Riley publishers, Lisp remained my “thinking and research” language.</p>

<h3 id="leanpub-auto-hy-macros-let-you-extend-the-hy-language-in-your-programs">Hy Macros Let You Extend the Hy Language in Your Programs</h3>

<p>In my work I seldom use macros since I mostly write application type programs. Macros are useful for extending the syntax allowed for programs written in Lisp languages.</p>

<p>My most common use of macros is flexibly handling arguments without evaluating them. In the following example I want to write a macro <strong>all-to-string</strong> that takes a list of objects that can include undefined symbols. For example, if the variable <strong>x</strong> is undefined, then trying to evaluate <strong>(print x 1)</strong> will throw an error like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">NameError:</code> <code class="nv">name</code> <code class="ss">'x</code><code class="o">'</code> <code class="nv">is</code> <code class="nb">not</code> <code class="nv">defined</code>
</pre></div>

</figure>

<p>The following listing shows my experiments in a Hy REPL to write the macro <strong>all-to-string</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">map</code> <code class="nb">str</code> <code class="p">[</code><code class="s">"a"</code> <code class="mi">4</code><code class="p">]))</code>
<code class="linenos"> 4 </code><code class="p">[</code><code class="ss">'a</code><code class="o">'</code>, <code class="ss">'4</code><code class="o">'</code><code class="p">]</code>
<code class="linenos"> 5 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">.join</code> <code class="s">" "</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">map</code> <code class="nb">str</code> <code class="p">[</code><code class="s">"a"</code> <code class="mi">4</code><code class="p">])))</code>
<code class="linenos"> 6 </code><code class="ss">'a</code> <code class="mi">4</code><code class="o">'</code>
<code class="linenos"> 7 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">defmacro </code><code class="nv">foo2</code> <code class="p">[</code><code class="o">&amp;</code><code class="k">rest </code><code class="nv">x</code><code class="p">]</code> <code class="nv">x</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="nv">&lt;function</code> <code class="nv">foo2</code> <code class="nv">at</code> <code class="mi">0</code><code class="nv">x10b91b488&gt;</code>
<code class="linenos"> 9 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">foo2</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">[</code><code class="mi">1</code>, <code class="mi">2</code>, <code class="mi">3</code><code class="p">]</code>
<code class="linenos">11 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">foo2</code> <code class="mi">1</code> <code class="nv">runpuppyrun</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">12 </code><code class="nv">Traceback</code> <code class="p">(</code><code class="nf">most</code> <code class="nv">recent</code> <code class="nv">call</code> <code class="nv">last</code><code class="p">)</code><code class="nv">:</code>
<code class="linenos">13 </code>  <code class="nv">File</code> <code class="s">"stdin-3241d1d4f129e0da87f331bfe8f9f7aba903073a"</code>, <code class="nv">line</code> <code class="mi">1</code>, <code class="k">in </code><code class="nv">&lt;module&gt;</code>
<code class="linenos">14 </code>    <code class="p">(</code><code class="nf">foo2</code> <code class="mi">1</code> <code class="nv">runpuppyrun</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">15 </code><code class="ne">NameError</code><code class="nv">:</code> <code class="nv">name</code> <code class="ss">'runpuppyrun</code><code class="o">'</code> <code class="k">is </code><code class="nv">not</code> <code class="nv">defined</code>
<code class="linenos">16 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">defmacro </code><code class="nb">all</code><code class="nv">-to-string</code> <code class="p">[</code><code class="o">&amp;</code><code class="k">rest </code><code class="nv">x</code><code class="p">]</code> <code class="p">(</code><code class="nf">.join</code> <code class="s">" "</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">map</code> <code class="nb">str</code> <code class="nv">x</code><code class="p">))))</code>
<code class="linenos">17 </code><code class="nv">&lt;function</code> <code class="nb">all</code><code class="nv">-to-string</code> <code class="nv">at</code> <code class="mi">0</code><code class="nv">x10b91b158&gt;</code>
<code class="linenos">18 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">all</code><code class="nv">-to-string</code> <code class="nv">cater123</code> <code class="mi">22</code><code class="p">)</code>
<code class="linenos">19 </code><code class="ss">'cater123</code> <code class="mi">22</code><code class="o">'</code>
<code class="linenos">20 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">all</code><code class="nv">-to-string</code> <code class="nv">the</code> <code class="nv">boy</code> <code class="nv">ran</code> <code class="nv">to</code> <code class="k">get </code><code class="mi">1</code> <code class="nv">new</code> <code class="nv">helmet</code><code class="p">)</code>
<code class="linenos">21 </code><code class="ss">'the</code> <code class="nv">boy</code> <code class="nv">ran</code> <code class="nv">to</code> <code class="k">get </code><code class="mi">1</code> <code class="nv">new</code> <code class="nv">helmet</code><code class="o">'</code>
<code class="linenos">22 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">all</code><code class="nv">-to-string</code> <code class="nv">the</code> <code class="nv">boy</code> <code class="s">"ran"</code> <code class="nv">to</code> <code class="k">get </code><code class="mi">1</code> <code class="s">"new"</code> <code class="nv">helmet</code><code class="p">)</code>
<code class="linenos">23 </code><code class="ss">'the</code> <code class="nv">boy</code> <code class="nv">ran</code> <code class="nv">to</code> <code class="k">get </code><code class="mi">1</code> <code class="nv">new</code> <code class="nv">helmet</code><code class="o">'</code>
<code class="linenos">24 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>My first try in line 7 did not work, the macro just returning a function that echos the arguments but throws an error (line 50) when one of the arguments is a symbol with no definition. The second try on line 16 works as intended because we are mapping the function <strong>str</strong> (which coerces any argument into a string) over the argument list.</p>

<h3 id="leanpub-auto-performing-bottom-up-development-inside-a-repl-is-a-lifestyle-choice">Performing Bottom Up Development Inside a REPL is a Lifestyle Choice</h3>

<p>It is my personal choice to prefer a bottom up style of coding, effectively extending the Hy (or other Lisp) language to look like something that looks custom designed and built to solve a specific problem. This is possible in Lisp languages because once a function or macro is defined, it is for our purposes part of the Hy language. If, for example, you are writing a web application that uses a database then I believe that it makes sense to first write low level functions to perform operations that you know you will need, for example, for creating and updating customer data from the database, utility functions used in a web application (which we cover in the next chapter), etc. For the rest of your application, you use these new low level functions as if they were built into the language.</p>

<p>When I need to write a new low-level function, I start in a REPL and define variables (with test values) for what the function arguments will be. I then write the code for the function one line at a time using these “arguments” in expressions that will later be copied to a Hy source file. Immediately seeing results in a REPL helps me catch mistakes early, often a misunderstanding of the type or values of intermediate calculations. This style of coding works for me and I hope you like it also.</p>


<h2 id="leanpub-auto-running-hy-in-jupyter-notebooks">Running Hy in Jupyter Notebooks</h2>

<p>This chapter is optional material for running many of the examples in this book in Jupyter notebooks. If you don’t mind taking a few minutes to install Jupyter Notebooks and the <a href="https://github.com/Calysto/calysto_hy">Hy kernal by Calysto</a> using the notebooks for this chapter is a fast overview for the material in this book. Alternatively, you might want to read the rest of the book first to better understand the examples and then revisit this chapter later.</p>

<h3 id="leanpub-auto-install-requirements">Install Requirements</h3>

<p>Assuming that you have a recent Python 3.x and Hy installed, you will additionally need:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>pip install jupyter
<code class="linenos">2 </code>pip install git+https://github.com/ekaschalk/jedhy.git
<code class="linenos">3 </code>pip install git+https://github.com/Calysto/calysto_hy.git
<code class="linenos">4 </code>python -m calysto_hy install
</pre></div>

</figure>

<p>I stored the Jupyter Notebook files in a separate github repository that you will want to clone:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>git clone https://github.com/mark-watson/hylang-jupyter-notesbooks.git
<code class="linenos">2 </code><code class="nb">cd</code> hylang-jupyter-notesbooks
</pre></div>

</figure>

<p>From insdie the directory hylang-jupyter-notesbooks, you can now run Jupyter with the newly installed Calysto Hy kernel using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>jupyter console --kernel calysto_hy
</pre></div>

</figure>

<p>The <strong>File</strong> menu can then be used to open the sample Jupiter Notebooks from this git repository.</p>


<h2 id="leanpub-auto-writing-web-applications">Writing Web Applications</h2>

<p>Python has good libraries and frameworks for building web applications and here we will use the <strong>Flask</strong> library and framework “under the hood” and write two simple Hy Language web applications. We will start with a simple “Hello World” example in Python, see how to reformulate it in Hy, and then proceed with more complex examples that will show how to use HTML generating templates, sessions, and cookies to store user data for the next time they visit your web site. In a later chapter we will cover use of the SQLite and PostgreSQL databases which are commonly used to persist data for users in web applications. This pattern involves letting a user login and store a unique token for the user in a web browser cookie. In principle, you can do the same with web browser cookies but if a user visits your web site with a different browser or device then they will not have access to the data stored in cookies on a previous visit.</p>

<p>I like lightweight web frameworks. In Ruby I use Sinatra, in Haskell I use Spock, and when I built Java web apps I liked lightweight tools like JSP. Flask is simple but capable and using it from Hy is productive and fun. In addition to using lightweight frameworks I like to deploy web apps in the simplest way possible. We will close this chapter by discussing how to use the Heroku and Google Cloud Platform AppEngine platforms.</p>

<h3 id="leanpub-auto-getting-started-with-flask-using-python-decorators-in-hy">Getting Started With Flask: Using Python Decorators in Hy</h3>

<p>You will need to install Flask using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">pip</code> <code class="nv">install</code> <code class="nv">flask</code>
</pre></div>

</figure>

<p>We will use the Hy macro <strong>with-decorator</strong> to replace Python code with annotations. Here the decorator <strong>@app.route</strong> is used to map a URI pattern with a Python callback function. In the following case we define the behavior when the index page of a web app is accessed:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">Flask</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="nd">@app</code><code class="o">.</code><code class="n">route</code><code class="p">(</code><code class="s1">'/'</code><code class="p">)</code>
<code class="linenos">4 </code>  <code class="k">def</code> <code class="nf">index</code><code class="p">():</code>
<code class="linenos">5 </code>     <code class="k">return</code> <code class="s2">"Hello World !"</code><code class="p">)</code>
<code class="linenos">6 </code>
<code class="linenos">7 </code><code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">()</code>
</pre></div>

</figure>

<p>I first used Flask with the Hy language after seeing a post of code from HN user “volent”, seen in the file <strong>flask_test.hy</strong> in the directory <strong>hy-lisp-python/webapp</strong> that is functionally equivalent to the above Python code snippet:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">;; snippet by HN user volent:</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">flask</code> <code class="p">[</code><code class="nv">Flask</code><code class="p">]])</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">app</code> <code class="p">(</code><code class="nf">Flask</code> <code class="s">"Flask test"</code><code class="p">))</code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/"</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">index</code> <code class="p">[]</code>
<code class="linenos">10 </code>    <code class="s">"Hello World !"</code><code class="p">))</code>
<code class="linenos">11 </code><code class="p">(</code><code class="nf">app.run</code><code class="p">)</code>
</pre></div>

</figure>

<p>The Hy macro <strong>with-decorator</strong> macro is used to use Python style decorators in Hy applications.</p>

<p>I liked this example and after experimenting with the code, I then started using Hy and Flask. Please try running this example to make sure you are setup properly with Flask:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">(</code>base<code class="o">)</code> Marks-MacBook:webapp $ ./flask_test.hy 
 * Serving Flask app <code class="s2">"Flask test"</code> <code class="o">(</code>lazy loading<code class="o">)</code>
 * Environment: production
   WARNING: This is a development server. Do not use it <code class="k">in</code> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://127.0.0.1:5000/ <code class="o">(</code>Press CTRL+C to quit<code class="o">)</code>
</pre></div>

</figure>

<p>Open <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> in your web browser:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 469px">
    <img src="images/flask1.jpg" alt="Hello world Flask web app" style="width: 100%">
    <figcaption>Hello world Flask web app</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-using-jinja2-templates-to-generate-html">Using Jinja2 Templates To Generate HTML</h3>

<p><a href="https://pypi.org/project/Jinja2/">Jinja2</a> is a templating system that allows HTML markup to be supplemented with Python variable references and simple Python loops, etc. The values of application variables can be stored in a context and the HTML template has the variables values substituted with current values before returning a HTML response to the user’s web browser.</p>

<p>By default Jinja2 templates are stored in a subdirectory named <strong>templates</strong>. The template for this example can be found in the file <strong>hy-lisp-python/webapp/templates/template1.j2</strong> that is shown here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
<code class="linenos"> 2 </code>  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="linenos"> 3 </code>    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Testing Jinja2 and Flask with the Hy language<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
<code class="linenos"> 4 </code>  <code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
<code class="linenos"> 5 </code>  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="linenos"> 6 </code>     {% if name %}
<code class="linenos"> 7 </code>       <code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code>Hello {{name}}<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>
<code class="linenos"> 8 </code>     {% else %}
<code class="linenos"> 9 </code>       <code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code>Hey, please enter your name!<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>
<code class="linenos">10 </code>     {% endif %}
<code class="linenos">11 </code>    
<code class="linenos">12 </code>    <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/response"</code><code class="p">&gt;</code>
<code class="linenos">13 </code>      Name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"name"</code> <code class="na">required</code><code class="p">&gt;</code>
<code class="linenos">14 </code>      <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"Submit"</code><code class="p">&gt;</code>
<code class="linenos">15 </code>    <code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
<code class="linenos">16 </code>  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="linenos">17 </code><code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Note that in line 6 we are using a Python <strong>if</strong> expression to check if the variable <strong>name</strong> is defined in the current app execution context.</p>

<p>In the context of a running Flask app, the following will render the above template with the variable <strong>name</strong> defined as <strong>None</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code><code class="p">)</code>
</pre></div>

</figure>

<p>We can set values as named parameters for variables used in the template, for example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="s">"Mark"</code><code class="p">)</code>
</pre></div>

</figure>

<p>I am assuming that you understand the basics or HTML and also GET and POST operations in HTTP requests.</p>

<p>The following Flask web app defines behavior for rendering the template without the variable <strong>name</strong> set and also a HTML POST handler to pass the name entered on the HTML form back to the POST response handler:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">flask</code> <code class="p">[</code><code class="nv">Flask</code> <code class="nv">render_template</code> <code class="nv">request</code><code class="p">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">app</code> <code class="p">(</code><code class="nf">Flask</code> <code class="s">"Flask and Jinja2 test"</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/"</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">index</code> <code class="p">[]</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code><code class="p">)))</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/response"</code> <code class="ss">:methods</code> <code class="p">[</code><code class="s">"POST"</code><code class="p">])</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">response</code> <code class="p">[]</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">name</code> <code class="p">(</code><code class="nf">request.form.get</code> <code class="s">"name"</code><code class="p">))</code>
<code class="linenos">14 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="nv">name</code><code class="p">)))</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="p">(</code><code class="nf">app.run</code><code class="p">)</code>
</pre></div>

</figure>

<p>Please note that there is nothing special about the names inside the <strong>with-decorator</strong> code blocks: the functions <strong>index</strong> and <strong>response</strong> could have arbitrary names like <strong>a123</strong> an <strong>b17</strong>. I used the function names <strong>index</strong> and <strong>response</strong> because they help describe what the functions do.</p>

<p>Open <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> in your web browser:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/flask2.jpg" alt="Flask web app using a Jinja2 Template" style="width: 100%">
    <figcaption>Flask web app using a Jinja2 Template</figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 469px">
    <img src="images/flask3.jpg" alt="Flask web app using a Jinja2 Template after entering my name and submitting the HTML input form" style="width: 100%">
    <figcaption>Flask web app using a Jinja2 Template after entering my name and submitting the HTML input form</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-handling-http-sessions-and-cookies">Handling HTTP Sessions and Cookies</h3>

<p>There is a special variable <strong>session</strong> that Flask maintains for each client of a Flask web app. Different people using a web app will have independent sessions. In a web app, we can set a session value by treating the session for a given user as a dictionary:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">=</code>&gt; <code class="o">(</code>setv <code class="o">(</code>get session <code class="s2">"name"</code><code class="o">)</code> <code class="s2">"Mark"</code><code class="o">)</code>
<code class="o">=</code>&gt; session
<code class="o">{</code><code class="s1">'name'</code>: <code class="s1">'Mark'</code><code class="o">}</code>
</pre></div>

</figure>

<p>Inside a Jinja2 template you can use a simple Python expression to place a session variable’s value into the HTML generated from a template:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">{{</code> <code class="nv">session[</code><code class="ss">'name']</code> <code class="nv">}}</code>
</pre></div>

</figure>

<p>In a web app you can access the session using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="k">get </code><code class="nv">session</code> <code class="s">"name"</code><code class="p">)</code>
</pre></div>

</figure>

<p>In order to set the value of a named cookie, we can:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">flask</code> <code class="p">[</code><code class="nv">Flask</code> <code class="nv">render_template</code> <code class="nv">request</code> <code class="nv">make_response</code><code class="p">]])</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/response"</code> <code class="ss">:methods</code> <code class="p">[</code><code class="s">"POST"</code><code class="p">])</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">response</code> <code class="p">[]</code>
<code class="linenos">5 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">name</code> <code class="p">(</code><code class="nf">request.form.get</code> <code class="s">"name"</code><code class="p">))</code>
<code class="linenos">6 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">resp</code> <code class="p">(</code><code class="nf">make_reponse</code> <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="nv">name</code><code class="p">)))</code>
<code class="linenos">7 </code>    <code class="p">(</code><code class="nf">resp.set_cookie</code> <code class="s">"name"</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">8 </code>    <code class="nv">resp</code><code class="p">))</code>
</pre></div>

</figure>

<p>Values of named cookies can be retrieved using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nf">request.cookies.get</code> <code class="s">"name"</code><code class="p">)</code>
</pre></div>

</figure>

<p>inside of a <strong>with-decorator</strong> form. The value for <strong>request</strong> is defined in the execution context by Flask when handling HTTP requests. Here is a complete example of handling cookies in the file <em>cookie_test.hy</em>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">flask</code> <code class="p">[</code><code class="nv">Flask</code> <code class="nv">render_template</code> <code class="nv">request</code> <code class="nv">make-response</code><code class="p">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">app</code> <code class="p">(</code><code class="nf">Flask</code> <code class="s">"Flask and Jinja2 test"</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/"</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">index</code> <code class="p">[]</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">cookie-data</code> <code class="p">(</code><code class="nf">request.cookies.get</code> <code class="s">"hy-cookie"</code><code class="p">))</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="nb">print</code> <code class="s">"cookie-data:"</code> <code class="nv">cookie-data</code><code class="p">)</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">a-response</code> <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="nv">cookie-data</code><code class="p">))</code>
<code class="linenos">12 </code>    <code class="nv">a-response</code><code class="p">))</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/response"</code> <code class="ss">:methods</code> <code class="p">[</code><code class="s">"POST"</code><code class="p">])</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">response</code> <code class="p">[]</code>
<code class="linenos">16 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">name</code> <code class="p">(</code><code class="nf">request.form.get</code> <code class="s">"name"</code><code class="p">))</code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">a-response</code> <code class="p">(</code><code class="nf">make-response</code> <code class="p">(</code><code class="nf">render-template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="nv">name</code><code class="p">)))</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nf">a-response.set-cookie</code> <code class="s">"hy-cookie"</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">20 </code>    <code class="nv">a-response</code><code class="p">))</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="p">(</code><code class="nf">app.run</code><code class="p">)</code>
</pre></div>

</figure>

<p>I suggest that you not only try running this example as-is but also try changing the template, and generally experiment with the code. Making even simple code changes helps to understand the code better.</p>

<h3 id="leanpub-auto-deploying-hy-language-flask-apps-to-google-cloud-platform-appengine">Deploying Hy Language Flask Apps to Google Cloud Platform AppEngine</h3>

<p>The example for this section is in a <a href="https://github.com/mark-watson/hy-lisp-gcp-starter-project">separate github repository</a> that you should clone or copy to a new project for a starter project if you intend to deploy to AppEngine.</p>

<p>This AppEngine example is very similar to that in the last section except that it also serves a static asset and has a small Python stub main program to load the Hy language library and import the Hy language code.</p>

<p>Here is the Python stub main program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">import </code><code class="nv">hy</code>
<code class="linenos">2 </code><code class="k">import </code><code class="nv">flask_test</code>
<code class="linenos">3 </code><code class="nv">from</code> <code class="nv">flask_test</code> <code class="k">import </code><code class="nv">app</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="k">if</code> <code class="nv">__name__</code> <code class="nv">==</code> <code class="ss">'__main__':</code>
<code class="linenos">6 </code>    <code class="o">#</code> <code class="nv">Used</code> <code class="k">when </code><code class="nv">running</code> <code class="nv">locally</code> <code class="nv">only.</code> <code class="nv">When</code> <code class="nv">deploying</code> <code class="nv">to</code> <code class="nv">Google</code> <code class="nv">App</code>
<code class="linenos">7 </code>    <code class="o">#</code> <code class="nv">Engine</code>, <code class="nv">a</code> <code class="nv">webserver</code> <code class="nv">process</code> <code class="nv">such</code> <code class="k">as</code> <code class="nv">Gunicorn</code> <code class="nv">will</code> <code class="nv">serve</code> <code class="nv">the</code> <code class="nv">app.</code>
<code class="linenos">8 </code>    <code class="nv">app.run</code><code class="p">(</code><code class="nf">host=</code><code class="ss">'localhost</code><code class="o">'</code>, <code class="nv">port=9090</code>, <code class="nv">debug=True</code><code class="p">)</code>
</pre></div>

</figure>

<p>The Hy app is slightly different than we saw in the last section. On line 6 we specify the location of static assets and we do not call the <strong>run()</strong> method on the <strong>app</strong> object.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">flask</code> <code class="p">[</code><code class="nv">Flask</code> <code class="nv">render_template</code> <code class="nv">request</code><code class="p">]])</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="k">import </code><code class="nv">os</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">port</code> <code class="p">(</code><code class="nb">int</code> <code class="p">(</code><code class="nf">os.environ.get</code> <code class="s">"PORT"</code> <code class="mi">5000</code><code class="p">)))</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">app</code> <code class="p">(</code><code class="nf">Flask</code> <code class="s">"Flask test"</code> <code class="ss">:static_folder</code> <code class="s">"./static"</code> <code class="ss">:static_url_path</code> <code class="s">"/static"</code><code class="p">))</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/"</code><code class="p">)</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">index</code> <code class="p">[]</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code><code class="p">)))</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/response"</code> <code class="ss">:methods</code> <code class="p">[</code><code class="s">"POST"</code><code class="p">])</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">response</code> <code class="p">[]</code>
<code class="linenos">14 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">name</code> <code class="p">(</code><code class="nf">request.form.get</code> <code class="s">"name"</code><code class="p">))</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="nv">name</code><code class="p">)))</code>
</pre></div>

</figure>

<p>I assume that you have some experience with GCP and have the following:</p>

<ul>
  <li>GCP command line tools installed.</li>
  <li>You have created a new project on the GCP AppEngine console named something like hy-gcp-test (if you choose a name already in use, you wil get a warning).</li>
</ul>

<p>After cloning or otherwise copying this project, you use the command line tools to deploy and test your Flask app:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">gcloud</code> <code class="nv">auth</code> <code class="nv">login</code>
<code class="nv">gcloud</code> <code class="nv">config</code> <code class="nb">set</code> <code class="nv">project</code> <code class="nv">hy-gcp-test</code>
<code class="nv">gcloud</code> <code class="nv">app</code> <code class="nv">deploy</code>
<code class="nv">gcloud</code> <code class="nv">app</code> <code class="nv">browse</code>
</pre></div>

</figure>

<p>If you have problems, look at your logs:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">gcloud</code> <code class="nv">app</code> <code class="nv">logs</code> <code class="nv">tail</code> <code class="nv">-s</code> <code class="nv">default</code>
</pre></div>

</figure>

<p>You can edit changes locally and test locally using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">python</code> <code class="nv">main.py</code>
</pre></div>

</figure>

<p>Any changes can be tested by deploying again:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">gcloud</code> <code class="nv">app</code> <code class="nv">deploy</code>
</pre></div>

</figure>

<p>Please note that everytime you deploy, a new instance is created. You will want to use the GCP AppEngine console to remove old instances, and remove all instances when you are done.</p>

<h4 id="leanpub-auto-going-forward">Going forward</h4>

<p>You can make a copy of this example, create a github repo, and follow the above directions as a first step to creating Hy language application on AppEngine. The Google Cloud Platform has many services that you can use in your app (using the Python APIs, called from your Hy program), including:</p>

<ul>
  <li>Storage and Databases.</li>
  <li>Big Data.</li>
  <li>Machine Learning.</li>
</ul>

<h3 id="leanpub-auto-deploying-hy-language-flask-apps-to-the-heroku-platform">Deploying Hy Language Flask Apps to the Heroku Platform</h3>

<p>The example for this section is in a <a href="https://github.com/mark-watson/hy-lisp-heroku-starter-project">separate github repository</a> that you should clone or otherwise use as starter project if you intend to deploy to the Heroku platform.</p>

<p>We use a Python stub program <strong>wsgi.python</strong> to make our Flask app work with the WSGI interface that Heroku uses:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">import </code><code class="nv">hy</code>
<code class="k">import </code><code class="nv">flask_test</code>
<code class="nv">from</code> <code class="nv">flask_test</code> <code class="k">import </code><code class="nv">app</code>
</pre></div>

</figure>

<p>The Heroku platform will call the <strong>run()</strong> method on the imported <strong>app</strong> object because of the settings in the Heroku <strong>Proc</strong> file for this project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">web:</code> <code class="nv">gunicorn</code> <code class="ss">'wsgi:app</code><code class="o">'</code> <code class="nv">--log-file</code> <code class="nv">-</code>
</pre></div>

</figure>

<p>Here we are stating to the Heroku platform that we want the production-friendly <strong>gunicorn</strong> server to call the <strong>run()</strong> method on the <strong>app</strong> object that is defined in the <strong>wsgi</strong> module (here the module name is the prefix name of the Python WSGI handler file).</p>

<p>The Hy Flask app has a few changes from earlier examples. All changes are in line 3:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">flask</code> <code class="p">[</code><code class="nv">Flask</code> <code class="nv">render_template</code> <code class="nv">request</code><code class="p">]])</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">app</code> <code class="p">(</code><code class="nf">Flask</code> <code class="s">"Flask test"</code> <code class="ss">:static_folder</code> <code class="s">"./static"</code> <code class="ss">:static_url_path</code> <code class="s">"/"</code><code class="p">))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/"</code><code class="p">)</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">index</code> <code class="p">[]</code>
<code class="linenos"> 7 </code>    <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code><code class="p">)))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="k">with</code><code class="nv">-decorator</code> <code class="p">(</code><code class="nf">app.route</code> <code class="s">"/response"</code> <code class="ss">:methods</code> <code class="p">[</code><code class="s">"POST"</code><code class="p">])</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">response</code> <code class="p">[]</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">name</code> <code class="p">(</code><code class="nf">request.form.get</code> <code class="s">"name"</code><code class="p">))</code>
<code class="linenos">12 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="nf">render_template</code> <code class="s">"template1.j2"</code> <code class="ss">:name</code> <code class="nv">name</code><code class="p">)))</code>
</pre></div>

</figure>

<p>You need to install the Heroku command line tools:</p>

<p><a href="https://devcenter.heroku.com/categories/command-line">https://devcenter.heroku.com/categories/command-line</a></p>

<p>After checking out this repo, do the following from this directory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">heroku</code> <code class="nv">login</code>
<code class="nv">heroku</code> <code class="nv">create</code>
<code class="nv">git</code> <code class="nb">push</code> <code class="nv">heroku</code> <code class="nv">master</code>
</pre></div>

</figure>

<p>If you have your Heroku account setup these commands will deploy this example.</p>

<p>You can look at the Heroku log files for your application using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">heroku</code> <code class="nv">logs</code> <code class="nv">--tail</code>
</pre></div>

</figure>

<p>You can open this Hello World app in your default web browser using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">heroku</code> <code class="nb">open</code>
</pre></div>

</figure>

<p>By default, your Hello World app will run on the free Heroku mode. You should still remove it when you are done:</p>

<ul>
  <li>login to:  https://dashboard.heroku.com/apps</li>
  <li>click on your application name</li>
  <li>click on the Settings tab</li>
  <li>scroll to the bottom of the page and use the option to delete the app</li>
</ul>

<h4 id="leanpub-auto-going-forward-1">Going forward</h4>

<p>You can make a copy of this example, create a github repo, and follow the above directions.</p>

<p>To test your Heroku setup locally or for development, you can use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">heroku</code> <code class="nv">local</code>
</pre></div>

</figure>

<p>The Heroku platform has a wide variety of supported services, including many third party services like <a href="https://www.heroku.com/managed-data-services">data services</a> and <a href="https://elements.heroku.com/addons">Heroku and third party addons</a>.</p>

<h3 id="leanpub-auto-wrap-up">Wrap-up</h3>

<p>I like to be able to implement simple things simply, without a lot of ceremony. Once you work through these examples I hope you feel that you can generate Hy and Flask based web apps quickly and with very little code required.</p>

<p>To return to the theme of bottom-up programming, I find that starting with short low level utility functions and placing them in a separate file makes reuse simple and makes future similar projects even easier. For each language I work with, I collect snippets of useful code and short utilities kept in separate files. When writing code I start looking in my snippets directory for the language I am using to implement low level functionality even before doing a web search. When I work in Common Lisp I keep all low level code that I have written in small libraries contained a single Quicklisp source root directory and for Python and Hy I use Python’s <strong>setuptools</strong> library to generate libraries that are installed globally on my laptop for easy reuse. It is worth some effort to organize your work for future reuse.</p>


<h2 id="leanpub-auto-responsible-web-scraping">Responsible Web Scraping</h2>

<p>I put the word “Responsible” in the chapter title to remind you that just because it is easy (as we will soon see) to pull data from web sites, it is important to respect the property rights of web site owners and abide by their terms and conditions for use. This <a href="https://en.wikipedia.org/wiki/Fair_use">Wikipedia article on Fair Use</a> provides a good overview of using copyright material.</p>

<p>The web scraping code we develop here uses the Python BeautifulSoup and URI libraries.</p>

<p>For my work and research, I have been most interested in using web scraping to collect text data for natural language processing but other common applications include writing AI news collection and summarization assistants, trying to predict stock prices based on comments in social media which is what we did at Webmind Corporation in 2000 and 2001, etc.</p>

<h3 id="leanpub-auto-using-the-python-beautifulsoup-library-in-the-hy-language">Using the Python BeautifulSoup Library in the Hy Language</h3>

<p>There are many good libraries for parsing HTML text and extracting both structure (headings, what is in bold font, etc.) and embedded raw text. I particularly like the Python Beautiful Soup library and we will use it here.</p>

<p>In line 4 for the following listing of file <strong>get_web_page.hy</strong>, I am setting the default user agent to a descriptive string “HyLangBook” but for some web sites you might need to set this to appear as a Firefox or Chrome browser (iOS, Android, Windows, Linux, or macOS). The function <strong>get-raw-data</strong> gets the entire contents of a web site as a single string value.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">urllib.request</code> <code class="p">[</code><code class="nv">Request</code> <code class="nv">urlopen</code><code class="p">]])</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-raw-data-from-web</code> <code class="p">[</code><code class="nv">aUri</code>
<code class="linenos">4 </code>                             <code class="o">&amp;</code><code class="nv">optional</code> <code class="p">[</code><code class="nv">anAgent</code> <code class="p">{</code><code class="s">"User-Agent"</code> <code class="s">"HyLangBook/1.0"</code><code class="p">}]]</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">req</code> <code class="p">(</code><code class="nf">Request</code> <code class="nv">aUri</code> <code class="ss">:headers</code> <code class="nv">anAgent</code><code class="p">))</code>
<code class="linenos">6 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">httpResponse</code> <code class="p">(</code><code class="nf">urlopen</code> <code class="nv">req</code><code class="p">))</code>
<code class="linenos">7 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">data</code> <code class="p">(</code><code class="nf">.read</code> <code class="nv">httpResponse</code><code class="p">))</code>
<code class="linenos">8 </code>  <code class="nv">data</code><code class="p">)</code>
</pre></div>

</figure>

<p>Let’s test this function in a REPL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">get-page-data</code> <code class="p">[</code><code class="nv">get-raw-data-from-web</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">get-raw-data-from-web</code> <code class="s">"http://knowledgebooks.com"</code><code class="p">)</code>
<code class="linenos"> 5 </code><code class="nv">b</code><code class="ss">'&lt;!DOCTYPE</code> <code class="nv">html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;KnowledgeBooks.com</code> <code class="nv">-</code> <code class="nv">research</code> <code class="nv">on</code> <code class="nv">the</code> <code class="nv">Knowledge</code> <code class="nv">M</code><code class="err">\</code>
<code class="linenos"> 6 </code><code class="nv">anagement</code>, <code class="nv">and</code> <code class="nv">the</code> <code class="nv">Semantic</code> <code class="nv">Web</code> <code class="nv">...</code><code class="o">'</code>
<code class="linenos"> 7 </code><code class="nv">=&gt;</code> 
<code class="linenos"> 8 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">get-page-data</code> <code class="p">[</code><code class="nv">get-page-html-elements</code><code class="p">]])</code>
<code class="linenos"> 9 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">get-page-html-elements</code> <code class="s">"http://knowledgebooks.com"</code><code class="p">)</code>
<code class="linenos">10 </code><code class="p">{</code><code class="ss">'title':</code> <code class="p">[</code><code class="nv">&lt;title&gt;KnowledgeBooks.com</code> <code class="nv">-</code> <code class="nv">research</code> <code class="nv">on</code> <code class="nv">the</code> <code class="nv">Knowledge</code> <code class="nv">Management</code>, <code class="nv">and</code> <code class="nv">the</code><code class="err">\</code>
<code class="linenos">11 </code> <code class="nv">Semantic</code> <code class="nv">Web</code> <code class="nv">&lt;/title&gt;</code><code class="p">]</code>,
<code class="linenos">12 </code><code class="ss">'a':</code> <code class="p">[</code><code class="nv">&lt;a</code> <code class="nv">class=</code><code class="s">"brand"</code> <code class="nv">href=</code><code class="s">"#"</code><code class="nv">&gt;KnowledgeBooks.com</code>  <code class="nv">&lt;/a&gt;</code>,  <code class="nv">...</code>
<code class="linenos">13 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>This REPL session shows the the function <strong>get-raw-data-from-web</strong> defined in the previous listing returns a web page as a string. In line 9 we use a function <strong>get-page-html-elements</strong> to find all elements in a string containing HTML. This function is defined in the next listing and shows how to parse and process the string contents of a web pages. Note: you will need to install the <strong>lxml</strong> library for this example (using pip or pip3 depending on your Python configuration):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">pip</code> <code class="nv">install</code> <code class="nv">lxml</code>
</pre></div>

</figure>

<p>The following listing of file <strong>get_page_data.hy</strong> uses the Beautiful Soup library to parse the string data for HTML text from a web site. The function <strong>get-page-html-elements</strong> returns names and associated data with each element in HTML represented as a string (the extra code on lines 20-24 is just debug example code):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">get_web_page</code> <code class="p">[</code><code class="nv">get-raw-data-from-web</code><code class="p">]])</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">bs4</code> <code class="p">[</code><code class="nv">BeautifulSoup</code><code class="p">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-element-data</code> <code class="p">[</code><code class="nv">anElement</code><code class="p">]</code>
<code class="linenos"> 6 </code>  <code class="p">{</code><code class="s">"text"</code> <code class="p">(</code><code class="nf">.getText</code> <code class="nv">anElement</code><code class="p">)</code>
<code class="linenos"> 7 </code>   <code class="s">"name"</code> <code class="p">(</code><code class="nf">.</code> <code class="nv">anElement</code> <code class="nv">name</code><code class="p">)</code>
<code class="linenos"> 8 </code>   <code class="s">"class"</code> <code class="p">(</code><code class="nf">.get</code> <code class="nv">anElement</code> <code class="s">"class"</code><code class="p">)</code>
<code class="linenos"> 9 </code>   <code class="s">"href"</code> <code class="p">(</code><code class="nf">.get</code> <code class="nv">anElement</code> <code class="s">"href"</code><code class="p">)})</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-page-html-elements</code> <code class="p">[</code><code class="nv">aUri</code><code class="p">]</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">raw-data</code> <code class="p">(</code><code class="nf">get-raw-data-from-web</code> <code class="nv">aUri</code><code class="p">))</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">soup</code> <code class="p">(</code><code class="nf">BeautifulSoup</code> <code class="nv">raw-data</code> <code class="s">"lxml"</code><code class="p">))</code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">title</code> <code class="p">(</code><code class="nf">.find_all</code> <code class="nv">soup</code> <code class="s">"title"</code><code class="p">))</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">a</code> <code class="p">(</code><code class="nf">.find_all</code> <code class="nv">soup</code> <code class="s">"a"</code><code class="p">))</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">h1</code> <code class="p">(</code><code class="nf">.find_all</code> <code class="nv">soup</code> <code class="s">"h1"</code><code class="p">))</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">h2</code> <code class="p">(</code><code class="nf">.find_all</code> <code class="nv">soup</code> <code class="s">"h2"</code><code class="p">))</code>
<code class="linenos">18 </code>  <code class="p">{</code><code class="s">"title"</code> <code class="nv">title</code> <code class="s">"a"</code> <code class="nv">a</code> <code class="s">"h1"</code> <code class="nv">h1</code> <code class="s">"h2"</code> <code class="nv">h2</code><code class="p">})</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">elements</code> <code class="p">(</code><code class="nf">get-page-html-elements</code> <code class="s">"http://markwatson.com"</code><code class="p">))</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="k">get </code><code class="nv">elements</code> <code class="s">"a"</code><code class="p">))</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">ta</code> <code class="p">(</code><code class="k">get </code><code class="nv">elements</code> <code class="s">"a"</code><code class="p">)]</code> <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">get-element-data</code> <code class="nv">ta</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The function <strong>get-element-data</strong> defined in lines 5-9 accepts as an argument an HTML element object (as defined in the Beautiful soup library) and extracts data, if available, for text, name, class, and href values. The function <strong>get-page-html-elements</strong> defied in lines 11-18 accepts as an argument a string containing a URI and returns a dictionary (or map, or hashtable) containing lists of all <strong>a</strong>, <strong>h1</strong>, <strong>h2</strong>, and <strong>title</strong> elements in the web page pointed to by the input URI. You can modify <strong>get-page-html-elements</strong> to add additional HTML element types, as needed.</p>

<p>Here is the output (with many lines removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">{</code><code class="ss">'text</code><code class="o">'</code><code class="err">:</code> <code class="ss">'Mark</code> <code class="nv">Watson</code> <code class="nv">artificial</code> <code class="nv">intelligence</code> <code class="nv">consultant</code> <code class="nb">and</code> <code class="nv">author</code><code class="ss">',</code>
<code class="linenos"> 2 </code> <code class="ss">'name</code><code class="o">'</code><code class="err">:</code> <code class="ss">'a',</code> <code class="ss">'class</code><code class="o">'</code><code class="err">:</code> <code class="nv">[</code><code class="ss">'navbar-brand'],</code> <code class="ss">'href</code><code class="o">'</code><code class="err">:</code> <code class="o">'</code><code class="nf">#'</code><code class="nv">}</code>
<code class="linenos"> 3 </code><code class="nv">{</code><code class="ss">'text</code><code class="o">'</code><code class="err">:</code> <code class="ss">'Home</code> <code class="nv">page</code><code class="ss">',</code> <code class="ss">'name</code><code class="o">'</code><code class="err">:</code> <code class="ss">'a',</code> <code class="ss">'class</code><code class="o">'</code><code class="err">:</code> <code class="nv">None,</code> <code class="ss">'href</code><code class="o">'</code><code class="err">:</code> <code class="ss">'/'}</code>
<code class="linenos"> 4 </code><code class="nv">{</code><code class="ss">'text</code><code class="o">'</code><code class="err">:</code> <code class="ss">'My</code> <code class="nv">Blog</code><code class="ss">',</code> <code class="ss">'name</code><code class="o">'</code><code class="err">:</code> <code class="ss">'a',</code> <code class="ss">'class</code><code class="o">'</code><code class="err">:</code> <code class="nv">None,</code>
<code class="linenos"> 5 </code> <code class="ss">'href</code><code class="o">'</code><code class="err">:</code> <code class="ss">'https://mark-watson.blogspot.com'}</code>
<code class="linenos"> 6 </code><code class="nv">{</code><code class="ss">'text</code><code class="o">'</code><code class="err">:</code> <code class="ss">'GitHub',</code> <code class="ss">'name</code><code class="o">'</code><code class="err">:</code> <code class="ss">'a',</code> <code class="ss">'class</code><code class="o">'</code><code class="err">:</code> <code class="nv">None,</code>
<code class="linenos"> 7 </code> <code class="ss">'href</code><code class="o">'</code><code class="err">:</code> <code class="ss">'https://github.com/mark-watson'}</code>
<code class="linenos"> 8 </code><code class="nv">{</code><code class="ss">'text</code><code class="o">'</code><code class="err">:</code> <code class="ss">'Twitter',</code> <code class="ss">'name</code><code class="o">'</code><code class="err">:</code> <code class="ss">'a',</code> <code class="ss">'class</code><code class="o">'</code><code class="err">:</code> <code class="nv">None,</code> <code class="ss">'href</code><code class="o">'</code><code class="err">:</code> <code class="ss">'https://twitter.com/mark_l_</code><code class="err">\</code>
<code class="linenos"> 9 </code><code class="nv">watson</code><code class="ss">'}</code>
<code class="linenos">10 </code><code class="nv">{</code><code class="ss">'text</code><code class="o">'</code><code class="err">:</code> <code class="ss">'WikiData',</code> <code class="ss">'name</code><code class="o">'</code><code class="err">:</code> <code class="ss">'a',</code> <code class="ss">'class</code><code class="o">'</code><code class="err">:</code> <code class="nv">None,</code> <code class="ss">'href</code><code class="o">'</code><code class="err">:</code> <code class="ss">'https://www.wikidata.org/w</code><code class="err">\</code>
<code class="linenos">11 </code><code class="nv">iki/Q18670263</code><code class="ss">'}</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-getting-html-links-from-the-democracynoworg-news-web-site">Getting HTML Links from the DemocracyNow.org News Web Site</h3>

<p>I financially support and rely on both NPR.org and DemocracyNow.org news as my main sources of news so I will use their news sites for examples here and in the next section. Web sites differ so much in format that it is often necessary to build highly customized web scrapers for individual web sites and to maintain the web scraping code as the format of the site changes in time.</p>

<p>Before working through this example and/or the example in the next section use the file <strong>Makefile</strong> to fetch data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">make</code> <code class="nv">data</code>
</pre></div>

</figure>

<p>This should copy the home pages for both web sites to the files:</p>

<ul>
  <li>democracynow_home_page.html (used here)</li>
  <li>npr_home_page.html (used for the example in the next section)</li>
</ul>

<p>The following listing shows <strong>democracynow_front_page.hy</strong></p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">get-web-page</code> <code class="p">[</code><code class="nv">get-web-page-from-disk</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">bs4</code> <code class="p">[</code><code class="nv">BeautifulSoup</code><code class="p">]])</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="c1">;; you need to run 'make data' to fetch sample HTML data for dev and testing</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-democracy-now-links</code> <code class="p">[]</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">test-html</code> <code class="p">(</code><code class="nf">get-web-page-from-disk</code> <code class="s">"democracynow_home_page.html"</code><code class="p">))</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">bs</code> <code class="p">(</code><code class="nf">BeautifulSoup</code> <code class="nv">test-html</code> <code class="ss">:features</code> <code class="s">"lxml"</code><code class="p">))</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nb">all</code><code class="nv">-anchor-elements</code> <code class="p">(</code><code class="nf">.findAll</code> <code class="nv">bs</code> <code class="s">"a"</code><code class="p">))</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nf">lfor</code> <code class="nv">e</code> <code class="nb">all</code><code class="nv">-anchor-elements</code>
<code class="linenos">13 </code>          <code class="ss">:if</code> <code class="p">(</code><code class="nf">&gt;</code> <code class="p">(</code><code class="nb">len</code> <code class="p">(</code><code class="nf">.get-text</code> <code class="nv">e</code><code class="p">))</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">14 </code>          <code class="p">(</code>, <code class="p">(</code><code class="nf">.get</code> <code class="nv">e</code> <code class="s">"href"</code><code class="p">)</code> <code class="p">(</code><code class="nf">.get-text</code> <code class="nv">e</code><code class="p">))))</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">__name__</code> <code class="s">"__main__"</code><code class="p">)</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">uri</code> <code class="nv">text</code><code class="p">]</code> <code class="p">(</code><code class="nf">get-democracy-now-links</code><code class="p">)]</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">uri</code> <code class="s">":"</code> <code class="nv">text</code><code class="p">)))</code>
</pre></div>

</figure>

<p>This simply prints our URIs and text (separated with the string “:”) for each link on the home page. On line 13 we discard any anchor elements that do not contain text. On line 14 the comma character at the start of the return list indicates that we are constructing a tuple. Lines 16-18 define a main function that is used when running this file art the command line. This is similar to how main functions can be defined in Python to allow a library file to also be run as a command line tool.</p>

<p>A few lines of output from today’s front page is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">/2020/1/7/the_great_hack_cambridge_analytica</code> <code class="err">:</code> <code class="nv">Meet</code> <code class="nv">Brittany</code> <code class="nv">Kaiser,</code> <code class="nv">Cambridge</code> <code class="nv">Analy</code><code class="err">\</code>
<code class="nv">tica</code> <code class="nv">Whistleblower</code> <code class="nv">Releasing</code> <code class="nv">Troves</code> <code class="nv">of</code> <code class="nv">New</code> <code class="nv">Files</code> <code class="nv">from</code> <code class="nv">Data</code> <code class="nv">Firm</code>
<code class="nv">/2019/11/8/remembering_orangeburg_massacre_1968_south_carolina</code> <code class="err">:</code> <code class="nv">Remembering</code> <code class="k">the</code> <code class="nv">196</code><code class="err">\</code>
<code class="mi">8</code> <code class="nv">Orangeburg</code> <code class="nv">Massacre</code> <code class="nv">When</code> <code class="nv">Police</code> <code class="nv">Shot</code> <code class="nv">Dead</code> <code class="nv">Three</code> <code class="nv">Unarmed</code> <code class="nv">Black</code> <code class="nv">Students</code>
<code class="nv">/2020/1/15/democratic_debate_higher_education_universal_programs</code> <code class="err">:</code> <code class="nv">Democrats</code> <code class="nv">Debate</code> <code class="err">\</code>
<code class="nv">Wealth</code> <code class="nv">Tax,</code> <code class="nv">Free</code> <code class="nv">Public</code> <code class="nv">College</code> <code class="nv">&amp;</code> <code class="nv">Student</code> <code class="nv">Debt</code> <code class="nv">Relief</code> <code class="nv">as</code> <code class="nv">Part</code> <code class="nv">of</code> <code class="nv">New</code> <code class="nv">Economic</code> <code class="nv">Plan</code>
<code class="nv">/2020/1/14/dahlia_lithwick_impeachment</code> <code class="err">:</code> <code class="nv">GOP</code> <code class="nv">Debate</code> <code class="nv">on</code> <code class="nv">Impeachment</code> <code class="nv">Witnesses</code> <code class="nv">Intensi</code><code class="err">\</code>
<code class="nv">fies</code> <code class="nv">as</code> <code class="nv">Pelosi</code> <code class="nv">Prepares</code> <code class="nv">to</code> <code class="nv">Send</code> <code class="nv">Articles</code> <code class="nv">to</code> <code class="nv">Senate</code>
<code class="nv">/2020/1/14/oakland_california_moms_4_housing</code> <code class="err">:</code> <code class="nv">Moms</code> <code class="mi">4</code> <code class="nv">Housing:</code> <code class="nv">Meet</code> <code class="k">the</code> <code class="nv">Oakland</code> <code class="nv">Moth</code><code class="err">\</code>
<code class="nv">ers</code> <code class="nv">Facing</code> <code class="nv">Eviction</code> <code class="nv">After</code> <code class="nv">Two</code> <code class="nv">Months</code> <code class="nv">Occupying</code> <code class="nv">Vacant</code> <code class="nv">House</code>
<code class="nv">/2020/1/14/luis_garden_acosta_martin_espada</code> <code class="err">:</code> <code class="err">“</code><code class="nv">Morir</code> <code class="nv">Soñando</code><code class="err">”:</code> <code class="nv">Martín</code> <code class="nv">Espada</code> <code class="nv">Reads</code> <code class="nv">P</code><code class="err">\</code>
<code class="nv">oem</code> <code class="nv">About</code> <code class="nv">Luis</code> <code class="nv">Garden</code> <code class="nv">Acosta,</code> <code class="nv">Young</code> <code class="nv">Lord</code> <code class="nv">&amp;</code> <code class="nv">Community</code> <code class="nv">Activist</code>
</pre></div>

</figure>

<p>The URIs are relative to the root URI https://www.democracynow.org/.</p>

<h3 id="leanpub-auto-getting-summaries-of-front-page-from-the-nprorg-news-web-site">Getting Summaries of Front Page from the NPR.org News Web Site</h3>

<p>This example is similar to the example in the last section except that text from home page links is formatted to provide a daily news summary. I am assuming that you ran the example in the last section so the web site home pages have been copied to local files.</p>

<p>The following listing shows <strong>npr_front_page_summary.hy</strong></p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">get-web-page</code> <code class="p">[</code><code class="nv">get-web-page-from-disk</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">bs4</code> <code class="p">[</code><code class="nv">BeautifulSoup</code><code class="p">]])</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="c1">;; you need to run 'make data' to fetch sample HTML data for dev and testing</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-npr-links</code> <code class="p">[]</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">test-html</code> <code class="p">(</code><code class="nf">get-web-page-from-disk</code> <code class="s">"npr_home_page.html"</code><code class="p">))</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">bs</code> <code class="p">(</code><code class="nf">BeautifulSoup</code> <code class="nv">test-html</code> <code class="ss">:features</code> <code class="s">"lxml"</code><code class="p">))</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nb">all</code><code class="nv">-anchor-elements</code> <code class="p">(</code><code class="nf">.findAll</code> <code class="nv">bs</code> <code class="s">"a"</code><code class="p">))</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">filtered-a</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="nf">lfor</code> <code class="nv">e</code> <code class="nb">all</code><code class="nv">-anchor-elements</code>
<code class="linenos">14 </code>          <code class="ss">:if</code> <code class="p">(</code><code class="nf">&gt;</code> <code class="p">(</code><code class="nb">len</code> <code class="p">(</code><code class="nf">.get-text</code> <code class="nv">e</code><code class="p">))</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">15 </code>          <code class="p">(</code>, <code class="p">(</code><code class="nf">.get</code> <code class="nv">e</code> <code class="s">"href"</code><code class="p">)</code> <code class="p">(</code><code class="nf">.get-text</code> <code class="nv">e</code><code class="p">))))</code>
<code class="linenos">16 </code>  <code class="nv">filtered-a</code><code class="p">)</code>
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">create-npr-summary</code> <code class="p">[]</code>
<code class="linenos">19 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">links</code> <code class="p">(</code><code class="nf">get-npr-links</code><code class="p">))</code>
<code class="linenos">20 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">filtered-links</code> <code class="p">(</code><code class="nf">lfor</code> <code class="p">[</code><code class="nv">uri</code> <code class="nv">text</code><code class="p">]</code> <code class="nv">links</code> <code class="ss">:if</code> <code class="p">(</code><code class="nf">&gt;</code> <code class="p">(</code><code class="nb">len</code> <code class="p">(</code><code class="nf">.strip</code> <code class="nv">text</code><code class="p">))</code> <code class="mi">40</code><code class="p">)</code> <code class="p">(</code><code class="nf">.strip</code><code class="err">\</code>
<code class="linenos">21 </code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="nf">.join</code> <code class="s">"\n\n"</code> <code class="nv">filtered-links</code><code class="p">))</code>
<code class="linenos">23 </code>
<code class="linenos">24 </code><code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">__name__</code> <code class="s">"__main__"</code><code class="p">)</code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">create-npr-summary</code><code class="p">)))</code>
</pre></div>

</figure>

<p>In lines 12-15 we are filtering out (or removing) all anchor HTML elements that do not contain text. The following shows a few lines of the generated output for data collected today:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">January</code> <code class="mi">16</code><code class="o">,</code> <code class="mi">2020</code>  <code class="nv">Birds</code> <code class="nv">change</code> <code class="k">the</code> <code class="nv">shape</code> <code class="nv">of</code> <code class="nv">their</code> <code class="nv">wings</code> <code class="nv">far</code> <code class="nv">more</code> <code class="nv">than</code>
<code class="nv">planes.</code> <code class="nv">The</code> <code class="nv">complexities</code> <code class="nv">of</code> <code class="nv">bird</code> <code class="nv">flight</code> <code class="nv">have</code> <code class="nv">posed</code> <code class="nv">a</code> <code class="nv">major</code> <code class="nv">design</code> <code class="nv">challenge</code>
<code class="nv">for</code> <code class="nv">scientists</code> <code class="nv">trying</code> <code class="nv">to</code> <code class="nv">translate</code> <code class="k">the</code> <code class="nv">way</code> <code class="nv">birds</code> <code class="nv">fly</code> <code class="nv">into</code> <code class="nv">robots.</code>

<code class="nv">FBI</code> <code class="nv">Vows</code> <code class="nv">To</code> <code class="nv">Warn</code> <code class="nv">More</code> <code class="nv">Election</code> <code class="nv">Officials</code> <code class="nv">If</code> <code class="nv">Discovering</code> <code class="nv">A</code> <code class="nv">Cyberattack</code>

<code class="nv">January</code> <code class="mi">16</code><code class="o">,</code> <code class="mi">2020</code>  <code class="nv">The</code> <code class="nv">bureau</code> <code class="nv">was</code> <code class="nv">faulted</code> <code class="nv">after</code> <code class="k">the</code> <code class="nv">Russian</code> <code class="nv">attack</code> <code class="nv">on</code> <code class="k">the</code>
<code class="mi">2016</code> <code class="nv">election</code> <code class="nv">for</code> <code class="nv">keeping</code> <code class="nv">too</code> <code class="nv">much</code> <code class="nv">information</code> <code class="nv">from</code> <code class="nv">state</code> <code class="nb">and</code> <code class="nv">local</code>
<code class="nv">authorities.</code> <code class="nv">It</code> <code class="nv">says</code> <code class="nv">it</code><code class="ss">'ll</code> <code class="nv">use</code> <code class="nv">a</code> <code class="nv">new</code> <code class="nv">policy</code> <code class="nv">going</code> <code class="nv">forward.</code>

<code class="nv">Ukraine</code> <code class="nv">Is</code> <code class="nv">Investigating</code> <code class="nv">Whether</code> <code class="nv">U.S.</code> <code class="nv">Ambassador</code> <code class="nv">Yovanovitch</code> <code class="nv">Was</code> <code class="nv">Surveilled</code>

<code class="nv">January</code> <code class="mi">16</code><code class="o">,</code> <code class="mi">2020</code>  <code class="nv">Ukraine</code><code class="ss">'s</code> <code class="nv">Internal</code> <code class="nv">Affairs</code> <code class="nv">Ministry</code> <code class="nv">says</code> <code class="nv">it</code><code class="ss">'s</code> <code class="nv">asking</code> <code class="k">the</code>
<code class="nv">FBI</code> <code class="nv">to</code> <code class="nv">help</code> <code class="nv">determine</code> <code class="nv">whether</code> <code class="nv">international</code> <code class="nv">laws</code> <code class="nv">were</code> <code class="nv">broken,</code> <code class="nb">or</code> <code class="s">"whether it</code>
<code class="s">is just a bravado and a fake information"</code> <code class="nv">from</code> <code class="nv">a</code> <code class="nv">U.S.</code> <code class="nv">politician.</code>

<code class="nv">Electric</code> <code class="nv">Burn:</code> <code class="nv">Those</code> <code class="nv">Who</code> <code class="nv">Bet</code> <code class="nv">Against</code> <code class="nv">Elon</code> <code class="nv">Musk</code> <code class="nv">And</code> <code class="nv">Tesla</code> <code class="nv">Are</code> <code class="nv">Paying</code> <code class="nv">A</code> <code class="nv">Big</code> <code class="nv">Price</code>

<code class="nv">January</code> <code class="mi">16</code><code class="o">,</code> <code class="mi">2020</code>  <code class="nv">For</code> <code class="nv">years,</code> <code class="nv">Elon</code> <code class="nv">Musk</code> <code class="nv">skeptics</code> <code class="nv">have</code> <code class="nv">shorted</code> <code class="nv">Tesla</code> <code class="nv">stock,</code> <code class="nv">confident</code> <code class="err">\</code>
<code class="k">the</code> <code class="nv">electric</code> <code class="nv">carmaker</code> <code class="nv">was</code> <code class="nv">on</code> <code class="k">the</code> <code class="nv">brink</code> <code class="nv">of</code> <code class="nv">disaster.</code> <code class="nv">Instead,</code> <code class="nv">share</code> <code class="nv">value</code> <code class="nv">has</code> <code class="nv">skyrock</code><code class="err">\</code>
<code class="nv">eted,</code> <code class="nv">costing</code> <code class="nv">short</code> <code class="nv">sellers</code> <code class="nv">billions.</code>

<code class="nv">TSA</code> <code class="nv">Says</code> <code class="nv">It</code> <code class="nv">Seized</code> <code class="nv">A</code> <code class="nv">Record</code> <code class="nv">Number</code> <code class="nv">Of</code> <code class="nv">Firearms</code> <code class="nv">At</code> <code class="nv">U.S.</code> <code class="nv">Airports</code> <code class="nv">Last</code> <code class="nv">Year</code>
</pre></div>

</figure>

<p>The examples seen here are simple but should be sufficient to get you started gathering text data from the web.</p>


<h2 id="leanpub-auto-using-the-microsoft-bing-search-apis">Using the Microsoft Bing Search APIs</h2>

<p>You will need to register with Microsoft’s Azure search service to use the material in this chapter. It is likely that you view search as a manual human-centered activity. I hope to expand your thinking to considering applications that automate search, finding information on the web, and automatically organizing information.</p>

<h3 id="leanpub-auto-getting-an-access-key-for-microsoft-bing-search-apis">Getting an Access Key for Microsoft Bing Search APIs</h3>

<p>You will need an Azure account. I use the Bing search APIs fairly often for research but I have never spent more than about a dollar a month and usually I get no bill at all. For personal use it is an inexpensive service.</p>

<p>Get started by going to the web page <a href="https://azure.microsoft.com/en-us/try/cognitive-services/">https://azure.microsoft.com/en-us/try/cognitive-services/</a> and sign up for an access key. The Search APIs signup is currently in the fourth tab in this web form. When you navigate to the Search APIs tab, select the option Bing Search APIs v7. You will get an API key that you need to store in an environment variable that you will soon need:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nb">export</code> <code class="nv">BING_SEARCH_V7_SUBSCRIPTION_KEY</code><code class="o">=</code>4e97234341d9891191c772b7371ad5b1
</pre></div>

</figure>

<p>That is not my real subscription key!</p>

<p>After adding this to your <strong>.profile</strong> file (or <strong>.zshrc</strong>, or <strong>.bashrc</strong>, or etc.), open a new terminal window and make sure the following works for you:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">hy</code>
<code class="nv">hy</code> <code class="mf">0.18</code><code class="nv">.0</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.4</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="nv">os</code><code class="p">)</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="k">get </code><code class="nv">os.environ</code> <code class="s">"BING_SEARCH_V7_SUBSCRIPTION_KEY"</code><code class="p">)</code>
<code class="ss">'4e97234341d9891191c772b7371ad5b1</code><code class="o">'</code>
<code class="nv">=&gt;</code> 
</pre></div>

</figure>

<h3 id="leanpub-auto-example-search-script">Example Search Script</h3>

<p>It takes very little Hy code to access the Bing search APIs. We will look at a long example script that expects a single command line argument that is a string containing search terms. The following example script shows you how to make a search query that requests search results in JSON format. We also look at parsing the returned JSON data. I formatted this listing to fit the page width:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>

<code class="p">(</code><code class="k">import </code><code class="nv">json</code><code class="p">)</code>
<code class="p">(</code><code class="k">import </code><code class="nv">os</code><code class="p">)</code>
<code class="p">(</code><code class="k">import </code><code class="nv">sys</code><code class="p">)</code>
<code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">pprint</code> <code class="p">[</code><code class="nv">pprint</code><code class="p">]])</code>
<code class="p">(</code><code class="k">import </code><code class="nv">requests</code><code class="p">)</code>

<code class="c1">;; Add your Bing Search V7 subscription key and </code>
<code class="c1">;; the endpoint to your environment variables.</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">subscription_key</code> <code class="p">(</code><code class="k">get </code><code class="nv">os.environ</code> <code class="s">"BING_SEARCH_V7_SUBSCRIPTION_KEY"</code><code class="p">))</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">endpoint</code> <code class="s">"https://api.cognitive.microsoft.com/bing/v7.0/search"</code><code class="p">)</code>

<code class="c1">;; Query term(s) to search for. </code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">query</code> <code class="p">(</code><code class="k">get </code><code class="nv">sys.argv</code> <code class="mi">1</code><code class="p">))</code> <code class="c1">;; an example: "site:wikidata.org Sedona Arizona"</code>

<code class="c1">;; Construct a request</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">mkt</code> <code class="s">"en-US"</code><code class="p">)</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">params</code> <code class="p">{</code> <code class="s">"q"</code> <code class="nv">query</code> <code class="s">"mkt"</code> <code class="nv">mkt</code> <code class="p">})</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">headers</code> <code class="p">{</code> <code class="s">"Ocp-Apim-Subscription-Key"</code> <code class="nv">subscription_key</code> <code class="p">})</code>

<code class="c1">;; Call the API</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">response</code> <code class="p">(</code><code class="nf">requests.get</code> <code class="nv">endpoint</code> <code class="ss">:headers</code> <code class="nv">headers</code> <code class="ss">:params</code> <code class="nv">params</code><code class="p">))</code>

<code class="p">(</code><code class="nb">print</code> <code class="s">"\nFull JSON response from Bing search query:\n"</code><code class="p">)</code>
<code class="p">(</code><code class="nf">pprint</code> <code class="p">(</code><code class="nf">response.json</code><code class="p">))</code>

<code class="c1">;; pull out resuts and print them individually:</code>

<code class="p">(</code><code class="kd">setv </code><code class="nv">results</code> <code class="p">(</code><code class="k">get </code><code class="p">(</code><code class="nf">response.json</code><code class="p">)</code> <code class="s">"webPages"</code><code class="p">))</code>

<code class="p">(</code><code class="nb">print</code> <code class="s">"\nResults from the key 'webPages':\n"</code><code class="p">)</code>
<code class="p">(</code><code class="nf">pprint</code> <code class="nv">results</code><code class="p">)</code>

<code class="p">(</code><code class="nb">print</code> <code class="s">"\nDetailed printout from the first search result:\n"</code><code class="p">)</code>

<code class="p">(</code><code class="kd">setv </code><code class="nv">result-list</code> <code class="p">(</code><code class="k">get </code><code class="nv">results</code> <code class="s">"value"</code><code class="p">))</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">first-result</code> <code class="p">(</code><code class="k">first </code><code class="nv">result-list</code><code class="p">))</code>

<code class="p">(</code><code class="nb">print</code> <code class="s">"\nFirst result, all data:\n"</code><code class="p">)</code>
<code class="p">(</code><code class="nf">pprint</code> <code class="nv">first-result</code><code class="p">)</code>

<code class="p">(</code><code class="nb">print</code> <code class="s">"\nSummary of first search result:\n"</code><code class="p">)</code>
<code class="p">(</code><code class="nf">pprint</code> <code class="p">(</code><code class="k">get </code><code class="nv">first-result</code> <code class="s">"displayUrl"</code><code class="p">))</code>

<code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="s">"displayUrl"</code> <code class="nv">first-result</code><code class="p">)</code>
    <code class="p">(</code><code class="nb">print</code>
     <code class="p">(</code><code class="nf">.format</code>
       <code class="s">" key: {:15} \t:\t {}"</code> <code class="s">"displayUrl"</code>
       <code class="p">(</code><code class="k">get </code><code class="nv">first-result</code> <code class="s">"displayUrl"</code><code class="p">))))</code>
<code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="s">"language"</code> <code class="nv">first-result</code><code class="p">)</code>
    <code class="p">(</code><code class="nb">print</code>
      <code class="p">(</code><code class="nf">.format</code> <code class="s">" key: {:15} \t:\t {}"</code> <code class="s">"language"</code> 
      <code class="p">(</code><code class="k">get </code><code class="nv">first-result</code> <code class="s">"language"</code><code class="p">))))</code>
<code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="s">"name"</code> <code class="nv">first-result</code><code class="p">)</code>
    <code class="p">(</code><code class="nb">print</code> 
      <code class="p">(</code><code class="nf">.format</code> 
        <code class="s">" key: {:15} \t:\t {}"</code> <code class="s">"name"</code> 
        <code class="p">(</code><code class="k">get </code><code class="nv">first-result</code> <code class="s">"name"</code><code class="p">))))</code>
</pre></div>

</figure>

<p>You can use search hints like “site:wikidata.org” to only search specific web sites. In the following example I use the search query:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="s">"site:wikidata.org Sedona Arizona"</code>
</pre></div>

</figure>

<p>This example generates 364 lines of output so I only show a few selected lines here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">./bing.hy</code> <code class="s">"site:wikidata.org Sedona Arizona"</code> <code class="k">| </code><code class="nv">wc</code> <code class="nv">-l</code>
     <code class="mi">364</code>
<code class="nv">$</code> <code class="nv">./bing.hy</code> <code class="s">"site:wikidata.org Sedona Arizona"</code>

<code class="nv">Full</code> <code class="nv">JSON</code> <code class="nv">response</code> <code class="nv">from</code> <code class="nv">Bing</code> <code class="nv">search</code> <code class="nv">query:</code>

<code class="p">{</code><code class="ss">'_type':</code> <code class="ss">'SearchResponse</code><code class="o">'</code>,
 <code class="ss">'queryContext':</code> <code class="p">{</code><code class="ss">'originalQuery':</code> <code class="ss">'site:wikidata.org</code> <code class="nv">Sedona</code> <code class="nv">Arizona</code><code class="o">'</code><code class="p">}</code>,
 
   <code class="nv">...</code>

<code class="nv">Results</code> <code class="nv">from</code> <code class="nv">the</code> <code class="nv">key</code> <code class="ss">'webPages':</code>

<code class="p">{</code><code class="ss">'totalEstimatedMatches':</code> <code class="mi">27</code>,
 <code class="ss">'value':</code> <code class="p">[{</code><code class="ss">'about':</code> <code class="p">[{</code><code class="ss">'name':</code> <code class="ss">'Sedona</code><code class="o">'</code><code class="p">}</code>, <code class="p">{</code><code class="ss">'name':</code> <code class="ss">'Sedona</code><code class="o">'</code><code class="p">}]</code>,
            <code class="ss">'dateLastCrawled':</code> <code class="ss">'2020-05-24T00:04:00.0000000Z</code><code class="o">'</code>,
            <code class="ss">'displayUrl':</code> <code class="ss">'https://www.wikidata.org/wiki/Q80041</code><code class="o">'</code>,
    <code class="nv">...</code>

<code class="nv">Summary</code> <code class="nv">of</code> <code class="k">first </code><code class="nv">search</code> <code class="nv">result:</code>

<code class="ss">'https://www.wikidata.org/wiki/Q80041</code><code class="o">'</code>
 <code class="nv">key:</code> <code class="nv">displayUrl</code>      	<code class="nv">:</code>	 <code class="nv">https://www.wikidata.org/wiki/Q80041</code>
 <code class="nv">key:</code> <code class="nv">language</code>        	<code class="nv">:</code>	 <code class="nv">en</code>
 <code class="nv">key:</code> <code class="nv">name</code>            	<code class="nv">:</code>	 <code class="nv">Sedona</code> <code class="nv">-</code> <code class="nv">Wikidata</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-wrap-up-1">Wrap-up</h3>

<p>In addition to using automated web scraping to get data for my personal research, I often use automated web search. I find the Microsoft’s Azure Bing search APIs are the most convenient to use and I like paying for services that I use. The search engine Duck Duck Go also provides free search APIs but even though I use Duck Duck Go for 90% of my manual web searches, when I build automated systems I prefer to rely on services that I pay for.</p>


<h2 id="leanpub-auto-deep-learning">Deep Learning</h2>

<p>Most of my professional career since 2014 has involved Deep Learning, mostly with TensorFlow using the Keras APIs. In the late 1980s I was on a DARPA neural network technology advisory panel for a year, I wrote the first prototype of the SAIC ANSim neural network library commercial product, and I wrote the neural network prediction code for a bomb detector my company designed and built for the FAA for deployment in airports. More recently I have used GAN (generative adversarial networks) models for synthesizing numeric spreadsheet data and LSTM (long short term memory) models to synthesize highly structured text data like nested JSON and for NLP (natural language processing). I have 55 USA and several European patents using neural network and Deep Learning technology.</p>

<p>The Hy language utilities and example programs we develop here all use TensorFlow and Keras “under the hood” to do the heavy lifting. Keras is a simpler to use API for TensorFlow and I usually use Keras rather than the lower level TensorFlow APIs.</p>

<p>There are other libraries and frameworks that might interest you in addition to TensorFlow and Keras. I particularly like the Flux library for the Julia programming language. Currently Python has the most comprehensive libraries for Deep Learning but other languages that support differential computing (more on this later) like Julia and Swift may gain popularity in the future.</p>

<p>Here we will learn a vocabulary for discussing Deep Learning neural network models, look at possible architectures, and show two Hy language examples that should be sufficient to get you used to using Keras with the Hy language. If you already have Deep Learning application development experience you might want to skip the following review material and skip to the Hy language examples.</p>

<p>If you want to use Deep Learning professionally, there are two specific online resources that I recommend: Andrew Ng leads the efforts at <a href="https://www.deeplearning.ai/">deeplearning.ai</a> and Jeremy Howard leads the efforts at <a href="https://www.fast.ai/">fast.ai</a>. Here I will show you how to use a few useful techniques. Andrew and Jeremy will teach you skills that may lead a professional level of expertise if you take their courses.</p>

<p>There are many Deep Learning neural architectures in current practical use; a few types that I use are:</p>

<ul>
  <li>Multi-layer perceptron networks with many fully connected layers. An input layer contains placeholders for input data. Each element in the input layer is connected by a two-dimensional weight matrix to each element in the first hidden layer. We can use any number of fully connected hidden layers, with the last hidden layer connected to an output layer.</li>
  <li>Convolutional networks for image processing and text classification. Convolutions, or filters, are small windows that can process input images (filters are two-dimensional) or sequences like text (filters are one-dimensional). Each filter uses a single set of learned weights independent of where the filter is applied in an input image or input sequence.</li>
  <li>Autoencoders have the same number of input layer and output layer elements with one or more hidden fully connected layers. Autoencoders are trained to produce the same output as training input values using a relatively small number of hidden layer elements. Autoencoders are capable of removing noise in input data.</li>
  <li>LSTM (long short term memory) process elements in a sequence in order and are capable of remembering patterns that they have seen earlier in the sequence.</li>
  <li>GAN (generative adversarial networks) models comprise two different and competing neural models, the generator and the discriminator. GANs are often trained on input images (although in my work I have applied GANs to two-dimensional numeric spreadsheet data). The generator model takes as input a “latent input vector” (this is just a vector of specific size with random values) and generates a random output image. The weights of the generator model are trained to produce random images that are similar to how training images look. The discriminator model is trained to recognize if an arbitrary output image is original training data or an image created by the generator model. The generator and discriminator models are trained together.</li>
</ul>

<p>The core functionality of libraries like TensorFlow are written in C++ and take advantage of special hardware like GPUs, custom ASICs, and devices like Google’s TPUs. Most people who work with Deep Learning models don’t need to even be aware of the low level optimizations used to make training and using Deep Learning models more efficient. That said, in the following section I am going to show you how simple neural networks are trained and used.</p>

<h3 id="leanpub-auto-simple-multi-layer-perceptron-neural-networks">Simple Multi-layer Perceptron Neural Networks</h3>

<p>I use the terms Multi-layer perceptron neural networks, backpropagation neural networks and delta-rule networks interchangeably. Backpropagation refers to the model training process of calculating the output errors when training inputs are passed in the forward direction from input layer, to hidden layers, and then to the output layer. There will be an error which is the difference between the calculated outputs and the training outputs. This error can be used to adjust the weights from the last hidden layer to the output layer to reduce the error. The error is then backprogated backwards through the hidden layers, updating all weights in the model. I have detailed example code in any of my older artificial intelligence books. Here I am satisfied to give you an intuition to how simple neural networks are trained.</p>

<p>The basic idea is that we start with a network initialized with random weights and for each training case we propagate the inputs through the network towards the output neurons, calculate the output errors, and back-up the errors from the output neurons back towards the input neurons in order to make small changes to the weights to lower the error for the current training example. We repeat this process by cycling through the training examples many times.</p>

<p>The following figure shows a simple backpropagation network with one hidden layer. Neurons in adjacent layers are connected by floating point connection strength weights. These weights start out as small random values that change as the network is trained. Weights are represented in the following figure by arrows; in the code the weights connecting the input to the output neurons are represented as a two-dimensional array.</p>


<div class="figure-wrapper center">
  <figure id="nn-backprop" class="image" style="width: 217px">
    <img src="images/nn_backprop2d.png" alt="Example Backpropagation network with One Hidden Layer" style="width: 100%">
    <figcaption>Example Backpropagation network with One Hidden Layer</figcaption>
  </figure>
</div>


<p>Each non-input neuron has an activation value that is calculated from the activation values of connected neurons feeding into it, gated (adjusted) by the connection weights. For example, in the above figure, the value of Output 1 neuron is calculated by summing the activation of Input 1 times weight W1,1 and Input 2 activation times weight W2,1 and applying a “squashing function” like Sigmoid or Relu (see figures below) to this sum to get the final value for Output 1’s activation value. We want to flatten activation values to a relatively small range but still maintain relative values. To do this flattening we use the Sigmoid function that is seen in the next figure, along with the derivative of the Sigmoid function which we will use in the code for training a network by adjusting the weights.</p>


<div class="figure-wrapper center">
  <figure id="nn-sigmoid" class="image" style="width: 288px">
    <img src="images/nn_sigmoid.png" alt="Sigmoid Function and Derivative of Sigmoid Function (SigmoidP)" style="width: 100%">
    <figcaption>Sigmoid Function and Derivative of Sigmoid Function (SigmoidP)</figcaption>
  </figure>
</div>


<p>Simple neural network architectures with just one or two hidden layers are easy to train using backpropagation and I have from scratch code for this several of my previous books. You can see Java and Common Lisp from-scratch implementations in two of my books that you can read online: <a href="https://leanpub.com/javaai">Practical Artificial Intelligence Programming With Java</a> and <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, or the Savvy Programmer’s Secret Weapon</a>. However, here we are using Hy to write models using the TensorFlow framework which has the huge advantage that small models you experiment with on your laptop can be scaled to more parameters (usually this means more neurons in hidden layers which increases the number of weights in a model) and run in the cloud using multiple GPUs.</p>

<p>Except for pendantic purposes, I now never write neural network code from scratch, instead I take advantage of the many person-years of engineering work put into the development of frameworks like TensorFlow, PyTorch, mxnet, etc. We now move on to two examples built with TensorFlow.</p>

<h3 id="leanpub-auto-deep-learning-1">Deep Learning</h3>

<p>Deep Learning models are generally understood to have many more hidden layers than simple multi-layer perceptron neural networks and often comprise multiple simple models combined together in series or in parallel.
Complex architectures can be iteratively developed by manually adjusting the size of model components, changing the components, etc. Alternatively, model architecture search can be automated. At Capital One I used Google’s 
<a href="https://github.com/tensorflow/adanet">AdaNet project</a> that efficiently searches for effective model architectures inside a single TensorFlow session. The model architecture used here is simple: one input layer representing the input values in a sample of University of Wisconsin cancer data, one hidden layer, and an output layer consisting of one neuron whose activation value will be interpreted as a prediction of benign or malignant.</p>

<p>The material in this chapter is intended to serve two purposes:</p>

<ul>
  <li>If you are already familiar with Deep Learning and TensorFlow then the examples here will serve to show you how to call the TensorFlow APIs from Hy.</li>
  <li>If you have little or no exposure with Deep Learning then the short Hy language examples will provide you with concise code to experiment with and you can then decide to study further.</li>
</ul>

<p>Once again, I recommend that you consider taking two online Deep Learning course sequences. For no cost, Jeremy Howard provides lessons at <a href="https://fast.ai">fast.ai</a> that are very good and the later classes use PyTorch which is a framework that is similar to TensorFlow. For a modest cost Andrew Ng provides classes at <a href="https://www.deeplearning.ai/">deeplearning.ai</a> that use TensorFlow. I have been working in the field of machine learning since the 1980s, but I still take Andrew’s online classes to stay up-to-date. In the last eight years I have taken his Stanford University machine learning class twice and also his complete course sequence using TensorFlow. I have also worked through much of Jeremy’s material. I recommend both course sequences without reservation.</p>

<h3 id="leanpub-auto-using-keras-and-tensorflow-to-model-the-wisconsin-cancer-data-set">Using Keras and TensorFlow to Model The Wisconsin Cancer Data Set</h3>

<p>The University of Wisconsin cancer database has 646 samples. Each sample has 9 input values and one output value, the target output class (0 for benign, 1 for cancer):</p>

<ul>
  <li>0 Clump Thickness               1 - 10</li>
  <li>1 Uniformity of Cell Size       1 - 10</li>
  <li>2 Uniformity of Cell Shape      1 - 10</li>
  <li>3 Marginal Adhesion             1 - 10</li>
  <li>4 Single Epithelial Cell Size   1 - 10</li>
  <li>5 Bare Nuclei                   1 - 10</li>
  <li>6 Bland Chromatin               1 - 10</li>
  <li>7 Normal Nucleoli               1 - 10</li>
  <li>8 Mitoses                       1 - 10</li>
  <li>9 Class (0 for benign, 1 for malignant)</li>
</ul>

<p>We will use separate training and test files <strong>hy-lisp-python/deeplearning/train.csv</strong> and <strong>hy-lisp-python/deeplearning/test.csv</strong>. Here are a few samples from the training file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="mi">6</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">7</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">0</code>
<code class="mi">2</code><code class="o">,</code><code class="mi">5</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">6</code><code class="o">,</code><code class="mi">7</code><code class="o">,</code><code class="mi">7</code><code class="o">,</code><code class="mi">5</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code>
<code class="mi">10</code><code class="o">,</code><code class="mi">4</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">6</code><code class="o">,</code><code class="mi">5</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">1</code>
<code class="mi">6</code><code class="o">,</code><code class="mi">10</code><code class="o">,</code><code class="mi">10</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">8</code><code class="o">,</code><code class="mi">10</code><code class="o">,</code><code class="mi">7</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">1</code>
<code class="mi">5</code><code class="o">,</code><code class="mi">6</code><code class="o">,</code><code class="mi">5</code><code class="o">,</code><code class="mi">6</code><code class="o">,</code><code class="mi">10</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">3</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code>
<code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">0</code>
<code class="mi">3</code><code class="o">,</code><code class="mi">7</code><code class="o">,</code><code class="mi">7</code><code class="o">,</code><code class="mi">4</code><code class="o">,</code><code class="mi">4</code><code class="o">,</code><code class="mi">9</code><code class="o">,</code><code class="mi">4</code><code class="o">,</code><code class="mi">8</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code>
<code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">2</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">1</code><code class="o">,</code><code class="mi">0</code>
</pre></div>

</figure>

<p>After you look at this data, if you did not have much experience with machine learning then it might not be obvious how to build a model to accept a sample for a patient like we see in the Wisconsin data set and then predict if the sample implies benign or cancerous outcome for the patient. Using TensorFlow with a simple 
neural network model, we will implement a model in about 40 lines of Hy code to implement this example.</p>

<p>Since there are nine input values we will need nine input neurons that will represent the input values for a sample in either training or separate test data. These nine input neurons (created in lines 9-10 in the following listing) will be completely connected to twelve neurons in a hidden layer. Here, completely connected means that each of the nine input neurons is connected via a weight to each hidden layer neuron. There are 9 * 12 = 108 weights between the input and hidden layers. There is a single output layer neuron that is connected to each hidden layer neuron.</p>

<p>Notice that in lines 12 and 14 in the following listing that we specify a <strong>relu</strong> activation function while the activation function connecting the hidden layer to the output layer uses the <strong>sigmoid</strong> activation function that we saw plotted earlier.</p>

<p>There is an example in the git example repo directory <strong>hy-lisp-python/matplotlib</strong> in the file <strong>plot_relu.hy</strong> that generated the following figure:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/relu.png" alt="Relu Function" style="width: 100%">
    <figcaption>Relu Function</figcaption>
  </figure>
</div>


<p>The following listing shows the use of the Keras TensorFlow APIs to build a model (lines 9-19) with one input layer, two hidden layers, and an output layer with just one neuron. After we build the model, we define two utility functions <strong>train</strong> (lines 21-23) to train a model given training inputs (<strong>x</strong> argument<strong>) and corresponding training outputs (</strong>y** argument), and we also define <strong>predict</strong> (lines 25-26) using a trained model to make a cancer or benign prediction given test input values (<strong>x-data</strong> argument).</p>

<p>Lines 28-33 show a utility function <strong>load-data</strong> that loads a University of Wisconsin cancer data set CSV file, scales the input and output values to the range [0.0, 1.0] and returns a list containing input (<strong>x-data</strong>) and target output data (<strong>y-data</strong>). You may want to load this example in a REPL and evaluate <strong>load-data</strong> on one of the CSV files.</p>

<p>The function <strong>main</strong> (lines 35-45) loads training and test (evaluation of model accuracy on data not used for training), trains a model, and then tests the accuracy of the model on the test (evaluation) data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="nv">argparse</code> <code class="nv">os</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="k">import </code><code class="nv">keras</code>
<code class="linenos"> 5 </code>        <code class="nv">keras.utils.data-utils</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">pandas</code> <code class="p">[</code><code class="nv">read-csv</code><code class="p">]])</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">build-model</code> <code class="p">[]</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">model</code> <code class="p">(</code><code class="nf">keras.models.Sequential</code><code class="p">))</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="nf">.add</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">keras.layers.core.Dense</code> <code class="mi">9</code>
<code class="linenos">12 </code>                 <code class="ss">:activation</code> <code class="s">"relu"</code><code class="p">))</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="nf">.add</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">keras.layers.core.Dense</code> <code class="mi">12</code>
<code class="linenos">14 </code>                 <code class="ss">:activation</code> <code class="s">"relu"</code><code class="p">))</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="nf">.add</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">keras.layers.core.Dense</code> <code class="mi">1</code>
<code class="linenos">16 </code>                 <code class="ss">:activation</code> <code class="s">"sigmoid"</code><code class="p">))</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="nf">.compile</code> <code class="nv">model</code> <code class="ss">:loss</code>      <code class="s">"binary_crossentropy"</code>
<code class="linenos">18 </code>                  <code class="ss">:optimizer</code> <code class="p">(</code><code class="nf">keras.optimizers.RMSprop</code><code class="p">))</code>
<code class="linenos">19 </code>  <code class="nv">model</code><code class="p">)</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">train</code> <code class="p">[</code><code class="nv">batch-size</code> <code class="nv">model</code> <code class="nv">x</code> <code class="nv">y</code><code class="p">]</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">it</code> <code class="p">(</code><code class="nb">range</code> <code class="mi">50</code><code class="p">)]</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="nf">.fit</code> <code class="nv">model</code> <code class="nv">x</code> <code class="nv">y</code> <code class="ss">:batch-size</code> <code class="nv">batch-size</code> <code class="ss">:epochs</code> <code class="mi">10</code> <code class="ss">:verbose</code> <code class="kc">False</code><code class="p">)))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">predict</code> <code class="p">[</code><code class="nv">model</code> <code class="nv">x-data</code><code class="p">]</code>
<code class="linenos">26 </code>    <code class="p">(</code><code class="nf">.predict</code> <code class="nv">model</code> <code class="nv">x-data</code><code class="p">))</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">load-data</code> <code class="p">[</code><code class="nv">file-name</code><code class="p">]</code>
<code class="linenos">29 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nb">all</code><code class="nv">-data</code> <code class="p">(</code><code class="nf">read-csv</code> <code class="nv">file-name</code> <code class="ss">:header</code> <code class="kc">None</code><code class="p">))</code>
<code class="linenos">30 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">x-data10</code> <code class="p">(</code><code class="nf">.</code> <code class="nb">all</code><code class="nv">-data.iloc</code> <code class="p">[(</code>, <code class="p">(</code><code class="nb">slice</code> <code class="mi">0</code> <code class="mi">10</code><code class="p">)</code> <code class="p">[</code><code class="mi">0</code> <code class="mi">1</code> <code class="mi">2</code> <code class="mi">3</code> <code class="mi">4</code> <code class="mi">5</code> <code class="mi">6</code> <code class="mi">7</code> <code class="mi">8</code><code class="p">])]</code> <code class="nv">values</code><code class="p">))</code>
<code class="linenos">31 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">x-data</code> <code class="p">(</code><code class="nf">*</code> <code class="mf">0.1</code> <code class="nv">x-data10</code><code class="p">))</code>
<code class="linenos">32 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">y-data</code> <code class="p">(</code><code class="nf">.</code> <code class="nb">all</code><code class="nv">-data.iloc</code> <code class="p">[(</code>, <code class="p">(</code><code class="nb">slice</code> <code class="mi">0</code> <code class="mi">10</code><code class="p">)</code> <code class="p">[</code><code class="mi">9</code><code class="p">])]</code> <code class="nv">values</code><code class="p">))</code>
<code class="linenos">33 </code>  <code class="p">[</code><code class="nv">x-data</code> <code class="nv">y-data</code><code class="p">])</code>
<code class="linenos">34 </code>
<code class="linenos">35 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">main</code> <code class="p">[]</code>
<code class="linenos">36 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">xyd</code> <code class="p">(</code><code class="nf">load-data</code> <code class="s">"train.csv"</code><code class="p">))</code>
<code class="linenos">37 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">model</code> <code class="p">(</code><code class="nf">build-model</code><code class="p">))</code>
<code class="linenos">38 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">xytest</code> <code class="p">(</code><code class="nf">load-data</code> <code class="s">"test.csv"</code><code class="p">))</code>
<code class="linenos">39 </code>  <code class="p">(</code><code class="nf">train</code> <code class="mi">10</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">.</code> <code class="nv">xyd</code> <code class="p">[</code><code class="mi">0</code><code class="p">])</code> <code class="p">(</code><code class="nf">.</code> <code class="nv">xyd</code> <code class="p">[</code><code class="mi">1</code><code class="p">]))</code>
<code class="linenos">40 </code>  <code class="p">(</code><code class="nb">print</code> <code class="s">"* predictions (calculated, expected):"</code><code class="p">)</code>
<code class="linenos">41 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">predictions</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">map</code> <code class="k">first </code><code class="p">(</code><code class="nf">predict</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">.</code> <code class="nv">xytest</code> <code class="p">[</code><code class="mi">0</code><code class="p">])))))</code>
<code class="linenos">42 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">expected</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">map</code> <code class="k">first </code><code class="p">(</code><code class="nf">.</code> <code class="nv">xytest</code> <code class="p">[</code><code class="mi">1</code><code class="p">]))))</code>
<code class="linenos">43 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">44 </code>    <code class="p">(</code><code class="nb">list</code>
<code class="linenos">45 </code>      <code class="p">(</code><code class="nb">zip</code> <code class="nv">predictions</code> <code class="nv">expected</code><code class="p">))))</code>
<code class="linenos">46 </code>
<code class="linenos">47 </code><code class="p">(</code><code class="nf">main</code><code class="p">)</code>
</pre></div>

</figure>

<p>The following listing shows the output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">$</code> <code class="nv">hy</code> <code class="nv">wisconsin.hy</code> 
<code class="linenos">2 </code><code class="nv">Using</code> <code class="nv">TensorFlow</code> <code class="nv">backend.</code>
<code class="linenos">3 </code><code class="nv">*</code> <code class="nv">predictions</code> <code class="p">(</code><code class="nf">calculated</code>, <code class="nv">expected</code><code class="p">)</code><code class="nv">:</code>
<code class="linenos">4 </code><code class="p">[(</code><code class="mf">0.9759052</code>, <code class="mi">1</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.99994254</code>, <code class="mi">1</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.8564741</code>, <code class="mi">1</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.95866203</code>, <code class="mi">1</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.03042546</code>, <code class="mi">0</code><code class="p">)</code>, <code class="err">\</code>
<code class="linenos">5 </code><code class="p">(</code><code class="mf">0.21845636</code>, <code class="mi">0</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.99662805</code>, <code class="mi">1</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.08626339</code>, <code class="mi">0</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.045683343</code>, <code class="mi">0</code><code class="p">)</code>, <code class="p">(</code><code class="mf">0.9992156</code>, <code class="mi">1</code><code class="p">)]</code>
</pre></div>

</figure>

<p>Let’s look at the first test case: the “real” output from the training data is a value of 1 and the calculated predicted value (using the trained model) is 0.9759052. In making predictions, we can choose a cutoff value, 0.5 for example, and interpret any calculated prediction value less than the cutoff as a Boolean <em>false</em> prediction and calculated prediction value greater to or equal to the cutoff value is a Boolean <em>true</em> prediction.</p>

<h3 id="leanpub-auto-using-a-lstm-recurrent-neural-network-to-generate-english-text-similar-to-the--philosopher-nietzsches-writing">Using a LSTM Recurrent Neural Network to Generate English Text Similar to the  Philosopher Nietzsche’s writing</h3>

<p>We will translate a Python example program from Google’s <a href="https://keras.io/examples/lstm_text_generation/">Keras documentation (listing of LSTM.py that is included with the example Hy code)</a> to Hy. This is a moderately long example and you can use the original Python and the translated Hy code as a general guide for converting other models implemented in Python using Keras that you want use in Hy. I have, in most cases, kept the same variable names to make it easier to compare the Python and Hy code.</p>

<p>Note that using the nietzsche.txt data set requires a fair amount of memory. If your computer has less than 16G of RAM, you might want to reduce the size of the training text by first running the following example until you see the printout “Create sentences and next_chars data…” then kill the program. The first time you run this program, the training data is fetched from the web and stored locally. You can manually edit the file <strong>~/.keras/datasets/nietzsche.txt</strong> to remove 75% of the data by:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">pushd</code> <code class="nv">~/.keras/datasets/</code>
<code class="linenos">2 </code>    <code class="nv">mv</code> <code class="nv">nietzsche.txt</code> <code class="nv">nietzsche_large.txt</code>
<code class="linenos">3 </code>    <code class="nv">head</code> <code class="mi">-800</code> <code class="nv">nietzsche_large.txt</code> <code class="nb">&gt;</code> <code class="nv">nietzsche.txt</code>
<code class="linenos">4 </code>    <code class="nv">popd</code>
</pre></div>

</figure>

<p>The next time you run the example, the Keras example data loading utilities will notice a local copy and even though the file now is much smaller, the data loading utilities will not download a new copy.</p>

<p>When I start training a new Deep Learning model I like to monitor system resources using the <strong>top</strong> command line activity, watching for page faults when training on a CPU which might indicate that I am trying to train too large of a model for my system memory. If you are using CUDA and a GPU then use the CUDA command line utilities for monitoring the state of the GPU utilization. It is beyond the scope of this introductory tutorial, but the tool <a href="https://www.tensorflow.org/tensorboard/">TensorBoard</a> is very useful for monitoring the state of model training.</p>

<p>There are a few things that make the following example code more complex than the example using the University of Wisconsin cancer data set. We need to convert each character in the training data to a one-hot encoding which is a vector of all 0.0 values except for a single value of 1.0. I am going to show you a short REPL session so that you understand how this works and then we will look at the complete Hy code example.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.callbacks</code> <code class="p">[</code><code class="nv">LambdaCallback</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="nv">Using</code> <code class="nv">TensorFlow</code> <code class="nv">backend.</code>
<code class="linenos"> 5 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.models</code> <code class="p">[</code><code class="nv">Sequential</code><code class="p">]])</code>
<code class="linenos"> 6 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.layers</code> <code class="p">[</code><code class="nv">Dense</code> <code class="nv">LSTM</code><code class="p">]])</code>
<code class="linenos"> 7 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.optimizers</code> <code class="p">[</code><code class="nv">RMSprop</code><code class="p">]])</code>
<code class="linenos"> 8 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.utils.data_utils</code> <code class="p">[</code><code class="nv">get_file</code><code class="p">]])</code>
<code class="linenos"> 9 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">numpy</code> <code class="ss">:as</code> <code class="nv">np</code><code class="p">])</code> <code class="c1">;; note the syntax for aliasing a module name</code>
<code class="linenos">10 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="nv">random</code> <code class="nv">sys</code> <code class="nv">io</code><code class="p">)</code>
<code class="linenos">11 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">with</code> <code class="p">[</code><code class="nv">f</code> <code class="p">(</code><code class="nf">io.open</code> <code class="s">"/Users/markw/.keras/datasets/nietzsche.txt"</code> <code class="ss">:encoding</code> <code class="s">"utf-8"</code><code class="p">)]</code>
<code class="linenos">12 </code><code class="nv">...</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">text</code> <code class="p">(</code><code class="nf">.read</code> <code class="nv">f</code><code class="p">)))</code>
<code class="linenos">13 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">text</code> <code class="mi">98</code> <code class="mi">130</code><code class="p">)</code>
<code class="linenos">14 </code><code class="ss">'philosophers</code>, <code class="k">in </code><code class="nv">so</code> <code class="nv">far</code> <code class="k">as</code> <code class="nv">they</code> <code class="o">'</code>
<code class="linenos">15 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">chars</code> <code class="p">(</code><code class="nb">sorted</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">set</code> <code class="nv">text</code><code class="p">))))</code>
<code class="linenos">16 </code><code class="nv">=&gt;</code> <code class="nv">chars</code>
<code class="linenos">17 </code><code class="p">[</code><code class="o">'</code><code class="sc">\n</code><code class="o">'</code>, <code class="o">'</code> <code class="o">'</code>, <code class="ss">'!</code><code class="o">'</code>, <code class="o">'</code><code class="s">"', "</code><code class="o">'</code><code class="s">", '(', ')', ',', '-', '.', '0', '1', '2', '3', '4', '5', '6\</code>
<code class="linenos">18 </code><code class="s">', '7', '8', '9', ':', ';', '?', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', '\</code>
<code class="linenos">19 </code><code class="s">K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', '_', 'a', \</code>
<code class="linenos">20 </code><code class="s">'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r',\</code>
<code class="linenos">21 </code><code class="s"> 's', 't', 'u', 'v', 'w', 'x', 'y', 'z']</code>
<code class="linenos">22 </code><code class="s">=&gt; (setv char_indices (dict (lfor i (enumerate chars) (, (last i) (first i)))))</code>
<code class="linenos">23 </code><code class="s">=&gt; char_indices</code>
<code class="linenos">24 </code><code class="s">{'\n': 0, ' ': 1, '!': 2, '"</code><code class="ss">':</code> <code class="mi">3</code>, <code class="s">"'"</code><code class="nv">:</code> <code class="mi">4</code>, <code class="o">'</code><code class="p">(</code><code class="ss">':</code> <code class="mi">5</code>, <code class="o">'</code><code class="p">)</code><code class="ss">':</code> <code class="mi">6</code>, <code class="o">'</code>,<code class="ss">':</code> <code class="mi">7</code>, <code class="ss">'-':</code> <code class="mi">8</code>, <code class="ss">'.':</code> <code class="mi">9</code>, <code class="ss">'0</code><code class="err">\</code>
<code class="linenos">25 </code><code class="ss">':</code> <code class="mi">10</code>, <code class="ss">'1':</code> <code class="mi">11</code>, <code class="ss">'2':</code> <code class="mi">12</code>, <code class="ss">'3':</code> <code class="mi">13</code>, <code class="ss">'4':</code> <code class="mi">14</code>, <code class="ss">'5':</code> <code class="mi">15</code>, <code class="ss">'6':</code> <code class="mi">16</code>, <code class="ss">'7':</code> <code class="mi">17</code>, <code class="ss">'8':</code> <code class="mi">18</code>, <code class="ss">'9':</code> <code class="err">\</code>
<code class="linenos">26 </code><code class="mi">19</code>, <code class="ss">':':</code> <code class="mi">20</code>, <code class="o">'</code><code class="c1">;': 21, '?': 22, 'A': 23, 'B': 24, 'C': 25, 'D': 26, 'E': 27, 'F': 28,\</code>
<code class="linenos">27 </code> <code class="ss">'G':</code> <code class="mi">29</code>, <code class="ss">'H':</code> <code class="mi">30</code>, <code class="ss">'I':</code> <code class="mi">31</code>, <code class="ss">'J':</code> <code class="mi">32</code>, <code class="ss">'K':</code> <code class="mi">33</code>, <code class="ss">'L':</code> <code class="mi">34</code>, <code class="ss">'M':</code> <code class="mi">35</code>, <code class="ss">'N':</code> <code class="mi">36</code>, <code class="ss">'O':</code> <code class="mi">37</code>, <code class="ss">'P</code><code class="err">\</code>
<code class="linenos">28 </code><code class="ss">':</code> <code class="mi">38</code>, <code class="ss">'Q':</code> <code class="mi">39</code>, <code class="ss">'R':</code> <code class="mi">40</code>, <code class="ss">'S':</code> <code class="mi">41</code>, <code class="ss">'T':</code> <code class="mi">42</code>, <code class="ss">'U':</code> <code class="mi">43</code>, <code class="ss">'V':</code> <code class="mi">44</code>, <code class="ss">'W':</code> <code class="mi">45</code>, <code class="ss">'X':</code> <code class="mi">46</code>, <code class="ss">'Y':</code> <code class="err">\</code>
<code class="linenos">29 </code><code class="mi">47</code>, <code class="ss">'_':</code> <code class="mi">48</code>, <code class="ss">'a':</code> <code class="mi">49</code>, <code class="ss">'b':</code> <code class="mi">50</code>, <code class="ss">'c':</code> <code class="mi">51</code>, <code class="ss">'d':</code> <code class="mi">52</code>, <code class="ss">'e':</code> <code class="mi">53</code>, <code class="ss">'f':</code> <code class="mi">54</code>, <code class="ss">'g':</code> <code class="mi">55</code>, <code class="ss">'h':</code> <code class="mi">56</code>,<code class="err">\</code>
<code class="linenos">30 </code> <code class="ss">'i':</code> <code class="mi">57</code>, <code class="ss">'j':</code> <code class="mi">58</code>, <code class="ss">'k':</code> <code class="mi">59</code>, <code class="ss">'l':</code> <code class="mi">60</code>, <code class="ss">'m':</code> <code class="mi">61</code>, <code class="ss">'n':</code> <code class="mi">62</code>, <code class="ss">'o':</code> <code class="mi">63</code>, <code class="ss">'p':</code> <code class="mi">64</code>, <code class="ss">'q':</code> <code class="mi">65</code>, <code class="ss">'r</code><code class="err">\</code>
<code class="linenos">31 </code><code class="ss">':</code> <code class="mi">66</code>, <code class="ss">'s':</code> <code class="mi">67</code>, <code class="ss">'t':</code> <code class="mi">68</code>, <code class="ss">'u':</code> <code class="mi">69</code>, <code class="ss">'v':</code> <code class="mi">70</code>, <code class="ss">'w':</code> <code class="mi">71</code>, <code class="ss">'x':</code> <code class="mi">72</code>, <code class="ss">'y':</code> <code class="mi">73</code>, <code class="ss">'z':</code> <code class="mi">74</code><code class="p">}</code>
<code class="linenos">32 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">indices_char</code> <code class="p">(</code><code class="nb">dict</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">chars</code><code class="p">)</code> <code class="nv">i</code><code class="p">)))</code>
<code class="linenos">33 </code><code class="nv">=&gt;</code> <code class="nv">indices_char</code>
<code class="linenos">34 </code><code class="p">{</code><code class="mi">0</code><code class="nv">:</code> <code class="o">'</code><code class="sc">\n</code><code class="o">'</code>, <code class="mi">1</code><code class="nv">:</code> <code class="o">'</code> <code class="o">'</code>, <code class="mi">2</code><code class="nv">:</code> <code class="ss">'!</code><code class="o">'</code>, <code class="mi">3</code><code class="nv">:</code> <code class="o">'</code><code class="s">"', 4: "</code><code class="o">'</code><code class="s">", 5: '(', 6: ')', 7: ',', 8: '-', 9: '.', 10\</code>
<code class="linenos">35 </code><code class="s">: '0', 11: '1', 12: '2', 13: '3', 14: '4', 15: '5', 16: '6', 17: '7', 18: '8', 19: '\</code>
<code class="linenos">36 </code><code class="s">9', 20: ':', 21: ';', 22: '?', 23: 'A', 24: 'B', 25: 'C', 26: 'D', 27: 'E', 28: 'F',\</code>
<code class="linenos">37 </code><code class="s"> 29: 'G', 30: 'H', 31: 'I', 32: 'J', 33: 'K', 34: 'L', 35: 'M', 36: 'N', 37: 'O', 38\</code>
<code class="linenos">38 </code><code class="s">: 'P', 39: 'Q', 40: 'R', 41: 'S', 42: 'T', 43: 'U', 44: 'V', 45: 'W', 46: 'X', 47: '\</code>
<code class="linenos">39 </code><code class="s">Y', 48: '_', 49: 'a', 50: 'b', 51: 'c', 52: 'd', 53: 'e', 54: 'f', 55: 'g', 56: 'h',\</code>
<code class="linenos">40 </code><code class="s"> 57: 'i', 58: 'j', 59: 'k', 60: 'l', 61: 'm', 62: 'n', 63: 'o', 64: 'p', 65: 'q', 66\</code>
<code class="linenos">41 </code><code class="s">: 'r', 67: 's', 68: 't', 69: 'u', 70: 'v', 71: 'w', 72: 'x', 73: 'y', 74: 'z'}</code>
<code class="linenos">42 </code><code class="s">=&gt; (setv maxlen 40)</code>
<code class="linenos">43 </code><code class="s">=&gt; (setv s "</code><code class="nv">Oh!</code> <code class="nv">I</code> <code class="nv">saw</code> <code class="mi">1</code> <code class="nv">dog</code> <code class="p">(</code><code class="nf">yesterday</code><code class="p">)</code><code class="s">")</code>
<code class="linenos">44 </code><code class="s">=&gt; (setv x_pred (np.zeros [1 maxlen (len chars)]))</code>
<code class="linenos">45 </code><code class="s">=&gt; (for [[t char] (lfor j (enumerate s) j)]</code>
<code class="linenos">46 </code><code class="s">... (setv (get x_pred 0 t (get char_indices char)) 1))</code>
<code class="linenos">47 </code><code class="s">=&gt; x_pred</code>
<code class="linenos">48 </code><code class="s">array([[[0., 0., 0., ..., 0., 0., 0.],</code>
<code class="linenos">49 </code><code class="s">        [0., 0., 0., ..., 0., 0., 0.],</code>
<code class="linenos">50 </code><code class="s">        [0., 0., 1., ..., 0., 0., 0.],   // here 1. is the third character "</code><code class="nv">!</code><code class="err">"</code>
<code class="linenos">51 </code>        <code class="nv">...</code>,
<code class="linenos">52 </code>        <code class="p">[</code><code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="nv">...</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code><code class="p">]</code>,
<code class="linenos">53 </code>        <code class="p">[</code><code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="nv">...</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code><code class="p">]</code>,
<code class="linenos">54 </code>        <code class="p">[</code><code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="nv">...</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code>, <code class="mi">0</code><code class="nv">.</code><code class="p">]]])</code>
<code class="linenos">55 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>For lines 48-54, each line represents a single character one-hot encoded. Notice how the third character shown on line 50 has a value of “1.” at index 2, which corresponds to the one-hot encoding of the letter “!”.</p>

<p>Now that you have a feeling for how one-hot encoding works, hopefully the following example will make sense to you. We will further discuss one-hot-encoding after the next code listing. For training, we take 40 characters (the value of the variable <strong>maxlen</strong>) at a time, and using one one-hot encode a character at a time as input and the target output will be the one-hot encoding of the following character in the input sequence. We are iterating on training the model for a while and then given a few characters of text, predict a likely next character - and keep repeating this process. The generated text is then used as input to the model to generate yet more text. You can repeat this process until you have generated sufficient text.</p>

<p>This is a powerful technique that I used to model JSON with complex deeply nested schemas and then generate synthetic JSON in the same schema as the training data. Here, training a model to mimic the philosopher Nietzsche’s writing is much easier than learning highly structured data like JSON:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="c1">;; This example was translated from the Python example in the Keras</code>
<code class="linenos"> 4 </code><code class="c1">;; documentation at: https://keras.io/examples/lstm_text_generation/</code>
<code class="linenos"> 5 </code><code class="c1">;; The original Python file LSTM.py is included in the directory</code>
<code class="linenos"> 6 </code><code class="c1">;; hy-lisp-python/deeplearning for reference.</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.callbacks</code> <code class="p">[</code><code class="nv">LambdaCallback</code><code class="p">]])</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.models</code> <code class="p">[</code><code class="nv">Sequential</code><code class="p">]])</code>
<code class="linenos">10 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.layers</code> <code class="p">[</code><code class="nv">Dense</code> <code class="nv">LSTM</code><code class="p">]])</code>
<code class="linenos">11 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.optimizers</code> <code class="p">[</code><code class="nv">RMSprop</code><code class="p">]])</code>
<code class="linenos">12 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">keras.utils.data_utils</code> <code class="p">[</code><code class="nv">get_file</code><code class="p">]])</code>
<code class="linenos">13 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">numpy</code> <code class="ss">:as</code> <code class="nv">np</code><code class="p">])</code> <code class="c1">;; note the syntax for aliasing a module name</code>
<code class="linenos">14 </code><code class="p">(</code><code class="k">import </code><code class="nv">random</code> <code class="nv">sys</code> <code class="nv">io</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">path</code>
<code class="linenos">17 </code>      <code class="p">(</code><code class="nf">get_file</code>        <code class="c1">;; this saves a local copy in ~/.keras/datasets</code>
<code class="linenos">18 </code>        <code class="s">"nietzsche.txt"</code>
<code class="linenos">19 </code>        <code class="ss">:origin</code> <code class="s">"https://s3.amazonaws.com/text-datasets/nietzsche.txt"</code><code class="p">))</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="k">with</code> <code class="p">[</code><code class="nv">f</code> <code class="p">(</code><code class="nf">io.open</code> <code class="nv">path</code> <code class="ss">:encoding</code> <code class="s">"utf-8"</code><code class="p">)]</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">text</code> <code class="p">(</code><code class="nf">.read</code> <code class="nv">f</code><code class="p">)))</code> <code class="c1">;; note: sometimes we use (.lower text) to</code>
<code class="linenos">23 </code><code class="c1">;;       convert text to all lower case</code>
<code class="linenos">24 </code><code class="p">(</code><code class="nb">print</code> <code class="s">"corpus length:"</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">text</code><code class="p">))</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">chars</code> <code class="p">(</code><code class="nb">sorted</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nb">set</code> <code class="nv">text</code><code class="p">))))</code>
<code class="linenos">27 </code><code class="p">(</code><code class="nb">print</code> <code class="s">"total chars (unique characters in input text):"</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">chars</code><code class="p">))</code>
<code class="linenos">28 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">char_indices</code> <code class="p">(</code><code class="nb">dict</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">chars</code><code class="p">)</code> <code class="p">(</code>, <code class="p">(</code><code class="nf">last</code> <code class="nv">i</code><code class="p">)</code> <code class="p">(</code><code class="k">first </code><code class="nv">i</code><code class="p">)))))</code>
<code class="linenos">29 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">indices_char</code> <code class="p">(</code><code class="nb">dict</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">i</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">chars</code><code class="p">)</code> <code class="nv">i</code><code class="p">)))</code>
<code class="linenos">30 </code>
<code class="linenos">31 </code><code class="c1">;; cut the text in semi-redundant sequences of maxlen characters</code>
<code class="linenos">32 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">maxlen</code> <code class="mi">40</code><code class="p">)</code>
<code class="linenos">33 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">step</code> <code class="mi">3</code><code class="p">)</code> <code class="c1">;; when we sample text, slide sampling window 3 characters</code>
<code class="linenos">34 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">sentences</code> <code class="p">(</code><code class="nb">list</code><code class="p">))</code>
<code class="linenos">35 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">next_chars</code> <code class="p">(</code><code class="nb">list</code><code class="p">))</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code><code class="p">(</code><code class="nb">print</code> <code class="s">"Create sentences and next_chars data..."</code><code class="p">)</code>
<code class="linenos">38 </code><code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">i</code> <code class="p">(</code><code class="nb">range</code> <code class="mi">0</code> <code class="p">(</code><code class="nf">-</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">text</code><code class="p">)</code> <code class="nv">maxlen</code><code class="p">)</code> <code class="nv">step</code><code class="p">)]</code>
<code class="linenos">39 </code>  <code class="p">(</code><code class="nf">.append</code> <code class="nv">sentences</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">text</code> <code class="nv">i</code> <code class="p">(</code><code class="nf">+</code> <code class="nv">i</code> <code class="nv">maxlen</code><code class="p">)))</code>
<code class="linenos">40 </code>  <code class="p">(</code><code class="nf">.append</code> <code class="nv">next_chars</code> <code class="p">(</code><code class="k">get </code><code class="nv">text</code> <code class="p">(</code><code class="nf">+</code> <code class="nv">i</code> <code class="nv">maxlen</code><code class="p">))))</code>
<code class="linenos">41 </code>
<code class="linenos">42 </code><code class="p">(</code><code class="nb">print</code> <code class="s">"Vectorization..."</code><code class="p">)</code>
<code class="linenos">43 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">x</code> <code class="p">(</code><code class="nf">np.zeros</code> <code class="p">[(</code><code class="nb">len</code> <code class="nv">sentences</code><code class="p">)</code> <code class="nv">maxlen</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">chars</code><code class="p">)]</code> <code class="ss">:dtype</code> <code class="nv">np.bool</code><code class="p">))</code>
<code class="linenos">44 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">y</code> <code class="p">(</code><code class="nf">np.zeros</code> <code class="p">[(</code><code class="nb">len</code> <code class="nv">sentences</code><code class="p">)</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">chars</code><code class="p">)]</code> <code class="ss">:dtype</code> <code class="nv">np.bool</code><code class="p">))</code>
<code class="linenos">45 </code><code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">i</code> <code class="nv">sentence</code><code class="p">]</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">j</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">sentences</code><code class="p">)</code> <code class="nv">j</code><code class="p">)]</code>
<code class="linenos">46 </code>  <code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">t</code> <code class="nv">char</code><code class="p">]</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">j</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">sentence</code><code class="p">)</code> <code class="nv">j</code><code class="p">)]</code>
<code class="linenos">47 </code>    <code class="p">(</code><code class="kd">setv </code><code class="p">(</code><code class="k">get </code><code class="nv">x</code> <code class="nv">i</code> <code class="nv">t</code> <code class="p">(</code><code class="k">get </code><code class="nv">char_indices</code> <code class="nv">char</code><code class="p">))</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">48 </code>  <code class="p">(</code><code class="kd">setv </code><code class="p">(</code><code class="k">get </code><code class="nv">y</code> <code class="nv">i</code> <code class="p">(</code><code class="k">get </code><code class="nv">char_indices</code> <code class="p">(</code><code class="k">get </code><code class="nv">next_chars</code> <code class="nv">i</code><code class="p">)))</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">49 </code><code class="p">(</code><code class="nb">print</code> <code class="s">"Done creating one-hot encoded training data."</code><code class="p">)</code>
<code class="linenos">50 </code>
<code class="linenos">51 </code><code class="p">(</code><code class="nb">print</code> <code class="s">"Building model..."</code><code class="p">)</code>
<code class="linenos">52 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">model</code> <code class="p">(</code><code class="nf">Sequential</code><code class="p">))</code>
<code class="linenos">53 </code><code class="p">(</code><code class="nf">.add</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">LSTM</code> <code class="mi">128</code> <code class="ss">:input_shape</code> <code class="p">[</code><code class="nv">maxlen</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">chars</code><code class="p">)]))</code>
<code class="linenos">54 </code><code class="p">(</code><code class="nf">.add</code> <code class="nv">model</code> <code class="p">(</code><code class="nf">Dense</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">chars</code><code class="p">)</code> <code class="ss">:activation</code> <code class="s">"softmax"</code><code class="p">))</code>
<code class="linenos">55 </code>
<code class="linenos">56 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">optimizer</code> <code class="p">(</code><code class="nf">RMSprop</code> <code class="mf">0.01</code><code class="p">))</code>
<code class="linenos">57 </code><code class="p">(</code><code class="nf">.compile</code> <code class="nv">model</code> <code class="ss">:loss</code> <code class="s">"categorical_crossentropy"</code> <code class="ss">:optimizer</code> <code class="nv">optimizer</code><code class="p">)</code>
<code class="linenos">58 </code>
<code class="linenos">59 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">sample</code> <code class="p">[</code><code class="nv">preds</code> <code class="o">&amp;</code><code class="nv">optional</code> <code class="p">[</code><code class="nv">temperature</code> <code class="mf">1.0</code><code class="p">]]</code>
<code class="linenos">60 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">preds</code> <code class="p">(</code><code class="nf">.astype</code> <code class="p">(</code><code class="nf">np.array</code> <code class="nv">preds</code><code class="p">)</code> <code class="s">"float64"</code><code class="p">))</code>
<code class="linenos">61 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">preds</code> <code class="p">(</code><code class="nf">/</code> <code class="p">(</code><code class="nf">np.log</code> <code class="nv">preds</code><code class="p">)</code> <code class="nv">temperature</code><code class="p">))</code>
<code class="linenos">62 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">exp_preds</code> <code class="p">(</code><code class="nf">np.exp</code> <code class="nv">preds</code><code class="p">))</code>
<code class="linenos">63 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">preds</code> <code class="p">(</code><code class="nf">/</code> <code class="nv">exp_preds</code> <code class="p">(</code><code class="nf">np.sum</code> <code class="nv">exp_preds</code><code class="p">)))</code>
<code class="linenos">64 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">probas</code> <code class="p">(</code><code class="nf">np.random.multinomial</code> <code class="mi">1</code> <code class="nv">preds</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">65 </code>  <code class="p">(</code><code class="nf">np.argmax</code> <code class="nv">probas</code><code class="p">))</code>
<code class="linenos">66 </code>
<code class="linenos">67 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">on_epoch_end</code> <code class="p">[</code><code class="nv">epoch</code> <code class="o">&amp;</code><code class="nv">optional</code> <code class="nv">not-used</code><code class="p">]</code>
<code class="linenos">68 </code>  <code class="p">(</code><code class="nb">print</code><code class="p">)</code>
<code class="linenos">69 </code>  <code class="p">(</code><code class="nb">print</code> <code class="s">"----- Generating text after Epoch:"</code> <code class="nv">epoch</code><code class="p">)</code>
<code class="linenos">70 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">start_index</code> <code class="p">(</code><code class="nf">random.randint</code> <code class="mi">0</code> <code class="p">(</code><code class="nf">-</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">text</code><code class="p">)</code> <code class="nv">maxlen</code> <code class="mi">1</code><code class="p">)))</code>
<code class="linenos">71 </code>  <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">diversity</code> <code class="p">[</code><code class="mf">0.2</code> <code class="mf">0.5</code> <code class="mf">1.0</code> <code class="mf">1.2</code><code class="p">]]</code>
<code class="linenos">72 </code>    <code class="p">(</code><code class="nb">print</code> <code class="s">"----- diversity:"</code> <code class="nv">diversity</code><code class="p">)</code>
<code class="linenos">73 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">generated</code> <code class="s">""</code><code class="p">)</code>
<code class="linenos">74 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">sentence</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">text</code> <code class="nv">start_index</code> <code class="p">(</code><code class="nf">+</code> <code class="nv">start_index</code> <code class="nv">maxlen</code><code class="p">)))</code>
<code class="linenos">75 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">generated</code> <code class="p">(</code><code class="nf">+</code> <code class="nv">generated</code> <code class="nv">sentence</code><code class="p">))</code>
<code class="linenos">76 </code>    <code class="p">(</code><code class="nb">print</code> <code class="s">"----- Generating with seed:"</code> <code class="nv">sentence</code><code class="p">)</code>
<code class="linenos">77 </code>    <code class="p">(</code><code class="nf">sys.stdout.write</code> <code class="nv">generated</code><code class="p">)</code>
<code class="linenos">78 </code>    <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">i</code> <code class="p">(</code><code class="nb">range</code> <code class="mi">400</code><code class="p">)]</code>
<code class="linenos">79 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">x_pred</code> <code class="p">(</code><code class="nf">np.zeros</code> <code class="p">[</code><code class="mi">1</code> <code class="nv">maxlen</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">chars</code><code class="p">)]))</code>
<code class="linenos">80 </code>      <code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">t</code> <code class="nv">char</code><code class="p">]</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">j</code> <code class="p">(</code><code class="nb">enumerate</code> <code class="nv">sentence</code><code class="p">)</code> <code class="nv">j</code><code class="p">)]</code>
<code class="linenos">81 </code>        <code class="p">(</code><code class="kd">setv </code><code class="p">(</code><code class="k">get </code><code class="nv">x_pred</code> <code class="mi">0</code> <code class="nv">t</code> <code class="p">(</code><code class="k">get </code><code class="nv">char_indices</code> <code class="nv">char</code><code class="p">))</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">82 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">preds</code> <code class="p">(</code><code class="k">first </code><code class="p">(</code><code class="nf">model.predict</code> <code class="nv">x_pred</code> <code class="ss">:verbose</code> <code class="mi">0</code><code class="p">)))</code>
<code class="linenos">83 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">next_index</code> <code class="p">(</code><code class="nf">sample</code> <code class="nv">preds</code> <code class="nv">diversity</code><code class="p">))</code>
<code class="linenos">84 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">next_char</code> <code class="p">(</code><code class="k">get </code><code class="nv">indices_char</code> <code class="nv">next_index</code><code class="p">))</code>
<code class="linenos">85 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">sentence</code> <code class="p">(</code><code class="nf">+</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">sentence</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">next_char</code><code class="p">))</code>
<code class="linenos">86 </code>      <code class="p">(</code><code class="nf">sys.stdout.write</code> <code class="nv">next_char</code><code class="p">)</code>
<code class="linenos">87 </code>      <code class="p">(</code><code class="nf">sys.stdout.flush</code><code class="p">))</code>
<code class="linenos">88 </code>    <code class="p">(</code><code class="nb">print</code><code class="p">)))</code>
<code class="linenos">89 </code>
<code class="linenos">90 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">print_callback</code> <code class="p">(</code><code class="nf">LambdaCallback</code> <code class="ss">:on_epoch_end</code> <code class="nv">on_epoch_end</code><code class="p">))</code>
<code class="linenos">91 </code>
<code class="linenos">92 </code><code class="p">(</code><code class="nf">model.fit</code> <code class="nv">x</code> <code class="nv">y</code> <code class="ss">:batch_size</code> <code class="mi">128</code> <code class="ss">:epochs</code> <code class="mi">60</code> <code class="ss">:callbacks</code> <code class="p">[</code><code class="nv">print_callback</code><code class="p">])</code>
</pre></div>

</figure>

<p>In lines 52-54 we defined a model using the Keras APIs and in lines 56-57 compiled the model using a <a href="https://keras.io/optimizers/">categorical crossentropy loss function with an RMSprop optimizer</a>.</p>

<p>In lines 59-65 we define a function <strong>sample</strong> that takes a first required argument <strong>preds</strong> which is a one-hot predicted encoded character that might look like (maxlen or 40 values):</p>

<p>[2.80193929e-02 6.78635418e-01 7.85831537e-04 4.92034527e-03
   . . .
 6.62320468e-04 9.14627407e-03 2.31375365e-04]</p>

<p>Now, here the predicted one hot encoding values are not strictly 0 or 1, rather they are small floating point numbers of a single number much larger than the others. The largest number is 6.78635418e-01 at index 1 which corresponds to a one-hot encoding for a “ “ space character.</p>

<p>If we print out the number of characters in text and the unique list of characters (variable <strong>chars</strong>) in the training text file nietzsche.txt we see:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">corpus</code> <code class="nv">length:</code> <code class="mi">600893</code>
<code class="nv">[</code><code class="ss">'\n',</code> <code class="o">'</code> <code class="ss">',</code> <code class="ss">'!',</code> <code class="o">'</code><code class="s">"', "</code><code class="o">'</code><code class="err">"</code><code class="o">,</code> <code class="o">'</code><code class="p">(</code><code class="ss">',</code> <code class="o">'</code><code class="p">)</code><code class="ss">',</code> <code class="ss">',',</code> <code class="ss">'-',</code> <code class="ss">'.',</code> <code class="ss">'0',</code> <code class="ss">'1',</code> <code class="ss">'2',</code> <code class="ss">'3',</code> <code class="ss">'4',</code> <code class="ss">'5',</code> <code class="ss">'6</code><code class="err">\</code>
<code class="ss">',</code> <code class="ss">'7',</code> <code class="ss">'8',</code> <code class="ss">'9',</code> <code class="o">'</code><code class="err">:</code><code class="ss">',</code> <code class="o">'</code><code class="c1">;', '=', '?', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', '\</code>
<code class="nv">J</code><code class="ss">',</code> <code class="ss">'K',</code> <code class="ss">'L',</code> <code class="ss">'M',</code> <code class="ss">'N',</code> <code class="ss">'O',</code> <code class="ss">'P',</code> <code class="ss">'Q',</code> <code class="ss">'R',</code> <code class="ss">'S',</code> <code class="ss">'T',</code> <code class="ss">'U',</code> <code class="ss">'V',</code> <code class="ss">'W',</code> <code class="ss">'X',</code> <code class="ss">'Y',</code> <code class="ss">'Z',</code> <code class="err">\</code>
<code class="ss">'[',</code> <code class="ss">']',</code> <code class="ss">'_',</code> <code class="ss">'a',</code> <code class="ss">'b',</code> <code class="ss">'c',</code> <code class="ss">'d',</code> <code class="ss">'e',</code> <code class="ss">'f',</code> <code class="ss">'g',</code> <code class="ss">'h',</code> <code class="ss">'i',</code> <code class="ss">'j',</code> <code class="ss">'k',</code> <code class="ss">'l',</code> <code class="ss">'m',</code> <code class="ss">'n',</code><code class="err">\</code>
 <code class="ss">'o',</code> <code class="ss">'p',</code> <code class="ss">'q',</code> <code class="ss">'r',</code> <code class="ss">'s',</code> <code class="ss">'t',</code> <code class="ss">'u',</code> <code class="ss">'v',</code> <code class="ss">'w',</code> <code class="ss">'x',</code> <code class="ss">'y',</code> <code class="ss">'z',</code> <code class="ss">'Æ',</code> <code class="ss">'ä',</code> <code class="ss">'æ',</code> <code class="ss">'é',</code> <code class="ss">'ë</code><code class="o">'</code><code class="err">\</code>
<code class="nv">]</code>
</pre></div>

</figure>

<p><strong>A review of one-hot encoding:</strong></p>

<p>Let’s review our earlier discussion of one-hot encoding with a simpler case. It is important to understand how we one-hot encode input text to inputs for the model and decode back one-hot vectors to text when we use a trained model to generate text. It will help to see the dictionaries for converting characters to indices and then reverse indices to original characters as we saw earlier, some output removed:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">char_indices:</code>
 <code class="nv">{</code><code class="ss">'\n</code><code class="o">'</code><code class="err">:</code> <code class="mi">0</code><code class="o">,</code> <code class="o">'</code> <code class="o">'</code><code class="err">:</code> <code class="mi">1</code><code class="o">,</code> <code class="ss">'!</code><code class="o">'</code><code class="err">:</code> <code class="mi">2</code><code class="o">,</code> <code class="o">'</code><code class="s">"': 3, "</code><code class="o">'</code><code class="s">": 4, '(': 5, ')': 6, ',': 7, '-': 8, '.': 9, '\</code>
<code class="s">0': 10, '1': 11, '2': 12, '3': 13, '4': 14, '5': 15, '6': 16, '7': 17, '8': 18, '9':\</code>
<code class="s"> 19, </code>
<code class="s">   . . .</code>
<code class="s"> 'f': 58, 'g': 59, 'h': 60, 'i': 61, 'j': 62, 'k': 63, 'l': 64, 'm': 65, 'n': 66, 'o\</code>
<code class="s">': 67, 'p': 68, 'q': 69, 'r': 70, 's': 71, 't': 72, 'u': 73, 'v': 74, 'w': 75, 'x': \</code>
<code class="s">76, 'y': 77, 'z': 78, 'Æ': 79, 'ä': 80, 'æ': 81, 'é': 82, 'ë': 83}</code>
<code class="s">indices_char:</code>
<code class="s"> {0: '\n', 1: ' ', 2: '!', 3: '"</code><code class="ss">',</code> <code class="nv">4:</code> <code class="s">"'"</code><code class="o">,</code> <code class="nv">5:</code> <code class="o">'</code><code class="p">(</code><code class="ss">',</code> <code class="nv">6:</code> <code class="o">'</code><code class="p">)</code><code class="ss">',</code> <code class="nv">7:</code> <code class="ss">',',</code> <code class="nv">8:</code> <code class="ss">'-',</code> <code class="nv">9:</code> <code class="ss">'.',</code> <code class="nv">1</code><code class="err">\</code>
<code class="nv">0:</code> <code class="ss">'0',</code> <code class="nv">11:</code> <code class="ss">'1',</code> <code class="nv">12:</code> <code class="ss">'2',</code> <code class="nv">13:</code> <code class="ss">'3',</code> <code class="nv">14:</code> <code class="ss">'4',</code> <code class="nv">15:</code> <code class="ss">'5',</code> <code class="nv">16:</code> <code class="ss">'6',</code> <code class="nv">17:</code> <code class="ss">'7',</code> <code class="nv">18:</code> <code class="ss">'8',</code> <code class="nv">19:</code> <code class="err">\</code>
<code class="ss">'9',</code> 
   <code class="o">.</code> <code class="o">.</code> <code class="o">.</code>
 <code class="ss">'o',</code> <code class="nv">68:</code> <code class="ss">'p',</code> <code class="nv">69:</code> <code class="ss">'q',</code> <code class="nv">70:</code> <code class="ss">'r',</code> <code class="nv">71:</code> <code class="ss">'s',</code> <code class="nv">72:</code> <code class="ss">'t',</code> <code class="nv">73:</code> <code class="ss">'u',</code> <code class="nv">74:</code> <code class="ss">'v',</code> <code class="nv">75:</code> <code class="ss">'w',</code> <code class="nv">76:</code> <code class="ss">'x</code><code class="err">\</code>
<code class="ss">',</code> <code class="nv">77:</code> <code class="ss">'y',</code> <code class="nv">78:</code> <code class="ss">'z',</code> <code class="nv">79:</code> <code class="ss">'Æ',</code> <code class="nv">80:</code> <code class="ss">'ä',</code> <code class="nv">81:</code> <code class="ss">'æ',</code> <code class="nv">82:</code> <code class="ss">'é',</code> <code class="nv">83:</code> <code class="ss">'ë'}</code>
</pre></div>

</figure>

<p>We prepare the input and target output data in lines 43-48 in the last code listing. Using a short string, let’s look in the next REPL session listing at how these input and output training examples are extracted for an input string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>Marks-MacBook:deeplearning $ hy
<code class="linenos"> 2 </code>hy <code class="m">0</code>.17.0+108.g919a77e using CPython<code class="o">(</code>default<code class="o">)</code> <code class="m">3</code>.7.3 on <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="o">=</code>&gt; <code class="o">(</code>setv text <code class="s2">"0123456789abcdefg"</code><code class="o">)</code>
<code class="linenos"> 4 </code><code class="o">=</code>&gt; <code class="o">(</code>setv maxlen <code class="m">4</code><code class="o">)</code>
<code class="linenos"> 5 </code><code class="o">=</code>&gt; <code class="o">(</code>setv i <code class="m">3</code><code class="o">)</code>
<code class="linenos"> 6 </code><code class="o">=</code>&gt; <code class="o">(</code>cut text i <code class="o">(</code>+ i maxlen<code class="o">))</code>
<code class="linenos"> 7 </code><code class="s1">'3456'</code>
<code class="linenos"> 8 </code><code class="o">=</code>&gt; <code class="o">(</code>cut text <code class="o">(</code>+ <code class="m">1</code> maxlen<code class="o">))</code>
<code class="linenos"> 9 </code><code class="s1">'56789abcdefg'</code>
<code class="linenos">10 </code><code class="o">=</code>&gt; <code class="o">(</code>setv i <code class="m">4</code><code class="o">)</code>                 <code class="p">;;</code> i is the <code class="k">for</code> loop variable <code class="k">for</code>
<code class="linenos">11 </code><code class="o">=</code>&gt; <code class="o">(</code>cut text i <code class="o">(</code>+ i maxlen<code class="o">))</code>  <code class="p">;;</code> defining sentences and next_chars
<code class="linenos">12 </code><code class="s1">'4567'</code>
<code class="linenos">13 </code><code class="o">=</code>&gt; <code class="o">(</code>cut text <code class="o">(</code>+ i maxlen<code class="o">))</code>
<code class="linenos">14 </code><code class="s1">'89abcdefg'</code>
<code class="linenos">15 </code><code class="o">=</code>&gt; 
</pre></div>

</figure>

<p>So the input training sentences are each <strong>maxlen</strong> characters long and the <strong>next-chars</strong> target outputs each start with the character after the last character in the corresponding input training sentence.</p>

<p>This script pauses during each training epoc to generate text given diversity values of 0.2, 0.5, 1.0, and 1.2. The smaller the diversity value the more closely the generated text matches the training text. The generated text is more realistic after many training epocs. In the following, I list a highly edited copy of running through several training epochs. I only show generated text for diversity equal to 0.2:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="nv">text</code> <code class="nv">after</code> <code class="nv">Epoch:</code> <code class="mi">0</code>
<code class="linenos"> 2 </code><code class="nv">-----</code> <code class="nv">diversity:</code> <code class="mf">0.2</code>
<code class="linenos"> 3 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="k">with</code> <code class="nv">seed:</code> <code class="nv">ocity.</code> <code class="nv">Equally</code> <code class="nv">so</code>, <code class="nv">gratitude.--Justice</code> <code class="nv">r</code>
<code class="linenos"> 4 </code><code class="nv">ocity.</code> <code class="nv">Equally</code> <code class="nv">so</code>, <code class="nv">gratitude.--Justice</code> <code class="nv">read</code> <code class="k">in </code><code class="nv">the</code> <code class="nv">become</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">conscience</code> <code class="nv">the</code> <code class="nv">seen</code><code class="err">\</code>
<code class="linenos"> 5 </code><code class="nv">er</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">conception</code> <code class="nv">that</code> <code class="nv">the</code> <code class="nv">becess</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">power</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">procentical</code> <code class="nv">that</code> <code class="nv">the</code> <code class="nv">becau</code><code class="err">\</code>
<code class="linenos"> 6 </code><code class="nv">se</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">prostice</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">prostice</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">will</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">conscience</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">power</code> <code class="nv">of</code> <code class="nv">t</code><code class="err">\</code>
<code class="linenos"> 7 </code><code class="nv">he</code> <code class="nv">perhaps</code> <code class="nv">the</code> <code class="bp">self</code><code class="nv">-distance</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nb">all</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">world</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">s</code><code class="err">\</code>
<code class="linenos"> 8 </code><code class="nv">oul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">world</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">and</code> <code class="nv">an</code> <code class="nv">an</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">profound</code> <code class="nv">the</code> <code class="bp">self</code><code class="nv">-dister</code> <code class="nv">the</code> <code class="nb">all</code> <code class="nv">the</code><code class="err">\</code>
<code class="linenos"> 9 </code> <code class="nv">belief</code> <code class="nv">and</code> <code class="nv">the</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="nv">text</code> <code class="nv">after</code> <code class="nv">Epoch:</code> <code class="mi">8</code>
<code class="linenos">12 </code><code class="nv">-----</code> <code class="nv">diversity:</code> <code class="mf">0.2</code>
<code class="linenos">13 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="k">with</code> <code class="nv">seed:</code> <code class="nv">nations</code>
<code class="linenos">14 </code><code class="nv">laboring</code> <code class="nv">simultaneously</code> <code class="nv">under</code> <code class="nv">th</code>
<code class="linenos">15 </code><code class="nv">nations</code>
<code class="linenos">16 </code><code class="nv">laboring</code> <code class="nv">simultaneously</code> <code class="nv">under</code> <code class="nv">the</code> <code class="nv">subjection</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">same</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">subjecti</code><code class="err">\</code>
<code class="linenos">17 </code><code class="nv">on</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">subjection</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">same</code> <code class="nv">not</code> <code class="nv">a</code> <code class="nv">strong</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">spiritual</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">same</code> <code class="err">\</code>
<code class="linenos">18 </code><code class="nv">really</code> <code class="nv">the</code> <code class="nv">propers</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">stree</code> <code class="nv">be</code> <code class="nv">the</code> <code class="nv">subjection</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">spiritual</code> <code class="nv">that</code> <code class="k">is </code><code class="nv">to</code> <code class="nv">probab</code><code class="err">\</code>
<code class="linenos">19 </code><code class="nv">ly</code> <code class="nv">the</code> <code class="nv">stree</code> <code class="nv">concerning</code> <code class="nv">the</code> <code class="nv">spiritual</code> <code class="nv">the</code> <code class="nv">sublicities</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">spiritual</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">proce</code><code class="err">\</code>
<code class="linenos">20 </code><code class="nv">ssities</code> <code class="nv">the</code> <code class="nv">spirit</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">subjection</code> <code class="nv">of</code> <code class="nv">the</code> <code class="bp">self</code><code class="nv">-constitution</code> <code class="nv">and</code> <code class="nv">proper</code><code class="err">\</code>
<code class="linenos">21 </code><code class="nv">s</code> <code class="nv">to</code> <code class="nv">the</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="nv">text</code> <code class="nv">after</code> <code class="nv">Epoch:</code> <code class="mi">14</code>
<code class="linenos">24 </code><code class="nv">-----</code> <code class="nv">diversity:</code> <code class="mf">0.2</code>
<code class="linenos">25 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="k">with</code> <code class="nv">seed:</code>  <code class="nv">to</code> <code class="nv">which</code> <code class="nv">no</code> <code class="nv">other</code> <code class="nv">path</code> <code class="nv">could</code> <code class="nv">conduct</code> <code class="nv">us</code>
<code class="linenos">26 </code> <code class="nv">to</code> <code class="nv">which</code> <code class="nv">no</code> <code class="nv">other</code> <code class="nv">path</code> <code class="nv">could</code> <code class="nv">conduct</code> <code class="nv">us</code> <code class="nv">a</code> <code class="nv">stronger</code> <code class="nv">that</code> <code class="k">is </code><code class="nv">the</code> <code class="bp">self</code><code class="nv">-delight</code> <code class="nv">and</code> <code class="nv">the</code><code class="err">\</code>
<code class="linenos">27 </code> <code class="nv">strange</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">world</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">consider</code> <code class="nv">the</code> <code class="nv">such</code> <code class="nv">a</code> <code class="err">\</code>
<code class="linenos">28 </code><code class="nv">state</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">such</code> <code class="nv">a</code> <code class="nv">sandine</code> <code class="nv">and</code> <code class="nv">interpretation</code> <code class="nv">of</code><code class="err">\</code>
<code class="linenos">29 </code> <code class="nv">the</code> <code class="nv">process</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">process</code> <code class="nv">of</code> <code class="nv">th</code><code class="err">\</code>
<code class="linenos">30 </code><code class="nv">e</code> <code class="nv">world</code> <code class="k">in </code><code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">spirit</code> <code class="nv">and</code> <code class="nv">superstetion</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">world</code> <code class="nv">the</code> <code class="nv">se</code><code class="err">\</code>
<code class="linenos">31 </code><code class="nv">nse</code> <code class="nv">of</code> <code class="nv">the</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="nv">text</code> <code class="nv">after</code> <code class="nv">Epoch:</code> <code class="mi">17</code>
<code class="linenos">34 </code><code class="nv">-----</code> <code class="nv">diversity:</code> <code class="mf">0.2</code>
<code class="linenos">35 </code><code class="nv">-----</code> <code class="nv">Generating</code> <code class="k">with</code> <code class="nv">seed:</code> <code class="nv">hemselves</code> <code class="nv">although</code> <code class="nv">they</code> <code class="nv">could</code> <code class="nv">easily</code> <code class="nv">hav</code>
<code class="linenos">36 </code><code class="nv">hemselves</code> <code class="nv">although</code> <code class="nv">they</code> <code class="nv">could</code> <code class="nv">easily</code> <code class="nv">have</code> <code class="nv">been</code> <code class="nv">moral</code> <code class="nv">morality</code> <code class="nv">and</code> <code class="nv">the</code> <code class="bp">self</code><code class="nv">-in</code> <code class="nv">which</code> <code class="err">\</code>
<code class="linenos">37 </code><code class="nv">the</code> <code class="bp">self</code><code class="nv">-in</code> <code class="nv">the</code> <code class="nv">world</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">same</code> <code class="nv">man</code> <code class="k">in </code><code class="nv">the</code> <code class="nv">standard</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">possibility</code> <code class="nv">that</code> <code class="k">is </code><code class="nv">to</code> <code class="err">\</code>
<code class="linenos">38 </code><code class="nv">the</code> <code class="nv">strength</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">sense-in</code> <code class="nv">the</code> <code class="nv">former</code> <code class="nv">the</code> <code class="nv">sense-in</code> <code class="nv">the</code> <code class="nv">special</code> <code class="nv">and</code> <code class="nv">the</code> <code class="nv">same</code> <code class="nv">man</code> <code class="nv">in</code><code class="err">\</code>
<code class="linenos">39 </code> <code class="nv">the</code> <code class="nv">consequently</code> <code class="nv">the</code> <code class="nv">soul</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">superstition</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">special</code> <code class="k">in </code><code class="nv">the</code> <code class="nv">end</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">poss</code><code class="err">\</code>
<code class="linenos">40 </code><code class="nv">ible</code> <code class="nv">that</code> <code class="nv">it</code> <code class="k">is </code><code class="nv">will</code> <code class="nv">not</code> <code class="nv">be</code> <code class="nv">a</code> <code class="nv">sort</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">superior</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">superstition</code> <code class="nv">of</code> <code class="nv">the</code> <code class="nv">same</code> <code class="nv">m</code><code class="err">\</code>
<code class="linenos">41 </code><code class="nv">an</code> <code class="nv">to</code> <code class="nv">the</code> <code class="nv">same</code> <code class="nv">man</code>
</pre></div>

</figure>

<p>Here we trained on examples, translated to English, of the philosopher Nietzsche. I have used similar code to this example to train on highly structured JSON data and the resulting LSTM bsed model was usually able to generate similarly structured JSON. I have seen other examples where the training data was code in C++.</p>

<p>How is this example working? The model learns what combinations of characters tend to appear together and in what order.</p>

<p>In the next chapter we will use pre-trained Deep Learning models for natural language processing (NLP).</p>


<h2 id="leanpub-auto-natural-language-processing">Natural Language Processing</h2>

<p>I have been working in the field of Natural Language Processing (NLP) since 1985 so I ‘lived through’ the revolutionary change in NLP that has occurred since 2014: deep learning results out-classed results from previous symbolic methods.</p>

<p>I will not cover older symbolic methods of NLP here, rather I refer you to my previous books <a href="https://leanpub.com/javaai">Practical Artificial Intelligence Programming With Java</a>, [Loving Common Lisp, <a href="https://leanpub.com/lovinglisp">The Savvy Programmer’s Secret Weapon</a>, and <a href="https://leanpub.com/haskell-cookbook">Haskell Tutorial and Cookbook</a> for examples. We get better results using Deep Learning (DL) for NLP and the library <strong>spaCy</strong> (<a href="https://spacy.io/">https://spacy.io</a>) that we use in this chapter provides near state of the art performance. The authors of <strong>spaCy</strong> frequently update it to use the latest breakthroughs in the field.</p>

<p>You will learn how to apply both DL and NLP by using the state-of-the-art full-feature library <a href="https://spacy.io/">spaCy</a>. This chapter concentrates on how to use spaCy in the Hy language for solutions to a few selected problems in NLP that I use in my own work. I urge you to also review the “Guides” section of the <a href="https://spacy.io/usage">spaCy documentation</a> where examples are in Python but after experimenting with the examples in this chapter you should have no difficulty in translating any spaCy Python examples to the Hy language.</p>

<p>If you have not already done so install the <strong>spaCy</strong> library and the full English language model:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip install spacy
python -m spacy download en
</pre></div>

</figure>

<p>You can use a smaller model (which requires loading “en_core_web_sm” instead of “en” in the following examples):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip install spacy
python -m spacy download en_core_web_sm
</pre></div>

</figure>

<h3 id="leanpub-auto-exploring-the-spacy-library">Exploring the spaCy Library</h3>

<p>We will use the Hy REPL to experiment with spaCy, Lisp style. The following REPL listings are all from the same session, split into separate listings so that I can talk you through the examples:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">Marks</code><code class="o">-</code><code class="nl">MacBook:</code><code class="n">nlp</code> <code class="n">$</code> <code class="n">hy</code>
<code class="linenos"> 2 </code><code class="n">hy</code> <code class="mf">0.17</code><code class="o">.</code><code class="mi">0</code><code class="o">+</code><code class="mi">108</code><code class="o">.</code><code class="na">g919a77e</code> <code class="n">using</code> <code class="n">CPython</code><code class="o">(</code><code class="k">default</code><code class="o">)</code> <code class="mf">3.7</code><code class="o">.</code><code class="mi">3</code> <code class="n">on</code> <code class="n">Darwin</code>
<code class="linenos"> 3 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="nn">spacy</code><code class="o">)</code>
<code class="linenos"> 4 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">nlp</code><code class="o">-</code><code class="n">model</code> <code class="o">(</code><code class="n">spacy</code><code class="o">.</code><code class="na">load</code> <code class="s">"en"</code><code class="o">))</code>
<code class="linenos"> 5 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">doc</code> <code class="o">(</code><code class="n">nlp</code><code class="o">-</code><code class="n">model</code> <code class="s">"President George Bush went to Mexico and he had a very good\</code>
<code class="linenos"> 6 </code><code class="s"> meal"</code><code class="o">))</code>
<code class="linenos"> 7 </code><code class="o">=&gt;</code> <code class="n">doc</code>
<code class="linenos"> 8 </code><code class="n">President</code> <code class="n">George</code> <code class="n">Bush</code> <code class="n">went</code> <code class="n">to</code> <code class="n">Mexico</code> <code class="n">and</code> <code class="n">he</code> <code class="n">had</code> <code class="n">a</code> <code class="n">very</code> <code class="n">good</code> <code class="n">meal</code>
<code class="linenos"> 9 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">dir</code> <code class="n">doc</code><code class="o">)</code>
<code class="linenos">10 </code><code class="o">[</code><code class="sc">'_'</code><code class="o">,</code> <code class="err">'</code><code class="n">__bytes__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__class__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__delattr__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__dir__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__doc__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__eq__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__fo</code><code class="err">\</code>
<code class="linenos">11 </code><code class="n">rmat__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__ge__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__getattribute__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__getitem__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__gt__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__hash__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__init_</code><code class="err">\</code>
<code class="linenos">12 </code><code class="n">_</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__init_subclass__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__iter__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__le__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__len__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__lt__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__ne__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__new</code><code class="err">\</code>
<code class="linenos">13 </code><code class="n">__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__pyx_vtable__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__reduce__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__reduce_ex__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__repr__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__setattr__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__</code><code class="err">\</code>
<code class="linenos">14 </code><code class="n">setstate__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__sizeof__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__str__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__subclasshook__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">__unicode__</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_bulk_merg</code><code class="err">\</code>
<code class="linenos">15 </code><code class="n">e</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_py_tokens</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_realloc</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_vector</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_vector_norm</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">cats</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">char_span</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">count</code><code class="err">\</code>
<code class="linenos">16 </code><code class="n">_by</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">doc</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">ents</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">extend_tensor</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">from_array</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">from_bytes</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">from_disk</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">get_</code><code class="err">\</code>
<code class="linenos">17 </code><code class="n">extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">get_lca_matrix</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">has_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">has_vector</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_nered</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_parsed</code><code class="err">'\</code>
<code class="linenos">18 </code><code class="o">,</code> <code class="err">'</code><code class="n">is_sentenced</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_tagged</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">lang</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">lang_</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">mem</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">merge</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">noun_chunks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">noun</code><code class="err">\</code>
<code class="linenos">19 </code><code class="n">_chunks_iterator</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">print_tree</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">remove_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">retokenize</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">sentiment</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">sen</code><code class="err">\</code>
<code class="linenos">20 </code><code class="n">ts</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">set_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">similarity</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">tensor</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">text</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">text_with_ws</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_array</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">t</code><code class="err">\</code>
<code class="linenos">21 </code><code class="n">o_bytes</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_disk</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_json</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_data</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_hooks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_span_hooks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_</code><code class="err">\</code>
<code class="linenos">22 </code><code class="n">token_hooks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">vector</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">vector_norm</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">vocab</code><code class="err">'</code><code class="o">]</code>
</pre></div>

</figure>

<p>In lines 3-6 we import the spaCy library, load the English language model, and create a document from input text. What is a spaCy document? In line 9 we use the standard Python function <strong>dir</strong> to look at all names and functions defined for the object <strong>doc</strong> returned from applying a spaCy model to a string containing text. The value printed shows many built in “dunder” (double underscore attributes), and we can remove these:</p>

<p>In lines 23-26 we use the <strong>dir</strong> function again to see the attributes and methods for this class, but filter out any attributes containing the characters “__”:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">23 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">lfor</code>
<code class="linenos">24 </code><code class="o">...</code> <code class="n">x</code> <code class="o">(</code><code class="n">dir</code> <code class="n">doc</code><code class="o">)</code>
<code class="linenos">25 </code><code class="o">...</code> <code class="o">:</code><code class="k">if</code> <code class="o">(</code><code class="n">not</code> <code class="o">(.</code><code class="n">startswith</code> <code class="n">x</code> <code class="s">"__"</code><code class="o">))</code>
<code class="linenos">26 </code><code class="o">...</code> <code class="n">x</code><code class="o">)</code>
<code class="linenos">27 </code><code class="o">[</code><code class="sc">'_'</code><code class="o">,</code> <code class="err">'</code><code class="n">_bulk_merge</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_py_tokens</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_realloc</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_vector</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">_vector_norm</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">cats</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">c</code><code class="err">\</code>
<code class="linenos">28 </code><code class="n">har_span</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">count_by</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">doc</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">ents</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">extend_tensor</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">from_array</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">from_bytes</code><code class="err">'</code><code class="o">,</code> <code class="err">'\</code>
<code class="linenos">29 </code><code class="n">from_disk</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">get_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">get_lca_matrix</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">has_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">has_vector</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_ne</code><code class="err">\</code>
<code class="linenos">30 </code><code class="n">red</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_parsed</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_sentenced</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">is_tagged</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">lang</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">lang_</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">mem</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">merge</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">no</code><code class="err">\</code>
<code class="linenos">31 </code><code class="n">un_chunks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">noun_chunks_iterator</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">print_tree</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">remove_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">retokenize</code><code class="err">'</code><code class="o">,</code> <code class="err">\</code>
<code class="linenos">32 </code><code class="err">'</code><code class="n">sentiment</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">sents</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">set_extension</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">similarity</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">tensor</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">text</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">text_with_ws</code><code class="err">\</code>
<code class="linenos">33 </code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_array</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_bytes</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_disk</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">to_json</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_data</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_hooks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_sp</code><code class="err">\</code>
<code class="linenos">34 </code><code class="n">an_hooks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">user_token_hooks</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">vector</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">vector_norm</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">vocab</code><code class="err">'</code><code class="o">]</code>
<code class="linenos">35 </code><code class="o">=&gt;</code>
</pre></div>

</figure>

<p>The <strong>to_json</strong> method looks promising so we will import the Python pretty print library and look at the pretty printed result of calling the <strong>to_json</strong> method on our document stored in <strong>doc</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 36 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="err">[</code><code class="nn">pprint</code> <code class="o">[</code><code class="n">pprint</code><code class="o">]])</code>
<code class="linenos"> 37 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">pprint</code> <code class="o">(</code><code class="n">doc</code><code class="o">.</code><code class="na">to_json</code><code class="o">))</code>
<code class="linenos"> 38 </code><code class="o">{</code><code class="err">'</code><code class="n">ents</code><code class="err">'</code><code class="o">:</code> <code class="o">[{</code><code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">21</code><code class="o">,</code> <code class="err">'</code><code class="n">label</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PERSON</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">10</code><code class="o">},</code>
<code class="linenos"> 39 </code>          <code class="o">{</code><code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">36</code><code class="o">,</code> <code class="err">'</code><code class="n">label</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">GPE</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">30</code><code class="o">}],</code>
<code class="linenos"> 40 </code> <code class="err">'</code><code class="n">sents</code><code class="err">'</code><code class="o">:</code> <code class="o">[{</code><code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">64</code><code class="o">,</code> <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">0</code><code class="o">}],</code>
<code class="linenos"> 41 </code> <code class="err">'</code><code class="n">text</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">President</code> <code class="n">George</code> <code class="n">Bush</code> <code class="n">went</code> <code class="n">to</code> <code class="n">Mexico</code> <code class="n">and</code> <code class="n">he</code> <code class="n">had</code> <code class="n">a</code> <code class="n">very</code> <code class="n">good</code> <code class="n">meal</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 42 </code> <code class="err">'</code><code class="n">tokens</code><code class="err">'</code><code class="o">:</code> <code class="o">[{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">compound</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 43 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">9</code><code class="o">,</code>
<code class="linenos"> 44 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">2</code><code class="o">,</code>
<code class="linenos"> 45 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">0</code><code class="o">,</code>
<code class="linenos"> 46 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PROPN</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 47 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">0</code><code class="o">,</code>
<code class="linenos"> 48 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">NNP</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 49 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">compound</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 50 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">16</code><code class="o">,</code>
<code class="linenos"> 51 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">2</code><code class="o">,</code>
<code class="linenos"> 52 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">1</code><code class="o">,</code>
<code class="linenos"> 53 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PROPN</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 54 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">10</code><code class="o">,</code>
<code class="linenos"> 55 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">NNP</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 56 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">nsubj</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 57 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">21</code><code class="o">,</code>
<code class="linenos"> 58 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">3</code><code class="o">,</code>
<code class="linenos"> 59 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">2</code><code class="o">,</code>
<code class="linenos"> 60 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PROPN</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 61 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">17</code><code class="o">,</code>
<code class="linenos"> 62 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">NNP</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 63 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">ROOT</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 64 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">26</code><code class="o">,</code>
<code class="linenos"> 65 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">3</code><code class="o">,</code>
<code class="linenos"> 66 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">3</code><code class="o">,</code>
<code class="linenos"> 67 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">VERB</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 68 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">22</code><code class="o">,</code>
<code class="linenos"> 69 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">VBD</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 70 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">prep</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 71 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">29</code><code class="o">,</code>
<code class="linenos"> 72 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">3</code><code class="o">,</code>
<code class="linenos"> 73 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">4</code><code class="o">,</code>
<code class="linenos"> 74 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">ADP</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 75 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">27</code><code class="o">,</code>
<code class="linenos"> 76 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">IN</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 77 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">pobj</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 78 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">36</code><code class="o">,</code>
<code class="linenos"> 79 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">4</code><code class="o">,</code>
<code class="linenos"> 80 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">5</code><code class="o">,</code>
<code class="linenos"> 81 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PROPN</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 82 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">30</code><code class="o">,</code>
<code class="linenos"> 83 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">NNP</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 84 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">cc</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 85 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">40</code><code class="o">,</code>
<code class="linenos"> 86 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">3</code><code class="o">,</code>
<code class="linenos"> 87 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">6</code><code class="o">,</code>
<code class="linenos"> 88 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">CCONJ</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 89 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">37</code><code class="o">,</code>
<code class="linenos"> 90 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">CC</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 91 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">nsubj</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 92 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">43</code><code class="o">,</code>
<code class="linenos"> 93 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">8</code><code class="o">,</code>
<code class="linenos"> 94 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">7</code><code class="o">,</code>
<code class="linenos"> 95 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PRON</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 96 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">41</code><code class="o">,</code>
<code class="linenos"> 97 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">PRP</code><code class="err">'</code><code class="o">},</code>
<code class="linenos"> 98 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">conj</code><code class="err">'</code><code class="o">,</code>
<code class="linenos"> 99 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">47</code><code class="o">,</code>
<code class="linenos">100 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">3</code><code class="o">,</code>
<code class="linenos">101 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">8</code><code class="o">,</code>
<code class="linenos">102 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">VERB</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">103 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">44</code><code class="o">,</code>
<code class="linenos">104 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">VBD</code><code class="err">'</code><code class="o">},</code>
<code class="linenos">105 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">det</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">106 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">49</code><code class="o">,</code>
<code class="linenos">107 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">12</code><code class="o">,</code>
<code class="linenos">108 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">9</code><code class="o">,</code>
<code class="linenos">109 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">DET</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">110 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">48</code><code class="o">,</code>
<code class="linenos">111 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">DT</code><code class="err">'</code><code class="o">},</code>
<code class="linenos">112 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">advmod</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">113 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">54</code><code class="o">,</code>
<code class="linenos">114 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">11</code><code class="o">,</code>
<code class="linenos">115 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">10</code><code class="o">,</code>
<code class="linenos">116 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">ADV</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">117 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">50</code><code class="o">,</code>
<code class="linenos">118 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">RB</code><code class="err">'</code><code class="o">},</code>
<code class="linenos">119 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">amod</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">120 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">59</code><code class="o">,</code>
<code class="linenos">121 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">12</code><code class="o">,</code>
<code class="linenos">122 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">11</code><code class="o">,</code>
<code class="linenos">123 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">ADJ</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">124 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">55</code><code class="o">,</code>
<code class="linenos">125 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">JJ</code><code class="err">'</code><code class="o">},</code>
<code class="linenos">126 </code>            <code class="o">{</code><code class="err">'</code><code class="n">dep</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">dobj</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">127 </code>             <code class="err">'</code><code class="n">end</code><code class="err">'</code><code class="o">:</code> <code class="mi">64</code><code class="o">,</code>
<code class="linenos">128 </code>             <code class="err">'</code><code class="n">head</code><code class="err">'</code><code class="o">:</code> <code class="mi">8</code><code class="o">,</code>
<code class="linenos">129 </code>             <code class="err">'</code><code class="n">id</code><code class="err">'</code><code class="o">:</code> <code class="mi">12</code><code class="o">,</code>
<code class="linenos">130 </code>             <code class="err">'</code><code class="n">pos</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">NOUN</code><code class="err">'</code><code class="o">,</code>
<code class="linenos">131 </code>             <code class="err">'</code><code class="n">start</code><code class="err">'</code><code class="o">:</code> <code class="mi">60</code><code class="o">,</code>
<code class="linenos">132 </code>             <code class="err">'</code><code class="n">tag</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">NN</code><code class="err">'</code><code class="o">}]}</code>
<code class="linenos">133 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>The JSON data is nested dictionaries. In a later chapter on Knowledge Graphs, we will want to get the named entities like people, organizations, etc., from text and use this information to automatically generate data for Knowledge Graphs. The values for the key <strong>ents</strong> (stands for “entities”) will be useful. Notice that the words in the original text are specified by beginning and ending text token indices (values of <strong>head</strong> and <strong>end</strong> in lines 52 to 142).</p>

<p>The values for the key <strong>tokens</strong> listed on lines 42-132 contains the head (or starting index, ending index, the token number (<strong>id</strong>), and the part of speech (<strong>pos</strong>). We will list what the parts of speech mean later.</p>

<p>We would like the words for each entity to be concatenated into a single string for each entity and we do this here in lines 136-137 and see the results in lines 138-139.</p>

<p>I like to add the entity name strings back into the dictionary representing a document and line 140 shows the use of <strong>lfor</strong> to create a list of lists where the sublists contain the entity name as a single string and the type of entity. We list the entity types supported by spaCy in the next section.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">134 </code><code class="o">=&gt;</code> <code class="n">doc</code><code class="o">.</code><code class="na">ents</code>
<code class="linenos">135 </code><code class="o">(</code><code class="n">George</code> <code class="n">Bush</code><code class="o">,</code> <code class="n">Mexico</code><code class="o">)</code>
<code class="linenos">136 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[</code><code class="n">entity</code> <code class="n">doc</code><code class="o">.</code><code class="na">ents</code><code class="o">]</code>
<code class="linenos">137 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="s">"entity text:"</code> <code class="n">entity</code><code class="o">.</code><code class="na">text</code> <code class="s">"entity label:"</code> <code class="n">entity</code><code class="o">.</code><code class="na">label_</code><code class="o">))</code>
<code class="linenos">138 </code><code class="n">entity</code> <code class="nl">text:</code> <code class="n">George</code> <code class="n">Bush</code> <code class="n">entity</code> <code class="nl">label:</code> <code class="n">PERSON</code>
<code class="linenos">139 </code><code class="n">entity</code> <code class="nl">text:</code> <code class="n">Mexico</code> <code class="n">entity</code> <code class="nl">label:</code> <code class="n">GPE</code>
<code class="linenos">140 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">lfor</code> <code class="n">entity</code> <code class="n">doc</code><code class="o">.</code><code class="na">ents</code> <code class="o">[</code><code class="n">entity</code><code class="o">.</code><code class="na">text</code> <code class="n">entity</code><code class="o">.</code><code class="na">label_</code><code class="o">])</code>
<code class="linenos">141 </code><code class="o">[[</code><code class="err">'</code><code class="n">George</code> <code class="n">Bush</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">PERSON</code><code class="err">'</code><code class="o">],</code> <code class="o">[</code><code class="err">'</code><code class="n">Mexico</code><code class="err">'</code><code class="o">,</code> <code class="err">'</code><code class="n">GPE</code><code class="err">'</code><code class="o">]]</code>
<code class="linenos">142 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>We can also access each sentence as a separate string. In this example the original text used to create our sample document had only a single sentence so the <strong>sents</strong> property returns a list containing a single string:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">147 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">list</code> <code class="n">doc</code><code class="o">.</code><code class="na">sents</code><code class="o">)</code>
<code class="linenos">148 </code><code class="o">[</code><code class="n">President</code> <code class="n">George</code> <code class="n">Bush</code> <code class="n">went</code> <code class="n">to</code> <code class="n">Mexico</code> <code class="n">and</code> <code class="n">he</code> <code class="n">had</code> <code class="n">a</code> <code class="n">very</code> <code class="n">good</code> <code class="n">meal</code><code class="o">]</code>
<code class="linenos">149 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>The last example showing how to use a spaCy document object is listing each word with its part of speech:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">150 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[</code><code class="n">word</code> <code class="n">doc</code><code class="o">]</code>
<code class="linenos">151 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="n">word</code><code class="o">.</code><code class="na">text</code> <code class="n">word</code><code class="o">.</code><code class="na">pos_</code><code class="o">))</code>
<code class="linenos">152 </code><code class="n">President</code> <code class="n">PROPN</code>
<code class="linenos">153 </code><code class="n">George</code> <code class="n">PROPN</code>
<code class="linenos">154 </code><code class="n">Bush</code> <code class="n">PROPN</code>
<code class="linenos">155 </code><code class="n">went</code> <code class="n">VERB</code>
<code class="linenos">156 </code><code class="n">to</code> <code class="n">ADP</code>
<code class="linenos">157 </code><code class="n">Mexico</code> <code class="n">PROPN</code>
<code class="linenos">158 </code><code class="n">and</code> <code class="n">CCONJ</code>
<code class="linenos">159 </code><code class="n">he</code> <code class="n">PRON</code>
<code class="linenos">160 </code><code class="n">had</code> <code class="n">VERB</code>
<code class="linenos">161 </code><code class="n">a</code> <code class="n">DET</code>
<code class="linenos">162 </code><code class="n">very</code> <code class="n">ADV</code>
<code class="linenos">163 </code><code class="n">good</code> <code class="n">ADJ</code>
<code class="linenos">164 </code><code class="n">meal</code> <code class="n">NOUN</code>
<code class="linenos">165 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>The following list shows the definitions for the part of speech (POS) tags:</p>

<ul>
  <li>ADJ: adjective</li>
  <li>ADP: adposition</li>
  <li>ADV: adverb</li>
  <li>AUX: auxiliary verb</li>
  <li>CONJ: coordinating conjunction</li>
  <li>DET: determiner</li>
  <li>INTJ: interjection</li>
  <li>NOUN: noun</li>
  <li>NUM: numeral</li>
  <li>PART: particle</li>
  <li>PRON: pronoun</li>
  <li>PROPN: proper noun</li>
  <li>PUNCT: punctuation</li>
  <li>SCONJ: subordinating conjunction</li>
  <li>SYM: symbol</li>
  <li>VERB: verb</li>
  <li>X: other</li>
</ul>

<h3 id="leanpub-auto-implementing-a-hynlp-wrapper-for-the-python-spacy-library">Implementing a HyNLP Wrapper for the Python spaCy Library</h3>

<p>We will generate two libraries (in files <strong>nlp_lib.hy</strong> and <strong>coref_nlp_lib.hy</strong>). The first is a general NLP library and the second specifically solves the anaphora resolution, or coreference, problem. There are test programs for each library in the files <strong>nlp_example.hy</strong> and <strong>coref_example.hy</strong>.</p>

<p>For an example in a later chapter, we will use the library developed here to automatically generate Knowledge Graphs from text data. We will need the ability to find person, company, location, etc. names in text. We use spaCy here to do this. The types of named entities on which spaCy is pre-trained includes:</p>

<ul>
  <li>CARDINAL: any number that is not identified as a more specific type, like money, time, etc.</li>
  <li>DATE</li>
  <li>FAC: facilities like highways, bridges, airports, etc.</li>
  <li>GPE: Countries, states (or provinces), and cities</li>
  <li>LOC: any non-GPE location</li>
  <li>PRODUCT</li>
  <li>EVENT</li>
  <li>LANGUAGE: any named language</li>
  <li>MONEY: any monetary value or unit of money</li>
  <li>NORP: nationalities or religious groups</li>
  <li>ORG: any organization like a company, non-profit, school, etc.</li>
  <li>PERCENT: any number in [0, 100] followed by the percent % character</li>
  <li>PERSON</li>
  <li>ORDINAL: any number spelled out, like “one”, “two”, etc.</li>
  <li>TIME</li>
</ul>

<p>Listing for hy-lisp-python/nlp/nlp_lib.hy:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="nv">spacy</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">nlp-model</code> <code class="p">(</code><code class="nf">spacy.load</code> <code class="s">"en"</code><code class="p">))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">nlp</code> <code class="p">[</code><code class="nv">some-text</code><code class="p">]</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">doc</code> <code class="p">(</code><code class="nf">nlp-model</code> <code class="nv">some-text</code><code class="p">))</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">entities</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">entity</code> <code class="nv">doc.ents</code> <code class="p">[</code><code class="nv">entity.text</code> <code class="nv">entity.label_</code><code class="p">]))</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">j</code> <code class="p">(</code><code class="nf">doc.to_json</code><code class="p">))</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="kd">setv </code><code class="p">(</code><code class="k">get </code><code class="nv">j</code> <code class="s">"entities"</code><code class="p">)</code> <code class="nv">entities</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="nv">j</code><code class="p">)</code>
</pre></div>

</figure>

<p>Listing for hy-lisp-python/nlp/nlp_example.hy:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">nlp-lib</code> <code class="p">[</code><code class="nv">nlp</code><code class="p">]])</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="p">(</code><code class="nb">print</code>
<code class="linenos">6 </code>  <code class="p">(</code><code class="nf">nlp</code> <code class="s">"President George Bush went to Mexico and he had a very good meal"</code><code class="p">))</code>
<code class="linenos">7 </code>
<code class="linenos">8 </code><code class="p">(</code><code class="nb">print</code>
<code class="linenos">9 </code>  <code class="p">(</code><code class="nf">nlp</code> <code class="s">"Lucy threw a ball to Bill and he caught it"</code><code class="p">))</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">Marks-MacBook:nlp</code> <code class="nv">$</code> <code class="nv">./nlp_example.hy</code>
<code class="linenos">2 </code><code class="p">{</code><code class="ss">'text':</code> <code class="ss">'President</code> <code class="nv">George</code> <code class="nv">Bush</code> <code class="nv">went</code> <code class="nv">to</code> <code class="nv">Mexico</code> <code class="nv">and</code> <code class="nv">he</code> <code class="nv">had</code> <code class="nv">a</code> <code class="nv">very</code> <code class="nv">good</code> <code class="nv">meal</code><code class="o">'</code>, <code class="ss">'ents':</code><code class="err">\</code>
<code class="linenos">3 </code> <code class="p">[{</code><code class="ss">'start':</code> <code class="mi">10</code>, <code class="ss">'end':</code> <code class="mi">21</code>, <code class="ss">'label':</code> <code class="ss">'PERSON</code><code class="o">'</code><code class="p">}</code>, <code class="p">{</code><code class="ss">'start':</code> <code class="mi">30</code>, <code class="ss">'end':</code> <code class="mi">36</code>, <code class="ss">'label':</code> <code class="ss">'GP</code><code class="err">\</code>
<code class="linenos">4 </code><code class="nv">E</code><code class="o">'</code><code class="p">}]</code>, <code class="ss">'sents':</code> <code class="p">[{</code><code class="ss">'start':</code> <code class="mi">0</code>, <code class="ss">'end':</code> <code class="mi">64</code><code class="p">}]</code>, <code class="ss">'tokens':</code> 
<code class="linenos">5 </code>
<code class="linenos">6 </code>  <code class="nv">..LOTS</code> <code class="nv">OF</code> <code class="nv">OUTPUT</code> <code class="nv">NOT</code> <code class="nv">SHOWN..</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-coreference-anaphora-resolution">Coreference (Anaphora Resolution)</h3>

<p>Another common NLP task is coreference (or anaphora resolution) which is the process of resolving pronouns in text (e.g., he, she, it, etc.) with preceding proper nouns that pronouns refer to. A simple example would be translating “John ran fast and he fell” to “John ran fast and John fell.” This is an easy example, but often proper nouns that pronouns refer to are in previous sentences and resolving coreference can be ambiguous and require knowledge of common word use and grammar. This problem is now handled by deep learning transfer models like <a href="https://github.com/google-research/bert">BERT</a>.</p>

<p>In addition to installing <strong>spaCy</strong> you also need the library <strong>neuralcoref</strong>. Only specific versions of <strong>spaCy</strong> and <strong>neuralcoref</strong> are compatible with each other. As of July 31, 2020 the following works to get dependencies and run the example for this section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip uninstall spacy neuralcoref
pip install <code class="nv">spacy</code><code class="o">==</code><code class="m">2</code>.1.3
python -m spacy download en
pip install <code class="nv">neuralcoref</code><code class="o">==</code><code class="m">4</code>.0.0
./coref_example.hy 
</pre></div>

</figure>

<p>Please note that version 2.1.3 of <strong>spaCy</strong> is older than the default version that pip installs. You might want to create a new Python virtual environment for this example or if you use Anaconda then use separate Anaconda environment.</p>

<p>Listing of coref_nlp_lib.hy contains a wrapper for spaCy’s coreference model:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="nv">argparse</code> <code class="nv">os</code><code class="p">)</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="k">import </code><code class="nv">spacy</code> <code class="nv">neuralcoref</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">nlp2</code> <code class="p">(</code><code class="nf">spacy.load</code> <code class="s">"en"</code><code class="p">))</code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nf">neuralcoref.add_to_pipe</code> <code class="nv">nlp2</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">coref-nlp</code> <code class="p">[</code><code class="nv">some-text</code><code class="p">]</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">doc</code> <code class="p">(</code><code class="nf">nlp2</code> <code class="nv">some-text</code><code class="p">))</code>
<code class="linenos"> 9 </code>  <code class="p">{</code> <code class="s">"corefs"</code> <code class="nv">doc._.coref_resolved</code>
<code class="linenos">10 </code>    <code class="s">"clusters"</code> <code class="nv">doc._.coref_clusters</code>
<code class="linenos">11 </code>    <code class="s">"scores"</code> <code class="nv">doc._.coref_scores</code><code class="p">})</code>
</pre></div>

</figure>

<p>Listing of <strong>coref_example.hy</strong> shows code to test the Hy spaCy and coreference wrapper:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">coref-nlp-lib</code> <code class="p">[</code><code class="nv">coref-nlp</code><code class="p">]])</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="c1">;; tests:</code>
<code class="linenos">6 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">coref-nlp</code> <code class="s">"President George Bush went to Mexico and he had a very good meal"</code><code class="err">\</code>
<code class="linenos">7 </code><code class="p">))</code>
<code class="linenos">8 </code><code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">coref-nlp</code> <code class="s">"Lucy threw a ball to Bill and he caught it"</code><code class="p">))</code>
</pre></div>

</figure>

<p>The output will look like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">Marks-MacBook:nlp</code> <code class="nv">$</code> <code class="nv">./coref_example.hy</code> 
<code class="linenos"> 2 </code><code class="p">{</code><code class="ss">'corefs':</code> <code class="ss">'President</code> <code class="nv">George</code> <code class="nv">Bush</code> <code class="nv">went</code> <code class="nv">to</code> <code class="nv">Mexico</code> <code class="nv">and</code> <code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush</code> <code class="nv">had</code> <code class="nv">a</code> <code class="nv">ver</code><code class="err">\</code>
<code class="linenos"> 3 </code><code class="nv">y</code> <code class="nv">good</code> <code class="nv">meal</code><code class="o">'</code>, <code class="ss">'clusters':</code> <code class="p">[</code><code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="p">[</code><code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush</code>, <code class="nv">he</code><code class="p">]]</code>, <code class="ss">'sco</code><code class="err">\</code>
<code class="linenos"> 4 </code><code class="nv">res</code><code class="ss">':</code> <code class="p">{</code><code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="p">{</code><code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">1.5810412168502808</code><code class="p">}</code>, <code class="nv">George</code> <code class="nv">Bu</code><code class="err">\</code>
<code class="linenos"> 5 </code><code class="nv">sh:</code> <code class="p">{</code><code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">4.11817741394043</code>, <code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">-1.546141266822815</code><code class="p">}</code>, <code class="nv">Mexi</code><code class="err">\</code>
<code class="linenos"> 6 </code><code class="nv">co:</code> <code class="p">{</code><code class="nv">Mexico:</code> <code class="mf">1.4138349294662476</code>, <code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">-4.650205612182617</code>, <code class="nv">George</code> <code class="nv">B</code><code class="err">\</code>
<code class="linenos"> 7 </code><code class="nv">ush:</code> <code class="mf">-3.666614532470703</code><code class="p">}</code>, <code class="nv">he:</code> <code class="p">{</code><code class="nv">he:</code> <code class="mf">-0.5704692006111145</code>, <code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">9.385</code><code class="err">\</code>
<code class="linenos"> 8 </code><code class="mi">97583770752</code>, <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">-1.4178757667541504</code>, <code class="nv">Mexico:</code> <code class="mf">-3.6565260887145996</code><code class="p">}</code>, <code class="nv">a</code> <code class="nv">very</code> <code class="err">\</code>
<code class="linenos"> 9 </code><code class="nv">good</code> <code class="nv">meal:</code> <code class="p">{</code><code class="nv">a</code> <code class="nv">very</code> <code class="nv">good</code> <code class="nv">meal:</code> <code class="mf">1.652894377708435</code>, <code class="nv">President</code> <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">-2.554375886</code><code class="err">\</code>
<code class="linenos">10 </code><code class="mi">9171143</code>, <code class="nv">George</code> <code class="nv">Bush:</code> <code class="mf">-2.13267183303833</code>, <code class="nv">Mexico:</code> <code class="mf">-1.6889561414718628</code>, <code class="nv">he:</code> <code class="mf">-2.7667927</code><code class="err">\</code>
<code class="linenos">11 </code><code class="mi">742004395</code><code class="p">}}}</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="p">{</code><code class="ss">'corefs':</code> <code class="ss">'Lucy</code> <code class="nv">threw</code> <code class="nv">a</code> <code class="nv">ball</code> <code class="nv">to</code> <code class="nv">Bill</code> <code class="nv">and</code> <code class="nv">Bill</code> <code class="nv">caught</code> <code class="nv">a</code> <code class="nv">ball</code><code class="o">'</code>, <code class="ss">'clusters':</code> <code class="p">[</code><code class="nv">a</code> <code class="nv">ball:</code> <code class="err">\</code>
<code class="linenos">14 </code><code class="p">[</code><code class="nv">a</code> <code class="nv">ball</code>, <code class="nv">it</code><code class="p">]</code>, <code class="nv">Bill:</code> <code class="p">[</code><code class="nv">Bill</code>, <code class="nv">he</code><code class="p">]]</code>, <code class="ss">'scores':</code> <code class="p">{</code><code class="nv">Lucy:</code> <code class="p">{</code><code class="nv">Lucy:</code> <code class="mf">0.41820740699768066</code><code class="p">}</code>, <code class="nv">a</code> <code class="nv">bal</code><code class="err">\</code>
<code class="linenos">15 </code><code class="nv">l:</code> <code class="p">{</code><code class="nv">a</code> <code class="nv">ball:</code> <code class="mf">1.8033190965652466</code>, <code class="nv">Lucy:</code> <code class="mf">-2.721518039703369</code><code class="p">}</code>, <code class="nv">Bill:</code> <code class="p">{</code><code class="nv">Bill:</code> <code class="mf">1.5611814260</code><code class="err">\</code>
<code class="linenos">16 </code><code class="mi">482788</code>, <code class="nv">Lucy:</code> <code class="mf">-2.8222298622131348</code>, <code class="nv">a</code> <code class="nv">ball:</code> <code class="mf">-1.806389570236206</code><code class="p">}</code>, <code class="nv">he:</code> <code class="p">{</code><code class="nv">he:</code> <code class="mf">-0.57600766</code><code class="err">\</code>
<code class="linenos">17 </code><code class="mi">42036438</code>, <code class="nv">Lucy:</code> <code class="mf">3.054243326187134</code>, <code class="nv">a</code> <code class="nv">ball:</code> <code class="mf">-1.818403720855713</code>, <code class="nv">Bill:</code> <code class="mf">3.0774276256561</code><code class="err">\</code>
<code class="linenos">18 </code><code class="mi">28</code><code class="p">}</code>, <code class="nv">it:</code> <code class="p">{</code><code class="nv">it:</code> <code class="mf">-1.0269954204559326</code>, <code class="nv">Lucy:</code> <code class="mf">-3.4972281455993652</code>, <code class="nv">a</code> <code class="nv">ball:</code> <code class="mf">-0.31290221214</code><code class="err">\</code>
<code class="linenos">19 </code><code class="mi">294434</code>, <code class="nv">Bill:</code> <code class="mf">-2.5343685150146484</code>, <code class="nv">he:</code> <code class="mf">-3.6687228679656982</code><code class="p">}}}</code>
</pre></div>

</figure>

<p>Anaphora resolution, also called coreference, refers to two or more words or phrases in an input text refer to the same noun. This analysis usually entails identifying which noun phrases that pronouns refer to.</p>

<h3 id="leanpub-auto-wrap-up-2">Wrap-up</h3>

<p>I spent several years of development time during the period from  1984 through 2015 working on natural language processing technology and as a personal side project I sold commercial NLP libraries that I wrote on my own time in Ruby and Common Lisp. The state-of-the-art of Deep Learning enhanced NLP is very good and the open source spaCy library makes excellent use of both conventional NLP technology and pre-trained Deep Learning models. I no longer spend very much time writing my own NLP libraries and instead use spaCy.</p>

<p>I urge you to read through the <a href="https://spacy.io/api/doc">spaCy documentation</a> because we covered just basic functionality here that we will also need in the later chapter on automatically generating data for Knowledge Graphs. After working through the interactive REPL sessions and the examples in this chapter, you should be able to translate any Python API example code to Hy.</p>


<h2 id="leanpub-auto-datastores">Datastores</h2>

<p>I use flat files and the PostgreSQL relational database for most data storage and processing needs in my consulting business over the last twenty years. For work on large data projects at Compass Labs and Google I used Hadoop and Big Table. I will not cover big data datastores here, rather I will concentrate on what I think of as “laptop development” requirements: a modest amount of data and optimizing speed of development and ease of infrastructure setup. We will cover three datastores:</p>

<ul>
  <li>Sqlite single-file-based relational database</li>
  <li>PostgreSQL relational database</li>
  <li>RDF library <strong>rdflib</strong> that is useful for semantic web and linked data applications</li>
</ul>

<p>For graph data we will stick with RDF because it is a fairly widely used standard. Google, Microsoft, Yahoo and Yandex support <a href="https://schema.org/">schema.org</a> for defining schemas for structured data on the web. In the next chapter we will go into more details on RDF, here we look at the “plumbing” for using the <strong>rdflib</strong> library to manipulate and query RDF data and how to export RDF data in several formats. Then in a later chapter, we will develop tools to automatically generate RDF data from raw text as a tool for developing customized Knowledge Graphs.</p>

<p>In one of my previous previous books <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, or the Savvy Programmer’s Secret Weapon</a> I also covered the general purpose graph database Neo4j which I like to use for some use cases, but for the purposes of this book we stick with RDF.</p>

<h3 id="leanpub-auto-sqlite">Sqlite</h3>

<p>We will cover two relational databases: Sqlite and PostgreSQL. Sqlite is an embedded database. There are Sqlite libraries for many programming languages and here we use the Python library.</p>

<p>The following examples are simple but sufficient to show you how to open a single file Sqlite database, add data, modify data, query data, and delete data. I assume that you have some familiarity with relational databases, especially concepts like data columns and rows, and SQL queries.</p>

<p>Let’s start with putting common code for using Sqlite into a reusable library in the file <strong>sqlite_lib.hy</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">sqlite3</code> <code class="p">[</code><code class="nv">connect</code> <code class="nv">version</code> <code class="nv">Error</code> <code class="p">]])</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">create-db</code> <code class="p">[</code><code class="nv">db-file-path</code><code class="p">]</code> <code class="c1">;; db-file-path can also be ":memory:"</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">conn</code> <code class="p">(</code><code class="nf">connect</code> <code class="nv">db-file-path</code><code class="p">))</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="nb">print</code> <code class="nv">version</code><code class="p">)</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="nf">conn.close</code><code class="p">))</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">connection</code> <code class="p">[</code><code class="nv">db-file-path</code><code class="p">]</code> <code class="c1">;; db-file-path can also be ":memory:"</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="nf">connect</code> <code class="nv">db-file-path</code><code class="p">))</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">query</code> <code class="p">[</code><code class="nv">conn</code> <code class="nv">sql</code> <code class="o">&amp;</code><code class="nv">optional</code> <code class="nv">variable-bindings</code><code class="p">]</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">cur</code> <code class="p">(</code><code class="nf">conn.cursor</code><code class="p">))</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="k">if</code> <code class="nv">variable-bindings</code>
<code class="linenos">14 </code>    <code class="p">(</code><code class="nf">cur.execute</code> <code class="nv">sql</code> <code class="nv">variable-bindings</code><code class="p">)</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nf">cur.execute</code> <code class="nv">sql</code><code class="p">))</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="nf">cur.fetchall</code><code class="p">))</code>
</pre></div>

</figure>

<p>The function <strong>create-db</strong> in lines 3-6 creates a database from a file path if it does not already exist. The function <strong>connection</strong> (lines 8-9) creates a persistent connection to a database defined by a file path to the single file used for a Sqlite database. This connection can be reused.  The function <strong>query</strong> (lines 11-16) requires a connection object and a SQL query represented as a string, makes a database query, and returns all matching data in nested lists.</p>

<p>The following listing of file <strong>sqlite_example.hy</strong>shows how to use this simple library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">sqlite-lib</code> <code class="p">[</code><code class="nv">create-db</code> <code class="nv">connection</code> <code class="nv">query</code><code class="p">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">test_sqlite-lib</code> <code class="p">[]</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">dbpath</code> <code class="s">":memory:"</code><code class="p">)</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="nf">create-db</code> <code class="nv">dbpath</code><code class="p">)</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">conn</code> <code class="p">(</code><code class="nf">connection</code> <code class="s">":memory:"</code><code class="p">))</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"CREATE TABLE people (name TEXT, email TEXT);"</code><code class="p">)</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"INSERT INTO people VALUES ('Mark', 'mark@markwatson.com')"</code><code class="p">))</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"INSERT INTO people VALUES ('Kiddo', 'kiddo@markwatson.com')"</code><code class="p">))</code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"SELECT * FROM people"</code><code class="p">))</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"UPDATE people SET name = ? WHERE email = ?"</code>
<code class="linenos">18 </code>      <code class="p">[</code><code class="s">"Mark Watson"</code> <code class="s">"mark@markwatson.com"</code><code class="p">]))</code>
<code class="linenos">19 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">20 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"SELECT * FROM people"</code><code class="p">))</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="nb">print</code>
<code class="linenos">22 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"DELETE FROM people  WHERE name=?"</code> <code class="p">[</code><code class="s">"Kiddo"</code><code class="p">]))</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="nb">print</code>
<code class="linenos">24 </code>    <code class="p">(</code><code class="nf">query</code> <code class="nv">conn</code> <code class="s">"SELECT * FROM people"</code><code class="p">))</code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="nf">conn.close</code><code class="p">))</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="p">(</code><code class="nf">test_sqlite-lib</code><code class="p">)</code>
</pre></div>

</figure>

<p>We opened an in-memory database in lines 7 and 8 but we could have also created a persistent database on disk using, for example, “test_database.db” instead of <strong>:memory</strong>. In line 9 we create a database table with just two columns, each column holding string values.</p>

<p>In lines 15, 20, and 24 we are using a wild card query using the asterisk character to return all column values for each matched row in the database.</p>

<p>Running the example program produces the following output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ ./sqlite_example.hy
<code class="linenos">2 </code><code class="m">2</code>.6.0
<code class="linenos">3 </code><code class="o">[]</code>
<code class="linenos">4 </code><code class="o">[]</code>
<code class="linenos">5 </code><code class="o">[(</code><code class="s1">'Mark'</code>, <code class="s1">'mark@markwatson.com'</code><code class="o">)</code>, <code class="o">(</code><code class="s1">'Kiddo'</code>, <code class="s1">'kiddo@markwatson.com'</code><code class="o">)]</code>
<code class="linenos">6 </code><code class="o">[]</code>
<code class="linenos">7 </code><code class="o">[(</code><code class="s1">'Mark Watson'</code>, <code class="s1">'mark@markwatson.com'</code><code class="o">)</code>, <code class="o">(</code><code class="s1">'Kiddo'</code>, <code class="s1">'kiddo@markwatson.com'</code><code class="o">)]</code>
<code class="linenos">8 </code><code class="o">[]</code>
<code class="linenos">9 </code><code class="o">[(</code><code class="s1">'Mark Watson'</code>, <code class="s1">'mark@markwatson.com'</code><code class="o">)]</code>
</pre></div>

</figure>

<p>Line 2 shows the version of SQlist we are using. The lists in lines 1-2, 4, and 6 are empty because the functions to create a table, insert data into a table, update a row in a table, and delete rows do not return values.</p>

<p>In the next section we will see how PostgreSQL treats JSON data as a native data type. For sqlite, you can store JSON data as a “dumped” string value but you can’t query by key/value pairs in the data. You can encode JSON as a string and then decode it back to JSON (or as a dictionary) using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">json</code> <code class="p">[</code><code class="nv">dumps</code> <code class="nv">loads</code><code class="p">]])</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">json-data</code> <code class="nv">.....</code><code class="p">)</code>
<code class="linenos">4 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">s-data</code> <code class="p">(</code><code class="nf">json.dumps</code> <code class="nv">json-data</code><code class="p">))</code>
<code class="linenos">5 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">restored-json-data</code> <code class="p">(</code><code class="nf">json.loads</code> <code class="nv">s-data</code><code class="p">))</code>
</pre></div>

</figure>

<h3 id="leanpub-auto-postgresql">PostgreSQL</h3>

<p>We just saw use cases for the Sqlite embedded database. Now we look at my favorite general purpose database, PostgreSQL. The PostgreSQL database server is available as a managed service on most cloud providers and it is easy to also run a PostgreSQL server on your laptop or on a VPS or server.</p>

<p>We will use the <a href="http://initd.org/psycopg/">psycopg</a> PostgreSQL adapter that is compatible with CPython and can be installed using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">pip</code> <code class="nv">install</code> <code class="nv">psycopg2</code>
</pre></div>

</figure>

<p>The following material is self-contained but before using PostgreSQL and psycopg in your own applications I recommend that you reference the psycopg documentation.</p>

<h4 id="leanpub-auto-notes-for-using-postgresql-and-setting-up-an-example-database-hybook-on-macos-and-linux">Notes for Using PostgreSQL and Setting Up an Example Database “hybook” on macOS and Linux</h4>

<p>The following two sections may help you get PostgreSQL set up on macOS and Linux.</p>

<h5 id="leanpub-auto-macos">macOS</h5>

<p>For macOS we use the PostgreSQL application and we will start by using the <strong>postgres</strong> command line utility to create a new database and table in this database. Using <strong>postgres</strong> account, create a new database <strong>hybook</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">Marks</code><code class="o">-</code><code class="n">MacBook</code><code class="p">:</code><code class="n">datastores</code> <code class="err">$</code> <code class="n">psql</code> <code class="o">-</code><code class="n">d</code> <code class="ss">"postgres"</code>
<code class="linenos"> 2 </code><code class="n">psql</code> <code class="p">(</code><code class="mi">9</code><code class="p">.</code><code class="mi">6</code><code class="p">.</code><code class="mi">3</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="k">Type</code> <code class="ss">"help"</code> <code class="k">for</code> <code class="n">help</code><code class="p">.</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="n">postgres</code><code class="o">=#</code> <code class="err">\</code><code class="n">d</code>
<code class="linenos"> 6 </code><code class="k">No</code> <code class="n">relations</code> <code class="k">found</code><code class="p">.</code>
<code class="linenos"> 7 </code><code class="n">postgres</code><code class="o">=#</code> <code class="k">CREATE</code> <code class="k">DATABASE</code> <code class="n">hybook</code><code class="p">;</code>
<code class="linenos"> 8 </code><code class="k">CREATE</code> <code class="k">DATABASE</code>
<code class="linenos"> 9 </code><code class="n">postgres</code><code class="o">=#</code> <code class="err">\</code><code class="n">q</code>
<code class="linenos">10 </code><code class="n">Marks</code><code class="o">-</code><code class="n">MacBook</code><code class="p">:</code><code class="n">datastores</code> <code class="err">$</code> 
</pre></div>

</figure>

<p>Create a table <strong>news</strong> in database <strong>hybook</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">markw</code> <code class="err">$</code> <code class="n">psql</code> <code class="o">-</code><code class="n">d</code> <code class="ss">"hybook"</code>
<code class="linenos">2 </code><code class="n">psql</code> <code class="p">(</code><code class="mi">9</code><code class="p">.</code><code class="mi">6</code><code class="p">.</code><code class="mi">3</code><code class="p">)</code>
<code class="linenos">3 </code><code class="k">Type</code> <code class="ss">"help"</code> <code class="k">for</code> <code class="n">help</code><code class="p">.</code>
<code class="linenos">4 </code>
<code class="linenos">5 </code><code class="n">hybook</code><code class="o">=#</code> <code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">news</code> <code class="p">(</code><code class="n">uri</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">50</code><code class="p">)</code> <code class="k">not</code> <code class="k">null</code><code class="p">,</code> <code class="n">title</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">50</code><code class="p">),</code> <code class="n">articletext</code><code class="err">\</code>
<code class="linenos">6 </code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">500</code><code class="p">),</code> <code class="n">nlpdata</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">50</code><code class="p">));</code> 
<code class="linenos">7 </code><code class="k">CREATE</code> <code class="k">TABLE</code>
<code class="linenos">8 </code><code class="n">hybook</code><code class="o">=#</code> 
</pre></div>

</figure>

<h5 id="leanpub-auto-linux">Linux</h5>

<p>For <strong>Ubuntu</strong> <strong>Linux</strong> first install PostgreSQL and then use <strong>sudo</strong> to use the account <strong>postgres</strong>:</p>

<p>To start a local server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>sudo su - postgres
<code class="linenos">2 </code>/usr/lib/postgresql/10/bin/pg_ctl -D /var/lib/postgresql/10/main -l logfile start
</pre></div>

</figure>

<p>and to stop the server:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>sudo su - postgres
<code class="linenos">2 </code>/usr/lib/postgresql/10/bin/pg_ctl -D /var/lib/postgresql/10/main -l logfile stop
</pre></div>

</figure>

<p>When the PostgreSQL server is running we can use the <strong>psql</strong> command line program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>sudo su - postgres
<code class="linenos"> 2 </code>psql
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code>postgres@pop-os:~$ psql -d <code class="s2">"hybook"</code>
<code class="linenos"> 5 </code>psql <code class="o">(</code><code class="m">10</code>.7 <code class="o">(</code>Ubuntu <code class="m">10</code>.7-0ubuntu0.18.10.1<code class="o">))</code>
<code class="linenos"> 6 </code>Type <code class="s2">"help"</code> <code class="k">for</code> help.
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="nv">hybook</code><code class="o">=</code><code class="c1"># CREATE TABLE news (uri VARCHAR(50) not null, title VARCHAR(50), articletext\</code>
<code class="linenos"> 9 </code> VARCHAR<code class="o">(</code><code class="m">500</code><code class="o">)</code>, nlpdata VARCHAR<code class="o">(</code><code class="m">50</code><code class="o">))</code><code class="p">;</code>
<code class="linenos">10 </code>CREATE TABLE
<code class="linenos">11 </code><code class="nv">hybook</code><code class="o">=</code><code class="c1"># \d</code>
<code class="linenos">12 </code>        List of relations
<code class="linenos">13 </code> Schema <code class="p">|</code> Name <code class="p">|</code> Type  <code class="p">|</code>  Owner   
<code class="linenos">14 </code>--------+------+-------+----------
<code class="linenos">15 </code> public <code class="p">|</code> news <code class="p">|</code> table <code class="p">|</code> postgres
<code class="linenos">16 </code><code class="o">(</code><code class="m">1</code> row<code class="o">)</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-using-hy-with-postgresql">Using Hy with PostgreSQL</h4>

<p>When using Hy (or any other Lisp language and also for Haskell), I usually start both coding and experimenting with new libraries and APIs in a REPL. Let’s do that here to see from a high level how we can use psycopg on the table <strong>news</strong> in the database <strong>hybook</strong> that we created in the last section:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">Marks</code><code class="o">-</code><code class="nl">MacBook:</code><code class="n">datastores</code> <code class="n">$</code> <code class="n">hy</code>
<code class="linenos"> 2 </code><code class="n">hy</code> <code class="mf">0.17</code><code class="o">.</code><code class="mi">0</code><code class="o">+</code><code class="mi">108</code><code class="o">.</code><code class="na">g919a77e</code> <code class="n">using</code> <code class="n">CPython</code><code class="o">(</code><code class="k">default</code><code class="o">)</code> <code class="mf">3.7</code><code class="o">.</code><code class="mi">3</code> <code class="n">on</code> <code class="n">Darwin</code>
<code class="linenos"> 3 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="nn">json</code> <code class="n">psycopg2</code><code class="o">)</code>
<code class="linenos"> 4 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">conn</code> <code class="o">(</code><code class="n">psycopg2</code><code class="o">.</code><code class="na">connect</code> <code class="o">:</code><code class="n">dbname</code> <code class="s">"hybook"</code> <code class="o">:</code><code class="n">user</code> <code class="s">"markw"</code><code class="o">))</code>
<code class="linenos"> 5 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">cur</code> <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">cursor</code><code class="o">))</code>
<code class="linenos"> 6 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">cur</code><code class="o">.</code><code class="na">execute</code> <code class="s">"INSERT INTO news VALUES (%s, %s, %s, %s)"</code>
<code class="linenos"> 7 </code>      <code class="o">[</code><code class="s">"http://knowledgebooks.com/schema"</code> <code class="s">"test schema"</code>
<code class="linenos"> 8 </code>      <code class="s">"text in article"</code> <code class="o">(</code><code class="n">json</code><code class="o">.</code><code class="na">dumps</code> <code class="o">{</code><code class="s">"type"</code> <code class="s">"news"</code><code class="o">})])</code>
<code class="linenos"> 9 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">commit</code><code class="o">)</code>
<code class="linenos">10 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">cur</code><code class="o">.</code><code class="na">execute</code> <code class="s">"SELECT * FROM news"</code><code class="o">)</code>
<code class="linenos">11 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[</code><code class="n">record</code> <code class="n">cur</code><code class="o">]</code>
<code class="linenos">12 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="n">record</code><code class="o">))</code>
<code class="linenos">13 </code><code class="o">(</code><code class="err">'</code><code class="nl">http:</code><code class="c1">//knowledgebooks.com/schema', 'test schema', 'text in article',</code>
<code class="linenos">14 </code> <code class="err">'</code><code class="o">{</code><code class="s">"type"</code><code class="o">:</code> <code class="s">"news"</code><code class="o">}</code><code class="err">'</code><code class="o">)</code>
<code class="linenos">15 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">cur</code><code class="o">.</code><code class="na">execute</code> <code class="s">"SELECT nlpdata FROM news"</code><code class="o">)</code>
<code class="linenos">16 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[</code><code class="n">record</code> <code class="n">cur</code><code class="o">]</code>
<code class="linenos">17 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="n">record</code><code class="o">))</code>
<code class="linenos">18 </code><code class="o">(</code><code class="err">'</code><code class="o">{</code><code class="s">"type"</code><code class="o">:</code> <code class="s">"news"</code><code class="o">}</code><code class="err">'</code><code class="o">,)</code>
<code class="linenos">19 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">cur</code><code class="o">.</code><code class="na">execute</code> <code class="s">"SELECT nlpdata FROM news"</code><code class="o">)</code>
<code class="linenos">20 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[</code><code class="n">record</code> <code class="n">cur</code><code class="o">]</code>
<code class="linenos">21 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="o">(</code><code class="n">json</code><code class="o">.</code><code class="na">loads</code> <code class="o">(</code><code class="n">first</code> <code class="n">record</code><code class="o">))))</code>
<code class="linenos">22 </code><code class="o">{</code><code class="err">'</code><code class="n">type</code><code class="err">'</code><code class="o">:</code> <code class="err">'</code><code class="n">news</code><code class="err">'</code><code class="o">}</code>
<code class="linenos">23 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>In lines 6-8 and 13-14 you notice that I am using PostgreSQL’s native JSON support.</p>

<p>As with most of the material in this book, I hope that you have a Hy REPL open and are experimenting with the APIs and code in the book’s interactive REPL examples.</p>

<p>The file <strong>postgres_lib.hy</strong> wraps commonly used functionality for accessing a database, adding, modifying, and querying data in a short reusable library:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">(</code><code class="kn">import</code> <code class="err">[</code><code class="nn">psycopg2</code> <code class="o">[</code><code class="nb">connect</code><code class="o">]])</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">(</code><code class="n">defn</code> <code class="n">connection</code><code class="o">-</code><code class="n">and</code><code class="o">-</code><code class="n">cursor</code> <code class="o">[</code><code class="n">dbname</code> <code class="n">username</code><code class="o">]</code>
<code class="linenos"> 4 </code>  <code class="o">(</code><code class="n">setv</code> <code class="n">conn</code> <code class="o">(</code><code class="nb">connect</code> <code class="o">:</code><code class="n">dbname</code> <code class="n">dbname</code> <code class="o">:</code><code class="n">user</code> <code class="n">username</code><code class="o">))</code>
<code class="linenos"> 5 </code>  <code class="o">(</code><code class="n">setv</code> <code class="n">cursor</code> <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">cursor</code><code class="o">))</code>
<code class="linenos"> 6 </code>  <code class="o">[</code><code class="n">conn</code> <code class="n">cursor</code><code class="o">])</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="o">(</code><code class="n">defn</code> <code class="n">query</code> <code class="o">[</code><code class="n">cursor</code> <code class="n">sql</code> <code class="o">&amp;</code><code class="n">optional</code> <code class="n">variable</code><code class="o">-</code><code class="n">bindings</code><code class="o">]</code>
<code class="linenos"> 9 </code>  <code class="o">(</code><code class="k">if</code> <code class="n">variable</code><code class="o">-</code><code class="n">bindings</code>
<code class="linenos">10 </code>    <code class="o">(</code><code class="n">cursor</code><code class="o">.</code><code class="na">execute</code> <code class="n">sql</code> <code class="n">variable</code><code class="o">-</code><code class="n">bindings</code><code class="o">)</code>
<code class="linenos">11 </code>    <code class="o">(</code><code class="n">cursor</code><code class="o">.</code><code class="na">execute</code> <code class="n">sql</code><code class="o">)))</code>
</pre></div>

</figure>

<p>The function <strong>query</strong> in lines 8-11 executes any SQL comands so in addition to querying a database, it can also be used with appropriate SQL commands to delete rows, update rows, and create and destroy tables.</p>

<p>The following file <strong>postgres_example.hy</strong> contains examples for using the library we just defined:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="err">#</code><code class="o">!/</code><code class="n">usr</code><code class="o">/</code><code class="n">bin</code><code class="o">/</code><code class="nb">env</code> <code class="n">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="o">(</code><code class="kn">import</code> <code class="err">[</code><code class="nn">postgres</code><code class="o">-</code><code class="n">lib</code> <code class="o">[</code><code class="n">connection</code><code class="o">-</code><code class="n">and</code><code class="o">-</code><code class="n">cursor</code> <code class="n">query</code><code class="o">]])</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="o">(</code><code class="n">defn</code> <code class="n">test</code><code class="o">-</code><code class="n">postgres</code><code class="o">-</code><code class="n">lib</code> <code class="o">[]</code>
<code class="linenos"> 6 </code>  <code class="o">(</code><code class="n">setv</code> <code class="o">[</code><code class="n">conn</code> <code class="n">cursor</code><code class="o">]</code> <code class="o">(</code><code class="n">connection</code><code class="o">-</code><code class="n">and</code><code class="o">-</code><code class="n">cursor</code> <code class="s">"hybook"</code> <code class="s">"markw"</code><code class="o">))</code>
<code class="linenos"> 7 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"CREATE TABLE people (name TEXT, email TEXT);"</code><code class="o">)</code>
<code class="linenos"> 8 </code>  <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">commit</code><code class="o">)</code>
<code class="linenos"> 9 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"INSERT INTO people VALUES ('Mark', 'mark@markwatson.com')"</code><code class="o">)</code>
<code class="linenos">10 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"INSERT INTO people VALUES ('Kiddo', 'kiddo@markwatson.com')"</code><code class="o">)</code>
<code class="linenos">11 </code>  <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">commit</code><code class="o">)</code>
<code class="linenos">12 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"SELECT * FROM people"</code><code class="o">)</code>
<code class="linenos">13 </code>  <code class="o">(</code><code class="nb">print</code> <code class="o">(</code><code class="n">cursor</code><code class="o">.</code><code class="na">fetchall</code><code class="o">))</code>
<code class="linenos">14 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"UPDATE people SET name = %s WHERE email = %s"</code>
<code class="linenos">15 </code>      <code class="o">[</code><code class="s">"Mark Watson"</code> <code class="s">"mark@markwatson.com"</code><code class="o">])</code>
<code class="linenos">16 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"SELECT * FROM people"</code><code class="o">)</code>
<code class="linenos">17 </code>  <code class="o">(</code><code class="nb">print</code> <code class="o">(</code><code class="n">cursor</code><code class="o">.</code><code class="na">fetchall</code><code class="o">))</code>
<code class="linenos">18 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"DELETE FROM people  WHERE name = %s"</code> <code class="o">[</code><code class="s">"Kiddo"</code><code class="o">])</code>
<code class="linenos">19 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"SELECT * FROM people"</code><code class="o">)</code>
<code class="linenos">20 </code>  <code class="o">(</code><code class="nb">print</code> <code class="o">(</code><code class="n">cursor</code><code class="o">.</code><code class="na">fetchall</code><code class="o">))</code>
<code class="linenos">21 </code>  <code class="o">(</code><code class="n">query</code> <code class="n">cursor</code> <code class="s">"DROP TABLE people;"</code><code class="o">)</code>
<code class="linenos">22 </code>  <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">commit</code><code class="o">)</code>
<code class="linenos">23 </code>  <code class="o">(</code><code class="n">conn</code><code class="o">.</code><code class="na">close</code><code class="o">))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="o">(</code><code class="n">test</code><code class="o">-</code><code class="n">postgres</code><code class="o">-</code><code class="n">lib</code><code class="o">)</code>
</pre></div>

</figure>

<p>Here is the output from this example Hy script:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>Marks-MacBook:datastores $ ./postgres_example.hy
<code class="linenos">2 </code><code class="o">[(</code><code class="s1">'Mark'</code>, <code class="s1">'mark@markwatson.com'</code><code class="o">)</code>, <code class="o">(</code><code class="s1">'Kiddo'</code>, <code class="s1">'kiddo@markwatson.com'</code><code class="o">)]</code>
<code class="linenos">3 </code><code class="o">[(</code><code class="s1">'Kiddo'</code>, <code class="s1">'kiddo@markwatson.com'</code><code class="o">)</code>, <code class="o">(</code><code class="s1">'Mark Watson'</code>, <code class="s1">'mark@markwatson.com'</code><code class="o">)]</code>
<code class="linenos">4 </code><code class="o">[(</code><code class="s1">'Mark Watson'</code>, <code class="s1">'mark@markwatson.com'</code><code class="o">)]</code>
</pre></div>

</figure>

<p>I use PostgreSQL more than any other datastore and taking the time to learn how to manage PostgreSQL servers and write application software will save you time and effort when you are prototyping new ideas or developing data oriented product at work. I love using PostgreSQL and personally, I only use Sqlite for very small database tasks or applications.</p>

<h3 id="rdflibintro">RDF Data Using the “rdflib” Library</h3>

<p>While the last two sections on Sqlite and PostgreSQL provided examples that you are likely to use in your own work, we will now turn to something more esoteric but still useful, the RDF notations for using data schema and RDF triple graph data in semantic web, linked data, and Knowledge Graph applications. I used graph databases working with Google’s Knowledge Graph when I worked there and I have had several consulting projects using linked data. I currently work on the Knowledge Graph team at Olive AI. You will need to understand the material in this section for the two chapters that take a deeper dive into the semantic web and linked data and also develop an example that automatically creates Knowledge Graphs.</p>

<p>In my work I use RDF as a notation for graph data, RDFS (RDF Schema) to define formally data types and relationship types in RDF data, and occasionally OWL (Web Ontology Language) for reasoning about RDF data and inferring new graph triple data from data explicitly defined. Here we will only cover RDF since it is the most practical linked data tool and I refer you to my other semantic web books for deeper coverage of RDF as well as RDFS and OWL.</p>

<p>We will go into some detail on using semantic web and linked data resources in the next chapter. Here we will study the use of library <strong>rdflib</strong> as a data store, reading RDF data from disk and from web resources, adding RDF statements (which are triples containing a subject, predicate, and object) and for serializing an in-memory graph to a file in one of the standard RDF XML, turtle, or NT formats.</p>

<p>You need to install both the <strong>rdflib</strong> library and the plugin for using the JSON-LD format:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="nv">pip</code> <code class="nv">install</code> <code class="nv">rdflib</code>
<code class="linenos">2 </code><code class="nv">pip</code> <code class="nv">install</code> <code class="nv">rdflib-jsonld</code>
</pre></div>

</figure>

<p>The following REPL session shows importing the <strong>rdflib</strong> library, fetching RDF (in XML format) from my personal web site, printing out the triples in the graph in NT format, and showing how the graph can be queried. I added most of this RDF to my web site in 2005, with a few updates since then. The following REPL session is split up into several listings (with some long output removed) so I can explain how the <strong>rdflib</strong> is being used. In the first REPL listing I load an RDF file in XML format from my web site and print it in NT format. NT format can have either subject/predicate/object all on one line separated by spaces and terminated by a period or as shown below, the subject is on one line with predicate and objects printed indented on two additional lines. In both cases a period character “.” is used to terminate search RDF NT statement. The statements are displayed in arbitrary order.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">Marks</code><code class="o">-</code><code class="nl">MacBook:</code><code class="n">datastores</code> <code class="n">$</code> <code class="n">hy</code>
<code class="linenos"> 2 </code><code class="n">hy</code> <code class="mf">0.17</code><code class="o">.</code><code class="mi">0</code><code class="o">+</code><code class="mi">108</code><code class="o">.</code><code class="na">g919a77e</code> <code class="n">using</code> <code class="n">CPython</code><code class="o">(</code><code class="k">default</code><code class="o">)</code> <code class="mf">3.7</code><code class="o">.</code><code class="mi">3</code> <code class="n">on</code> <code class="n">Darwin</code>
<code class="linenos"> 3 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="err">[</code><code class="nn">rdflib</code> <code class="o">[</code><code class="n">Graph</code><code class="o">]])</code>
<code class="linenos"> 4 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">graph</code> <code class="o">(</code><code class="n">Graph</code><code class="o">))</code>
<code class="linenos"> 5 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">load</code> <code class="s">"http://markwatson.com/index.rdf"</code><code class="o">)</code>
<code class="linenos"> 6 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[[</code><code class="n">subject</code> <code class="n">predicate</code> <code class="n">object</code><code class="o">]</code> <code class="n">graph</code><code class="o">]</code>
<code class="linenos"> 7 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="n">subject</code> <code class="s">"\n  "</code> <code class="n">predicate</code> <code class="s">"\n  "</code> <code class="n">object</code> <code class="s">" ."</code><code class="o">))</code>
<code class="linenos"> 8 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson_consulting_services </code>
<code class="linenos"> 9 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#label </code>
<code class="linenos">10 </code>   <code class="n">Mark</code> <code class="n">Watson</code> <code class="n">Consulting</code> <code class="n">Services</code>  <code class="o">.</code>
<code class="linenos">11 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">12 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#firstName </code>
<code class="linenos">13 </code>   <code class="n">Mark</code>  <code class="o">.</code>
<code class="linenos">14 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">15 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#name </code>
<code class="linenos">16 </code>   <code class="n">Mark</code> <code class="n">Watson</code>  <code class="o">.</code>
<code class="linenos">17 </code><code class="nl">http:</code><code class="c1">//www.markwatson.com/ </code>
<code class="linenos">18 </code>   <code class="nl">http:</code><code class="c1">//purl.org/dc/elements/1.1/language </code>
<code class="linenos">19 </code>   <code class="n">en</code><code class="o">-</code><code class="n">us</code>  <code class="o">.</code>
<code class="linenos">20 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">21 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#researchTopic </code>
<code class="linenos">22 </code>   <code class="n">Semantic</code> <code class="n">Web</code>  <code class="o">.</code>
<code class="linenos">23 </code><code class="nl">http:</code><code class="c1">//www.markwatson.com/ </code>
<code class="linenos">24 </code>   <code class="nl">http:</code><code class="c1">//purl.org/dc/elements/1.1/date </code>
<code class="linenos">25 </code>   <code class="mi">2005</code><code class="o">-</code><code class="mi">7</code><code class="o">-</code><code class="mi">10</code>  <code class="o">.</code>
<code class="linenos">26 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">27 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#researchTopic </code>
<code class="linenos">28 </code>   <code class="n">RDF</code> <code class="n">and</code> <code class="n">RDF</code> <code class="n">Schema</code>  <code class="o">.</code>
<code class="linenos">29 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">30 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#researchTopic </code>
<code class="linenos">31 </code>   <code class="n">ontologies</code>  <code class="o">.</code>
<code class="linenos">32 </code><code class="nl">http:</code><code class="c1">//www.markwatson.com/ </code>
<code class="linenos">33 </code>   <code class="nl">http:</code><code class="c1">//purl.org/dc/elements/1.1/title </code>
<code class="linenos">34 </code>   <code class="n">Mark</code> <code class="n">Watson</code><code class="err">'</code><code class="n">s</code> <code class="n">Home</code> <code class="n">Page</code>  <code class="o">.</code>
<code class="linenos">35 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">36 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#mailbox </code>
<code class="linenos">37 </code>   <code class="nl">mailto:</code><code class="n">markw</code><code class="nd">@markwatson.com</code>  <code class="o">.</code>
<code class="linenos">38 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">39 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#homepage </code>
<code class="linenos">40 </code>   <code class="nl">http:</code><code class="c1">//www.markwatson.com/  .</code>
<code class="linenos">41 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">42 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#fullName </code>
<code class="linenos">43 </code>   <code class="n">Mark</code> <code class="n">Watson</code>  <code class="o">.</code>
<code class="linenos">44 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson_consulting_services </code>
<code class="linenos">45 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#name </code>
<code class="linenos">46 </code>   <code class="n">Mark</code> <code class="n">Watson</code> <code class="n">Consulting</code> <code class="n">Services</code>  <code class="o">.</code>
<code class="linenos">47 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">48 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#company </code>
<code class="linenos">49 </code>   <code class="n">Mark</code> <code class="n">Watson</code> <code class="n">Consulting</code> <code class="n">Services</code>  <code class="o">.</code>
<code class="linenos">50 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">51 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#type </code>
<code class="linenos">52 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#Person  .</code>
<code class="linenos">53 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">54 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#value </code>
<code class="linenos">55 </code>   <code class="n">Mark</code> <code class="n">Watson</code>  <code class="o">.</code>
<code class="linenos">56 </code><code class="nl">http:</code><code class="c1">//www.markwatson.com/ </code>
<code class="linenos">57 </code>   <code class="nl">http:</code><code class="c1">//purl.org/dc/elements/1.1/creator </code>
<code class="linenos">58 </code>   <code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson  .</code>
<code class="linenos">59 </code><code class="nl">http:</code><code class="c1">//www.markwatson.com/ </code>
<code class="linenos">60 </code>   <code class="nl">http:</code><code class="c1">//purl.org/dc/elements/1.1/description </code>
<code class="linenos">61 </code>   
<code class="linenos">62 </code>      <code class="n">Mark</code> <code class="n">Watson</code> <code class="n">is</code> <code class="n">the</code> <code class="n">author</code> <code class="k">of</code> <code class="mi">16</code> <code class="n">published</code> <code class="n">books</code> <code class="n">and</code> <code class="n">a</code> <code class="n">consultant</code> <code class="n">specializing</code> <code class="err">\</code>
<code class="linenos">63 </code><code class="n">in</code> <code class="n">artificial</code> <code class="n">intelligence</code> <code class="n">and</code> <code class="n">Java</code> <code class="n">technologies</code><code class="o">.</code>
<code class="linenos">64 </code>      <code class="o">.</code>
<code class="linenos">65 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">66 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#type </code>
<code class="linenos">67 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#Person  .</code>
<code class="linenos">68 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">69 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#motherTongue </code>
<code class="linenos">70 </code>   <code class="n">en</code>  <code class="o">.</code>
<code class="linenos">71 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">72 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#type </code>
<code class="linenos">73 </code>   <code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#Consultant  .</code>
<code class="linenos">74 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson_consulting_services </code>
<code class="linenos">75 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#type </code>
<code class="linenos">76 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#Organization  .</code>
<code class="linenos">77 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson </code>
<code class="linenos">78 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#label </code>
<code class="linenos">79 </code>   <code class="n">Mark</code> <code class="n">Watson</code>  <code class="o">.</code>
<code class="linenos">80 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#Sun_ONE </code>
<code class="linenos">81 </code>   <code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#type </code>
<code class="linenos">82 </code>   <code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#Book  .</code>
<code class="linenos">83 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>There are several available formats for serializing RDF data. Here we will serialize using the JSON-LD format (later we will also see examples for serializing in NT and Turtle formats):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="err">[</code><code class="nn">rdflib</code> <code class="o">[</code><code class="n">plugin</code><code class="o">]])</code>
<code class="linenos"> 2 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="err">[</code><code class="nn">rdflib.serializer</code> <code class="o">[</code><code class="n">Serializer</code><code class="o">]])</code>
<code class="linenos"> 3 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="nb">print</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">serialize</code> <code class="o">:</code><code class="n">format</code> <code class="s">"json-ld"</code> <code class="o">:</code><code class="n">indent</code> <code class="mi">2</code><code class="o">))</code>
<code class="linenos"> 4 </code><code class="o">[</code>
<code class="linenos"> 5 </code>   <code class="o">{</code>
<code class="linenos"> 6 </code>      <code class="s">"@id"</code><code class="o">:</code> <code class="s">"https://markwatson.com/index.rdf#Sun_ONE"</code><code class="o">,</code>
<code class="linenos"> 7 </code>      <code class="s">"@type"</code><code class="o">:</code> <code class="o">[</code><code class="s">"http://www.ontoweb.org/ontology/1#Book"</code> <code class="o">],</code>
<code class="linenos"> 8 </code>      <code class="s">"http://www.ontoweb.org/ontology/1#author"</code><code class="o">:</code> <code class="o">[</code>
<code class="linenos"> 9 </code>         <code class="o">{</code> <code class="s">"@id"</code><code class="o">:</code> <code class="s">"https://markwatson.com/index.rdf#mark_watson"</code> <code class="o">}</code>
<code class="linenos">10 </code>      <code class="o">],</code>
<code class="linenos">11 </code>      <code class="s">"http://www.ontoweb.org/ontology/1#booktitle"</code><code class="o">:</code> <code class="o">[</code>
<code class="linenos">12 </code>         <code class="o">{</code> <code class="s">"@value"</code><code class="o">:</code> <code class="s">"Sun ONE Services - J2EE"</code> <code class="o">}</code>
<code class="linenos">13 </code>      <code class="o">],</code>
<code class="linenos">14 </code>      
<code class="linenos">15 </code>      <code class="o">...</code>  
</pre></div>

</figure>

<p>JSON-LD is convenient for implementing APIs that are intended for use by developers who are not familiar with RDF technology.</p>

<p>We will cover the SPARQL query language in more detail in the next chapter but for now, notice that SPARQL is similar to SQL queries. SPARQL queries can find triples in a graph matching simple patterns, match complex patterns, and update and delete triples in a graph. The following simple SPARQL query finds all triples with the predicate equal to <a href="http://www.w3.org/2000/10/swap/pim/contact#company">http://www.w3.org/2000/10/swap/pim/contact#company</a> and prints out the subject and object of any matching triples:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">84 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[[</code><code class="n">subject</code> <code class="n">object</code>
<code class="linenos">85 </code><code class="o">...</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">query</code>
<code class="linenos">86 </code><code class="o">...</code>   <code class="s">"select ?s ?o where { ?s &lt;http://www.w3.org/2000/10/swap/pim/contact#company&gt; \</code>
<code class="linenos">87 </code><code class="s">?o }"</code><code class="o">)]</code>
<code class="linenos">88 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="n">subject</code> <code class="s">"\n contact company: "</code> <code class="n">object</code><code class="o">))</code>
<code class="linenos">89 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson</code>
<code class="linenos">90 </code>  <code class="n">contact</code> <code class="nl">company:</code>  <code class="n">Mark</code> <code class="n">Watson</code> <code class="n">Consulting</code> <code class="n">Services</code>
</pre></div>

</figure>

<p>We will see more examples of the SPARQL query language in the next chapter. For now, notice that the general form of a <strong>select</strong> query statement is a list of query variables (names beginning with a question mark) and a <strong>where</strong> clause in curly brackets that contains matching patterns. This SPARQL query is simple, but like SQL queries, SPARQL queries can get very complex. I only lightly cover SPARQL in this book. You can get PDF copies of my two older semantic web books for free: <a href="https://markwatson.com/opencontentdata/book_java.pdf">Practical Semantic Web and Linked Data Applications, Java, Scala, Clojure, and JRuby Edition</a> and <a href="https://markwatson.com/opencontentdata/book_lisp.pdf">Practical Semantic Web and Linked Data Applications, Common Lisp Edition</a>. There are links to relevant git repos and other information on my <a href="https://markwatson.com/books/">book web page</a>.</p>

<p>As I mentioned, the RDF data on my web site has been essentially unchanged since 2005. What if I wanted to update it noting that more recently I worked as a contractor at Google and as a Deep Learning engineering manager at Capital One? In the following listing, continuing the same REPL session, I will add two RDF statements indicating additional jobs and show how to serialize the new updated graph in three formats: XML, turtle (my favorite RDF notation) and NT:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 89 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="kn">import</code> <code class="nn">rdflib</code><code class="o">)</code>
<code class="linenos"> 90 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">mark</code><code class="o">-</code><code class="n">node</code> <code class="o">(</code><code class="n">rdflib</code><code class="o">.</code><code class="na">URIRef</code>  <code class="s">"http://markwatson.com/index.rdf#mark_watson"</code><code class="o">))</code>
<code class="linenos"> 91 </code><code class="o">=&gt;</code> <code class="n">mark</code><code class="o">-</code><code class="n">node</code>
<code class="linenos"> 92 </code><code class="n">rdflib</code><code class="o">.</code><code class="na">term</code><code class="o">.</code><code class="na">URIRef</code><code class="o">(</code><code class="err">'</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson')</code>
<code class="linenos"> 93 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">setv</code> <code class="n">company</code><code class="o">-</code><code class="n">node</code> <code class="o">(</code><code class="n">rdflib</code><code class="o">.</code><code class="na">URIRef</code> <code class="s">"http://www.w3.org/2000/10/swap/pim/contact#com\</code>
<code class="linenos"> 94 </code><code class="s">pany"</code><code class="o">))</code>
<code class="linenos"> 95 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">add</code> <code class="o">[</code><code class="n">mark</code><code class="o">-</code><code class="n">node</code> <code class="n">company</code><code class="o">-</code><code class="n">node</code> <code class="o">(</code><code class="n">rdflib</code><code class="o">.</code><code class="na">Literal</code> <code class="s">"Google"</code><code class="o">)])</code>
<code class="linenos"> 96 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">add</code> <code class="o">[</code><code class="n">mark</code><code class="o">-</code><code class="n">node</code> <code class="n">company</code><code class="o">-</code><code class="n">node</code> <code class="o">(</code><code class="n">rdflib</code><code class="o">.</code><code class="na">Literal</code> <code class="s">"Capital One"</code><code class="o">)])</code>
<code class="linenos"> 97 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="k">for</code> <code class="o">[[</code><code class="n">subject</code> <code class="n">object</code><code class="o">]</code>
<code class="linenos"> 98 </code><code class="o">...</code>       <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">query</code>
<code class="linenos"> 99 </code><code class="o">...</code>         <code class="s">"select ?s ?o where { ?s &lt;http://www.w3.org/2000/10/swap/pim/contact#com\</code>
<code class="linenos">100 </code><code class="s">pany&gt; ?o }"</code><code class="o">)]</code>
<code class="linenos">101 </code><code class="o">...</code> <code class="o">(</code><code class="nb">print</code> <code class="n">subject</code> <code class="s">" contact company: "</code> <code class="n">object</code><code class="o">))</code>
<code class="linenos">102 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson  contact company:  Mark Watson Consultin\</code>
<code class="linenos">103 </code><code class="n">g</code> <code class="n">Services</code>
<code class="linenos">104 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson  contact company:  Google</code>
<code class="linenos">105 </code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson  contact company:  Capital One</code>
<code class="linenos">106 </code><code class="o">=&gt;</code> 
<code class="linenos">107 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">serialize</code> <code class="o">:</code><code class="n">format</code> <code class="s">"pretty-xml"</code><code class="o">)</code>
<code class="linenos">108 </code><code class="o">&lt;?</code><code class="n">xml</code> <code class="n">version</code><code class="o">=</code><code class="s">"1.0"</code> <code class="n">encoding</code><code class="o">=</code><code class="s">"utf-8"</code><code class="o">?&gt;</code>
<code class="linenos">109 </code><code class="o">&lt;</code><code class="nl">rdf:</code><code class="n">RDF</code>
<code class="linenos">110 </code>  <code class="nl">xmlns:</code><code class="n">dc</code><code class="o">=</code><code class="s">"http://purl.org/dc/elements/1.1/"</code>
<code class="linenos">111 </code>  <code class="nl">xmlns:</code><code class="n">contact</code><code class="o">=</code><code class="s">"http://www.w3.org/2000/10/swap/pim/contact#"</code>
<code class="linenos">112 </code>  <code class="nl">xmlns:</code><code class="n">rdf</code><code class="o">=</code><code class="s">"http://www.w3.org/1999/02/22-rdf-syntax-ns#"</code>
<code class="linenos">113 </code>  <code class="nl">xmlns:</code><code class="n">ow</code><code class="o">=</code><code class="s">"http://www.ontoweb.org/ontology/1#"</code>
<code class="linenos">114 </code>  <code class="nl">xmlns:</code><code class="n">ns1</code><code class="o">=</code><code class="s">"http://markwatson.com/index.rdf#"</code><code class="o">&gt;</code>
<code class="linenos">115 </code>
<code class="linenos">116 </code>    <code class="n">LOTS</code> <code class="n">OF</code> <code class="n">STUFF</code> <code class="n">NOT</code> <code class="n">SHOWN</code>
<code class="linenos">117 </code>
<code class="linenos">118 </code><code class="o">&lt;/</code><code class="nl">rdf:</code><code class="n">RDF</code><code class="o">&gt;</code>
</pre></div>

</figure>

<p>I like Turtle RDF notation better than the XML notation because Turtle is easier to read and understand. Here, on line 118 we serialize the graph (with new nodes added above in lines 90 to 96) to Turtle:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">118 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">serialize</code> <code class="o">:</code><code class="n">format</code> <code class="s">"turtle"</code><code class="o">)</code>
<code class="linenos">119 </code><code class="nd">@prefix</code> <code class="nl">contact:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#&gt; .</code>
<code class="linenos">120 </code><code class="nd">@prefix</code> <code class="nl">dc:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//purl.org/dc/elements/1.1/&gt; .</code>
<code class="linenos">121 </code><code class="nd">@prefix</code> <code class="nl">ns1:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#&gt; .</code>
<code class="linenos">122 </code><code class="nd">@prefix</code> <code class="nl">ow:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.ontoweb.org/ontology/1#&gt; .</code>
<code class="linenos">123 </code><code class="nd">@prefix</code> <code class="nl">rdf:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .</code>
<code class="linenos">124 </code><code class="nd">@prefix</code> <code class="nl">rdfs:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.w3.org/2000/01/rdf-schema#&gt; .</code>
<code class="linenos">125 </code><code class="nd">@prefix</code> <code class="nl">xml:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.w3.org/XML/1998/namespace&gt; .</code>
<code class="linenos">126 </code><code class="nd">@prefix</code> <code class="nl">xsd:</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.w3.org/2001/XMLSchema#&gt; .</code>
<code class="linenos">127 </code>
<code class="linenos">128 </code><code class="nl">ns1:</code><code class="n">mark_watson_consulting_services</code> <code class="n">a</code> <code class="nl">ow:</code><code class="n">Organization</code> <code class="o">;</code>
<code class="linenos">129 </code>    <code class="nl">ow:</code><code class="n">name</code> <code class="s">"Mark Watson Consulting Services"</code> <code class="o">;</code>
<code class="linenos">130 </code>    <code class="nl">rdf:</code><code class="n">label</code> <code class="s">"Mark Watson Consulting Services"</code> <code class="o">.</code>
<code class="linenos">131 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.markwatson.com/&gt; </code>
<code class="linenos">132 </code>    <code class="nl">dc:</code><code class="n">creator</code> <code class="nl">ns1:</code><code class="n">mark_watson</code> <code class="o">;</code>
<code class="linenos">133 </code>    <code class="nl">dc:</code><code class="n">date</code> <code class="s">"2005-7-10"</code> <code class="o">;</code>
<code class="linenos">134 </code>    <code class="nl">dc:</code><code class="n">description</code> 
<code class="linenos">135 </code>          <code class="s">"Mark Watson is the author of 16 published books and a consultant</code>
<code class="linenos">136 </code><code class="s">          specializing in artificial intelligence and Java technologies."</code> <code class="o">;</code>
<code class="linenos">137 </code>     <code class="nl">dc:</code><code class="n">format</code> <code class="s">"text/html"</code> <code class="o">;</code>
<code class="linenos">138 </code>     <code class="nl">dc:</code><code class="n">language</code> <code class="s">"en-us"</code> <code class="o">;</code>
<code class="linenos">139 </code>     <code class="nl">dc:</code><code class="n">title</code> <code class="s">"Mark Watson\'s Home Page"</code> <code class="o">;</code>
<code class="linenos">140 </code>     <code class="nl">dc:</code><code class="n">type</code> <code class="s">"Consultant Homepage"</code> <code class="o">.</code>
<code class="linenos">141 </code><code class="nl">ns1:</code><code class="n">mark_watson</code> <code class="n">a</code> <code class="nl">ns1:</code><code class="n">Consultant</code><code class="o">,</code>
<code class="linenos">142 </code>                  <code class="nl">ow:</code><code class="n">Person</code><code class="o">,</code>
<code class="linenos">143 </code>                  <code class="nl">contact:</code><code class="n">Person</code> <code class="o">;</code>
<code class="linenos">144 </code>                <code class="nl">ow:</code><code class="n">name</code> <code class="s">"Mark Watson"</code> <code class="o">;</code>
<code class="linenos">145 </code>                <code class="nl">ow:</code><code class="n">researchTopic</code> <code class="s">"RDF and RDF Schema"</code><code class="o">,</code>
<code class="linenos">146 </code>                                 <code class="s">"Semantic Web"</code><code class="o">,</code>
<code class="linenos">147 </code>                                 <code class="s">"ontologies"</code> <code class="o">;</code>
<code class="linenos">148 </code>                <code class="nl">rdf:</code><code class="n">label</code> <code class="s">"Mark Watson"</code> <code class="o">;</code>
<code class="linenos">149 </code>                <code class="nl">rdf:</code><code class="n">value</code> <code class="s">"Mark Watson"</code> <code class="o">;</code>
<code class="linenos">150 </code>                <code class="nl">contact:</code><code class="n">company</code> <code class="s">"Capital One"</code><code class="o">,</code>
<code class="linenos">151 </code>                                <code class="s">"Google"</code><code class="o">,</code>
<code class="linenos">152 </code>                                <code class="s">"Mark Watson Consulting Services"</code> <code class="o">;</code>
<code class="linenos">153 </code>                <code class="nl">contact:</code><code class="n">familyName</code> <code class="s">"Watson"</code> <code class="o">;</code>
<code class="linenos">154 </code>                <code class="nl">contact:</code><code class="n">firstName</code> <code class="s">"Mark"</code> <code class="o">;</code>
<code class="linenos">155 </code>                <code class="nl">contact:</code><code class="n">fullName</code> <code class="s">"Mark Watson"</code> <code class="o">;</code>
<code class="linenos">156 </code>                <code class="nl">contact:</code><code class="n">homepage</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.markwatson.com/&gt; ;</code>
<code class="linenos">157 </code>                <code class="nl">contact:</code><code class="n">mailbox</code> <code class="o">&lt;</code><code class="nl">mailto:</code><code class="n">markw</code><code class="nd">@markwatson.com</code><code class="o">&gt;</code> <code class="o">;</code>
<code class="linenos">158 </code>                <code class="nl">contact:</code><code class="n">motherTongue</code> <code class="s">"en"</code> <code class="o">.</code>
</pre></div>

</figure>

<p>In addition to the Turtle format I also use the simpler NT format that puts URI prefixes inline and unlike Turtle does not use prefix abrieviations. Here in line 159 we serialize to NT format:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">159 </code><code class="o">=&gt;</code> <code class="o">(</code><code class="n">graph</code><code class="o">.</code><code class="na">serialize</code> <code class="o">:</code><code class="n">format</code> <code class="s">"nt"</code><code class="o">)</code>
<code class="linenos">160 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#Sun_ONE&gt; &lt;http://www.ontoweb.org/ontology/1#booktit\</code>
<code class="linenos">161 </code><code class="n">le</code><code class="o">&gt;</code> <code class="s">"Sun ONE Services - J2EE"</code> <code class="o">.</code>
<code class="linenos">162 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.markwatson.com/&gt; &lt;http://purl.org/dc/elements/1.1/language&gt; "en-us" .</code>
<code class="linenos">163 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#Sun_ONE&gt; &lt;http://www.ontoweb.org/ontology/1#author&gt;\</code>
<code class="linenos">164 </code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson&gt; .</code>
<code class="linenos">165 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.markwatson.com/&gt; &lt;http://purl.org/dc/elements/1.1/date&gt; "2005-7-10" .</code>
<code class="linenos">166 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.ontoweb.org/ontology/1#res\</code>
<code class="linenos">167 </code><code class="n">earchTopic</code><code class="o">&gt;</code> <code class="s">"ontologies"</code> <code class="o">.</code>
<code class="linenos">168 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.markwatson.com/&gt; &lt;http://purl.org/dc/elements/1.1/type&gt; "Consultant Home\</code>
<code class="linenos">169 </code><code class="n">page</code><code class="s">" .</code>
<code class="linenos">170 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.w3.org/2000/10/swap/pim/co\</code>
<code class="linenos">171 </code><code class="s">ntact#homepage&gt; &lt;http://www.markwatson.com/&gt; .</code>
<code class="linenos">172 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.w3.org/2000/10/swap/pim/co\</code>
<code class="linenos">173 </code><code class="s">ntact#company&gt; "</code><code class="n">Google</code><code class="s">" .</code>
<code class="linenos">174 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.w3.org/2000/10/swap/pim/co\</code>
<code class="linenos">175 </code><code class="s">ntact#company&gt; "</code><code class="n">Capital</code> <code class="n">One</code><code class="s">" .</code>
<code class="linenos">176 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.ontoweb.org/ontology/1#res\</code>
<code class="linenos">177 </code><code class="s">earchTopic&gt; "</code><code class="n">Semantic</code> <code class="n">Web</code><code class="s">" .</code>
<code class="linenos">178 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.ontoweb.org/ontology/1#res\</code>
<code class="linenos">179 </code><code class="s">earchTopic&gt; "</code><code class="n">RDF</code> <code class="n">and</code> <code class="n">RDF</code> <code class="n">Schema</code><code class="s">" .</code>
<code class="linenos">180 </code><code class="s">&lt;http://www.markwatson.com/&gt; &lt;http://purl.org/dc/elements/1.1/title&gt; "</code><code class="n">Mark</code> <code class="n">Watson</code><code class="err">\'</code><code class="n">s</code><code class="err">\</code>
<code class="linenos">181 </code> <code class="n">Home</code> <code class="n">Page</code><code class="s">" .</code>
<code class="linenos">182 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.w3.org/2000/10/swap/pim/co\</code>
<code class="linenos">183 </code><code class="s">ntact#mailbox&gt; &lt;mailto:markw@markwatson.com&gt; .</code>
<code class="linenos">184 </code><code class="s">&lt;http://www.markwatson.com/&gt; &lt;http://purl.org/dc/elements/1.1/format&gt; "</code><code class="n">text</code><code class="o">/</code><code class="n">html</code><code class="s">" .</code>
<code class="linenos">185 </code><code class="s">&lt;http://markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.w3.org/2000/10/swap/pim/co\</code>
<code class="linenos">186 </code><code class="s">ntact#fullName&gt; "</code><code class="n">Mark</code> <code class="n">Watson</code><code class="err">"</code> <code class="o">.</code>
<code class="linenos">187 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//markwatson.com/index.rdf#mark_watson&gt; &lt;http://www.w3.org/1999/02/22-rdf-synt\</code>
<code class="linenos">188 </code><code class="n">ax</code><code class="o">-</code><code class="n">ns</code><code class="err">#</code><code class="n">type</code><code class="o">&gt;</code> <code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.w3.org/2000/10/swap/pim/contact#Person&gt; .</code>
<code class="linenos">189 </code><code class="o">&lt;</code><code class="nl">http:</code><code class="c1">//www.markwatson.com/&gt; &lt;http://purl.org/dc/elements/1.1/creator&gt; &lt;http://markw\</code>
<code class="linenos">190 </code><code class="n">atson</code><code class="o">.</code><code class="na">com</code><code class="o">/</code><code class="n">index</code><code class="o">.</code><code class="na">rdf</code><code class="err">#</code><code class="n">mark_watson</code><code class="o">&gt;</code> <code class="o">.</code>
<code class="linenos">191 </code>
<code class="linenos">192 </code>      <code class="n">LOTS</code> <code class="n">OF</code> <code class="n">STUFF</code> <code class="n">NOT</code> <code class="n">SHOWN</code>
<code class="linenos">193 </code><code class="o">=&gt;</code> 
</pre></div>

</figure>

<p>Using RDFLIB with in-memoery RDF triple storage is very convenient with small or mid-size RDF data sets as long as initializing the data store by reading a local file containing RDF triples is a fast operation. If I need to use large RDF data sets I prefer to not use rdflib and instead use SPARQL to access a free or open source standalone RDF data store like <a href="https://en.wikipedia.org/wiki/Virtuoso_Universal_Server">OpenLink Virtuoso</a> or <a href="https://www.ontotext.com/products/graphdb/graphdb-free/">GraphDB™ Free Edition</a>. I also like and recommend the commercial AllegroGraph and Stardog RDF server products.</p>

<h3 id="leanpub-auto-wrap-up-3">Wrap-up</h3>

<p>We will go into much more detail on practical uses of RDF and SPARQL in the next chapter. I hope that you worked through the REPL examples in this section because if you understand the basics of using the <strong>rdflib</strong> then you will have an easier time understanding the more abstract material in the next chapter.</p>


<h2 id="leanpub-auto-linked-data-the-semantic-web-and-knowledge-graphs">Linked Data, the Semantic Web, and Knowledge Graphs</h2>

<p>Tim Berners Lee, James Hendler, and Ora Lassila wrote in 2001 an article for Scientific American where they introduced the term Semantic Web. Here I do not capitalize semantic web and use the similar term linked data somewhat interchangeably with semantic web. Most work using these technologies now is building corporate Knowledge Graphs. I currently work on the Knowledge Graph team at <a href="https://oliveai.com">Olive AI</a>.</p>

<p>I assume that you read the section <a href="#rdflibintro">RDF Data Using the “rdflib” Library</a> in the last chapter.</p>

<p>In the same way that the web allows links between related web pages, linked data supports linking associated data on the web together. I view linked data as a relatively simple way to specify relationships between data sources on the web while the semantic web has a much larger vision: the semantic web has the potential to be the entirety of human knowledge represented as data on the web in a form that software agents can work with to answer questions, perform research, and to infer new data from existing data.</p>

<p>While the “web” describes information for human readers, the semantic web is meant to provide structured data for ingestion by software agents. This distinction will be clear as we compare WikiPedia, made for human readers, with DBPedia which uses the info boxes on WikiPedia topics to automatically extract RDF data describing WikiPedia topics. Let’s look at the WikiPedia topic for the town I live in, Sedona Arizona, and show how the info box on the English version of the <a href="https://en.wikipedia.org/wiki/Sedona,_Arizona">WikiPedia topic page for Sedona https://en.wikipedia.org/wiki/Sedona,_Arizona</a> maps to the <a href="http://dbpedia.org/page/Sedona,_Arizona">DBPedia page http://dbpedia.org/page/Sedona,_Arizona</a>. Please open both of these WikiPedia and DBPedia URIs in two browser tabs and keep them open for reference.</p>

<p>I assume that the format of the WikiPedia page is familiar so let’s look at the DBPedia page for Sedona that in human readable form shows the RDF statements with Sedona Arizona as the subject. RDF is used to model and represent data. RDF is defined by three values so an instance of an RDF statement is called a <em>triple</em> with three parts:</p>

<ul>
  <li>subject: a URI (also referred to as a “Resource”)</li>
  <li>property: a URI (also referred to as a “Resource”)</li>
  <li>value: a URI (also referred to as a “Resource”) or a literal value (like a string)</li>
</ul>

<p>The subject for each Sedona related triple is the above URI for the DBPedia human readable page. The subject and property references in an RDF triple will almost always be a URI that can ground an entity to information on the web. The human readable page for Sedona lists several properties and the values of these properties. One of the properties is “dbo:areaCode” where “dbo” is a name space reference (in this case for a <a href="http://www.w3.org/2002/07/owl#DatatypeProperty">DatatypeProperty</a>).</p>

<p>The following two figures show an abstract representation of linked data and then a sample of linked data with actual web URIs for resources and properties:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 40%">
    <img src="images/rdf1.png" alt="Abstract RDF representation with 2 Resources, 2 literal values, and 3 Properties" style="width: 100%">
    <figcaption>Abstract RDF representation with 2 Resources, 2 literal values, and 3 Properties</figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 75%">
    <img src="images/rdf2.png" alt="Concrete example using RDF seen in last chapter showing the RDF representation with 2 Resources, 2 literal values, and 3 Properties" style="width: 100%">
    <figcaption>Concrete example using RDF seen in last chapter showing the RDF representation with 2 Resources, 2 literal values, and 3 Properties</figcaption>
  </figure>
</div>


<p>We saw a SPARQL Query (SPARQL for RDF data is similar to SQL for relational database queries) in the last chapter. Let’s look at another example using the RDF in the last figure:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">select</code> <code class="nv">?v</code> <code class="nv">where</code> <code class="nv">{</code>  <code class="nv">&lt;http://markwatson.com/index.rdf#Sun_ONE&gt;</code>
<code class="linenos">2 </code>                       <code class="nv">&lt;http://www.ontoweb.org/ontology/1#booktitle&gt;</code>
<code class="linenos">3 </code>                       <code class="nv">?v</code> <code class="nv">}</code>
</pre></div>

</figure>

<p>This query should return the result “Sun ONE Services - J2EE”. If you wanted to query for all URI resources that are books with the literal value of their titles, then you can use:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">select</code> <code class="nv">?s</code> <code class="nv">?v</code> <code class="nv">where</code> <code class="nv">{</code>  <code class="nv">?s</code>
<code class="linenos">2 </code>                          <code class="nv">&lt;http://www.ontoweb.org/ontology/1#booktitle&gt;</code>
<code class="linenos">3 </code>                          <code class="nv">?v</code> <code class="nv">}</code>
</pre></div>

</figure>

<p>Note that <strong>?s</strong> and <strong>?v</strong> are arbitrary query variable names, here standing for “subject” and “value”. You can use more descriptive variable names like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="nv">select</code> <code class="nv">?bookURI</code> <code class="nv">?bookTitle</code> <code class="nv">where</code> 
<code class="linenos">2 </code>        <code class="nv">{</code> <code class="nv">?bookURI</code>
<code class="linenos">3 </code>          <code class="nv">&lt;http://www.ontoweb.org/ontology/1#booktitle&gt;</code>
<code class="linenos">4 </code>          <code class="nv">?bookTitle</code> <code class="nv">}</code>
</pre></div>

</figure>

<p>We will be diving a little deeper into RDF examples in the next chapter when we write a tool for generating RDF data from raw text input.  For now I want you to understand the idea of RDF statements represented as triples, that web URIs represent things, properties, and sometimes values, and that URIs can be followed manually (often called “dereferencing”) to see what they reference in human readable form.</p>

<h3 id="leanpub-auto-understanding-the-resource-description-framework-rdf">Understanding the Resource Description Framework (RDF)</h3>

<p>Text data on the web has some structure in the form of HTML elements like headers, page titles, anchor links, etc. but this structure is too imprecise for general use by software agents. RDF is a method for encoding structured data in a more precise way.</p>

<p>We used the RDF data on my web site in the last chapter to introduce the “plumbing” of using the <strong>rdflib</strong> Python library to access, manipulate, and query RDF data.</p>

<h3 id="leanpub-auto-resource-namespaces-provided-in-rdflib">Resource Namespaces Provided in rdflib</h3>

<p>The following standard namespaces are predefined in <strong>rdflib</strong>:</p>

<ul>
  <li>RDF       <a href="https://www.w3.org/TR/rdf-syntax-grammar/">https://www.w3.org/TR/rdf-syntax-grammar/</a>
</li>
  <li>RDFS      <a href="https://www.w3.org/TR/rdf-schema/">https://www.w3.org/TR/rdf-schema/</a>
</li>
  <li>OWL       <a href="http://www.w3.org/2002/07/owl#">http://www.w3.org/2002/07/owl#</a>
</li>
  <li>XSD       <a href="http://www.w3.org/2001/XMLSchema#">http://www.w3.org/2001/XMLSchema#</a>
</li>
  <li>FOAF      <a href="http://xmlns.com/foaf/0.1/">http://xmlns.com/foaf/0.1/</a>
</li>
  <li>SKOS      <a href="http://www.w3.org/2004/02/skos/core#">http://www.w3.org/2004/02/skos/core#</a>
</li>
  <li>DOAP      <a href="http://usefulinc.com/ns/doap#">http://usefulinc.com/ns/doap#</a>
</li>
  <li>DC        <a href="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</a>
</li>
  <li>DCTERMS   <a href="http://purl.org/dc/terms/">http://purl.org/dc/terms/</a>
</li>
  <li>VOID      <a href="http://rdfs.org/ns/void#">http://rdfs.org/ns/void#</a>
</li>
</ul>

<p>Let’s look into the Friend of a Friend (FOAF) namespace. Click on the above link for FOAF <a href="http://xmlns.com/foaf/0.1/">http://xmlns.com/foaf/0.1/</a> and find the definitions for the FOAF Core:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>    <code class="nv">Agent</code>
<code class="linenos"> 2 </code>    <code class="nv">Person</code>
<code class="linenos"> 3 </code>    <code class="nv">name</code>
<code class="linenos"> 4 </code>    <code class="nv">title</code>
<code class="linenos"> 5 </code>    <code class="nv">img</code>
<code class="linenos"> 6 </code>    <code class="nv">depiction</code> <code class="p">(</code><code class="nv">depicts</code><code class="p">)</code>
<code class="linenos"> 7 </code>    <code class="nv">familyName</code>
<code class="linenos"> 8 </code>    <code class="nv">givenName</code>
<code class="linenos"> 9 </code>    <code class="nv">knows</code>
<code class="linenos">10 </code>    <code class="nv">based_near</code>
<code class="linenos">11 </code>    <code class="nv">age</code>
<code class="linenos">12 </code>    <code class="nv">made</code> <code class="p">(</code><code class="nv">maker</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="nv">primaryTopic</code> <code class="p">(</code><code class="nv">primaryTopicOf</code><code class="p">)</code>
<code class="linenos">14 </code>    <code class="nv">Project</code>
<code class="linenos">15 </code>    <code class="nv">Organization</code>
<code class="linenos">16 </code>    <code class="nv">Group</code>
<code class="linenos">17 </code>    <code class="nb">member</code>
<code class="linenos">18 </code>    <code class="nv">Document</code>
<code class="linenos">19 </code>    <code class="nv">Image</code>
</pre></div>

</figure>

<p>and for the Social Web:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">nick</code>
<code class="linenos"> 2 </code><code class="nv">mbox</code>
<code class="linenos"> 3 </code><code class="nv">homepage</code>
<code class="linenos"> 4 </code><code class="nv">weblog</code>
<code class="linenos"> 5 </code><code class="nv">openid</code>
<code class="linenos"> 6 </code><code class="nv">jabberID</code>
<code class="linenos"> 7 </code><code class="nv">mbox_sha1sum</code>
<code class="linenos"> 8 </code><code class="nv">interest</code>
<code class="linenos"> 9 </code><code class="nv">topic_interest</code>
<code class="linenos">10 </code><code class="nv">topic</code> <code class="p">(</code><code class="nv">page</code><code class="p">)</code>
<code class="linenos">11 </code><code class="nv">workplaceHomepage</code>
<code class="linenos">12 </code><code class="nv">workInfoHomepage</code>
<code class="linenos">13 </code><code class="nv">schoolHomepage</code>
<code class="linenos">14 </code><code class="nv">publications</code>
<code class="linenos">15 </code><code class="nv">currentProject</code>
<code class="linenos">16 </code><code class="nv">pastProject</code>
<code class="linenos">17 </code><code class="nv">account</code>
<code class="linenos">18 </code><code class="nv">OnlineAccount</code>
<code class="linenos">19 </code><code class="nv">accountName</code>
<code class="linenos">20 </code><code class="nv">accountServiceHomepage</code>
<code class="linenos">21 </code><code class="nv">PersonalProfileDocument</code>
<code class="linenos">22 </code><code class="nv">tipjar</code>
<code class="linenos">23 </code><code class="nv">sha1</code>
<code class="linenos">24 </code><code class="nv">thumbnail</code>
<code class="linenos">25 </code><code class="nv">logo</code>
</pre></div>

</figure>

<p>You now have seen a few common Schemas for RDF data. Another Schema that is widely used for annotating web sites, that we won’t need for our examples here, is <a href="https://schema.org">schema.org</a>. Let’s now use a Hy REPL session to explore namespaces and programatically create RDF using <strong>rdflib</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">Marks-MacBook:database</code> <code class="nv">$</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code><code class="nv">hy</code> <code class="mf">0.17</code><code class="nv">.0+108.g919a77e</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.3</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="linenos"> 3 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">rdflib.namespace</code> <code class="p">[</code><code class="nv">FOAF</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="nv">=&gt;</code> <code class="nv">FOAF</code>
<code class="linenos"> 5 </code><code class="nv">Namespace</code><code class="p">(</code><code class="ss">'http://xmlns.com/foaf/0.1/</code><code class="o">'</code><code class="p">)</code>
<code class="linenos"> 6 </code><code class="nv">=&gt;</code> <code class="nv">FOAF.name</code>
<code class="linenos"> 7 </code><code class="nv">rdflib.term.URIRef</code><code class="p">(</code><code class="ss">'http://xmlns.com/foaf/0.1/name</code><code class="o">'</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="nv">=&gt;</code> <code class="nv">FOAF.title</code>
<code class="linenos"> 9 </code><code class="nv">rdflib.term.URIRef</code><code class="p">(</code><code class="ss">'http://xmlns.com/foaf/0.1/title</code><code class="o">'</code><code class="p">)</code>
<code class="linenos">10 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="nv">rdflib</code><code class="p">)</code>
<code class="linenos">11 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">graph</code> <code class="p">(</code><code class="nf">rdflib.Graph</code><code class="p">))</code>
<code class="linenos">12 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">mark</code> <code class="p">(</code><code class="nf">rdflib.BNode</code><code class="p">))</code>
<code class="linenos">13 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.bind</code> <code class="s">"foaf"</code> <code class="nv">FOAF</code><code class="p">)</code>
<code class="linenos">14 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">rdflib</code> <code class="p">[</code><code class="nv">RDF</code><code class="p">]])</code>
<code class="linenos">15 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.add</code> <code class="p">[</code><code class="nv">mark</code> <code class="nv">RDF.type</code> <code class="nv">FOAF.Person</code><code class="p">])</code>
<code class="linenos">16 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.add</code> <code class="p">[</code><code class="nv">mark</code> <code class="nv">FOAF.nick</code> <code class="p">(</code><code class="nf">rdflib.Literal</code> <code class="s">"Mark"</code> <code class="ss">:lang</code> <code class="s">"en"</code><code class="p">)])</code>
<code class="linenos">17 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.add</code> <code class="p">[</code><code class="nv">mark</code> <code class="nv">FOAF.name</code> <code class="p">(</code><code class="nf">rdflib.Literal</code> <code class="s">"Mark Watson"</code> <code class="ss">:lang</code> <code class="s">"en"</code><code class="p">)])</code>
<code class="linenos">18 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">node</code> <code class="nv">graph</code><code class="p">]</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">node</code><code class="p">))</code>
<code class="linenos">19 </code><code class="p">(</code><code class="nf">rdflib.term.BNode</code><code class="p">(</code><code class="ss">'N21c7fa7385b545eb8a7e3821b7cb5</code><code class="o">'</code><code class="p">)</code>, <code class="nv">rdflib.term.URIRef</code><code class="p">(</code><code class="ss">'http://www</code><code class="err">\</code>
<code class="linenos">20 </code><code class="nv">.w3.org/1999/02/22-rdf-syntax-ns#type</code><code class="o">'</code><code class="p">)</code>, <code class="nv">rdflib.term.URIRef</code><code class="p">(</code><code class="ss">'http://xmlns.com/foaf/0</code><code class="err">\</code>
<code class="linenos">21 </code><code class="nv">.1/Person</code><code class="o">'</code><code class="p">))</code>
<code class="linenos">22 </code><code class="p">(</code><code class="nf">rdflib.term.BNode</code><code class="p">(</code><code class="ss">'N21c7fa7385b545eb8a7e3821b7cb5</code><code class="o">'</code><code class="p">)</code>, <code class="nv">rdflib.term.URIRef</code><code class="p">(</code><code class="ss">'http://xml</code><code class="err">\</code>
<code class="linenos">23 </code><code class="nv">ns.com/foaf/0.1/name</code><code class="o">'</code><code class="p">)</code>, <code class="nv">rdflib.term.Literal</code><code class="p">(</code><code class="ss">'Mark</code> <code class="nv">Watson</code><code class="o">'</code>, <code class="nv">lang=</code><code class="ss">'en</code><code class="o">'</code><code class="p">))</code>
<code class="linenos">24 </code><code class="p">(</code><code class="nf">rdflib.term.BNode</code><code class="p">(</code><code class="ss">'N21c7fa7385b545eb8a7e3821b7cb5</code><code class="o">'</code><code class="p">)</code>, <code class="nv">rdflib.term.URIRef</code><code class="p">(</code><code class="ss">'http://xml</code><code class="err">\</code>
<code class="linenos">25 </code><code class="nv">ns.com/foaf/0.1/nick</code><code class="o">'</code><code class="p">)</code>, <code class="nv">rdflib.term.Literal</code><code class="p">(</code><code class="ss">'Mark</code><code class="o">'</code>, <code class="nv">lang=</code><code class="ss">'en</code><code class="o">'</code><code class="p">))</code>
<code class="linenos">26 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.serialize</code> <code class="ss">:format</code> <code class="s">"pretty-xml"</code><code class="p">)</code>
<code class="linenos">27 </code><code class="nv">b</code><code class="ss">'&lt;?xml</code> <code class="nv">version=</code><code class="s">"1.0"</code> <code class="nv">encoding=</code><code class="s">"utf-8"</code><code class="nv">?&gt;</code>
<code class="linenos">28 </code><code class="nv">&lt;rdf:RDF</code>
<code class="linenos">29 </code>    <code class="nv">xmlns:foaf=</code><code class="s">"http://xmlns.com/foaf/0.1/"</code>
<code class="linenos">30 </code>    <code class="nv">xmlns:rdf=</code><code class="s">"http://www.w3.org/1999/02/22-rdf-syntax-ns#"</code>
<code class="linenos">31 </code><code class="nv">&gt;</code>
<code class="linenos">32 </code>  <code class="nv">&lt;foaf:Person</code> <code class="nv">rdf:nodeID=</code><code class="s">"N21c7fa7385b545eb8a7e3821b75b9cb5"</code><code class="nv">&gt;</code>
<code class="linenos">33 </code>    <code class="nv">&lt;foaf:name</code> <code class="nv">xml:lang=</code><code class="s">"en"</code><code class="nv">&gt;Mark</code> <code class="nv">Watson&lt;/foaf:name&gt;</code>
<code class="linenos">34 </code>    <code class="nv">&lt;foaf:nick</code> <code class="nv">xml:lang=</code><code class="s">"en"</code><code class="nv">&gt;Mark&lt;/foaf:nick&gt;</code>
<code class="linenos">35 </code>  <code class="nv">&lt;/foaf:Person&gt;</code>
<code class="linenos">36 </code><code class="nv">&lt;/rdf:RDF&gt;</code><code class="sc">\n</code><code class="o">'</code>
<code class="linenos">37 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.serialize</code> <code class="ss">:format</code> <code class="s">"turtle"</code><code class="p">)</code>
<code class="linenos">38 </code><code class="o">@</code><code class="nv">prefix</code> <code class="nv">foaf:</code> <code class="nv">&lt;http://xmlns.com/foaf/0.1/&gt;</code> <code class="nv">.</code>
<code class="linenos">39 </code><code class="o">@</code><code class="nv">prefix</code> <code class="nv">rdf:</code> <code class="nv">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</code> <code class="nv">.</code>
<code class="linenos">40 </code><code class="o">@</code><code class="nv">prefix</code> <code class="nv">rdfs:</code> <code class="nv">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="nv">.</code>
<code class="linenos">41 </code><code class="o">@</code><code class="nv">prefix</code> <code class="nv">xml:</code> <code class="nv">&lt;http://www.w3.org/XML/1998/namespace&gt;</code> <code class="nv">.</code>
<code class="linenos">42 </code><code class="o">@</code><code class="nv">prefix</code> <code class="nv">xsd:</code> <code class="nv">&lt;http://www.w3.org/2001/XMLSchema#&gt;</code> <code class="nv">.</code>
<code class="linenos">43 </code>
<code class="linenos">44 </code><code class="p">[]</code> <code class="nv">a</code> <code class="nv">foaf:Person</code> <code class="c1">;</code>
<code class="linenos">45 </code>     <code class="nv">foaf:name</code> <code class="s">"Mark Watson"</code><code class="o">@</code><code class="nv">en</code> <code class="c1">;</code>
<code class="linenos">46 </code>     <code class="nv">foaf:nick</code> <code class="s">"Mark"</code><code class="o">@</code><code class="nv">en</code> <code class="nv">.</code>
<code class="linenos">47 </code>
<code class="linenos">48 </code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">graph.serialize</code> <code class="ss">:format</code> <code class="s">"nt"</code><code class="p">)</code>
<code class="linenos">49 </code><code class="nv">_:N21c7fa7385b545eb8a7e3821b75b9cb5</code>
<code class="linenos">50 </code>   <code class="nv">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt;</code>
<code class="linenos">51 </code>   <code class="nv">&lt;http://xmlns.com/foaf/0.1/Person&gt;</code> <code class="nv">.</code>
<code class="linenos">52 </code><code class="nv">_:N21c7fa7385b545eb8a7e3821b75b9cb5</code> <code class="nv">&lt;http://xmlns.com/foaf/0.1/name&gt;</code> <code class="s">"Mark Watson"</code><code class="o">@</code><code class="nv">e</code><code class="err">\</code>
<code class="linenos">53 </code><code class="nv">n</code> <code class="nv">.</code>
<code class="linenos">54 </code><code class="nv">_:N21c7fa7385b545eb8a7e3821b75b9cb5</code> <code class="nv">&lt;http://xmlns.com/foaf/0.1/nick&gt;</code> <code class="s">"Mark"</code><code class="o">@</code><code class="nv">en</code> <code class="nv">.</code>
<code class="linenos">55 </code><code class="nv">=&gt;</code> 
</pre></div>

</figure>

<h3 id="leanpub-auto-understanding-the-sparql-query-language">Understanding the SPARQL Query Language</h3>

<p>For the purposes of the material in this book, the two sample SPARQL queries here and in the last chapter are sufficient for you to get started using <strong>rdflib</strong> with arbitrary RDF data sources and simple queries.</p>

<p>The Apache Foundation has a <a href="https://jena.apache.org/tutorials/sparql.html">good introduction to SPARQL</a> that I refer you to for more information.</p>

<h3 id="leanpub-auto-wrapping-the-python-rdflib-library">Wrapping the Python <strong>rdflib</strong> Library</h3>

<p>I hope that I have provided you with enough motivation to explore RDF data sources and consider the use of linked data/semantic web technologies for your projects.</p>

<p>You can install using the <a href="https://github.com/RDFLib/rdflib">source code for <strong>rdflib</strong></a> or using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip install rdflib
</pre></div>

</figure>

<p>If I depend on a library, regardless of the programming language, I like to keep an up-to-date copy of the source code ready at hand. There is sometimes no substitute for having library code available to read.</p>

<p>In the next chapter we will use natural language processing to extract structured information from raw text and automatically generate RDF data.</p>


<h2 id="leanpub-auto-knowledge-graph-creator">Knowledge Graph Creator</h2>

<p>A Knowledge Graph, that I often abbreviate as <strong>KG</strong>, is a graph database using a schema to define types (both objects and relationships between objects) and properties that link property values to objects. The term “Knowledge Graph” is both a general term and also sometimes refers to the specific Knowledge Graph used at Google which I worked with while working there in 2013. Here, we use KG to reference the general technology of storing knowledge in graph databases.</p>

<p>The application we develop here, the Knowledge Graph Creator (which I often refer to as KGCreator) is a utility that I use to generate small Knowledge Graphs from input text.</p>

<p>Knowledge engineering and knowledge representation are disciplines that started in the 1980s and are still both current research topics and used in industry. I view linked data, the semantic web, and KGs as extensions of this earlier work.</p>

<p>We base our work here on RDF. There is a general type of KGs that are also widely used in industry and that we will not cover here: property graphs, as used in Neo4J. Property graphs are general graphs that place no restrictions on the number of links a graph node may have and allow general data structures to be stored as node data and for the property links between nodes. Property links can have attributes, like nodes in the graph.</p>

<p>Semantic web data as represented by subject/property/value RDF triples are more constrained than property graphs but support powerful logic inferencing to better use data that is implicit in a graph but not explicitly stated (i.e., data is more easily inferred).</p>

<p>We covered RDF data in some detail in the last chapter. Here we will implement a toolset for converting unstructured text into RDF data using a few schema definitions from <a href="https://schema.org/">schema.org</a>. I believe in both the RDF and the general graph database approaches but here we will just use RDF.</p>

<p>Historically Knowledge Graphs used semantic web technology like <a href="https://en.wikipedia.org/wiki/Resource_Description_Framework">Resource Description Framework (RDF)</a> and <a href="https://en.wikipedia.org/wiki/Web_Ontology_Language">Web Ontology Language (OWL)</a>. I wrote two books in 2010 on semantic web technologies and you can get free PDFs for the <a href="http://markwatson.com/opencontentdata/book_lisp.pdf">Common Lisp version</a> (code is <a href="https://github.com/mark-watson/lisp_practical_semantic_web">here</a>) and the <a href="http://markwatson.com/opencontentdata/book_java.pdf">Java/Clojure/Scala version</a> (code is <a href="https://github.com/mark-watson/java_practical_semantic_web">here</a>). These free books might interest you after working through the material in this chapter.</p>

<p>I have an ongoing personal research project for creating knowledge graphs from various data sources. You can read more at <a href="http://www.kgcreator.com/">my KGCreator web site</a>. I have simplified versions of my KGCreator software implemented in both my <a href="https://leanpub.com/haskell-cookbook">Haskell Book</a> and in my most recent <a href="https://leanpub.com/lovinglisp">Common Lisp book</a>. The example here is similar to my Common Lisp implementation, except that it is implemented in the Hy language and I only support generating RDF. The examples in my Haskell and Common Lisp books also generate data for the Neo4J graph database.</p>

<p>What is a KG? It is a modern way to organize and access structured data and integrate data and metadata with other automated systems.</p>

<p>A Knowledge Graph is different from just a graph database containing graph data. The difference is that a KG will in general use Schemas, Taxonomy’s and Ontology’s that define the allowed types and structure of data and allowed relationships.</p>

<p>There is also an executable aspect of KGs since their primary use may be to support other systems in an organization.</p>

<h3 id="leanpub-auto-recommended-industrial-use-of-knowledge-graphs">Recommended Industrial Use of Knowledge Graphs</h3>

<p>Who needs a KG? How do you get started?</p>

<p>If people in your organization are spending much time doing general web search, it might be a signal that you should maintain your organization’s curated knowledge in a human searchable and software accessible way. A possible application is an internal search engine that mixes public web search APIs with search for knowledge used internally inside your organization.</p>

<p>Here are a few use cases:</p>

<ul>
  <li>At Google we used their Knowledge Graph for researching new internal systems that were built on their standard Knowledge Graph, with new schemas and data added.</li>
  <li>Digital transformations: start by using a KG to hold metadata for current data in already existing databases. A KG of metadata can provide you with a virtual data lake. It is common to build a large data lake and then have staff not be able to find data. Don’t try to do everything at once.</li>
  <li>Capture and preserve senior human expertise. The act of building an Ontology for in-house knowledge helps to understand how to organize data and provides people with a common vocabulary to discuss and model business processes.</li>
  <li>KYC (Know Your Customer) applications using data from many diverse data sources.</li>
  <li>Take advantage of expertise in a domain (e.g., healthcare or financial services) to build a Taxonomy and Ontology to use to organize available data. For most domains, there are standard existing Schemas, Taxonomy’s and Ontology’s that can be identified and used as-is or extended for your organization.</li>
</ul>

<p>To get started:</p>

<ul>
  <li>Start small with just one use case.</li>
  <li>Design a Schema that identifies object types and relationships</li>
  <li>Write some acceptance test cases that you want a prototype to be able to serve as a baseline to develop against.</li>
  <li>Avoid having too many stakeholders in early prototype projects — try to choose stakeholders based on potential stakeholders’ initial enthusiasm.</li>
</ul>

<p>A good way to start is to identify a single problem, determine the best data sources to use, define an Ontology that is just sufficient to solve the current problem and build a prototype “vertical slice” application. Lessons learned with a quick prototype will inform you on what was valuable and what to put effort into when expanding your KG. Start small and don’t try to build a huge system without taking many small development and evaluation steps.</p>

<p>What about KGs for small organizations? Small companies have less development resources but starting small and implementing a system that models the key data relationships, customer relationships, etc., does not require excessive resources. Just capturing where data comes from and who is responsible for maintaining important data sources can be valuable.</p>

<p>What about KGs for individuals? Given the effort involved in building custom KGs, one possible individual use case is developing KGs for commercial sale.</p>

<p>The application that we develop next is one way to quickly bootstrap a new KG by populating it with automatically generated RDF than can be manually curated by removing statements and adding new statements as appropriate.</p>

<h3 id="leanpub-auto-design-of-kgcreator-application">Design of KGCreator Application</h3>

<p>The example application developed here processes input text files in the sub-directory <strong>test_data</strong>. For each file with the extension <strong>.txt</strong> in <strong>test_data</strong>, there should be a matching file with the extension <strong>.meta</strong> that contains the origin URI for the corresponding text file. The git repository for this book has a few files in <strong>test_data</strong> that you can experiment with or replace with your own data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ ls test_data 
test1.meta test1.txt test2.meta test2.txt test3.meta test3.txt
</pre></div>

</figure>

<p>The *.txt files contain plain text for analysis and the *.meta files contain the original web source URI for the corresponding *.txt files. Using the spaCy library and Python/Hy’s standard libraries for file access, the KGCreator is simple to implement. Here is the overall design of this example:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 70%">
    <img src="images/kg1.png" alt="Overview of the Knowledge Graph Creator script" style="width: 100%">
    <figcaption>Overview of the Knowledge Graph Creator script</figcaption>
  </figure>
</div>


<p>We will develop two versions of the Knowledge Graph Creator. The first generates RDF that uses string values for the object part of generated RDF statements. The second implementation attempts to resolve these string values to DBPedia URIs.</p>

<p>Using only the spaCy NLP library that we used earlier and the built in Hy/Python libraries, this first example (uses strings a object values) is implemented in just 58 lines of Hy code that is seen in the following three code listings:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">os</code> <code class="p">[</code><code class="nv">scandir</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">os.path</code> <code class="p">[</code><code class="nv">splitext</code> <code class="nv">exists</code><code class="p">]])</code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="k">import </code><code class="nv">spacy</code><code class="p">)</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">nlp-model</code> <code class="p">(</code><code class="nf">spacy.load</code> <code class="s">"en"</code><code class="p">))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">find-entities-in-text</code> <code class="p">[</code><code class="nv">some-text</code><code class="p">]</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">clean</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="nf">.strip</code> <code class="p">(</code><code class="nf">.replace</code> <code class="nv">s</code> <code class="s">"\n"</code> <code class="s">" "</code><code class="p">)))</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">doc</code> <code class="p">(</code><code class="nf">nlp-model</code> <code class="nv">some-text</code><code class="p">))</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="nb">map</code> <code class="nb">list</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">entity</code> <code class="nv">doc.ents</code> <code class="p">[(</code><code class="nf">clean</code> <code class="nv">entity.text</code><code class="p">)</code> <code class="nv">entity.label_</code><code class="p">])))</code>
</pre></div>

</figure>

<p>In lines 3 and 4 we import three standard Python utilities we need for finding all files in a directory, checking to see if a file exists, and splitting text into tokens.  In line 7 we load the English language spaCy model and save the value of the model in the variable <strong>nlp-model</strong>. The function find-entities-in-text uses the spaCy English language model to find entities like organizations, people, etc., in text and cleans entity names by removing new line characters and other unnecessary white space (nested function <strong>clean</strong> in lines 10 and 11). We can run a test in a REPL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nb">list</code> <code class="p">(</code><code class="nf">find-entities-in-text</code> <code class="s">"John Smith went to Los Angeles to work at IBM"</code><code class="p">))</code>
<code class="p">[[</code><code class="ss">'John</code> <code class="nv">Smith</code><code class="o">'</code>, <code class="ss">'PERSON</code><code class="o">'</code><code class="p">]</code>, <code class="p">[</code><code class="ss">'Los</code> <code class="nv">Angeles</code><code class="o">'</code>, <code class="ss">'GPE</code><code class="o">'</code><code class="p">]</code>, <code class="p">[</code><code class="ss">'IBM</code><code class="o">'</code>, <code class="ss">'ORG</code><code class="o">'</code><code class="p">]]</code>
</pre></div>

</figure>

<p>The function <strong>find-entities-in-text</strong> returns a map object so I wrapped the results in a <strong>list</strong> to print out the entities in the test sentence. The entity types used by spaCy were defined in an earlier chapter, here we just use the entity types defined in lines 21-26 in the following listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">14 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">data2Rdf</code> <code class="p">[</code><code class="nv">meta-data</code> <code class="nv">entities</code> <code class="nv">fout</code><code class="p">]</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">value</code> <code class="nv">abbreviation</code><code class="p">]</code> <code class="nv">entities</code><code class="p">]</code>
<code class="linenos">16 </code>    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="nv">abbreviation</code> <code class="nv">e2umap</code><code class="p">)</code>
<code class="linenos">17 </code>      <code class="p">(</code><code class="nf">.write</code> <code class="nv">fout</code> <code class="p">(</code><code class="nf">+</code> <code class="s">"&lt;"</code> <code class="nv">meta-data</code> <code class="s">"&gt;\t"</code> <code class="p">(</code><code class="k">get </code><code class="nv">e2umap</code> <code class="nv">abbreviation</code><code class="p">)</code> <code class="s">"\t"</code> <code class="s">"\""</code>
<code class="linenos">18 </code>                       <code class="nv">value</code> <code class="s">"\""</code> <code class="s">" .\n"</code><code class="p">)))))</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">e2umap</code> <code class="p">{</code>
<code class="linenos">21 </code>  <code class="s">"ORG"</code> <code class="s">"&lt;https://schema.org/Organization&gt;"</code>
<code class="linenos">22 </code>  <code class="s">"LOC"</code> <code class="s">"&lt;https://schema.org/location&gt;"</code>
<code class="linenos">23 </code>  <code class="s">"GPE"</code> <code class="s">"&lt;https://schema.org/location&gt;"</code>
<code class="linenos">24 </code>  <code class="s">"NORP"</code> <code class="s">"&lt;https://schema.org/nationality&gt;"</code>
<code class="linenos">25 </code>  <code class="s">"PRODUCT"</code> <code class="s">"&lt;https://schema.org/Product&gt;"</code>
<code class="linenos">26 </code>  <code class="s">"PERSON"</code> <code class="s">"&lt;https://schema.org/Person&gt;"</code><code class="p">})</code>
</pre></div>

</figure>

<p>In lines 28-39 we open an output file for writing generated RDF data and loop through all text files in the input directory and call the function <strong>process-file</strong> for each text + meta file pair in the input directory:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">28 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">process-directory</code> <code class="p">[</code><code class="nv">directory-name</code> <code class="nv">output-rdf</code><code class="p">]</code>
<code class="linenos">29 </code>  <code class="p">(</code><code class="k">with</code> <code class="p">[</code><code class="nv">frdf</code> <code class="p">(</code><code class="nb">open</code> <code class="nv">output-rdf</code> <code class="s">"w"</code><code class="p">)]</code>
<code class="linenos">30 </code>    <code class="p">(</code><code class="k">with</code> <code class="p">[</code><code class="nv">entries</code> <code class="p">(</code><code class="nf">scandir</code> <code class="nv">directory-name</code><code class="p">)]</code>
<code class="linenos">31 </code>      <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">entry</code> <code class="nv">entries</code><code class="p">]</code>
<code class="linenos">32 </code>        <code class="p">(</code><code class="kd">setv </code><code class="p">[</code><code class="nv">_</code> <code class="nv">file-extension</code><code class="p">]</code> <code class="p">(</code><code class="nf">splitext</code> <code class="nv">entry.name</code><code class="p">))</code>
<code class="linenos">33 </code>        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">file-extension</code> <code class="s">".txt"</code><code class="p">)</code>
<code class="linenos">34 </code>            <code class="p">(</code><code class="nf">do</code>
<code class="linenos">35 </code>              <code class="p">(</code><code class="kd">setv </code><code class="nv">check-file-name</code> <code class="p">(</code><code class="nf">+</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">entry.path</code> <code class="mi">0</code> <code class="mi">-4</code><code class="p">)</code> <code class="s">".meta"</code><code class="p">))</code>
<code class="linenos">36 </code>              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">exists</code> <code class="nv">check-file-name</code><code class="p">)</code>
<code class="linenos">37 </code>                  <code class="p">(</code><code class="nf">process-file</code> <code class="nv">entry.path</code> <code class="nv">check-file-name</code> <code class="nv">frdf</code><code class="p">)</code>
<code class="linenos">38 </code>                  <code class="p">(</code><code class="nb">print</code> <code class="s">"Warning: no .meta file for"</code> <code class="nv">entry.path</code>
<code class="linenos">39 </code>                         <code class="s">"in directory"</code> <code class="nv">directory-name</code><code class="p">))))))))</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">40 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">process-file</code> <code class="p">[</code><code class="nv">txt-path</code> <code class="nv">meta-path</code> <code class="nv">frdf</code><code class="p">]</code>
<code class="linenos">41 </code>  
<code class="linenos">42 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">read-data</code> <code class="p">[</code><code class="nv">text-path</code> <code class="nv">meta-path</code><code class="p">]</code>
<code class="linenos">43 </code>    <code class="p">(</code><code class="k">with</code> <code class="p">[</code><code class="nv">f</code> <code class="p">(</code><code class="nb">open</code> <code class="nv">text-path</code><code class="p">)]</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">t1</code> <code class="p">(</code><code class="nf">.read</code> <code class="nv">f</code><code class="p">)))</code>
<code class="linenos">44 </code>    <code class="p">(</code><code class="k">with</code> <code class="p">[</code><code class="nv">f</code> <code class="p">(</code><code class="nb">open</code> <code class="nv">meta-path</code><code class="p">)]</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">t2</code> <code class="p">(</code><code class="nf">.read</code> <code class="nv">f</code><code class="p">)))</code>
<code class="linenos">45 </code>    <code class="p">[</code><code class="nv">t1</code> <code class="nv">t2</code><code class="p">])</code>
<code class="linenos">46 </code>  
<code class="linenos">47 </code>  <code class="p">(</code><code class="kd">defn </code><code class="nv">modify-entity-names</code> <code class="p">[</code><code class="nv">ename</code><code class="p">]</code>
<code class="linenos">48 </code>    <code class="p">(</code><code class="nf">.replace</code> <code class="nv">ename</code> <code class="s">"the "</code> <code class="s">""</code><code class="p">))</code>
<code class="linenos">49 </code>  
<code class="linenos">50 </code>  <code class="p">(</code><code class="kd">setv </code><code class="p">[</code><code class="nv">txt</code> <code class="nv">meta</code><code class="p">]</code> <code class="p">(</code><code class="nf">read-data</code> <code class="nv">txt-path</code> <code class="nv">meta-path</code><code class="p">))</code>
<code class="linenos">51 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">entities</code> <code class="p">(</code><code class="nf">find-entities-in-text</code> <code class="nv">txt</code><code class="p">))</code>
<code class="linenos">52 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">entities</code> <code class="c1">;; only operate on a few entity types</code>
<code class="linenos">53 </code>        <code class="p">(</code><code class="nf">lfor</code> <code class="p">[</code><code class="nv">e</code> <code class="nv">t</code><code class="p">]</code> <code class="nv">entities</code>
<code class="linenos">54 </code>              <code class="ss">:if</code> <code class="p">(</code><code class="k">in </code><code class="nv">t</code> <code class="p">[</code><code class="s">"NORP"</code> <code class="s">"ORG"</code> <code class="s">"PRODUCT"</code> <code class="s">"GPE"</code> <code class="s">"PERSON"</code> <code class="s">"LOC"</code><code class="p">])</code>
<code class="linenos">55 </code>              <code class="p">[(</code><code class="nf">modify-entity-names</code> <code class="nv">e</code><code class="p">)</code> <code class="nv">t</code><code class="p">]))</code>
<code class="linenos">56 </code>  <code class="p">(</code><code class="nf">data2Rdf</code> <code class="nv">meta</code> <code class="nv">entities</code> <code class="nv">frdf</code><code class="p">))</code>
<code class="linenos">57 </code>
<code class="linenos">58 </code><code class="p">(</code><code class="nf">process-directory</code> <code class="s">"test_data"</code> <code class="s">"output.rdf"</code><code class="p">)</code>
</pre></div>

</figure>

<p>We will look at generated output, problems with it, and how to fix these problems in the next section.</p>

<h3 id="leanpub-auto-problems-with-using-literal-values-in-rdf">Problems with using Literal Values in RDF</h3>

<p>Using the Hy script in the last section, let’s look at some of the generated RDF for the text files in the input test directory (most output is not shown). In each triple the first item, the subject, is the URI of the data source, the second item in each statement is a URI representing a relationship (or property), and the third item is a literal string value:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/nationality&gt;</code>	<code class="s">"Portuguese"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"Banco Espirito Santo SA"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Person&gt;</code>	      <code class="s">"John Evans"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"Banco Espirito"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"The Wall Street Journal"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"IBM"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/location&gt;</code>	<code class="s">"Canada"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"Australian Broadcasting Corporation"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Person&gt;</code>	<code class="s">"Frank Smith"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"Australian Writers Guild"</code> <code class="nv">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"American University"</code> <code class="nv">.</code>
<code class="nv">&lt;https://localnews.com/june/z902.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"The Wall Street Journal"</code> <code class="nv">.</code>
<code class="nv">&lt;https://localnews.com/june/z902.html&gt;</code>
  <code class="nv">&lt;https://schema.org/location&gt;</code>	<code class="s">"Mexico"</code> <code class="nv">.</code>
<code class="nv">&lt;https://localnews.com/june/z902.html&gt;</code>
  <code class="nv">&lt;https://schema.org/location&gt;</code>	<code class="s">"Canada"</code> <code class="nv">.</code>
<code class="nv">&lt;https://localnews.com/june/z902.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Person&gt;</code>	<code class="s">"Bill Clinton"</code> <code class="nv">.</code>
<code class="nv">&lt;https://localnews.com/june/z902.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"IBM"</code> <code class="nv">.</code>
<code class="nv">&lt;https://localnews.com/june/z902.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>	<code class="s">"Microsoft"</code> <code class="nv">.</code>
<code class="nv">&lt;https://abcnews.go.com/US/violent-long-lasting-tornadoes-threaten-oklahoma-texas/st</code><code class="err">\</code>
<code class="nv">ory?id=63146361&gt;</code>
  <code class="nv">&lt;https://schema.org/Person&gt;</code>	<code class="s">"Jane Deerborn"</code> <code class="nv">.</code>
<code class="nv">&lt;https://abcnews.go.com/US/violent-long-lasting-tornadoes-threaten-oklahoma-texas/st</code><code class="err">\</code>
<code class="nv">ory?id=63146361&gt;</code>
  <code class="nv">&lt;https://schema.org/location&gt;</code>	<code class="s">"Texas"</code> <code class="nv">.</code>
</pre></div>

</figure>

<p>Let’s visualize the results in a bash shell:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>$ git clone https://github.com/fatestigma/ontology-visualization
$ <code class="nb">cd</code> ontology-visualization
$ chmod +x ontology_viz.py
$ ./ontology_viz.py -o test.dot output.rdf  -O ontology.ttl
$ <code class="c1"># copy the file output.rdf from examples repo directory hy-lisp-python/kgcreator</code>
$ dot -Tpng -o test.png test.dot
$ open test.png
</pre></div>

</figure>

<p>Edited to fit on the page, the output looks like:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/1dot1.png" alt="" style="width: 100%">
    <figcaption></figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 467px">
    <img src="images/1dot2.png" alt="" style="width: 100%">
    <figcaption></figcaption>
  </figure>
</div>



<div class="figure-wrapper center">
  <figure class="image" style="width: 468px">
    <img src="images/1dot3.png" alt="" style="width: 100%">
    <figcaption></figcaption>
  </figure>
</div>


<p>Because we used literal values, notice how for example the node for the entity <strong>IBM</strong> is not shared and thus a software agent using this RDF data cannot, for example, infer relationships between two news sources that both have articles about IBM. We will work on a solution to this problem in the next section.</p>

<h3 id="leanpub-auto-revisiting-this-example-using-uris-instead-of-literal-values">Revisiting This Example Using URIs Instead of Literal Values</h3>

<p>Note that in the figure in the previous section that nodes for literal values (e.g., for “IBM”) are not shared. In this section we will copy the file <strong>kgcreator.hy</strong> to <strong>kgcreator_uri.hy</strong> add a few additions to map string literal values for entity names to <a href="http://dbpedia.org">http://dbpedia.org</a> URIs by individually searching Google using the pattern “DBPedia ‘entity name’” and defining a new map <strong>v2umap</strong> for mapping literal values to DBPedia URIs.</p>

<p>Note: In a production system (not a book example), I would use <a href="https://www.wikidata.org/wiki/Wikidata:Database_download">https://www.wikidata.org database download</a> to download all of WikiData (which includes DBPedia data) and use a fuzzy text matching to find WikiData URIs for string literals. The compressed WikiData JSON data file is about 50 GB. Here we will manually find DBPedia for entity names that are in the example data.</p>

<p>In <strong>kgcreator_uri.hy</strong> we add a map <strong>v2umap</strong> for selected entity literal names to DBPedia URIs that I manually created using a web search on the DBPedia domain:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="kd">setv </code><code class="nv">v2umap</code> <code class="p">{</code> <code class="c1">;; object literal value to URI mapping</code>
  <code class="s">"IBM"</code> <code class="s">"&lt;http://dbpedia.org/page/IBM&gt;"</code>
  <code class="s">"The Wall Street Journal"</code> <code class="s">"&lt;http://dbpedia.org/page/The_Wall_Street_Journal&gt;"</code>
  <code class="s">"Banco Espirito"</code> <code class="s">"&lt;http://dbpedia.org/page/Banco_Esp%C3%ADrito_Santo&gt;"</code>
  <code class="s">"Australian Broadcasting Corporation"</code>
  <code class="s">"http://dbpedia.org/page/Australian_Broadcasting_Corporation"</code>
  <code class="s">"Australian Writers Guild"</code>
  <code class="s">"http://dbpedia.org/page/Australian_Broadcasting_Corporation"</code>
  <code class="s">"Microsoft"</code> <code class="s">"http://dbpedia.org/page/Microsoft"</code><code class="p">})</code>
</pre></div>

</figure>

<p>We also make a change in the function <strong>data2Rdf</strong> to use the map <strong>v2umap</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="kd">defn </code><code class="nv">data2Rdf</code> <code class="p">[</code><code class="nv">meta-data</code> <code class="nv">entities</code> <code class="nv">fout</code><code class="p">]</code>
  <code class="p">(</code><code class="k">for</code> <code class="p">[[</code><code class="nv">value</code> <code class="nv">abbreviation</code><code class="p">]</code> <code class="nv">entities</code><code class="p">]</code>
    <code class="p">(</code><code class="kd">setv </code><code class="nv">a-literal</code> <code class="p">(</code><code class="nf">+</code> <code class="s">"\""</code> <code class="nv">value</code> <code class="s">"\""</code><code class="p">))</code>
    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="nv">value</code> <code class="nv">v2umap</code><code class="p">)</code> <code class="p">(</code><code class="kd">setv </code><code class="nv">a-literal</code> <code class="p">(</code><code class="k">get </code><code class="nv">v2umap</code> <code class="nv">value</code><code class="p">)))</code>
    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="nv">abbreviation</code> <code class="nv">e2umap</code><code class="p">)</code>
      <code class="p">(</code><code class="nf">.write</code> <code class="nv">fout</code> <code class="p">(</code><code class="nf">+</code> <code class="s">"&lt;"</code> <code class="nv">meta-data</code> <code class="s">"&gt;\t"</code> <code class="p">(</code><code class="k">get </code><code class="nv">e2umap</code> <code class="nv">abbreviation</code><code class="p">)</code>
                      <code class="s">"\t"</code> <code class="nv">a-literal</code> <code class="s">" .\n"</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>Here is some of the generated RDF that has changed:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>
  <code class="nv">&lt;http://dbpedia.org/page/IBM&gt;</code> <code class="o">.</code>
<code class="nv">&lt;https://newsshop.com/may/a1023.html&gt;</code>
  <code class="nv">&lt;https://schema.org/Organization&gt;</code>
  <code class="nv">&lt;http://dbpedia.org/page/Banco_Esp%C3%ADrito_Santo&gt;</code> <code class="o">.</code>
</pre></div>

</figure>

<p>Now when we visualize generated RDF, we share nodes for The Wallstreet Journal and IBM:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 90%">
    <img src="images/2dot1.png" alt="Part of the RDF graph that shows shared nodes when URIs are used for RDF values instead of literal strings" style="width: 100%">
    <figcaption>Part of the RDF graph that shows shared nodes when URIs are used for RDF values instead of literal strings</figcaption>
  </figure>
</div>


<p>While literal values sometimes are useful in generated RDF, using literals for the values in RDF triples prevents types of queries and inference that can be performed on the data.</p>

<h3 id="leanpub-auto-wrap-up-4">Wrap-up</h3>

<p>In the field of Artificial Intelligence there are two topics that get me the most excited and I have been fortunate to be paid to work on both: Deep Learning and Knowledge Graphs. Here we have just touched the surface for creating data for Knowledge Graphs but I hope that between this chapter and the material on RDF in the chapter <strong>Datastores</strong> that you have enough information and experience playing with the examples to get started prototyping a Knowledge Graph in your organizartion. My advice is to “start small” by picking a problem that your organization has that can be solved by not moving data around, but rather, by creating a custom Knowledge Graph for metadata for existing information in your organization.</p>


<h2 id="kgn">Knowledge Graph Navigator</h2>

<p>The Knowledge Graph Navigator (which I will often refer to as KGN) is a tool for processing a set of entity names and automatically exploring the public Knowledge Graph <a href="http://dbpedia.org">DBPedia</a> using SPARQL queries. I wrote KGN in Common Lisp for my own use to automate some things I used to do manually when exploring Knowledge Graphs, and later thought that KGN might be useful also for educational purposes. KGN uses NLP code developed in earlier chapters and we will reuse that code with a short review of using the APIs.</p>

<p>Please note that the example is a simplified version that I first wrote in Common Lisp and is also an example in my book <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, or the Savvy Programmer’s Secret Weapon</a> that you can read for free online. If you are interested you can see <a href="http://www.knowledgegraphnavigator.com/screen/">screen shots of the Common Lisp version here</a>.</p>

<p>The following two screen shots show the text based user interface for this example. This example application asks the user for a list of entity names and uses SPARQL queries to discover potential matches in DBPedia. We use the python library <a href="https://github.com/CITGuru/PyInquirer">PyInquirer</a> for requesting entity names and then to show the user a list of matches from DBPedia. The following screen shot shows these steps:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 92%">
    <img src="images/kgnuserselect.png" alt="Initial user interaction with Knowledge Graph Navigator example" style="width: 100%">
    <figcaption>Initial user interaction with Knowledge Graph Navigator example</figcaption>
  </figure>
</div>


<p>To select the entities of interest, the user uses a space character to select or deselect an entity and the return (or enter) key to accept the list selections.</p>

<p>After the user selects entities from the list, the list disappears. The next screen shot shows the output from this example after the user finishes selecting entities of interest:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 92%">
    <img src="images/kgnafter.png" alt="After the user selects entities of interest" style="width: 100%">
    <figcaption>After the user selects entities of interest</figcaption>
  </figure>
</div>


<p>The code for this application is in the directory <strong>kgn</strong>. You will need to install the following Python library that supports console/text user interfaces:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip install PyInquirer
</pre></div>

</figure>

<p>You will also need the <strong>spacy</strong> library and language model that we used in the earlier chapter on natural language processing. If you have not already done so, install these requirements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>pip install spacy
python -m spacy download en_core_web_sm
</pre></div>

</figure>

<p>After listing the generated SPARQL for finding information for the entities in the query, KGN searches for relationships between these entities. These discovered relationships can be seen at the end of the last screen shot. Please note that this step makes SPARQL queries on <strong>O(n^2)</strong> where <strong>n</strong> is the number of entities. Local caching of SPARQL queries to DBPedia helps make processing many entities possible.</p>

<p>Every time KGN makes a SPARQL query web service call to DBPedia the query and response are cached in a SQLite database in <strong>~/.kgn_hy_cache.db</strong> which can greatly speed up the program, especially in development mode when testing a set of queries. This caching also takes some load off of the public DBPedia endpoint, which is a polite thing to do.</p>

<h3 id="leanpub-auto-review-of-nlp-utilities-used-in-application">Review of NLP Utilities Used in Application</h3>

<p>We covered NLP in a previous chapter, so the following is just a quick review. The NLP code we use is near the top of the file <strong>kgn.hy</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="k">import </code><code class="nv">spacy</code><code class="p">)</code>

<code class="p">(</code><code class="kd">setv </code><code class="nv">nlp-model</code> <code class="p">(</code><code class="nf">spacy.load</code> <code class="s">"en"</code><code class="p">))</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">entities-in-text</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code>
  <code class="p">(</code><code class="kd">setv </code><code class="nv">doc</code> <code class="p">(</code><code class="nf">nlp-model</code> <code class="nv">s</code><code class="p">))</code>
  <code class="p">(</code><code class="kd">setv </code><code class="nv">ret</code> <code class="p">{})</code>
  <code class="p">(</code><code class="k">for</code>
    <code class="p">[[</code><code class="nv">ename</code> <code class="nv">etype</code><code class="p">]</code> <code class="p">(</code><code class="nf">lfor</code> <code class="nv">entity</code> <code class="nv">doc.ents</code> <code class="p">[</code><code class="nv">entity.text</code> <code class="nv">entity.label_</code><code class="p">])]</code>   
    <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="nv">etype</code> <code class="nv">ret</code><code class="p">)</code>
        <code class="p">(</code><code class="kd">setv </code><code class="p">(</code><code class="k">get </code><code class="nv">ret</code> <code class="nv">etype</code><code class="p">)</code> <code class="p">(</code><code class="nf">+</code> <code class="p">(</code><code class="k">get </code><code class="nv">ret</code> <code class="nv">etype</code><code class="p">)</code> <code class="p">[</code><code class="nv">ename</code><code class="p">]))</code>
        <code class="p">(</code><code class="k">assoc </code><code class="nv">ret</code> <code class="nv">etype</code> <code class="p">[</code><code class="nv">ename</code><code class="p">])))</code>
  <code class="nv">ret</code><code class="p">)</code>
</pre></div>

</figure>

<p>Here is an example use of this function:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">=&gt;</code> <code class="p">(</code><code class="nv">kgn.entities-in-text</code> <code class="s">"Bill Gates, Microsoft, Seattle"</code><code class="p">)</code>
<code class="nv">{</code><code class="ss">'PERSON</code><code class="o">'</code><code class="err">:</code> <code class="nv">[</code><code class="ss">'Bill</code> <code class="nv">Gates</code><code class="ss">'],</code> <code class="ss">'ORG</code><code class="o">'</code><code class="err">:</code> <code class="nv">[</code><code class="ss">'Microsoft'],</code> <code class="ss">'GPE</code><code class="o">'</code><code class="err">:</code> <code class="nv">[</code><code class="ss">'Seattle']}</code>
</pre></div>

</figure>

<p>The entity type “GPE” indicates that the entity is some type of location.</p>

<h3 id="leanpub-auto-developing-low-level-caching-sparql-utilities">Developing Low-Level Caching SPARQL Utilities</h3>

<p>While developing KGN and also using it as an end user, many SPARQL queries to DBPedia contain repeated entity names so it makes sense to write a caching layer.  We use a SQLite database “~/.kgn_hy_cache.db” to store queries and responses. We covered using SQLite in some detail in the chapter on datastores.</p>

<p>The caching layer is implemented in the file <strong>cache.hy</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">sqlite3</code> <code class="p">[</code><code class="nv">connect</code> <code class="nv">version</code> <code class="nv">Error</code> <code class="p">]])</code>
<code class="linenos"> 2 </code><code class="p">(</code><code class="k">import </code><code class="nv">json</code><code class="p">)</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">*db-path*</code> <code class="s">"kgn_hy_cache.db"</code><code class="p">)</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">create-db</code> <code class="p">[]</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">try</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">conn</code> <code class="p">(</code><code class="nf">connect</code> <code class="nv">*db-path*</code><code class="p">))</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="nb">print</code> <code class="nv">version</code><code class="p">)</code>
<code class="linenos">10 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">cur</code> <code class="p">(</code><code class="nf">conn.cursor</code><code class="p">))</code>
<code class="linenos">11 </code>    <code class="p">(</code><code class="nf">cur.execute</code> <code class="s">"CREATE TABLE dbpedia (query string  PRIMARY KEY ASC, data json)"</code><code class="p">)</code>
<code class="linenos">12 </code>    <code class="p">(</code><code class="nf">conn.close</code><code class="p">)</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="k">except</code> <code class="p">[</code><code class="nv">e</code> <code class="ne">Exception</code><code class="p">]</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">e</code><code class="p">))))</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">save-query-results-dbpedia</code> <code class="p">[</code><code class="nv">query</code> <code class="nv">result</code><code class="p">]</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="k">try</code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">conn</code> <code class="p">(</code><code class="nf">connect</code> <code class="nv">*db-path*</code><code class="p">))</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="kd">setv </code><code class="nv">cur</code> <code class="p">(</code><code class="nf">conn.cursor</code><code class="p">))</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nf">cur.execute</code> <code class="s">"insert into dbpedia (query, data) values (?, ?)"</code> 
<code class="linenos">20 </code>                 <code class="p">[</code><code class="nv">query</code> <code class="p">(</code><code class="nf">json.dumps</code> <code class="nv">result</code><code class="p">)])</code>
<code class="linenos">21 </code>    <code class="p">(</code><code class="nf">conn.commit</code><code class="p">)</code>
<code class="linenos">22 </code>    <code class="p">(</code><code class="nf">conn.close</code><code class="p">)</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="k">except</code> <code class="p">[</code><code class="nv">e</code> <code class="ne">Exception</code><code class="p">]</code> <code class="p">(</code><code class="nb">print</code> <code class="nv">e</code><code class="p">))))</code>
<code class="linenos">24 </code> 
<code class="linenos">25 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">fetch-result-dbpedia</code> <code class="p">[</code><code class="nv">query</code><code class="p">]</code>
<code class="linenos">26 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">results</code> <code class="p">[])</code>
<code class="linenos">27 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">conn</code> <code class="p">(</code><code class="nf">connect</code> <code class="nv">*db-path*</code><code class="p">))</code>
<code class="linenos">28 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">cur</code> <code class="p">(</code><code class="nf">conn.cursor</code><code class="p">))</code>
<code class="linenos">29 </code>  <code class="p">(</code><code class="nf">cur.execute</code> <code class="s">"select data from dbpedia where query = ? limit 1"</code> <code class="p">[</code><code class="nv">query</code><code class="p">])</code>
<code class="linenos">30 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">d</code> <code class="p">(</code><code class="nf">cur.fetchall</code><code class="p">))</code>
<code class="linenos">31 </code>  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">&gt;</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">d</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">32 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">results</code> <code class="p">(</code><code class="nf">json.loads</code> <code class="p">(</code><code class="k">first </code><code class="p">(</code><code class="k">first </code><code class="nv">d</code><code class="p">)))))</code>
<code class="linenos">33 </code>  <code class="p">(</code><code class="nf">conn.close</code><code class="p">)</code>
<code class="linenos">34 </code>  <code class="nv">results</code><code class="p">)</code>
<code class="linenos">35 </code> 
<code class="linenos">36 </code><code class="p">(</code><code class="nf">create-db</code><code class="p">)</code>
</pre></div>

</figure>

<p>Here we store structured data from SPARQL queries as JSON data serialized as string values.</p>

<h4 id="leanpub-auto-sparql-utilities">SPARQL Utilities</h4>

<p>We will use the caching code from the last section and also the standard Python library <strong>requests</strong> to access the DBPedia servers. The following code is found in the file <strong>sparql.hy</strong> and also provides support for using both DBPedia and WikiData. We only use DBPedia in this chapter but when you start incorporating SPARQL queries into applications that you write, you will also probably want to use WikiData.</p>

<p>The function <strong>do-query-helper</strong> contains generic code for SPARQL queries and is used in functions <strong>wikidata-sparql</strong> and <strong>dbpedia-sparql</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="k">import </code><code class="nv">json</code><code class="p">)</code>
<code class="p">(</code><code class="k">import </code><code class="nv">requests</code><code class="p">)</code>
<code class="p">(</code><code class="nf">require</code> <code class="p">[</code><code class="nv">hy.contrib.walk</code> <code class="p">[</code><code class="nv">let</code><code class="p">]])</code>

<code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">cache</code> <code class="p">[</code><code class="nv">fetch-result-dbpedia</code> <code class="nv">save-query-results-dbpedia</code><code class="p">]])</code>

<code class="p">(</code><code class="kd">setv </code><code class="nv">wikidata-endpoint</code> <code class="s">"https://query.wikidata.org/bigdata/namespace/wdq/sparql"</code><code class="p">)</code>
<code class="p">(</code><code class="kd">setv </code><code class="nv">dbpedia-endpoint</code> <code class="s">"https://dbpedia.org/sparql"</code><code class="p">)</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">do-query-helper</code> <code class="p">[</code><code class="nv">endpoint</code> <code class="nv">query</code><code class="p">]</code>
  <code class="c1">;; check cache:</code>
  <code class="p">(</code><code class="kd">setv </code><code class="nv">cached-results</code> <code class="p">(</code><code class="nf">fetch-result-dbpedia</code> <code class="nv">query</code><code class="p">))</code>
  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">&gt;</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">cached-results</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
      <code class="p">(</code><code class="k">let </code><code class="p">()</code>
        <code class="p">(</code><code class="nb">print</code> <code class="s">"Using cached query results"</code><code class="p">)</code>
        <code class="p">(</code><code class="nb">eval</code> <code class="nv">cached-results</code><code class="p">))</code>
      <code class="p">(</code><code class="k">let </code><code class="p">()</code>
        <code class="c1">;; Construct a request</code>
        <code class="p">(</code><code class="kd">setv </code><code class="nv">params</code> <code class="p">{</code> <code class="s">"query"</code> <code class="nv">query</code> <code class="s">"format"</code> <code class="s">"json"</code><code class="p">})</code>
        
        <code class="c1">;; Call the API</code>
        <code class="p">(</code><code class="kd">setv </code><code class="nv">response</code> <code class="p">(</code><code class="nf">requests.get</code> <code class="nv">endpoint</code> <code class="ss">:params</code> <code class="nv">params</code><code class="p">))</code>
        
        <code class="p">(</code><code class="kd">setv </code><code class="nv">json-data</code> <code class="p">(</code><code class="nf">response.json</code><code class="p">))</code>
        
        <code class="p">(</code><code class="kd">setv </code><code class="nb">vars</code> <code class="p">(</code><code class="k">get </code><code class="p">(</code><code class="k">get </code><code class="nv">json-data</code> <code class="s">"head"</code><code class="p">)</code> <code class="s">"vars"</code><code class="p">))</code>
        
        <code class="p">(</code><code class="kd">setv </code><code class="nv">results</code> <code class="p">(</code><code class="k">get </code><code class="nv">json-data</code> <code class="s">"results"</code><code class="p">))</code>
        
        <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="k">in </code><code class="s">"bindings"</code> <code class="nv">results</code><code class="p">)</code>
            <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">bindings</code> <code class="p">(</code><code class="k">get </code><code class="nv">results</code> <code class="s">"bindings"</code><code class="p">)</code>
                  <code class="nv">qr</code>
                  <code class="p">(</code><code class="nf">lfor</code> <code class="nv">binding</code> <code class="nv">bindings</code>
                        <code class="p">(</code><code class="nf">lfor</code> <code class="nv">var</code> <code class="nb">vars</code>
                              <code class="p">[</code><code class="nv">var</code> <code class="p">(</code><code class="k">get </code><code class="p">(</code><code class="k">get </code><code class="nv">binding</code> <code class="nv">var</code><code class="p">)</code> <code class="s">"value"</code><code class="p">)]))]</code>
              <code class="p">(</code><code class="nf">save-query-results-dbpedia</code> <code class="nv">query</code> <code class="nv">qr</code><code class="p">)</code>
              <code class="nv">qr</code><code class="p">)</code>
            <code class="p">[]))))</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">wikidata-sparql</code> <code class="p">[</code><code class="nv">query</code><code class="p">]</code>
  <code class="p">(</code><code class="nf">do-query-helper</code> <code class="nv">wikidata-endpoint</code> <code class="nv">query</code><code class="p">))</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">dbpedia-sparql</code> <code class="p">[</code><code class="nv">query</code><code class="p">]</code>
  <code class="p">(</code><code class="nf">do-query-helper</code> <code class="nv">dbpedia-endpoint</code> <code class="nv">query</code><code class="p">))</code>
</pre></div>

</figure>

<p>Here is an example query (manually formatted for page width):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nv">$</code> <code class="nv">hy</code>
<code class="nv">hy</code> <code class="mf">0.18</code><code class="nv">.0</code> <code class="nv">using</code> <code class="nv">CPython</code><code class="p">(</code><code class="nf">default</code><code class="p">)</code> <code class="mf">3.7</code><code class="nv">.4</code> <code class="nv">on</code> <code class="nv">Darwin</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="k">import </code><code class="nv">sparql</code><code class="p">)</code>
<code class="nv">table</code> <code class="nv">dbpedia</code> <code class="nv">already</code> <code class="nv">exists</code>
<code class="nv">=&gt;</code> <code class="p">(</code><code class="nf">sparql.dbpedia-sparql</code>
     <code class="s">"select ?s ?p ?o { ?s ?p ?o } limit 1"</code><code class="p">)</code>
<code class="p">[[[</code><code class="ss">'s</code><code class="o">'</code>, <code class="ss">'http://www.openlinksw.com/virtrdf-data-formats#default-iid</code><code class="o">'</code><code class="p">]</code>,
  <code class="p">[</code><code class="ss">'p</code><code class="o">'</code>, <code class="ss">'http://www.w3.org/1999/02/22-rdf-syntax-ns#type</code><code class="o">'</code><code class="p">]</code>,
  <code class="p">[</code><code class="ss">'o</code><code class="o">'</code>, <code class="ss">'http://www.openlinksw.com/schemas/virtrdf#QuadMapFormat</code><code class="o">'</code><code class="p">]]]</code>
<code class="nv">=&gt;</code> 
</pre></div>

</figure>

<p>This is a wild-card SPARQL query that will match any of the 9.5 billion RDF triples in DBPedia and return just one result.</p>

<p>This caching layer greatly speeds up my own personal use of KGN. Without caching, queries that contain many entity references simply take too long to run.</p>

<h3 id="leanpub-auto-utilities-to-colorize-sparql-and-generated-output">Utilities to Colorize SPARQL and Generated Output</h3>

<p>When I first had the basic functionality of KGN working, I was disappointed by how the application looked as normal text. Every editor and IDE I use colorizes text in an appropriate way so I used standard ANSI terminal escape sequences to implement color hilting SPARQL queries.</p>

<p>The code in the following listing is in the file <strong>colorize.hy</strong>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nf">require</code> <code class="p">[</code><code class="nv">hy.contrib.walk</code> <code class="p">[</code><code class="nv">let</code><code class="p">]])</code>
<code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">io</code> <code class="p">[</code><code class="nv">StringIO</code><code class="p">]])</code>

<code class="c1">;; Utilities to add ANSI terminal escape sequences to colorize text.</code>
<code class="c1">;; note: the following 5 functions return string values that then need to</code>
<code class="c1">;;       be printed.</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">blue</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"{}{}{}"</code> <code class="s">"\033[94m"</code> <code class="nv">s</code> <code class="s">"\033[0m"</code><code class="p">))</code>
<code class="p">(</code><code class="kd">defn </code><code class="nv">red</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"{}{}{}"</code> <code class="s">"\033[91m"</code> <code class="nv">s</code> <code class="s">"\033[0m"</code><code class="p">))</code>
<code class="p">(</code><code class="kd">defn </code><code class="nv">green</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"{}{}{}"</code> <code class="s">"\033[92m"</code> <code class="nv">s</code> <code class="s">"\033[0m"</code><code class="p">))</code>
<code class="p">(</code><code class="kd">defn </code><code class="nv">pink</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"{}{}{}"</code> <code class="s">"\033[95m"</code> <code class="nv">s</code> <code class="s">"\033[0m"</code><code class="p">))</code>
<code class="p">(</code><code class="kd">defn </code><code class="nv">bold</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code> <code class="p">(</code><code class="nf">.format</code> <code class="s">"{}{}{}"</code> <code class="s">"\033[1m"</code> <code class="nv">s</code> <code class="s">"\033[0m"</code><code class="p">))</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">tokenize-keep-uris</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code>
  <code class="p">(</code><code class="nf">.split</code> <code class="nv">s</code><code class="p">))</code>

<code class="p">(</code><code class="kd">defn </code><code class="nv">colorize-sparql</code> <code class="p">[</code><code class="nv">s</code><code class="p">]</code>
  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">tokens</code>
        <code class="p">(</code><code class="nf">tokenize-keep-uris</code>
          <code class="p">(</code><code class="nf">.replace</code> <code class="p">(</code><code class="nf">.replace</code> <code class="p">(</code><code class="nf">.replace</code> <code class="nv">s</code> <code class="s">"{"</code> <code class="s">" { "</code><code class="p">)</code> <code class="s">"}"</code> <code class="s">" } "</code><code class="p">)</code> <code class="s">"."</code> <code class="s">" . "</code><code class="p">))</code>
        <code class="nv">ret</code> <code class="p">(</code><code class="nf">StringIO</code><code class="p">)]</code> <code class="c1">;; ret is an output stream for a string buffer</code>
    <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">token</code> <code class="nv">tokens</code><code class="p">]</code>
      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">&gt;</code> <code class="p">(</code><code class="nb">len</code> <code class="nv">token</code><code class="p">)</code> <code class="mi">0</code><code class="p">)</code>
          <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="p">(</code><code class="k">get </code><code class="nv">token</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"?"</code><code class="p">)</code>
              <code class="p">(</code><code class="nf">.write</code> <code class="nv">ret</code> <code class="p">(</code><code class="nf">red</code> <code class="nv">token</code><code class="p">))</code>
              <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">in</code>
                    <code class="nv">token</code>
                    <code class="p">[</code><code class="s">"where"</code> <code class="s">"select"</code> <code class="s">"distinct"</code> <code class="s">"option"</code> <code class="s">"filter"</code>
                     <code class="s">"FILTER"</code> <code class="s">"OPTION"</code> <code class="s">"DISTINCT"</code> <code class="s">"SELECT"</code> <code class="s">"WHERE"</code><code class="p">])</code>
                  <code class="p">(</code><code class="nf">.write</code> <code class="nv">ret</code> <code class="p">(</code><code class="nf">blue</code> <code class="nv">token</code><code class="p">))</code>
                  <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="p">(</code><code class="k">get </code><code class="nv">token</code> <code class="mi">0</code><code class="p">)</code> <code class="s">"&lt;"</code><code class="p">)</code>
                      <code class="p">(</code><code class="nf">.write</code> <code class="nv">ret</code> <code class="p">(</code><code class="nf">bold</code> <code class="nv">token</code><code class="p">))</code>
                      <code class="p">(</code><code class="nf">.write</code> <code class="nv">ret</code> <code class="nv">token</code><code class="p">)))))</code>
      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">not</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">token</code> <code class="s">"?"</code><code class="p">))</code>
          <code class="p">(</code><code class="nf">.write</code> <code class="nv">ret</code> <code class="s">" "</code><code class="p">)))</code>
    <code class="p">(</code><code class="nf">.seek</code> <code class="nv">ret</code> <code class="mi">0</code><code class="p">)</code>
    <code class="p">(</code><code class="nf">.read</code> <code class="nv">ret</code><code class="p">)))</code>
</pre></div>

</figure>

<p>You have seen colorized SPARQL in the two screen shots at the beginning of this chapter.</p>

<h3 id="leanpub-auto-text-utilities-for-queries-and-results">Text Utilities for Queries and Results</h3>

<p>The application low level utility functions are in the file <strong>kgn-utils.hy</strong>. The function <strong>dbpedia-get-entities-by-name</strong> requires two arguments:</p>

<ul>
  <li>The name of an entity to search for.</li>
  <li>A URI representing the entity type that we are looking for.</li>
</ul>

<p>We embed a SPARQL query that has placeholders for the entity name and type. The filter expression specifies that we only want triple results with comment values in the English language by using <strong>(lang(?comment) = ‘en’)</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="o">#</code><code class="nv">!/usr/bin/env</code> <code class="nv">hy</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">sparql</code> <code class="p">[</code><code class="nv">dbpedia-sparql</code><code class="p">]])</code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">colorize</code> <code class="p">[</code><code class="nv">colorize-sparql</code><code class="p">]])</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="k">import </code><code class="p">[</code><code class="nv">pprint</code> <code class="p">[</code><code class="nv">pprint</code><code class="p">]])</code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="nf">require</code> <code class="p">[</code><code class="nv">hy.contrib.walk</code> <code class="p">[</code><code class="nv">let</code><code class="p">]])</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">dbpedia-get-entities-by-name</code> <code class="p">[</code><code class="nv">name</code> <code class="nv">dbpedia-type</code><code class="p">]</code>
<code class="linenos">10 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">sparql</code>
<code class="linenos">11 </code>        <code class="p">(</code><code class="nf">.format</code> <code class="s">"select distinct ?s ?comment {{ ?s ?p \"{}\"@en . ?s &lt;http://www.w3\</code>
<code class="linenos">12 </code><code class="s">.org/2000/01/rdf-schema#comment&gt;  ?comment  . FILTER  (lang(?comment) = 'en') . ?s &lt;\</code>
<code class="linenos">13 </code><code class="s">http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt; {} . }} limit 15"</code> <code class="nv">name</code> <code class="nv">dbpedia-type</code><code class="err">\</code>
<code class="linenos">14 </code><code class="p">)]</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nb">print</code> <code class="s">"Generated SPARQL to get DBPedia entity URIs from a name:"</code><code class="p">)</code>
<code class="linenos">16 </code>    <code class="p">(</code><code class="nb">print</code> <code class="p">(</code><code class="nf">colorize-sparql</code> <code class="nv">sparql</code><code class="p">))</code>
<code class="linenos">17 </code>    <code class="p">(</code><code class="nf">dbpedia-sparql</code> <code class="nv">sparql</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Here is an example:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 92%">
    <img src="images/kgnutils.png" alt="Getting entities by name with colorized SPARL query script" style="width: 100%">
    <figcaption>Getting entities by name with colorized SPARL query script</figcaption>
  </figure>
</div>


<h3 id="leanpub-auto-finishing-the-main-function-for-kgn">Finishing the Main Function for KGN</h3>

<p>We already looked at the NLP code near the beginning of the file <strong>kgn.hy</strong>. Let’s look at the remainder of the implementation.</p>

<p>We need a dictionary (or hash table) to convert <strong>spaCy</strong> entity type names to DBPedia type URIs:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">entity-type-to-type-uri</code>
<code class="linenos">2 </code>      <code class="p">{</code><code class="s">"PERSON"</code> <code class="s">"&lt;http://dbpedia.org/ontology/Person&gt;"</code>
<code class="linenos">3 </code>       <code class="s">"GPE"</code> <code class="s">"&lt;http://dbpedia.org/ontology/Place&gt;"</code>
<code class="linenos">4 </code>       <code class="s">"ORG"</code> <code class="s">"&lt;http://dbpedia.org/ontology/Organisation&gt;"</code>
<code class="linenos">5 </code>       <code class="p">})</code>
</pre></div>

</figure>

<p>When we get entity results from DBPedia, the comments describing entities can be a few paragraphs of text. We want to shorten the comments so they fit in a single line of the entity selection list that we have seen earlier. The following code defines a comment shortening function and also a global variable that we will use to store the entity URIs for each shortened comment:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="kd">setv </code><code class="nv">short-comment-to-uri</code> <code class="p">{})</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">shorten-comment</code> <code class="p">[</code><code class="nv">comment</code> <code class="nv">uri</code><code class="p">]</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="kd">setv </code><code class="nv">sc</code> <code class="p">(</code><code class="nf">+</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">comment</code> <code class="mi">0</code> <code class="mi">70</code><code class="p">)</code> <code class="s">"..."</code><code class="p">))</code>
<code class="linenos">5 </code>  <code class="p">(</code><code class="k">assoc </code><code class="nv">short-comment-to-uri</code> <code class="nv">sc</code> <code class="nv">uri</code><code class="p">)</code>
<code class="linenos">6 </code>  <code class="nv">sc</code><code class="p">)</code>
</pre></div>

</figure>

<p>In line 5, we use the function <strong>assoc</strong> to add a key and value pair to an existing dictionary <strong>short-comment-to-uri</strong>.</p>

<p>Finally, let’s look at the main application loop. In line 4 we are using the function <strong>get-query</strong> (defined in file <strong>textui.hy</strong>) to get a list of entity names from the user. In line 7 we use the function <strong>entities-in-text</strong> that we saw earlier to map text to entity types and names. In the nested loops in lines 13-26 we build one line descriptions of people, place, and organizations that we will use to show the user a menu for selecting entities found in DBPedia from the original query. We are giving the use a chance to select only the discovered entities that they are interested in.</p>

<p>In lines 33-35 we are converting the shortened comment strings the user selected back to DBPedia entity URIs. Finally in line 36 we use the function <strong>entity-results-&gt;relationship-links</strong> to find relationships between the user selected entities.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">kgn</code> <code class="p">[]</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="k">while</code>
<code class="linenos"> 3 </code>    <code class="kc">True</code>
<code class="linenos"> 4 </code>    <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">query</code> <code class="p">(</code><code class="nf">get-query</code><code class="p">)</code>
<code class="linenos"> 5 </code>          <code class="nv">emap</code> <code class="p">{}]</code>
<code class="linenos"> 6 </code>      <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">or</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">query</code> <code class="s">"quit"</code><code class="p">)</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">query</code> <code class="s">"q"</code><code class="p">))</code>
<code class="linenos"> 7 </code>          <code class="p">(</code><code class="k">break</code><code class="p">))</code>
<code class="linenos"> 8 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">elist</code> <code class="p">(</code><code class="nf">entities-in-text</code> <code class="nv">query</code><code class="p">))</code>
<code class="linenos"> 9 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">people-found-on-dbpedia</code> <code class="p">[])</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">places-found-on-dbpedia</code> <code class="p">[])</code>
<code class="linenos">11 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">organizations-found-on-dbpedia</code> <code class="p">[])</code>
<code class="linenos">12 </code>      <code class="p">(</code><code class="k">global</code> <code class="nv">short-comment-to-uri</code><code class="p">)</code>
<code class="linenos">13 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">short-comment-to-uri</code> <code class="p">{})</code>
<code class="linenos">14 </code>      <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">key</code> <code class="nv">elist</code><code class="p">]</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="kd">setv </code><code class="nb">type</code><code class="nv">-uri</code> <code class="p">(</code><code class="k">get </code><code class="nv">entity-type-to-type-uri</code> <code class="nv">key</code><code class="p">))</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">name</code> <code class="p">(</code><code class="k">get </code><code class="nv">elist</code> <code class="nv">key</code><code class="p">)]</code>
<code class="linenos">17 </code>          <code class="p">(</code><code class="kd">setv </code><code class="nv">dbp</code> <code class="p">(</code><code class="nf">dbpedia-get-entities-by-name</code> <code class="nv">name</code> <code class="nb">type</code><code class="nv">-uri</code><code class="p">))</code>
<code class="linenos">18 </code>          <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">d</code> <code class="nv">dbp</code><code class="p">]</code>
<code class="linenos">19 </code>            <code class="p">(</code><code class="kd">setv </code><code class="nv">short-comment</code> <code class="p">(</code><code class="nf">shorten-comment</code> <code class="p">(</code><code class="nf">second</code> <code class="p">(</code><code class="nf">second</code> <code class="nv">d</code><code class="p">))</code> 
<code class="linenos">20 </code>            <code class="p">(</code><code class="nf">second</code> <code class="p">(</code><code class="k">first </code><code class="nv">d</code><code class="p">))))</code>
<code class="linenos">21 </code>            <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">key</code> <code class="s">"PERSON"</code><code class="p">)</code>
<code class="linenos">22 </code>                <code class="p">(</code><code class="nf">.extend</code> <code class="nv">people-found-on-dbpedia</code> <code class="p">[(</code><code class="nf">+</code> <code class="nv">name</code>  <code class="s">" || "</code> <code class="nv">short-comment</code><code class="p">)]))</code>
<code class="linenos">23 </code>            <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">key</code> <code class="s">"GPE"</code><code class="p">)</code>
<code class="linenos">24 </code>                <code class="p">(</code><code class="nf">.extend</code> <code class="nv">places-found-on-dbpedia</code> <code class="p">[(</code><code class="nf">+</code> <code class="nv">name</code>  <code class="s">" || "</code> <code class="nv">short-comment</code><code class="p">)]))</code>
<code class="linenos">25 </code>            <code class="p">(</code><code class="k">if</code> <code class="p">(</code><code class="nf">=</code> <code class="nv">key</code> <code class="s">"ORG"</code><code class="p">)</code>
<code class="linenos">26 </code>                <code class="p">(</code><code class="nf">.extend</code> <code class="nv">organizations-found-on-dbpedia</code> 
<code class="linenos">27 </code>                <code class="p">[(</code><code class="nf">+</code> <code class="nv">name</code>  <code class="s">" || "</code> <code class="nv">short-comment</code><code class="p">)])))))</code>
<code class="linenos">28 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">user-selected-entities</code>
<code class="linenos">29 </code>            <code class="p">(</code><code class="nf">select-entities</code>
<code class="linenos">30 </code>              <code class="nv">people-found-on-dbpedia</code>
<code class="linenos">31 </code>              <code class="nv">places-found-on-dbpedia</code>
<code class="linenos">32 </code>              <code class="nv">organizations-found-on-dbpedia</code><code class="p">))</code>
<code class="linenos">33 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">uri-list</code> <code class="p">[])</code>
<code class="linenos">34 </code>      <code class="p">(</code><code class="k">for</code> <code class="p">[</code><code class="nv">entity</code> <code class="p">(</code><code class="k">get </code><code class="nv">user-selected-entities</code> <code class="s">"entities"</code><code class="p">)]</code>
<code class="linenos">35 </code>        <code class="p">(</code><code class="kd">setv </code><code class="nv">short-comment</code> <code class="p">(</code><code class="nf">cut</code> <code class="nv">entity</code> <code class="p">(</code><code class="nf">+</code> <code class="mi">4</code> <code class="p">(</code><code class="nf">.index</code> <code class="nv">entity</code> <code class="s">" || "</code><code class="p">))))</code>
<code class="linenos">36 </code>        <code class="p">(</code><code class="nf">.extend</code> <code class="nv">uri-list</code> <code class="p">[(</code><code class="k">get </code><code class="nv">short-comment-to-uri</code> <code class="nv">short-comment</code><code class="p">)]))</code>
<code class="linenos">37 </code>      <code class="p">(</code><code class="kd">setv </code><code class="nv">relation-data</code> <code class="p">(</code><code class="nf">entity-results-&gt;relationship-links</code> <code class="nv">uri-list</code><code class="p">))</code>
<code class="linenos">38 </code>      <code class="p">(</code><code class="nb">print</code> <code class="s">"\nDiscovered relationship links:"</code><code class="p">)</code>
<code class="linenos">39 </code>      <code class="p">(</code><code class="nf">pprint</code> <code class="nv">relation-data</code><code class="p">))))</code>
</pre></div>

</figure>

<p>If you have not already done so, I hope you experiment running this example application. The first time you specify an entity name expect some delay while DBPedia is accessed. Thereafter the cache will make the application more responsive when you use the same name again in a different query.</p>

<h3 id="leanpub-auto-wrap-up-5">Wrap-up</h3>

<p>If you enjoyed running and experimenting with this example and want to modify it for your own projects then I hope that I provided a sufficient road map for you to do so.</p>

<p>I got the idea for the KGN application because I was spending quite a bit of time manually setting up SPARQL queries for DBPedia and other public sources like WikiData, and I wanted to experiment with partially automating this exploration process.</p>


<h2 id="leanpub-auto-book-wrap-up">Book Wrap-up</h2>

<p>I love programming in Lisp languages but I often need to use Python libraries for Deep Learning and NLP. The Hy language is a good fit for me, it is simple to install along with the Python libraries that I use for my work and it is a fun language to write code in. Most importantly, Hy fits well with the type of iterative bottom-up REPL-based development that I prefer.</p>

<p>I hope that you enjoyed this short book and that at least a few things that you have learned here will both help you in your work and give you ideas for new personal projects.</p>

<p>Best regards,</p>

<p>Mark Watson</p>

<p>February 15, 2020</p>

</div>
</body>
</html>
