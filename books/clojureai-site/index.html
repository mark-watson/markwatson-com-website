<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Practical Artificial Intelligence Programming With Clojure</title>
  <link href="stylesheet.css" rel="stylesheet" />
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJNL6DY9ZQ"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MJNL6DY9ZQ');
      </script>
 
</head>
<body dir="" class="lfm">
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#leanpub-auto-preface'>Preface</a>
    <ul>
      <li>
        <a href='#leanpub-auto-clojure-with-some-java-and-python'>Clojure, With Some Java and Python</a>
      </li>
      <li>
        <a href='#leanpub-auto-personal-artificial-intelligence-journey-or-life-as-a-lisp-developer'>Personal Artificial Intelligence Journey: or, Life as a Lisp Developer</a>
      </li>
      <li>
        <a href='#leanpub-auto-acknowledgements'>Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#dl4j'>Deep Learning Using Deeplearning4j</a>
    <ul>
      <li>
        <a href='#leanpub-auto-feed-forward-classification-networks'>Feed Forward Classification Networks</a>
      </li>
      <li>
        <a href='#leanpub-auto-optional-material-documentation-for-other-types-of-deeplearning4j-built-in-layers'>Optional Material: Documentation For Other Types of DeepLearning4J Built In Layers</a>
      </li>
      <li>
        <a href='#leanpub-auto-deep-learning-wrap-up'>Deep Learning Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#opennlp'>Natural Language Processing Using OpenNLP</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-the-clojure-and-java-wrappers-for-opennlp'>Using the Clojure and Java Wrappers for OpenNLP</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#libpython'>Python/Clojure Interoperation Using the libpython-clj Library</a>
    <ul>
      <li>
        <a href='#leanpub-auto-using-spacy-for-natural-language-processing'>Using spaCy for Natural Language Processing</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-the-hugging-face-transformer-models-for-question-answering'>Using the Hugging Face Transformer Models for Question Answering</a>
      </li>
      <li>
        <a href='#leanpub-auto-combined-spacy-and-transformer-question-answering'>Combined spaCy and Transformer Question Answering</a>
      </li>
      <li>
        <a href='#leanpub-auto-using-libpython-clj-with-the-spacy-and-hugging-face-transformer-python-nlp-libraries'>Using libpython-clj with the spaCy and Hugging Face Transformer Python NLP Libraries</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-anomaly-detection-machine-learning-example'>Anomaly Detection Machine Learning Example</a>
    <ul>
      <li>
        <a href='#leanpub-auto-motivation-for-anomaly-detection'>Motivation for Anomaly Detection</a>
      </li>
      <li>
        <a href='#leanpub-auto-math-primer-for-anomaly-detection'>Math Primer for Anomaly Detection</a>
      </li>
      <li>
        <a href='#leanpub-auto-anomalydetection-utility-class-written-in-java'>AnomalyDetection Utility Class Written in Java</a>
      </li>
      <li>
        <a href='#leanpub-auto-clojure-experiment-for-the-university-of-wisconsin-cancer-data-using-java-anomaly-detection-code'>Clojure Experiment for the University of Wisconsin Cancer Data Using Java Anomaly Detection Code</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-web-scraping'>Web Scraping</a>
    <ul>
      <li>
        <a href='#leanpub-auto-web-scraping-using-the-jsoup-library'>Web Scraping Using the <strong>jsoup</strong> Library</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#semantic-web'>Background Material for the Semantic Web and Knowledge Graphs</a>
    <ul>
      <li>
        <a href='#leanpub-auto-learning-plan'>Learning Plan</a>
      </li>
      <li>
        <a href='#leanpub-auto-available-tools'>Available Tools</a>
      </li>
      <li>
        <a href='#leanpub-auto-rdf-the-universal-data-format'>RDF: The Universal Data Format</a>
      </li>
      <li>
        <a href='#rdfs'>Extending RDF with RDF Schema</a>
      </li>
      <li>
        <a href='#leanpub-auto-the-sparql-query-language'>The SPARQL Query Language</a>
      </li>
      <li>
        <a href='#owl'>OWL: The Web Ontology Language</a>
      </li>
      <li>
        <a href='#leanpub-auto-semantic-web-wrap-up'>Semantic Web Wrap-up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-clojure-wrapper-for-the-jena-rdf-and-sparql-library'>Clojure Wrapper for the Jena RDF and SPARQL Library</a>
  </li>
  <li>
    <a href='#kgn'>Knowledge Graph Navigator</a>
    <ul>
      <li>
        <a href='#leanpub-auto-entity-types-handled-by-kgn'>Entity Types Handled by KGN</a>
      </li>
      <li>
        <a href='#leanpub-auto-kgn-implementation'>KGN Implementation</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#leanpub-auto-using-the-openai-apis'>Using the OpenAI APIs</a>
  </li>
  <li>
    <a href='#leanpub-auto-conclusions'>Conclusions</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="lfm">
<h2 id="leanpub-auto-preface">Preface</h2>

<p>Copyright Mark Watson. All rights reserved. This book may be shared using the Creative Commons “share and share alike, no modifications, no commercial reuse” license.</p>

<p>The latest edition of this book is always available for purchase at <a href="https://leanpub.com/clojureai">https://leanpub.com/clojureai</a>.  You can also download a free copy from my website <a href="https://markwatson.com">https://markwatson.com</a>. You are welcome to take free copies of all of my eBooks and to share them. I offer the purchase option for readers who wish to directly support my work.</p>

<p>I have been developing commercial Artificial Intelligence (AI) tools and applications since the 1980s and I usually use the Lisp languages Common Lisp, Clojure, Racket Scheme, and Gambit Scheme. This book contains code that I wrote for myself and I am wrapping it in a book in the hopes that my code and this book will also be useful to you, dear reader.</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 153px">
    <img src="images/Mark.png" alt="Mark Watson" style="width: 100%">
    <figcaption>Mark Watson</figcaption>
  </figure>
</div>


<p>I wrote this book for both professional programmers and home hobbyists who already know how to program in Clojure and who want to learn practical AI programming and information processing techniques. I have tried to make this an enjoyable book to work through. In the style of a “cook book,” the chapters can be studied in any order. </p>

<p>This book uses two of the examples in my Java AI book that is also available for purchase at <a href="https://leanpub.com/javaai">Leanpub.com</a> and as a free download from my personal web site. I replicate these two bits of Java code in the GitHub repository for this book:</p>

<p><a href="https://github.com/mark-watson/Clojure-AI-Book-Code">https://github.com/mark-watson/Clojure-AI-Book-Code</a></p>

<p>Git pull requests with code improvements will be appreciated by me and the readers of this book.</p>

<h3 id="leanpub-auto-clojure-with-some-java-and-python">Clojure, With Some Java and Python</h3>

<p>To be clear, I actually like Common Lisp slightly more than Clojure, even though Clojure is a beautifully designed modern language and Common Lisp is ancient and has defects. Then why do I use Clojure? The Java ecosystem is huge and Clojure takes full advantage of Java interoperability. Just as I sometimes need access to the rich Java ecosystem I also need Python libraries for some of my projects. Here we will use the <strong>libpython-clj</strong> library for that. I also like the language <strong>Hy</strong> that has a Clojure-like syntax and wraps the Python language. If you use Python then my book <a href="https://leanpub.com/hy-lisp-python">A Lisp Programmer Living in Python-Land: The Hy Programming Language</a> might be of interest.</p>

<p>Using the Java ecosystem is an important aspect of Clojure development and in the few cases where I use Java libraries from my Java AI book, my Clojure examples illustrate how to convert Clojure <strong>seq</strong> data to Java arrays, handle returned Java data values, etc.</p>

<h3 id="leanpub-auto-personal-artificial-intelligence-journey-or-life-as-a-lisp-developer">Personal Artificial Intelligence Journey: or, Life as a Lisp Developer</h3>

<p>I have been interested in AI since reading Bertram Raphael’s excellent book <em>Thinking Computer: Mind Inside Matter</em> in the early 1980s. I have also had the good fortune to work on many interesting AI projects including the development of commercial expert system tools for the Xerox LISP machines and the Apple Macintosh, development of commercial neural network tools, application of natural language and expert systems technology, medical information systems, application of AI technologies to Nintendo and PC video games, and the application of AI technologies to the financial markets. I have also applied statistical natural language processing techniques to analyzing social media data from Twitter and Facebook. I worked at Google on their Knowledge Graph and I managed a deep learning team at Capital One where I was awarded 55 US patents.</p>

<p>I enjoy AI programming, and hopefully this enthusiasm will also infect you.</p>

<h3 id="leanpub-auto-acknowledgements">Acknowledgements</h3>

<p>I produced the manuscript for this book using the <a href="http://leanpub.com">leanpub.com</a> publishing system and I recommend leanpub.com to other authors.</p>

<p><strong>Editor: Carol Watson</strong></p>

<p>Thanks to the following people who found typos in this and earlier book editions: Roger Erens</p>

<p>Thanks to the following people who suggested improvements in this and earlier book editions: non so far.</p>


<h2 id="dl4j">Deep Learning Using Deeplearning4j</h2>

<p>In the last ten years Deep Learning has been so successful for solving difficult problems in areas like image understanding and natural language processing (NLP) that many people now equate Deep Learning with AI. While I think this is a false equivalence, I have often used plain old fashioned neural networks and Deep Learning models in my work.</p>

<p>One limitation of conventional back propagation neural networks is that they are limited to the number of neuron layers that can be efficiently trained (the vanishing gradients problem).</p>

<p>Deep learning uses computational improvements to mitigate the vanishing gradient problem like using ReLu activation functions rather than the more traditional Sigmoid function, and networks called “skip connections” where some layers are initially turned off with connections skipping to the next active layer.</p>

<p>Modern deep learning frameworks like DeepLearning4j, TensorFlow, and PyTorch are easy to use and efficient. We use DeepLearning4j in this chapter because it is written in Java and easy to use with Clojure. In a later chapter we will use the Clojure library <strong>libpython-clj</strong> to access other deep learning-based tools like the Hugging Face Transformer models for question answering systems as well as the <strong>spaCy</strong> Python library for NLP.</p>

<p>I have used GAN (generative adversarial networks) models for synthesizing numeric spreadsheet data, LSTM (long short term memory) models to synthesize highly structured text data like nested JSON, and for NLP (natural language processing). Several of my 55 US patents use neural network and Deep Learning technology.</p>

<p>The <a href="http://deeplearning4j.org/">Deeplearning4j.org</a> Java library supports many neural network algorithms. We will look at one simple example so you will feel comfortable integrating Deeplearning4j with your Clojure projects and a later optional-reading section details other available types of models.  Note that I will often refer to Deeplearning4j as DL4J. </p>

<p>We start with a simple example of a feed forward network using the same University of Wisconsin cancer database that we will also use later in the chapter on anomaly detection.</p>

<p>There is a separate <a href="https://github.com/eclipse/deeplearning4j-examples">repository of DL4J examples</a> that you might want to look at since any of these Java examples that look useful for your projects can be used in Clojure using the example here to get started.</p>

<h3 id="leanpub-auto-feed-forward-classification-networks">Feed Forward Classification Networks</h3>

<p>Feed forward classification networks are a type of deep neural network that can contain multiple hidden neuron layers. In the example here the adjacent layers are fully connected (all neurons in adjacent layers are connected). The DL4J library is written to scale to large problems and to use GPUs if you have them available.</p>

<p>In general, simpler network architectures that can solve a problem are better than unnecessarily complicated architectures. You can start with simple architectures and add layers, different layer types, and parallel models as needed. For feed forward networks model complexity has two dimensions: the numbers of neurons in hidden layers, and the number of hidden layers. If you put too many neurons in hidden layers then the training data is effectively memorized and this will hurt performance on data samples not used in training (referred to as out of sample data). In practice, I “starve the network” by reducing the number of hidden neurons until the model has reduced accuracy on independent test data. Then I slightly increase the number of neurons in hidden layers. This technique helps avoid models simply memorizing training data (the over fitting problem).</p>

<p>Our example here reads the University of Wisconsin cancer training and testing data sets (lines 37-53), creates a model (lines 53-79), trains it (line 81) and tests it (lines 82-94).</p>

<p>You can increase the number of hidden units per layer in line 23 (something that you might do for more complex problems). To add a hidden layer you can repeat lines 68-75 (and incrementing the layer index from 1 to 2). Note that in this example, we are mostly working with Java data types, not Clojure types. In a later chapter that uses the Jena RDF/SPARQL library, we convert Java values to Clojure values.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">deeplearning-dl4j-clj.wisconsin-data</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:import</code> <code class="p">[</code><code class="nv">org.datavec.api.split</code> <code class="nv">FileSplit</code><code class="p">]</code>
<code class="linenos"> 3 </code>           <code class="p">[</code><code class="nv">org.deeplearning4j.datasets.datavec</code> 
<code class="linenos"> 4 </code>            <code class="nv">RecordReaderDataSetIterator</code><code class="p">]</code>
<code class="linenos"> 5 </code>           <code class="p">[</code><code class="nv">org.datavec.api.records.reader.impl.csv</code>
<code class="linenos"> 6 </code>            <code class="nv">CSVRecordReader</code><code class="p">]</code>
<code class="linenos"> 7 </code>           <code class="p">[</code><code class="nv">org.deeplearning4j.nn.conf</code>
<code class="linenos"> 8 </code>            <code class="nv">NeuralNetConfiguration$Builder</code><code class="p">]</code>
<code class="linenos"> 9 </code>           <code class="p">[</code><code class="nv">org.deeplearning4j.nn.conf.layers</code>
<code class="linenos">10 </code>            <code class="nv">OutputLayer$Builder</code> <code class="nv">DenseLayer$Builder</code><code class="p">]</code>
<code class="linenos">11 </code>           <code class="p">[</code><code class="nv">org.deeplearning4j.nn.weights</code> <code class="nv">WeightInit</code><code class="p">]</code>
<code class="linenos">12 </code>           <code class="p">[</code><code class="nv">org.nd4j.linalg.activations</code> <code class="nv">Activation</code><code class="p">]</code>
<code class="linenos">13 </code>           <code class="p">[</code><code class="nv">org.nd4j.linalg.lossfunctions</code>
<code class="linenos">14 </code>            <code class="nv">LossFunctions$LossFunction</code><code class="p">]</code>
<code class="linenos">15 </code>           <code class="p">[</code><code class="nv">org.deeplearning4j.optimize.listeners</code>
<code class="linenos">16 </code>            <code class="nv">ScoreIterationListener</code><code class="p">]</code>
<code class="linenos">17 </code>           <code class="p">[</code><code class="nv">org.deeplearning4j.nn.multilayer</code>
<code class="linenos">18 </code>            <code class="nv">MultiLayerNetwork</code><code class="p">]</code>
<code class="linenos">19 </code>           <code class="p">[</code><code class="nv">java.io</code> <code class="nv">File</code><code class="p">]</code>
<code class="linenos">20 </code>           <code class="p">[</code><code class="nv">org.nd4j.linalg.learning.config</code> <code class="nv">Adam</code> <code class="nv">Sgd</code>
<code class="linenos">21 </code>            <code class="nv">AdaDelta</code> <code class="nv">AdaGrad</code> <code class="nv">AdaMax</code> <code class="nv">Nadam</code> <code class="nv">NoOp</code><code class="p">]))</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="p">(</code><code class="k">def </code><code class="nv">numHidden</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">24 </code><code class="p">(</code><code class="k">def </code><code class="nv">numOutputs</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">25 </code><code class="p">(</code><code class="k">def </code><code class="nv">batchSize</code> <code class="mi">64</code><code class="p">)</code>
<code class="linenos">26 </code>
<code class="linenos">27 </code><code class="p">(</code><code class="k">def </code><code class="nv">initial-seed</code> <code class="p">(</code><code class="nb">long </code><code class="mi">33117</code><code class="p">))</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code><code class="p">(</code><code class="k">def </code><code class="nv">numInputs</code> <code class="mi">9</code><code class="p">)</code>
<code class="linenos">30 </code><code class="p">(</code><code class="k">def </code><code class="nv">labelIndex</code> <code class="mi">9</code><code class="p">)</code>
<code class="linenos">31 </code><code class="p">(</code><code class="k">def </code><code class="nv">numClasses</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code>
<code class="linenos">34 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code>
<code class="linenos">35 </code>  <code class="s">"Using DL4J with Wisconsin data"</code>
<code class="linenos">36 </code>  <code class="p">[</code><code class="o">&amp;</code> <code class="nv">args</code><code class="p">]</code>
<code class="linenos">37 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">recordReader</code> <code class="p">(</code><code class="k">new </code><code class="nv">CSVRecordReader</code><code class="p">)</code>
<code class="linenos">38 </code>        <code class="nv">_</code> <code class="p">(</code><code class="k">. </code><code class="nv">recordReader</code>
<code class="linenos">39 </code>            <code class="nv">initialize</code>
<code class="linenos">40 </code>            <code class="p">(</code><code class="k">new </code><code class="nv">FileSplit</code>
<code class="linenos">41 </code>             <code class="p">(</code><code class="k">new </code><code class="nv">File</code> <code class="s">"data/"</code>, <code class="s">"training.csv"</code><code class="p">)))</code>
<code class="linenos">42 </code>        <code class="nv">trainIter</code>
<code class="linenos">43 </code>        <code class="p">(</code><code class="k">new </code><code class="nv">RecordReaderDataSetIterator</code>
<code class="linenos">44 </code>          <code class="nv">recordReader</code> <code class="nv">batchSize</code> <code class="nv">labelIndex</code> <code class="nv">numClasses</code><code class="p">)</code>
<code class="linenos">45 </code>        <code class="nv">recordReaderTest</code> <code class="p">(</code><code class="k">new </code><code class="nv">CSVRecordReader</code><code class="p">)</code>
<code class="linenos">46 </code>        <code class="nv">_</code> <code class="p">(</code><code class="k">. </code><code class="nv">recordReaderTest</code>
<code class="linenos">47 </code>            <code class="nv">initialize</code>
<code class="linenos">48 </code>             <code class="p">(</code><code class="k">new </code><code class="nv">FileSplit</code>
<code class="linenos">49 </code>              <code class="p">(</code><code class="k">new </code><code class="nv">File</code> <code class="s">"data/"</code>, <code class="s">"testing.csv"</code><code class="p">)))</code>
<code class="linenos">50 </code>        <code class="nv">testIter</code>
<code class="linenos">51 </code>        <code class="p">(</code><code class="k">new </code><code class="nv">RecordReaderDataSetIterator</code>
<code class="linenos">52 </code>           <code class="nv">recordReaderTest</code> <code class="nv">batchSize</code> <code class="nv">labelIndex</code>
<code class="linenos">53 </code>           <code class="nv">numClasses</code><code class="p">)</code>
<code class="linenos">54 </code>        <code class="nv">conf</code> <code class="p">(</code><code class="nf">-&gt;</code>
<code class="linenos">55 </code>               <code class="p">(</code><code class="k">new </code><code class="nv">NeuralNetConfiguration$Builder</code><code class="p">)</code>
<code class="linenos">56 </code>               <code class="p">(</code><code class="nf">.seed</code> <code class="nv">initial-seed</code><code class="p">)</code>
<code class="linenos">57 </code>               <code class="p">(</code><code class="nf">.activation</code> <code class="nv">Activation/TANH</code><code class="p">)</code>
<code class="linenos">58 </code>               <code class="p">(</code><code class="nf">.weightInit</code> <code class="p">(</code><code class="nf">WeightInit/XAVIER</code><code class="p">))</code>
<code class="linenos">59 </code>               <code class="p">(</code><code class="nf">.updater</code> <code class="p">(</code><code class="k">new </code><code class="nv">Sgd</code> <code class="mf">0.1</code><code class="p">))</code>
<code class="linenos">60 </code>               <code class="p">(</code><code class="nf">.l2</code> <code class="mi">1</code><code class="nv">e-4</code><code class="p">)</code>
<code class="linenos">61 </code>               <code class="p">(</code><code class="nf">.list</code><code class="p">)</code>
<code class="linenos">62 </code>               <code class="p">(</code><code class="nf">.layer</code>
<code class="linenos">63 </code>                 <code class="mi">0</code>,
<code class="linenos">64 </code>                 <code class="p">(</code><code class="nb">-&gt; </code><code class="p">(</code><code class="k">new </code><code class="nv">DenseLayer$Builder</code><code class="p">)</code>
<code class="linenos">65 </code>                     <code class="p">(</code><code class="nf">.nIn</code> <code class="nv">numInputs</code><code class="p">)</code>
<code class="linenos">66 </code>                     <code class="p">(</code><code class="nf">.nOut</code> <code class="nv">numHidden</code><code class="p">)</code>
<code class="linenos">67 </code>                     <code class="p">(</code><code class="nf">.build</code><code class="p">)))</code>
<code class="linenos">68 </code>               <code class="p">(</code><code class="nf">.layer</code>
<code class="linenos">69 </code>                 <code class="mi">1</code>,
<code class="linenos">70 </code>                 <code class="p">(</code><code class="nb">-&gt; </code><code class="p">(</code><code class="k">new </code><code class="nv">OutputLayer$Builder</code>
<code class="linenos">71 </code>                       <code class="nv">LossFunctions$LossFunction/MCXENT</code><code class="p">)</code>
<code class="linenos">72 </code>                     <code class="p">(</code><code class="nf">.nIn</code> <code class="nv">numHidden</code><code class="p">)</code>
<code class="linenos">73 </code>                     <code class="p">(</code><code class="nf">.nOut</code> <code class="nv">numClasses</code><code class="p">)</code>
<code class="linenos">74 </code>                     <code class="p">(</code><code class="nf">.activation</code> <code class="nv">Activation/SOFTMAX</code><code class="p">)</code>
<code class="linenos">75 </code>                     <code class="p">(</code><code class="nf">.build</code><code class="p">)))</code>
<code class="linenos">76 </code>               <code class="p">(</code><code class="nf">.build</code><code class="p">))</code>
<code class="linenos">77 </code>        <code class="nv">model</code> <code class="p">(</code><code class="k">new </code><code class="nv">MultiLayerNetwork</code> <code class="nv">conf</code><code class="p">)</code>
<code class="linenos">78 </code>        <code class="nv">score-listener</code> <code class="p">(</code><code class="nf">ScoreIterationListener.</code> <code class="mi">100</code><code class="p">)]</code>
<code class="linenos">79 </code>    <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">init</code><code class="p">)</code>
<code class="linenos">80 </code>    <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">setListeners</code> <code class="p">(</code><code class="nb">list </code><code class="nv">score-listener</code><code class="p">))</code>
<code class="linenos">81 </code>    <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">fit</code> <code class="nv">trainIter</code> <code class="mi">10</code><code class="p">)</code>
<code class="linenos">82 </code>    <code class="p">(</code><code class="nf">while</code> <code class="p">(</code><code class="k">. </code><code class="nv">testIter</code> <code class="nv">hasNext</code><code class="p">)</code>
<code class="linenos">83 </code>      <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">ds</code> <code class="p">(</code><code class="k">. </code><code class="nv">testIter</code> <code class="nv">next</code><code class="p">)</code>
<code class="linenos">84 </code>            <code class="nv">features</code> <code class="p">(</code><code class="k">. </code><code class="nv">ds</code> <code class="nv">getFeatures</code><code class="p">)</code>
<code class="linenos">85 </code>            <code class="nv">labels</code> <code class="p">(</code><code class="k">. </code><code class="nv">ds</code> <code class="nv">getLabels</code><code class="p">)</code>
<code class="linenos">86 </code>            <code class="nv">predicted</code> <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">output</code> <code class="nv">features</code> <code class="nv">false</code><code class="p">)]</code>
<code class="linenos">87 </code>        <code class="c1">;; 26 test samples in data/testing.csv:</code>
<code class="linenos">88 </code>        <code class="p">(</code><code class="nb">doseq </code><code class="p">[</code><code class="nv">i</code> <code class="p">(</code><code class="nb">range </code><code class="mi">0</code> <code class="mi">52</code> <code class="mi">2</code><code class="p">)]</code>
<code class="linenos">89 </code>          <code class="p">(</code><code class="nf">println</code>
<code class="linenos">90 </code>            <code class="s">"desired output: ["</code> <code class="p">(</code><code class="k">. </code><code class="nv">labels</code> <code class="nv">getDouble</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">91 </code>            <code class="p">(</code><code class="k">. </code><code class="nv">labels</code> <code class="nv">getDouble</code> <code class="p">(</code><code class="nb">+ </code><code class="nv">i</code> <code class="mi">1</code><code class="p">))</code> <code class="s">"]"</code>
<code class="linenos">92 </code>            <code class="s">"predicted output: ["</code>
<code class="linenos">93 </code>            <code class="p">(</code><code class="k">. </code><code class="nv">predicted</code> <code class="nv">getDouble</code> <code class="nv">i</code><code class="p">)</code>
<code class="linenos">94 </code>            <code class="p">(</code><code class="k">. </code><code class="nv">predicted</code> <code class="nv">getDouble</code> <code class="p">(</code><code class="nb">+ </code><code class="nv">i</code> <code class="mi">1</code><code class="p">))</code> <code class="s">"]"</code><code class="p">))))))</code>
</pre></div>

</figure>

<p>Notice that we have separate training and testing data sets. It is very important to not use training data for testing because performance on recognizing training data should always be good assuming that you have enough memory capacity in a network (i.e., enough hidden units and enough neurons in each hidden layer).</p>

<p>The following program output shows the target (correct output) and the output predicted by the trained model:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>target: [ 0.0 1.0 ] predicted : [ 0.16 0.84 ]
target: [ 0.0 1.0 ] predicted : [ 0.39 0.61 ]
target: [ 1.0 0.0 ] predicted : [ 0.91 0.09 ]
target: [ 0.0 1.0 ] predicted : [ 0.16 0.84 ]
target: [ 1.0 0.0 ] predicted : [ 0.96 0.04 ]
target: [ 1.0 0.0 ] predicted : [ 0.95 0.05 ]
target: [ 1.0 0.0 ] predicted : [ 0.95 0.05 ]
target: [ 0.0 1.0 ] predicted : [ 0.21 0.79 ]
target: [ 1.0 0.0 ] predicted : [ 0.94 0.06 ]
target: [ 1.0 0.0 ] predicted : [ 0.92 0.08 ]
target: [ 0.0 1.0 ] predicted : [ 0.16 0.84 ]
target: [ 1.0 0.0 ] predicted : [ 0.94 0.06 ]
target: [ 0.0 1.0 ] predicted : [ 0.16 0.84 ]
target: [ 1.0 0.0 ] predicted : [ 0.96 0.04 ]
target: [ 0.0 1.0 ] predicted : [ 0.17 0.83 ]
target: [ 0.0 1.0 ] predicted : [ 0.17 0.83 ]
target: [ 0.0 1.0 ] predicted : [ 0.16 0.84 ]
target: [ 0.0 1.0 ] predicted : [ 0.16 0.84 ]
target: [ 1.0 0.0 ] predicted : [ 0.95 0.05 ]
target: [ 1.0 0.0 ] predicted : [ 0.94 0.06 ]
target: [ 1.0 0.0 ] predicted : [ 0.92 0.08 ]
target: [ 1.0 0.0 ] predicted : [ 0.96 0.04 ]
</pre></div>

</figure>

<p>This is a simple example but is hopefully sufficient to get you started if you want to use DL4J in your Clojure projects. An alternative approach would be writing your model code in Java and embedding the Java code in your Clojure projects - we will see examples of this in later chapters.</p>

<h3 id="leanpub-auto-optional-material-documentation-for-other-types-of-deeplearning4j-built-in-layers">Optional Material: Documentation For Other Types of DeepLearning4J Built In Layers</h3>

<p>The <a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/package-tree.html">documentation for the built in layer classes in DL4J</a> is probably more than you need for now so let’s review the most other types of layers that I sometimes use. In the simple example we used in the last section we used two types of layers:</p>

<ul>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/DenseLayer.html">org.deeplearning4j.nn.conf.layers.DenseLayer</a> - maintains connections to all neurons in the previous and next layer, or it is “fully connected.”</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/OutputLayer.html">org.deeplearning4j.nn.conf.layers.OutputLayer</a> - has built in behavior for starting the back propagation calculations back through previous layers.</li>
</ul>

<p>As you build more deep learning enabled applications, depending on what requirements you have, you will likely need to use at least some of the following Dl4J layer classes:</p>

<ul>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/AutoEncoder.html">org.deeplearning4j.nn.conf.layers.AutoEncoder</a> - often used to remove noise from data. Autoencoders work by making the target training output values equal to the input training values while reducing the number of neurons in the AutoEncoding layer. The layer learns a concise representation of data, or “generalizes” data by learning which features are important.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/CapsuleLayer.html">org.deeplearning4j.nn.conf.layers.CapsuleLayer</a> - Capsule networks are an attempt to be more efficient versions of convolutional models. Convolutional networks discard position information of detected features while capsule models maintain and use this information.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Convolution1DLayer.html">org.deeplearning4j.nn.conf.layers.Convolution1D</a> - one dimensional convolutional layers learn one dimensional feature detectors. Trained layers learn to recognize features but discard the information of where the feature is located. These are often used for data input streams like signal data and word tokens in natural language processing.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Convolution2D.html">org.deeplearning4j.nn.conf.layers.Convolution2D</a> - two dimensional convolutional layers learn two dimensional feature detectors. Trained layers learn to recognize features but discard the information of where the feature is located. These are often used for recognizing if a type of object appears inside a picture. Note that features, for example representing a nose or a mouth, are recognized but their location in an input picture does not matter. For example, you could cut up an image of someone’s face, moving the ears to the picture center, the mouth to the upper left corner, etc., and the picture would still be predicted to contain a face with some probability because using soft max output layers produces class labels that can be interpreted as probabilities since the values over all output classes sum to the value 1.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/EmbeddingLayer.html">org.deeplearning4j.nn.conf.layers.EmbeddingLayer</a> - embedding layers are used to transform input data into integer data. My most frequent use of embedding layers is word embedding where each word in training data is assigned an integer value. This data can be “one hot encoded” and in the case of processing words, if there are 5000 unique words in the training data for a classifier, then the embedding layer would have 5001 neurons, one for each word and one to represent all words not in the training data. If the word index (indexing is zero-based) is, for example 117, then the activation value for neuron at index 117 is set to one and all others in the layer are set to zero.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/FeedForwardLayer.html">org.deeplearning4j.nn.conf.layers.FeedForwardLayer</a> - this is a super class for most specialized types of feed forward layers so reading through the class reference is recommended.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/DropoutLayer.html">org.deeplearning4j.nn.conf.layers.DropoutLayer</a> - dropout layers are very useful for preventing learning new input patterns from making the network forget previously learned patterns. For each training batch, some fraction of neurons in a dropout layer are turned off and don’t update their weights during a training batch cycle. The development of using dropout was key historically for getting deep learning networks to work with many layers and large amounts of training data.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/LSTM.html">org.deeplearning4j.nn.conf.layers.LSTM</a> - LSTM layers are used to extend the temporal memory of what a layer can remember. LSTM are a refinement of RNN models that use an input window to pass through a data stream and the RNN model can only use what is inside this temporal sampling window.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Pooling1D.html">org.deeplearning4j.nn.conf.layers.Pooling1D</a> - a one dimensional pooling layer transforms a longer input to a shorter output by downsampling, i.e., there are fewer output connections than input connections.</li>
  <li>
<a href="https://deeplearning4j.org/api/latest/org/deeplearning4j/nn/conf/layers/Pooling2D.html">org.deeplearning4j.nn.conf.layers.Pooling2D</a> - a two dimensional pooling layer transforms a larger two dimensional array of data input to a smaller output two dimensional array by downsampling.</li>
</ul>

<h3 id="leanpub-auto-deep-learning-wrap-up">Deep Learning Wrap Up</h3>

<p>I first used neural networks in the late 1980s for phoneme (speech) recognition, specifically using time delay neural networks and I gave a talk about it at <a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp?reload=true&amp;arnumber=4307059">IEEE First Annual International Conference on Neural Networks San Diego, California June 21-24, 1987</a>. In the following year I wrote the Backpropagation neural network code that my company used in a bomb detector that we built for the FAA. Back then, neural networks were not widely accepted but in the present time Google, Microsoft, and many other companies are using deep learning for a wide range of practical problems. Exciting work is also being done in the field of natural language processing.</p>

<p>Later we will look at an example calling directly out to Python code using the <strong>libpython-clj</strong> library to use the spaCy natural language processing library. You can also use the <strong>libpython-clj</strong> library to access libraries like TensorFlow, PyTorch, etc. in your Clojure applications.</p>


<h2 id="opennlp">Natural Language Processing Using OpenNLP</h2>

<p>Here we use the <a href="https://opennlp.apache.org">Apache OpenNLP project</a> written in Java. OpenNLP has pre-trained models for tokenization, sentence segmentation, part-of-speech tagging, named entity extraction, chunking, parsing, and coreference resolution. Here we use a subset of OpenNLP’s functionality. My Java AI book has a more complete treatment, including building custom classification models and performing chunk-parsing of sentence structure.</p>

<p>Currently, OpenNLP has support for Danish, German, English, Spanish, Portuguese, and Swedish. I include in the github repository pre-trained models for English in the directory <strong>models</strong>.</p>

<h3 id="leanpub-auto-using-the-clojure-and-java-wrappers-for-opennlp">Using the Clojure and Java Wrappers for OpenNLP</h3>

<p>I won’t list the simple Java wrapper code in the directory <strong>src-java</strong> here. You might want to open the files <strong>NLP.java</strong> and <strong>Pair.java</strong> for reference:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>src-java
└── main
    ├── java
    │   └── com
    │       └── markwatson
    │           └── opennlp
    │               ├── NLP.java
    │               └── Pair.java
    └── resources
        └── log4j.xml
</pre></div>

</figure>

<p>The <strong>project.clj</strong> file shows the setup for incorporating Java code into a Clojure project:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="kd">defproject </code><code class="nv">opennlp-clj</code> <code class="s">"0.1.0-SNAPSHOT"</code>
  <code class="ss">:description</code> <code class="s">"Example using OpenNLP with Clojure"</code>
  <code class="ss">:url</code> <code class="s">"http://markwatson.com"</code>
  <code class="ss">:license</code>
  <code class="p">{</code><code class="ss">:name</code>
   <code class="s">"EPL-2.0 OR GPL-2+ WITH Classpath-exception-2.0"</code>
   <code class="ss">:url</code> <code class="s">"https://www.eclipse.org/legal/epl-2.0/"</code><code class="p">}</code>
  <code class="ss">:source-paths</code>      <code class="p">[</code><code class="s">"src"</code><code class="p">]</code>
  <code class="ss">:java-source-paths</code> <code class="p">[</code><code class="s">"src-java"</code><code class="p">]</code>
  <code class="ss">:javac-options</code>     <code class="p">[</code><code class="s">"-target"</code> <code class="s">"1.8"</code> <code class="s">"-source"</code> <code class="s">"1.8"</code><code class="p">]</code>

  <code class="ss">:dependencies</code> <code class="p">[[</code><code class="nv">org.clojure/clojure</code> <code class="s">"1.10.1"</code><code class="p">]</code>
                 <code class="c1">;from my Java AI book:</code>
                 <code class="c1">;[com.markwatson/opennlp "1.0-SNAPSHOT"]</code>
                 <code class="p">[</code><code class="nv">opennlp/tools</code> <code class="s">"1.5.0"</code><code class="p">]]</code>
  <code class="ss">:repl-options</code> <code class="p">{</code><code class="ss">:init-ns</code> <code class="nv">opennlp-clj.core</code><code class="p">})</code>
</pre></div>

</figure>

<p>Note the use of <strong>:java-source-paths</strong> to specify where the Java codes are stored in the project. When you use <strong>lein run</strong> to try the example, both the Java and Clojure code are compiled. When I first wrote this example, I used the maven output target for the OpenNLP example in my Java AI book. I left the dependency in this <strong>project.clj</strong> file commented out and instead added the two Java source files to this project. Copying the code into this project should make it easier for you to run this example.</p>

<p>In the following listing notice that I have two versions of tokenization functions:<strong>tokenize-&gt;java</strong> returns Java data structures and<strong>tokenize-&gt;seq</strong> returns a Clojure <strong>seq</strong>. The other example wrapper functions take a Java array of tokens as an argument.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">opennlp-clj.core</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:import</code> <code class="p">(</code><code class="nf">com.markwatson.opennlp</code> <code class="nv">NLP</code><code class="p">)))</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">sentence-splitter</code>
<code class="linenos"> 5 </code>  <code class="s">"tokenize entire sentences"</code>
<code class="linenos"> 6 </code>  <code class="p">[</code><code class="nv">string-input</code><code class="p">]</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nf">NLP/sentenceSplitter</code> <code class="nv">string-input</code><code class="p">)))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">tokenize-&gt;seq</code>
<code class="linenos">10 </code>  <code class="s">"tokenize words to Clojure seq"</code>
<code class="linenos">11 </code>  <code class="p">[</code><code class="nv">string-input</code><code class="p">]</code>
<code class="linenos">12 </code>  <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nf">NLP/tokenize</code> <code class="nv">string-input</code><code class="p">)))</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">tokenize-&gt;java</code>
<code class="linenos">15 </code>  <code class="s">"tokenize words to Java array"</code>
<code class="linenos">16 </code>  <code class="p">[</code><code class="nv">string-input</code><code class="p">]</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="nf">NLP/tokenize</code> <code class="nv">string-input</code><code class="p">))</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="c1">;; Word analysis:</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">POS</code>
<code class="linenos">22 </code>  <code class="s">"part of speech"</code>
<code class="linenos">23 </code>  <code class="p">[</code><code class="nv">java-token-array</code><code class="p">]</code>
<code class="linenos">24 </code>  <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nf">NLP/POS</code> <code class="nv">java-token-array</code><code class="p">)))</code>
<code class="linenos">25 </code>
<code class="linenos">26 </code><code class="c1">;; Entities:</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">company-names</code>
<code class="linenos">29 </code>  <code class="p">[</code><code class="nv">java-token-array</code><code class="p">]</code>
<code class="linenos">30 </code>  <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nf">NLP/companyNames</code> <code class="nv">java-token-array</code><code class="p">)))</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">location-names</code>
<code class="linenos">33 </code>  <code class="p">[</code><code class="nv">java-token-array</code><code class="p">]</code>
<code class="linenos">34 </code>  <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nf">NLP/locationNames</code> <code class="nv">java-token-array</code><code class="p">)))</code>
<code class="linenos">35 </code>
<code class="linenos">36 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">person-names</code>
<code class="linenos">37 </code>  <code class="p">[</code><code class="nv">java-token-array</code><code class="p">]</code>
<code class="linenos">38 </code>  <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nf">NLP/personNames</code> <code class="nv">java-token-array</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Here I tokenize text into a Java array that is used to call the Java OpenNLP code (in the directory <strong>src-java</strong>). The first operation that you will usually start with for processing natural language text is breaking input text into individual words and sentences.</p>

<p>The test code for this project shows how to use these APIs:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">opennlp-clj.core-test</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.test</code> <code class="ss">:as</code> <code class="nv">test</code><code class="p">])</code>
<code class="linenos"> 3 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">opennlp-clj.core</code> <code class="ss">:as</code> <code class="nv">onlp</code><code class="p">]))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nf">def</code>
<code class="linenos"> 6 </code>  <code class="nv">test-text</code>
<code class="linenos"> 7 </code>  <code class="s">"The cat chased the mouse around the tree while Mary Sm\</code>
<code class="linenos"> 8 </code><code class="s">ith (who works at IBM in San Francisco) watched."</code><code class="p">)</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="nf">test/deftest</code> <code class="nv">pos-test</code>
<code class="linenos">11 </code>  <code class="p">(</code><code class="nf">test/testing</code> <code class="s">"parts of speech"</code>
<code class="linenos">12 </code>    <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">token-java-array</code> <code class="p">(</code><code class="nf">onlp/tokenize-&gt;java</code> <code class="nv">test-text</code><code class="p">)</code>
<code class="linenos">13 </code>          <code class="nv">token-clojure-seq</code> <code class="p">(</code><code class="nf">onlp/tokenize-&gt;seq</code> <code class="nv">test-text</code><code class="p">)</code>
<code class="linenos">14 </code>          <code class="nv">words-pos</code> <code class="p">(</code><code class="nf">onlp/POS</code> <code class="nv">token-java-array</code><code class="p">)</code>
<code class="linenos">15 </code>          <code class="nv">companies</code> <code class="p">(</code><code class="nf">onlp/company-names</code> <code class="nv">token-java-array</code><code class="p">)</code>
<code class="linenos">16 </code>          <code class="nv">places</code> <code class="p">(</code><code class="nf">onlp/location-names</code> <code class="nv">token-java-array</code><code class="p">)</code>
<code class="linenos">17 </code>          <code class="nv">people</code> <code class="p">(</code><code class="nf">onlp/person-names</code> <code class="nv">token-java-array</code><code class="p">)]</code>
<code class="linenos">18 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"Input text:\n"</code> <code class="nv">test-text</code><code class="p">)</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"Tokens as Java array:\n"</code> <code class="nv">token-java-array</code><code class="p">)</code>
<code class="linenos">20 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"Tokens as Clojure seq:\n"</code>
<code class="linenos">21 </code>               <code class="nv">token-clojure-seq</code><code class="p">)</code>
<code class="linenos">22 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"Part of speech tokens:\n"</code> <code class="nv">words-pos</code><code class="p">)</code>
<code class="linenos">23 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"Companies:\n"</code> <code class="nv">companies</code><code class="p">)</code>
<code class="linenos">24 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"Places:\n"</code> <code class="nv">places</code><code class="p">)</code>
<code class="linenos">25 </code>      <code class="p">(</code><code class="nb">println </code><code class="s">"People:\n"</code> <code class="nv">people</code><code class="p">)</code>
<code class="linenos">26 </code>      <code class="p">(</code><code class="nf">test/is</code> <code class="p">(</code><code class="nb">= </code><code class="p">(</code><code class="nb">first </code><code class="nv">words-pos</code><code class="p">)</code> <code class="s">"DT"</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>Here is the test output:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>Input text:
The cat chased the mouse around the tree while Mary Smith\
 (who works at IBM in San Francisco) watched.
Tokens as Java array:
 #object[[Ljava.lang.String; 0x2f04105 [Ljava.lang.String\
;@2f04105]
Tokens as Clojure seq:
 (The cat chased the mouse around the tree while Mary Smi\
th ( who works at IBM in San Francisco ) watched .)
Part of speech tokens:
 (DT NN VBD DT NN IN DT NN IN NNP NNP -LRB- WP VBZ IN NNP\
 IN NNP NNP -RRB- VBD .)
Companies:
 (IBM)
Places:
 (San Francisco)
People:
 (Mary Smith)
</pre></div>

</figure>

<p>The part of speech tokens like DT (determiner), NN (noun), etc. are defined in the README file for this project.</p>

<p><strong>Note:</strong> my Java AI book covers OpenNLP in more depth, including how to train your own classification models.</p>

<p>We take a different approach to NLP in the next chapter: using the <strong>libpython-clj</strong> library to call Python NLP libraries and pre-trained deep learning models. The Python models have more functionality but the OpenNLP library is much easier to setup and use with Clojure.</p>


<h2 id="libpython">Python/Clojure Interoperation Using the libpython-clj Library</h2>

<p>In the last chapter we used the Java OpenNLP library for natural language processing (NLP). Here we take an alternative approach of using the <strong>libpython-clj</strong> library to access the <a href="https://spacy.io">spaCy</a> NLP library implemented in Python (and the embedded compiled code written in FORTRAN and C/C++). The <strong>libpython-clj</strong> library can also be used to tap into the wealth of deep learning and numerical computation libraries written in Python. See the file <strong>INSTALL_MLW.txt</strong> for project dependencies.</p>

<p>This example also uses the <a href="https://huggingface.co/transformers/">Hugging Face Transformer models</a> for NLP question answering.</p>

<p>To get started using <strong>libpython-clj</strong> I want to direct you toward two resources that you will want to familiarize yourself with:</p>

<ul>
  <li><a href="https://github.com/clj-python/libpython-clj">libpython-clj GitHub repository</a></li>
  <li><a href="https://github.com/gigasquid/libpython-clj-examples">Carin Meier’s libpython-clj examples GitHub repository</a></li>
</ul>

<p>I suggest bookmarking the <strong>libpython-clj</strong> GitHub repository for reference and treat Carin Meier’s <strong>libpython-clj</strong> examples as your main source for using a wide variety of Python libraries with <strong>libpython-clj</strong>.</p>

<h3 id="leanpub-auto-using-spacy-for-natural-language-processing">Using spaCy for Natural Language Processing</h3>

<p><strong>spaCy</strong> is a great library that is likely all you need for processing text and NLP. <strong>spaCy</strong> is written in Python and in the past for accessing <strong>spaCy</strong> I have used the Hy language (Clojure syntax Lisp that sits on top of Python), used the <strong>py4cl</strong> library with Common Lisp, or I just used Python. The <strong>libpython-clj</strong> library now gives me a great fourth option.</p>

<p>Let’s start by looking at example code in a REPL session and output for this example (we will implement the code later). I reformatted the following output to fit the page width:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ ~/Clojure-AI-Book-Code/nlp_libpython$ lein repl
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code>nlp-libpython-spacy.core=&gt; (def test-text "John Smith
<code class="linenos"> 4 </code>  worked for IBM in Mexico last year and earned $1
<code class="linenos"> 5 </code>  million in salary and bonuses.")
<code class="linenos"> 6 </code>#'nlp-libpython-spacy.core/test-text
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code>nlp-libpython-spacy.core=&gt; (text-&gt;entities
<code class="linenos"> 9 </code>                             test-text)
<code class="linenos">10 </code>(["John Smith" "PERSON"] ["IBM" "ORG"] ["Mexico" "GPE"]
<code class="linenos">11 </code> ["last year" "DATE"] ["$1 million" "MONEY"])
<code class="linenos">12 </code>
<code class="linenos">13 </code>nlp-libpython-spacy.core=&gt; (text-&gt;tokens-and-pos
<code class="linenos">14 </code>                             test-text)
<code class="linenos">15 </code>(["John" "PROPN"] ["Smith" "PROPN"] ["worked" "VERB"]
<code class="linenos">16 </code> ["for" "ADP"] ["IBM" "PROPN"] ["in" "ADP"]
<code class="linenos">17 </code> ["Mexico" "PROPN"] ["last" "ADJ"] ["year" "NOUN"]
<code class="linenos">18 </code> ["and" "CCONJ"] ["earned" "VERB"] ["$" "SYM"]
<code class="linenos">19 </code> ["1" "NUM"] ["million" "NUM"] ["in" "ADP"]
<code class="linenos">20 </code> ["salary" "NOUN"] ["and" "CCONJ"] ["bonuses" "NOUN"]
<code class="linenos">21 </code> ["." "PUNCT"])
<code class="linenos">22 </code>
<code class="linenos">23 </code>nlp-libpython-spacy.core=&gt; (text-&gt;pos test-text)
<code class="linenos">24 </code>("PROPN" "PROPN" "VERB" "ADP" "PROPN" "ADP" "PROPN"
<code class="linenos">25 </code> "ADJ" "NOUN" "CCONJ" "VERB" "SYM" "NUM" "NUM"
<code class="linenos">26 </code> "ADP" "NOUN" "CCONJ" "NOUN" "PUNCT")
<code class="linenos">27 </code>
<code class="linenos">28 </code>nlp-libpython-spacy.core=&gt; (text-&gt;tokens test-text)
<code class="linenos">29 </code>("John" "Smith" "worked" "for" "IBM" "in" "Mexico"
<code class="linenos">30 </code> "last" "year" "and" "earned" "$" "1" "million"
<code class="linenos">31 </code> "in" "salary" "and" "bonuses" ".")
</pre></div>

</figure>

<p>The part of speech tokens are defined in the repository directory for the last chapter in the file <strong>nlp_opennlp/README.md</strong>.</p>

<h3 id="leanpub-auto-using-the-hugging-face-transformer-models-for-question-answering">Using the Hugging Face Transformer Models for Question Answering</h3>

<p>Deep learning NLP libraries like BERT and and other types of Transformer models have changed the landscape for applications like translation and question answering. Here we use a Hugging Face Transformer Model to answer questions when provided with a block of text that contains the answer to the questions. Before looking at the code for this example, let’s look at how it is used:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">lp</code><code class="o">-</code><code class="nv">libpython</code><code class="o">-</code><code class="nv">spacy</code>.<code class="nv">core</code><code class="o">=&gt;</code> <code class="ss">(</code><code class="nv">def</code> <code class="nv">context</code><code class="o">-</code><code class="nv">text</code> <code class="s2">"</code><code class="s">Since last</code>
<code class="linenos"> 2 </code>   <code class="nv">year</code>, <code class="nv">Bill</code> <code class="nv">lives</code> <code class="nv">in</code> <code class="nv">Seattle</code>. <code class="nv">He</code> <code class="nv">likes</code> <code class="nv">to</code> <code class="nv">skateboard</code>.<code class="s2">"</code><code class="s">)</code>
<code class="linenos"> 3 </code>#<code class="s1">'</code><code class="s">nlp-libpython-spacy.core/context-text</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nv">nlp</code><code class="o">-</code><code class="nv">libpython</code><code class="o">-</code><code class="nv">spacy</code>.<code class="nv">core</code><code class="o">=&gt;</code> <code class="ss">(</code><code class="nv">qa</code>
<code class="linenos"> 6 </code>                             <code class="s2">"</code><code class="s">where does Bill call home?</code><code class="s2">"</code>
<code class="linenos"> 7 </code>                             <code class="nv">context</code><code class="o">-</code><code class="nv">text</code><code class="ss">)</code>
<code class="linenos"> 8 </code>{<code class="s1">'</code><code class="s">score</code><code class="s1">'</code>: <code class="mi">0</code>.<code class="mi">9626545906066895</code>, <code class="s1">'</code><code class="s">start</code><code class="s1">'</code>: <code class="mi">31</code>, <code class="s1">'</code><code class="s">end</code><code class="s1">'</code>: <code class="mi">38</code>,
<code class="linenos"> 9 </code> <code class="s1">'</code><code class="s">answer</code><code class="s1">'</code>: <code class="s1">'</code><code class="s">Seattle</code><code class="s1">'</code>}
<code class="linenos">10 </code> 
<code class="linenos">11 </code><code class="nv">nlp</code><code class="o">-</code><code class="nv">libpython</code><code class="o">-</code><code class="nv">spacy</code>.<code class="nv">core</code><code class="o">=&gt;</code> <code class="ss">(</code><code class="nv">qa</code>
<code class="linenos">12 </code>                             <code class="s2">"</code><code class="s">what does Bill enjoy?</code><code class="s2">"</code>
<code class="linenos">13 </code>                             <code class="nv">context</code><code class="o">-</code><code class="nv">text</code><code class="ss">)</code>
<code class="linenos">14 </code>{<code class="s1">'</code><code class="s">score</code><code class="s1">'</code>: <code class="mi">0</code>.<code class="mi">9084932804107666</code>, <code class="s1">'</code><code class="s">start</code><code class="s1">'</code>: <code class="mi">52</code>, <code class="s1">'</code><code class="s">end</code><code class="s1">'</code>: <code class="mi">62</code>,
<code class="linenos">15 </code> <code class="s1">'</code><code class="s">answer</code><code class="s1">'</code>: <code class="s1">'</code><code class="s">skateboard</code><code class="s1">'</code>}
</pre></div>

</figure>

<p>Nice results that show the power of using publicly available pre-trained deep learning models. Notice that the model handles equating the words “likes” with “enjoy.” Similarly, the phrase “call home” is known to be similar to the word “lives.” In traditional NLP systems, these capabilities would be handled with a synonym dictionary and a lot of custom code. By training Transformer models of (potentially) hundreds of gigabytes of text, an accurate model of natural language, grammar, synonyms, different sentence structure, etc. are handled with no extra custom code. By using word, phrase, and sentence embeddings Transformer models also learn the relationships between words including multiple word meanings.</p>

<p>Usually the context text block that contains the information to answer queries will be a few paragraphs of text. This is a simple example containing only eleven words. When I use these Transformer models at work I typically provide a few paragraphs of text, which we will also do later in this chapter when we query the public DBPedia Knowledge Graph for context text.</p>

<h3 id="leanpub-auto-combined-spacy-and-transformer-question-answering">Combined spaCy and Transformer Question Answering</h3>

<p>Let’s look at two example queries: “What is the population of Paris?” and “Where does Bill Gates Work?.” Here use both the spaCy library and the Hugging Face Transformer library. We also use some material covered in detail later in the book for accessing public Knowledge Graphs to get context text for entities found in the questions we are processing.</p>

<p>Let’s use a REPL session to see some results (the printout of the context text is abbreviated for concision). I added a debug printout to the example code to print out the context text (this debug printout is not in the repository for the book example code):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="n">lp</code><code class="o">-</code><code class="n">libpython</code><code class="o">-</code><code class="n">spacy</code><code class="p">.</code><code class="n">core</code><code class="o">=&gt;</code><code class="w"> </code><code class="p">(</code><code class="n">spacy</code><code class="o">-</code><code class="n">qa</code><code class="o">-</code><code class="n">demo</code><code class="w"></code>
<code class="linenos"> 2 </code><code class="w">   </code><code class="ss">"what is the population of Paris?"</code><code class="p">)</code><code class="w"></code>
<code class="linenos"> 3 </code><code class="o">*</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="n">context</code><code class="w"> </code><code class="nc">text</code><code class="err">:</code><code class="w"> </code><code class="n">Paris</code><code class="w"> </code><code class="p">(</code><code class="n">French</code><code class="w"> </code><code class="nl">pronunciation</code><code class="p">:</code><code class="w"> </code><code class="err">​</code><code class="o">[</code><code class="n">paʁi</code><code class="o">]</code><code class="w"> </code><code class="p">()</code><code class="err">\</code><code class="w"></code>
<code class="linenos"> 4 </code><code class="p">)</code><code class="w"> </code><code class="k">is</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="n">capital</code><code class="w"> </code><code class="ow">and</code><code class="w"> </code><code class="n">most</code><code class="w"> </code><code class="n">populous</code><code class="w"> </code><code class="n">city</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="n">France</code><code class="p">,</code><code class="w"> </code><code class="k">with</code><code class="w"> </code><code class="n">a</code><code class="err">\</code><code class="w"></code>
<code class="linenos"> 5 </code><code class="n">n</code><code class="w"> </code><code class="n">estimated</code><code class="w"> </code><code class="n">population</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="mi">150</code><code class="p">,</code><code class="mi">271</code><code class="w"> </code><code class="n">residents</code><code class="w"> </code><code class="k">as</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="mi">2020</code><code class="p">,</code><code class="err">\</code><code class="w"></code>
<code class="linenos"> 6 </code><code class="w"> </code><code class="ow">in</code><code class="w"> </code><code class="n">an</code><code class="w"> </code><code class="n">area</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="mi">105</code><code class="w"> </code><code class="nf">square</code><code class="w"> </code><code class="n">kilometres</code><code class="w"> </code><code class="p">(</code><code class="mi">41</code><code class="w"> </code><code class="nf">square</code><code class="w"> </code><code class="n">miles</code><code class="p">).</code><code class="w"> </code><code class="n">S</code><code class="err">\</code><code class="w"></code>
<code class="linenos"> 7 </code><code class="n">ince</code><code class="w"> </code><code class="n">the</code><code class="w"> </code><code class="mi">17</code><code class="n">th</code><code class="w"> </code><code class="n">century</code><code class="p">,</code><code class="w"> </code><code class="n">Paris</code><code class="w"> </code><code class="n">has</code><code class="w"> </code><code class="n">been</code><code class="w"> </code><code class="n">one</code><code class="w"> </code><code class="k">of</code><code class="w"> </code><code class="n">Europe</code><code class="s1">'s maj\</code>
<code class="linenos"> 8 </code><code class="s1">or centres of finance, diplomacy, commerce, fashion, scie\</code>
<code class="linenos"> 9 </code><code class="s1">nce and arts.</code>
<code class="linenos">10 </code><code class="s1"> The City of Paris is the centre and seat of government o\</code>
<code class="linenos">11 </code><code class="s1">f the Île-de-France, or Paris Region ...</code>
<code class="linenos">12 </code><code class="s1"> {'</code><code class="n">score</code><code class="s1">': 0.9000497460365295, '</code><code class="k">start</code><code class="s1">': 122, '</code><code class="k">end</code><code class="s1">': 131,</code>
<code class="linenos">13 </code><code class="s1">  '</code><code class="n">answer</code><code class="s1">': '</code><code class="mi">2</code><code class="p">,</code><code class="mi">150</code><code class="p">,</code><code class="mi">271</code><code class="s1">'}</code>
<code class="linenos">14 </code><code class="s1">nlp-libpython-spacy.core=&gt; (spacy-qa-demo</code>
<code class="linenos">15 </code><code class="s1">   "where does Bill Gates Work?")</code>
<code class="linenos">16 </code><code class="s1">* * context text: William Henry Gates III (born October 2\</code>
<code class="linenos">17 </code><code class="s1">8, 1955) is an American business magnate, software develo\</code>
<code class="linenos">18 </code><code class="s1">per,</code>
<code class="linenos">19 </code><code class="s1"> investor, and philanthropist. He is best known as the co\</code>
<code class="linenos">20 </code><code class="s1">-founder of Microsoft Corporation. During his career at M\</code>
<code class="linenos">21 </code><code class="s1">icro</code>
<code class="linenos">22 </code><code class="s1">soft, Gates held the positions of chairman, chief executi\</code>
<code class="linenos">23 </code><code class="s1">ve officer (CEO), president and chief software architect,\</code>
<code class="linenos">24 </code><code class="s1"> while also being the largest individual shareholder unti\</code>
<code class="linenos">25 </code><code class="s1">l May 2014. He is one of the best-known entrepreneurs and\</code>
<code class="linenos">26 </code><code class="s1"> pioneers of the microcomputer revolution of the 1970s an\</code>
<code class="linenos">27 </code><code class="s1">d 1980s.</code>
<code class="linenos">28 </code><code class="s1">{'</code><code class="n">score</code><code class="s1">': 0.3064478039741516, '</code><code class="k">start</code><code class="s1">': 213, '</code><code class="k">end</code><code class="s1">': 222,</code>
<code class="linenos">29 </code><code class="s1"> '</code><code class="n">answer</code><code class="s1">': '</code><code class="n">Microsoft</code><code class="err">'}</code><code class="w"></code>
</pre></div>

</figure>

<p>This example may take longer to run because the example code is making SPARQL queries to the DBPedia public Knowledge Graph to get context text, a topic we will cover in depth later in the book.</p>

<h3 id="leanpub-auto-using-libpython-clj-with-the-spacy-and-hugging-face-transformer-python-nlp-libraries">Using libpython-clj with the spaCy and Hugging Face Transformer Python NLP Libraries</h3>

<p>I combined the three examples we just saw in one project for this chapter. Let’s start with the project file which is largely copied from Carin Meier’s <strong>libpython-clj</strong> examples GitHub repository.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">defproject </code><code class="nv">python_interop_deeplearning</code> <code class="s">"0.1.0-SNAPSHOT"</code>
<code class="linenos"> 2 </code>  <code class="ss">:description</code>
<code class="linenos"> 3 </code>  <code class="s">"Example using libpython-clj with spaCy"</code>
<code class="linenos"> 4 </code>  <code class="ss">:url</code>
<code class="linenos"> 5 </code>  <code class="s">"https://github.com/gigasquid/libpython-clj-examples"</code>
<code class="linenos"> 6 </code>  <code class="ss">:license</code>
<code class="linenos"> 7 </code>  <code class="p">{</code><code class="ss">:name</code>
<code class="linenos"> 8 </code>   <code class="s">"EPL-2.0 OR GPL-2+ WITH Classpath-exception-2.0"</code>
<code class="linenos"> 9 </code>   <code class="ss">:url</code> <code class="s">"https://www.eclipse.org/legal/epl-2.0/"</code><code class="p">}</code>
<code class="linenos">10 </code>  <code class="ss">:jvm-opts</code> <code class="p">[</code><code class="s">"-Djdk.attach.allowAttachSelf"</code>
<code class="linenos">11 </code>             <code class="s">"-XX:+UnlockDiagnosticVMOptions"</code>
<code class="linenos">12 </code>             <code class="s">"-XX:+DebugNonSafepoints"</code><code class="p">]</code>
<code class="linenos">13 </code>    <code class="ss">:plugins</code> <code class="p">[[</code><code class="nv">lein-tools-deps</code> <code class="s">"0.4.5"</code><code class="p">]]</code>
<code class="linenos">14 </code>    <code class="ss">:middleware</code>
<code class="linenos">15 </code>    <code class="p">[</code><code class="nv">lein-tools-deps.plugin/resolve-dependencies-with-dep</code><code class="err">\</code>
<code class="linenos">16 </code><code class="nv">s-edn</code><code class="p">]</code>
<code class="linenos">17 </code>    <code class="ss">:lein-tools-deps/config</code> <code class="p">{</code><code class="ss">:config-files</code> <code class="p">[</code><code class="ss">:project</code><code class="p">]</code>
<code class="linenos">18 </code>                             <code class="ss">:resolve-aliases</code> <code class="p">[]}</code>
<code class="linenos">19 </code>    <code class="ss">:mvn/repos</code>
<code class="linenos">20 </code>    <code class="p">{</code><code class="s">"central"</code> <code class="p">{</code><code class="ss">:url</code> <code class="s">"https://repo1.maven.org/maven2/"</code><code class="p">}</code>
<code class="linenos">21 </code>     <code class="s">"clojars"</code> <code class="p">{</code><code class="ss">:url</code> <code class="s">"https://clojars.org/repo"</code><code class="p">}}</code>
<code class="linenos">22 </code>   <code class="ss">:dependencies</code> <code class="p">[[</code><code class="nv">org.clojure/clojure</code> <code class="s">"1.10.1"</code><code class="p">]</code>
<code class="linenos">23 </code>                  <code class="p">[</code><code class="nv">clj-python/libpython-clj</code> <code class="s">"1.37"</code><code class="p">]</code>
<code class="linenos">24 </code>                  <code class="p">[</code><code class="nv">clj-http</code> <code class="s">"3.10.3"</code><code class="p">]</code>
<code class="linenos">25 </code>                  <code class="p">[</code><code class="nv">com.cemerick/url</code> <code class="s">"0.1.1"</code><code class="p">]</code>
<code class="linenos">26 </code>                  <code class="p">[</code><code class="nv">org.clojure/data.csv</code> <code class="s">"1.0.0"</code><code class="p">]</code>
<code class="linenos">27 </code>                  <code class="p">[</code><code class="nv">org.clojure/data.json</code> <code class="s">"1.0.0"</code><code class="p">]]</code>
<code class="linenos">28 </code>  <code class="ss">:main</code> <code class="o">^</code><code class="ss">:skip-aot</code> <code class="nv">nlp-libpython-spacy.core</code>
<code class="linenos">29 </code>  <code class="ss">:target-path</code> <code class="s">"target/%s"</code>
<code class="linenos">30 </code>  <code class="ss">:profiles</code>
<code class="linenos">31 </code>  <code class="p">{</code><code class="ss">:uberjar</code>
<code class="linenos">32 </code>    <code class="p">{</code><code class="ss">:aot</code> <code class="ss">:all</code>
<code class="linenos">33 </code>          <code class="ss">:jvm-opts</code>
<code class="linenos">34 </code>          <code class="p">[</code><code class="s">"-Dclojure.compiler.direct-linking=true"</code><code class="p">]}})</code>
</pre></div>

</figure>

<p>Before looking at the example code, let’s go back to a REPL session to experiment with <strong>libpython-clj</strong> Python accessor functions. In the following example we call directly into the <strong>spaCy</strong> library and we use a separate Python file <strong>QA.py</strong> to wrap the Hugging Face Transformer mode. This provides you, dear reader, with examples of both techniques I use (direct calls and using separate Python wrappers). We will list the file <strong>QA.py</strong> later.</p>

<p>In lines 1-8 of the example program we set up the Clojure namespace and define  accessor functions for interacting with Python. Before we jump into the example code listing, I want to show you a few things in a REPL:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>$ lein repl
<code class="linenos">2 </code>nlp-libpython-spacy.core<code class="o">=</code>&gt; <code class="o">(</code>nlp <code class="s2">"The cat ran"</code><code class="o">)</code>
<code class="linenos">3 </code>The cat ran
<code class="linenos">4 </code>nlp-libpython-spacy.core<code class="o">=</code>&gt; <code class="o">(</code><code class="nb">type</code> <code class="o">(</code>nlp <code class="s2">"The cat ran"</code><code class="o">))</code>
<code class="linenos">5 </code>:pyobject
</pre></div>

</figure>

<p>The output on line 3 prints as a string but is really a Python object (a <strong>spaCy</strong> <strong>Document</strong>) returned as a value from the wrapped <strong>nlp</strong> function. The Python <strong>dir</strong> function prints all methods and attributes of a Python object. Here, I show only four out of the  eighty-eight methods and attributes on a <strong>spaCy</strong> <strong>Document</strong> object:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>nlp-libpython-spacy.core=&gt; (py/dir (nlp "The cat ran"))
<code class="linenos">2 </code>["__iter__" "lang" "sentiment" "text" "to_json" ...]
</pre></div>

</figure>

<p>The method <strong>__iter__</strong> is a Python iterator and allows Clojure code using <strong>libpython-clj</strong> to iterate through a Python collection using the Clojure <strong>map</strong> function as we will see in the example program. The <strong>text</strong> method returns a string representation of a <strong>spaCy</strong> <strong>Document</strong> object and we will also use <strong>text</strong> to get the print representation of <strong>spaCy</strong> <strong>Token</strong> objects.</p>

<p>Here we call two of the wrapper functions in our example:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="n">nlp</code><code class="o">-</code><code class="n">libpython</code><code class="o">-</code><code class="n">spacy</code><code class="p">.</code><code class="n">core</code><code class="o">=&gt;</code> <code class="p">(</code><code class="n">text</code><code class="o">-&gt;</code><code class="n">tokens</code> <code class="s">"the cat ran"</code><code class="p">)</code>
<code class="linenos">2 </code><code class="p">(</code><code class="s">"the"</code> <code class="s">"cat"</code> <code class="s">"ran"</code><code class="p">)</code>
<code class="linenos">3 </code><code class="n">nlp</code><code class="o">-</code><code class="n">libpython</code><code class="o">-</code><code class="n">spacy</code><code class="p">.</code><code class="n">core</code><code class="o">=&gt;</code> <code class="p">(</code><code class="n">text</code><code class="o">-&gt;</code><code class="n">tokens</code><code class="o">-</code><code class="kr">and</code><code class="o">-</code><code class="n">pos</code>
<code class="linenos">4 </code>                             <code class="s">"the cat ran"</code><code class="p">)</code>
<code class="linenos">5 </code><code class="p">([</code><code class="s">"the"</code> <code class="s">"DET"</code><code class="p">]</code> <code class="p">[</code><code class="s">"cat"</code> <code class="s">"NOUN"</code><code class="p">]</code> <code class="p">[</code><code class="s">"ran"</code> <code class="s">"VERB"</code><code class="p">])</code>
</pre></div>

</figure>

<p>Now let’s look at the listing of the example project for this chapter. The Python file <strong>QA.py</strong> loaded in line 9 will be seen later. The <strong>spaCy</strong> library requires a model file to be loaded as seen in line 11.</p>

<p>The combined demo that uses <strong>spaCY</strong>, the transformer model, and queries the public DBPedia Knowledge Graph is implemented in function <strong>spacy-qa-demo</strong> (lines 38-61). In line 49 we call a utility function <strong>dbpedia-get-entity-text-by-name</strong> that is described in a later chapter; for now it is enough to know that it uses the SPARQL query template in the file <strong>get_entity_text.sparql</strong> to get context text for an entity from DBPedia. This code is wrapped in the local function <strong>get-text-fn</strong> that is called for each entity name from in the natural language query.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">nlp-libpython-spacy.core</code>
<code class="linenos"> 2 </code>    <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">libpython-clj.require</code> <code class="ss">:refer</code>
<code class="linenos"> 3 </code>                                     <code class="p">[</code><code class="nv">require-python</code><code class="p">]]</code>
<code class="linenos"> 4 </code>              <code class="p">[</code><code class="nv">libpython-clj.python</code> <code class="ss">:as</code> <code class="nv">py</code>
<code class="linenos"> 5 </code>                                    <code class="ss">:refer</code>
<code class="linenos"> 6 </code>                                    <code class="p">[</code><code class="nv">py.</code> <code class="nv">py.-</code><code class="p">]]))</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="p">(</code><code class="nf">require-python</code> <code class="o">'</code><code class="p">[</code><code class="nv">spacy</code> <code class="ss">:as</code> <code class="nv">sp</code><code class="p">])</code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nf">require-python</code> <code class="o">'</code><code class="p">[</code><code class="nv">QA</code> <code class="ss">:as</code> <code class="nv">qa</code><code class="p">])</code> <code class="c1">;; loads the file QA.py</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="k">def </code><code class="nv">nlp</code> <code class="p">(</code><code class="nf">sp/load</code> <code class="s">"en_core_web_sm"</code><code class="p">))</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="p">(</code><code class="k">def </code><code class="nv">test-text</code> <code class="s">"John Smith worked for IBM in Mexico last \</code>
<code class="linenos">14 </code><code class="s">year and earned $1 million in salary and bonuses."</code><code class="p">)</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">text-&gt;tokens</code> <code class="p">[</code><code class="nv">text</code><code class="p">]</code>
<code class="linenos">17 </code>  <code class="p">(</code><code class="nb">map </code><code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">token</code><code class="p">]</code> <code class="p">(</code><code class="nf">py.-</code> <code class="nv">token</code> <code class="nv">text</code><code class="p">))</code>
<code class="linenos">18 </code>       <code class="p">(</code><code class="nf">nlp</code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">text-&gt;pos</code> <code class="p">[</code><code class="nv">text</code><code class="p">]</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="nb">map </code><code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">token</code><code class="p">]</code> <code class="p">(</code><code class="nf">py.-</code> <code class="nv">token</code> <code class="nv">pos_</code><code class="p">))</code>
<code class="linenos">22 </code>       <code class="p">(</code><code class="nf">nlp</code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">23 </code>  
<code class="linenos">24 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">text-&gt;tokens-and-pos</code> <code class="p">[</code><code class="nv">text</code><code class="p">]</code>
<code class="linenos">25 </code>  <code class="p">(</code><code class="nb">map </code><code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">token</code><code class="p">]</code> <code class="p">[(</code><code class="nf">py.-</code> <code class="nv">token</code> <code class="nv">text</code><code class="p">)</code> <code class="p">(</code><code class="nf">py.-</code> <code class="nv">token</code> <code class="nv">pos_</code><code class="p">)])</code>
<code class="linenos">26 </code>       <code class="p">(</code><code class="nf">nlp</code> <code class="nv">text</code><code class="p">)))</code>
<code class="linenos">27 </code>
<code class="linenos">28 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">text-&gt;entities</code> <code class="p">[</code><code class="nv">text</code><code class="p">]</code>
<code class="linenos">29 </code>  <code class="p">(</code><code class="nb">map </code><code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">entity</code><code class="p">]</code> <code class="p">(</code><code class="nf">py.-</code> <code class="nv">entity</code> <code class="nv">label_</code><code class="p">))</code>
<code class="linenos">30 </code>       <code class="p">(</code><code class="nf">py.-</code> <code class="p">(</code><code class="nf">nlp</code> <code class="nv">text</code><code class="p">)</code> <code class="nv">ents</code><code class="p">)))</code>
<code class="linenos">31 </code>
<code class="linenos">32 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">qa</code>
<code class="linenos">33 </code>  <code class="s">"Use Transformer model for question answering"</code>
<code class="linenos">34 </code>  <code class="p">[</code><code class="nv">question</code> <code class="nv">context-text</code><code class="p">]</code>
<code class="linenos">35 </code>  <code class="c1">;; prints to stdout and returns a map:</code>
<code class="linenos">36 </code>  <code class="p">(</code><code class="nf">qa/answer</code> <code class="nv">question</code> <code class="nv">context-text</code><code class="p">))</code>
<code class="linenos">37 </code>
<code class="linenos">38 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">spacy-qa-demo</code> <code class="p">[</code><code class="nv">natural-language-query</code><code class="p">]</code>
<code class="linenos">39 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">entity-map</code>
<code class="linenos">40 </code>        <code class="p">{</code><code class="s">"PERSON"</code> <code class="s">"&lt;http://dbpedia.org/ontology/Person&gt;"</code>
<code class="linenos">41 </code>         <code class="s">"ORG"</code>
<code class="linenos">42 </code>         <code class="s">"&lt;http://dbpedia.org/ontology/Organization&gt;"</code>
<code class="linenos">43 </code>         <code class="s">"GPE"</code>    <code class="s">"&lt;http://dbpedia.org/ontology/Place&gt;"</code><code class="p">}</code>
<code class="linenos">44 </code>        <code class="nv">entities</code> <code class="p">(</code><code class="nf">text-&gt;entities</code> <code class="nv">natural-language-query</code><code class="p">)</code>
<code class="linenos">45 </code>        <code class="nv">get-text-fn</code>
<code class="linenos">46 </code>        <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">entity</code><code class="p">]</code>
<code class="linenos">47 </code>          <code class="p">(</code><code class="nf">clojure.string/join</code>
<code class="linenos">48 </code>           <code class="s">" "</code>
<code class="linenos">49 </code>           <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">entity</code> <code class="nv">entities</code><code class="p">]</code>
<code class="linenos">50 </code>             <code class="p">(</code><code class="nf">kgn/dbpedia-get-entity-text-by-name</code>
<code class="linenos">51 </code>              <code class="p">(</code><code class="nb">first </code><code class="nv">entity</code><code class="p">)</code>
<code class="linenos">52 </code>              <code class="p">(</code><code class="nb">get </code><code class="nv">entity-map</code> <code class="p">(</code><code class="nb">second </code><code class="nv">entity</code><code class="p">))))))</code>
<code class="linenos">53 </code>        <code class="nv">context-text</code>
<code class="linenos">54 </code>        <code class="p">(</code><code class="nf">clojure.string/join</code>
<code class="linenos">55 </code>          <code class="s">" "</code>
<code class="linenos">56 </code>          <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">entity</code> <code class="nv">entities</code><code class="p">]</code>
<code class="linenos">57 </code>            <code class="p">(</code><code class="nf">get-text-fn</code> <code class="nv">entity</code><code class="p">)))</code>
<code class="linenos">58 </code>        <code class="nv">_</code> <code class="p">(</code><code class="nb">println </code><code class="s">"* * context text:"</code> <code class="nv">context-text</code><code class="p">)</code>
<code class="linenos">59 </code>        <code class="nv">answer</code> <code class="p">(</code><code class="nf">qa</code> <code class="nv">natural-language-query</code> <code class="nv">context-text</code><code class="p">)]</code>
<code class="linenos">60 </code>    <code class="nv">answer</code><code class="p">))</code>
<code class="linenos">61 </code>
<code class="linenos">62 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code>
<code class="linenos">63 </code>  <code class="p">[</code><code class="o">&amp;</code> <code class="nv">_</code><code class="p">]</code>
<code class="linenos">64 </code>  <code class="p">(</code><code class="nb">println </code><code class="p">(</code><code class="nf">text-&gt;entities</code> <code class="nv">test-text</code><code class="p">))</code>
<code class="linenos">65 </code>  <code class="p">(</code><code class="nb">println </code><code class="p">(</code><code class="nf">text-&gt;tokens-and-pos</code> <code class="nv">test-text</code><code class="p">))</code>
<code class="linenos">66 </code>  <code class="p">(</code><code class="nb">println </code><code class="p">(</code><code class="nf">text-&gt;pos</code> <code class="nv">test-text</code><code class="p">))</code>
<code class="linenos">67 </code>  <code class="p">(</code><code class="nb">println </code><code class="p">(</code><code class="nf">text-&gt;tokens</code> <code class="nv">test-text</code><code class="p">))</code>
<code class="linenos">68 </code>  <code class="p">(</code><code class="nf">qa</code> <code class="s">"where does Bill call home?"</code>
<code class="linenos">69 </code>      <code class="s">"Since last year, Bill lives in Seattle. He likes t\</code>
<code class="linenos">70 </code><code class="s">o skateboard."</code><code class="p">)</code>
<code class="linenos">71 </code>  <code class="p">(</code><code class="nf">qa</code> <code class="s">"what does Bill enjoy?"</code>
<code class="linenos">72 </code>      <code class="s">"Since last year, Bill lives in Seattle. He likes t\</code>
<code class="linenos">73 </code><code class="s">o skateboard."</code><code class="p">)</code>
<code class="linenos">74 </code>  <code class="p">(</code><code class="nf">spacy-qa-demo</code> <code class="s">"what is the population of Paris?"</code><code class="p">)</code>
<code class="linenos">75 </code>  <code class="p">(</code><code class="nf">spacy-qa-demo</code> <code class="s">"where does Bill Gates Work?"</code><code class="p">))</code>
</pre></div>

</figure>

<p>If you <strong>lein run</strong> to run the test <strong>-main</strong> function in lines 62-75 in the last listing, you will see the sample output that we saw earlier.</p>

<p>This example also shows how to load (see line 9 in the last listing) the local Python file <strong>QA.py</strong> and call a function defined in the file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="kn">from</code> <code class="nn">transformers</code> <code class="kn">import</code> <code class="n">pipeline</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="n">qa</code> <code class="o">=</code> <code class="n">pipeline</code><code class="p">(</code>
<code class="linenos"> 4 </code>    <code class="s2">"question-answering"</code><code class="p">,</code>
<code class="linenos"> 5 </code>    <code class="n">model</code><code class="o">=</code><code class="s2">"NeuML/bert-small-cord19-squad2"</code><code class="p">,</code>
<code class="linenos"> 6 </code>    <code class="n">tokenizer</code><code class="o">=</code><code class="s2">"NeuML/bert-small-cord19qa"</code>
<code class="linenos"> 7 </code><code class="p">)</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="k">def</code> <code class="nf">answer</code> <code class="p">(</code><code class="n">query_text</code><code class="p">,</code><code class="n">context_text</code><code class="p">):</code>
<code class="linenos">10 </code>  <code class="n">answer</code> <code class="o">=</code> <code class="n">qa</code><code class="p">({</code>
<code class="linenos">11 </code>                <code class="s2">"question"</code><code class="p">:</code> <code class="n">query_text</code><code class="p">,</code>
<code class="linenos">12 </code>                <code class="s2">"context"</code><code class="p">:</code> <code class="n">context_text</code>
<code class="linenos">13 </code>               <code class="p">})</code>
<code class="linenos">14 </code>  <code class="nb">print</code><code class="p">(</code><code class="n">answer</code><code class="p">)</code>
<code class="linenos">15 </code>  <code class="k">return</code> <code class="n">answer</code>
</pre></div>

</figure>

<p>Lines 5-6 specify names for pre-trained model files that we use. In the example repository, the file <strong>INSTALL_MLW.txt</strong> shows how I installed the dependencies for this example on a Google Cloud Platform VPS. While I sometimes use Docker for projects with custom dependencies that I don’t want to install on my laptop, I often prefer using a VPS that I can start and stop when I need it.</p>

<p>Writing a Python wrapper that is called from your Clojure code is a good approach if, for example, you had existing Python code that uses TensorFlow or PyTorch, or there was a complete application written in Python that you wanted to use from Clojure. While it is possible to do everything in Clojure calling directly into Python libraries it is sometimes simpler to write Python wrappers that define top level functions that you need in your Clojure project.</p>

<p>The material in this chapter is of particular interest to me because I use both NLP and Knowledge Graph technologies in my work. With the ability to access the Python <strong>spaCY</strong> and Hugging Face Transformer models, as well as the Java Jena library for semantic web and Knowledge Graph applications (more on this topic later), Clojure is a nice language to use for my projects.</p>


<h2 id="leanpub-auto-anomaly-detection-machine-learning-example">Anomaly Detection Machine Learning Example</h2>

<p>Anomaly detection models are used in one very specific class of use cases: when you have many negative (non-anomaly) examples and relatively few positive (anomaly) examples. We can refer to this as an unbalanced training set. To try an experiment with anomaly detection we can reuse the Wisconsin data. For training we will ignore positive examples in the original data, create a model of “how things should be,” and hopefully be able to detect anomalies different from the original negative (non-malignant) examples (i.e., data samples indicating cancer malignancy).</p>

<p>Anomaly detection is a difficult problem. The simple approach we use assumes that each data feature has a Gaussian distribution, or can be made to look like Gaussian distribution using a data transformation; this is often done by taking the logarithm of features, as needed.</p>

<p>If you have a large training set of both negative and positive examples then do not use anomaly detection models. If your training examples are balanced then use a classification model as we saw earlier in the chapter <a href="#dl4j">Deep Learning Using Deeplearning4j</a>.</p>

<h3 id="leanpub-auto-motivation-for-anomaly-detection">Motivation for Anomaly Detection</h3>

<p>When should we use anomaly detection? This is important so I am going to repeat my suggestion that you should use supervised learning algorithms like neural networks and logistic classification when there are roughly an equal number of available negative and positive examples in the training data. The University of Wisconsin cancer data set is fairly evenly split between negative and positive examples so I artificially fudged it for this example.</p>

<p>Anomaly detection should be used when you have many negative (“normal”) examples and relatively few positive (“anomaly”) examples. For the example in this chapter we will simulate scarcity of positive (“anomaly”) results by preparing the data using the Wisconsin cancer data as follows:</p>

<ul>
  <li>We will split the data into training (60%), cross validation (20%) and testing (20%).</li>
  <li>For the training data, we will discard all but two positive (“anomaly”) examples. We do this to simulate the real world test case where some positive examples are likely to end up in the training data in spite of the fact that we would prefer the training data to only contain negative (“normal”) examples.</li>
  <li>We will use the cross validation data to find a good value for the epsilon meta parameter.</li>
  <li>After we find a good epsilon value, we will calculate the F1 measurement for the model.</li>
</ul>

<h3 id="leanpub-auto-math-primer-for-anomaly-detection">Math Primer for Anomaly Detection</h3>

<p>We are trying to model “normal” behavior and we do this by taking each feature and fitting a Gaussian (bell curve) distribution to each feature. The learned parameters for a Gaussian distribution are the mean of the data (where the bell shaped curve is centered) and the variance. You might be more familiar with the term standard deviation, \(\sigma\). Variance is defined as \( \sigma ^2\).</p>

<p>We will need to calculate the probability of a value <strong>x</strong> given the mean and variance of a probability distribution: \(P(x : \mu, \sigma ^2)\) where \(\mu\) is the mean and \( \sigma ^2\)
 is the squared variance:</p>


$$
P(x : \mu, \sigma ^2) = \frac{1}{{\sigma \sqrt {2\pi } }}e^{{{ - \left( {x - \mu } \right)^2 } \mathord{\left/ {\vphantom {{ - \left( {x - \mu } \right)^2 } {2\sigma ^2 }}} \right. \kern-\nulldelimiterspace} {2\sigma ^2 }}}
$$

<p>where \(x_i\) are the samples and we can calculate the squared variance as:</p>


$$
\sigma^2 = \frac{\displaystyle\sum_{i=1}^{m}(x_i - \mu)^2} {m}
$$

<p>We calculate the parameters of \(\mu\) and \( \sigma ^2\) for each feature. A bell shaped distribution in two dimensions is easy to visualize as is an inverted bowl shape in three dimensions. What if we have many features? Well, the math works and don’t worry about not being able to picture it in your mind.</p>

<h3 id="leanpub-auto-anomalydetection-utility-class-written-in-java">AnomalyDetection Utility Class Written in Java</h3>

<p>The class <strong>AnomalyDetection</strong> (from my Java AI book) in the directory <strong>src-java</strong> is fairly general purpose. I won’t list the Java code in the file <strong>AnomalyDetection.java</strong> here but please do open it in a text editor to refer to while reading this section. This Java class processes a set of training examples and for each feature calculates \(\mu\) and \( \sigma ^2\). We are also training for a third parameter: an epsilon “cutoff” value: if for a given input vector \(P(x : \mu, \sigma ^2)\) evaluates to a value greater than epsilon then the input vector is “normal”, less than epsilon implies that the input vector is an “anomaly.” The math for calculating these three features from training data is fairly easy but the code is not: we need to organize the training data and search for a value of epsilon that minimizes the error for a cross validation data set.</p>

<p>To be clear: we separate the input examples into three separate sets of training, cross validation, and testing data. We use the training data to set the model parameters, use the cross validation data to learn an epsilon value, and finally use the testing data to get precision, recall, and F1 scores that indicate how well the model detects anomalies in data not used for training and cross validation.</p>

<p>If you are interested in the Java implementation either read the source code or for more detail read the code description in my Java AI book.</p>

<h3 id="leanpub-auto-clojure-experiment-for-the-university-of-wisconsin-cancer-data-using-java-anomaly-detection-code">Clojure Experiment for the University of Wisconsin Cancer Data Using Java Anomaly Detection Code</h3>

<p>The example in this section loads the University of Wisconsin data and uses the Java class <strong>AnomalyDetection</strong> described in the last section to find anomalies, which for this example will be input vectors that represented malignancy in the original data. We don’t train on the non-malignancy samples.</p>

<p>The Wisconsin data has 9 input features and one target output. Optionally the example program can use Incanter to plot the distribution of input variables. For of these plots are shown here:
<img src="images/wisconsin_plots.png" alt="Distributions for 4 of the 9 input features" style="width: 288px"></p>

<p>Let’s start by looking at the project file <strong>project.clj</strong>:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">defproject </code><code class="nv">anomaly_detection_clj</code> <code class="s">"0.1.0-SNAPSHOT"</code>
<code class="linenos"> 2 </code>  <code class="ss">:description</code> <code class="s">"Anomaly Detection code"</code>
<code class="linenos"> 3 </code>  <code class="ss">:url</code> <code class="s">"https://markwatson.com"</code>
<code class="linenos"> 4 </code>  <code class="ss">:license</code>
<code class="linenos"> 5 </code>  <code class="p">{</code><code class="ss">:name</code>
<code class="linenos"> 6 </code>   <code class="s">"EPL-2.0 OR GPL-2+ WITH Classpath-exception-2.0"</code>
<code class="linenos"> 7 </code>   <code class="ss">:url</code> <code class="s">"https://www.eclipse.org/legal/epl-2.0/"</code><code class="p">}</code>
<code class="linenos"> 8 </code>  <code class="ss">:dependencies</code> <code class="p">[[</code><code class="nv">org.clojure/clojure</code> <code class="s">"1.10.1"</code><code class="p">]</code>
<code class="linenos"> 9 </code>                 <code class="p">[</code><code class="nv">org.apache.commons/commons-io</code> <code class="s">"1.3.2"</code><code class="p">]</code>
<code class="linenos">10 </code>                 <code class="p">[</code><code class="nv">org.clojure/data.csv</code> <code class="s">"1.0.0"</code><code class="p">]</code>
<code class="linenos">11 </code>                 <code class="p">[</code><code class="nv">incanter</code> <code class="s">"1.9.3"</code><code class="p">]]</code>
<code class="linenos">12 </code>  <code class="ss">:source-paths</code>      <code class="p">[</code><code class="s">"src"</code><code class="p">]</code>
<code class="linenos">13 </code>  <code class="ss">:java-source-paths</code> <code class="p">[</code><code class="s">"src-java"</code><code class="p">]</code>
<code class="linenos">14 </code>  <code class="ss">:javac-options</code>     <code class="p">[</code><code class="s">"-target"</code> <code class="s">"1.8"</code> <code class="s">"-source"</code> <code class="s">"1.8"</code><code class="p">]</code>
<code class="linenos">15 </code>  <code class="ss">:main</code> <code class="o">^</code><code class="ss">:skip-aot</code> <code class="nv">anomaly-detection-clj.core</code>
<code class="linenos">16 </code>  <code class="ss">:target-path</code> <code class="s">"target/%s"</code>
<code class="linenos">17 </code>  <code class="ss">:profiles</code>
<code class="linenos">18 </code>  <code class="p">{</code><code class="ss">:uberjar</code>
<code class="linenos">19 </code>      <code class="p">{</code><code class="ss">:aot</code> <code class="ss">:all</code>
<code class="linenos">20 </code>       <code class="ss">:jvm-opts</code>
<code class="linenos">21 </code>       <code class="p">[</code><code class="s">"-Dclojure.compiler.direct-linking=true"</code><code class="p">]}})</code>
</pre></div>

</figure>

<p>The example code in <strong>src/anomaly_detection/core.clj</strong> is formatted for page width in the following listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">anomaly-detection-clj.core</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:gen-class</code><code class="p">)</code>
<code class="linenos"> 3 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="nv">clojure.pprint</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">(</code><code class="nf">incanter</code> <code class="nv">core</code> <code class="nv">stats</code> <code class="nv">charts</code><code class="p">))</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.data.csv</code> <code class="ss">:as</code> <code class="nv">csv</code><code class="p">])</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.java.io</code> <code class="ss">:as</code> <code class="nv">io</code><code class="p">])</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.data.csv</code> <code class="ss">:as</code> <code class="nv">csv</code><code class="p">]))</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="p">(</code><code class="nf">import</code>
<code class="linenos">10 </code> <code class="p">(</code><code class="nf">com.markwatson.anomaly_detection</code> <code class="nv">AnomalyDetection</code><code class="p">))</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="k">def </code><code class="nv">GENERATE_PLOTS</code> <code class="nv">false</code><code class="p">)</code>
<code class="linenos">13 </code>
<code class="linenos">14 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">print-histogram</code> <code class="p">[</code><code class="nv">title</code> <code class="nv">values-2d</code> <code class="nv">index-to-display</code><code class="p">]</code>
<code class="linenos">15 </code>  <code class="p">(</code><code class="nb">println </code><code class="s">"** plotting:"</code> <code class="nv">title</code><code class="p">)</code>
<code class="linenos">16 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">column</code> <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">row</code> <code class="nv">values-2d</code><code class="p">]</code>
<code class="linenos">17 </code>                 <code class="p">(</code><code class="nb">nth </code><code class="nv">row</code> <code class="nv">index-to-display</code><code class="p">))]</code>
<code class="linenos">18 </code>    <code class="p">(</code><code class="nf">incanter.core/view</code>
<code class="linenos">19 </code>      <code class="p">(</code><code class="nf">incanter.charts/histogram</code> <code class="nv">column</code>
<code class="linenos">20 </code>                                 <code class="ss">:title</code> <code class="nv">title</code><code class="p">))))</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">data-&gt;gausian</code>
<code class="linenos">23 </code>  <code class="s">"separate labeled output and then make the data look</code>
<code class="linenos">24 </code><code class="s">   more like a Gausian (bell curve shaped) distribution"</code>
<code class="linenos">25 </code>  <code class="p">[</code><code class="nv">vector-of-numbers-as-strings</code><code class="p">]</code>
<code class="linenos">26 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">v</code> <code class="p">(</code><code class="nb">map </code><code class="nv">read-string</code> <code class="nv">vector-of-numbers-as-strings</code><code class="p">)</code>
<code class="linenos">27 </code>        <code class="nv">training-data0</code> <code class="p">(</code><code class="nf">map</code>
<code class="linenos">28 </code>                         <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">x</code><code class="p">]</code>
<code class="linenos">29 </code>                           <code class="p">(</code><code class="nf">Math/log</code>
<code class="linenos">30 </code>                             <code class="p">(</code><code class="nb">+ </code><code class="p">(</code><code class="nb">* </code><code class="mf">0.1</code> <code class="nv">x</code><code class="p">)</code> <code class="mf">1.2</code><code class="p">)))</code>
<code class="linenos">31 </code>                         <code class="p">(</code><code class="nb">butlast </code><code class="nv">v</code><code class="p">))</code>
<code class="linenos">32 </code>        <code class="c1">; target output should be [0,1] instead of [2,4]:</code>
<code class="linenos">33 </code>        <code class="nv">target-output</code> <code class="p">(</code><code class="nb">* </code><code class="mf">0.5</code> <code class="p">(</code><code class="nb">- </code><code class="p">(</code><code class="nb">last </code><code class="nv">v</code><code class="p">)</code> <code class="mi">2</code><code class="p">))</code>
<code class="linenos">34 </code>        <code class="nv">vmin</code> <code class="p">(</code><code class="nb">apply min </code><code class="nv">training-data0</code><code class="p">)</code>
<code class="linenos">35 </code>        <code class="nv">vmax</code> <code class="p">(</code><code class="nb">apply max </code><code class="nv">training-data0</code><code class="p">)</code>
<code class="linenos">36 </code>        <code class="nv">training-data</code> <code class="p">(</code><code class="nf">map</code>
<code class="linenos">37 </code>                        <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">x</code><code class="p">]</code>
<code class="linenos">38 </code>                          <code class="p">(</code><code class="nf">/</code>
<code class="linenos">39 </code>                            <code class="p">(</code><code class="nb">- </code><code class="nv">x</code> <code class="nv">vmin</code><code class="p">)</code>
<code class="linenos">40 </code>                            <code class="p">(</code><code class="nb">+ </code><code class="mf">0.0001</code> <code class="p">(</code><code class="nb">- </code><code class="nv">vmax</code> <code class="nv">vmin</code><code class="p">))))</code>
<code class="linenos">41 </code>                        <code class="nv">training-data0</code><code class="p">)]</code>
<code class="linenos">42 </code>    <code class="p">(</code><code class="nb">concat </code><code class="nv">training-data</code> <code class="p">[</code><code class="nv">target-output</code><code class="p">])))</code>
<code class="linenos">43 </code>
<code class="linenos">44 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">testAD</code> <code class="p">[]</code>
<code class="linenos">45 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">ad</code> <code class="p">(</code><code class="nf">AnomalyDetection.</code><code class="p">)</code>
<code class="linenos">46 </code>        <code class="nv">cdata</code>
<code class="linenos">47 </code>        <code class="p">(</code><code class="nf">map</code>
<code class="linenos">48 </code>          <code class="nv">data-&gt;gausian</code>
<code class="linenos">49 </code>          <code class="p">(</code><code class="nf">with-open</code>
<code class="linenos">50 </code>            <code class="p">[</code><code class="nv">reader</code>
<code class="linenos">51 </code>              <code class="p">(</code><code class="nf">io/reader</code>
<code class="linenos">52 </code>               <code class="s">"data/cleaned_wisconsin_cancer_data.csv"</code><code class="p">)]</code>
<code class="linenos">53 </code>            <code class="p">(</code><code class="nf">doall</code>
<code class="linenos">54 </code>              <code class="p">(</code><code class="nf">csv/read-csv</code> <code class="nv">reader</code><code class="p">))))]</code>
<code class="linenos">55 </code>    <code class="p">(</code><code class="k">if </code><code class="nv">GENERATE_PLOTS</code>
<code class="linenos">56 </code>      <code class="p">(</code><code class="nf">do</code>
<code class="linenos">57 </code>        <code class="p">(</code><code class="nf">print-histogram</code> <code class="s">"Clump Thickness"</code> <code class="nv">cdata</code> <code class="mi">0</code><code class="p">)</code>
<code class="linenos">58 </code>        <code class="p">(</code><code class="nf">print-histogram</code>
<code class="linenos">59 </code>          <code class="s">"Uniformity of Cell Size"</code> <code class="nv">cdata</code> <code class="mi">1</code><code class="p">)</code>
<code class="linenos">60 </code>        <code class="p">(</code><code class="nf">print-histogram</code>
<code class="linenos">61 </code>          <code class="s">"Uniformity of Cell Shape"</code> <code class="nv">cdata</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">62 </code>        <code class="p">(</code><code class="nf">print-histogram</code> <code class="s">"Marginal Adhesion"</code> <code class="nv">cdata</code> <code class="mi">3</code><code class="p">)</code>
<code class="linenos">63 </code>        <code class="p">(</code><code class="nf">print-histogram</code>
<code class="linenos">64 </code>          <code class="s">"Single Epithelial Cell Size"</code> <code class="nv">cdata</code> <code class="mi">4</code><code class="p">)</code>
<code class="linenos">65 </code>        <code class="p">(</code><code class="nf">print-histogram</code> <code class="s">"Bare Nuclei"</code> <code class="nv">cdata</code> <code class="mi">5</code><code class="p">)</code>
<code class="linenos">66 </code>        <code class="p">(</code><code class="nf">print-histogram</code> <code class="s">"Bland Chromatin"</code> <code class="nv">cdata</code> <code class="mi">6</code><code class="p">)</code>
<code class="linenos">67 </code>        <code class="p">(</code><code class="nf">print-histogram</code> <code class="s">"Normal Nucleoli"</code> <code class="nv">cdata</code> <code class="mi">7</code><code class="p">)</code>
<code class="linenos">68 </code>        <code class="p">(</code><code class="nf">print-histogram</code> <code class="s">"Mitoses"</code> <code class="nv">cdata</code> <code class="mi">8</code><code class="p">)))</code>
<code class="linenos">69 </code>    <code class="c1">;; get best model parameters:</code>
<code class="linenos">70 </code>    <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">java-cdata</code> <code class="p">(</code><code class="nb">into-array </code><code class="p">(</code><code class="nb">map </code><code class="nv">double-array</code> <code class="nv">cdata</code><code class="p">))</code>
<code class="linenos">71 </code>          <code class="nv">detector</code>
<code class="linenos">72 </code>          <code class="p">(</code><code class="k">new </code><code class="nv">AnomalyDetection</code>
<code class="linenos">73 </code>            <code class="mi">10</code> <code class="p">(</code><code class="nb">- </code><code class="p">(</code><code class="nb">count </code><code class="nv">cdata</code><code class="p">)</code> <code class="mi">1</code><code class="p">)</code> <code class="nv">java-cdata</code><code class="p">)]</code>
<code class="linenos">74 </code>      <code class="p">(</code><code class="k">. </code><code class="nv">detector</code> <code class="nv">train</code><code class="p">)</code>
<code class="linenos">75 </code>      <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">test_malignant</code>
<code class="linenos">76 </code>            <code class="p">(</code><code class="nf">double-array</code> <code class="p">[</code><code class="mf">0.5</code> <code class="mi">1</code> <code class="mi">1</code> <code class="mf">0.8</code> <code class="mf">0.5</code> <code class="mf">0.5</code> <code class="mf">0.7</code> <code class="mi">1</code> <code class="mf">0.1</code><code class="p">])</code>
<code class="linenos">77 </code>            <code class="nv">test_benign</code>
<code class="linenos">78 </code>            <code class="p">(</code><code class="nf">double-array</code>
<code class="linenos">79 </code>             <code class="p">[</code><code class="mf">0.5</code> <code class="mf">0.4</code> <code class="mf">0.5</code> <code class="mf">0.1</code> <code class="mf">0.8</code> <code class="mf">0.1</code> <code class="mf">0.3</code> <code class="mf">0.6</code> <code class="mf">0.1</code><code class="p">])</code>
<code class="linenos">80 </code>            <code class="nv">malignant_result</code>
<code class="linenos">81 </code>            <code class="p">(</code><code class="k">. </code><code class="nv">detector</code> <code class="nv">isAnamoly</code> <code class="nv">test_malignant</code><code class="p">)</code>
<code class="linenos">82 </code>            <code class="nv">benign_result</code>
<code class="linenos">83 </code>            <code class="p">(</code><code class="k">. </code><code class="nv">detector</code> <code class="nv">isAnamoly</code> <code class="nv">test_benign</code><code class="p">)]</code>
<code class="linenos">84 </code>        <code class="p">(</code><code class="k">if </code><code class="nv">malignant_result</code>
<code class="linenos">85 </code>          <code class="p">(</code><code class="nb">println </code><code class="s">"malignant_result true"</code><code class="p">)</code>
<code class="linenos">86 </code>          <code class="p">(</code><code class="nb">println </code><code class="s">"malignant_result false"</code><code class="p">))</code>
<code class="linenos">87 </code>        <code class="p">(</code><code class="k">if </code><code class="nv">benign_result</code>
<code class="linenos">88 </code>          <code class="p">(</code><code class="nb">println </code><code class="s">"benign_result true"</code><code class="p">)</code>
<code class="linenos">89 </code>          <code class="p">(</code><code class="nb">println </code><code class="s">"benign_result false"</code><code class="p">))</code>
<code class="linenos">90 </code>
<code class="linenos">91 </code>        <code class="p">))))</code>
<code class="linenos">92 </code>        
<code class="linenos">93 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code> <code class="p">[</code><code class="o">&amp;</code> <code class="nv">_</code><code class="p">]</code>
<code class="linenos">94 </code>  <code class="p">(</code><code class="nf">testAD</code><code class="p">))</code>
</pre></div>

</figure>

<p>Data used by an anomaly detection model should have (roughly) a Gaussian (bell curve shape) distribution. What form does the cancer data have? Unfortunately, each of the data features seems to either have a greater density at the lower range of feature values or large density at the extremes of the data feature ranges. This will cause our model to not perform as well as we would like.</p>

<p>I won’t do it in this example, but the feature “Bare Nuclei” should be removed because it is not even close to being a bell-shaped distribution. Another thing that you can do (recommended by Andrew Ng in his Coursera Machine Learning class) is to take the log of data and otherwise transform it to something that looks more like a Gaussian distribution.</p>

<p>In a real application you would drop features that you can not transform to something like a Gaussian distribution.</p>

<p>Here are the results of running the code as it is in the GitHub repository for this book (with some verbose output removed for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">75</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">05</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">75</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">07</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">75</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">08</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">68</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">14</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">24</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">25</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">38</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">39</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">4</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">41</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">42</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">43</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">113</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">44</code>

<code class="o">****</code> <code class="nv">Best</code> <code class="nv">epsilon</code> <code class="nv">value</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">15000000000000002</code>
   <code class="nv">cross_validation_error_count</code> <code class="o">=</code> <code class="mi">63</code>.<code class="mi">0</code> <code class="k">for</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">15</code>\
<code class="mi">000000000000002</code>

 <code class="o">--</code> <code class="nv">best</code> <code class="nv">epsilon</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">15000000000000002</code>
 <code class="o">--</code> <code class="nv">number</code> <code class="nv">of</code> <code class="nv">test</code> <code class="nv">examples</code> <code class="o">=</code> <code class="mi">66</code>
 <code class="o">--</code> <code class="nv">number</code> <code class="nv">of</code> <code class="nv">false</code> <code class="nv">positives</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">0</code>
 <code class="o">--</code> <code class="nv">number</code> <code class="nv">of</code> <code class="nv">true</code> <code class="nv">positives</code> <code class="o">=</code> <code class="mi">8</code>.<code class="mi">0</code>
 <code class="o">--</code> <code class="nv">number</code> <code class="nv">of</code> <code class="nv">false</code> <code class="nv">negatives</code> <code class="o">=</code> <code class="mi">11</code>.<code class="mi">0</code>
 <code class="o">--</code> <code class="nv">number</code> <code class="nv">of</code> <code class="nv">true</code> <code class="nv">negatives</code> <code class="o">=</code> <code class="mi">47</code>.<code class="mi">0</code>
 <code class="o">--</code> <code class="nv">precision</code> <code class="o">=</code> <code class="mi">1</code>.<code class="mi">0</code>
 <code class="o">--</code> <code class="nv">recall</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">42105263157894735</code>
 <code class="o">--</code> <code class="nv">F1</code> <code class="o">=</code> <code class="mi">0</code>.<code class="mi">5925925925925926</code>
<code class="nv">malignant_result</code> <code class="nv">true</code>
<code class="nv">benign_result</code> <code class="nv">false</code>
</pre></div>

</figure>

<p>How do we evaluate these results? The precision value of 1.0 means that there were no false positives. False positives are predictions of a true result when it should have been false. The value 0.421 for recall means that of all the samples that should have been classified as positive, we only predicted about 42% of them. The F1 score is calculated as two times the product of precision and recall, divided by the sum of precision plus recall.</p>

<p>We used a simple approach here that has the benefit of working with small data sets. Ideally, even with highly unbalanced data sets, we would have sufficient positive examples to use deep learning to model features, data transformations, and a classification model. In many real-world problems with unbalanced data sets, sufficient data is not available.</p>


<h2 id="leanpub-auto-web-scraping">Web Scraping</h2>

<p>I often write software to automatically collect and use data from the web and other sources. As a practical matter, much of the data that many people use for machine learning comes from either the web or from internal data sources. This section provides some guidance and examples for getting text data from the web.</p>

<p>Before we start a technical discussion about web scraping I want to point out that much of the information on the web is copyright and the first thing that you should do is to read the terms of service for web sites to insure that your use of “scraped” or “spidered” data conforms with the wishes of the persons or organizations who own the content and pay to run scraped web sites.</p>

<h3 id="leanpub-auto-web-scraping-using-the-jsoup-library">Web Scraping Using the <strong>jsoup</strong> Library</h3>

<p>We will use the MIT licensed Java library <a href="http://jsoup.org/">jsoup</a>. One reason I selected <strong>jsoup</strong> for the examples in this chapter out of many fine libraries that provide similar functionality is the particularly nice documentation, especially <a href="http://jsoup.org/cookbook/">The <strong>jsoup Cookbook</strong></a> which I urge you to bookmark as a general reference. In this chapter I will concentrate on just the most frequent web scraping use cases that I use in my own work: getting all plain text and links from a web site. It should be straightforward for you to take the following example and extend it with whatever else you may need from the <strong>jsoup Cookbook</strong>.</p>

<p>We need to require the <strong>jsoup</strong> dependency in the project file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">defproject </code><code class="nv">webscraping</code> <code class="s">"0.1.0-SNAPSHOT"</code>
<code class="linenos"> 2 </code>  <code class="ss">:description</code> <code class="s">"Demonstration of using Java Jsoup library"</code>
<code class="linenos"> 3 </code>  <code class="ss">:url</code> <code class="s">"http://markwatson.com"</code>
<code class="linenos"> 4 </code>  <code class="ss">:license</code>
<code class="linenos"> 5 </code>  <code class="p">{</code><code class="ss">:name</code>
<code class="linenos"> 6 </code>   <code class="s">"EPL-2.0 OR GPL-2+ WITH Classpath-exception-2.0"</code>
<code class="linenos"> 7 </code>   <code class="ss">:url</code> <code class="s">"https://www.eclipse.org/legal/epl-2.0/"</code><code class="p">}</code>
<code class="linenos"> 8 </code>  <code class="ss">:dependencies</code> <code class="p">[[</code><code class="nv">org.clojure/clojure</code> <code class="s">"1.10.1"</code><code class="p">]</code>
<code class="linenos"> 9 </code>                 <code class="p">[</code><code class="nv">org.jsoup/jsoup</code> <code class="s">"1.7.2"</code><code class="p">]]</code>
<code class="linenos">10 </code>  <code class="ss">:repl-options</code> <code class="p">{</code><code class="ss">:init-ns</code> <code class="nv">webscraping.core</code><code class="p">})</code>
</pre></div>

</figure>

<p>The example code for this chapter uses <strong>jsoup</strong> to get the complete plain text and also the anchor (<strong>&lt;a href=…</strong>) data for a web page. In reading the following code let’s start at the end: lines 28-35 where we fetch data from a web site as a <strong>jsoup</strong> document object. Once we have this document object, we use the Java method <strong>text</strong> on to get plain text. On line 37 we use the utility function <strong>get-html-anchors</strong> that is defined in lines 6-23. On line 8 we search for all anchor patterns “a[href]”. For each anchor, we construct the full target URI. Lines 17-21 handle the corner case of URIs like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>https://example/com#faq
</pre></div>

</figure>

<p>where we need to use a check to see if a URI starts with “http” in which case we just use the URI as is. Otherwise, treat the URI as a partial like “#faq” that is added to the base URI.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">webscraping.core</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.string</code> <code class="ss">:as</code> <code class="nv">str</code><code class="p">]))</code>
<code class="linenos"> 3 </code>
<code class="linenos"> 4 </code><code class="p">(</code><code class="nb">import </code><code class="p">(</code><code class="nf">org.jsoup</code> <code class="nv">Jsoup</code><code class="p">))</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">get-html-anchors</code> <code class="p">[</code><code class="nv">jsoup-web-page-contents</code><code class="p">]</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">anchors</code>
<code class="linenos"> 8 </code>        <code class="p">(</code><code class="k">. </code><code class="nv">jsoup-web-page-contents</code> <code class="nb">select </code><code class="s">"a[href]"</code><code class="p">)]</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">anchor</code> <code class="nv">anchors</code><code class="p">]</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">anchor-text</code>
<code class="linenos">11 </code>            <code class="p">(</code><code class="k">. </code><code class="p">(</code><code class="nb">first </code><code class="p">(</code><code class="k">. </code><code class="nv">anchor</code> <code class="nv">childNodes</code><code class="p">))</code> <code class="nv">text</code><code class="p">)</code>
<code class="linenos">12 </code>            <code class="nv">anchor-uri-base</code>
<code class="linenos">13 </code>            <code class="p">(</code><code class="k">. </code><code class="p">(</code><code class="nb">first </code><code class="p">(</code><code class="k">. </code><code class="nv">anchor</code> <code class="nv">childNodes</code><code class="p">))</code> <code class="nv">baseUri</code><code class="p">)</code>
<code class="linenos">14 </code>            <code class="nv">href-attribute</code>
<code class="linenos">15 </code>            <code class="p">(</code><code class="k">. </code><code class="p">(</code><code class="k">. </code><code class="nv">anchor</code> <code class="nv">attributes</code><code class="p">)</code> <code class="nb">get </code><code class="s">"href"</code><code class="p">)</code>
<code class="linenos">16 </code>            <code class="nv">anchor-uri</code>
<code class="linenos">17 </code>            <code class="p">(</code><code class="k">if </code><code class="p">(</code><code class="nf">str/starts-with?</code> <code class="nv">href-attribute</code> <code class="s">"http"</code><code class="p">)</code>
<code class="linenos">18 </code>              <code class="nv">href-attribute</code>
<code class="linenos">19 </code>              <code class="p">(</code><code class="nf">str/join</code> <code class="s">""</code>
<code class="linenos">20 </code>                 <code class="p">[</code><code class="nv">anchor-uri-base</code>
<code class="linenos">21 </code>                  <code class="p">(</code><code class="k">. </code><code class="p">(</code><code class="k">. </code><code class="nv">anchor</code> <code class="nv">attributes</code><code class="p">)</code> <code class="nb">get </code><code class="s">"href"</code><code class="p">)]))</code>
<code class="linenos">22 </code>            <code class="nv">furi</code> <code class="p">(</code><code class="nb">first </code><code class="p">(</code><code class="k">. </code><code class="nv">anchor</code> <code class="nv">childNodes</code><code class="p">))]</code>
<code class="linenos">23 </code>        <code class="p">{</code><code class="ss">:text</code> <code class="p">(</code><code class="nf">str/trim</code> <code class="nv">anchor-text</code><code class="p">)</code> <code class="ss">:uri</code> <code class="nv">anchor-uri</code><code class="p">}))))</code>
<code class="linenos">24 </code>
<code class="linenos">25 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">fetch-web-page-data</code>
<code class="linenos">26 </code>  <code class="s">"Get the &lt;a&gt; anchor data and full text from a web URI"</code>
<code class="linenos">27 </code>  <code class="p">[</code><code class="nv">a-uri</code><code class="p">]</code>
<code class="linenos">28 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">doc</code>
<code class="linenos">29 </code>        <code class="p">(</code><code class="nf">-&gt;</code>
<code class="linenos">30 </code>          <code class="p">(</code><code class="k">. </code><code class="nv">Jsoup</code> <code class="nv">connect</code> <code class="nv">a-uri</code><code class="p">)</code>
<code class="linenos">31 </code>          <code class="p">(</code><code class="nf">.userAgent</code>
<code class="linenos">32 </code>            <code class="s">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.0;\</code>
<code class="linenos">33 </code><code class="s"> rv:77.0) Gecko/20100101 Firefox/77.0"</code><code class="p">)</code>
<code class="linenos">34 </code>          <code class="p">(</code><code class="nf">.timeout</code> <code class="mi">20000</code><code class="p">)</code>
<code class="linenos">35 </code>          <code class="p">(</code><code class="nf">.get</code><code class="p">))</code>
<code class="linenos">36 </code>        <code class="nv">all-page-text</code> <code class="p">(</code><code class="k">. </code><code class="nb">doc </code><code class="nv">text</code><code class="p">)</code>
<code class="linenos">37 </code>        <code class="nv">anchors</code> <code class="p">(</code><code class="nf">get-html-anchors</code> <code class="nv">doc</code><code class="p">)]</code>
<code class="linenos">38 </code>    <code class="p">{</code><code class="ss">:page-text</code> <code class="nv">all-page-text</code> <code class="ss">:anchors</code> <code class="nv">anchors</code><code class="p">}))</code>
</pre></div>

</figure>

<p>On lines 32-33 I am setting the same user agent as my local web browser. In principle I would prefer making up a user agent name that contains my name and why I am spidering data, but in practice some web sites refuse requests from non-standard agents.</p>

<p>Let’s look at the test code for an example of fetching the text and links from my personal web site:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">webscraping.core-test</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.test</code> <code class="ss">:refer</code> <code class="ss">:all</code><code class="p">]</code>
<code class="linenos"> 3 </code>            <code class="p">[</code><code class="nv">clojure.pprint</code> <code class="ss">:as</code> <code class="nv">pp</code><code class="p">]</code>
<code class="linenos"> 4 </code>            <code class="p">[</code><code class="nv">webscraping.core</code> <code class="ss">:refer</code> <code class="ss">:all</code><code class="p">]))</code>
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code><code class="p">(</code><code class="nf">deftest</code> <code class="nv">a-test</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="nf">testing</code>
<code class="linenos"> 8 </code>    <code class="s">"Fetch my website and check number of results"</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">page-data</code>
<code class="linenos">10 </code>         <code class="p">(</code><code class="nf">fetch-web-page-data</code> <code class="s">"https://markwatson.com"</code><code class="p">)]</code>
<code class="linenos">11 </code>      <code class="p">(</code><code class="nf">pp/pprint</code> <code class="nv">page-data</code><code class="p">)</code>
<code class="linenos">12 </code>      <code class="p">(</code><code class="nf">is</code> <code class="p">(</code><code class="nb">= </code><code class="p">(</code><code class="nb">count </code><code class="nv">page-data</code><code class="p">)</code> <code class="mi">2</code><code class="p">)))))</code>
</pre></div>

</figure>

<p>Output might look like (most of the output is not shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">{:</code><code class="err">page</code><code class="mi">-</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code>
 <code class="s2">"Mark Watson: AI Practitioner and Lisp Hacker ..."</code><code class="p">,</code>
 <code class="p">:</code><code class="err">a</code><code class="kc">n</code><code class="err">chors</code>
 <code class="err">(</code><code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"Read my Blog"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://mark-watson.blogspot.com"</code><code class="p">}</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"Fun stuff"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://markwatson.com#fun"</code><code class="p">}</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"My Books"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://markwatson.com#books"</code><code class="p">}</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"My Open Source Projects"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://markwatson.com#opensource"</code><code class="p">}</code>
 <code class="err">...</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"leanpub"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://leanpub.com/u/markwatson"</code><code class="p">}</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"GitHub"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://github.com/mark-watson"</code><code class="p">}</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"LinkedIn"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://www.linkedin.com/in/marklwatson/"</code><code class="p">}</code>
  <code class="p">{:</code><code class="kc">te</code><code class="err">x</code><code class="kc">t</code> <code class="s2">"Twitter"</code><code class="p">,</code>
   <code class="p">:</code><code class="err">uri</code> <code class="s2">"https://twitter.com/mark_l_watson"</code><code class="p">}</code>
<code class="err">...</code> <code class="err">)</code><code class="p">}</code>
</pre></div>

</figure>

<p>For training data for machine learning it is useful to just grab all text on a web page and assume that common phrases dealing with web navigation, etc. will be dropped from learned models because they occur in many different training examples for different classifications.</p>

<p>I find the <strong>jsoup</strong> library to be robust for fetching and parsing HTML data from web pages. As we have seen it is straightforward to use <strong>jsoup</strong> in Clojure projects.</p>


<h2 id="semantic-web">Background Material for the Semantic Web and Knowledge Graphs</h2>

<p>We will start with a tutorial on Semantic Web data standards like RDF, RDFS, and OWL, then implement a wrapper for the Apache Jena library in the next chapter, and finally take a deeper dive into an example application in the chapter <a href="#kgn">Knowledge Graph Navigator</a>. </p>

<p>The scope of the Semantic Web is comprised of all public data sources on the Internet that follow specific standards like RDF. Knowledge Graphs may be large scale, as the graphs that drive Google’s and Facebook’s businesses, or they can be specific to an organization.</p>

<p><strong>Notes:</strong></p>

<ul>
  <li>The material in this chapter is background material. If you want to jump right into code examples then proceed to the next two chapters.</li>
  <li>Much of the material here was derived from a similar chapter in my Java AI book.</li>
</ul>

<h3 id="leanpub-auto-learning-plan">Learning Plan</h3>
<p>You will learn how to do the following:</p>

<ul>
  <li>Understand RDF data formats.</li>
  <li>Understand SPARQL queries for RDF data stores (both local and remote).</li>
  <li>Use the Apache Jena library (covered in the next chapter) to use local RDF data and perform SPARQL queries.</li>
  <li>Use the Apache Jena library to query remote SPARQL endpoints like DBPedia and WikiData.</li>
  <li>Use the Apache Derby relational database to cache SPARQL remote queries for both efficiency and for building systems that may have intermittent access to the Internet (covered in the next chapter).</li>
  <li>Take a quick look at RDF, RDFS, and OWL reasoners.</li>
</ul>

<p>The Semantic Web is intended to provide a massive linked set of data for use by software systems just as the World Wide Web provides a massive collection of linked web pages for human reading and browsing. The Semantic Web is like the web in that anyone can generate any content that they want. This freedom to publish anything works for the web because we use our ability to understand natural language to interpret what we read – and often to dismiss material that based upon our own knowledge we consider to be incorrect.</p>

<p>Semantic Web and linked data technologies are also useful for smaller amounts of data, an example being a Knowledge Graph containing information for a business. We will further explore Knowledge Graphs in the next two chapters.</p>

<p>The core concept for the Semantic Web is data integration and use from different sources. As we will soon see, the tools for implementing the Semantic Web are designed for encoding data and sharing data from many different sources.</p>

<p>I cover the Semantic Web in this book because I believe that Semantic Web technologies are complementary to AI systems for gathering and processing data on the web. As more web pages are generated by applications (as opposed to simply showing static HTML files) it becomes easier to produce both HTML for human readers and semantic data for software agents.</p>

<p>There are several very good Semantic Web toolkits for the Java language and platform. Here we use Apache Jena because it is what I often use in my own work and I believe that it is a good starting technology for your first experiments with Semantic Web technologies. This chapter provides an incomplete coverage of Semantic Web technologies and is intended as a gentle introduction to a few useful techniques and how to implement those techniques in Clojure (using the Java Jena libraries). </p>

<p>This material is just the start of a journey in understanding the technology that I think is as important as technologies like deep learning that get more public mindshare.</p>

<p>The following figure shows a layered hierarchy of data models that are used to implement Semantic Web applications. To design and implement these applications we need to think in terms of physical models (storage and access of RDF, RDFS, and perhaps OWL data), logical models (how we use RDF and RDFS to define relationships between data represented as unique URIs and string literals and how we logically combine data from different sources) and conceptual modeling (higher level knowledge representation and reasoning using OWL). Originally RDF data was serialized as XML data but other formats have become much more popular because they are easier to read and manually create. The top three layers in the figure might be represented as XML, or as LD-JSON (linked data JSON) or formats like N-Triples and N3 that we will use later.</p>


<div class="figure-wrapper center">
  <figure id="semantic-web-data-models" class="image" style="width: 249px">
    <img src="images/semantic_web_data.png" alt="Semantic Web Data Models" style="width: 100%">
    <figcaption>Semantic Web Data Models</figcaption>
  </figure>
</div>


<p>RDF data is the bedrock of the Semantic Web and Knowledge Graphs.</p>

<h3 id="leanpub-auto-available-tools">Available Tools</h3>

<p>Previously for Java-based semantic web projects I used the open source Sesame library for managing and querying RDF Data. Sesame is now called RDF4J and is part of the Eclipse organization’s projects.</p>

<p>I decided to use the Apache Jena project in this new edition because I think Jena is slightly easier to set up a light weight development environment. If you need to set up an RDF server I recommend using the open source <a href="https://jena.apache.org/documentation/fuseki2/">Fuseki</a> server which is part of the Apache Jena project. For experimenting with local Knowledge Graphs I also use the <a href="https://www.ontotext.com/try-graphdb-se">free version of GraphDB</a>. For client applications, in the next chapter we will use a Clojure wrapper for the Jena library that works with RDF and performing SPARQL queries.</p>

<h3 id="leanpub-auto-rdf-the-universal-data-format">RDF: The Universal Data Format</h3>

<p>The Resource Description Framework (RDF) is used to encode information and the RDF Schema (RDFS) facilitates using data with different RDF encodings without the need to convert one set of schemas to another. Later, using OWL, we can simply declare that one predicate is the same as another; that is, one predicate is a sub-predicate of another (e.g., a property <strong>containsCity</strong> can be declared to be a sub-property of <strong>containsPlace</strong> so if something contains a city then it also contains a place), etc. The predicate part of an RDF statement often refers to a property.</p>

<p>RDF data was originally encoded as XML and intended for automated processing. In this chapter we will use two simple to read formats called “N-Triples” and “N3.” Apache Jena can be used to convert between all RDF formats so we might as well use formats that are easier to read and understand. RDF data consists of a set of triple values:</p>

<ul>
  <li>subject</li>
  <li>predicate</li>
  <li>object</li>
</ul>

<p>Some of my work with Semantic Web technologies deals with processing news stories, extracting semantic information from the text, and storing it in RDF. I will use this application domain for the examples in this chapter and the next chapter when we implement code to automatically generate RDF for Knowledge Graphs. I deal with triples like:</p>

<ul>
  <li>subject: a URL (or URI) of a news article.</li>
  <li>predicate: a relation like “containsPerson”.</li>
  <li>object: a literal value like “Bill Clinton” or a URI representing Bill Clinton.</li>
</ul>

<p>In the next chapter we will use the entity recognition library we developed in an earlier chapter to create RDF from text input.</p>

<p>We will use either URIs or string literals as values for objects. We will always use URIs for representing subjects and predicates. In any case URIs are usually preferred to string literals. We will see an example of this preferred use but first we need to learn the N-Triple and N3 RDF formats.</p>

<p>I proposed the idea that RDF was more flexible than Object Modeling in programming languages, relational databases, and XML with schemas. If we can tag new attributes on the fly to existing data, how do we prevent what I might call “data chaos” as we modify existing data sources? It turns out that the solution to this problem is also the solution for encoding real semantics (or meaning) with data: we usually use unique URIs for RDF subjects, predicates, and objects, and usually with a preference for not using string literals. The definitions of predicates are tied to a namespace and later with OWL we will state the equivalence of predicates in different namespaces with the same semantic meaning. I will try to make this idea more clear with some examples and <a href="https://en.wikipedia.org/wiki/Resource_Description_Framework">Wikipedia has a good writeup on RDF</a>.</p>

<p>Any part of a triple (subject, predicate, or object) is either a URI or a string literal. URIs encode namespaces. For example, the containsPerson predicate in the last example could be written as:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">knowledgebooks</code><code class="p">.</code><code class="err">com</code><code class="o">/</code><code class="err">ontology</code><code class="o">/</code><code class="c">#containsPerson</code>
</pre></div>

</figure>

<p>The first part of this URI is considered to be the namespace for this predicate “containsPerson.” When different RDF triples use this same predicate, this is some assurance to us that all users of this predicate understand the same meaning. Furthermore, we will see later that we can use RDFS to state equivalency between this predicate (in the namespace http://knowledgebooks.com/ontology/) with predicates represented by different URIs used in other data sources. In an “artificial intelligence” sense, software that we write does not understand predicates like “containsCity”,  “containsPerson”, or “isLocation” in the way that a human reader can by combining understood common meanings for the words “contains”, “city”, “is”, “person”, and “location” but for many interesting and useful types of applications that is fine as long as the predicate is used consistently. We will see that we can define abbreviation prefixes for namespaces which makes RDF and RDFS files shorter and easier to read.</p>

<p>The Jena library supports most serialization formats for RDF:</p>

<ul>
  <li>Turtle</li>
  <li>N3</li>
  <li>N-Triples</li>
  <li>NQuads</li>
  <li>TriG</li>
  <li>JSON-LD</li>
  <li>RDF/XML</li>
  <li>RDF/JSON</li>
  <li>TriX</li>
  <li>RDF Binary</li>
</ul>

<p>A statement in N-Triple format consists of three URIs (two URIs and a string literals for the object) followed by a period to end the statement. While statements are often written one per line in a source file they can be broken across lines; it is the ending period which marks the end of a statement. The standard file extension for N-Triple format files is *.nt and the standard format for N3 format files is *.n3.</p>

<p>My preference is to use N-Triple format files as output from programs that I write to save data as RDF. N-Triple files don’t use any abbreviations and each RDF statement is self-contained. I often use tools like the command line commands in Jena or RDF4J to convert N-Triple files to N3 or other formats if I will be reading them or even hand editing them. Here is an example using the N3 syntax:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"China"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>The N3 format adds prefixes (abbreviations) to the N-Triple format. In practice it would be better to use the URI <strong><a href="http://dbpedia.org/resource/China">http://dbpedia.org/resource/China</a></strong> instead of the literal value “China.”</p>

<p>Here we see the use of an abbreviation prefix “kb:” for the namespace for my company KnowledgeBooks.com ontologies. The first term in the RDF statement (the subject) is the URI of a news article. The second term (the predicate) is “containsCountry” in the “kb:” namespace. The last item in the statement (the object) is a string literal “China.” I would describe this RDF statement in English as, “The news article at URI http://news.com/201234 mentions the country China.”</p>

<p>This was a very simple N3 example which we will expand to show additional features of the N3 notation. As another example, let’s look at the case of this news article also mentioning the USA. Instead of adding a whole new statement like this we can combine them using N3 notation. Here we have two separate RDF statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
</pre></div>

</figure>

<p>We can collapse multiple RDF statements that share the same subject and optionally the same predicate:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
    <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code> <code class="p">,</code>
    <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
</pre></div>

</figure>

<p>The indentation and placement on separate lines is arbitrary - use whatever style you like that is readable. We can also add in additional predicates that use the same subject (I am going to use string literals here instead of URIs for objects to make the following example more concise but in practice prefer using URIs):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"China"</code> <code class="p">,</code>
                           <code class="s">"USA"</code> <code class="p">.</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"United Nations"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Ban Ki-moon"</code> <code class="p">,</code> <code class="s">"Gordon Brown"</code> <code class="p">,</code>
                          <code class="s">"Hu Jintao"</code> <code class="p">,</code> <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Pervez Musharraf"</code> <code class="p">,</code>
                          <code class="s">"Vladimir Putin"</code> <code class="p">,</code> 
                          <code class="s">"Mahmoud Ahmadinejad"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>This single N3 statement represents ten individual RDF triples. Each section defining triples with the same subject and predicate have objects separated by commas and ending with a period. Please note that whatever RDF storage system you use (we will be using Jena) it makes no difference if we load RDF as XML, N-Triple, or N3 format files: internally subject, predicate, and object triples are stored in the same way and are used in the same way. RDF triples in a data store represent directed graphs that may not all be connected.</p>

<p>I promised you that the data in RDF data stores was easy to extend. As an example, let us assume that we have written software that is able to read online news articles and create RDF data that captures some of the semantics in the articles. If we extend our program to also recognize dates when the articles are published, we can simply reprocess articles and for each article add a triple to our RDF data store using a form like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="linenos">2 </code>
<code class="linenos">3 </code><code class="nl">&lt;http://news.com/201234/&gt;</code>
<code class="linenos">4 </code>  <code class="nn">kb</code><code class="p">:</code><code class="nt">datePublished</code>
<code class="linenos">5 </code>  <code class="s">"2008-05-11"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Note that I split one RDF statement across three lines (3-5) here to fit page width. The RDF statement on lines 3-5 is legal and will be handled correctly by RDF parsers. Here we just represent the date as a string. We can add a type to the object representing a specific date:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">xsd</code><code class="p">:</code> <code class="nl">&lt;http://www.w3.org/2001/XMLSchema#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
 
 <code class="nl">&lt;http://news.com/201234/&gt;</code>
   <code class="nn">kb</code><code class="p">:</code><code class="nt">datePublished</code>
   <code class="s">"2008-05-11"</code><code class="o">^^</code><code class="nn">xsd</code><code class="p">:</code><code class="nt">date</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Furthermore, if we do not have dates for all news articles, that is often acceptable because when constructing SPARQL queries you can match optional patterns. If for example you are looking up articles on a specific subject then some results may have a publication date attached to the results for that article and some might not. In practice RDF supports types and we would use a date type as seen in the last example, not a string. However, in designing the example programs for this chapter I decided to simplify our representation of URIs and often use string literals as simple Java strings.</p>

<h3 id="rdfs">Extending RDF with RDF Schema</h3>

<p>RDF Schema (RDFS) supports the definition of classes and properties based on set inclusion. In RDFS classes and properties are orthogonal. Let’s start with looking at an example using additional namespaces:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>   <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdf</code><code class="p">:</code>  <code class="o">&lt;</code><code class="nn">http</code><code class="p">:</code><code class="o">//</code><code class="err">www</code><code class="p">.</code><code class="err">w</code><code class="mf">3.</code><code class="err">org</code><code class="o">/</code><code class="mi">1999</code><code class="o">/</code><code class="mi">02</code><code class="o">/</code><code class="mi">22</code><code class="o">-</code><code class="err">rdf</code><code class="o">-</code><code class="err">syntax</code><code class="o">-</code><code class="err">ns\</code>
<code class="c">#&gt; .</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code> <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">dbo</code><code class="p">:</code>  <code class="nl">&lt;http://dbpedia.org/ontology/&gt;</code> <code class="p">.</code>

<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://news.com/201234/&gt;</code>
  <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code>
  <code class="nl">&lt;http://dbpedia.org/resource/United_States&gt;</code>  <code class="p">.</code>
  
<code class="nl">&lt;http://dbpedia.org/resource/China&gt;</code>
  <code class="nn">rdfs</code><code class="p">:</code><code class="nt">label</code> <code class="s">"China"</code><code class="o">@</code><code class="nf">en</code><code class="p">,</code>
  <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">dbo</code><code class="p">:</code><code class="nt">Place</code> <code class="p">,</code>
  <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">dbo</code><code class="p">:</code><code class="nt">Country</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Because the Semantic Web is intended to be processed automatically by software systems it is encoded as RDF. There is a problem that must be solved in implementing and using the Semantic Web: everyone who publishes Semantic Web data is free to create their own RDF schemas for storing data. For example, there is usually no single standard RDF schema definition for topics like news stories and stock market data. The <a href="https://www.w3.org/2009/08/skos-reference/skos.html">SKOS</a> is a namespace containing standard schemas and the most widely used standard is <a href="https://schema.org/docs/schemas.html">schema.org</a>. Understanding the ways of integrating different data sources using different schemas helps to understand the design decisions behind the Semantic Web applications. In this chapter I often use my own schemas in the knowledgebooks.com namespace for the simple examples you see here. When you build your own production systems part of the work is searching through <strong>schema.org</strong> and <strong>SKOS</strong> to use standard name spaces and schemas when possible because this facilitates linking your data to other RDF Data on the web. The use of standard schemas helps when you link internal proprietary Knowledge Graphs used in organization with public open data from sources like <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">WikiData</a> and <a href="https://wiki.dbpedia.org/about">DBPedia</a>.</p>

<p>Let’s consider an example: suppose that your local Knowledge Graph referred to President Joe Biden in which case we could “mint” our own URI like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>https://knowledgebooks.com/person#Joe_Biden
</pre></div>

</figure>

<p>In this case users of the local Knowledge Graph could not take advantage of connected data. For example, the DBPedia and WikiData URIs for How Biden are:</p>

<ul>
  <li><a href="https://dbpedia.org/resource/Joe_Biden">https://dbpedia.org/resource/Joe_Biden</a></li>
  <li><a href="http://www.wikidata.org/entity/Q6279">http://www.wikidata.org/entity/Q6279</a></li>
</ul>

<p>Both of these URIs can be followed by clicking on the links if you are reading a PDF copy of this book. Please “follow your nose” and see how both of these URIs resolve to human-readable web pages.</p>

<p>After telling you, dear reader, to always try to use public and standard URIs like the above examples for Joe Biden, I will now revert to using simple made-up URIs for the following discussion.</p>

<p>We will start with an example that is an extension of the example in the last section that also uses RDFS. We add a few additional RDF statements:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>  <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
</pre></div>

</figure>

<p>The last three lines declare that:</p>

<ul>
  <li>The property containsCity is a sub-property of containsPlace.</li>
  <li>The property containsCountry is a sub-property of containsPlace.</li>
  <li>The property containsState is a sub-property of containsPlace.</li>
</ul>

<p>Why is this useful? For at least two reasons:</p>

<ul>
  <li>You can query an RDF data store for all triples that use property containsPlace and also match triples with properties equal to containsCity, containsCountry, or containsState. There may not even be any triples that explicitly use the property containsPlace.</li>
  <li>Consider a hypothetical case where you are using two different RDF data stores that use different properties for naming cities: <strong>cityName</strong> and <strong>city</strong>. You can define <strong>cityName</strong> to be a sub-property of <strong>city</strong> and then write all queries against the single property name <strong>city</strong>. This removes the necessity to convert data from different sources to use the same Schema. You can also use OWL to state property and class equivalency.</li>
</ul>

<p>In addition to providing a vocabulary for describing properties and class membership by properties, RDFS is also used for logical inference to infer new triples, combine data from different RDF data sources, and to allow effective querying of RDF data stores. We will see examples of all of these features of RDFS when we later start using the Jena libraries to perform SPARQL queries.</p>

<h3 id="leanpub-auto-the-sparql-query-language">The SPARQL Query Language</h3>

<p>SPARQL is a query language used to query RDF data stores. While SPARQL may initially look like SQL, we will see that there are some important differences like support for RDFS and OWL inferencing and graph-based instead of relational matching operations. We will cover the basics of SPARQL in this section and then see more examples later when we learn how to embed Jena in Java applications, and see more examples in the last chapter <a href="#kgn">Knowledge Graph Navigator</a>.</p>

<p>We will use the N3 format RDF file test_data/news.n3 for the examples. I created this file automatically by spidering Reuters news stories on the news.yahoo.com web site and automatically extracting named entities from the text of the articles. We saw techniques for extracting named entities from text in earlier chapters. In this chapter we use these sample RDF files.</p>

<p>You have already seen snippets of this file and I list the entire file here for reference, edited to fit line width: you may find the file news.n3 easier to read if you are at your computer and open the file in a text editor so you will not be limited to what fits on a book page:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="err">@</code><code class="k">prefix</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code> <code class="p">.</code>
<code class="err">@</code><code class="k">prefix</code> <code class="nn">rdfs</code><code class="p">:</code>  <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/20080616/usa_flooding_dc_16/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Burlington"</code> <code class="p">,</code> <code class="s">"Denver"</code> <code class="p">,</code>
                        <code class="s">"St. Paul"</code> <code class="p">,</code><code class="s">" Chicago"</code> <code class="p">,</code>
                        <code class="s">"Quincy"</code> <code class="p">,</code> <code class="s">"CHICAGO"</code> <code class="p">,</code>
                        <code class="s">"Iowa City"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsRegion</code> <code class="s">"U.S. Midwest"</code> <code class="p">,</code> <code class="s">"Midwest"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Japan"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Minnesota"</code> <code class="p">,</code> <code class="s">"Illinois"</code> <code class="p">,</code> 
                         <code class="s">"Mississippi"</code> <code class="p">,</code> <code class="s">"Iowa"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"National Guard"</code> <code class="p">,</code>
                         <code class="s">"U.S. Department of Agriculture"</code><code class="p">,</code>
                         <code class="s">"White House"</code> <code class="p">,</code>
                         <code class="s">"Chicago Board of Trade"</code> <code class="p">,</code>
                         <code class="s">"Department of Transportation"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Dena Gray-Fisher"</code> <code class="p">,</code>
                          <code class="s">"Donald Miller"</code> <code class="p">,</code>
                          <code class="s">"Glenn Hollander"</code> <code class="p">,</code>
                          <code class="s">"Rich Feltes"</code> <code class="p">,</code>
                          <code class="s">"George W. Bush"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"food inflation"</code><code class="p">,</code> <code class="s">"food"</code><code class="p">,</code>
                                <code class="s">"finance ministers"</code> <code class="p">,</code>
                                <code class="s">"oil"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/78325/ts_nm/usa_politics_dc_2/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Washington"</code> <code class="p">,</code> <code class="s">"Baghdad"</code> <code class="p">,</code>
                        <code class="s">"Arlington"</code> <code class="p">,</code> <code class="s">"Flint"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code>
                           <code class="s">"Afghanistan"</code> <code class="p">,</code>
                           <code class="s">"Iraq"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Illinois"</code> <code class="p">,</code> <code class="s">"Virginia"</code> <code class="p">,</code>
                         <code class="s">"Arizona"</code> <code class="p">,</code> <code class="s">"Michigan"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"White House"</code> <code class="p">,</code>
                                <code class="s">"Obama administration"</code> <code class="p">,</code>
                                <code class="s">"Iraqi government"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"David Petraeus"</code> <code class="p">,</code>
                          <code class="s">"John McCain"</code> <code class="p">,</code>
                          <code class="s">"Hoshiyar Zebari"</code> <code class="p">,</code>
                          <code class="s">"Barack Obama"</code> <code class="p">,</code>
                          <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Carly Fiorina"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"oil prices"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/10944/ts_nm/worldleaders_dc_1/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"WASHINGTON"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Pakistan"</code> <code class="p">,</code>
                           <code class="s">"Islamic Republic of Iran"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Maryland"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"University of Maryland"</code> <code class="p">,</code>
                                <code class="s">"United Nations"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Ban Ki-moon"</code> <code class="p">,</code> <code class="s">"Gordon Brown"</code> <code class="p">,</code>
                          <code class="s">"Hu Jintao"</code> <code class="p">,</code> <code class="s">"George W. Bush"</code> <code class="p">,</code>
                          <code class="s">"Pervez Musharraf"</code> <code class="p">,</code>
                          <code class="s">"Vladimir Putin"</code> <code class="p">,</code>
                          <code class="s">"Steven Kull"</code> <code class="p">,</code>
                          <code class="s">"Mahmoud Ahmadinejad"</code> <code class="p">.</code>

<code class="nl">&lt;http://yahoo.com/10622/global_economy_dc_4/&gt;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="s">"Sao Paulo"</code> <code class="p">,</code> <code class="s">"Kuala Lumpur"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsRegion</code> <code class="s">"Midwest"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="s">"United States"</code> <code class="p">,</code> <code class="s">"Britain"</code> <code class="p">,</code>
                           <code class="s">"Saudi Arabia"</code> <code class="p">,</code> <code class="s">"Spain"</code> <code class="p">,</code>
                           <code class="s">"Italy"</code> <code class="p">,</code> <code class="err">Indi</code><code class="k">a</code><code class="s">" , </code>
                           <code class="s">""</code><code class="err">France</code><code class="s">" , "</code><code class="err">Canad</code><code class="k">a</code><code class="s">" ,</code>
                           <code class="s">"Russia"</code><code class="p">,</code> <code class="s">"Germany"</code><code class="p">,</code> <code class="s">"China"</code><code class="p">,</code>
                           <code class="s">"Japan"</code> <code class="p">,</code> <code class="s">"South Korea"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="s">"Federal Reserve Bank"</code> <code class="p">,</code>
                                <code class="s">"European Union"</code> <code class="p">,</code>
                                <code class="s">"European Central Bank"</code> <code class="p">,</code>
                                <code class="s">"European Commission"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPerson</code> <code class="s">"Lee Myung-bak"</code> <code class="p">,</code> <code class="s">"Rajat Nag"</code> <code class="p">,</code>
                          <code class="s">"Luiz Inacio Lula da Silva"</code> <code class="p">,</code>
                          <code class="s">"Jeffrey Lacker"</code> <code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCompany</code>
            <code class="s">"Development Bank Managing"</code> <code class="p">,</code>
            <code class="s">"Reuters"</code> <code class="p">,</code>
            <code class="s">"Richmond Federal Reserve Bank"</code><code class="p">;</code>
        <code class="nn">kb</code><code class="p">:</code><code class="nt">containsIndustryTerm</code> <code class="s">"central bank"</code> <code class="p">,</code> <code class="s">"food"</code> <code class="p">,</code>
                                <code class="s">"energy costs"</code> <code class="p">,</code>
                                <code class="s">"finance ministers"</code> <code class="p">,</code>
                                <code class="s">"crude oil prices"</code> <code class="p">,</code>
                                <code class="s">"oil prices"</code> <code class="p">,</code>
                                <code class="s">"oil shock"</code> <code class="p">,</code>
                                <code class="s">"food prices"</code> <code class="p">,</code>
                                <code class="s">"Finance ministers"</code> <code class="p">,</code>
                                <code class="s">"Oil prices"</code> <code class="p">,</code> <code class="s">"oil"</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Please note that in the above RDF listing I took advantage of the free form syntax of N3 and Turtle RDF formats to reformat the data to fit page width.</p>

<p>In the following examples, I used the library developed in the next chapter that allows us to load multiple RDF input files and then to use SPARQL queries.</p>

<p>We will start with a simple SPARQL query for subjects (news article URLs) and objects (matching countries) with the value for the predicate equal to <strong>containsCountry</strong>. Variables in queries start with a question mark character and can have any names:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
  <code class="k">WHERE</code> <code class="p">{</code>
   <code class="nv">?subject</code>
   <code class="nl">&lt;http://knowledgebooks.com/ontology#containsCountry&gt;</code>
   <code class="nv">?object</code> <code class="p">.</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>It is important for you to understand what is happening when we apply the last SPARQL query to our sample data. Conceptually, all the triples in the sample data are scanned, keeping the ones where the predicate part of a triple is equal to <strong><a href="http://knowledgebooks.com/ontology#containsCountry">http://knowledgebooks.com/ontology#containsCountry</a></strong>. In practice RDF data stores supporting SPARQL queries index RDF data so a complete scan of the sample data is not required. This is analogous to relational databases where indices are created to avoid needing to perform complete scans of database tables.</p>

<p>In practice, when you are exploring a Knowledge Graph like DBPedia or WikiData (that are just very large collections of RDF triples), you might run a query and discover a useful or interesting entity URI in the triple store, then drill down to find out more about the entity. In a later chapter <a href="#kgn">Knowledge Graph Navigator</a> we attempt to automate this exploration process using the DBPedia data as a Knowledge Graph.</p>

<p>We will be using the same code to access the small example of RDF statements in our sample data as we will for accessing DBPedia or WikiData.</p>

<p>We can make this last query easier to read and reduce the chance of misspelling errors by using a namespace prefix:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
  <code class="k">WHERE</code> <code class="p">{</code>
      <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nv">?object</code> <code class="p">.</code>
  <code class="p">}</code>
</pre></div>

</figure>

<p>We could have filtered on any other predicate, for instance <strong>containsPlace</strong>. Here is another example using a match against a string literal to find all articles exactly matching the text “Maryland.”</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code>  <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="k">WHERE</code> <code class="p">{</code> <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="s">"Maryla\</code>
<code class="err">nd</code><code class="s">" . }</code>
</pre></div>

</figure>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
ust_dc_1/
</pre></div>

</figure>

<p>We can also match partial string literals against regular expressions:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code> <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="nv">?subject</code> <code class="nv">?object</code>
       <code class="k">WHERE</code> <code class="p">{</code>
         <code class="nv">?subject</code>
         <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code>
         <code class="nv">?object</code> <code class="k">FILTER</code> <code class="nf">regex</code><code class="p">(</code><code class="nv">?object</code><code class="p">,</code> <code class="s">"University"</code><code class="p">)</code> <code class="p">.</code>
       <code class="p">}</code>
</pre></div>

</figure>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
ust_dc_1/ 
   "University of Maryland"
</pre></div>

</figure>

<p>We might want to return all triples matching a property of containing an organization and where the object is a string containing the substring “University.” The matching statement after the FILTER check matches every triple that matches the subject in the first pattern:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">PREFIX</code> <code class="nn">kb</code><code class="p">:</code> <code class="nl">&lt;http://knowledgebooks.com/ontology#&gt;</code>
<code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?subject</code> <code class="nv">?a_predicate</code> <code class="nv">?an_object</code>
 <code class="k">WHERE</code> <code class="p">{</code>
    <code class="nv">?subject</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsOrganization</code> <code class="nv">?object</code> <code class="p">.</code>
       <code class="k">FILTER</code> <code class="nf">regex</code><code class="p">(</code><code class="nv">?object</code><code class="p">,</code><code class="s">"University"</code><code class="p">)</code> <code class="p">.</code>
    <code class="nv">?subject</code> <code class="nv">?a_predicate</code> <code class="nv">?an_object</code> <code class="p">.</code>
<code class="p">}</code>
<code class="k">ORDER BY</code> <code class="nv">?a_predicate</code> <code class="nv">?an_object</code>
<code class="k">LIMIT</code> <code class="mi">10</code>
<code class="k">OFFSET</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>When WHERE clauses contain more than one triple pattern to match, this is equivalent to a Boolean “and” operation. The DISTINCT clause removes duplicate results. The ORDER BY clause sorts the output in alphabetical order: in this case first by predicate (containsCity, containsCountry, etc.) and then by object. The LIMIT modifier limits the number of results returned and the OFFSET modifier sets the number of matching results to skip.</p>

<p>The output is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos"> 2 </code>ust_dc_1/
<code class="linenos"> 3 </code>	 http://knowledgebooks.com/ontology#containsOrganization
<code class="linenos"> 4 </code>   "University of Maryland" .
<code class="linenos"> 5 </code>
<code class="linenos"> 6 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos"> 7 </code>ust_dc_1/
<code class="linenos"> 8 </code>	 http://knowledgebooks.com/ontology#containsPerson,
<code class="linenos"> 9 </code>	 "Ban Ki-moon" .
<code class="linenos">10 </code>	 
<code class="linenos">11 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">12 </code>ust_dc_1/
<code class="linenos">13 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">14 </code>	 "George W. Bush" .
<code class="linenos">15 </code>
<code class="linenos">16 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">17 </code>ust_dc_1/
<code class="linenos">18 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">19 </code>	 "Gordon Brown" .
<code class="linenos">20 </code>
<code class="linenos">21 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">22 </code>ust_dc_1/
<code class="linenos">23 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">24 </code>	 "Hu Jintao" .
<code class="linenos">25 </code>
<code class="linenos">26 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">27 </code>ust_dc_1/
<code class="linenos">28 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">29 </code>	 "Mahmoud Ahmadinejad" .
<code class="linenos">30 </code>
<code class="linenos">31 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">32 </code>ust_dc_1/
<code class="linenos">33 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">34 </code>	 "Pervez Musharraf" .
<code class="linenos">35 </code>
<code class="linenos">36 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">37 </code>ust_dc_1/
<code class="linenos">38 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">39 </code>	 "Steven Kull" .
<code class="linenos">40 </code>
<code class="linenos">41 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">42 </code>ust_dc_1/
<code class="linenos">43 </code>	 http://knowledgebooks.com/ontology#containsPerson
<code class="linenos">44 </code>	 "Vladimir Putin" .
<code class="linenos">45 </code>
<code class="linenos">46 </code>http://news.yahoo.com/s/nm/20080616/ts_nm/worldleaders_tr\
<code class="linenos">47 </code>ust_dc_1/
<code class="linenos">48 </code>	 http://knowledgebooks.com/ontology#containsState
<code class="linenos">49 </code>	 "Maryland" .
</pre></div>

</figure>

<p>We are finished with our quick tutorial on using the SELECT query form. There are three other query forms that I am not covering in this chapter:</p>

<ul>
  <li>
<a href="https://www.w3.org/TR/rdf-sparql-query/#construct">CONSTRUCT</a> – returns a new RDF graph of query results</li>
  <li>
<a href="https://www.w3.org/TR/rdf-sparql-query/#ask">ASK</a> – returns Boolean true or false indicating if a query matches
any triples</li>
  <li>
<a href="https://www.w3.org/TR/rdf-sparql-query/#describe">DESCRIBE</a> – returns a new RDF graph containing matched resources</li>
</ul>

<p>A common SELECT matching pattern that I don’t cover in this chapter is <a href="https://www.w3.org/TR/rdf-sparql-query/#optionals">optional</a>.</p>

<h3 id="owl">OWL: The Web Ontology Language</h3>

<p>We have already seen a few examples of using RDFS to define sub-properties in this chapter. The Web Ontology Language (OWL) extends the expressive power of RDFS. We now look at a few OWL examples and then look at parts of the Java unit test showing three SPARQL queries that use OWL reasoning. The following RDF data stores support at least some level of OWL reasoning:</p>

<ul>
  <li>ProtegeOwlApis - compatible with the Protege Ontology editor</li>
  <li>Pellet - DL reasoner</li>
  <li>Owlim - OWL DL reasoner compatible with some versions of Sesame</li>
  <li>Jena - General purpose library</li>
  <li>OWLAPI - a simpler API using many other libraries</li>
  <li>Stardog - a commercial OWL and RDF reasoning system and datastore</li>
  <li>Allegrograph - a commercial RDF+ and RDF reasoning system and datastore</li>
</ul>

<p>OWL is more expressive than RDFS in that it supports cardinality, richer class relationships, and Descriptive Logic (DL) reasoning. OWL treats the idea of classes very differently than object oriented programming languages like Java and Smalltalk, but similar to the way PowerLoom (see chapter on <em>Reasoning</em>) uses concepts (PowerLoom’s rough equivalent to a class). In OWL, instances of a class are referred to as individuals and class membership is determined by a set of properties that allow a DL reasoner to infer class membership of an individual (this is called entailment.)</p>

<p>We saw an example of expressing transitive relationships when we were using PowerLoom in the chapter on <em>Reasoning</em> where we defined a PowerLoom rule to express that the relation “contains” is transitive. We will now look at a similar example using OWL.</p>

<p>We have been using the RDF file news.n3 in previous examples and we will layer new examples by adding new triples that represent RDF, RDFS, and OWL. We saw in news.n3 the definition of three triples using <strong>rdfs:subPropertyOf</strong> properties to create a more general kb:containsPlace property:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsCountry</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
<code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">rdfs</code><code class="p">:</code><code class="nt">subPropertyOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>

<code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="nn">rdf</code><code class="p">:</code><code class="nt">type</code> <code class="nn">owl</code><code class="p">:</code><code class="nt">transitiveProperty</code> <code class="p">.</code>

<code class="nn">kbplace</code><code class="p">:</code><code class="nt">UnitedStates</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsState</code> <code class="nn">kbplace</code><code class="p">:</code><code class="nt">Illinois</code> <code class="p">.</code>
<code class="nn">kbplace</code><code class="p">:</code><code class="nt">Illinois</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsCity</code> <code class="nn">kbplace</code><code class="p">:</code><code class="nt">Chicago</code> <code class="p">.</code>
</pre></div>

</figure>

<p>We can also infer that:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">kbplace</code><code class="p">:</code><code class="nt">UnitedStates</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="nn">kbplace</code><code class="p">:</code><code class="nt">Chicago</code> <code class="p">.</code>
</pre></div>

</figure>

<p>We can also model inverse properties in OWL. For example, here we add an inverse property kb:containedIn, adding it to the example in the last listing:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="nn">kb</code><code class="p">:</code><code class="nt">containedIn</code> <code class="nn">owl</code><code class="p">:</code><code class="nt">inverseOf</code> <code class="nn">kb</code><code class="p">:</code><code class="nt">containsPlace</code> <code class="p">.</code>
</pre></div>

</figure>

<p>Given an RDF container that supported extended OWL DL SPARQL queries, we can now execute SPARQL queries matching the property kb:containedIn and “match” triples in the RDF triple store that have never been asserted but are inferred by the OWL reasoner.</p>

<p>OWL DL is a very large subset of full OWL. From reading the chapter on Reasoning and the very light coverage of OWL in this section, you should understand the concept of class membership not by explicitly stating that an object (or individual) is a member of a class, but rather because an individual has properties that can be used to infer class membership.</p>

<p>The World Wide Web Consortium has defined three versions of the OWL language that are in increasing order of complexity: OWL Lite, OWL DL, and OWL Full. OWL DL (supports Description Logic) is the most widely used (and recommended) version of OWL. OWL Full is not computationally decidable since it supports full logic, multiple class inheritance, and other things that probably make it computationally intractable for all but smaller problems.</p>

<h3 id="leanpub-auto-semantic-web-wrap-up">Semantic Web Wrap-up</h3>

<p>Writing Semantic Web applications and building Knowledge Graphs is a very large topic, worthy of an entire book. I have covered in this chapter the background material for the next two chapters: writing Clojure wrappers for using the Jena library and the Knowledge Graph Navigator application.</p>


<h2 id="leanpub-auto-clojure-wrapper-for-the-jena-rdf-and-sparql-library">Clojure Wrapper for the Jena RDF and SPARQL Library</h2>

<p>If you read through the optional background material in the last chapter you have some understanding of RDF Data and SPARQL queries. If you skipped the last chapter you can still follow along with the code here.</p>

<p>When querying remote SPARQL endpoints like DBPedia and WikiData I often find that I repeatedly make some of the same queries many times, especially during development and testing. I have found that by caching SPARQL query results that I can greatly improve my developer experience. We will use the Apache Derby relational database (pure Java code and easy to embed in applications) for query caching.</p>

<p>One of the examples in the chapter <a href="#libpython">Python/Clojure Interoperation Using the libpython-clj Library</a> performed SPARQL queries using simple pure Clojure code. The Jena libraries used here provide more functionality but I use both approaches in my own work.</p>

<p>We declare both Jena and the Derby relational database libraries as dependencies in our project file:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">defproject </code><code class="nv">semantic_web_jena_clj</code> <code class="s">"0.1.0-SNAPSHOT"</code>
<code class="linenos"> 2 </code>  <code class="ss">:description</code> <code class="s">"Clojure Wrapper for Apache Jena"</code>
<code class="linenos"> 3 </code>  <code class="ss">:url</code> <code class="s">"https://markwatson.com"</code>
<code class="linenos"> 4 </code>  <code class="ss">:license</code>
<code class="linenos"> 5 </code>  <code class="p">{</code><code class="ss">:name</code> <code class="s">"EPL-2.0 OR GPL-2+ WITH Classpath-exception-2.0"</code>
<code class="linenos"> 6 </code>   <code class="ss">:url</code> <code class="s">"https://www.eclipse.org/legal/epl-2.0/"</code><code class="p">}</code>
<code class="linenos"> 7 </code>  <code class="ss">:source-paths</code>      <code class="p">[</code><code class="s">"src"</code><code class="p">]</code>
<code class="linenos"> 8 </code>  <code class="ss">:java-source-paths</code> <code class="p">[</code><code class="s">"src-java"</code><code class="p">]</code>
<code class="linenos"> 9 </code>  <code class="ss">:javac-options</code>     <code class="p">[</code><code class="s">"-target"</code> <code class="s">"1.8"</code> <code class="s">"-source"</code> <code class="s">"1.8"</code><code class="p">]</code>
<code class="linenos">10 </code>  <code class="ss">:dependencies</code> <code class="p">[[</code><code class="nv">org.clojure/clojure</code> <code class="s">"1.10.1"</code><code class="p">]</code>
<code class="linenos">11 </code>                 <code class="p">[</code><code class="nv">org.apache.derby/derby</code> <code class="s">"10.15.2.0"</code><code class="p">]</code>
<code class="linenos">12 </code>                 <code class="p">[</code><code class="nv">org.apache.derby/derbytools</code> <code class="s">"10.15.2.0"</code><code class="p">]</code>
<code class="linenos">13 </code>                 <code class="p">[</code><code class="nv">org.apache.derby/derbyclient</code>
<code class="linenos">14 </code>                  <code class="s">"10.15.2.0"</code><code class="p">]</code>
<code class="linenos">15 </code>                 <code class="p">[</code><code class="nv">org.apache.jena/apache-jena-libs</code>
<code class="linenos">16 </code>                  <code class="s">"3.17.0"</code> <code class="ss">:extension</code> <code class="s">"pom"</code><code class="p">]]</code>
<code class="linenos">17 </code>  <code class="ss">:repl-options</code> <code class="p">{</code><code class="ss">:init-ns</code> <code class="nv">semantic-web-jena-clj.core</code><code class="p">})</code>
</pre></div>

</figure>

<p>We will use the Jena library for handling RDF and SPARQL queries and the Derby database library for implementing query caching. Please note that the directory structure for this project also includes Java code that I wrote to wrap the Jena APIs for my specific needs (some files not shown for brevity):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>$ tree                
<code class="linenos"> 2 </code>.
<code class="linenos"> 3 </code>├── LICENSE
<code class="linenos"> 4 </code>├── README.md
<code class="linenos"> 5 </code>├── data
<code class="linenos"> 6 </code>│   ├── business.sql
<code class="linenos"> 7 </code>│   ├── news.nt
<code class="linenos"> 8 </code>│   ├── sample_news.nt
<code class="linenos"> 9 </code>├── pom.xml
<code class="linenos">10 </code>├── project.clj
<code class="linenos">11 </code>├── src
<code class="linenos">12 </code>│   └── semantic_web_jena_clj
<code class="linenos">13 </code>│       └── core.clj
<code class="linenos">14 </code>├── src-java
<code class="linenos">15 </code>│   └── main
<code class="linenos">16 </code>│       ├── java
<code class="linenos">17 </code>│       │   └── com
<code class="linenos">18 </code>│       │       └── markwatson
<code class="linenos">19 </code>│       │           └── semanticweb
<code class="linenos">20 </code>│       │               ├── Cache.java
<code class="linenos">21 </code>│       │               ├── JenaApis.java
<code class="linenos">22 </code>│       │               └── QueryResult.java
<code class="linenos">23 </code>│       └── resources
<code class="linenos">24 </code>│           └── log4j.xml
<code class="linenos">25 </code>└── <code class="nb">test</code>
<code class="linenos">26 </code>    └── semantic_web_jena_clj
<code class="linenos">27 </code>        └── core_test.clj
</pre></div>

</figure>

<p>While I expect that you will just use the Java code as is, there is one modification that you might want to make for your applications: I turned on OWL reasoning by default. If you don’t need OWL reasoning and you will be working with large numbers of RDF triples (tens of millions should fit nicely in-memory on your laptop), then you might want to change the following two lines of code in <strong>JenaApis.java</strong> by uncommenting line 2 and commenting line 4:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code> <code class="c1">// use if OWL reasoning not required:</code>
<code class="linenos">2 </code> <code class="c1">//model = ModelFactory.createDefaultModel();</code>
<code class="linenos">3 </code> <code class="c1">// to use the OWL reasoner:</code>
<code class="linenos">4 </code> <code class="n">model</code> <code class="o">=</code> <code class="n">ModelFactory</code><code class="p">.</code><code class="na">createOntologyModel</code><code class="p">();</code>
</pre></div>

</figure>

<p>OWL reasoning is expensive but for small RDF Data sets you might as well leave it turned on.</p>

<p>I don’t list the file <strong>JenaApis.java</strong> here but you might want to have it open in an editor while reading the following listing of the Clojure code that wraps this Java code.</p>

<p>The Clojure wrapping functions are mostly self-explanatory. The main corner case is converting Java results from Jena to Clojure <strong>seq</strong> data structures, as we do in lines 13-14.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">semantic-web-jena-clj.core</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:import</code> <code class="p">(</code><code class="nf">com.markwatson.semanticweb</code> <code class="nv">JenaApis</code> <code class="nv">Cache</code>
<code class="linenos"> 3 </code>                                       <code class="nv">QueryResult</code><code class="p">)))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">defn- </code><code class="nv">get-jena-api-model</code>
<code class="linenos"> 6 </code>  <code class="s">"get a default model with OWL reasoning"</code>
<code class="linenos"> 7 </code>  <code class="p">[]</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">new </code><code class="nv">JenaApis</code><code class="p">))</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="kd">defonce </code><code class="nv">model</code> <code class="p">(</code><code class="nf">get-jena-api-model</code><code class="p">))</code>
<code class="linenos">11 </code>
<code class="linenos">12 </code><code class="p">(</code><code class="kd">defn- </code><code class="nv">results-&gt;clj</code> <code class="p">[</code><code class="nv">results</code><code class="p">]</code>
<code class="linenos">13 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">variable-list</code> <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="k">. </code><code class="nv">results</code> <code class="nv">variableList</code><code class="p">))</code>
<code class="linenos">14 </code>        <code class="nv">bindings-list</code> <code class="p">(</code><code class="nb">seq </code><code class="p">(</code><code class="nb">map seq </code><code class="p">(</code><code class="k">. </code><code class="nv">results</code> <code class="nv">rows</code><code class="p">)))]</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nb">cons </code><code class="nv">variable-list</code> <code class="nv">bindings-list</code><code class="p">)))</code>
<code class="linenos">16 </code>
<code class="linenos">17 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">load-rdf-file</code> <code class="p">[</code><code class="nv">fpath</code><code class="p">]</code>
<code class="linenos">18 </code>  <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">loadRdfFile</code> <code class="nv">fpath</code><code class="p">))</code>
<code class="linenos">19 </code>
<code class="linenos">20 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">query</code> <code class="s">"SPARQL query"</code> <code class="p">[</code><code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">21 </code>  <code class="p">(</code><code class="nf">results-&gt;clj</code> <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">query</code> <code class="nv">sparql-query</code><code class="p">)))</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">query-remote</code>
<code class="linenos">24 </code> <code class="s">"remote service like DBPedia, etc."</code>
<code class="linenos">25 </code> <code class="p">[</code><code class="nv">remote-service</code> <code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">26 </code>  <code class="p">(</code><code class="nf">results-&gt;clj</code>
<code class="linenos">27 </code>    <code class="p">(</code><code class="k">. </code><code class="nv">model</code> <code class="nv">queryRemote</code> <code class="nv">remote-service</code> <code class="nv">sparql-query</code><code class="p">)))</code>
<code class="linenos">28 </code>
<code class="linenos">29 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">query-dbpedia</code> <code class="p">[</code><code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">30 </code>  <code class="p">(</code><code class="nf">query-remote</code> <code class="s">"https://dbpedia.org/sparql"</code>
<code class="linenos">31 </code>                <code class="nv">sparql-query</code><code class="p">))</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">query-wikidata</code> <code class="p">[</code><code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">34 </code>  <code class="p">(</code><code class="nf">query-remote</code>
<code class="linenos">35 </code>    <code class="s">"https://query.wikidata.org/bigdata/namespace/wdq/spa\</code>
<code class="linenos">36 </code><code class="s">rql"</code> <code class="nv">sparql-query</code><code class="p">))</code>
</pre></div>

</figure>

<p>Here is a listing of text code that loads RDF data from a file and does a SPARQL query, SPARQL queries DBPedia, and SPARQL queries WikiData:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">semantic-web-jena-clj.core-test</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.test</code> <code class="ss">:refer</code> <code class="ss">:all</code><code class="p">]</code>
<code class="linenos"> 3 </code>            <code class="p">[</code><code class="nv">semantic-web-jena-clj.core</code> <code class="ss">:refer</code> <code class="ss">:all</code><code class="p">]))</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="nf">deftest</code> <code class="nv">load-data-and-sample-queries</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="nf">testing</code>
<code class="linenos"> 7 </code>    <code class="s">"Load local triples files and SPARQL queries"</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nf">load-rdf-file</code> <code class="s">"data/sample_news.nt"</code><code class="p">)</code>
<code class="linenos"> 9 </code>    <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">results</code> <code class="p">(</code><code class="nf">query</code> <code class="s">"select * { ?s ?p ?o } limit 5"</code><code class="p">)]</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="nb">println </code><code class="nv">results</code><code class="p">)</code>
<code class="linenos">11 </code>      <code class="p">(</code><code class="nf">is</code> <code class="p">(</code><code class="nb">= </code><code class="p">(</code><code class="nb">count </code><code class="nv">results</code><code class="p">)</code> <code class="mi">6</code><code class="p">)))))</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="p">(</code><code class="nf">deftest</code> <code class="nv">dbpedia-test</code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="nf">testing</code> <code class="s">"Try SPARQL query to DBPedia endpoint"</code>
<code class="linenos">15 </code>    <code class="p">(</code><code class="nf">println</code>
<code class="linenos">16 </code>      <code class="p">(</code><code class="nf">query-dbpedia</code>
<code class="linenos">17 </code>        <code class="s">"select ?p where { &lt;http://dbpedia.org/resource/B\</code>
<code class="linenos">18 </code><code class="s">ill_Gates&gt; ?p &lt;http://dbpedia.org/resource/Microsoft&gt; . }\</code>
<code class="linenos">19 </code><code class="s"> limit 10"</code><code class="p">))))</code>
<code class="linenos">20 </code>
<code class="linenos">21 </code><code class="p">(</code><code class="nf">deftest</code> <code class="nv">wikidata-test</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="nf">testing</code> <code class="s">"Try SPARQL query to WikiData endpoint"</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="nf">println</code>
<code class="linenos">24 </code>      <code class="p">(</code><code class="nf">query-dbpedia</code>
<code class="linenos">25 </code>        <code class="s">"select * where { ?subject ?property ?object . } \</code>
<code class="linenos">26 </code><code class="s">limit 10"</code><code class="p">))))</code>
</pre></div>

</figure>

<p>You might question line 11: we are checking that the return values as a <strong>seq</strong> of length six while the SPARQL statement limits the returned results to five results on line 9. The “extra” result” of the first element in the <strong>seq</strong> that is a list of variable names from the SPARQL query.</p>

<p>Output will look like (reformatted for readability and most output is not shown):</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code>((subject property object)
<code class="linenos"> 2 </code> (http://www.openlinksw.com/virtrdf-data-formats#default-\
<code class="linenos"> 3 </code>iid
<code class="linenos"> 4 </code>  http://www.w3.org/1999/02/22-rdf-syntax-ns#type
<code class="linenos"> 5 </code>  http://www.openlinksw.com/schemas/virtrdf#QuadMapFormat)
<code class="linenos"> 6 </code> (http://www.openlinksw.com/virtrdf-data-formats#default-\
<code class="linenos"> 7 </code>iid-nullable
<code class="linenos"> 8 </code>  http://www.w3.org/1999/02/22-rdf-syntax-ns#type
<code class="linenos"> 9 </code>  http://www.openlinksw.com/schemas/virtrdf#QuadMapFormat)
<code class="linenos">10 </code>  ...
</pre></div>

</figure>

<p>Data consists of nested lists where the first sub-list is the SPARQL query variable names, in this case: <strong>subject property object</strong>. Subsequent sub-lists are binding values for the query variables.</p>

<p>We will use the Jena wrapper in the next chapter.</p>


<h2 id="kgn">Knowledge Graph Navigator</h2>

<p>The Knowledge Graph Navigator (which I will often refer to as KGN) is a tool for processing a set of entity names and automatically explores the public Knowledge Graph <a href="http://dbpedia.org">DBPedia</a> using SPARQL queries. I started to write KGN for my own use to automate some things I used to do manually when exploring Knowledge Graphs, and later thought that KGN might be also useful for educational purposes. KGN shows the user the auto-generated SPARQL queries so hopefully the user will learn by seeing examples. KGN uses the Clojure Jena wrapper
example code from the last chapter as well the two Java classes <strong>JenaAPis</strong> and <strong>QueryResults</strong> (which wrap the Apache Jena library) that were also included in the example for the previous chapter.</p>

<p><strong>Note:</strong> There are three separate examples for implementing SPARQL queries in this example:</p>

<ul>
  <li>Use the code from the last chapter (Jena and query caching)</li>
  <li>Use a small standalone set of Clojure functions to access DBPedia</li>
  <li>Use a small standalone set of Clojure functions to access a local GraphDB RDF server with the data file <strong>dbpedia_sample.nt</strong> loaded into a graph named <strong>dbpedia</strong>.</li>
</ul>

<p>The example code is set up to use Jena and query caching; edit the file <strong>sparql.clj</strong> to enable the other options.</p>

<p>I have implemented parts of KGN in several languages: Common Lisp, Java, Racket Scheme, Swift, Python, and Hy. The most full featured version of KGN, including a full user interface, is featured in my book <a href="https://leanpub.com/lovinglisp">Loving Common Lisp, or the Savvy Programmer’s Secret Weapon</a> that you can read free online. That version performs more speculative SPARQL queries to find information compared to the example here that I designed for ease of understanding, and modification.</p>

<p>We will be running an example using data containing three person entities, one company entity, and one place entity. The following figure shows a very small part of the DBPedia Knowledge Graph that is centered around these entities. The data for this figure was collected by an example Knowledge Graph Creator from my Common Lisp book:</p>


<div class="figure-wrapper center">
  <figure class="image" style="width: 287px">
    <img src="images/graphdb.jpg" alt="File dbpedia_sample.nt loaded into the free version of GraphDB" style="width: 100%">
    <figcaption>File dbpedia_sample.nt loaded into the free version of GraphDB</figcaption>
  </figure>
</div>


<p>I chose to use DBPedia instead of WikiData for this example because DBPedia URIs are human readable. The following URIs represent the concept of a <em>person</em>. The semantic meanings of DBPedia and FOAF (friend of a friend) URIs are self-evident to a human reader while the WikiData URI is not:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code>http://www.wikidata.org/entity/Q215627
http://dbpedia.org/ontology/Person
http://xmlns.com/foaf/0.1/name
</pre></div>

</figure>

<p>I frequently use WikiData in my work and WikiData is one of the most useful public knowledge bases. I have both DBPedia and WikiData Sparql endpoints in the example code that we will look at later, with the WikiData endpoint comment out. You can try manually querying WikiData at the <a href="https://query.wikidata.org">WikiData SPARL endpoint</a>. For example, you might explore the WikiData URI for the <em>person</em> concept using:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">select</code> <code class="nv">?p</code> <code class="nv">?o</code> <code class="k">where</code> <code class="p">{</code>
 <code class="nl">&lt;http://www.wikidata.org/entity/Q215627&gt;</code> <code class="nv">?p</code> <code class="nv">?o</code> <code class="p">.</code>
<code class="p">}</code> <code class="k">limit</code> <code class="mi">10</code>
</pre></div>

</figure>

<p>For the rest of this chapter we will just use DBPedia or data copied from DBPedia.</p>

<p>After looking an interactive session using the example program for this chapter we will look at the implementation.</p>

<h3 id="leanpub-auto-entity-types-handled-by-kgn">Entity Types Handled by KGN</h3>

<p>To keep this example simple we handle just three entity types:</p>

<ul>
  <li>People</li>
  <li>Organizations</li>
  <li>Places</li>
</ul>

<p>In addition to finding detailed information for people, organizations, and places we will also search for relationships between entities. This search process consists of generating a series of SPARQL queries and calling the DBPedia SPARQL endpoint.</p>

<p>Before we design and write the code, I want to show you sample output for our example program:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">(</code><code class="nf">kgn</code> <code class="p">{</code><code class="ss">:People</code> <code class="p">[</code><code class="s">"Bill Gates"</code> <code class="s">"Steve Jobs"</code> <code class="s">"Melinda Gates"</code><code class="p">]</code>
      <code class="ss">:Organization</code> <code class="p">[</code><code class="s">"Microsoft"</code><code class="p">]</code>
      <code class="ss">:Place</code>        <code class="p">[</code><code class="s">"California"</code><code class="p">]})</code>
</pre></div>

</figure>

<p>The output (with some text shortened) is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="p">{:</code><code class="err">e</code><code class="kc">nt</code><code class="err">i</code><code class="kc">t</code><code class="err">y</code><code class="mi">-</code><code class="err">summaries</code>
 <code class="err">((</code><code class="s2">"Bill Gates"</code>
   <code class="s2">"http://dbpedia.org/resource/Bill_Gates"</code>
   <code class="s2">"William Henry Gates III (born October 28, 1955) is an\</code>
<code class="s2"> American business magnate, software developer, investor,\</code>
<code class="s2"> and philanthropist. He is best known as the co-founder o\</code>
<code class="s2">f Microsoft Corporation. During his career..."</code><code class="err">)</code>
  <code class="err">(</code><code class="s2">"Steve Jobs"</code>
   <code class="s2">"http://dbpedia.org/resource/Steve_Jobs"</code>
   <code class="s2">"Steven Paul Jobs (; February 24, 1955 – October 5, 20\</code>
<code class="s2">11) was an American business magnate, industrial designer\</code>
<code class="s2">, investor, and media proprietor. He was the chairman, ch\</code>
<code class="s2">ief executive officer (CEO), and co-founder of Apple Inc.\</code>
<code class="s2">, the chairman and majority shareholder of Pixar..."</code><code class="err">)</code>
  <code class="err">(</code><code class="s2">"Melinda Gates"</code>
   <code class="s2">"http://dbpedia.org/resource/Melinda_Gates"</code>
   <code class="s2">"Melinda Ann Gates (née French; August 15, 1964) is an\</code>
<code class="s2"> American philanthropist and a former general manager at \</code>
<code class="s2">Microsoft. In 2000, she co-founded the Bill &amp; Melinda Gat\</code>
<code class="s2">es Foundation with her husband Bill Gates..."</code><code class="err">)</code>
  <code class="err">(</code><code class="s2">"Microsoft"</code>
   <code class="s2">"http://dbpedia.org/resource/Microsoft"</code>
   <code class="s2">"Microsoft Corporation () is an American multinational\</code>
<code class="s2"> technology company with headquarters in Redmond, Washing\</code>
<code class="s2">ton. It develops, manufactures, licenses, supports, and s\</code>
<code class="s2">ells computer software..."</code><code class="err">)</code>
  <code class="err">(</code><code class="s2">"California"</code>
   <code class="s2">"http://dbpedia.org/resource/California"</code>
   <code class="s2">"California is a state in the Pacific Region of the Un\</code>
<code class="s2">ited States. With 39.5 million residents across ..."</code><code class="err">))</code><code class="p">,</code>
 <code class="p">:</code><code class="err">discovered</code><code class="mi">-</code><code class="err">rela</code><code class="kc">t</code><code class="err">io</code><code class="kc">ns</code><code class="err">hips</code>
 <code class="err">((</code><code class="p">[</code><code class="s2">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/property/spouse&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/resource/Melinda_Gates&gt;"</code><code class="p">]</code>
   <code class="p">[</code><code class="s2">"&lt;http://dbpedia.org/resource/Melinda_Gates&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/property/spouse&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code><code class="p">]</code><code class="err">)</code>
  <code class="err">(</code><code class="p">[</code><code class="s2">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/ontology/knownFor&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/resource/Microsoft&gt;"</code><code class="p">]</code>
   <code class="p">[</code><code class="s2">"&lt;http://dbpedia.org/resource/Microsoft&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/property/founders&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/resource/Bill_Gates&gt;"</code><code class="p">]</code><code class="err">)</code>
  <code class="err">(</code><code class="p">[</code><code class="s2">"&lt;http://dbpedia.org/resource/Steve_Jobs&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/ontology/birthPlace&gt;"</code>
    <code class="s2">"&lt;http://dbpedia.org/resource/California&gt;"</code><code class="p">]</code><code class="err">))</code><code class="p">}</code>
</pre></div>

</figure>

<p>Note that the output from the function <strong>kgn</strong> is a map containing two keys: <strong>:entity-summaries</strong> and <strong>:discovered-relationships</strong>.</p>

<h3 id="leanpub-auto-kgn-implementation">KGN Implementation</h3>

<p>The example application works processing a list or Person, Place, and Organization names. We generate SPARQL queries to DBPedia to find information about the entities and relationships between them.</p>

<p>Since the DBPedia queries are time consuming, I created a tiny subset of DBPedia in the file <strong>dbpedia_sample.nt</strong> and load it into a RDF data store like <strong>GraphDB</strong> or <strong>Fuseki</strong> running on my laptop. This local setup is especially helpful during development when the same queries are repeatedly used for testing. If you don’t modify the file <strong>sparql.clj</strong> then by default the public DBPedia SPARQL endpoint will be used.</p>

<p>The Clojure and Java files from the example in the last chapter were copied un-changed to the current example and the <strong>project.clj</strong> file contains the same dependencies as we used earlier:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">defproject </code><code class="nv">knowledge_graph_navigator_clj</code> <code class="s">"0.1.0-SNAPSHOT"</code>
<code class="linenos"> 2 </code>  <code class="ss">:description</code> <code class="s">"Knowledge Graph Navigator"</code>
<code class="linenos"> 3 </code>  <code class="ss">:url</code> <code class="s">"https://markwatson.com"</code>
<code class="linenos"> 4 </code>  <code class="ss">:license</code>
<code class="linenos"> 5 </code>  <code class="p">{</code><code class="ss">:name</code>
<code class="linenos"> 6 </code>   <code class="s">"EPL-2.0 OR GPL-2+ WITH Classpath-exception-2.0"</code>
<code class="linenos"> 7 </code>   <code class="ss">:url</code>  <code class="s">"https://www.eclipse.org/legal/epl-2.0/"</code><code class="p">}</code>
<code class="linenos"> 8 </code>  <code class="ss">:source-paths</code>      <code class="p">[</code><code class="s">"src"</code><code class="p">]</code>
<code class="linenos"> 9 </code>  <code class="ss">:java-source-paths</code> <code class="p">[</code><code class="s">"src-java"</code><code class="p">]</code>
<code class="linenos">10 </code>  <code class="ss">:javac-options</code>     <code class="p">[</code><code class="s">"-target"</code> <code class="s">"1.8"</code> <code class="s">"-source"</code> <code class="s">"1.8"</code><code class="p">]</code>
<code class="linenos">11 </code>  <code class="ss">:dependencies</code> <code class="p">[[</code><code class="nv">org.clojure/clojure</code> <code class="s">"1.10.1"</code><code class="p">]</code>
<code class="linenos">12 </code>                 <code class="p">[</code><code class="nv">clj-http</code> <code class="s">"3.10.3"</code><code class="p">]</code>
<code class="linenos">13 </code>                 <code class="p">[</code><code class="nv">com.cemerick/url</code> <code class="s">"0.1.1"</code><code class="p">]</code>
<code class="linenos">14 </code>                 <code class="p">[</code><code class="nv">org.clojure/data.csv</code> <code class="s">"1.0.0"</code><code class="p">]</code>
<code class="linenos">15 </code>                 <code class="p">[</code><code class="nv">org.clojure/data.json</code> <code class="s">"1.0.0"</code><code class="p">]</code>
<code class="linenos">16 </code>                 <code class="p">[</code><code class="nv">org.clojure/math.combinatorics</code> <code class="s">"0.1.6"</code><code class="p">]</code>
<code class="linenos">17 </code>                 <code class="p">[</code><code class="nv">org.apache.derby/derby</code> <code class="s">"10.15.2.0"</code><code class="p">]</code>
<code class="linenos">18 </code>                 <code class="p">[</code><code class="nv">org.apache.derby/derbytools</code> <code class="s">"10.15.2.0"</code><code class="p">]</code>
<code class="linenos">19 </code>                 <code class="p">[</code><code class="nv">org.apache.derby/derbyclient</code>
<code class="linenos">20 </code>                  <code class="s">"10.15.2.0"</code><code class="p">]</code>
<code class="linenos">21 </code>                 <code class="p">[</code><code class="nv">org.apache.jena/apache-jena-libs</code>
<code class="linenos">22 </code>                  <code class="s">"3.17.0"</code> <code class="ss">:extension</code> <code class="s">"pom"</code><code class="p">]]</code>
<code class="linenos">23 </code>  <code class="ss">:repl-options</code>
<code class="linenos">24 </code>  <code class="p">{</code><code class="ss">:init-ns</code> <code class="nv">knowledge-graph-navigator-clj.kgn</code><code class="p">}</code>
<code class="linenos">25 </code>  <code class="ss">:main</code> <code class="o">^</code><code class="ss">:skip-aot</code> <code class="nv">knowledge-graph-navigator-clj.kgn</code><code class="p">)</code>
</pre></div>

</figure>

<p>I copied the code from the last chapter into this project to save readers from needing to <strong>lein install</strong> the project in the last chapter. We won’t look at that code again here.</p>

<p>This example is contained in several source files. We will start at the low-level code in <strong>sparql.clj</strong>. You can edit lines 10-11 if you want to change which SPARQL libraries and endpoints you want to use. There are utility functions for using DBPedia (lines 13-20), the free version of GraphDB (lines 22-35), and a top level function <strong>sparql-endpoint</strong> that can be configured to use the options you can change in lines 10-11. I have a top level wrapper function <strong>sparql-endpoint</strong> so the remainder of the example works without modification with all options. Lines 52-57 is a small main function to facilitate working with this file in isolation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">knowledge-graph-navigator-clj.sparql</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clj-http.client</code> <code class="ss">:as</code> <code class="nv">client</code><code class="p">])</code>
<code class="linenos"> 3 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="nv">clojure.stacktrace</code><code class="p">)</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">cemerick.url</code> <code class="ss">:refer</code> <code class="p">(</code><code class="nf">url-encode</code><code class="p">)])</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.data.csv</code> <code class="ss">:as</code> <code class="nv">csv</code><code class="p">])</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">semantic-web-jena-clj.core</code> <code class="ss">:as</code> <code class="nv">jena</code><code class="p">]))</code>
<code class="linenos"> 7 </code>
<code class="linenos"> 8 </code><code class="c1">;; see https://github.com/mark-watson/clj-sparql</code>
<code class="linenos"> 9 </code>
<code class="linenos">10 </code><code class="p">(</code><code class="k">def </code><code class="nv">USE-LOCAL-GRAPHDB</code> <code class="nv">false</code><code class="p">)</code>
<code class="linenos">11 </code><code class="p">(</code><code class="k">def </code><code class="nv">USE-CACHING</code> <code class="nv">true</code><code class="p">)</code> <code class="c1">;; use Jena wrapper</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">dbpedia</code> <code class="p">[</code><code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">14 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">q</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="nf">str</code>
<code class="linenos">16 </code>          <code class="s">"https://dbpedia.org//sparql?output=csv&amp;query="</code>
<code class="linenos">17 </code>          <code class="p">(</code><code class="nf">url-encode</code> <code class="nv">sparql-query</code><code class="p">))</code>
<code class="linenos">18 </code>        <code class="nv">response</code> <code class="p">(</code><code class="nf">client/get</code> <code class="nv">q</code><code class="p">)</code>
<code class="linenos">19 </code>        <code class="nv">body</code> <code class="p">(</code><code class="ss">:body</code> <code class="nv">response</code><code class="p">)]</code>
<code class="linenos">20 </code>    <code class="p">(</code><code class="nf">csv/read-csv</code> <code class="nv">body</code><code class="p">)))</code>
<code class="linenos">21 </code>
<code class="linenos">22 </code><code class="p">(</code><code class="kd">defn- </code><code class="nv">graphdb-helper</code> <code class="p">[</code><code class="nv">host</code> <code class="nv">port</code> <code class="nv">graph-name</code> <code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">23 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">q</code>
<code class="linenos">24 </code>        <code class="p">(</code><code class="nb">str </code><code class="nv">host</code> <code class="s">":"</code> <code class="nv">port</code> <code class="s">"/repositories/"</code> <code class="nv">graph-name</code>
<code class="linenos">25 </code>           <code class="s">"?query="</code> <code class="p">(</code><code class="nf">url-encode</code> <code class="nv">sparql-query</code><code class="p">))</code>
<code class="linenos">26 </code>        <code class="nv">response</code> <code class="p">(</code><code class="nf">client/get</code> <code class="nv">q</code><code class="p">)</code>
<code class="linenos">27 </code>        <code class="nv">body</code> <code class="p">(</code><code class="ss">:body</code> <code class="nv">response</code><code class="p">)]</code>
<code class="linenos">28 </code>    <code class="p">(</code><code class="nf">csv/read-csv</code> <code class="nv">body</code><code class="p">)))</code>
<code class="linenos">29 </code>
<code class="linenos">30 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">graphdb</code>
<code class="linenos">31 </code>  <code class="p">([</code><code class="nv">graph-name</code> <code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">32 </code>  <code class="p">(</code><code class="nf">graphdb-helper</code>
<code class="linenos">33 </code>    <code class="s">"http://127.0.0.1"</code> <code class="mi">7200</code> <code class="nv">graph-name</code> <code class="nv">sparql-query</code><code class="p">))</code>
<code class="linenos">34 </code>  <code class="p">([</code><code class="nv">host</code> <code class="nv">port</code> <code class="nv">graph-name</code> <code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">35 </code>    <code class="p">(</code><code class="nf">graphdb-helper</code> <code class="nv">host</code> <code class="nv">port</code> <code class="nv">graph-name</code> <code class="nv">sparql-query</code><code class="p">)))</code>
<code class="linenos">36 </code>
<code class="linenos">37 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">sparql-endpoint</code> <code class="p">[</code><code class="nv">sparql-query</code><code class="p">]</code>
<code class="linenos">38 </code>  <code class="p">(</code><code class="nf">try</code>
<code class="linenos">39 </code>    <code class="p">(</code><code class="k">if </code><code class="nv">USE-LOCAL-GRAPHDB</code>
<code class="linenos">40 </code>      <code class="p">(</code><code class="nf">graphdb</code> <code class="s">"dbpedia"</code> <code class="nv">sparql-query</code><code class="p">)</code>
<code class="linenos">41 </code>      <code class="p">(</code><code class="k">if </code><code class="nv">USE-CACHING</code>
<code class="linenos">42 </code>        <code class="p">(</code><code class="nf">jena/query-dbpedia</code> <code class="nv">sparql-query</code><code class="p">)</code>
<code class="linenos">43 </code>        <code class="p">(</code><code class="nf">dbpedia</code> <code class="nv">sparql-query</code><code class="p">)))</code>
<code class="linenos">44 </code>    <code class="p">(</code><code class="nf">catch</code> <code class="nv">Exception</code> <code class="nv">e</code>
<code class="linenos">45 </code>      <code class="p">(</code><code class="nf">do</code>
<code class="linenos">46 </code>        <code class="p">(</code><code class="nf">println</code>
<code class="linenos">47 </code>          <code class="s">"WARNING: query failed:\n"</code> <code class="nv">sparql-query</code><code class="p">)</code>
<code class="linenos">48 </code>        <code class="p">(</code><code class="nb">println </code><code class="p">(</code><code class="nf">.getMessage</code> <code class="nv">e</code><code class="p">))</code>
<code class="linenos">49 </code>        <code class="p">(</code><code class="nf">clojure.stacktrace/print-stack-trace</code> <code class="nv">e</code><code class="p">)</code>
<code class="linenos">50 </code>        <code class="p">[]))))</code>
<code class="linenos">51 </code>
<code class="linenos">52 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code>
<code class="linenos">53 </code>  <code class="s">"SPARQL example"</code>
<code class="linenos">54 </code>  <code class="p">[</code><code class="o">&amp;</code> <code class="nv">_</code><code class="p">]</code>
<code class="linenos">55 </code>  <code class="p">(</code><code class="nf">println</code>
<code class="linenos">56 </code>    <code class="p">(</code><code class="nf">sparql-endpoint</code>
<code class="linenos">57 </code>      <code class="s">"select * { ?s ?p ?o } limit 10"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The next source file <strong>sparql_utils.clj</strong> contains one function that loads a SPARQL template file and performs variable substitutions from a map:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">knowledge-graph-navigator-clj.sparql-utils</code><code class="p">)</code>
<code class="linenos"> 2 </code>
<code class="linenos"> 3 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">sparql_template</code>
<code class="linenos"> 4 </code>  <code class="s">"open SPARQL template file and perform</code>
<code class="linenos"> 5 </code><code class="s">   variable substitutions"</code>
<code class="linenos"> 6 </code>  <code class="p">[</code><code class="nv">template-fpath</code> <code class="nv">substitution-map</code><code class="p">]</code>
<code class="linenos"> 7 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">template-as-string</code> <code class="p">(</code><code class="nb">slurp </code><code class="nv">template-fpath</code><code class="p">)]</code>
<code class="linenos"> 8 </code>    <code class="p">(</code><code class="nf">clojure.string/replace</code>
<code class="linenos"> 9 </code>      <code class="nv">template-as-string</code>
<code class="linenos">10 </code>      <code class="p">(</code><code class="nf">re-pattern</code>
<code class="linenos">11 </code>        <code class="c1">; create a regex pattern of quoted replacements </code>
<code class="linenos">12 </code>        <code class="c1">; separated by |</code>
<code class="linenos">13 </code>        <code class="c1">; this code is derived from a stackoverflow</code>
<code class="linenos">14 </code>        <code class="c1">; example by user bmillare</code>
<code class="linenos">15 </code>        <code class="p">(</code><code class="nf">apply</code>
<code class="linenos">16 </code>          <code class="nv">str</code>
<code class="linenos">17 </code>          <code class="p">(</code><code class="nf">interpose</code>
<code class="linenos">18 </code>            <code class="s">"|"</code>
<code class="linenos">19 </code>            <code class="p">(</code><code class="nf">map</code>
<code class="linenos">20 </code>              <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">x</code><code class="p">]</code> <code class="p">(</code><code class="nf">java.util.regex.Pattern/quote</code> <code class="nv">x</code><code class="p">))</code>
<code class="linenos">21 </code>              <code class="p">(</code><code class="nb">keys </code><code class="nv">substitution-map</code><code class="p">)))))</code>
<code class="linenos">22 </code>      <code class="nv">substitution-map</code><code class="p">)))</code>
</pre></div>

</figure>

<p>The next source file <strong>entities_by_name.clj</strong> provides the functionality of finding DBPedia entity URIs for names of entities, for example “Steve Jobs.” The heart of this functionality is one SPARQL query template that is used to look up URIs by name; in this example, the name is hard-wired to “Steve Jobs”. The file <strong>entities_by_name.sparql</strong> contains:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="k">select</code> <code class="k">distinct</code> <code class="nv">?s</code> <code class="nv">?comment</code> <code class="k">where</code> <code class="p">{</code>
<code class="linenos"> 2 </code>    <code class="nv">?s</code> <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</code>
<code class="linenos"> 3 </code>            <code class="s">"&lt;NAME&gt;"</code><code class="o">@</code><code class="nf">en</code> <code class="p">.</code>
<code class="linenos"> 4 </code>    <code class="nv">?s</code> <code class="nl">&lt;http://www.w3.org/2000/01/rdf-schema#comment&gt;</code>
<code class="linenos"> 5 </code>            <code class="nv">?comment</code>  <code class="p">.</code>
<code class="linenos"> 6 </code>    <code class="k">FILTER</code>  <code class="p">(</code><code class="nf">lang</code><code class="p">(</code><code class="nv">?comment</code><code class="p">)</code> <code class="o">=</code> <code class="s">"en"</code><code class="p">)</code> <code class="p">.</code>
<code class="linenos"> 7 </code>    <code class="nv">?s</code>
<code class="linenos"> 8 </code>        <code class="nl">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&gt;</code>
<code class="linenos"> 9 </code>        <code class="nl">&lt;ENTITY_TYPE&gt;</code> <code class="p">.</code>
<code class="linenos">10 </code><code class="p">}</code>
</pre></div>

</figure>

<p>The function <strong>dbpedia-get-entities-by-name</strong> takes two arguments <strong>name</strong> and <strong>dbpedia-type</strong> where <strong>name</strong> was set to “Steve Jobs” and <strong>dbpedia-type</strong> was set to the URI:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>&lt;http://dbpedia.org/ontology/Person&gt;
</pre></div>

</figure>

<p>in the SPARQL query. The <strong>FILTER</strong> statement on line 6 is used to discard all string values that are not tagged to be English language (“en”).</p>

<p>This SPARQL query template file is used in lines in lines 9-11:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">knowledge-graph-navigator-clj.entities-by-name</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">knowledge-graph-navigator-clj.sparql</code>
<code class="linenos"> 3 </code>             <code class="ss">:as</code> <code class="nv">sparql</code><code class="p">])</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.pprint</code> <code class="ss">:as</code> <code class="nv">pp</code><code class="p">])</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="nv">clojure.string</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">dbpedia-get-entities-by-name</code> <code class="p">[</code><code class="nb">name </code><code class="nv">dbpedia-type</code><code class="p">]</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">sparql-query</code>
<code class="linenos"> 9 </code>        <code class="p">(</code><code class="nf">utils/sparql_template</code>
<code class="linenos">10 </code>          <code class="s">"entities_by_name.sparql"</code>
<code class="linenos">11 </code>          <code class="p">{</code><code class="s">"&lt;NAME&gt;"</code> <code class="nb">name </code><code class="s">"&lt;ENTITY_TYPE&gt;"</code> <code class="nv">dbpedia-type</code><code class="p">})</code>
<code class="linenos">12 </code>        <code class="nv">results</code> <code class="p">(</code><code class="nf">sparql/sparql-endpoint</code> <code class="nv">sparql-query</code><code class="p">)]</code>
<code class="linenos">13 </code>    <code class="nv">results</code><code class="p">))</code>
<code class="linenos">14 </code>
<code class="linenos">15 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code>
<code class="linenos">16 </code>  <code class="s">"test/dev entities by name"</code>
<code class="linenos">17 </code>  <code class="p">[</code><code class="o">&amp;</code> <code class="nv">_</code><code class="p">]</code>
<code class="linenos">18 </code>  <code class="p">(</code><code class="nf">println</code>
<code class="linenos">19 </code>    <code class="p">(</code><code class="nf">dbpedia-get-entities-by-name</code>
<code class="linenos">20 </code>      <code class="s">"Steve Jobs"</code>
<code class="linenos">21 </code>      <code class="s">"&lt;http://dbpedia.org/ontology/Person&gt;"</code><code class="p">))</code>
<code class="linenos">22 </code>  <code class="p">(</code><code class="nf">println</code>
<code class="linenos">23 </code>    <code class="p">(</code><code class="nf">dbpedia-get-entities-by-name</code>
<code class="linenos">24 </code>      <code class="s">"Microsoft"</code>
<code class="linenos">25 </code>      <code class="s">"&lt;http://dbpedia.org/ontology/Organization&gt;"</code><code class="p">))</code>
<code class="linenos">26 </code>  <code class="p">(</code><code class="nf">pp/pprint</code>
<code class="linenos">27 </code>    <code class="p">(</code><code class="nf">dbpedia-get-entities-by-name</code>
<code class="linenos">28 </code>      <code class="s">"California"</code>
<code class="linenos">29 </code>      <code class="s">"&lt;http://dbpedia.org/ontology/Place&gt;"</code><code class="p">))</code>
<code class="linenos">30 </code>  <code class="p">)</code>
</pre></div>

</figure>

<p>The main function in lines 23-38 was useful for debugging the SPARQL query and code and I left it in the example so you can run and test this file in isolation.</p>

<p>The last utility function we need is defined in the source file <strong>relationships.clj</strong> that uses another SPARQL query template file. This SPARQL template file <strong>relationships.sparql</strong> contains:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="k">SELECT</code> <code class="k">DISTINCT</code> <code class="nv">?p</code> <code class="p">{</code>
<code class="linenos">2 </code>    <code class="nl">&lt;URI1&gt;</code>
<code class="linenos">3 </code>       <code class="nv">?p</code>
<code class="linenos">4 </code>       <code class="nl">&lt;URI2&gt;</code> <code class="p">.</code>
<code class="linenos">5 </code>    <code class="k">FILTER</code> <code class="p">(</code><code class="o">!</code><code class="nf">regex</code><code class="p">(</code><code class="nf">str</code><code class="p">(</code><code class="nv">?p</code><code class="p">),</code><code class="s">"wikiPage"</code><code class="p">,</code><code class="s">"i"</code><code class="p">))</code>
<code class="linenos">6 </code><code class="p">}</code> <code class="k">LIMIT</code> <code class="mi">5</code>
</pre></div>

</figure>

<p>There are three things to note here. The DISTINCT keyword removes duplicate results, In SPARQL queries URIs are enclosed in <strong>&lt;</strong> <strong>&gt;</strong> angle brackets but the brackets are not included in SPARQL query results so the example code adds them. Also, we are looking for all properties that link the two subject/object entity URIs except we don’t want any property URIs that provides human readable results (“follow your nose” to dereference URIs to a human readable format); these property names contain the string “wikiPage” so we filter them out of the results.</p>

<p>The <strong>map</strong> call on lines 13-16 is used to discard the first SPARQL query result that is a list of variable bindings from the SPARQL query.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">knowledge-graph-navigator-clj.relationships</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">knowledge-graph-navigator-clj.sparql</code>
<code class="linenos"> 3 </code>             <code class="ss">:as</code> <code class="nv">sparql</code><code class="p">])</code>
<code class="linenos"> 4 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.pprint</code> <code class="ss">:as</code> <code class="nv">pp</code><code class="p">])</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="nv">clojure.string</code><code class="p">))</code>
<code class="linenos"> 6 </code>
<code class="linenos"> 7 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">dbpedia-get-relationships</code> <code class="p">[</code><code class="nv">s-uri</code> <code class="nv">o-uri</code><code class="p">]</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">query</code>
<code class="linenos"> 9 </code>        <code class="p">(</code><code class="nf">utils/sparql_template</code>
<code class="linenos">10 </code>          <code class="s">"relationships.sparql"</code>
<code class="linenos">11 </code>          <code class="p">{</code><code class="s">"&lt;URI1&gt;"</code> <code class="nv">s-uri</code> <code class="s">"&lt;URI2&gt;"</code> <code class="nv">o-uri</code><code class="p">})</code>
<code class="linenos">12 </code>        <code class="nv">results</code> <code class="p">(</code><code class="nf">sparql/sparql-endpoint</code> <code class="nv">query</code><code class="p">)]</code>
<code class="linenos">13 </code>    <code class="p">(</code><code class="nf">map</code>
<code class="linenos">14 </code>      <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">u</code><code class="p">]</code> <code class="p">(</code><code class="nf">clojure.string/join</code> <code class="s">""</code> <code class="p">[</code><code class="s">"&lt;"</code> <code class="nv">u</code> <code class="s">"&gt;"</code><code class="p">]))</code>
<code class="linenos">15 </code>        <code class="c1">;;discard SPARQL variable name p (?p):</code>
<code class="linenos">16 </code>        <code class="p">(</code><code class="nb">second </code><code class="nv">results</code><code class="p">))))</code> 
<code class="linenos">17 </code>
<code class="linenos">18 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">entity-results-&gt;relationship-links</code>
<code class="linenos">19 </code>  <code class="p">[</code><code class="nv">uris-no-brackets</code><code class="p">]</code>
<code class="linenos">20 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">uris</code> <code class="p">(</code><code class="nf">map</code>
<code class="linenos">21 </code>               <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">u</code><code class="p">]</code>
<code class="linenos">22 </code>                 <code class="p">(</code><code class="nf">clojure.string/join</code> <code class="s">""</code> <code class="p">[</code><code class="s">"&lt;"</code> <code class="nv">u</code> <code class="s">"&gt;"</code><code class="p">]))</code>
<code class="linenos">23 </code>               <code class="nv">uris-no-brackets</code><code class="p">)</code>
<code class="linenos">24 </code>        <code class="nv">relationship-statements</code> <code class="p">(</code><code class="nf">atom</code> <code class="p">[])]</code>
<code class="linenos">25 </code>    <code class="p">(</code><code class="nb">doseq </code><code class="p">[</code><code class="nv">e1</code> <code class="nv">uris</code><code class="p">]</code>
<code class="linenos">26 </code>      <code class="p">(</code><code class="nb">doseq </code><code class="p">[</code><code class="nv">e2</code> <code class="nv">uris</code><code class="p">]</code>
<code class="linenos">27 </code>        <code class="p">(</code><code class="k">if </code><code class="p">(</code><code class="nb">not </code><code class="p">(</code><code class="nb">= </code><code class="nv">e1</code> <code class="nv">e2</code><code class="p">))</code>
<code class="linenos">28 </code>          <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">l1</code> <code class="p">(</code><code class="nf">dbpedia-get-relationships</code> <code class="nv">e1</code> <code class="nv">e2</code><code class="p">)</code>
<code class="linenos">29 </code>                <code class="nv">l2</code> <code class="p">(</code><code class="nf">dbpedia-get-relationships</code> <code class="nv">e2</code> <code class="nv">e1</code><code class="p">)]</code>
<code class="linenos">30 </code>            <code class="p">(</code><code class="nb">doseq </code><code class="p">[</code><code class="nv">x</code> <code class="nv">l1</code><code class="p">]</code>
<code class="linenos">31 </code>              <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">a-tuple</code> <code class="p">[</code><code class="nv">e1</code> <code class="nv">x</code> <code class="nv">e2</code><code class="p">]]</code>
<code class="linenos">32 </code>                <code class="p">(</code><code class="k">if </code><code class="p">(</code><code class="nf">not</code>
<code class="linenos">33 </code>                      <code class="p">(</code><code class="k">. </code><code class="o">@</code><code class="nv">relationship-statements</code>
<code class="linenos">34 </code>                        <code class="nv">contains</code> <code class="nv">a-tuple</code><code class="p">))</code>
<code class="linenos">35 </code>                  <code class="p">(</code><code class="nf">reset!</code> <code class="nv">relationship-statements</code>
<code class="linenos">36 </code>                    <code class="p">(</code><code class="nb">cons </code><code class="nv">a-tuple</code>
<code class="linenos">37 </code>                          <code class="o">@</code><code class="nv">relationship-statements</code><code class="p">))</code>
<code class="linenos">38 </code>                  <code class="nv">nil</code><code class="p">))</code>
<code class="linenos">39 </code>            <code class="p">(</code><code class="nb">doseq </code><code class="p">[</code><code class="nv">x</code> <code class="nv">l2</code><code class="p">]</code>
<code class="linenos">40 </code>              <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">a-tuple</code> <code class="p">[</code><code class="nv">e2</code> <code class="nv">x</code> <code class="nv">e1</code><code class="p">]]</code>
<code class="linenos">41 </code>                <code class="p">(</code><code class="k">if </code><code class="p">(</code><code class="nf">not</code>
<code class="linenos">42 </code>                      <code class="p">(</code><code class="k">. </code><code class="o">@</code><code class="nv">relationship-statements</code>
<code class="linenos">43 </code>                        <code class="nv">contains</code> <code class="nv">a-tuple</code><code class="p">))</code>
<code class="linenos">44 </code>                  <code class="p">(</code><code class="nf">reset!</code> <code class="nv">relationship-statements</code>
<code class="linenos">45 </code>                    <code class="p">(</code><code class="nb">cons </code><code class="nv">a-tuple</code>
<code class="linenos">46 </code>                          <code class="o">@</code><code class="nv">relationship-statements</code><code class="p">))</code>
<code class="linenos">47 </code>                  <code class="nv">nil</code><code class="p">)))))</code>
<code class="linenos">48 </code>          <code class="nv">nil</code><code class="p">)))</code>
<code class="linenos">49 </code>    <code class="o">@</code><code class="nv">relationship-statements</code><code class="p">))</code>
<code class="linenos">50 </code>
<code class="linenos">51 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code>
<code class="linenos">52 </code>  <code class="s">"dev/test entity relationships code"</code>
<code class="linenos">53 </code>  <code class="p">[</code><code class="o">&amp;</code> <code class="nv">_</code><code class="p">]</code>
<code class="linenos">54 </code>  <code class="p">(</code><code class="nf">println</code>
<code class="linenos">55 </code>    <code class="s">"Testing entity-results-&gt;relationship-links"</code><code class="p">)</code>
<code class="linenos">56 </code>  <code class="p">(</code><code class="nf">pp/pprint</code>
<code class="linenos">57 </code>    <code class="p">(</code><code class="nf">entity-results-&gt;relationship-links</code>
<code class="linenos">58 </code>      <code class="p">[</code><code class="s">"http://dbpedia.org/resource/Bill_Gates"</code>
<code class="linenos">59 </code>       <code class="s">"http://dbpedia.org/resource/Microsoft"</code><code class="p">])))</code>
</pre></div>

</figure>

<p>The function <strong>entity-results-&gt;relationship-links</strong> (lines 18-49) takes a list of entity URIs (without the angle brackets) and if there are <strong>N</strong> input URIs it then generates SPARQL queries for all <strong>O(N^2)</strong> combinations of choosing two entities at a time.</p>

<p>The last source file <strong>kgn.clj</strong> contains the main function for this application. We use the Clojure library <strong>clojure.math.combinatorics</strong> to calculate all combinations of entity URIs, taken two at a time. In lines 11-17 we map entity type symbols to the DBPedia entity type URI for the symbol.</p>

<p>There are two parts to the main function <strong>kgn</strong>:</p>

<ul>
  <li>Lines 24-39 collects comment descriptions for each input entity.</li>
  <li>Lines 40-50 find, for each entity URI pair, possible relationships between entities.</li>
</ul>

<p>Function <strong>kgn</strong> returns a map of summaries and discovered entity relationships that we saw listed early in this chapter.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">knowledge-graph-navigator-clj.kgn</code>
<code class="linenos"> 2 </code>  <code class="p">(</code><code class="ss">:require</code>
<code class="linenos"> 3 </code>    <code class="p">[</code><code class="nv">knowledge-graph-navigator-clj.entities-by-name</code>
<code class="linenos"> 4 </code>     <code class="ss">:as</code> <code class="nv">entity-name</code><code class="p">])</code>
<code class="linenos"> 5 </code>  <code class="p">(</code><code class="ss">:require</code>
<code class="linenos"> 6 </code>    <code class="p">[</code><code class="nv">knowledge-graph-navigator-clj.relationships</code>
<code class="linenos"> 7 </code>     <code class="ss">:as</code> <code class="nv">rel</code><code class="p">])</code>
<code class="linenos"> 8 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.math.combinatorics</code> <code class="ss">:as</code> <code class="nv">combo</code><code class="p">])</code>
<code class="linenos"> 9 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.pprint</code> <code class="ss">:as</code> <code class="nv">pp</code><code class="p">]))</code>
<code class="linenos">10 </code>
<code class="linenos">11 </code><code class="p">(</code><code class="k">def </code><code class="nv">entity-map</code>
<code class="linenos">12 </code>  <code class="p">{</code><code class="ss">:People</code>
<code class="linenos">13 </code>   <code class="s">"&lt;http://dbpedia.org/ontology/Person&gt;"</code>
<code class="linenos">14 </code>   <code class="ss">:Organization</code>
<code class="linenos">15 </code>   <code class="s">"&lt;http://dbpedia.org/ontology/Organization&gt;"</code>
<code class="linenos">16 </code>   <code class="ss">:Place</code>
<code class="linenos">17 </code>   <code class="s">"&lt;http://dbpedia.org/ontology/Place&gt;"</code><code class="p">})</code>
<code class="linenos">18 </code>
<code class="linenos">19 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">kgn</code>
<code class="linenos">20 </code>  <code class="s">"Top level function for the KGN library.</code>
<code class="linenos">21 </code><code class="s">   Inputs: a map with keys Person, Place, and</code>
<code class="linenos">22 </code><code class="s">   Organization. values list of names"</code>
<code class="linenos">23 </code>  <code class="p">[</code><code class="nv">input-entity-map</code><code class="p">]</code>
<code class="linenos">24 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">entities-summary-data</code>
<code class="linenos">25 </code>        <code class="p">(</code><code class="nf">filter</code>
<code class="linenos">26 </code>          <code class="c1">;; get rid of empty SPARQL results:</code>
<code class="linenos">27 </code>          <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">x</code><code class="p">]</code> <code class="p">(</code><code class="nb">&gt; </code><code class="p">(</code><code class="nb">count </code><code class="nv">x</code><code class="p">)</code> <code class="mi">1</code><code class="p">))</code>
<code class="linenos">28 </code>          <code class="p">(</code><code class="nb">mapcat </code>   <code class="c1">;; flatten just top level</code>
<code class="linenos">29 </code>            <code class="nv">identity</code>
<code class="linenos">30 </code>            <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">entity-key</code> <code class="p">(</code><code class="nb">keys </code><code class="nv">input-entity-map</code><code class="p">)]</code>
<code class="linenos">31 </code>              <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">entity-name</code>
<code class="linenos">32 </code>                    <code class="p">(</code><code class="nf">input-entity-map</code> <code class="nv">entity-key</code><code class="p">)]</code>
<code class="linenos">33 </code>                <code class="p">(</code><code class="nf">cons</code>
<code class="linenos">34 </code>                  <code class="nv">entity-name</code>
<code class="linenos">35 </code>                  <code class="p">(</code><code class="nf">second</code>
<code class="linenos">36 </code>                    <code class="p">(</code><code class="nf">entity-name/dbpedia-get-entities-by-</code><code class="err">\</code>
<code class="linenos">37 </code><code class="nb">name </code>
<code class="linenos">38 </code>                     <code class="nv">entity-name</code>
<code class="linenos">39 </code>                     <code class="p">(</code><code class="nf">entity-map</code> <code class="nv">entity-key</code><code class="p">))))))))</code>
<code class="linenos">40 </code>        <code class="nv">entity-uris</code> <code class="p">(</code><code class="nb">map second </code><code class="nv">entities-summary-data</code><code class="p">)</code>
<code class="linenos">41 </code>        <code class="nv">combinations-by-2-of-entity-uris</code>
<code class="linenos">42 </code>        <code class="p">(</code><code class="nf">combo/combinations</code> <code class="nv">entity-uris</code> <code class="mi">2</code><code class="p">)</code>
<code class="linenos">43 </code>        <code class="nv">discovered-relationships</code>
<code class="linenos">44 </code>        <code class="p">(</code><code class="nf">filter</code>
<code class="linenos">45 </code>          <code class="p">(</code><code class="k">fn </code><code class="p">[</code><code class="nv">x</code><code class="p">]</code> <code class="p">(</code><code class="nb">&gt; </code><code class="p">(</code><code class="nb">count </code><code class="nv">x</code><code class="p">)</code> <code class="mi">0</code><code class="p">))</code>
<code class="linenos">46 </code>          <code class="p">(</code><code class="nb">for </code><code class="p">[</code><code class="nv">pair-of-uris</code>
<code class="linenos">47 </code>                <code class="nv">combinations-by-2-of-entity-uris</code><code class="p">]</code>
<code class="linenos">48 </code>            <code class="p">(</code><code class="nf">seq</code>
<code class="linenos">49 </code>              <code class="p">(</code><code class="nf">rel/entity-results-&gt;relationship-links</code>
<code class="linenos">50 </code>                <code class="nv">pair-of-uris</code><code class="p">))))]</code>
<code class="linenos">51 </code>    <code class="p">{</code><code class="ss">:entity-summaries</code> <code class="nv">entities-summary-data</code>
<code class="linenos">52 </code>     <code class="ss">:discovered-relationships</code>
<code class="linenos">53 </code>     <code class="nv">discovered-relationships</code><code class="p">}))</code>
<code class="linenos">54 </code>
<code class="linenos">55 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">-main</code>
<code class="linenos">56 </code>  <code class="s">"Main function for KGN example"</code>
<code class="linenos">57 </code>  <code class="p">[</code><code class="o">&amp;</code> <code class="nv">_</code><code class="p">]</code>
<code class="linenos">58 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">results</code>
<code class="linenos">59 </code>        <code class="p">(</code><code class="nf">kgn</code>
<code class="linenos">60 </code>          <code class="p">{</code><code class="ss">:People</code>
<code class="linenos">61 </code>           <code class="p">[</code><code class="s">"Bill Gates"</code> <code class="s">"Steve Jobs"</code> <code class="s">"Melinda Gates"</code><code class="p">]</code>
<code class="linenos">62 </code>           <code class="ss">:Organization</code> <code class="p">[</code><code class="s">"Microsoft"</code><code class="p">]</code>
<code class="linenos">63 </code>           <code class="ss">:Place</code>        <code class="p">[</code><code class="s">"California"</code><code class="p">]})]</code>
<code class="linenos">64 </code>    <code class="p">(</code><code class="nb">println </code><code class="s">" -- results:"</code><code class="p">)</code> <code class="p">(</code><code class="nf">pp/pprint</code> <code class="nv">results</code><code class="p">)))</code>
</pre></div>

</figure>

<p>This KGN example was hopefully both interesting to you and simple enough in its implementation to use as a jumping off point for your own projects. </p>

<p>I had the idea for the KGN application because I was spending quite a bit of time manually setting up SPARQL queries for DBPedia (and other public sources like WikiData) and I wanted to experiment with partially automating this process. I have experimented with versions of KGN written in Java, Hy language (<a href="https://leanpub.com/hy-lisp-python/read">Lisp running on Python that I wrote a short book on</a>), Swift, and Common Lisp and all four implementations take different approaches as I experimented with different ideas.</p>


<h2 id="leanpub-auto-using-the-openai-apis">Using the OpenAI APIs</h2>

<p>I have been working as an artificial intelligence practitioner since 1982 and the capability of the beta OpenAI APIs is the most impressive thing that I have seen (so far!) in my career. These APIs use the GPT-3 model.</p>

<p>I recommend reading the online documentation for the <a href="https://beta.openai.com/docs/introduction/key-concepts">online documentation for the APIs</a> to see all the capabilities of the beta OpenAI APIs.  Let’s start by jumping into the example code.  As seen in the <strong>src/openai_api/core.clj</strong> file we use the <strong>clj-http.client</strong> and <strong>‌clojure.data.json</strong> libraries:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="kd">ns </code><code class="nv">openai-api.core</code>
<code class="linenos">2 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clj-http.client</code> <code class="ss">:as</code> <code class="nv">client</code><code class="p">])</code>
<code class="linenos">3 </code>  <code class="p">(</code><code class="ss">:require</code> <code class="p">[</code><code class="nv">clojure.data.json</code> <code class="ss">:as</code> <code class="nv">json</code><code class="p">]))</code>
</pre></div>

</figure>

<p>The library that I wrote for this chapter supports three functions: for completing text, summarizing text, and answering general questions. The single OpenAI model that the beta OpenAI APIs use is fairly general purpose and can generate cooking directions when given an ingredient list, grammar correction, write an advertisement from a product description, generate spreadsheet data from data descriptions in English text, etc. </p>

<p>Given the examples from <a href="https://beta.openai.com">https://beta.openai.com</a> and the Clojure examples here, you should be able to modify my example code to use any of the functionality that OpenAI documents.</p>

<p>We will look closely at the function <strong>completions</strong> and then just look at the small differences to the other two example functions. The definitions for all three exported functions are kept in the file <strong>src/openai_api/core.clj</strong>*. You need to request an API key (I had to wait a few weeks to recieve my key) and set the value of the environment variable <strong>OPENAI_KEY</strong> to your key. You can add a statement like:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="k">export</code> <code class="n">OPENAI_KEY</code><code class="o">=</code><code class="n">sa</code><code class="o">-</code><code class="n">hdffds7</code><code class="o">&amp;</code><code class="n">dhdhsdgffd</code>
</pre></div>

</figure>

<p>to your <strong>.profile</strong> or other shell resource file.</p>

<p>While I sometimes use pure Clojure libraries to make HTTP requests, I prefer using the <strong>curl</strong> utility to experiment with API calls from the command line before starting to write any code.</p>

<p>An example <strong>curl</strong> command line call to the beta OpenAI APIs is:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>curl <code class="se">\</code>
<code class="linenos">2 </code>  https://api.openai.com/v1/engines/davinci/completions <code class="se">\</code>
<code class="linenos">3 </code>   -H <code class="s2">"Content-Type: application/json"</code>
<code class="linenos">4 </code>   -H <code class="s2">"Authorization: Bearer sa-hdffds7&amp;dhdhsdgffd"</code> <code class="se">\</code>
<code class="linenos">5 </code>   -d <code class="s1">'{"prompt": "The President went to Congress", \</code>
<code class="linenos">6 </code><code class="s1">        "max_tokens": 22}'</code>
</pre></div>

</figure>

<p>Here the API token “sa-hdffds7&amp;dhdhsdgffd” on line 4 is made up - that is not my API token. All of the OpenAI APIs expect JSON data with query parameters. To use the completion API, we set values for <strong>prompt</strong> and <strong>max_tokens</strong>. The value of <strong>max_tokens</strong> is the requested number of returns words or tokens. We will look at several examples later.</p>

<p>In the file <strong>src/openai_api/core.clj</strong> we start with a helper function <strong>openai-helper</strong> that takes a string with the OpenAI API call arguments encoded as a <strong>curl</strong> command, calls the service, and then extracts the results from the returned JSON data:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="p">(</code><code class="nf">def</code>
<code class="linenos"> 2 </code>  <code class="nv">host</code>
<code class="linenos"> 3 </code>  <code class="s">"https://api.openai.com/v1/engines/davinci/completions"</code><code class="p">)</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="p">(</code><code class="kd">defn- </code><code class="nv">openai-helper</code> <code class="p">[</code><code class="nv">body</code><code class="p">]</code>
<code class="linenos"> 6 </code>  <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">json-results</code>
<code class="linenos"> 7 </code>        <code class="p">(</code><code class="nf">client/post</code>
<code class="linenos"> 8 </code>          <code class="nv">host</code>
<code class="linenos"> 9 </code>          <code class="p">{</code><code class="ss">:accept</code> <code class="ss">:json</code>
<code class="linenos">10 </code>           <code class="ss">:headers</code>
<code class="linenos">11 </code>               <code class="p">{</code><code class="s">"Content-Type"</code>  <code class="s">"application/json"</code>
<code class="linenos">12 </code>                <code class="s">"Authorization"</code> 
<code class="linenos">13 </code>                <code class="p">(</code><code class="nb">str </code><code class="s">"Bearer "</code> 
<code class="linenos">14 </code>                     <code class="p">(</code><code class="nf">System/getenv</code> <code class="s">"OPENAI_KEY"</code><code class="p">))</code>
<code class="linenos">15 </code>               <code class="p">}</code>
<code class="linenos">16 </code>           <code class="ss">:body</code>   <code class="nv">body</code>
<code class="linenos">17 </code>           <code class="p">})]</code>
<code class="linenos">18 </code>    <code class="p">((</code><code class="nf">first</code>
<code class="linenos">19 </code>      <code class="p">((</code><code class="nf">json/read-str</code> <code class="p">(</code><code class="nf">json-results</code> <code class="ss">:body</code><code class="p">))</code> <code class="s">"choices"</code><code class="p">))</code>
<code class="linenos">20 </code>       <code class="s">"text"</code><code class="p">)))</code>
</pre></div>

</figure>

<p>I convert JSON data to a sequence and reach into the nested results list for the generated text string on lines 18-20. Here I am treating Clojure maps as access functions by passing a key value as an argument.</p>

<p>The three example functions all use this <strong>openai-helper</strong> function. The first example function <strong>completions</strong> sets the parameters to complete a text fragment. You have probably seen examples of the OpenAI GPT-3 model writing stories, given a starting sentence. We are using the same model and functionality here:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code><code class="p">(</code><code class="kd">defn </code><code class="nv">completions</code>
<code class="linenos">2 </code>  <code class="s">"Use the OpenAI API for text completions"</code>
<code class="linenos">3 </code>  <code class="p">[</code><code class="nv">prompt-text</code> <code class="nv">max-tokens</code><code class="p">]</code>
<code class="linenos">4 </code>  <code class="p">(</code><code class="nf">let</code>
<code class="linenos">5 </code>    <code class="p">[</code><code class="nv">body</code>
<code class="linenos">6 </code>     <code class="p">(</code><code class="nf">str</code>
<code class="linenos">7 </code>       <code class="s">"{\"prompt\": \""</code> <code class="nv">prompt-text</code> <code class="s">"\",\"max_tokens\": "</code>
<code class="linenos">8 </code>       <code class="p">(</code><code class="nb">str </code><code class="nv">max-tokens</code><code class="p">)</code> <code class="s">"}"</code><code class="p">)]</code>
<code class="linenos">9 </code>    <code class="p">(</code><code class="nf">openai-helper</code> <code class="nv">body</code><code class="p">)))</code>
</pre></div>

</figure>

<p>Note that the OpenAI models are stochastic. When generating output words (or tokens), the model assigns probabilities to possible words to generate and samples a word using these probabilities. As a simple example, suppose given prompt text “it fell and”, then the model could only generate three words, with probabilities for each word based on this prompt text:</p>

<ul>
  <li>the 0.9</li>
  <li>that 0.1</li>
  <li>a 0.1</li>
</ul>

<p>The model would <em>emit</em> the word <strong>the</strong> 90% of the time, the word <strong>that</strong> 10% of the time, or the word <strong>a</strong> 10% of the time. As a result, the model can generate different completion text for the same text prompt. Let’s look at some examples using the same prompt text. Notice the stochastic nature of the returned results:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">$</code> <code class="nv">lein</code> <code class="nv">repl</code>
<code class="linenos"> 2 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/completions</code> <code class="s">"He walked\</code>
<code class="linenos"> 3 </code><code class="s"> to the river"</code> <code class="mi">24</code><code class="p">)</code>
<code class="linenos"> 4 </code><code class="s">" and breathed in the new day, looking out to the lake wh\</code>
<code class="linenos"> 5 </code><code class="s">ere the Mire was displacing the Wold by its"</code>
<code class="linenos"> 6 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/completions</code> <code class="s">"He walked\</code>
<code class="linenos"> 7 </code><code class="s"> to the river"</code> <code class="mi">24</code><code class="p">)</code>
<code class="linenos"> 8 </code><code class="s">". He waded in, not caring about his expensive suit pants\</code>
<code class="linenos"> 9 </code><code class="s">. He was going to do this right, even if"</code>
<code class="linenos">10 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/completions</code> <code class="s">"He walked\</code>
<code class="linenos">11 </code><code class="s"> to the river"</code> <code class="mi">24</code><code class="p">)</code>
<code class="linenos">12 </code><code class="s">" every day. The salty air puffed through their pores. He\</code>
<code class="linenos">13 </code><code class="s"> had enjoyed her company. Maybe he did need a companion"</code>
</pre></div>

</figure>

<p>The function <strong>summarize</strong> is very similar to the function <strong>completions</strong> except the JSON data passed to the API has a few additional parameters that let the API know that we want a text summary:</p>

<ul>
  <li>presence_penalty - penalize words found in the original text (we set this to zero)</li>
  <li>temperature - higher values the randomness used to select output tokens. If you set this to zero, then the same prompt text will always yield the same results (I never use a zero value).</li>
  <li>top_p - also affects randomness. All examples I have seen use a value of 1.</li>
  <li>frequency_penalty - penalize using the same words repeatedly (I usually set this to zero, but you should experiment with different values)</li>
</ul>

<p>When summarizing text, try varying the number of generated tokens to get shorter or longer summaries; in the following examples we ask for 24, 90, and 150 output tokens:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="k">def </code><code class="nv">some-text</code>
<code class="linenos"> 2 </code>             <code class="o">#</code><code class="nv">_=&gt;</code>   <code class="s">"Jupiter is the fifth planet from the\</code>
<code class="linenos"> 3 </code><code class="s"> Sun and the largest in the Solar System. It is a gas gia\</code>
<code class="linenos"> 4 </code><code class="s">nt with a mass one-thousandth that of the Sun, but two-an\</code>
<code class="linenos"> 5 </code><code class="s">d-a-half times that of all the other planets in the Solar\</code>
<code class="linenos"> 6 </code><code class="s"> System combined. Jupiter is one of the brightest objects\</code>
<code class="linenos"> 7 </code><code class="s"> visible to the naked eye in the night sky, and has been \</code>
<code class="linenos"> 8 </code><code class="s">known to ancient civilizations since before recorded hist\</code>
<code class="linenos"> 9 </code><code class="s">ory. It is named after the Roman god Jupiter.[19] When vi\</code>
<code class="linenos">10 </code><code class="s">ewed from Earth, Jupiter can be bright enough for its ref\</code>
<code class="linenos">11 </code><code class="s">lected light to cast visible shadows,[20] and is on avera\</code>
<code class="linenos">12 </code><code class="s">ge the third-brightest natural object in the night sky af\</code>
<code class="linenos">13 </code><code class="s">ter the Moon and Venus."</code><code class="p">)</code>
<code class="linenos">14 </code><code class="o">#</code><code class="ss">'openai-api.core/some-text</code>
<code class="linenos">15 </code>
<code class="linenos">16 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/summarize</code> <code class="nv">some-text</code> <code class="mi">24</code><code class="p">)</code>
<code class="linenos">17 </code><code class="s">" The planet is often referred to by its Latin name, Jupi\</code>
<code class="linenos">18 </code><code class="s">ter, or by its Greek name, Zeus.\n\nJ"</code>
<code class="linenos">19 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/summarize</code> <code class="nv">some-text</code> <code class="mi">24</code><code class="p">)</code>
<code class="linenos">20 </code><code class="s">"\n\nJupiter is a gas giant with a radius 11 times that o\</code>
<code class="linenos">21 </code><code class="s">f Earth. It is a ball of mostly hydrogen"</code>
<code class="linenos">22 </code>
<code class="linenos">23 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/summarize</code> <code class="nv">some-text</code> <code class="nv">op</code><code class="err">\</code>
<code class="linenos">24 </code><code class="nv">enai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/summarize</code> <code class="nv">some-text</code> <code class="mi">90</code><code class="p">)</code>
<code class="linenos">25 </code><code class="s">"\n\nJupiter is classified as a gas giant along with Satu\</code>
<code class="linenos">26 </code><code class="s">rn, Uranus, and Neptune. Jupiter is composed primarily of\</code>
<code class="linenos">27 </code><code class="s"> gaseous and liquid matter.[21] It is the largest of the \</code>
<code class="linenos">28 </code><code class="s">four giant planets in the Solar System and hence its larg\</code>
<code class="linenos">29 </code><code class="s">est planet. It has a diameter of 142,984 km at its equato\</code>
<code class="linenos">30 </code><code class="s">r, which is 0.11 times the diameter of Earth. Jupiter is \</code>
<code class="linenos">31 </code><code class="s">a gas giant because the mass of the planet"</code>
<code class="linenos">32 </code>
<code class="linenos">33 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/summarize</code> <code class="nv">some-text</code> <code class="mi">15</code><code class="err">\</code>
<code class="linenos">34 </code><code class="mi">0</code><code class="p">)</code>
<code class="linenos">35 </code><code class="s">"\n\nJupiter is a gas giant, consisting mostly of hydroge\</code>
<code class="linenos">36 </code><code class="s">n and helium. It is a giant because it is over two-and-a-\</code>
<code class="linenos">37 </code><code class="s">half times as massive as the next-largest planet, Saturn.\</code>
<code class="linenos">38 </code><code class="s"> Jupiter is classified as a gas giant along with Saturn, \</code>
<code class="linenos">39 </code><code class="s">Uranus, and Neptune. Jupiter is a planet because it is a \</code>
<code class="linenos">40 </code><code class="s">body that has a solid core, a rocky mantle and a gaseous \</code>
<code class="linenos">41 </code><code class="s">outer atmosphere. Jupiter is the largest planet in the So\</code>
<code class="linenos">42 </code><code class="s">lar System, with a radius twice that of Earth and over 30\</code>
<code class="linenos">43 </code><code class="s">0 times that of the Earth's Moon. It is more massive than\</code>
<code class="linenos">44 </code><code class="s"> all the other planets in our Solar System combined.\n\nJ\</code>
<code class="linenos">45 </code><code class="s">upiter has a faint ring system, which was discovered in 1\</code>
<code class="linenos">46 </code><code class="s">979 when the two Voyager spacecraft passed"</code>
<code class="linenos">47 </code><code class="nv">openai-api.core=&gt;</code> 
</pre></div>

</figure>

<p>The function <strong>answer-question</strong> is very similar to the function <strong>summarize</strong> except the JSON data passed to the API has one additional parameter that let the API know that we want a question answered:</p>

<ul>
  <li>stop - The OpenAI API examples use the value: <strong>[\n]</strong>, which is what I use here.</li>
</ul>

<p>We also need to prepend the string “nQ: “ to the prompt text.</p>

<p>Additionally, the model returns a series of answers with the string “nQ:” acting as a delimiter between the answers. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos">1 </code>    <code class="p">(</code><code class="k">let </code><code class="p">[</code><code class="nv">ind</code> <code class="p">(</code><code class="nf">clojure.string/index-of</code> <code class="nv">results</code> <code class="s">"nQ:"</code><code class="p">)]</code>
<code class="linenos">2 </code>      <code class="p">(</code><code class="k">if </code><code class="p">(</code><code class="nb">nil? </code><code class="nv">ind</code><code class="p">)</code>
<code class="linenos">3 </code>        <code class="nv">results</code>
<code class="linenos">4 </code>        <code class="p">(</code><code class="nb">subs </code><code class="nv">results</code> <code class="mi">0</code> <code class="nv">ind</code><code class="p">))</code>
</pre></div>

</figure>

<p>I strongly urge you to add a debug printout to the question answering code to print the full answer before we check for the delimiter string. For some questions, the OpenAI APIs generate a series of answers that increase in generality. In the example code we just take the most specific answer.</p>

<p>Let’s look at a few question answering examples and we will discuss possible problems and workarounds. The first two examples ask the same question and get back different, but reasonable answers. The third example asks a general question. The GPT-3 model is trained using a massive amount of text from the web which is why it can generate reasonable answers:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="linenos"> 1 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/answer-question</code> <code class="s">"Where\</code>
<code class="linenos"> 2 </code><code class="s"> is the Valley of Kings?"</code> <code class="mi">60</code><code class="p">)</code>
<code class="linenos"> 3 </code><code class="s">" It's in Egypt."</code>
<code class="linenos"> 4 </code>
<code class="linenos"> 5 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/answer-question</code> <code class="s">"Where\</code>
<code class="linenos"> 6 </code><code class="s"> is the Valley of Kings?"</code> <code class="mi">60</code><code class="p">)</code>
<code class="linenos"> 7 </code><code class="s">" It is located in the Valley of the Kings, near Luxor."</code>
<code class="linenos"> 8 </code>
<code class="linenos"> 9 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/answer-question</code> <code class="s">"Who i\</code>
<code class="linenos">10 </code><code class="s">s Bill Clinton's wife?"</code> <code class="mi">60</code><code class="p">)</code>
<code class="linenos">11 </code><code class="s">" Hillary Clinton."</code>
<code class="linenos">12 </code>
<code class="linenos">13 </code><code class="nv">openai-api.core=&gt;</code> <code class="p">(</code><code class="nf">openai-api.core/answer-question</code> <code class="s">"What \</code>
<code class="linenos">14 </code><code class="s">rivers are in Arizona?"</code> <code class="mi">250</code><code class="p">)</code>
<code class="linenos">15 </code><code class="s">" The Colorado, Verde, Salt, Gila, San Pedro, Little Colo\</code>
<code class="linenos">16 </code><code class="s">rado, and the San Francisco."</code>
</pre></div>

</figure>

<p>In addition to reading the beta OpenAI API documentation you might want to read general material on the use of OpenAI’s GPT-3 model. Since the APIs we are using are beta they may change. I will update this chapter and the source code on GitHub if the APIs change.</p>


<h2 id="leanpub-auto-conclusions">Conclusions</h2>

<p>The material in this book was informed by my own work interests and experiences. If you enjoyed reading this book and you make practical use of at least some of the material I covered, then I consider my effort to be worthwhile.</p>

<p>Writing software is a combination of a business activity, promoting good for society, and an exploration to try out new ideas for self improvement. I believe that there is sometimes a fine line between spending too many resources tracking many new technologies versus getting stuck using old technologies at the expense of lost opportunities. My hope is that reading this book was an efficient and pleasurable use of your time, letting you try some new techniques and technologies that you had not considered before.</p>

<p>When we do expend resources to try new things it is almost always best to perform many small experiments and then dig deeper into areas that have a good chance of providing high value and capturing your interest. I hope that I have provided you with a good road map to dig deeper into material that interests you.</p>

<p>If we never get to meet in person or talk on the telephone, then I would like to thank you now for taking the time to read my book.</p>

</div>
</body>
</html>
